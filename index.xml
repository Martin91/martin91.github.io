<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Hackerpie</title><link>https://blog.hackerpie.com/</link><description>Recent content on Hackerpie</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><lastBuildDate>Tue, 19 Dec 2023 20:01:18 +0800</lastBuildDate><atom:link href="https://blog.hackerpie.com/index.xml" rel="self" type="application/rss+xml"/><item><title>è…¾è®¯ tRPC-Go æ¡†æ¶æ ¸å¿ƒå®ç°æºç è§£è¯»</title><link>https://blog.hackerpie.com/posts/architecture/tencent-trpc-go-framework-source/</link><pubDate>Tue, 19 Dec 2023 20:01:18 +0800</pubDate><guid>https://blog.hackerpie.com/posts/architecture/tencent-trpc-go-framework-source/</guid><description>&lt;h2 id="æ¦‚è¿°">æ¦‚è¿°&lt;/h2>
&lt;p>tRPC æ˜¯ä¸€å¥—ç”±è…¾è®¯å¼€æºçš„é«˜æ€§èƒ½ã€è·¨å¤šç§ç¼–ç¨‹è¯­è¨€ã€æ’ä»¶åŒ–çš„ RPC æ¡†æ¶ã€‚tRPC-Go æ˜¯æ¡†æ¶åœ¨ Golang ç¼–ç¨‹è¯­è¨€ä¸‹çš„å®˜æ–¹å®ç°ã€‚&lt;/p>
&lt;p>æœ¬æ–‡å‰–æ tRPC-Go æ¡†æ¶çš„æ ¸å¿ƒå®ç°åŸç†ï¼Œå¹¶é tRPC-Go æ¡†æ¶å¿«é€Ÿå…¥é—¨æ•™ç¨‹ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰æ¡†æ¶ä½¿ç”¨æ–¹æ³•æ–¹é¢çš„ä»‹ç»ã€‚&lt;/p>
&lt;p>æœ¬æ–‡å‡è®¾çš„è¯»è€…æ˜¯å·²ç»æœ‰ä¸€å®šçš„ tRPC-Go æ¡†æ¶ä½¿ç”¨ç»éªŒæˆ–å¯¹ tRPC-Go æ¡†æ¶è®¾è®¡æœ‰åŸºæœ¬äº†è§£çš„åŒå­¦ï¼Œæˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¯¹æƒ³è¦æ›´æ·±å…¥äº†è§£æ¡†æ¶åŸç†çš„åŒå­¦æä¾›æœ‰æ•ˆçš„å¸®åŠ©ã€‚&lt;/p>
&lt;p>é€šè¿‡é˜…è¯»æœ¬æ–‡ï¼Œä½ å°†å¯ä»¥ï¼š&lt;/p>
&lt;ul>
&lt;li>ç†Ÿæ‚‰ tRPC-Go æ¡†æ¶æ ¸å¿ƒæ¨¡å—è®¾è®¡åŸç†&lt;/li>
&lt;li>ä»¥æ¡†æ¶çš„æ ¸å¿ƒæµç¨‹ä¸ºè„‰ç»œè‡ªè¡Œå»¶ä¼¸äº†è§£å…¶ä»–é‡è¦æ¨¡å—å®ç°åŸç†&lt;/li>
&lt;/ul>
&lt;p>æ³¨æ„ï¼šæœ¬æ–‡å†™ä½œæ—¶ï¼Œå¯¹åº”çš„ tRPC-go æ¡†æ¶ç‰ˆæœ¬æ˜¯ &lt;code>v0.12.0&lt;/code>ã€‚&lt;/p>
&lt;h2 id="trpc-go-æ¶æ„é€Ÿè§ˆ">tRPC-Go æ¶æ„é€Ÿè§ˆ&lt;/h2>
&lt;p>åœ¨ä¸€å¤´æ‰è¿› tRPC-Go æ ¸å¿ƒç»„ä»¶çš„è®¾è®¡åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ tRPC-Go æ¡†æ¶çš„æ•´ä½“æ¶æ„è®¾è®¡ï¼Œè¿™ä¸ªæ¶æ„å›¾å¤§å®¶å¯ä»¥ä» tRPC-Go æ¡†æ¶çš„&lt;a href="https://github.com/trpc-group/trpc-go/">å®˜æ–¹æ–‡æ¡£&lt;/a>ä¸­æŸ¥åˆ°ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/overall_architecture.webp" alt="">
&lt;figcaption>æ€»ä½“æ¡†æ¶è®¾è®¡&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>tRPC-Go æ¡†æ¶çš„æœ€å¤§è®¾è®¡äº®ç‚¹æ˜¯æ¸…æ™°çš„ç»„ä»¶åˆ’åˆ†ä»¥åŠé«˜åº¦çš„çµæ´»æ€§ã€å¯æ‰©å±•æ€§ã€‚&lt;/p>
&lt;p>&lt;strong>ç»„ä»¶åˆ’åˆ†æ–¹é¢&lt;/strong>ï¼Œæ¡†æ¶åœ¨è®¾è®¡ä¸­è€ƒè™‘åˆ°äº†å¾®æœåŠ¡æ²»ç†ä¸­çš„å¸¸è§é—®é¢˜ï¼ŒåŒ…æ‹¬æœåŠ¡æ³¨å†Œå‘ç°ã€åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªä»¥åŠæœåŠ¡å¯è§‚æµ‹æ€§ç­‰ï¼Œå¯¹åº”åˆ°æ¡†æ¶ï¼Œå…¶å®šä¹‰äº† Metricsã€Tracingã€Selectorã€Conf ä»¥åŠ Log ç­‰ç»„ä»¶ï¼›è€Œ Codec å’Œ Transport ç­‰ç»„ä»¶åˆ™æ˜¯ RPC è°ƒç”¨é€šä¿¡è¿‡ç¨‹çš„æ ‡å‡†åŒ–ã€‚&lt;/p>
&lt;p>åœ¨&lt;strong>çµæ´»æ€§å’Œå¯æ‰©å±•æ€§&lt;/strong>çš„è€ƒé‡ä¸Šï¼Œæ¡†æ¶åˆ©ç”¨æ’ä»¶åŒ–è®¾è®¡æ€æƒ³ï¼Œæ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶å‡å¯ä»¥é€šè¿‡å®ç°æ¡†æ¶å®šä¹‰çš„å„ä¸ªæ¥å£æ¥å®ç°ä¸šåŠ¡å®šåˆ¶ä¸æ‰©å±•ï¼Œæˆ‘ä»¬åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæœ€å®¹æ˜“æ¥è§¦åˆ°çš„å°±æ˜¯å„ç§å„æ ·çš„æ‹¦æˆªå™¨ï¼Œè¿™äº›éƒ½ä¸º tRPC-Go å…¼å®¹è…¾è®¯å†…éƒ¨å·²æœ‰å„ç§åè®®ä¸æ¡†æ¶å¥ å®šäº†åŸºç¡€ã€‚&lt;/p>
&lt;p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œå¤§å®¶å°†ä¼šçœ‹åˆ°æ¡†æ¶åœ¨ Codec ã€Log ä»¥åŠ Tracing ç­‰æ–¹é¢çš„è®¾è®¡å®ç°ã€‚&lt;/p>
&lt;h2 id="trpc-go-æ¡†æ¶æ ¸å¿ƒæ¨¡å—åŠåº”ç”¨è¯¦è§£">tRPC-Go æ¡†æ¶æ ¸å¿ƒæ¨¡å—åŠåº”ç”¨è¯¦è§£&lt;/h2>
&lt;p>å­¦ä¹ ä¸€ä¸ªæ¡†æ¶ï¼Œæœ€æœ‰æ•ˆçš„æ–¹æ³•å°±æ˜¯å…ˆæŒæ¡å®ƒæœ€åŸºæœ¬çš„ä¸šåŠ¡è¿‡ç¨‹ï¼Œå…¶æ¬¡å†ä»å„ä¸ªæµç¨‹åˆ†å‰ç‚¹å»¶ä¼¸åˆ°å„ä¸ªè§’è½ï¼Œè¿™æ ·æ‰ä¸ä¼šåœ¨æ¡†æ¶å¤§é‡çš„ä»£ç ä¸­è¿·å¤±äº†æ–¹å‘ã€‚å¯¹äºä¸€ä¸ªç½‘ç»œåº”ç”¨æ¡†æ¶è€Œè¨€ï¼Œè¿›ç¨‹é—´çš„é€šä¿¡è¿‡ç¨‹å°±æ˜¯å®ƒæœ€åŸºæœ¬çš„ä¸šåŠ¡è¿‡ç¨‹ã€‚æ¥ä¸€ä¸ªéå¸¸ç†Ÿæ‚‰çš„ä¾‹å­ï¼šä¸€ä¸ª HTTP è¯·æ±‚ä»æµè§ˆå™¨ç«¯å‘é€åˆ°æœåŠ¡å™¨ç«¯å®Œæˆå“åº”ï¼Œå†è¿”å›åˆ°æµè§ˆå™¨ç«¯ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿå½“ç„¶ä¸è¦æ€•ï¼Œè¿™ä¸ªé—®é¢˜æ— éœ€å›ç­”ï¼Œæ”¾æ¾ã€‚æˆ‘åªæ˜¯ä¸ºäº†æå‡ºæˆ‘ä»¬ä»Šå¤©çš„ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>ä¸€æ¬¡ RPC è°ƒç”¨çš„æ ¸å¿ƒè¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿéœ€è¦ç»è¿‡å“ªäº›ç¯èŠ‚çš„å¤„ç†ï¼Ÿ&lt;/p>
&lt;/blockquote>
&lt;h3 id="ä¸€æ¬¡-rpc-è°ƒç”¨çš„æ ¸å¿ƒè¿‡ç¨‹">ä¸€æ¬¡ RPC è°ƒç”¨çš„æ ¸å¿ƒè¿‡ç¨‹&lt;/h3>
&lt;p>HTTP å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯åŒæ–¹æƒ³è¦é€šä¿¡ï¼Œå®¢æˆ·ç«¯éœ€è¦å…ˆå®Œæˆ HTTP è¯·æ±‚å¤´å’Œè¯·æ±‚æ­£æ–‡çš„ç»„è£…ï¼Œä»¥åŠåŸŸåçš„è§£æï¼Œè·å¾— IP åœ°å€åï¼Œæ ¹æ®è¯·æ±‚çš„ IP å’Œç«¯å£ï¼Œäº¤ç”±ä¼ è¾“å±‚å®Œæˆè¯·æ±‚çš„ä¼ è¾“ï¼›è€ŒæœåŠ¡å™¨ç«¯åœ¨æ”¶åˆ°è¯·æ±‚åï¼Œéœ€è¦å®Œæˆè¯·æ±‚ä¿¡æ¯çš„ç»“æ„åŒ–è§£æï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„åŠ¨ä½œï¼Œæœ€ååŒæ ·é€šè¿‡ä¼ è¾“å±‚è¿”å›å“åº”çš„å¤´å’Œæ­£æ–‡ç»™åˆ°æµè§ˆå™¨ç«¯ã€‚&lt;/p>
&lt;p>ç±»æ¯”ä¸€ä¸‹è¿™ä¸ªå¤§è‡´çš„è¿‡ç¨‹ï¼Œå¥—åˆ° RPC æ¡†æ¶çš„è®¾è®¡ä¸Šï¼Œéœ€è¦å®ç°çš„è¿‡ç¨‹å…¶å®æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œä¸‹é¢æ˜¯æˆ‘æŒ‰ç…§æˆ‘ä¸ªäººç†è§£ï¼Œç”»å‡ºæ¥çš„ RPC è°ƒç”¨è¿‡ç¨‹çš„å›¾ç¤ºï¼š&lt;/p>
&lt;p>æŒ‰ç…§ tRPC å®˜æ–¹çš„å«æ³•ï¼Œå‘èµ·è¯·æ±‚çš„ä¸€æ–¹ç§°ä¹‹ä¸ºä¸»è°ƒæ–¹ callerï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºä¸Šæ¸¸ï¼›è€Œå“åº”è¯·æ±‚çš„ä¸€æ–¹ç§°ä¹‹ä¸ºè¢«è°ƒæ–¹ calleeï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºä¸‹æ¸¸ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‰è‡ªå·±ä¹ æƒ¯ç®¡ä¸»è°ƒæ–¹å«å®¢æˆ·ç«¯ï¼Œç®¡è¢«è°ƒæ–¹å«æœåŠ¡ç«¯ã€‚æˆ‘ä¸ªäººå‡ºäºè¡¨è¾¾çš„ä¹ æƒ¯ï¼Œæˆ‘ä¸€èˆ¬ç”¨ä¸»è°ƒæ–¹/è¢«è°ƒæ–¹çš„å«æ³•ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/RPC-request-and-response.webp" alt="">
&lt;figcaption>RPC è¯·æ±‚å“åº”è¿‡ç¨‹&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>åœ¨è¿™ä¸ªå›¾ç¤ºçš„ tRPC-Go è¯·æ±‚å“åº”è¿‡ç¨‹ä¸­ï¼Œå®çº¿è¡¨ç¤ºä¸»è°ƒæ–¹å‘é€è¯·æ±‚åˆ°è¢«è°ƒæ–¹çš„è¿‡ç¨‹ï¼›è€Œè™šçº¿åˆ™æ˜¯è¢«è°ƒæ–¹å¤„ç†å®Œè¯·æ±‚ï¼Œè¿”å›ç»“æœåˆ°ä¸»è°ƒæ–¹çš„è¿‡ç¨‹ã€‚ä¸ HTTP ç›¸ä¼¼çš„ï¼Œä¸»è°ƒæ–¹éœ€è¦ï¼š&lt;/p>
&lt;ol>
&lt;li>é€šè¿‡ tRPC æ¡†æ¶ç”Ÿæˆçš„æ¡©ä»£ç å®Œæˆè¯·æ±‚å†…å®¹çš„å†…å­˜ç»“æ„åŒ–;&lt;/li>
&lt;li>é€šè¿‡æœåŠ¡å‘ç°æœºåˆ¶è·å–ç›®æ ‡æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯è¢«è°ƒæ–¹çš„ç½‘ç»œåœ°å€å’Œç«¯å£å·;&lt;/li>
&lt;li>é€šè¿‡å¯¹æ¶ˆæ¯ä¾æ¬¡è¿›è¡Œåºåˆ—åŒ–ã€å‹ç¼©å’Œç¼–ç ï¼Œè·å¾—äº†äºŒè¿›åˆ¶çš„æ¶ˆæ¯ï¼Œå°±å¯ä»¥é€šè¿‡ä¼ è¾“å±‚åè®®è¿›è¡Œè¿›ç¨‹é—´çš„ä¼ è¾“äº†ã€‚&lt;/li>
&lt;/ol>
&lt;p>å½“è¯·æ±‚åˆ°è¾¾è¢«è°ƒæ–¹ä¹‹åï¼Œå¤„ç†çš„è¿‡ç¨‹å’Œä¸»è°ƒæ–¹åˆšå¥½æ˜¯ç›¸åçš„:&lt;/p>
&lt;ol>
&lt;li>æ¶ˆæ¯ä½“éœ€è¦æŒ‰ç…§ tRPC çš„æ ‡å‡†åè®®è¿›è¡Œè§£ç ï¼Œåˆ†è§£å‡ºæ¶ˆæ¯å¤´ä¸æ¶ˆæ¯ä½“ï¼Œæ¶ˆæ¯å¤´ç”¨äºæ¡†æ¶åšè·¯ç”±åˆ†å‘ï¼›&lt;/li>
&lt;li>æ¶ˆæ¯ä½“ç»è¿‡è§£å‹ç¼©å’Œååºåˆ—åŒ–ï¼Œä½¿å¾—è¢«è°ƒæ–¹çš„åº”ç”¨å±‚é€»è¾‘è·å¾—äº†å†…å­˜ä¸­çš„ç»“æ„åŒ–æ•°æ®ï¼›&lt;/li>
&lt;li>è¢«è°ƒæ–¹çš„æœåŠ¡å¤„ç†å‡½æ•°æ‰§è¡Œä¸šåŠ¡é€»è¾‘ã€‚&lt;/li>
&lt;/ol>
&lt;p>å¸¦ç€è¿™ä¸ªå›¾ï¼Œæˆ‘ä»¬è¿›å…¥æºç çš„ä¸–ç•Œï¼ˆå…‰çœ‹æºç å®¹æ˜“å¤´æ™•å’ŒçŠ¯å›°ï¼Œå»ºè®®æ—¶ä¸æ—¶ç¿»å›æ¥çœ‹ä¸‹ä¸Šé¢çš„å›¾ï¼Œå¯ä»¥å½“æˆä»£ç åœ°å›¾ï¼‰ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œä»¥ä¸€ä¸ª tRPC è°ƒç”¨ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä»ä¸»è°ƒæ–¹çš„æ¡©ä»£ç å‡ºå‘ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/demo-call.webp" alt="">
&lt;figcaption>ç¤ºä¾‹ç¨‹åºä¸­çš„æ¡©ä»£ç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>&lt;code>SayHello&lt;/code> æ˜¯ä¸€ä¸ªè¿œç¨‹è°ƒç”¨çš„æ¡©ä»£ç ï¼Œå®ƒä¼šå‘èµ·å¯¹è¢«è°ƒæ–¹çš„ SayHello æ–¹æ³•çš„è¿œç¨‹è°ƒç”¨ï¼Œæ¡©ä»£ç é‡Œï¼Œä¸»è¦æ˜¯è®¾ç½®äº†æ¶ˆæ¯çš„ä¸»è¢«è°ƒåŒæ–¹ä¿¡æ¯ï¼Œç„¶åæ‰§è¡Œ &lt;code>c.client.Invoke&lt;/code> æ–¹æ³•è°ƒç”¨ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹ &lt;code>c.client&lt;/code> æ˜¯ä½•æ–¹ç¥åœ£ï¼Ÿåœ¨ &lt;code>SayHello&lt;/code> æ–¹æ³•çš„ä»£ç ä¸Šé¢ï¼Œclient å­—æ®µè¢«èµ‹å€¼äº† &lt;code>client.DefaultClient&lt;/code> ï¼Œåè€… &lt;code>client&lt;/code> æ˜¯ tRPC-Go æ¡†æ¶æºç é‡Œçš„ä¸€ä¸ªåŒ…ã€‚æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªåŒ…é‡Œçš„ä»£ç  &lt;code>client.DefaultClient&lt;/code>â€¦â€¦&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/default-client.webp" alt="">
&lt;figcaption>client.DefaultClient ç›¸å…³ä»£ç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>&lt;code>DefaultClient&lt;/code> æ˜¯ä¸€ä¸ªå…¨å±€çš„å˜é‡ï¼Œå®ƒæ˜¯ &lt;code>client.client&lt;/code> ç±»å‹çš„ä¸€ä¸ªå®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹ç”±æ¡†æ¶å¯åŠ¨æ—¶åˆå§‹åŒ–ã€‚æ‰¾åˆ°äº† &lt;code>DefaultClient&lt;/code>ï¼Œé‚£æˆ‘ä»¬å°±ç»§ç»­çœ‹å®ƒçš„ Invoke æ–¹æ³•ï¼Œè¿™æ˜¯ RPC è°ƒç”¨çš„æ ¸å¿ƒè¿‡ç¨‹ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬çš„è§†çº¿å¯ä»¥å¿«é€Ÿå®šä½åˆ° &lt;code>filters := c.fixFilters(opts)&lt;/code> è¿™ä¸€è¡Œï¼Œçœ‹èµ·æ¥æ˜¯æ‹¦æˆªå™¨ç›¸å…³çš„é€»è¾‘ï¼Œæˆ‘ä»¬è·Ÿè¸ªä¸€ä¸‹å®ƒçš„å®ç°é€»è¾‘ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/fixFilters.webp" alt="">
&lt;figcaption>fixFilters å‡½æ•°æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>åŸæ¥æ˜¯åœ¨æ‹¦æˆªå™¨é“¾çš„æœ«å°¾åŠ ä¸Šäº†æœåŠ¡å‘ç°çš„æ‹¦æˆªå™¨ã€‚è¿™å°±æ˜¯å‰é¢å›¾ç‰‡é‡Œè¯´çš„â€œé»˜è®¤æ³¨å…¥æœåŠ¡å‘ç°æ‹¦æˆªå™¨â€ã€‚è·³å‡º &lt;code>fixFilters&lt;/code> è¿™ä¸ªæ–¹æ³•ï¼Œè®©æˆ‘å›åˆ° &lt;code>Invoke&lt;/code> æ–¹æ³•çš„ä¸‹ä¸€è¡Œï¼Œä¹Ÿå°±æ˜¯ &lt;code>filters.Filter(contextWIthOptions(ctx, opts), reqbody, resbody, callFunc)&lt;/code>ã€‚æˆ‘ä»¬ç›´æ¥çœ‹ &lt;code>callFunc&lt;/code> å‡½æ•°ï¼Œå®ƒæ˜¯æ•´ä¸ª RPC è°ƒç”¨è¿‡ç¨‹çš„æ ¸å¿ƒé€»è¾‘ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/callFunc.webp" alt="">
&lt;figcaption>callFunc å‡½æ•°æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>å¤§è‡´çœ‹ä¸€çœ¼çš„è¯ï¼Œæœ‰å‡ ä¸ªé‡è¦çš„å‡½æ•°è°ƒç”¨ï¼Œä¸€ä¸ªæ˜¯ &lt;code>prepareRequestBuf&lt;/code>ï¼Œå®ƒå®Œæˆæ•´ä¸ªè¯·æ±‚çš„åºåˆ—åŒ–å’Œç¼–ç ï¼›ç„¶åæ˜¯ &lt;code>opts.Transport.RoundTrip&lt;/code>ï¼Œå®Œæˆä¼ è¾“å±‚çš„è°ƒç”¨ï¼›å†æ¥ç€æ˜¯ &lt;code>opts.Codec.Decode(msg, rspbuf)&lt;/code>ï¼Œå®Œæˆå“åº”æ¶ˆæ¯çš„è§£ç ï¼Œæœ€åæ˜¯ &lt;code>processResponseBuf&lt;/code> å‡½æ•°ï¼Œå®Œæˆçš„æ˜¯å“åº”æ¶ˆæ¯çš„ååºåˆ—åŒ–ç­‰ã€‚æˆ‘æŠŠè¿™äº›å‡½æ•°æˆ–æ–¹æ³•çš„è°ƒç”¨è¿‡ç¨‹å’Œå‰é¢çš„æµç¨‹å›¾çš„ä¸»è°ƒæ–¹çš„å¤„ç†è¿‡ç¨‹åšä¸‹å…³è”å›¾ç¤ºï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/invokeFlow.webp" alt="">
&lt;figcaption>Invoke å‡½æ•°é€»è¾‘å›¾ç¤º&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ &lt;code>prepareRequestBuf&lt;/code>ï¼Œå®ƒçš„å®ç°å¾ˆæ¸…æ™°ï¼Œå°±æ˜¯åºåˆ—åŒ–ã€å‹ç¼©ï¼Œä»¥åŠæœ€åçš„ç¼–ç ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/prepareRequestBuf.webp" alt="">
&lt;figcaption>prepareRequestBuf å‡½æ•°æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>å›åˆ° &lt;code>callFunc&lt;/code>ï¼Œæˆ‘ä»¬è¿™é‡Œç•¥è¿‡éƒ¨åˆ†å‡½æ•°ï¼Œç›´æ¥è·³è¿›æ¥çœ‹ &lt;code>processResponseBuf&lt;/code>:&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/processResponseBuf.webp" alt="">
&lt;figcaption>processResponseBuf å‡½æ•°æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯å…ˆè§£å‹ç¼©ï¼Œç„¶ååšååºåˆ—åŒ–ï¼Œæ‰€ä»¥å’Œ &lt;code>prepareRequestBuf&lt;/code> åˆšå¥½ç›¸åï¼Œä¸è¿‡æœ‰ç‚¹ä¸å¤Ÿå¯¹ç§°çš„æ˜¯ï¼Œè§£ç  &lt;code>Decode&lt;/code> æ²¡æœ‰åŒ…è£…åˆ°è¿™é‡Œè¾¹ï¼Œä¸ç„¶å°±æ˜¯å®Œç¾çš„å¯¹ç§°äº†ã€‚&lt;/p>
&lt;p>ä¸Šé¢å°±æ˜¯ä¸€ä¸ª RPC è°ƒç”¨çš„æ ¸å¿ƒè¿‡ç¨‹æºç äº†ï¼Œè€Œè¢«è°ƒæ–¹è¿”å›çš„è¿‡ç¨‹å’Œä¸»è°ƒæ–¹è¯·æ±‚çš„è¿‡ç¨‹å¤§ä½“ç›¸åŒï¼Œæˆ‘ä»¬å°±ä¸èµ˜è¿°äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦æŠŠè¿™ä¸ªå½“æˆç»ƒä¹ ï¼Œè‡ªå·±ç ”ç©¶ä¸€æ³¢ã€‚&lt;/p>
&lt;h3 id="åºåˆ—åŒ–ä¸å‹ç¼©">åºåˆ—åŒ–ä¸å‹ç¼©&lt;/h3>
&lt;p>å‰é¢çš„å†…å®¹æ˜¯ä¸€ä¸ª RPC è¯·æ±‚çš„ä¸€ä¸ªå¤§è‡´è¿‡ç¨‹ï¼Œç°åœ¨å¼€å§‹æˆ‘ä»¬ç”¨æ”¾å¤§é•œä»”ç»†è§£è¯»å…³é”®çš„å„ä¸ªç¯èŠ‚ã€‚è®©æˆ‘ä»¬å…ˆèšç„¦åˆ°åºåˆ—åŒ–å’Œå‹ç¼©è¿™ä¸ªç¯èŠ‚ã€‚è¿™æ˜¯ç¦»æ¡†æ¶ç”¨æˆ·æ›´è¿‘ï¼Œæ„ŸçŸ¥ä¹Ÿæ›´å¼ºçš„ä¸€ä¸ªç»„ä»¶äº†ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/serialize_and_compress.webp" alt="">
&lt;figcaption>åºåˆ—åŒ–å’Œå‹ç¼©é€»è¾‘&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>è¿™ä¸ªå›¾æ˜¯å†…å­˜ä¸­çš„ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–æˆäºŒè¿›åˆ¶ï¼Œå†é€šè¿‡ tRPC çš„ç½‘ç»œåè®®è¿›è¡Œç¼–ç åå¾—åˆ°çš„æ•´ä¸ªäºŒè¿›åˆ¶æ•°æ®çš„ç¤ºä¾‹è¿‡ç¨‹ï¼Œå³è¾¹æ˜¯è¢«è°ƒæ–¹æ”¶åˆ°è¯·æ±‚åï¼Œå¯¹è¯·æ±‚è¿›è¡Œè§£ç ä»¥åŠååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚&lt;/p>
&lt;p>tRPC-Go æ¡†æ¶æ—©æœŸå†…ç½®æ”¯æŒ pbã€json å’Œ jce ä¸‰ç§åºåˆ—åŒ–æ ¼å¼ï¼Œä»¥åŠ gzipã€snappy å‹ç¼©æ ¼å¼ï¼Œä½†æ˜¯ä»¥ç°åœ¨çš„ç‰ˆæœ¬çœ‹çš„è¯ï¼Œå·²ç»åœ¨æ¡†æ¶å†…éƒ¨åˆå¢åŠ äº†æ›´å¤šçš„æ ¼å¼ã€‚tRPC ç”Ÿæˆçš„æ¡©ä»£ç é‡Œï¼Œé»˜è®¤ä¼šä½¿ç”¨ pb åºåˆ—åŒ–æ ¼å¼ï¼Œå¹¶ä¸”ä¸ä½¿ç”¨ä»»ä½•å‹ç¼©ç®—æ³•ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/default_compress_type.webp" alt="">
&lt;figcaption>é»˜è®¤åºåˆ—åŒ–å’Œå‹ç¼©ç®—æ³•&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>tRPC-Go æ¡©ä»£ç ä¸­é»˜è®¤ä½¿ç”¨ pb åºåˆ—åŒ–æ ¼å¼&lt;/p>
&lt;p>è¦äº†è§£æ¡†æ¶å¯¹äºåºåˆ—åŒ–å’Œå‹ç¼©çš„å®ç°é€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å‰é¢è§£è¯» tRPC-Go è¯·æ±‚è¿‡ç¨‹æºç ä¸­æåˆ°çš„ &lt;code>prepareRequestBuf&lt;/code> å‡½æ•°ç€çœ¼ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/prepareRequestBuf2.webp" alt="">
&lt;figcaption>prepareRequestBuf æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>tRPC-Go æ¡†æ¶å®ç°å°†åºåˆ—åŒ–å’Œå‹ç¼©é€»è¾‘æ”¾åœ¨äº†ä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•° &lt;code>serializeAndCompress&lt;/code> é‡Œï¼Œæˆ‘ä»¬è·Ÿè¿›å»çœ‹ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/serializeAndCompress.webp" alt="">
&lt;figcaption>serializeAndCompress æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>è¿™é‡Œçš„ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>msg.SerializationType()&lt;/code> å³ä¸ºæ¡©ä»£ç ä¸­ &lt;code>msg.WithSerializationType(codec.SerializationTypePB)&lt;/code> è®¾ç½®çš„åºåˆ—åŒ–æ ¼å¼ï¼Œå³æ¡†æ¶é»˜è®¤ä½¿ç”¨ PB åºåˆ—åŒ–ï¼›&lt;/li>
&lt;li>&lt;code>msg.CompressType()&lt;/code> åˆ™ä¸ºé€šè¿‡ &lt;code>msg.WithCompressType(int)&lt;/code> è®¾ç½®çš„å‹ç¼©æ ¼å¼ï¼Œä½†æ˜¯è¿™ä¸ªåœ¨æ¡©ä»£ç ä¸­æ²¡æœ‰ä½“ç°ï¼Œå³æ¡†æ¶é»˜è®¤ä¸ä½¿ç”¨ä»»ä½•å‹ç¼©æ ¼å¼ã€‚ ä¸è¿‡è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹æœ‰æ„æ€çš„æ˜¯ï¼Œä½†ä»æ¡†æ¶è¿™å¤„æºç æ¥çœ‹ï¼Œæ¶ˆæ¯ä½“æºå¸¦çš„åºåˆ—åŒ–æ ¼å¼æˆ–è€…å‹ç¼©æ ¼å¼ä¸åˆæ³•æ—¶ï¼Œæ¡†æ¶å´ä¸ä¼šåšä»»ä½•é”™è¯¯è¿”å›ï¼Œæœ‰å¯èƒ½åœ¨ç‰¹å®šåœºæ™¯ä¼šå¯¼è‡´éš¾ä»¥å‘ç°çš„ç¼ºé™·ã€‚åé¢è¿˜ä¼šè®²åˆ°è¿™ä¸ªåœ°æ–¹ï¼›&lt;/li>
&lt;li>&lt;code>opts&lt;/code> å‚æ•°åˆ™æ˜¯æä¾›äº†ä¸€ç§åœ¨è¿è¡Œæ—¶è¦†ç›–åºåˆ—åŒ–æ ¼å¼ä»¥åŠå‹ç¼©æ ¼å¼çš„æœºåˆ¶ã€‚&lt;/li>
&lt;/ol>
&lt;p>æˆ‘ä»¬çœ‹ä¸‹ &lt;code>icodec.IsValidSerializationType()&lt;/code> è¿™ä¸ªå‡½æ•°æ˜¯æ€ä¹ˆåˆ¤æ–­åˆæ³•çš„åºåˆ—åŒ–æ ¼å¼çš„ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/IsValidSerializationType.webp" alt="">
&lt;figcaption>IsValidSerializationType æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>è¿™ä¸ªå‡½æ•°åˆ¤æ–­é€»è¾‘æ˜¯ï¼šåªæœ‰æšä¸¾å€¼å¤§äºç­‰äº &lt;code>codec.SerializationTypePB&lt;/code> çš„åºåˆ—åŒ–æ ¼å¼æ‰æ˜¯åˆæ³•çš„æ ¼å¼ã€‚æˆ‘ä»¬å†çœ‹çœ‹å†…ç½®çš„æšä¸¾å€¼ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/serialization_types.webp" alt="">
&lt;figcaption>åºåˆ—åŒ–ç±»å‹æšä¸¾&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°é»˜è®¤çš„ PB æ ¼å¼å°±æ˜¯ 0ï¼Œè€Œæ³¨é‡Šä¸­åˆ™çº¦å®šäº†åºåˆ—åŒ–æ ¼å¼æšä¸¾å€¼çš„å·æ®µè§„åˆ™ï¼š&lt;/p>
&lt;ol>
&lt;li>è¯­è¨€æ— å…³çš„åºåˆ—åŒ–æ ¼å¼ä½¿ç”¨ 0-127 åºå·ï¼Œç›®å‰ç”¨åˆ°äº†7ä¸ªå·ç ï¼›&lt;/li>
&lt;li>ä¸ç‰¹å®šè¯­è¨€ç›¸å…³çš„åºåˆ—åŒ–æ ¼å¼ä½¿ç”¨ä½¿ç”¨ 128-999 çš„åºå·ï¼Œè¿™ä¸ªå·æ®µç›®å‰å®šä¹‰äº† 4 ä¸ªæ ¼å¼ï¼›&lt;/li>
&lt;li>è€Œä¸šåŠ¡è‡ªå®šä¹‰çš„åºåˆ—åŒ–æ ¼å¼éœ€è¦ä½¿ç”¨ 1000 ä»¥ä¸Šçš„æšä¸¾å€¼ã€‚&lt;/li>
&lt;/ol>
&lt;p>å›åˆ° &lt;code>serializeAndCompress&lt;/code> è¿™ä¸ªå‡½æ•°ä½“ä¸­çš„ &lt;code>codec.Marshal(serializationType, reqbody)&lt;/code>ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ç”¨æ¥åŠ è½½å¯¹åº”çš„åºåˆ—åŒ–å™¨ï¼Œå¹¶ä¸”è°ƒç”¨å®ƒçš„ &lt;code>Marshal&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/Marshal.webp" alt="">
&lt;figcaption>Marshal å‡½æ•°æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>è¿™é‡Œä¼šçœ‹åˆ°å®ƒåœ¨è¿™é‡Œæœ€ç»ˆå¤„ç†äº†åºåˆ—åŒ–æ ¼å¼ä¸åˆæ³•çš„åœºæ™¯çš„ã€‚å†çœ‹åˆ° &lt;code>GetSerializer&lt;/code> å‡½æ•°çš„å®ç°ï¼Œå®ƒä» &lt;code>serializers&lt;/code> å…¨å±€å˜é‡ä¸­è·å–å¯¹åº”åºåˆ—åŒ–å™¨ï¼Œè€Œåºåˆ—åŒ–å™¨éƒ½éœ€è¦åœ¨å¯åŠ¨æ—¶é€šè¿‡ &lt;code>RegisterSerializer&lt;/code> å‡½æ•°æ³¨å†Œä¸Šæ¥ï¼Œè¿™ä¹Ÿæ˜¯è‡ªå®šä¹‰çš„åºåˆ—åŒ–å™¨å¿…é¡»åœ¨æ¡†æ¶åˆå§‹åŒ–æ—¶è°ƒç”¨çš„å‡½æ•°ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/serializers-manager.webp" alt="">
&lt;figcaption>serializers æ³¨å†Œå‘ç°&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>ä»¥ä¸Šå°±æ˜¯ä¸»è°ƒåœ¨è¯·æ±‚é˜¶æ®µå…³äºåºåˆ—åŒ–å’Œå‹ç¼©çš„ç›¸å…³é€»è¾‘ã€‚&lt;/p>
&lt;h3 id="æ¶ˆæ¯ç¼–è§£ç ">æ¶ˆæ¯ç¼–è§£ç &lt;/h3>
&lt;p>åºåˆ—åŒ–å’Œå‹ç¼©è§£å†³çš„æ˜¯å¦‚ä½•å°†æ¶ˆæ¯ä½“è½¬æ¢ä¸ºäºŒè¿›åˆ¶çš„é—®é¢˜ï¼Œè€Œç¼–ç æ­¥éª¤åˆ™å®Œæˆæ¶ˆæ¯å¤´çš„ç¼–ç ä»¥åŠå®Œæ•´çš„è¯·æ±‚å¸§çš„ç¼–ç ï¼Œåšå¥½ä¼ è¾“å±‚äºŒè¿›åˆ¶ä¼ è¾“çš„å‡†å¤‡ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/trpc-protocol.webp" alt="">
&lt;figcaption>tRPC ç½‘ç»œåè®®å°åŒ…æ ¼å¼&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>ä¸Šé¢æ˜¯ä¸€ä¸ª tRPC ç½‘ç»œåè®®å°åŒ…æ ¼å¼çš„å›¾ç¤ºï¼Œä¸€ä¸ª tRPC å¸§åŒ…å«å¸§å¤´ã€æŠ¥æ–‡å¤´ä»¥åŠæŠ¥æ–‡ä½“ä¸‰éƒ¨åˆ†ï¼Œå¸§å¤´é•¿åº¦å›ºå®š16ä¸ªå­—èŠ‚ï¼ŒæŠ¥æ–‡å¤´å’ŒæŠ¥æ–‡ä½“é•¿åº¦å¯å˜ã€‚æˆ‘ä»¬åœ¨æ¡†æ¶ä¸­è®¾ç½®çš„å„ç§ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¯”å¦‚ä½¿ç”¨çš„åºåˆ—åŒ–æ ¼å¼ã€å‹ç¼©æ ¼å¼ã€ä¸»è¢«è°ƒä¿¡æ¯ä»¥åŠé€ä¼ ä¿¡æ¯ç­‰ï¼Œéƒ½ä¼šæ”¾åœ¨æ ‡å‡†çš„æŠ¥æ–‡å¤´é‡Œï¼Œè¿™éƒ¨åˆ†å¼ºåˆ¶ä½¿ç”¨ pb åè®®åºåˆ—åŒ–ï¼Œè€ŒæŠ¥æ–‡ä½“çš„åºåˆ—åŒ–å’Œå‹ç¼©æ–¹å¼ï¼Œåˆ™æ˜¯å‰é¢å·²ç»è®²è§£è¿‡çš„éƒ¨åˆ†ã€‚æ‰€ä»¥æˆ‘ä»¬é‡ç‚¹å¯ä»¥äº†è§£ä¸€ä¸‹å¸§å¤´çš„æ ¼å¼ã€‚&lt;/p>
&lt;p>å¸§å¤´å¼€å¤´æ˜¯ 2 ä¸ªå­—èŠ‚çš„é­”æ•°ï¼Œåœ¨ tRPC åè®®ä¸­å›ºå®šæ˜¯æ•´æ•° 2352ã€‚é­”æ•°çš„ä½œç”¨æ˜¯åœ¨æ•°æ®ä¼ è¾“æˆ–æ–‡ä»¶è¯»å–çš„è¿‡ç¨‹ä¸­ï¼Œè®©æ¥æ”¶æ–¹èƒ½å¤Ÿå¿«é€Ÿå‡†ç¡®åœ°è¯†åˆ«æ•°æ®æ ¼å¼å’Œåè®®ç±»å‹ï¼Œä»¥ä¾¿æ­£ç¡®åœ°å¤„ç†æ•°æ®ã€‚å¦‚æœé­”æ•°åŒ¹é…å¤±è´¥ï¼Œåˆ™å¯èƒ½å¯¼è‡´æ•°æ®è§£æé”™è¯¯æˆ–åè®®é”™è¯¯ï¼Œç”šè‡³å¯èƒ½å¼•å‘å®‰å…¨æ¼æ´ã€‚æ‰€ä»¥é­”æ•°å¯ä»¥ç†è§£ä¸ºæ˜¯ç”¨æ¥å¿«é€Ÿè¯†åˆ«å¸§å¤´ä»¥åŠç¡®è®¤å¸§æ­£ç¡®æ€§çš„å¿«æ·æ–¹å¼ã€‚&lt;/p>
&lt;p>åœ¨é­”æ•°åé¢æ˜¯ 1 å­—èŠ‚çš„å¸§ç±»å‹ï¼Œå› ä¸º tRPC æ”¯æŒä¸åŒçš„è¯·æ±‚å“åº”æ¨¡å¼ï¼Œè¿™é‡Œçš„å¸§ç±»å‹ç”¨äºåŒºåˆ†å…·ä½“æ¨¡å¼ï¼Œè¿™ç¯‡æ–‡ç« é‡Œçš„è®²è§£éƒ½åªå…³æ³¨ä¸€é—®ä¸€ç­”è¿™ç§æ¨¡å¼ã€‚&lt;/p>
&lt;p>å¦‚æœå¸§ç±»å‹æ˜¯ 1ï¼Œä¹Ÿå°±æ˜¯æµå¼æ¨¡å¼ï¼Œåˆ™ç¬¬4ä¸ªå­—èŠ‚å°±ä¼šæœ‰æ„ä¹‰ï¼Œå®ƒè¡¨ç¤ºæµå¼æ¨¡å¼ä¸­æ•°æ®å¸§çš„å…·ä½“ç±»å‹ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥çš„ç¬¬5-8ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´ä¸ªå¸§çš„é•¿åº¦ï¼Œå› ä¸ºå¸§å¤´æœ¬èº«å ç”¨äº†16ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥æŠ¥æ–‡å’ŒæŠ¥æ–‡ä½“åŠ èµ·æ¥çš„æœ€å¤§é•¿åº¦å…è®¸ä¸º 2^32-16 ä¸ªå­—èŠ‚ã€‚&lt;/p>
&lt;p>ç¬¬9-10ä¸ªå­—èŠ‚è¡¨ç¤ºå¸§å¤´é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯é™å®šäº† tRPC åè®®ä¸‹ï¼ŒæŠ¥æ–‡å¤´æœ€å¤§é•¿åº¦ä¸è¶…è¿‡ 65535 ä¸ªå­—èŠ‚ã€‚&lt;/p>
&lt;p>ç¬¬11-14ä¸ªå­—èŠ‚è¡¨ç¤ºè¯·æ±‚ IDæˆ–è€…æµ IDã€‚&lt;/p>
&lt;p>ç¬¬15ä¸ªå­—èŠ‚è¡¨ç¤ºå½“å‰æŠ¥æ–‡ä½¿ç”¨çš„ tRPC åè®®ç‰ˆæœ¬å·ï¼Œè€Œç¬¬ 16 ä¸ªå­—èŠ‚æ˜¯ä¿ç•™å­—èŠ‚ï¼Œä¿ç•™å­—èŠ‚æ˜¯ä¸€ç§æ‰©å±•æ€§çš„è€ƒè™‘ï¼Œå¸¸è§çš„ç½‘ç»œåè®®ä¸­éƒ½ä¼šæœ‰ç±»ä¼¼çš„è®¾è®¡ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬åŒæ ·æ¥è§£è¯»ä¸€ä¸‹ä»£ç ï¼Œç¼–ç ç›¸å…³çš„é€»è¾‘å…¥å£åŒæ ·æ˜¯åœ¨æ¡†æ¶çš„ &lt;code>client.prepareRequestBuf&lt;/code> å‡½æ•°ä½“ä¸­ï¼Œå¯¹åº”çš„å‡½æ•°è°ƒç”¨æ˜¯ &lt;code>opts.Codec.Encode(msg, reqbodybuf)&lt;/code>ï¼Œè€Œ trpc åè®®å¯¹åº”çš„å®¢æˆ·ç«¯ç¼–ç å™¨åˆ™æ˜¯ &lt;code>trpc.DefaultClientCodec&lt;/code>ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/DefaultClientCodec.webp" alt="">
&lt;figcaption>DefaultClientCodec æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>æˆ‘ä»¬çœ‹ä¸‹å®ƒçš„ &lt;code>Encode&lt;/code> æ–¹æ³•çš„å®ç°ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/Encode.webp" alt="">
&lt;figcaption>Encode æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>è¿™é‡Œçš„ &lt;code>getRequestHead&lt;/code> å’Œ &lt;code>c.updateReqHead&lt;/code> ç”¨äºåˆå§‹åŒ–æ¶ˆæ¯ä½“çš„æ•°æ®ç»“æ„ &lt;code>req&lt;/code> ï¼Œå…·ä½“çš„å®ç°é€»è¾‘æˆ‘ä»¬åé¢è¿˜ä¼šè®²è§£ï¼Œè¿™é‡Œå…ˆèšç„¦åœ¨ç¼–ç æœ¬èº«ã€‚&lt;/p>
&lt;p>æ¶ˆæ¯ä½“ &lt;code>req&lt;/code> ç»è¿‡äº† pb åè®®çš„åºåˆ—åŒ–ï¼Œå’Œç»è¿‡äº†åºåˆ—åŒ–å’Œå‹ç¼©çš„æ¶ˆæ¯ä½“ &lt;code>reqbody&lt;/code> ä¸€åŒä¼ é€’ç»™äº† &lt;code>frameHead.construct&lt;/code> çš„è°ƒç”¨ï¼Œ&lt;code>trpc.FrameHead&lt;/code> å°è£…äº†åè®®å¸§çš„å¤„ç†é€»è¾‘ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒçš„ &lt;code>construct&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/construct.webp" alt="">
&lt;figcaption>construct æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>ç†è§£äº†è¿™ä¸ªåè®®ï¼Œç»“åˆå‰é¢è®²åˆ°çš„è¢«è°ƒæ–¹è§£ç ä»¥åŠååºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥è½»æ¾çŸ¥é“æ€ä¹ˆå¯¹ tRPC å¸§è¿›è¡Œåˆ†è§£äº†ï¼Œè¿›è€Œæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“è¢«è°ƒæ–¹æ˜¯å¦‚ä½•è·å¾—è¯·æ±‚çš„å¤´æ•°æ®äº†ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/parse-headers.webp" alt="">
&lt;figcaption>è§£æåè®®å¤´å›¾ç¤º&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h3 id="é“¾è·¯é€ä¼ åŸç†">é“¾è·¯é€ä¼ åŸç†&lt;/h3>
&lt;p>é“¾è·¯é€ä¼ ç”¨äºéåŠŸèƒ½æ€§éœ€æ±‚çš„ä¿¡æ¯ä¼ é€’ï¼Œæœ€å¸¸ç”¨çš„ä¾‹å­å°±æ˜¯åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªã€‚åœ¨ tRPC-Go æ¡†æ¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ &lt;code>(*codec.Message).WithClientMetaData&lt;/code> åœ¨è¿è¡Œæ—¶ä¸­è®¾ç½®é“¾è·¯é€ä¼ ä¿¡æ¯ï¼Œä½†æ˜¯åœ¨åè®®é‡Œï¼Œæ˜¯æ€ä¹ˆä¼ è¾“çš„å‘¢ï¼Ÿ&lt;/p>
&lt;p>æˆ‘ä»¬å›åˆ°è®²è§£æ¶ˆæ¯ç¼–ç æ—¶çš„ &lt;code>(*codec.ClientCodec).updateReqHead&lt;/code> æ–¹æ³•çš„é€»è¾‘ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/updateReqHead.webp" alt="">
&lt;figcaption>updateReqHead æ–¹æ³•æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>æˆ‘ä»¬å‰é¢è®²åˆ°ï¼Œ&lt;code>req&lt;/code> æ˜¯æŠ¥æ–‡å¤´ï¼Œè¿™é‡Œ &lt;code>setClientTransInfo&lt;/code> å°†æ¶ˆæ¯ä½“ç»“æ„ä¸­çš„ &lt;code>ClientMetaData&lt;/code> æ‹·è´ç»™äº†æŠ¥æ–‡å¤´ä¸­çš„ &lt;code>TransInfo&lt;/code> å­—æ®µï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/TransInfo.webp" alt="">
&lt;figcaption>TransInfo ç›¸å…³æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/TransInfo2.webp" alt="">
&lt;figcaption>é“¾è·¯é€ä¼ å›¾ç¤º&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>ä¸Šé¢çš„å›¾ç‰‡å±•ç¤ºäº†è¿è¡Œæ—¶å†…å­˜ä¸­çš„ msg ç»“æ„åŒ–æ•°æ®çš„å­—æ®µå¦‚ä½•å’Œ tRPC åè®®æ¶ˆæ¯å¤´ä¸­çš„ç‰¹å®šå­—æ®µæ˜ å°„ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†é“¾è·¯é€ä¼ ä¿¡æ¯ï¼Œtrpc åè®®è¿˜å°†è¯·æ±‚ ID å’Œè¶…æ—¶æ§åˆ¶åšäº†æ ‡å‡†åŒ–ã€‚&lt;/p>
&lt;h3 id="æ‹¦æˆªå™¨">æ‹¦æˆªå™¨&lt;/h3>
&lt;p>tRPC-Go æ¡†æ¶çš„æ‹¦æˆªå™¨æ˜¯æ—¥å¸¸å¼€å‘ä¸­ä¸å¾—ä¸æ¥è§¦çš„ç»„ä»¶ï¼Œä¹Ÿæ˜¯æ•´ä¸ªæ¡†æ¶ä¸­æœ€æœ‰æ´»åŠ›çš„éƒ¨åˆ†ã€‚æ‹¦æˆªå™¨æ˜¯ä¸€ç§é¢å‘åˆ‡ç‰‡ç¼–ç¨‹æ€æƒ³çš„è®¾è®¡äº§ç‰©ã€‚é€šå¸¸ç”¨äºä¸€äº›éåŠŸèƒ½æ€§éœ€æ±‚çš„å®ç°ï¼Œæ¯”å¦‚æ—¥å¿—æ‰“å°ã€é“¾è·¯è¿½è¸ªã€ç›‘æ§ä¸ŠæŠ¥ä»¥åŠè®¤è¯é€»è¾‘ç­‰ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/filters.webp" alt="">
&lt;figcaption>æ‹¦æˆªå™¨åŸç†å›¾ç¤º&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>ä¸Šé¢çš„å›¾ç‰‡æ˜¯ tRPC-Go æ¡†æ¶ä¸­æ‹¦æˆªå™¨é“¾çš„å›¾ç¤ºï¼Œ&lt;code>callFunc&lt;/code> æ˜¯æ¡†æ¶å†…éƒ¨å®šä¹‰çš„æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼Œä¸Šé¢çš„ filter åˆ™æ˜¯æ¡†æ¶é…ç½®çš„å¤šä¸ªè¿‡æ»¤å™¨ï¼Œä»–ä»¬åœ¨æœåŠ¡å¯åŠ¨æ—¶è¢«æ³¨å†Œåˆ°è¿‡æ»¤å™¨é“¾ä¸­ã€‚åœ¨è¿è¡Œæ—¶ï¼Œè¿™äº›è¿‡æ»¤å™¨è¢«åŒ¿åå‡½æ•°åŒ–ï¼Œç›®çš„ä¿æŒå…¶å‡½æ•°ç­¾åå’Œ &lt;code>callFunc&lt;/code> çš„å‡½æ•°ç­¾åä¸€è‡´ï¼Œåœ¨æ¡†æ¶ä¸­å®šä¹‰ä¸º &lt;code>HandleFunc&lt;/code>ã€‚å¸¦ç€è¿™ä¸ªç†è§£ï¼Œæˆ‘ä»¬çœ‹çœ‹ç›¸å…³çš„æºç ï¼Œæˆ‘ä»¬åŒæ ·åªçœ‹ä¸»è°ƒæ–¹çš„é€»è¾‘å°±å¥½äº†ï¼Œè¢«è°ƒæ–¹çš„æ‹¦æˆªå™¨é“¾å®ç°æ˜¯åŸºæœ¬ä¸€æ ·çš„ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/tRPC-Go/Filter.webp" alt="">
&lt;figcaption>æ‹¦æˆªå™¨é“¾æºç &lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>åœ¨ä¸€æ¬¡ RPC è°ƒç”¨ä¸­ï¼Œ&lt;code>next&lt;/code> å‚æ•°å³ä¸ºæˆ‘ä»¬å‰é¢è®²è§£è¿‡çš„ &lt;code>client.callFunc&lt;/code> å‡½æ•°ï¼Œå®ƒä½äºæ•´ä¸ªè¿è¡Œæ¨¡å‹çš„æœ€é‡Œå±‚ã€‚åœ¨ &lt;code>Filter&lt;/code> çš„å®ç°é‡Œï¼Œ90åˆ°97è¡Œä¾æ¬¡è®©æ‹¦æˆªå™¨é“¾ä¸Šçš„æ¯ä¸ªæ‹¦æˆªå™¨éƒ½é€‚é…æˆä¸€ä¸ª &lt;code>ClientHandleFunc&lt;/code> ï¼Œå³å‰é¢å›¾ç‰‡ä¸­çš„åŒ¿åå‡½æ•°ï¼Œå¹¶ä¸”è®©è¿™ä¸ªå‡½æ•°è¢«å…¶æ›´å‰é¢çš„ä¸€ä¸ªæ‹¦æˆªå™¨æ‰€å¼•ç”¨ï¼Œä»¥æ­¤å®ç°äº†å°†æ‹¦æˆªå™¨å’Œæ ¸å¿ƒçš„ &lt;code>client.callFunc&lt;/code> å‡½æ•°è¿æ¥èµ·æ¥ã€‚äº‹å®ä¸Šï¼Œè¿™é‡Œçš„ä»£ç è¡Œæ•°ä¸å¤šï¼Œä½†æ˜¯å› ä¸ºå¾ªç¯å¼•ç”¨äº†åŒä¸€ä¸ªå˜é‡ï¼Œé˜…è¯»èµ·æ¥è¿˜æŒºè´¹åŠ²çš„ã€‚&lt;/p>
&lt;p>æ¯ä¸ªåŒ¿åå‡½æ•°éƒ½åŒ…è£…äº†å¯¹åº”çš„ä¸€ä¸ªæ‹¦æˆªå™¨ï¼ŒåŒæ—¶åœ¨è°ƒç”¨ä¸­ç»™æ‹¦æˆªå™¨ä¼ é€’äº†å…¶åä¸€ä¸ªæ‹¦æˆªå™¨çš„é€‚é…å‡½æ•°ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>tRPC-Go æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ RPC æ¡†æ¶ï¼Œå®Œæ•´çš„æ¨¡å—æ€è€ƒç¡®ä¿äº†ä¸šåŠ¡çš„é€‚åº”æ€§ï¼ŒåŠ ä¸Šæ’ä»¶æœºåˆ¶åˆä¿è¯äº†ä¸šåŠ¡çš„å¯æ‰©å±•æ€§ï¼Œè®© tRPC æ¡†æ¶æˆä¸ºé›†å›¢å±‚é¢çš„ç»Ÿä¸€æ¡†æ¶å…·å¤‡äº†å®åŠ›ã€‚æœ¬æ–‡é€šè¿‡ä¸€ä¸ª RPC è°ƒç”¨è¿‡ç¨‹ä»ç²—åˆ°ç»†çš„è®²è§£ï¼Œå±•ç°äº†æ¡†æ¶å†…éƒ¨æ ¸å¿ƒé€»è¾‘çš„å®ç°é€»è¾‘ã€‚ä½†æ˜¯è¿™é‡Œè®²è§£çš„å†…å®¹åªæ˜¯ tRPC-Go æ¡†æ¶çš„å†°å±±ä¸€è§’ï¼Œè¿˜æœ‰æ›´å¤šçš„æ¯”å¦‚æŒ‡æ ‡ç›‘æ§ã€æ€§èƒ½æ²»ç†ä»¥åŠç†”æ–­å¤„ç†ç­‰åŠŸèƒ½çš„å†…å®¹ï¼Œè¿™äº›åŠŸèƒ½åˆ†å¸ƒåœ¨æ•´ä¸ª RPC è°ƒç”¨å’Œå“åº”è¿‡ç¨‹çš„è§’è§’è½è½ï¼Œå¦‚æœä½ åœ¨é˜…è¯»å®Œæœ¬æ–‡åï¼Œä»ç„¶æœ‰å…´è¶£ç ”ç©¶ tRPC-Go æ¡†æ¶çš„å®ç°åŸç†ï¼Œè¿˜éœ€è¦è‡ªè¡Œä¸‹è½½é˜…è¯»æ¡†æ¶æºç ï¼Œè€Œè¿™ç¯‡æ–‡ç« åˆ™æ˜¯ç»™ä½ æä¾›äº†ä¸€ä¸ªä¸Šæ‰‹çš„è„‰ç»œã€‚&lt;/p></description></item><item><title>Golang interface ç±»å‹çš„ nil å±…ç„¶ä¸ç­‰äºå­—é¢é‡ nil?</title><link>https://blog.hackerpie.com/posts/golang/nil-interface-is-not-equal-to-leteral-nil/</link><pubDate>Wed, 20 Sep 2023 12:20:18 +0800</pubDate><guid>https://blog.hackerpie.com/posts/golang/nil-interface-is-not-equal-to-leteral-nil/</guid><description>&lt;h2 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°&lt;/h2>
&lt;p>æ˜¨å¤©å¼€å‘çš„ä¸€æ®µä»£ç åœ¨è¿è¡Œæ—¶é‡åˆ°äº†å¥‡æ€ªçš„ panic é—®é¢˜ï¼ŒæŠ¥é”™ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>runtime error: invalid memory address or nil pointer dereference
&lt;/code>&lt;/pre>&lt;p>ä½†æ˜¯å¥‡æ€ªçš„æ˜¯ï¼Œä»£ç ä¸­ panic å‡ºå¤„ï¼Œæˆ‘æ˜¯æœ‰åˆ¤æ–­ nil çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// è¿™æ˜¯ç›¸å…³çš„ç»“æ„ä½“å®šä¹‰
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> Options &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sourceFrame fmt.Stringer &lt;span style="font-style:italic">// é”™è¯¯æ ¹æºæ ˆé¡µ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// çœç•¥ä¸€å †æ— å…³ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">if&lt;/span> options.sourceFrame != &lt;span style="font-weight:bold">nil&lt;/span> { &lt;span style="font-style:italic">// è¿™é‡Œåˆ¤æ–­äº† options.sourceFrame æ˜¯å¦ä¸º nil
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> metaData[metaKeySourceFrame] = options.sourceFrame.String() &lt;span style="font-style:italic">// è¿™ä¸€è¡Œä»£ç è§¦å‘ panic
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¥½å¥‡æ€ªï¼Œæˆ‘ä¸æ˜¯éƒ½åˆ¤æ–­äº†æ˜¯å¦ä¸º nil äº†å—ï¼Ÿä¸ºä»€ä¹ˆè¿˜ä¼šæŠ¥é”™å‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="é—®é¢˜åˆ†æ">é—®é¢˜åˆ†æ&lt;/h2>
&lt;p>ç»è¿‡ä¸€ç•ªæœç´¢å’Œå­¦ä¹ ï¼Œæœ€ç»ˆå‘ç° golang çš„ä¸€ä¸ªå‘ï¼š&lt;strong>interface ç±»å‹çš„ nil ä¸ç­‰äºå­—é¢é‡ nil&lt;/strong>ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Under the hood, an interface in Golang consists of two elements: type and value.&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨æˆ‘çš„å®é™…ä»£ç ä¸­ï¼Œ&lt;code>sourceFrame&lt;/code> å˜é‡çš„å€¼æ˜¯ &lt;code>{fmt.Stringer | *frame.Frame} *frame.Frame(nil)&lt;/code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äº golang è¿è¡Œæ—¶ï¼Œæˆ‘çš„ &lt;code>sourceFrame&lt;/code> æ˜¯â€œç±»å‹ä¸º frame.Frame çš„æŒ‡é’ˆï¼Œä¸”å€¼ä¸ºç©ºâ€ï¼Œå½“ç”¨å®ƒå»å’Œ &lt;code>nil&lt;/code> å¯¹æ¯”çš„æ—¶å€™ï¼Œå®ƒä»¬è™½ç„¶å€¼æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ç±»å‹ä¸ä¸€æ ·ï¼Œå­—é¢é‡ &lt;code>nil&lt;/code> çš„ç±»å‹ä¸º &lt;code>nil&lt;/code>ã€‚&lt;/p>
&lt;h3 id="ç¤ºä¾‹ç¨‹åº">ç¤ºä¾‹ç¨‹åº&lt;/h3>
&lt;h4 id="ç¨‹åº1æœ‰ç±»å‹çš„-nil">ç¨‹åº1ï¼šæœ‰ç±»å‹çš„ nil&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">package&lt;/span> main
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> &lt;span style="font-style:italic">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> main() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">var&lt;/span> a &lt;span style="font-weight:bold">interface&lt;/span>{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Printf(&lt;span style="font-style:italic">&amp;#34;%T\n&amp;#34;&lt;/span>, &lt;span style="font-weight:bold">nil&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Printf(&lt;span style="font-style:italic">&amp;#34;%T\n&amp;#34;&lt;/span>, a)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> a = (*&lt;span style="">string&lt;/span>)(&lt;span style="font-weight:bold">nil&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Printf(&lt;span style="font-style:italic">&amp;#34;%T\n&amp;#34;&lt;/span>, (*&lt;span style="">string&lt;/span>)(&lt;span style="font-weight:bold">nil&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Printf(&lt;span style="font-style:italic">&amp;#34;%T\n&amp;#34;&lt;/span>, a)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªä»£ç æµ‹è¯•ä¸åŒç±»å‹çš„ nilï¼Œè¾“å‡ºç»“æœä¸ºï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>&amp;lt;nil&amp;gt;
&amp;lt;nil&amp;gt;
*string
*string
&lt;/code>&lt;/pre>&lt;h4 id="ç¨‹åº2æµ‹è¯•-interface-ç±»å‹çš„-nil-å’Œå­—é¢é‡-nil-æ˜¯å¦ç›¸ç­‰">ç¨‹åº2ï¼šæµ‹è¯• interface ç±»å‹çš„ nil å’Œå­—é¢é‡ nil æ˜¯å¦ç›¸ç­‰&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">package&lt;/span> main
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> main() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> emptyStringPtr := (*&lt;span style="">string&lt;/span>)(&lt;span style="font-weight:bold">nil&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(emptyStringPtr == &lt;span style="font-weight:bold">nil&lt;/span>) &lt;span style="font-style:italic">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">var&lt;/span> a &lt;span style="font-weight:bold">interface&lt;/span>{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(a == &lt;span style="font-weight:bold">nil&lt;/span>) &lt;span style="font-style:italic">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> a = emptyStringPtr
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(a == &lt;span style="font-weight:bold">nil&lt;/span>) &lt;span style="font-style:italic">// false
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(a == (*&lt;span style="">string&lt;/span>)(&lt;span style="font-weight:bold">nil&lt;/span>)) &lt;span style="font-style:italic">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> fmt.Println(a == emptyStringPtr) &lt;span style="font-style:italic">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> fmt.Println(a.(*&lt;span style="">string&lt;/span>) == &lt;span style="font-weight:bold">nil&lt;/span>) &lt;span style="font-style:italic">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªä»£ç åˆ†åˆ«æµ‹è¯•äº†å…·ä½“ç±»å‹çš„ç©ºæŒ‡é’ˆå’Œç±»å‹ä¸ºç©ºæ¥å£çš„ç©ºæŒ‡é’ˆå’Œå­—é¢é‡ nil çš„æ¯”è¾ƒï¼Œè¾“å‡ºç»“æœå·²ç»å¯¹åº”æ³¨é‡Šåœ¨å¯¹åº”ä»£ç æœ«å°¾ã€‚&lt;/p>
&lt;p>æ‰€ä»¥é€šè¿‡è¿™ä¸ªæµ‹è¯•å¯ä»¥ç¡®è®¤ï¼š&lt;/p>
&lt;ol>
&lt;li>å…·ä½“ç±»å‹çš„ç©ºæŒ‡é’ˆå’Œå­—é¢é‡ nil æ˜¯ç›¸ç­‰çš„ï¼›&lt;/li>
&lt;li>ç±»å‹ä¸ºæ¥å£çš„ç©ºæŒ‡é’ˆæ˜¯å¦ç­‰äºå­—é¢é‡ nilï¼Œå–å†³äºå®ƒçš„å€¼æ˜¯å¦ä¸º nilï¼Œå¹¶ä¸”å®ƒçš„ç±»å‹ä¹Ÿä¸º nilï¼›&lt;/li>
&lt;li>å¦‚æœæƒ³è¦å°†ç±»å‹ä¸ºæ¥å£çš„å˜é‡å’Œå­—é¢é‡ nil è¿›è¡Œæ¯”è¾ƒï¼Œéœ€è¦å°†å®ƒä»¬è½¬æ¢ä¸ºå…·ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œç„¶åå†è¿›è¡Œæ¯”è¾ƒã€‚&lt;/li>
&lt;/ol>
&lt;p>ä½†æ˜¯è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªå¥½ç©çš„äº‹æƒ…ï¼Œå°±æ˜¯æŒ‰ç…§è¿™ä¸ªè§„å¾‹ï¼Œä¸‰ä¸ªå˜é‡ä¹‹é—´çš„ç›¸ç­‰æ€§ï¼Œæ˜¯æ²¡æœ‰ä¼ é€’æ€§çš„ï¼Œå› ä¸º &lt;code>a == emptyStringPtr&lt;/code>ï¼Œä¸” &lt;code>emptyStringPtr == nil&lt;/code>ï¼Œä½†æ˜¯ &lt;code>a != nil&lt;/code>ã€‚ğŸ˜³
çŒœæµ‹è¿™æ˜¯å› ä¸º golang åœ¨ä¸­é—´åšäº†éšå¼ç±»å‹è½¬æ¢ï¼Œå› ä¸ºå‰ä¸¤ç§ç­‰å¼å¯ä»¥æ¨å¯¼å…·ä½“ç±»å‹ï¼Œè€Œæœ€åä¸€ç§ç­‰å¼æ— æ³•æ¨å¯¼å…·ä½“ç±»å‹ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡Œéšå¼ç±»å‹è½¬æ¢ã€‚&lt;/p>
&lt;h2 id="å¦‚ä½•ä¼˜é›…åœ°åˆ¤æ–­-interface-ç±»å‹çš„-nil">å¦‚ä½•ä¼˜é›…åœ°åˆ¤æ–­ interface ç±»å‹çš„ nil?&lt;/h2>
&lt;p>é™¤äº†å‰é¢è¯´çš„è½¬æ¢ä¸ºå…·ä½“ç±»å‹å†æ¯”è¾ƒï¼Œä½†æ˜¯é€šå¸¸æ¥è¯´è¿è¡Œæ—¶å…·ä½“ç±»å‹ä¸å¯é¢„çŸ¥ã€‚å¦ä¸€ç§å¯è¡Œçš„æ–¹æ³•æ˜¯é€šè¿‡åå°„æ¥å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">package&lt;/span> main
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;reflect&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> main() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">var&lt;/span> a &lt;span style="font-weight:bold">interface&lt;/span>{} = (*&lt;span style="">string&lt;/span>)(&lt;span style="font-weight:bold">nil&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(a == &lt;span style="font-weight:bold">nil&lt;/span>) &lt;span style="font-style:italic">// false
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> fmt.Println(reflect.ValueOf(a).Kind() == reflect.Ptr &amp;amp;&amp;amp; reflect.ValueOf(a).IsNil()) &lt;span style="font-style:italic">// true
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://glucn.medium.com/golang-an-interface-holding-a-nil-value-is-not-nil-bb151f472cc7">Golang: An interface holding a nil value is not nil&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://yourbasic.org/golang/gotcha-why-nil-error-not-equal-nil/">Nil is not nil&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Golang 1.18 åŠ 1.18.1 ä¸­ iota ä¸ä» 0 å¼€å§‹</title><link>https://blog.hackerpie.com/posts/golang/iota-not-begins-with-0-in-1.18/</link><pubDate>Tue, 07 Mar 2023 14:32:18 +0800</pubDate><guid>https://blog.hackerpie.com/posts/golang/iota-not-begins-with-0-in-1.18/</guid><description>&lt;h1 id="ä¸€å¥è¯è¯»å®Œç‰ˆ">ä¸€å¥è¯è¯»å®Œç‰ˆ&lt;/h1>
&lt;p>golang æºç ä¸­ä½¿ç”¨äº† &lt;code>iota&lt;/code> å®šä¹‰æšä¸¾é‡ï¼Œå¹¶ä¸”æ²¡æœ‰æ˜¾å¼å£°æ˜èµ·å§‹å€¼çš„è¯ï¼Œè¯·ç¡®ä¿æ²¡æœ‰ä½¿ç”¨ golang 1.18 æˆ–è€… golang 1.18.1ã€‚&lt;/p>
&lt;h1 id="è¯¦ç»†è¯´æ˜ç‰ˆ">è¯¦ç»†è¯´æ˜ç‰ˆ&lt;/h1>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>æ˜¨å¤©åœ¨çº¿ä¸Šç³»ç»Ÿä¸­å‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼Œä»£ç ä¸­æœ‰ä¸€è¡Œ &lt;code>response.Code == konst.SuccessCode&lt;/code> ä»£ç çš„åˆ¤æ–­ç»“æœæ€»æ˜¯ &lt;code>false&lt;/code>ï¼Œç»è¿‡æ—¥å¿—æ ¸æŸ¥ï¼Œç¡®è®¤ &lt;code>response.Code&lt;/code> ä¸€å®šæ˜¯ &lt;code>0&lt;/code>ï¼Œä½†æ˜¯ç¥å¥‡çš„æ˜¯ &lt;code>konst.SuccessCode&lt;/code> å´æ˜¯ 1ï¼Œå…¶å®šä¹‰æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">package&lt;/span> konst
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">const&lt;/span> SuccessCode = &lt;span style="font-weight:bold">iota&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€å¥‡æ€ªçš„æ˜¯ï¼Œgoland IDE æç¤ºè¿™ä¸ªå¸¸é‡è§£æåçš„å€¼ä¹Ÿæ˜¯ 0ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆä¼šæ˜¯ 1 å‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="é—®é¢˜å®šä½">é—®é¢˜å®šä½&lt;/h2>
&lt;p>ç»è¿‡ä½¿ç”¨ä¸åŒçš„ golang ç‰ˆæœ¬ç¼–è¯‘åï¼Œåœ¨æœ¬åœ°å¤ç°äº†è¿™ä¸ªç¼ºé™·ï¼Œé—®é¢˜å‡ºåœ¨ golang 1.18 ä¸Šã€‚å…·ä½“å¯çœ‹ï¼š&lt;/p>
&lt;p>&lt;a href="https://go-review.googlesource.com/c/go/+/401134/4">https://go-review.googlesource.com/c/go/+/401134/4&lt;/a>&lt;/p>
&lt;p>æ­¤ç¼ºé™·æ˜¯ç”±äºåœ¨ golang 1.18 å’Œ 1.18.1 ä¸­è¿›è¡Œ iota æšä¸¾æ—¶ï¼Œæšä¸¾å€¼å¹¶ä¸æ€»æ˜¯ä» 0 å¼€å§‹é€’å¢ã€‚åœ¨è¿™ä¸ªé—®é¢˜çš„ä¿®å¤ç‰ˆæœ¬ 1.18.2 ä¸­ï¼Œå·²ç»ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ã€‚å› æ­¤ï¼Œå‡çº§åˆ° 1.18.2 ç‰ˆæœ¬æ˜¯è§£å†³æ­¤é—®é¢˜çš„æœ€ç®€å•æ–¹æ³•ã€‚å¦ä¸€ä¸ªè§£å†³æ–¹æ³•æ˜¯åœ¨å®šä¹‰æšä¸¾æ—¶æŒ‡å®šå€¼ &lt;code>= 0&lt;/code>ï¼Œè¿™å°†é¿å…å‡ºç° iota å€¼é”™è¯¯çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>å®˜æ–¹ä¿®å¤çš„è®°å½•è§ï¼šhttps://github.com/golang/go/issues/52441&lt;/p>
&lt;h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h2>
&lt;p>è§£å†³æ–¹æ¡ˆæ¯”è¾ƒç®€å•ï¼Œå¯ä»¥å‡çº§åˆ° golang 1.18.2 ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬å·²ç»ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœä¸æƒ³å‡çº§ï¼Œä¹Ÿå¯ä»¥åœ¨ konst.SuccessCode çš„åé¢åŠ ä¸Š &lt;code>= 0&lt;/code>ï¼Œè¿™æ ·å°±èƒ½é¿å…å‡ºç° iota å€¼é”™è¯¯çš„é—®é¢˜äº†ã€‚&lt;/p>
&lt;p>å¦å¤–ï¼Œæœ€å¥½çš„å®è·µæ˜¯ï¼Œå§‹ç»ˆåœ¨ç¬¬ä¸€ä¸ª iota ä¸ŠåŠ ä¸Š &lt;code>= 0&lt;/code>ï¼Œä¹Ÿèƒ½é˜²æ­¢ä»¥åç±»ä¼¼é—®é¢˜çš„å‡ºç°ã€‚&lt;/p></description></item><item><title>è´ªå¿ƒç®—æ³•ï¼šLeetCode 409 æœ€é•¿å›æ–‡ä¸²åŒ 100 é¢˜è§£</title><link>https://blog.hackerpie.com/posts/algorithms/greedy/longest-palindrome/</link><pubDate>Sat, 14 Jan 2023 09:13:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/algorithms/greedy/longest-palindrome/</guid><description>&lt;p>è¿™ç¯‡æ–‡ç« åˆ†äº«å¦‚ä½•å€ŸåŠ©ä½çš„æ€æƒ³å°† LeetCode 409â€”â€”æœ€é•¿å›æ–‡ä¸²çš„é¢˜è§£ä¼˜åŒ–åˆ°åŒ 100ã€‚&lt;/p>
&lt;h2 id="é¢˜ç›®">é¢˜ç›®&lt;/h2>
&lt;p>é¢˜ç›®æœ¬èº«æ˜¯ easy çº§åˆ«çš„ï¼ŒåŸé¢˜ç›®æ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>ç»™å®šä¸€ä¸ªåŒ…å«å¤§å†™å­—æ¯å’Œå°å†™å­—æ¯çš„å­—ç¬¦ä¸²Â sÂ ï¼Œè¿”å›Â é€šè¿‡è¿™äº›å­—æ¯æ„é€ æˆçš„ æœ€é•¿çš„å›æ–‡ä¸²Â ã€‚
åœ¨æ„é€ è¿‡ç¨‹ä¸­ï¼Œè¯·æ³¨æ„ åŒºåˆ†å¤§å°å†™ ã€‚æ¯”å¦‚Â &amp;#34;Aa&amp;#34;Â ä¸èƒ½å½“åšä¸€ä¸ªå›æ–‡å­—ç¬¦ä¸²ã€‚
&lt;/code>&lt;/pre>&lt;h2 id="æ€è·¯åˆ†æ">æ€è·¯åˆ†æ&lt;/h2>
&lt;p>åŸºæœ¬çš„æ€è·¯æ˜¯éå†å­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰å­—ç¬¦ï¼Œå¹¶ä¸”ç»Ÿè®¡æ¯ä¸ªå­—ç¬¦å‡ºç°çš„æ¬¡æ•°ï¼Œæœ€åæ±‚å’Œ &lt;code>length&lt;/code>ï¼š&lt;/p>
&lt;ul>
&lt;li>å¦‚æœå­—ç¬¦å‡ºç°æ¬¡æ•°ä¸ºå¶æ•°ï¼Œåˆ™å°†ç»“æœ &lt;code>length&lt;/code> ç›´æ¥åŠ  2ï¼›&lt;/li>
&lt;li>å¦‚æœå­—ç¬¦å‡ºç°æ¬¡æ•°ä¸ºå¥‡æ•°ï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­ï¼š
&lt;ul>
&lt;li>å¦‚æœ &lt;code>length&lt;/code> æœªæ›¾åŠ è¿‡å¥‡æ•°ï¼Œåˆ™å°†ç»“æœ &lt;code>length&lt;/code> ç›´æ¥åŠ ä¸Šè¿™ä¸ªå¥‡æ•°ï¼›&lt;/li>
&lt;li>å¦‚æœ &lt;code>length&lt;/code> å·²ç»åŠ è¿‡å¥‡æ•°ï¼Œåˆ™å°†ç»“æœ &lt;code>length&lt;/code> ç›´æ¥åŠ ä¸Šè¿™ä¸ªå¥‡æ•°-1ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>è¿™ä¸ªæ€è·¯çš„åŸºæœ¬åŸåˆ™æ˜¯æ‰€æœ‰å‡ºç°æ¬¡æ•°ä¸ºå¶æ•°çš„å­—ç¬¦å¯ä»¥åˆšå¥½ä½äºå›æ–‡ä¸­å¿ƒçš„ä¸¤ä¾§ï¼Œè€Œæœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªé•¿åº¦ä¸ºå¥‡æ•°çš„å›æ–‡ä¸­å¿ƒï¼Œè¶…è¿‡çš„å­ä¸²å°±åªèƒ½èˆå¼ƒæ‰ä¸€ä¸ªå­—ç¬¦ä½¿å…¶å˜æˆå¶æ•°é•¿åº¦ã€‚&lt;/p>
&lt;h3 id="å¯¹åº”ä»£ç ">å¯¹åº”ä»£ç &lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> longestPalindrome(s &lt;span style="">string&lt;/span>) &lt;span style="">int&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stats := &lt;span style="font-weight:bold">map&lt;/span>[&lt;span style="">rune&lt;/span>]&lt;span style="">int&lt;/span>{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> _, b := &lt;span style="font-weight:bold">range&lt;/span> s {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> _, found := stats[b]; !found {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stats[b] = 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stats[b]++
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> length := 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hasOdd := &lt;span style="font-weight:bold">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> _, count := &lt;span style="font-weight:bold">range&lt;/span> stats {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> count % 2 == 0 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> length += count
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> !hasOdd {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> length += count
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hasOdd = &lt;span style="font-weight:bold">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> length += (count - 1)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> length
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªé¢˜è§£å¾—åˆ°çš„ç»“æœæ˜¯ 100% æ—¶é—´ä¼˜åŠ¿ï¼Œ39% ç©ºé—´ä¼˜åŠ¿ï¼Œç©ºé—´å ç”¨çœ‹æ¥æœ‰æ¯”è¾ƒå¤§çš„ä¼˜åŒ–ç©ºé—´ã€‚&lt;/p>
&lt;h2 id="ä¼˜åŒ–æ€è·¯åˆ†æ">ä¼˜åŒ–æ€è·¯åˆ†æ&lt;/h2>
&lt;p>ç¬¬ä¸€éçš„ç®—æ³•æ€è·¯ï¼Œä¸ºäº†ç»Ÿè®¡ï¼Œæˆ‘ä»¬ç”¨äº†ä¸€ä¸ªå­—å…¸æ¥å­˜å‚¨å„ä¸ªå­—ç¬¦çš„å‡ºç°æ¬¡æ•°ï¼Œå¹¶ä¸”éœ€è¦åœ¨ç»Ÿè®¡å®Œæˆåå†ä¸€æ¬¡éå†ç»Ÿè®¡å¾—åˆ°çš„å­—å…¸ã€‚æœ€æ˜æ˜¾çš„é—®é¢˜æ˜¯ç©ºé—´çš„æ¶ˆè€—ï¼Œæ¯ä¸ªå­—ç¬¦éƒ½éœ€è¦ä¸€ä¸ª int ç±»å‹çš„æ•°æ®ç»“æ„ï¼Œä¸€èˆ¬æ¶‰åŠå­—å…¸ä»¥åŠè®¡æ•°ï¼Œæˆ‘éƒ½ä¼šåœ¨ä¼˜åŒ–çš„æ—¶å€™æƒ³ä¸€ä¸‹èƒ½ä¸èƒ½ç”¨ä½æ¥æ ‡è®°ã€‚&lt;/p>
&lt;p>å› ä¸ºé¢˜ç›®ä¸­ç»™å®šå­—ç¬¦ä¸²ä¸­æ‰€æœ‰å¯èƒ½çš„å­—ç¬¦å‡ä¸ºå¤§å°å†™å­—æ¯ï¼Œè€Œå‚è€ƒ ASCII ç ä¸­ï¼Œ&lt;code>'A'&lt;/code> çš„ç å€¼ä¸º 65ï¼Œæœ€å¤§ç å€¼çš„ &lt;code>'z'&lt;/code> ä¸º 122ï¼Œç›¸å·® &lt;code>57&lt;/code>ï¼Œå¦‚æœæˆ‘ä»¬ç”¨ä¸€ä¸ª &lt;code>uint64&lt;/code> ç±»å‹çš„å˜é‡æ¥è¡¨ç¤ºï¼Œåˆ™åˆšå¥½å¯ä»¥å®¹çº³æ‰€æœ‰å­—æ¯çš„è¡¨ç¤ºï¼Œå› ä¸º 57 &amp;lt; 64ã€‚&lt;/p>
&lt;p>è€Œæ”¹ä¸ºä½æ ‡è®°ä¹‹åï¼Œå› ä¸ºä¸€ä¸ªä½åªèƒ½è¡¨ç¤º 0 æˆ–è€… 1ï¼Œåˆ™æˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸€ä¸ªå­—ç¬¦å‡ºç°æ¬¡æ•°è¶…è¿‡ 1 æ¬¡ä¹‹åçš„å¤„ç†ã€‚æ ¹æ®å›æ–‡çš„ç‰¹ç‚¹ï¼Œåªè¦ä¸€ä¸ªå­—ç¬¦ä¸¤ä¸¤å‡ºç°ï¼Œåˆ™ä¸€å®šå¯ä»¥æ·»åŠ åˆ°å›æ–‡ä¸²ä¸­ï¼Œäºæ˜¯æˆ‘ä»¬è€ƒè™‘æ¯æ¬¡ç”¨ä¸€ä¸ªä½è¡¨ç¤ºæŸä¸ªå­—ç¬¦æ˜¯å¦å·²ç»å‡ºç°è¿‡ï¼Œå¦‚æœæ˜¯ï¼Œå†é‡åˆ°ä¸€ä¸ªæ—¶ï¼Œè¯¥ä½ç½®ä¸º 0ï¼Œ&lt;code>length&lt;/code> åŠ  2ï¼›å¦‚æœæŸä¸ªå­—ç¬¦æœªæ›¾å‡ºç°æˆ–è€…ä¹‹å‰å·²ç»å› ä¸ºå¶æ•°ç½®ä¸º0ï¼Œå†é‡åˆ°ä¸€ä¸ªç›¸åŒå­—ç¬¦æ—¶ï¼Œè¯¥å­—ç¬¦æ‰€å¯¹åº”çš„ä½ç½®ä¸º 1ã€‚&lt;/p>
&lt;p>ç®—æ³•çš„æ•´ä½“æ€è·¯æè¿°ï¼š&lt;/p>
&lt;ul>
&lt;li>åˆå§‹åŒ– &lt;code>uint64&lt;/code> ç±»å‹å˜é‡ stats&lt;/li>
&lt;li>åˆå§‹åŒ– &lt;code>int&lt;/code> ç±»å‹å˜é‡ length&lt;/li>
&lt;li>éå†å­—ç¬¦ä¸² s ä¸­çš„æ¯ä¸ªå­—ç¬¦
&lt;ul>
&lt;li>æŸ¥æ‰¾è¯¥å­—ç¬¦åœ¨ stats ä¸­å¯¹åº”çš„ä½çš„å€¼ bit&lt;/li>
&lt;li>å¦‚æœ bit ä¸º 0ï¼Œå°†è¯¥ bit ç½®ä¸º 1ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªå­—ç¬¦&lt;/li>
&lt;li>å¦‚æœ bit ä¸º 1ï¼Œå°†è¯¥ bit ç½®ä¸º 0ï¼Œlength åŠ  2&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>æœ€åéå† stats ä¸­çš„æ¯ä¸€ä¸ªä½
&lt;ul>
&lt;li>å¦‚æœæŸä½ä¸ä¸º 0ï¼Œåˆ™ length åŠ  1ï¼ŒåŒæ—¶é€€å‡ºéå†&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å¯¹åº”ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> longestPalindrome(s &lt;span style="">string&lt;/span>) &lt;span style="">int&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">var&lt;/span> stats &lt;span style="">uint64&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">var&lt;/span> length &lt;span style="">int&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> i := 0; i &amp;lt; len(s); i++ {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> bits := s[i] - &lt;span style="font-style:italic">&amp;#39;A&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> stats &amp;gt;&amp;gt; bits &amp;amp; 1 == 1 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> length += 2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stats &amp;amp;= (math.MaxUint64 - 1&amp;lt;&amp;lt;bits)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">continue&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stats |= 1&amp;lt;&amp;lt;bits
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> i := 0; i &amp;lt; 64; i++ {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> stats &amp;gt;&amp;gt; i &amp;amp; 1 == 1 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> length++
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> length
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªæ–°çš„æ€è·¯é‡Œï¼Œä¸€æ–¹é¢ä½¿ç”¨ä¸€ä¸ª &lt;code>uint64&lt;/code> ä»£æ›¿äº†åŸæ¥çš„å­—å…¸ï¼Œç©ºé—´å¤æ‚åº¦å˜æˆ O(0)ï¼Œå¦å¤–ä½¿ç”¨äº†ä½æ“ä½œï¼Œé€»è¾‘ç¨å¾®å¤æ‚äº†ä¸€ç‚¹ã€‚æœ€ç»ˆæäº¤ç»“æœä¸ºåŒ 100ã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/greedy/409_longest_palindrome_double_100.png" alt="">
&lt;figcaption>LeetCode 409 æäº¤ç»“æœ&lt;/figcaption>
&lt;/figure>
&lt;/p></description></item><item><title>è´ªå¿ƒç®—æ³•ï¼šæ•°ç»„æ‹†åˆ† LeetCode 561</title><link>https://blog.hackerpie.com/posts/algorithms/greedy/split_arrays/</link><pubDate>Thu, 12 Jan 2023 10:50:28 +0800</pubDate><guid>https://blog.hackerpie.com/posts/algorithms/greedy/split_arrays/</guid><description>&lt;p>LeetCode #561 æ˜¯ä¸€é“è´ªå¿ƒç®—æ³•çš„ easy é¢˜ï¼Œè®°å½•è¿™é“é¢˜ä¸»è¦æ˜¯æƒ³æ¢³ç†ä¸€ä¸‹æ•°å­¦è¯æ˜çš„è¿‡ç¨‹ã€‚è´ªå¿ƒç®—æ³•æ¯”è¾ƒæœ‰è¶£çš„æ˜¯ï¼Œä»£ç ä¸€èˆ¬å†™èµ·æ¥éƒ½ä¸å¤æ‚ï¼Œä½†æ˜¯è¯æ˜æœ¬èº«æ‰æ˜¯ä¸ªæ¯”è¾ƒéš¾çš„äº‹æƒ…ã€‚æ¯”å¦‚åœ¨é¢è¯•è¿‡ç¨‹ä¸­ï¼Œä½ å¯èƒ½æ„è¯†åˆ°äº†ä¸€ä¸ªé¢˜ç›®éœ€è¦ç”¨è´ªå¿ƒç®—æ³•ï¼Œæˆ–è€…æ˜¯ä½ ä¸å¥½åˆ¤æ–­æ˜¯å¦å¯ä»¥ä½¿ç”¨è´ªå¿ƒç®—æ³•ï¼Œä½†æ˜¯å°±æ˜¯æ— æ³•å‘é¢è¯•å®˜è¯æ˜è‡ªå·±çš„åˆ†æã€‚&lt;/p>
&lt;p>å…ˆçœ‹é¢˜ç›®å§ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>ç»™å®šé•¿åº¦ä¸ºÂ 2nÂ çš„æ•´æ•°æ•°ç»„ nums ï¼Œä½ çš„ä»»åŠ¡æ˜¯å°†è¿™äº›æ•°åˆ†æˆÂ n å¯¹, ä¾‹å¦‚ (a1, b1), (a2, b2), ..., (an, bn) ï¼Œ
ä½¿å¾—ä» 1 åˆ°Â n çš„ min(ai, bi) æ€»å’Œæœ€å¤§ã€‚
è¿”å›è¯¥æœ€å¤§æ€»å’Œ
&lt;/code>&lt;/pre>&lt;p>ç›´è§‰æ˜¯ä½¿ç”¨è´ªå¿ƒç®—æ³•ï¼Œç­–ç•¥æ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>å¯¹æ•°ç»„ nums è¿›è¡Œå‡åºæ’åºï¼Œä¾æ¬¡ä¸¤ä¸¤åˆ†ç»„ï¼Œå–å„ç»„ä¸­ç¬¬ä¸€ä¸ªæ•°çš„å’Œ
&lt;/code>&lt;/pre>&lt;h2 id="è¯æ˜è¿‡ç¨‹">è¯æ˜è¿‡ç¨‹&lt;/h2>
&lt;p>ä¸€èˆ¬è€Œè¨€ï¼Œå¯ä»¥ä½¿ç”¨åè¯æ³•æ¥éªŒè¯è´ªå¿ƒç­–ç•¥çš„æ­£ç¡®æ€§ã€‚&lt;/p>
&lt;p>&lt;strong>å‡è®¾ï¼š&lt;/strong> æœ‰å‡åºæ’åºå¥½çš„æ•°ç»„ &lt;code>a&lt;/code>ï¼ŒæŒ‰ç…§ä¸Šé¢æ‰€è¯´çš„ç­–ç•¥ï¼Œæˆ‘ä»¬å¾—åˆ°åˆ†ç»„ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>(a[0], a[1]), (a[2], a[3]), (a[i-1], a[i]), (a[i+1], a[i+2]), ..., (a[2n-2], a[2n-1])
&lt;/code>&lt;/pre>&lt;p>ç”±äºæ•°ç»„æ˜¯å‡åºï¼Œæ•…æœ‰ &lt;code>a[i-1] â‰¤ a[i] â‰¤ a[i+1] â‰¤ a[i+2]&lt;/code>ï¼Œè¿™å››ä¸ªå…ƒç´ å¯¹åº”çš„åˆ†ç»„ä¸­è¾ƒå°æ•°æ±‚å’Œç»“æœä¸º &lt;code>a[i-1] + a[i+1]&lt;/code>&lt;/p>
&lt;p>é‡æ–°æ’åˆ—ä»&lt;code>a[i-1]&lt;/code>åˆ°&lt;code>a[i+2]&lt;/code>çš„ä¸¤ä¸ªåˆ†ç»„ï¼Œå…±æœ‰4ç§å¯èƒ½çš„ç»„åˆï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>(a[i-1], a[i+1]), (a[i], a[i+2])&lt;/code>ï¼Œå…¶å¯¹åº”å„ç»„è¾ƒå°æ•°æ€»å’Œä¸º &lt;code>a[i-1] + a[i] â‰¤ a[i-1] + a[i+1]&lt;/code>ï¼›&lt;/li>
&lt;li>&lt;code>(a[i-1], a[i+2]), (a[i], a[i+1])&lt;/code>ï¼Œå…¶å¯¹åº”å„ç»„è¾ƒå°æ•°æ€»å’Œä¸º &lt;code>a[i-1] + a[i] â‰¤ a[i-1] + a[i+1]&lt;/code>ï¼›&lt;/li>
&lt;li>&lt;code>(a[i], a[i+1]), (a[i-1], a[i+2])&lt;/code>ï¼Œå…¶å¯¹åº”å„ç»„è¾ƒå°æ•°æ€»å’Œä¸º &lt;code>a[i] + a[i-1] â‰¤ a[i-1] + a[i+1]&lt;/code>ï¼›&lt;/li>
&lt;li>&lt;code>(a[i], a[i+2]), (a[i-1], a[i+1])&lt;/code>ï¼Œå…¶å¯¹åº”å„ç»„è¾ƒå°æ•°æ€»å’Œä¸º &lt;code>a[i] + a[i-1] â‰¤ a[i-1] + a[i+1]&lt;/code>ã€‚&lt;/li>
&lt;/ol>
&lt;p>å³ï¼Œå¦‚æœä¸æŒ‰ç…§å‡åºç»“æœè¿›è¡Œä¸¤ä¸¤åˆ†ç»„ï¼Œåˆ™å„ç»„è¾ƒå°æ•°çš„æ€»å’Œå°äºæˆ–ç­‰äºæŒ‰ç…§å‡åºç»“æœè¿›è¡Œä¸¤ä¸¤åˆ†ç»„çš„å„ç»„è¾ƒå°æ•°çš„æ€»å’Œã€‚&lt;/p>
&lt;h2 id="é¢˜è§£">é¢˜è§£&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> arrayPairSum(nums []&lt;span style="">int&lt;/span>) &lt;span style="">int&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sort.Slice(nums, &lt;span style="font-weight:bold">func&lt;/span>(i, j &lt;span style="">int&lt;/span>) &lt;span style="">bool&lt;/span> { &lt;span style="font-weight:bold">return&lt;/span> nums[i] &amp;lt;= nums[j] })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sum := 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> i := 0; i &amp;lt; len(nums); i += 2 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sum += nums[i]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> sum
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å¤æ‚åº¦åˆ†æ">å¤æ‚åº¦åˆ†æ&lt;/h3>
&lt;ul>
&lt;li>æ—¶é—´å¤æ‚åº¦ï¼š&lt;code>O(nlogn+n)&lt;/code>ï¼Œ&lt;code>nlogn&lt;/code> æ˜¯å¿«æ’çš„æ—¶é—´å¤æ‚åº¦ï¼Œ&lt;code>n&lt;/code> æ˜¯æ•°ç»„éå†çš„æ—¶é—´å¤æ‚åº¦ã€‚&lt;/li>
&lt;li>ç©ºé—´å¤æ‚åº¦ï¼š&lt;code>O(logn)&lt;/code>ï¼Œé€’å½’è°ƒç”¨çš„å†…å­˜å¼€é”€ã€‚&lt;/li>
&lt;/ul></description></item><item><title>Introducing the Schema of Allure Report Tool</title><link>https://blog.hackerpie.com/posts/testing/allure-report-beginners-guide/</link><pubDate>Sun, 18 Dec 2022 21:03:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/testing/allure-report-beginners-guide/</guid><description>&lt;h1 id="background">Background&lt;/h1>
&lt;p>In October, I claimed an issue on the company&amp;rsquo;s internal open source collaboration project. The task was to implement a test report visualization tool for the internal test framework. Because the display effect of Allure is really good, but there is no official detailed description of the underlying schema, so there are some gropings in the implementation process, and it is recorded here, hope it can help someone who may encounter similar problems.&lt;/p>
&lt;h1 id="what-is-allure-report">What is Allure Report?&lt;/h1>
&lt;p>&lt;a href="https://qameta.io/allure-report/">Allure&lt;/a>ï¼Œthe full name of which is Allure Reportï¼Œis a cross programming languages test report tool. The framework provides multiple adapters and bindings in different languages with the underlying and standard schema. It currently supports Java, JavaScript, Python, Ruby, PHP, Kotlin, .Net, and Goã€‚&lt;/p>
&lt;p>Allure is capable to generate clean test reports, which consist of Overview, Categories, Suites, Graphs, Timeline, Behaviors and Packages pages, you can visit &lt;a href="https://allure-framework.github.io/allure-demo">Allure demo&lt;/a> to see the official demo. If you wanna view more different examples, please visit &lt;a href="http://betty.us.es/restest-showcase-demo/">RESTest showcase&lt;/a>.&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure_Report.png" alt="">
&lt;figcaption>allure demo&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>Additionally, Allure supports multiple localesï¼Œcurrently, the official project supports 12 languages, including English and Chineseã€‚&lt;/p>
&lt;p>Allure implements the whole ecosystem based on different programming languages.&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure-architecture.jpg" alt="">
&lt;figcaption>allure architecture&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h1 id="allure-schema">Allure Schema&lt;/h1>
&lt;p>Thanks to the JSON-based and language-independent schema, Allure implements the standard in different languages. For example, you can visit &lt;a href="https://github.com/allure-framework/allure-python/blob/master/allure-python-commons/src/model2.py">allure-python-commons/src/model2.py&lt;/a> to view a Python version.&lt;/p>
&lt;p>However, the official team doesn&amp;rsquo;t provide detailed document about how to use the schema, so it is hard to understand how will the schema affects the final report. By trying and debugging, I have summarized the diagram to show all models and the relationships among them.&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure-models.jpg" alt="">
&lt;figcaption>allure models&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h2 id="a-detailed-demo">A Detailed Demo&lt;/h2>
&lt;p>For references between the schema and the final report, you can start from the below codes which is a basic allure test case:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;test_shell_testcase_failed32&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// The name of the test case
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;failed&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// the result of the test caseï¼Œits enumerations are defined by the `Status`
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;steps&amp;#34;&lt;/span>: [ &lt;span style="font-style:italic">// The steps of the testï¼Œthey are shown in the section &amp;#34;Test body&amp;#34; in the report
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;#@ æµ‹è¯•æ­¥éª¤:17:&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;passed&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;#@ æµ‹è¯•æ­¥éª¤:28:&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;passed&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;#@ æµ‹è¯•æ­¥éª¤:39:&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;passed&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;start&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;1665562034999&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// The beginning time of the test case
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;stop&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;1665562053613&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// The ending time of the test caseï¼Œit is used to calculate the elapsed time with the beginning timeï¼Œfor instance, it is 18s 614ms here
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;uuid&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;test_python_testcase-result-37&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// uuidï¼Œit should be generated by official libraries
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;testCaseId&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;20220411-152848-724647399&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// it should be generated by official libraries, too
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;labels&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;suite&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// suite means it is a special labelï¼Œits value is used to represent the suite name of cases
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tst_suite_common2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tag&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// normal labels, labels are listed in the details of the test case report
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;feature&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tag&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;medium priority&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tag&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;level:3&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tag&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;type:feature&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>the below shows the report corresponding to the above schemaï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure-report-example.png" alt="">
&lt;figcaption>allure case report&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h1 id="how-to-generate-allure-schema-by-official-libraries">How to generate Allure schema by official libraries?&lt;/h1>
&lt;p>Assume you are using Pythonï¼Œyou can use &lt;a href="https://github.com/allure-framework/allure-python/blob/master/allure-python-commons/src/logger.py">&lt;code>AllureFileLogger&lt;/code>&lt;/a>, which is a module in &lt;code>allure-python-commons&lt;/code> official library.&lt;/p>
&lt;p>The belows shows a simple exampleï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">allure_commons.logger&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> AllureFileLogger
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">allure_commons.model2&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> TestResult, Status, Label, Link
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">allure_commons.types&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> LinkType
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">allure_commons.utils&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> now, uuid4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">if&lt;/span> __name__ == &lt;span style="font-style:italic">&amp;#34;__main__&amp;#34;&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger = AllureFileLogger(report_dir=&lt;span style="font-style:italic">&amp;#34;tmp/logger_reports/&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = TestResult(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name=&lt;span style="font-style:italic">&amp;#34;test case&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> status=Status.PASSED,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># statusDetails=&amp;#34;test passed&amp;#34;,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stage=&lt;span style="font-style:italic">&amp;#34;local test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> description=&lt;span style="font-style:italic">&amp;#34;simulation test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> descriptionHtml=&lt;span style="font-style:italic">&amp;#34;&amp;lt;h1&amp;gt;simulation test&amp;lt;/h1&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> start=now()-3000,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stop=now(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uuid=uuid4(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> historyId=uuid4(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> testCaseId=uuid4(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fullName=&lt;span style="font-style:italic">&amp;#34;a fake test case demo&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> labels=[Label(name=&lt;span style="font-style:italic">&amp;#34;owner&amp;#34;&lt;/span>, value=&lt;span style="font-style:italic">&amp;#34;martinhong&amp;#34;&lt;/span>), Label(name=&lt;span style="font-style:italic">&amp;#34;weight&amp;#34;&lt;/span>, value=&lt;span style="font-style:italic">&amp;#34;highest&amp;#34;&lt;/span>)],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> links=[Link(type=LinkType.ISSUE,url=&lt;span style="font-style:italic">&amp;#34;https://google.com.hk&amp;#34;&lt;/span>,name=&lt;span style="font-style:italic">&amp;#34;fake link&amp;#34;&lt;/span>)])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.report_result(result)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It can generates the below schema:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;test case&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;passed&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;stage&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;local test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;simulation test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;descriptionHtml&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;&amp;lt;h1&amp;gt;simulation test&amp;lt;/h1&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;start&amp;#34;&lt;/span>: 1664635107494,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;stop&amp;#34;&lt;/span>: 1664635110494,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;uuid&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;083c72da-668c-406c-a258-ba61f2eec2f2&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;historyId&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;c665bc04-9b63-426f-a7ce-b1981853d775&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;testCaseId&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;2b53d7b0-2127-46ab-8c72-ec2e5c97b759&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;fullName&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;a fake test case demo&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;labels&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;owner&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;martinhong&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;weight&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;highest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;links&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;issue&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;url&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;https://google.com.hk&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;fake link&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Its corresponding report isï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure_simple_case.png" alt="">
&lt;figcaption>allure simple case&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h1 id="references">References&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://qameta.io/allure-report/">Allure Report&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Allure æµ‹è¯•æŠ¥å‘Šå¯è§†åŒ–å·¥å…·å…¥é—¨</title><link>https://blog.hackerpie.com/posts/testing/allure-report-beginners-guide-chinese/</link><pubDate>Sun, 18 Dec 2022 19:03:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/testing/allure-report-beginners-guide-chinese/</guid><description>&lt;h1 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h1>
&lt;p>10æœˆä»½åœ¨å…¬å¸å†…éƒ¨çš„å¼€æºååŒé¡¹ç›®ä¸Šè®¤é¢†äº†ä¸€ä¸ª issueï¼Œä»»åŠ¡æ˜¯ä¸ºå†…éƒ¨æµ‹è¯•æ¡†æ¶å®ç°ä¸€ä¸ªæµ‹è¯•æŠ¥å‘Šå¯è§†åŒ–å·¥å…·ï¼Œå½“æ—¶å¯¹æ¥äººæä¾›äº† Allure ä½œä¸ºé€‰å‹å‚è€ƒï¼Œæœ€åç»è¿‡ä¸€ç•ªæ‘¸ç´¢ä¹Ÿç»ˆäºå®ç°äº†æ—¢å®šæ•ˆæœã€‚å› ä¸º Allure å±•ç°æ•ˆæœç¡®å®è¿˜ä¸é”™ï¼Œä½†æ˜¯å®˜æ–¹æ²¡æœ‰åº•å±‚ schema çš„è¯¦ç»†è¯´æ˜ï¼Œæ‰€ä»¥å®ç°è¿‡ç¨‹ä¹Ÿæœ‰ä¸€äº›æ‘¸ç´¢ï¼Œè¿™é‡Œè®°å½•ä¸‹ï¼Œæˆ–è®¸ä¼šæœ‰äººé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ã€‚&lt;/p>
&lt;h1 id="ä»€ä¹ˆæ˜¯-allure-æ¡†æ¶">ä»€ä¹ˆæ˜¯ Allure æ¡†æ¶ï¼Ÿ&lt;/h1>
&lt;p>&lt;a href="https://qameta.io/allure-report/">Allure&lt;/a>ï¼Œå…¨ç§° Allure Reportï¼Œæ˜¯ä¸€ä¸ªè·¨ç¼–ç¨‹è¯­è¨€çš„æµ‹è¯•æŠ¥å‘Šå·¥å…·ï¼Œé€šè¿‡å®šä¹‰ç»Ÿä¸€çš„åº•å±‚ Schemaï¼Œå®˜æ–¹æä¾›äº†å¤šä¸ªç¼–ç¨‹è¯­è¨€ç‰ˆæœ¬çš„é€‚é…å®ç°ï¼Œç›®å‰ä¸»è¦æœ‰ Javaã€JavaScriptã€Pythonã€Rubyã€PHPã€Kotlinã€.Net ä»¥åŠ Goã€‚&lt;/p>
&lt;p>Allure å¯ä»¥ç”Ÿæˆæ¯”è¾ƒç®€æ´çš„æµ‹è¯•æŠ¥å‘Šï¼ŒæŠ¥å‘Šåˆ’åˆ†â€œOverviewâ€ã€â€œCategoriesâ€ã€â€œSuitesâ€ã€â€œGraphsâ€ã€â€œTimelineâ€ã€â€œBehaviorsâ€ä»¥åŠâ€œPackagesâ€å‡ å¤§æ¿å—ï¼Œå¯ä»¥è®¿é—®&lt;a href="https://allure-framework.github.io/allure-demo">Allure demo&lt;/a> æŸ¥çœ‹ç¤ºä¾‹æ•ˆæœã€‚å¦‚æœéœ€è¦äº†è§£æ›´å¤šä¸åŒçš„æµ‹è¯•é›†å±•ç¤ºçš„æ•ˆæœï¼Œå¯ä»¥è®¿é—® &lt;a href="http://betty.us.es/restest-showcase-demo/">RESTest showcase&lt;/a> æµè§ˆã€‚&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure_Report.png" alt="">
&lt;figcaption>allure demo&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>é™¤æ­¤ä¹‹å¤–ï¼ŒAllure ä¹Ÿæ”¯æŒå¤šè¯­è¨€åˆ‡æ¢ï¼Œç›®å‰å®˜æ–¹ç¤ºä¾‹åŒ…å«è‹±è¯­ã€ä¸­æ–‡ã€å¾·è¯­ç­‰åœ¨å†…çš„ 12 ç§è¯­è¨€ã€‚&lt;/p>
&lt;p>Allure æ¡†æ¶åœ¨å„ä¸ªç¼–ç¨‹è¯­è¨€ä¹‹ä¸Šæ„å»ºå®ç°äº†æ•´ä¸ªæµ‹è¯•æŠ¥å‘Šçš„ç”Ÿæ€ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure-architecture.jpg" alt="">
&lt;figcaption>allure architecture&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h1 id="allure-schema">Allure Schema&lt;/h1>
&lt;p>Allure çš„è·¨ç¼–ç¨‹è¯­è¨€ç‰¹æ€§å¾—ç›Šäºä¸€å¥—åŸºäº JSON æ ¼å¼çš„ Schemaï¼Œå®˜æ–¹åœ¨å…¶å„ä¸ªç¼–ç¨‹è¯­è¨€ç‰ˆæœ¬çš„æºç éƒ½æœ‰ç›¸å…³çš„å®šä¹‰ï¼Œæ¯”å¦‚ Python ç‰ˆçš„å¯ä»¥æŸ¥çœ‹ &lt;a href="https://github.com/allure-framework/allure-python/blob/master/allure-python-commons/src/model2.py">allure-python-commons/src/model2.py&lt;/a>ã€‚&lt;/p>
&lt;p>ä½†æ˜¯å®˜æ–¹å¯¹å…·ä½“çš„ Schema æ²¡æœ‰æ–‡å­—æ€§çš„æ–‡æ¡£ï¼Œæ‰€ä»¥ Schema å®šä¹‰å’Œæœ€ç»ˆç”ŸæˆæŠ¥å‘Šä¸­çš„æ•ˆæœçš„å…³è”ï¼Œæ²¡æœ‰ç¡®åˆ‡çš„è¯´æ˜ã€‚æˆ‘ç»è¿‡æ‘¸ç´¢å’Œå°è¯•ï¼Œæ•´ç†äº† Schema ä¸­å„ä¸ªæ¨¡å‹çš„å…³ç³»ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure-models.jpg" alt="">
&lt;figcaption>allure models&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h2 id="ç¤ºä¾‹">ç¤ºä¾‹&lt;/h2>
&lt;p>ä¸ºäº†ç›´è§‚å¯¹æ¯” Schema å’Œæœ€åç”Ÿæˆçš„æŠ¥å‘Šæ•ˆæœï¼Œå¯ä»¥æŸ¥çœ‹è¿™æ®µ allure çš„æµ‹è¯•ç”¨ä¾‹æŠ¥å‘Šä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;test_shell_testcase_failed32&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// æµ‹è¯•ç”¨ä¾‹å
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;failed&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// æµ‹è¯•ç”¨ä¾‹ç»“æœï¼Œåœ¨ä¸Šå›¾ä¸­å¯¹åº” `Status` æšä¸¾å€¼å®šä¹‰
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;steps&amp;#34;&lt;/span>: [ &lt;span style="font-style:italic">// æµ‹è¯•æ­¥éª¤ï¼Œåœ¨æµ‹è¯•æŠ¥å‘Šä¸­å±•ç¤ºåœ¨é¢æ¿å³ä¸‹è§’çš„ Test body é‡Œ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;#@ æµ‹è¯•æ­¥éª¤:17:&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;passed&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;#@ æµ‹è¯•æ­¥éª¤:28:&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;passed&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;#@ æµ‹è¯•æ­¥éª¤:39:&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;passed&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;start&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;1665562034999&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// æµ‹è¯•ç”¨ä¾‹å¼€å§‹æ—¶é—´
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;stop&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;1665562053613&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// æµ‹è¯•ç”¨ä¾‹ç»“æŸæ—¶é—´ï¼Œå’Œå¼€å§‹æ—¶é—´ä¸€èµ·ç¡®å®šæœ¬ç”¨ä¾‹çš„è€—æ—¶ï¼Œè¿™é‡Œæ˜¯ 18s 614ms
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;uuid&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;test_python_testcase-result-37&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// uuidï¼Œè¿™ä¸ªå¯ä»¥ç”±åº“ä»£ç è‡ªåŠ¨ç”Ÿæˆ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;testCaseId&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;20220411-152848-724647399&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// åŒæ ·å¯ä»¥ç”±åº“ä»£ç è‡ªåŠ¨ç”Ÿæˆ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;labels&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;suite&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ labelï¼Œå½“ä¸º suite æ—¶ï¼Œvalue è¡¨æ˜å½“å‰ç”¨ä¾‹å¯¹åº”çš„æµ‹è¯•é›†åç§°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tst_suite_common2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tag&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// tag æ˜¯æ™®é€šçš„æ ‡ç­¾ï¼Œæ˜¾ç¤ºåœ¨æŠ¥å‘Šä¸­çš„ç”¨ä¾‹è¯¦æƒ…ä¸­
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;feature&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tag&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;medium priority&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tag&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;level:3&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tag&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;type:feature&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»¥ä¸Š schema å¯¹åº”çš„æµ‹è¯•æŠ¥å‘Šå¦‚å›¾ï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure-report-example.png" alt="">
&lt;figcaption>allure å¯¹ç…§ç¤ºä¾‹&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h1 id="å¦‚ä½•åŸºäºå®˜æ–¹åº“å®ç°æ ‡å‡†çš„-schema-ç”Ÿæˆ">å¦‚ä½•åŸºäºå®˜æ–¹åº“å®ç°æ ‡å‡†çš„ schema ç”Ÿæˆï¼Ÿ&lt;/h1>
&lt;p>ä»¥ python ä¸ºä¾‹ï¼Œå¯ä»¥ä½¿ç”¨å®˜æ–¹ä»£ç åº“ &lt;code>allure-python-commons&lt;/code> ä¸­çš„ &lt;a href="https://github.com/allure-framework/allure-python/blob/master/allure-python-commons/src/logger.py">&lt;code>AllureFileLogger&lt;/code>&lt;/a>ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæç®€çš„ä¾‹å­æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">allure_commons.logger&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> AllureFileLogger
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">allure_commons.model2&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> TestResult, Status, Label, Link
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">allure_commons.types&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> LinkType
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">allure_commons.utils&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> now, uuid4
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">if&lt;/span> __name__ == &lt;span style="font-style:italic">&amp;#34;__main__&amp;#34;&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger = AllureFileLogger(report_dir=&lt;span style="font-style:italic">&amp;#34;tmp/logger_reports/&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = TestResult(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name=&lt;span style="font-style:italic">&amp;#34;test case&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> status=Status.PASSED,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># statusDetails=&amp;#34;test passed&amp;#34;,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stage=&lt;span style="font-style:italic">&amp;#34;local test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> description=&lt;span style="font-style:italic">&amp;#34;simulation test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> descriptionHtml=&lt;span style="font-style:italic">&amp;#34;&amp;lt;h1&amp;gt;simulation test&amp;lt;/h1&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> start=now()-3000,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stop=now(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> uuid=uuid4(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> historyId=uuid4(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> testCaseId=uuid4(),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fullName=&lt;span style="font-style:italic">&amp;#34;a fake test case demo&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> labels=[Label(name=&lt;span style="font-style:italic">&amp;#34;owner&amp;#34;&lt;/span>, value=&lt;span style="font-style:italic">&amp;#34;martinhong&amp;#34;&lt;/span>), Label(name=&lt;span style="font-style:italic">&amp;#34;weight&amp;#34;&lt;/span>, value=&lt;span style="font-style:italic">&amp;#34;highest&amp;#34;&lt;/span>)],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> links=[Link(type=LinkType.ISSUE,url=&lt;span style="font-style:italic">&amp;#34;https://google.com.hk&amp;#34;&lt;/span>,name=&lt;span style="font-style:italic">&amp;#34;fake link&amp;#34;&lt;/span>)])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.report_result(result)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œä»¥ä¸Šçš„ä»£ç ï¼Œç”Ÿæˆçš„ allure schema ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;test case&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;status&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;passed&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;stage&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;local test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;description&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;simulation test&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;descriptionHtml&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;&amp;lt;h1&amp;gt;simulation test&amp;lt;/h1&amp;gt;&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;start&amp;#34;&lt;/span>: 1664635107494,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;stop&amp;#34;&lt;/span>: 1664635110494,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;uuid&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;083c72da-668c-406c-a258-ba61f2eec2f2&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;historyId&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;c665bc04-9b63-426f-a7ce-b1981853d775&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;testCaseId&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;2b53d7b0-2127-46ab-8c72-ec2e5c97b759&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;fullName&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;a fake test case demo&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;labels&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;owner&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;martinhong&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;weight&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;value&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;highest&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;links&amp;#34;&lt;/span>: [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;type&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;issue&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;url&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;https://google.com.hk&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;fake link&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹åº”çš„å¯è§†åŒ–æŠ¥å‘Šä¸ºï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/allure/Allure_simple_case.png" alt="">
&lt;figcaption>allure ç®€å•ç¤ºä¾‹&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://qameta.io/allure-report/">Allure Report&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>How to enable automated captions in zoom.us</title><link>https://blog.hackerpie.com/posts/skills/zoomus-how-to-enable-automated-captions/</link><pubDate>Tue, 16 Aug 2022 10:12:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/skills/zoomus-how-to-enable-automated-captions/</guid><description>&lt;p>There are some times you may need to generate automated captions in zoom.us online meetings, and zoom.us also officially support this amazing feature. However, it is default to disabled so you need to manually enable it firstly. The below are steps to enable it quickly:&lt;/p>
&lt;p>Step 1: Login to &lt;a href="https://zoom.us">https://zoom.us&lt;/a> and then navigate your profile settings page, or you can click &lt;a href="https://zoom.us/profile/setting">this link&lt;/a> directly.&lt;/p>
&lt;p>Step 2: Scroll down your page until the In Meeting (Advanced) section, you can see there are two settings, one is Manual captions and the other is Automated captions, enable both of them like my screenshot.
&lt;img src="https://blog.hackerpie.com/images/posts/zoom-automated-captions/enable-automated-captions.png" alt="Enable automated captions">
&lt;/p>
&lt;p>Step 3(Optional): If you have been in a meeting, quit it and then join or start a new meeting, you should see there is a CC tool now.
&lt;img src="https://blog.hackerpie.com/images/posts/zoom-automated-captions/cc-captions.png" alt="CC tool">
&lt;/p>
&lt;p>Step 4: Click &amp;ldquo;Show Captions&amp;rdquo;, it should display a captions board:
&lt;img src="https://blog.hackerpie.com/images/posts/zoom-automated-captions/captions-board.png" alt="captions board">
&lt;/p>
&lt;p>That&amp;rsquo;s all! You can begin your speech and it will recognize your voice and transform to live captions automatically! So cool!&lt;/p>
&lt;h1 id="references">References&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://support.zoom.us/hc/en-us/articles/8158289360141">Enabling automated captions&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>stimulus.js åˆä½“éªŒ</title><link>https://blog.hackerpie.com/posts/frontend/stimulus-js-early-experience/</link><pubDate>Sun, 31 Jul 2022 09:46:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/frontend/stimulus-js-early-experience/</guid><description>&lt;p>&lt;code>stimulus.js&lt;/code> æ¡†æ¶æ˜¯ä¸€ä¸ªè½»é‡çš„ JavaScript æ¡†æ¶ï¼Œç”±å¤§åé¼é¼çš„ Basecamp å…¬å¸å¼€å‘ï¼Œä¹Ÿå°±æ˜¯ Ruby on Rails æ¡†æ¶æ ¸å¿ƒå¼€å‘å›¢é˜Ÿæ‰€åœ¨çš„å…¬å¸ã€‚è€æ—©å°±å¬è¯´äº† stimulus.js æ¡†æ¶ï¼Œä½†æ˜¯æ²¡æœ‰å®é™…ä½¿ç”¨è¿‡ã€‚æœ€è¿‘åˆšå¥½åœ¨è‡ªå·±çš„ä¸€ä¸ªå°é¡¹ç›®ä¸­æœ‰äº†å®è·µçš„æœºä¼šï¼Œæœ‰äº†ä¸€äº›å¿ƒå¾—ä½“ä¼šï¼Œæ€»ç»“åˆ†äº«ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>æé†’ï¼šå¦‚æœæƒ³å¿«é€Ÿä½“éªŒ stimulus.js åšå‡ºæ¥çš„ demoï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ª &lt;a href="https://github.com/chloerei/todomvc-stimulus">todomvc-stimulus&lt;/a>ã€‚&lt;/p>
&lt;h1 id="ä¸€ä¸ªå…‹åˆ¶çš„å‰ç«¯-javascript-æ¡†æ¶">ä¸€ä¸ªå…‹åˆ¶çš„å‰ç«¯ JavaScript æ¡†æ¶&lt;/h1>
&lt;p>è°ˆèµ·å¯¹ &lt;code>stimulus.js&lt;/code> æ¡†æ¶æ€»çš„å°è±¡ï¼Œæˆ‘è§‰å¾—è¿™æ˜¯ä¸€ä¸ªéå¸¸å…‹åˆ¶çš„å‰ç«¯ JavaScript æ¡†æ¶ã€‚å®ƒèšç„¦äº&lt;strong>åœ¨ HTML å…ƒç´ ä¸ JavaScript å¯¹è±¡çš„ç»‘å®š&lt;/strong>è¿™ä»¶äº‹æƒ…ä¸Šï¼Œå¹¶ä¸”è¿™ç§ç»‘å®šæ˜¯å•å‘çš„ï¼Œä¸æ˜¯å‰ç«¯å¼€å‘ä¸­æ—©å·²éå¸¸æ™®éçš„åŒå‘ç»‘å®šã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒæ²¡æœ‰æä¾›å…¶ä»–é¢å¤–çš„åŠŸèƒ½ã€‚&lt;/p>
&lt;p>ç”±äºå®ƒçš„å…‹åˆ¶ï¼Œ&lt;strong>è½»é‡&lt;/strong>æ˜¯å®ƒå¿…ç„¶è€Œç„¶çš„ç¬¬ä¸€ä¸ªä¼˜ç‚¹ã€‚å…¶æ¬¡ï¼Œé…åˆå…¶æ‰€è®¾è®¡çš„ &lt;code>controller&lt;/code> çš„æ¦‚å¿µï¼Œå¯ä»¥å®ç°äº¤äº’é€»è¾‘é‡ŒçŠ¶æ€çš„éš”ç¦»ä¸è§£è€¦ã€‚æœ€åï¼Œå®ƒåœ¨ &lt;code>controller&lt;/code> ä»£ç çš„ç»„ç»‡ä¸Šï¼Œä¹Ÿè®©ç†Ÿæ‚‰ Rails å¼€å‘çš„äººæ„Ÿåˆ°äº²åˆ‡ï¼š&lt;strong>çº¦å®šå¤§äºé…ç½®&lt;/strong>ã€‚æ¯ä¸ª &lt;code>controller&lt;/code> çš„å®šä¹‰ï¼Œéƒ½éœ€è¦æŒ‰ç…§çº¦å®šï¼Œä¸€ä¸ª &lt;code>controller&lt;/code> å¯¹åº”ä¸€ä¸ªæ–‡ä»¶ï¼Œæ”¾åœ¨ &lt;code>controllers&lt;/code> ç›®å½•ä¸‹ï¼Œä¸”æ–‡ä»¶åä¸ &lt;code>controller&lt;/code> çš„åå­—ä¸€è‡´ã€‚&lt;/p>
&lt;h2 id="stimulusjs-çš„è½»é‡">&lt;code>Stimulus.js&lt;/code> çš„è½»é‡&lt;/h2>
&lt;p>&lt;code>Stimulus.js&lt;/code> çš„æ ¸å¿ƒæ¦‚å¿µéå¸¸å°‘ï¼Œæƒ³è¦ä¸Šæ‰‹ &lt;code>stimulus.js&lt;/code> æ¡†æ¶çš„ä½¿ç”¨ï¼Œåªæœ‰ 4 ä¸ªæ ¸å¿ƒæ¦‚å¿µæ˜¯éœ€è¦äº†è§£çš„ã€‚&lt;/p>
&lt;h3 id="controllers">&lt;code>Controllers&lt;/code>&lt;/h3>
&lt;p>&lt;code>Controllers&lt;/code> æ˜¯å£°æ˜äº†è¯¸å¦‚ &lt;code>data-controller=&amp;quot;todos&amp;quot;&lt;/code> è¿™æ ·çš„ data å±æ€§çš„ HTML å…ƒç´ æ‰€ç»‘å®šçš„ JavaScript å¯¹è±¡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="font-weight:bold">div&lt;/span> data-controller=&lt;span style="font-style:italic">&amp;#34;todos&amp;#34;&lt;/span>&amp;gt;&amp;lt;/&lt;span style="font-weight:bold">div&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>stimulus.js&lt;/code> ä¼šè‡ªåŠ¨ä¸ºæ‰€æœ‰æ­¤ç±»å…ƒç´ å®ä¾‹åŒ–å¯¹åº”çš„ controllerï¼Œæ¯ä¸ªæ­¤ç±»å…ƒç´ å„è‡ªç»‘å®šä¸€ä¸ªå®ä¾‹ã€‚ä»¥ä¸Šè¿°ä¾‹å­æ¥è¯´ï¼Œ&lt;code>stimulus.js&lt;/code> ä¼šè‡ªåŠ¨æŸ¥æ‰¾ä½äº &lt;code>app/javascript/controllers/todos_controller.js&lt;/code> çš„æ–‡ä»¶ï¼Œå¹¶ä¸”å¯¼å…¥å…¶ä¸­å¯¼å‡ºçš„é»˜è®¤ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªç»å…¸çš„&lt;strong>çº¦å®šå¤§äºé…ç½®&lt;/strong>çš„åšæ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// app/javascript/controllers/todos_controller.js
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> { Controller } from &lt;span style="font-style:italic">&amp;#39;stimulus&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">export&lt;/span> &lt;span style="font-weight:bold">default&lt;/span> &lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">extends&lt;/span> Controller {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> connect() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ç„¶ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨æˆ–è€…æ— æ³•ä½¿ç”¨çº¦å®šçš„å½¢å¼ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ &lt;code>stimulus.js&lt;/code> æä¾›çš„å‡½æ•°è¿›è¡Œ controller çš„æ˜¾å¼æ³¨å†Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>application.register(&lt;span style="font-style:italic">&amp;#34;todos&amp;#34;&lt;/span>, TodosController)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ç±»å…ƒç´ ä»¥åŠå…¶å­å­™å…ƒç´ ï¼Œéƒ½æ˜¯å…ƒç´ ç»‘å®šçš„ controller çš„å¯è§èŒƒå›´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ &lt;code>stimulus.js&lt;/code> æ¡†æ¶ä¸­ï¼Œcontroller çš„å„ç§æ“ä½œï¼Œåªèƒ½ä½œç”¨äº controller ç»‘å®šçš„å…ƒç´ ä»¥åŠæ­¤å…ƒç´ çš„å­å­™å…ƒç´ ã€‚è¿™ä¸ªåŸåˆ™åŒæ ·é€‚ç”¨äºåµŒå¥— Controllers çš„æƒ…å†µä¸‹ã€‚&lt;/p>
&lt;p>Controllers ä¹‹é—´å¯ä»¥é€šè¿‡äº‹ä»¶çš„æ–¹å¼ç›¸äº’åä½œï¼Œè¿™ä¸ªä¼šåœ¨åé¢è®² Actions çš„æ—¶å€™å†è¡¥å……è®²ä¸€ä¸‹ã€‚&lt;/p>
&lt;h3 id="targets">&lt;code>Targets&lt;/code>&lt;/h3>
&lt;p>&lt;code>Targets&lt;/code> æ˜¯å¦ä¸€ç§åœ¨ HTML å…ƒç´ ä¸ JavaScript å¯¹è±¡ä¹‹é—´å®ç°ç»‘å®šçš„æ–¹æ³•ï¼Œä½†æ˜¯å®ƒä½œç”¨äºå…·ä½“çš„ Controller ä¹‹ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="font-weight:bold">div&lt;/span> data-controller=&lt;span style="font-style:italic">&amp;#34;todos&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;lt;!-- ... --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="font-weight:bold">button&lt;/span> data-todos-target=&lt;span style="font-style:italic">&amp;#34;addBtn&amp;#34;&lt;/span>&amp;gt;Add&amp;lt;/&lt;span style="font-weight:bold">button&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;/&lt;span style="font-weight:bold">div&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å£°æ˜ target çš„è§„åˆ™æ˜¯ &lt;code>data-&amp;lt;controller&amp;gt;-target=&amp;lt;target-name&amp;gt;&lt;/code>ï¼Œç›¸åº”çš„ï¼Œéœ€è¦åœ¨ controller å£°æ˜ç»‘å®šçš„å¯¹è±¡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// app/javascript/controllers/todos_controller.js
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> { Controller } from &lt;span style="font-style:italic">&amp;#39;stimulus&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">export&lt;/span> &lt;span style="font-weight:bold">default&lt;/span> &lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">extends&lt;/span> Controller {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stitic target = [&lt;span style="font-style:italic">&amp;#34;addBtn&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæˆäº† target çš„ç»‘å®šä¹‹åï¼Œå°±å¯ä»¥æŒ‰ç…§ stimulus.js å¯¹ targets çš„çº¦å®šï¼Œåœ¨ controllers æ–¹æ³•ä¸­ä½¿ç”¨ç±»ä¼¼ &lt;code>this.addBtnTarget&lt;/code> æˆ–è€… &lt;code>this.addBtnTargets&lt;/code> ï¼ˆé’ˆå¯¹æœ‰å¤šä¸ª HTML å…ƒç´ ç»‘å®šäº†åŒä¸€ä¸ª Target çš„æƒ…å†µï¼‰æ¥è®¿é—®è¿™äº›ç»‘å®šçš„ HTML å…ƒç´ äº†ã€‚&lt;/p>
&lt;h3 id="controllers-å’Œ-targets-çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ">&lt;code>Controllers å’Œ Targets çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ&lt;/code>&lt;/h3>
&lt;p>ä¸Šé¢è¯´çš„ Controllers å’Œ Targetsï¼Œéƒ½æ˜¯ HTML å…ƒç´ å’Œ JavaScript å¯¹è±¡ä¹‹é—´çš„ç»‘å®šåŠŸèƒ½ï¼Œå› ä¸º HTML å…ƒç´ éšç€æµè§ˆå™¨çš„åŠ è½½ä»¥åŠåç»­çš„ DOM æ“ä½œï¼Œå°±å¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¿™äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯æ€æ ·çš„ï¼Ÿ&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-plantuml" data-lang="plantuml">@startuml
(*) --&amp;gt; &amp;#34;initialize()&amp;#34;
--&amp;gt; &amp;#34;[name]TargetConnected(target: Element)&amp;#34;
--&amp;gt; &amp;#34;connect()&amp;#34;
--&amp;gt; &amp;#34;[name]TargetDisconnected(target: Element)&amp;#34;
--&amp;gt; &amp;#34;disconnect()&amp;#34;
@enduml
&lt;/code>&lt;/pre>&lt;p>è¿™å‡ ä¸ªç”Ÿå‘½å‘¨æœŸçš„å›è°ƒå‡½æ•°éƒ½ä¸ DOM çš„å˜åŒ–ç´§å¯†ç›¸å…³ï¼Œä¸€èˆ¬æ¥è¯´çœ‹è¿™å‡ ä¸ªæ¡ä»¶ï¼š&lt;/p>
&lt;ul>
&lt;li>å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Ÿ&lt;/li>
&lt;li>ç»‘å®šçš„æ ‡è¯†æ˜¯å¦å­˜åœ¨å…ƒç´ çš„å±æ€§åˆ—è¡¨ä¸­ï¼Œæ¯”å¦‚ &lt;code>data-controller&lt;/code> æˆ–è€… &lt;code>data-&amp;lt;controller&amp;gt;-target&lt;/code>ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;p>å½“æ¡ä»¶ä»éƒ¨åˆ†æˆ–è€…å…¨éƒ¨ä¸æ»¡è¶³å˜ä¸ºæ»¡è¶³æ—¶ï¼Œåˆ™ connect ç±»å‹çš„å›è°ƒå‡½æ•°è¢«è°ƒç”¨ï¼›ç›¸åï¼Œå¦‚æœç”±äº DOM çš„ä¸€äº›æ“ä½œå¯¼è‡´ä¸å†æ»¡è¶³å…¨éƒ¨æ¡ä»¶æ—¶ï¼Œdisconnect ç±»äº‹ä»¶çš„å›è°ƒå‡½æ•°è¢«è°ƒç”¨ã€‚&lt;/p>
&lt;p>controllers å¯ä»¥åœ¨ &lt;code>connect()&lt;/code> å›è°ƒä¸­å®šä¹‰åˆå§‹åŒ–çš„å·¥ä½œï¼Œæ¯”å¦‚ controller çš„ä¸€äº›çŠ¶æ€çš„åˆå§‹åŒ–ï¼Œç›¸åº”çš„ï¼Œ&lt;code>[name]TargetConnected&lt;/code> ä¹Ÿå¯ä»¥ç”¨äºæŸä¸ª target çš„åˆå§‹åŒ–ã€‚&lt;/p>
&lt;h3 id="actions">&lt;code>Actions&lt;/code>&lt;/h3>
&lt;p>Actions æ˜¯ &lt;code>stimulus.js&lt;/code> ä¸­çš„äº‹ä»¶å›è°ƒæœºåˆ¶ï¼Œç±»ä¼¼ HTML ä¸­ &lt;code>onclick&lt;/code>ã€&lt;code>onchange&lt;/code> ä¸€ç±»çš„è¯­æ³•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="font-weight:bold">div&lt;/span> data-controller=&lt;span style="font-style:italic">&amp;#34;todos&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;lt;!-- ... --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="font-weight:bold">button&lt;/span> data-todos-target=&lt;span style="font-style:italic">&amp;#34;addBtn&amp;#34;&lt;/span> data-action=&lt;span style="font-style:italic">&amp;#34;click-&amp;gt;todos#add&amp;#34;&lt;/span>&amp;gt;Add&amp;lt;/&lt;span style="font-weight:bold">button&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;/&lt;span style="font-weight:bold">div&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Actions æ”¯æŒå¤šä¸ªäº‹ä»¶å›è°ƒå£°æ˜ï¼Œè¿™æ ·åŒæ—¶ä¹Ÿæ–¹ä¾¿äº†å®ç° Controllers ä¹‹é—´çš„åä½œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="font-weight:bold">div&lt;/span> data-controller=&lt;span style="font-style:italic">&amp;#34;todos submitter&amp;#34;&lt;/span>&amp;gt; &lt;span style="font-style:italic">&amp;lt;!-- æ³¨æ„ï¼Œè¿™é‡Œä½¿ç”¨äº†å¤šä¸ª controller ç»‘å®š --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;lt;!-- ... --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;lt;&lt;span style="font-weight:bold">button&lt;/span> data-todos-target=&lt;span style="font-style:italic">&amp;#34;addBtn&amp;#34;&lt;/span> data-action=&lt;span style="font-style:italic">&amp;#34;click-&amp;gt;todos#add todos:added-&amp;gt;submitter#submit&amp;#34;&lt;/span>&amp;gt;Add&amp;lt;/&lt;span style="font-weight:bold">button&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;/&lt;span style="font-weight:bold">div&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// app/javascript/controllers/todos_controller.js
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">import&lt;/span> { Controller } from &lt;span style="font-style:italic">&amp;#39;stimulus&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">export&lt;/span> &lt;span style="font-weight:bold">default&lt;/span> &lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">extends&lt;/span> Controller {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> add() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// do something to maintain the status of todos controller
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">this&lt;/span>.dispatch(&lt;span style="font-style:italic">&amp;#34;added&amp;#34;&lt;/span>, {detail: {todos: [xxxx]}}}})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// app/javascript/controllers/submitter_controller.js
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">import&lt;/span> { Controller } from &lt;span style="font-style:italic">&amp;#39;stimulus&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">export&lt;/span> &lt;span style="font-weight:bold">default&lt;/span> &lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">extends&lt;/span> Controller {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> submit(event) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">const&lt;/span> todos = event.detail.todos; &lt;span style="font-style:italic">// extract event data
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">// do something else
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»¥è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œç¨‹åºæ‰§è¡Œçš„æµç¨‹æ˜¯è¿™æ ·çš„ï¼š&lt;/p>
&lt;ol>
&lt;li>ç”¨æˆ·ç‚¹å‡» Add æŒ‰é’®åï¼ŒæŒ‰é’®è§¦å‘çš„ &lt;code>click&lt;/code> äº‹ä»¶è§¦å‘äº†å¯¹ &lt;code>todos&lt;/code> controller çš„ &lt;code>added&lt;/code> çš„æ–¹æ³•çš„å›è°ƒï¼›&lt;/li>
&lt;li>&lt;code>added&lt;/code> æ–¹æ³•æ‰§è¡Œå®Œè‡ªèº«çš„æ ¸å¿ƒé€»è¾‘åï¼Œé€šè¿‡è°ƒç”¨ &lt;code>this.dispatch&lt;/code> æ–¹æ³•è§¦å‘ &lt;code>todos:added&lt;/code> äº‹ä»¶ï¼Œæ³¨æ„è¿™é‡Œçš„ &lt;code>todos:&lt;/code> å‰ç¼€æ˜¯æ¡†æ¶è‡ªåŠ¨åŠ ä¸Šçš„ï¼›&lt;/li>
&lt;li>&lt;code>todos:added&lt;/code> äº‹ä»¶çš„äº§ç”Ÿï¼Œè§¦å‘äº†å¯¹ &lt;code>submitter&lt;/code> controller çš„ &lt;code>submit&lt;/code> æ–¹æ³•çš„å›è°ƒã€‚&lt;/li>
&lt;/ol>
&lt;p>å°±è¿™æ ·ï¼Œé€šè¿‡æŠ½è±¡å‡ºä¸åŒçš„ controllersï¼Œå®ç°é€»è¾‘çš„åˆ†ç¦»å’Œè§£è€¦ï¼Œå†é€šè¿‡äº‹ä»¶æœºåˆ¶ï¼Œå°†é€»è¾‘å®ç°æ‹¼è£…å’Œç¼–æ’ã€‚&lt;/p>
&lt;p>ç†è§£äº†ä¸Šé¢è¿™ 4 ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼Œå°±è¶³ä»¥ä½¿ç”¨ &lt;code>stimulus.js&lt;/code> å¼€å‘å‡ºä¸€ä¸ªäº¤äº’ç›¸å¯¹ç®€å•çš„å‰ç«¯é€»è¾‘äº†ã€‚å½“ç„¶ï¼Œ&lt;code>stimulus.js&lt;/code> è¿˜æœ‰å…¶ä»–å‡ ä¸ªæ¦‚å¿µï¼Œä½†æ˜¯åœ¨æˆ‘çœ‹æ¥åªæ˜¯ä¸€äº›é”¦ä¸Šæ·»èŠ±çš„åŠŸèƒ½ï¼Œè¿™é‡Œå°±æ²¡å¿…è¦èµ˜è¿°äº†ã€‚&lt;/p>
&lt;h1 id="ä¹Ÿè°ˆè°ˆ-stimulusjs-ä¸é€‚åˆçš„åœºæ™¯">ä¹Ÿè°ˆè°ˆ &lt;code>stimulus.js&lt;/code> ä¸é€‚åˆçš„åœºæ™¯&lt;/h1>
&lt;p>å°½ç®¡æ˜¯ä¸€ä¸ªå°é¡¹ç›®ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ &lt;code>stimulus.js&lt;/code> çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿé‡åˆ°äº†ä¸€äº›è§‰å¾—æ¯”è¾ƒç¹ççš„é—®é¢˜ï¼Œè¿™äº›é—®é¢˜ä½“ç°åœ¨ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>ç¼ºä¹ DOM æ“ä½œçš„å°è£…&lt;/strong>ï¼šå› ä¸º &lt;code>stimulus.js&lt;/code> åªæä¾› HTML å…ƒç´ ä¸ JavaScript å¯¹è±¡ä¹‹é—´çš„ç»‘å®šï¼Œå¹¶æ²¡æœ‰æä¾›å¯¹ DOM æ“ä½œçš„å°è£…ï¼Œæ‰€ä»¥åœ¨éœ€è¦æ“ä½œ DOM çš„æ—¶å€™ï¼Œå°±ä¼šç»å¸¸éœ€è¦ç›´æ¥ä½¿ç”¨åŸç”Ÿ DOM å¯¹è±¡çš„æ“ä½œï¼Œæ¯”å¦‚ &lt;code>Element.classList.add()&lt;/code> ä¸€ç±»ï¼Œå¦‚æœæ˜¯åœ¨æ—©æœŸçš„æµè§ˆå™¨ä¸­ï¼Œè¿˜éœ€è¦æ‹…å¿ƒå…¼å®¹æ€§é—®é¢˜ç­‰ï¼Œä½†æ˜¯å¥½åœ¨ç°åœ¨çš„æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜å·²ç»å°‘äº†å¾ˆå¤šï¼Œè¿™å€’ä¸æ˜¯å¤ªå¤§çš„é—®é¢˜ï¼›&lt;/li>
&lt;li>&lt;strong>ç¼ºä¹å‰ç«¯æ¸²æŸ“çš„æ”¯æŒ&lt;/strong>ï¼šå› ä¸º &lt;code>stimulus.js&lt;/code> ä¸­çš„ç»‘å®šå¹¶éåŒå‘ç»‘å®šï¼Œåœ¨ä¸€äº›éœ€è¦æ ¹æ® JavaScript å¯¹è±¡æ¸²æŸ“ä¸åŒé¡µé¢å†…å®¹æˆ–è€…è§†è§‰æ•ˆæœçš„æƒ…å†µä¸‹ï¼Œå¦‚æœä¸å€ŸåŠ©å…¶ä»–æ¡†æ¶çš„æ”¯æŒï¼Œå°±åªèƒ½ç¼–å†™å„ç§å­—ç¬¦ä¸²æ’å€¼ï¼Œä»¥åŠ &lt;code>Element.innerHTML = xxxx&lt;/code> çš„ä»£ç ï¼ŒåŒæ ·æ•ˆç‡æ¯”è¾ƒä½ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥ï¼Œæ€»ç»“æ¥è¯´ï¼Œå¦‚æœä½ çš„å‰ç«¯é¡µé¢æ˜¯ä¸€ä¸ªé‡äº¤äº’çš„é¡µé¢ï¼Œå¯èƒ½åªä½¿ç”¨ &lt;code>stimulus.js&lt;/code> å¹¶ä¸æ˜¯ä¸€ä¸ªæ˜æ™ºä¹‹é€‰ã€‚ä»¥æˆ‘è‡ªå·±æ¥é€‰æ‹©çš„è¯ï¼Œå¦‚æœæ˜¯ä¸€äº›å†…å®¹ç±»çš„è½»äº¤äº’åœºæ™¯ï¼Œæ¯”å¦‚åšå®¢æˆ–è€…è®ºå›ï¼Œä¸€èˆ¬éœ€è¦äº¤äº’çš„å°±æ˜¯è¯„è®ºåŒºï¼Œç®€å•çš„æ–‡æœ¬è¾“å…¥ä»¥åŠè¿½åŠ å±•ç¤ºç­‰ï¼Œæˆ‘è§‰å¾—ç”¨ &lt;code>stimulus.js&lt;/code> ä¼šæ¯”è¾ƒèˆ’æœï¼Œè½»é‡ï¼Œåˆæ˜¯åŸæ±åŸå‘³çš„ DOMï¼›ä½†æ˜¯å…¶ä»–æƒ…å†µä¸‹ï¼Œæˆ‘å¯èƒ½ä¼šç›´æ¥ä¸Š &lt;code>vue.js&lt;/code> ä¹‹ç±»åŠŸèƒ½æ›´å…¨é¢çš„æ¡†æ¶ï¼Œæœ€å¤§ç¨‹åº¦å‡å°‘åœ¨é¡µé¢ä¸é€»è¾‘ä¹‹é—´çŠ¶æ€åŒæ­¥çš„ä»£ç ã€‚&lt;/p>
&lt;h1 id="ä½¿ç”¨-stimulusjs-è¸©è¿‡çš„å‘">ä½¿ç”¨ &lt;code>stimulus.js&lt;/code> è¸©è¿‡çš„å‘&lt;/h1>
&lt;ol>
&lt;li>&lt;strong>åœ¨ Controllers scope ä¹‹å¤–çš„ action æ— æ³•å›è°ƒåˆ° Controller çš„æ–¹æ³•&lt;/strong>&lt;br>
è¿™ä¸ªé—®é¢˜æœ€å¼€å§‹æ’æŸ¥äº†ä¸€äº›æ—¶é—´ï¼Œä¸€ç›´æ²¡æƒ³æ˜ç™½ä¸ºä»€ä¹ˆï¼Œåæ¥æ‰é¡¿æ‚Ÿï¼ŒåŸæ¥æ˜¯å› ä¸ºè¸©äº† Controller scope çš„å‘ã€‚å› ä¸ºæˆ‘çš„ action å£°æ˜éœ€è¦å›è°ƒçš„ controller åœ¨å½“å‰ DOM ä¸­ä¸åœ¨å¯è§èŒƒå›´ï¼Œäºæ˜¯è§¦å‘å›è°ƒå¤±è´¥ã€‚&lt;/li>
&lt;li>&lt;strong>å…ˆäº controller åˆå§‹åŒ–å‰è§¦å‘çš„ action æ— æ³•å›è°ƒåˆ° Controller çš„æ–¹æ³•&lt;/strong>
è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºæˆ‘åœ¨ä»£ç ä¸­å£°æ˜äº†ä¸€ä¸ª actionï¼Œå¹¶ä¸”åœ¨ controller ä¸­ä¹Ÿæ‰§è¡Œäº† &lt;code>dispatch&lt;/code>ï¼Œä½†æ˜¯æ­¤æ—¶å› ä¸ºç›®æ ‡çš„ controller è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œå¯¼è‡´çœ‹ä¼¼ä»£ç æ²¡æœ‰ä»»ä½•è¯­æ³•æˆ–è€…ä½¿ç”¨é”™è¯¯ï¼Œä½†æ˜¯ action æ— å¯èƒ½è§¦å‘å›è°ƒæˆåŠŸã€‚&lt;/li>
&lt;/ol>
&lt;h1 id="ç›¸å…³èµ„æ–™é“¾æ¥">ç›¸å…³èµ„æ–™é“¾æ¥&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://stimulus.hotwired.dev/">stimulus.js&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/chloerei/todomvc-stimulus">todomvc-stimulus&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://bundlephobia.com/package/stimulus@3.1.0">bundlephobia:stimulus@3.1.0&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Golang é”™è¯¯å¤„ç†å’Œæ—¥å¿—æ‰“å°çš„ 5 ç‚¹å»ºè®®</title><link>https://blog.hackerpie.com/posts/programming-paradigm/golang-error-logs/</link><pubDate>Sun, 12 Jun 2022 14:49:18 +0800</pubDate><guid>https://blog.hackerpie.com/posts/programming-paradigm/golang-error-logs/</guid><description>&lt;p>Golang è¯­è¨€è¯­æ³•ä¸­ï¼Œé”™è¯¯å¤„ç†æœºåˆ¶æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç‰¹è‰²çš„è®¾è®¡ï¼Œå®ƒæ˜¯åŸºäº&lt;a href="https://zh.wikipedia.org/wiki/%E9%98%B2%E5%BE%A1%E6%80%A7%E7%BC%96%E7%A8%8B">é˜²å¾¡æ€§ç¼–ç¨‹&lt;/a>æ€æƒ³çš„è®¾è®¡ã€‚ä¸è¿‡ä»Šå¤©è¿™ç¯‡æ–‡ç« ä¸è®¨è®º Golang é”™è¯¯å¤„ç†çš„è¯­æ³•è®¾è®¡é—®é¢˜ï¼Œç›¸åï¼Œä»Šå¤©æƒ³æ€è€ƒçš„æ˜¯ï¼ŒGolang é‡Œçš„é”™è¯¯æ—¥å¿—åº”è¯¥æ€æ ·å¤„ç†ä»¥åŠæ‰“å°æ¯”è¾ƒå¥½ã€‚&lt;/p>
&lt;h1 id="golang-ä¸­é”™è¯¯å¤„ç†å’Œæ—¥å¿—æ‰“å°çš„-5-ç‚¹å»ºè®®">Golang ä¸­é”™è¯¯å¤„ç†å’Œæ—¥å¿—æ‰“å°çš„ 5 ç‚¹å»ºè®®&lt;/h1>
&lt;ol>
&lt;li>ä½¿ç”¨é”™è¯¯æ ˆçš„æ–¹å¼ï¼›&lt;/li>
&lt;li>ä½¿ç”¨é€»è¾‘æ ˆä¿¡æ¯ï¼Œè€Œéä»£ç è°ƒç”¨æ ˆï¼›&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>fmt.Errorf&lt;/code>ï¼Œä¸ç”¨ &lt;code>pkg/errors&lt;/code> ç¬¬ä¸‰æ–¹æ¨¡å—ï¼›&lt;/li>
&lt;li>é¿å…ä½¿ç”¨ä¾èµ–æ ‡å‡†åº“ &lt;code>fmt&lt;/code> æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ—¥å¿—æ–¹æ³•ï¼›&lt;/li>
&lt;li>è½¬æ¢å¤–éƒ¨é”™è¯¯ï¼ŒåŸºäºå†…éƒ¨é”™è¯¯ç±»å‹åˆ¤æ–­ã€‚&lt;/li>
&lt;/ol>
&lt;h1 id="ä½¿ç”¨é”™è¯¯æ ˆçš„æ–¹å¼">ä½¿ç”¨é”™è¯¯æ ˆçš„æ–¹å¼&lt;/h1>
&lt;p>æˆ‘ä»è½¬ Golang å¼€å‘ä»¥æ¥ï¼Œä»çœ‹è¿‡çš„ Golang ä»£ç ä»¥åŠè‡ªå·±çš„å®è·µæ¥è¯´ï¼Œå¤§æ¦‚ä¼šæœ‰ä»¥ä¸‹å‡ ç§ä¸ªäººè®¤ä¸ºä¸æ˜¯å¤ªåˆç†çš„é”™è¯¯æ—¥å¿—æ‰“å°æ–¹å¼ï¼š&lt;/p>
&lt;ol>
&lt;li>æ¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨å¤„åœ¨å‘ç°é”™è¯¯æ—¶éƒ½æ‰“å°é”™è¯¯ä¿¡æ¯ï¼›&lt;/li>
&lt;li>çº¦å®šåªåœ¨æœ€é‡Œå±‚æˆ–è€…æœ€å¤–å±‚å‡½æ•°è°ƒç”¨å¤„å‘ç°é”™è¯¯æ—¶æ‰“å°é”™è¯¯ä¿¡æ¯ï¼Œè¿›ä¸€æ­¥ç»†åˆ†çš„è¯ï¼Œè¿˜åŒºåˆ†æ˜¯å¦ä¼šåœ¨é”™è¯¯é‡Œæºå¸¦è°ƒç”¨æ ˆä¿¡æ¯ï¼›&lt;/li>
&lt;li>æ²¡æœ‰æ˜ç¡®è§„èŒƒï¼Œåœ¨æ•´ä¸ªè°ƒç”¨é“¾çš„ä»»ä½•ä¸€å¤„æˆ–è€…å¤šå¤„è°ƒç”¨å‘ç°é”™è¯¯æ—¶éƒ½æœ‰å¯èƒ½æ‰“å°é”™è¯¯ä¿¡æ¯ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç¬¬ä¸€ç§æ–¹å¼ï¼Œå¥½å¤„æ˜¯ä¸ä¼šé—æ¼è°ƒç”¨é“¾è·¯ä¸Šçš„æ‰€æœ‰è°ƒç”¨èŠ‚ç‚¹ä¿¡æ¯ï¼Œä½†æ˜¯åœ¨å®é™…åº”ç”¨åœºæ™¯é‡Œï¼ŒæœåŠ¡çš„çº¿ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œä¸åŒçº¿ç¨‹æ‰“å°çš„æ—¥å¿—è¡Œä¹‹é—´ç›¸äº’äº¤é”™ï¼Œè¿™ç§æ–¹å¼æ‰“å°çš„åŒä¸€ä¸ªé“¾è·¯ä¸Šçš„æ—¥å¿—éå¸¸æ•£ä¹±ï¼Œå¯¼è‡´å°½ç®¡æ—¥å¿—é‡Œæœ‰å…¨éƒ¨é”™è¯¯ç›¸å…³çš„æ—¥å¿—ï¼Œä½†æ˜¯å´éš¾ä»¥ç®€å•å¿«é€Ÿè¿‡æ»¤å‡ºç›¸å…³è€Œéå¹²æ‰°çš„æ—¥å¿—è¡Œï¼Œæ‰€è°“çš„å¥½å¤„åå­˜å®äº¡ï¼Œè¿˜å æ®å¤§é‡ç£ç›˜ç©ºé—´ã€‚&lt;/p>
&lt;p>ç¬¬äºŒç§æ–¹å¼ï¼Œæœ€å¤§çš„é—®é¢˜æ˜¯å¯èƒ½ç¼ºå¤±å¯¹äºé”™è¯¯æ’æŸ¥æ‰€éœ€çš„ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚å¤§å¤šæ•°å‡½æ•°è°ƒç”¨éƒ½å‘ç”Ÿåœ¨è·¨å±‚ä»£ç é€»è¾‘çš„è°ƒç”¨ä¸Šï¼Œå¦‚æœåªåœ¨æœ€é‡Œå±‚è°ƒç”¨å¤„æ‰“å°é”™è¯¯ï¼Œåˆ™ä¸€èˆ¬ç¼ºå°‘æœ€å¤–å±‚è¯·æ±‚çš„å¤§å¤šæ•°å‚æ•°ä¿¡æ¯ï¼Œæƒ³è±¡ä¸€ä¸ªå­˜å‚¨å±‚ä»£ç è°ƒç”¨çš„ä¾‹å­ã€‚è€Œå¦å¤–ä¸€ç§æ€è·¯æ˜¯é€šè¿‡è®°å½•ä»£ç è°ƒç”¨æ ˆï¼Œå¯ä»¥å¸®åŠ©å¼€å‘äººå‘˜è¿˜åŸç¨‹åºæ‰§è¡Œè·¯å¾„ï¼Œè¿›è€Œé€šè¿‡é˜…è¯»æºç ä»¥åŠæ¨ç†è¿˜åŸè¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿™ç§æ–¹å¼ç¡®å®èƒ½å¤Ÿæé«˜é—®é¢˜æ’æŸ¥å¤„ç†çš„æ•ˆç‡ã€‚ä½†æ˜¯åªæ˜¯çº¯ç²¹ä»£ç è°ƒç”¨æ ˆä¿¡æ¯çš„è¯ï¼Œä¸€æ–¹é¢ä¼šæœ‰å¤§é‡ä¸šåŠ¡æ— å…³çš„ä»£ç æ ˆä¿¡æ¯å¯èƒ½è¢«è®°å½•åˆ°æ—¥å¿—é€ æˆå­˜å‚¨ç©ºé—´æµªè´¹ï¼Œå¦ä¸€æ–¹é¢æ˜¯ä»æ—§å¯èƒ½ç¼ºå¤±ä¸€äº›å…³é”®çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä¹Ÿæ˜¯é—®é¢˜å®šä½çš„å¿…è¦å…ƒç´ ã€‚&lt;/p>
&lt;p>ç¬¬ä¸‰ç§æ–¹å¼ï¼Œæœ¬è´¨ä¸Šæ˜¯å¼€å‘è€…å¯¹é”™è¯¯å¤„ç†æœ¬èº«ç¼ºä¹æ€è€ƒä»¥åŠå›¢é˜Ÿç¼ºä¹ç›¸å…³çš„ç¼–ç è§„èŒƒï¼Œçœ‹èµ·æ¥è¿™ç§é—®é¢˜æŒºä½çº§ï¼Œä½†æ˜¯å¹¶ä¸å°‘è§ã€‚è¿™ç§è‡ªç„¶æ˜¯æœ€åº”è¯¥é¿å…çš„ã€‚æˆ‘åœ¨æ­¤ä¹‹å‰ï¼Œè‡ªå·±ä¹Ÿæ²¡æœ‰å¥½å¥½æ€è€ƒè¿‡è¿™ä¸ªé—®é¢˜ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ç¬¬äºŒç§æ–¹å¼ï¼Œæƒ³è¦æœ‰æ•ˆå®šä½é”™è¯¯æ ¹æºï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯éœ€è¦è®°å½•é”™è¯¯å‘ç”Ÿæ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œä»¥ä¾¿æˆ‘ä»¬çŸ¥é“é”™è¯¯æ˜¯æ€ä¹ˆä¸€è·¯å‡ºç°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°ç¬¬ä¸€ä¸ªå…±è¯†ï¼š&lt;strong>é”™è¯¯éœ€è¦æºå¸¦è°ƒç”¨æ ˆä¿¡æ¯&lt;/strong>ã€‚&lt;/p>
&lt;h1 id="ä½¿ç”¨é€»è¾‘æ ˆä¿¡æ¯è€Œéä»£ç è°ƒç”¨æ ˆ">ä½¿ç”¨é€»è¾‘æ ˆä¿¡æ¯ï¼Œè€Œéä»£ç è°ƒç”¨æ ˆ&lt;/h1>
&lt;p>é¡ºç€ç¬¬ä¸€ç‚¹ï¼Œæˆ‘ä»¬æ˜ç™½äº†è°ƒç”¨æ ˆä¿¡æ¯çš„é‡è¦æ€§ã€‚å…³äºè°ƒç”¨æ ˆï¼Œä¸€ç§æœ€ç›´è§‚çš„æ–¹å¼å°±æ˜¯ç¨‹åºçš„å‡½æ•°è°ƒç”¨æ ˆï¼Œè¿™ç§æ–¹å¼ä¸€å®šç¨‹åº¦ä¸Šå¹¶ä¸æ˜¯é¢å‘äººçš„ï¼Œå°½ç®¡å®ƒè¯¦ç»†è®°å½•äº†æ¯ä¸ªè°ƒç”¨æ ˆæ‰€åœ¨çš„æºä»£ç æ–‡ä»¶ä»¥åŠè¡Œæ•°ã€‚æ¯”å¦‚ Golang ç¨‹åºåœ¨é‡åˆ° panic ä¸­æ‰“å°çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>panic: a problem
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>goroutine 1 [running]:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>main.main()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> /tmp/sandbox4213436970/prog.&lt;span style="font-weight:bold">go&lt;/span>:15 +0x27
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Program exited.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ç§æ–¹å¼çœ‹èµ·æ¥ï¼Œå¾€å¾€åªæ˜¯ä¸€å †æ–‡ä»¶åå’Œå‡½æ•°åçš„æ ˆä¿¡æ¯ï¼Œé¿å…ä¸äº†éœ€è¦å›åˆ°æºç ä¸­è¿›è¡Œé˜…è¯»ï¼Œå¦‚æœä¸æ˜¯ç†Ÿæ‚‰ä¸šåŠ¡çš„å¼€å‘äººå‘˜ï¼Œåˆ™å¯èƒ½éš¾ä»¥å¿«é€Ÿç†è§£é—®é¢˜äº§ç”Ÿçš„åŸå› ã€‚&lt;/p>
&lt;p>åœ¨æˆ‘çœ‹æ¥ï¼Œå¦å¤–ä¸€ç§æ€è·¯æ˜¯ï¼Œå¦‚æœæˆ‘å¯ä»¥äººä¸ºåœ°åœ¨ä»£ç ä¸­ä¸»åŠ¨è®°å½•é”™è¯¯å‘ç°æ—¶æ‰€åœ¨çš„ä½ç½®ä»¥åŠå‚æ•°ç­‰ï¼Œä¸ä¹Ÿæ˜¯ä¸€ç§è°ƒç”¨æ ˆçš„æ€æƒ³å—ï¼Ÿè€Œä¸”ï¼Œè¿™ç§æ–¹å¼ä¸‹ï¼Œæˆ‘è¿˜å¯ä»¥é¢å¤–å¢åŠ å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚æ¯”å¦‚æˆ‘æœŸå¾…æ‹¥æœ‰ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—æ¥å›æº¯é”™è¯¯å‘ç”Ÿçš„è¿‡ç¨‹ï¼Œå®ƒæœ€å¤§çš„ä¼˜ç‚¹æ˜¯é¢å‘å¼€å‘äººå‘˜å‹å¥½ä»¥åŠåä¸šåŠ¡æè¿°çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>handle upload failed, caused by:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> parse file failed, format: JSON,caused by:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> open file failed, caused by:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> file not found, path: /path/to/file
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ç§æ—¥å¿—ä¸‹ï¼Œä¿¡æ¯æ˜¯åå‘äºå¼€å‘è€…æ˜“äºç†è§£çš„ï¼Œé˜…è¯»ä¸‹æ¥ï¼Œå¾ˆå®¹æ˜“ç†è§£ç¨‹åºçš„ç›®çš„ä»¥åŠæ‰€é‡åˆ°çš„å¼‚å¸¸æƒ…å†µã€‚æ—¥å¿—é‡Œçš„â€œhandle upload failedâ€ ç­‰æ˜¯ä¸€ç§é€»è¾‘ä¸Šçš„è°ƒç”¨é“¾è·¯ï¼Œè€Œâ€œformat: JSONâ€ä»¥åŠâ€œpath: /path/to/fileâ€ åˆ™æ˜¯å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚&lt;/p>
&lt;p>å…·ä½“åˆ° Golang çš„è®¾è®¡çš„è€ƒè™‘ï¼Œå¦‚æœéœ€è¦åœ¨é”™è¯¯ä¸­è·å–è¢«è°ƒå‡½æ•°çš„è°ƒç”¨æ ˆä¿¡æ¯ï¼Œåˆ™éœ€è¦ä¾èµ– Golang çš„è¿è¡Œæ—¶å®ç°ï¼Œè¿™å°†ä¼šå¯¼è‡´ç¨‹åºæ¯”è¾ƒæ˜æ˜¾çš„æ€§èƒ½å¼€é”€ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œç»¼åˆè€ƒè™‘é”™è¯¯ä¿¡æ¯çš„å¼•å¯¼æ€§ä»¥åŠå¯¹ç¨‹åºçš„æ€§èƒ½å‹å¥½ï¼Œ&lt;strong>åº”è¯¥ä½¿ç”¨é€»è¾‘æ ˆä¿¡æ¯ï¼Œè€Œé¿å…ä½¿ç”¨ä»£ç è°ƒç”¨æ ˆ&lt;/strong>ã€‚&lt;/p>
&lt;h1 id="ä½¿ç”¨-fmterrorfä¸ç”¨-pkgerrors-ç¬¬ä¸‰æ–¹æ¨¡å—">ä½¿ç”¨ &lt;code>fmt.Errorf&lt;/code>ï¼Œä¸ç”¨ &lt;code>pkg/errors&lt;/code> ç¬¬ä¸‰æ–¹æ¨¡å—&lt;/h1>
&lt;p>è¿™ä¸€ç‚¹æ˜¯ç¬¬2ç‚¹çš„å»¶ä¼¸ã€‚&lt;/p>
&lt;p>åœ¨æ—©æœŸçš„ Golang ç‰ˆæœ¬ä¸­ï¼Œæ ‡å‡†åº“ä¸­å¹¶æ²¡æœ‰å¯¹äºé”™è¯¯æ ˆä¿¡æ¯çš„æ”¯æŒï¼Œä» Golang 1.13 å¼€å§‹ï¼ŒGolang åœ¨ &lt;code>fmt.Errorf&lt;/code> æ ‡å‡†åº“å‡½æ•°ä¸­å¢åŠ äº†ä¸€ä¸ªæ–°çš„æ ¼å¼åŒ–å ä½ç¬¦ &lt;code>%w&lt;/code> çš„æ”¯æŒï¼Œ&lt;code>w&lt;/code> æ˜¯ Wrap çš„ç¼©å†™ï¼Œæ„å³å¯¹åŸå§‹é”™è¯¯å¯¹è±¡è¿›è¡Œä¸€å±‚åŒ…è£…ã€‚æ¯”å¦‚ä¸ºäº†å®ç°ä¸ŠèŠ‚çš„é€»è¾‘æ ˆï¼Œä»£ç ç±»ä¼¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> main() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cause := errors.New(&lt;span style="font-style:italic">&amp;#34;file not found, path: /path/to/file&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> err := fmt.Errorf(&lt;span style="font-style:italic">&amp;#34;open file failed, %w&amp;#34;&lt;/span>, cause)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> err = fmt.Errorf(&lt;span style="font-style:italic">&amp;#34;parse file failed, format: JSON, %w&amp;#34;&lt;/span>, err)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> err = fmt.Errorf(&lt;span style="font-style:italic">&amp;#34;handle upload failed, %w&amp;#34;&lt;/span>, err)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(err) &lt;span style="font-style:italic">// output: handle upload failed, parse file failed, format: JSON, open file failed, file not found, path: /path/to/file
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Golang 1.13 é™¤äº† &lt;code>fmt.Errorf&lt;/code> çš„è¿™ä¸ªæ–°åŠŸèƒ½ï¼Œç›¸åº”åœ°åœ¨ &lt;code>errors&lt;/code> æ ‡å‡†åº“ä¸­ä¹Ÿå¢åŠ äº† &lt;code>errors.Is&lt;/code> ä»¥åŠ &lt;code>errors.As&lt;/code> ä¸¤ä¸ªæ–°å‡½æ•°ï¼Œå‰è€…ç”¨äºåˆ¤æ–­åˆ¶å®šé”™è¯¯çš„é”™è¯¯é“¾ä¸Šæ˜¯å¦å­˜åœ¨ç‰¹å®šçš„é”™è¯¯å€¼ï¼Œè€Œåè€…ç”¨äºå°è¯•å°† &lt;code>error&lt;/code> å€¼è½¬æ¢ä¸ºå…·ä½“çš„é”™è¯¯å€¼ã€‚åœ¨æ­¤ä¸å±•å¼€ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥ç‚¹å‡»&lt;a href="https://www.flysnow.org/2019/09/06/go1.13-error-wrapping.html">ã€ŠGoè¯­è¨€(golang)æ–°å‘å¸ƒçš„1.13ä¸­çš„Error Wrappingæ·±åº¦åˆ†æã€‹&lt;/a>ä¸€æ–‡äº†è§£æ›´å¤šç”¨æ³•ã€‚&lt;/p>
&lt;p>å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒGolang 1.13 çš„è¿™ä¸ªæ–°ç‰¹æ€§ï¼Œåº”è¯¥æ˜¯æºè‡ª &lt;a href="github.com/pkg/errors">pkg/errors&lt;/a> è¿™ä¸ªç¬¬ä¸‰æ–¹åŒ…çš„è®¾è®¡ï¼Œæ‰€ä»¥æ—©æœŸå¤§å®¶å¯èƒ½ä¼šä½¿ç”¨å…¶å®ç°ä¸Šé¢çš„é”™è¯¯æ ˆï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> main() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cause := errors.New(&lt;span style="font-style:italic">&amp;#34;file not found, path: /path/to/file&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> err := errors.WithMessage(cause, &lt;span style="font-style:italic">&amp;#34;open file failed&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> err = errors.WithMessage(err, &lt;span style="font-style:italic">&amp;#34;parse file failed, format: JSON&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> err = errors.WithMessage(err, &lt;span style="font-style:italic">&amp;#34;handle upload failed&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(err) &lt;span style="font-style:italic">// output: handle upload failed: parse file failed, format: JSON: open file failed: file not found, path: /path/to/file
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½†æ˜¯ç”±äº Golang å·²ç»å®ç°è¿™ä¸ªé”™è¯¯æ ˆçš„åŠŸèƒ½ï¼Œ&lt;code>pkg/errors&lt;/code> å·²ç»å°†é¡¹ç›®å½’æ¡£ï¼Œå¹¶ä¸”å»ºè®®å¼€å‘äººå‘˜ä½¿ç”¨ Golang å®˜æ–¹å®ç°çš„ç‰ˆæœ¬ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºäº†åº”ç”¨ç¨‹åºæœ¬èº«æ›´å¥½çš„å‘å‰å…¼å®¹ Golang 2.0ã€‚&lt;/p>
&lt;h1 id="é¿å…ä½¿ç”¨ä¾èµ–æ ‡å‡†åº“-fmt-æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ—¥å¿—æ–¹æ³•">é¿å…ä½¿ç”¨ä¾èµ–æ ‡å‡†åº“ &lt;code>fmt&lt;/code> æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ—¥å¿—æ–¹æ³•&lt;/h1>
&lt;p>åœ¨æ ‡å‡†åº“çš„æ—¥å¿—åŠŸèƒ½å®ç°ä¸­ï¼Œå…¶åŸºäº &lt;code>fmt&lt;/code> æ ‡å‡†åº“å®ç°ï¼Œè€Œåè€…åˆé‡åº¦ä¾èµ–äºåå°„çš„å·¥ä½œï¼Œè¿™äº›éƒ½å¯¼è‡´äº†æ¯”è¾ƒé«˜çš„ CPU å¼€é”€ä»¥åŠç»†ç¢çš„å†…å­˜åˆ†é…ï¼Œå‰è€…é€šè¿‡æŒ¤å  CPU æ—¶é—´ç‰‡ç›´æ¥å½±å“ç¨‹åºæ€§èƒ½ï¼Œè€Œåè€…å› ä¸ºåŠ å¤§äº†è¿è¡Œæ—¶åƒåœ¾å›æ”¶å·¥ä½œè´Ÿæ‹…é—´æ¥å½±å“ç¨‹åºæ€§èƒ½ã€‚&lt;/p>
&lt;p>é‚£æ€ä¹ˆåŠå¥½å‘¢ï¼Ÿå¯ä»¥è€ƒè™‘ç±»ä¼¼ &lt;a href="https://github.com/uber-go/zap">uber-go/zap&lt;/a> è¿™ç±»é’ˆå¯¹æ€§èƒ½ä¼˜åŒ–çš„ç¬¬ä¸‰æ–¹æ—¥å¿—åº“ã€‚zap ä¸»è¦é€šè¿‡å‡ ä¸ªè§’åº¦ä¼˜åŒ–æ€§èƒ½ï¼š&lt;/p>
&lt;ol>
&lt;li>ä½¿ç”¨å»¶è¿ŸåŠ è½½æœºåˆ¶é¿å…ä¸å¿…è¦çš„è®¡ç®—ï¼Œæ¯”å¦‚æœ‰äº›æ—¥å¿—éœ€è¦ Debug æ—¥å¿—çº§åˆ«æ‰éœ€æ‰“å°ï¼Œé‚£åœ¨ä»¥ Info æ—¥å¿—çº§åˆ«å¯åŠ¨çš„ç¨‹åºä¸­ï¼Œè¿™éƒ¨åˆ†æ—¥å¿—å…¶å®æ˜¯ä¸æ‰“å°çš„ï¼Œä¸æ‰“å°ä¹Ÿå°±æ²¡æœ‰è®¡ç®—çš„éœ€è¦ï¼Œæ‰€ä»¥å»¶è¿ŸåŠ è½½æœ‰åŠ©äºåœ¨é«˜çº§åˆ«æ—¥å¿—åœºæ™¯ä¸‹ç›´æ¥çœç•¥æ ¼å¼åŒ–æ—¥å¿—çš„å·¥ä½œï¼›&lt;/li>
&lt;li>ä½¿ç”¨æ˜¾å¼çš„ Fields æœºåˆ¶ï¼Œzap å¯ä»¥é¿å…å¤§é‡çš„åå°„éœ€æ±‚ï¼Œå¦å¤–ç»“åˆé›¶åˆ†é…çš„ JSON åºåˆ—åŒ–ç¼–ç å™¨ï¼Œæé«˜äº†æ€§èƒ½ã€‚&lt;/li>
&lt;/ol>
&lt;h1 id="è½¬æ¢å¤–éƒ¨é”™è¯¯åŸºäºå†…éƒ¨é”™è¯¯ç±»å‹åˆ¤æ–­">è½¬æ¢å¤–éƒ¨é”™è¯¯ï¼ŒåŸºäºå†…éƒ¨é”™è¯¯ç±»å‹åˆ¤æ–­&lt;/h1>
&lt;p>æ‰€è°“å¤–éƒ¨é”™è¯¯ï¼Œæ˜¯æŒ‡ç”±è‡ªèº«åº”ç”¨ç¨‹åºæºä»£ç ä¹‹å¤–æ‰€å®šä¹‰çš„é”™è¯¯ï¼Œæ¯”å¦‚ç³»ç»Ÿè°ƒç”¨çš„é”™è¯¯ã€rpc æœåŠ¡è¿”å›çš„é”™è¯¯ä»¥åŠæ•°æ®åº“è¯»å†™æ“ä½œé”™è¯¯ç­‰ã€‚åº”ç”¨ç¨‹åºè®¾è®¡è®²ç©¶åˆ†å±‚ä¸è§£è€¦ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº•å±‚å‡½æ•°è°ƒç”¨é‡åˆ°çš„å¤–éƒ¨é”™è¯¯è¿›è¡Œè½¬æ¢ï¼Œåˆ™æ„å‘³ç€ä¸Šå±‚é€»è¾‘ä¸ä¸‹å±‚å®ç°çš„è€¦åˆï¼Œç ´åäº†ä½è€¦åˆæ€§ã€‚æ¯”å¦‚ï¼Œå¯¹äºä¸€ä¸ªä¸šåŠ¡é€»è¾‘å±‚çš„ä»£ç æ¥è¯´ï¼Œå®ƒæ‰€ä¾èµ–çš„æ•°æ®åº“å±‚å‡½æ•°åº”è¯¥ç»™å®ƒç»Ÿä¸€çš„å†…éƒ¨é”™è¯¯ï¼Œæ¯”å¦‚ &lt;code>DBConnectFailed&lt;/code>ï¼Œè€Œä¸æ˜¯åè€…ä¾èµ–æŸä¸ª SDK æ‰€å®šä¹‰çš„ &lt;code>MySQLError&lt;/code> æˆ–è€… &lt;code>PGError&lt;/code> è¿™ç±»é”™è¯¯ã€‚&lt;/p>
&lt;h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h1>
&lt;ol>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/%E9%98%B2%E5%BE%A1%E6%80%A7%E7%BC%96%E7%A8%8B">é˜²å¾¡æ€§ç¼–ç¨‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.flysnow.org/2019/09/06/go1.13-error-wrapping.html">Goè¯­è¨€(golang)æ–°å‘å¸ƒçš„1.13ä¸­çš„Error Wrappingæ·±åº¦åˆ†æ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/uber-go/zap/blob/master/README.md">uber-go/zap: README&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>ä¿æŒé«˜æ•ˆä¸ä¸“æ³¨çš„ 5 ä¸ªä¹ æƒ¯</title><link>https://blog.hackerpie.com/posts/work-efficiency/5-ways-to-keep-high-efficiency-and-focus/</link><pubDate>Sun, 22 May 2022 11:07:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/work-efficiency/5-ways-to-keep-high-efficiency-and-focus/</guid><description>&lt;p>æ—¥å¸¸å·¥ä½œä¸­ï¼Œå¯èƒ½ç”±äºå„ç§å„æ ·çš„ä¿¡æ¯å¹²æ‰°å’Œè¯±æƒ‘ï¼Œäººåœ¨ä¿æŒé«˜æ•ˆå·¥ä½œä¸ä¸“æ³¨ä¸Šè¦é¢å¯¹çš„æŒ‘æˆ˜å…¶å®ä¸å°ã€‚å›é¡¾æˆ‘è‡ªå·±çš„ä¸€äº›å·¥ä½œç»éªŒå’Œä½“ä¼šï¼Œæˆ‘æ€»ç»“äº† 5 ä¸ªèƒ½å¸®åŠ©æˆ‘ä¿æŒä¸“æ³¨å’Œé«˜æ•ˆçš„ä¹ æƒ¯ï¼š&lt;/p>
&lt;ol>
&lt;li>æ‹’ç»æ³¨æ„åŠ›è¿·å®«â€”â€”ä¸è¦åœ¨ç”µè„‘ä¸Šç™»å½•å¾®ä¿¡ç­‰å¸¸ç”¨çš„ IM å·¥å…·ï¼Œå…³é—­æ‰‹æœºé€šçŸ¥æé†’&lt;/li>
&lt;li>å¼‚æ­¥æ²Ÿé€šâ€”â€”ç›´æ¥ç•™è¨€ä¸æ–‡æ¡£åä½œ&lt;/li>
&lt;li>å»¶è¿Ÿå­¦ä¹ â€”â€”æ„å¤–çš„å‘ç°æ”¾è¿› Todo list&lt;/li>
&lt;li>åŠ³é€¸ç»“åˆâ€”â€”è®©èº«ä½“èˆ’å±•ï¼Œè®©è„‘å­æ¸…ç†&lt;/li>
&lt;li>ä½©æˆ´è€³æœºï¼Œè†å¬éŸ³ä¹&lt;/li>
&lt;/ol>
&lt;h1 id="1-æ‹’ç»æ³¨æ„åŠ›è¿·å®«ä¸è¦åœ¨ç”µè„‘ä¸Šç™»å½•å¾®ä¿¡ç­‰å¸¸ç”¨çš„-im-å·¥å…·å…³é—­æ‰‹æœºé€šçŸ¥æé†’">1. æ‹’ç»æ³¨æ„åŠ›è¿·å®«â€”â€”ä¸è¦åœ¨ç”µè„‘ä¸Šç™»å½•å¾®ä¿¡ç­‰å¸¸ç”¨çš„ IM å·¥å…·ï¼Œå…³é—­æ‰‹æœºé€šçŸ¥æé†’&lt;/h1>
&lt;p>å¾®ä¿¡ç­‰å¸¸ç”¨ç¤¾äº¤è½¯ä»¶å°±åƒä¸€ä¸ªé»‘æ´ï¼Œåå™¬äººçš„å¤§é‡æ—¶é—´ã€‚åªæ˜¯ç”±äºä¸€æ¡æ–°çš„æ¶ˆæ¯åˆ°è¾¾åŠ ä¸Šä½ æƒ³è¦æ¶ˆç­å°çº¢ç‚¹çš„å¼ºè¿«ç—‡ï¼Œä½ è‡ªå·±å¾ˆå¿«å°±é™·å…¥å„ç§ä¿¡æ¯çš„è¯±æƒ‘ä¹‹ä¸­äº†ï¼Œçœ‹çœ‹è¿™ç§å¯èƒ½çš„æ³¨æ„åŠ›è½¬ç§»è·¯å¾„ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/work-efficiency/lost.jpg" alt="">
&lt;figcaption>å›¾1ï¼šæ³¨æ„åŠ›è¿·å®«&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>è€ŒæˆåŠŸé€ƒå‡ºè¿·å®«å¯èƒ½å¾—æ˜¯ä¸€æ®µå¯è§‚çš„æ—¶é—´ä¹‹åçš„äº‹æƒ…äº†ã€‚&lt;strong>æˆ‘ä¸å¾—ä¸å°è¯•å…³é—­æ‰‹æœºä¸Šçš„å„ç§ç¤¾äº¤è½¯ä»¶çš„é€šçŸ¥ï¼Œè¿™æ ·å¾ˆå¤§ç¨‹åº¦é™ä½äº†æˆ‘æ‹¿èµ·æ‰‹æœºæŸ¥çœ‹çš„é¢‘ç‡&lt;/strong>ã€‚ä½†æ˜¯æ…¢æ…¢åœ°ï¼Œæ¡Œé¢ç«¯çš„å¾®ä¿¡å®¢æˆ·ç«¯åŠŸèƒ½è¶Šæ¥è¶Šå¤šï¼Œå…ˆæ˜¯å¯ä»¥æŸ¥çœ‹æœ‹å‹åœˆäº†ï¼Œåæ¥åˆå¯ä»¥åˆ·è§†é¢‘å·äº†â€¦â€¦äºæ˜¯æˆ‘åˆå¼€å§‹å‘ç°ï¼Œæ¡Œé¢ç‰ˆçš„å¾®ä¿¡åŒæ ·ä¼šè®©æˆ‘å¾ˆå®¹æ˜“èµ°ç¥ï¼Œæˆ‘å°±å¼€å§‹ä¸åœ¨ä¸Šç­æ—¶é—´ç™»å½•æ¡Œé¢ç‰ˆå¾®ä¿¡ï¼Œè¿™åŒæ ·èƒ½å¤Ÿå¸®åŠ©æˆ‘ä¸“æ³¨äºæ¯å¤©çš„å·¥ä½œã€‚&lt;/p>
&lt;p>å±è”½äº†æ‰‹æœºé€šçŸ¥ï¼Œä¸»åŠ¨ä¸å»åœ¨ç”µè„‘ä¸Šç™»å½•å¾®ä¿¡ï¼Œçœ‹ä¼¼æˆ‘è·Ÿä¸ä¸Šå¾ˆå¤šä¿¡æ¯äº†ï¼Œä½†æ˜¯è‡³å°‘æˆ‘ä¸“æ³¨äº†ï¼Œè€Œä¸”äº‹å®æ˜¯ï¼Œç°åœ¨äº’è”ç½‘ä¸Šçš„å¾ˆå¤šä¿¡æ¯åŒè´¨åŒ–ä¸¥é‡ï¼ŒçœŸå‡éš¾è¾¨ï¼Œä½ æ²¡æœ‰å¿…è¦è·Ÿä¸Šã€‚&lt;/p>
&lt;h1 id="2-å¼‚æ­¥æ²Ÿé€šç›´æ¥ç•™è¨€ä¸æ–‡æ¡£åä½œ">2. å¼‚æ­¥æ²Ÿé€šâ€”â€”ç›´æ¥ç•™è¨€ä¸æ–‡æ¡£åä½œ&lt;/h1>
&lt;p>å¼‚æ­¥æ²Ÿé€šæ˜¯æ²Ÿé€šåŒæ–¹ä¸éœ€è¦å¯¹æ”¶åˆ°çš„æ¶ˆæ¯ç«‹é©¬è¿›è¡Œå›åº”ï¼Œè€Œæ˜¯ç­‰åˆ°è‡ªå·±æŸä¸ªç©ºæ¡£æˆ–è€…ä¹ æƒ¯çš„æ—¶é—´çª—å£å†ç»Ÿä¸€è¿›è¡Œæ¶ˆæ¯é˜…è¯»å’Œå›å¤ç­‰ï¼Œæ¯”å¦‚ç”µå­é‚®ä»¶å¤©ç„¶å°±æ˜¯ä¸€ç§å¼‚æ­¥æ²Ÿé€šçš„å…¸èŒƒï¼Œåªæ˜¯å›½äººå¤§éƒ½ä¸ä¹ æƒ¯é‚®ä»¶æ²Ÿé€šçš„è¿™ç§æ–¹å¼ã€‚&lt;/p>
&lt;p>ä¹‹æ‰€ä»¥æå€¡å¼‚æ­¥æ²Ÿé€šï¼Œå¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œä¸»è¦æ˜¯ä¸¤æ–¹é¢çš„éœ€è¦ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>é™ä½æ€ç»´ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€&lt;/strong>ï¼šå› ä¸ºäººåœ¨åˆ‡æ¢è¦åšçš„äº‹æƒ…çš„æ—¶å€™ï¼Œæ˜¯éœ€è¦å›æƒ³äº‹æƒ…çš„ç¼˜ç”±ã€è¿›åº¦ä»¥åŠæ—¢å®šæ€è·¯çš„ï¼Œè¿™äº›å°±æ˜¯å¼€é”€ï¼›&lt;/li>
&lt;li>&lt;strong>é™ä½ç„¦è™‘&lt;/strong>ï¼šç„¦è™‘æ˜¯å› ä¸ºå®¹æ˜“çº ç»“åˆ«äººæ¶ˆæ¯ä¸€ç›´æœªè¯»ã€å·²è¯»ä¸å›ç­‰ï¼Œä»¿ä½›å¯¹æ–¹ä¸å›å¤ï¼Œè‡ªå·±å°±æ²¡æ³•ç»§ç»­å·¥ä½œäº†ã€‚æƒ³è¦ä¸ç„¦è™‘ï¼Œåªèƒ½è°ƒæ•´è‡ªå·±çš„é¢„æœŸï¼Œé¢„æœŸå¤§å®¶éƒ½æ˜¯å¼‚æ­¥æ²Ÿé€šï¼Œä¹Ÿå°±å¹³å’Œäº†ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ€ä¹ˆåšå‘¢ï¼Ÿå¸¸è§åˆ†ä¸¤ç§å§ã€‚&lt;/p>
&lt;p>&lt;strong>ç¬¬ä¸€ç§ï¼Œæœ‰ä¸€ä¸ªé›¶ç¢çš„äº‹æƒ…éœ€è¦åˆ«äººå¸®å¿™æä¾›æ„è§æˆ–è€…å†³ç­–ï¼Œç›´æ¥ç•™è¨€&lt;/strong>ã€‚ä»¥å‰æˆ‘æ€»æ˜¯è§‰å¾—æœ‰ä»€ä¹ˆäº‹æƒ…ç­‰åˆ°å¯¹æ–¹æœ‰ç©ºäº†å†è¯´ï¼Œä½†æ˜¯è¿™æ ·äº‹æƒ…å¯èƒ½å°±æ‹–è¿‡å¤´äº†ã€‚ç°åœ¨çš„æˆ‘ä¼šå€¾å‘äºï¼š&lt;strong>æƒ³è¦æ²Ÿé€šçš„äº‹æƒ…ï¼Œå¦‚æœä¸æ˜¯å¤ªå¤æ‚ï¼Œä¸€ä¸¤å¥è¯å°±èƒ½è¯´æ¸…æ¥šçš„ï¼Œé‚£æˆ‘å°±ç›´æ¥åœ¨ IM è½¯ä»¶é‡Œç»™å¯¹æ–¹ç•™è¨€&lt;/strong>ï¼Œä¹‹åè¿™ä¸ªäº‹æƒ…æˆ‘ä¹Ÿå°±ä¸ç”¨æ‹…å¿ƒè‡ªå·±ä¼šå¿˜äº†ï¼ŒåŒæ—¶æˆ‘ä¹Ÿå¯ä»¥æ”¾å¿ƒå»åšå…¶ä»–äº‹æƒ…äº†ï¼Œè‡³äºä»–æ˜¯å³æ—¶å›å¤è¿˜æ˜¯æ™šç‚¹å›å¤ï¼Œå¯¹æˆ‘éƒ½ä¸æ˜¯é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä¸€å®šæ˜¯æ™šç‚¹æ‰ä¼šå›æ¥çœ‹æ¶ˆæ¯çš„ã€‚è¿™é‡Œå…¶å®è¿˜æœ‰ä¸ªå¥½å¤„ï¼Œæˆ‘æ€»è§‰å¾—æˆ‘è‡ªå·±å¤šå°‘æœ‰äº›æ‹–å»¶ç—‡ï¼Œä½†æ˜¯é€šè¿‡è¿™ç§æœ‰äº‹æ—©ç‚¹ç•™è¨€çš„æ–¹å¼ï¼Œæˆ‘å°±ä¸å¾—ä¸åœ¨æ›´å¿«çš„æ—¶é—´å†…å¤„ç†å®Œè¿™ä¸ªäº‹æƒ…ï¼Œå› ä¸ºä¸€æ—¦å¯¹æ–¹å›å¤äº†æˆ‘ï¼Œæˆ‘çœŸçš„å°±ä¸å¥½æ„æ€æ‹–ç€äº†ã€‚&lt;/p>
&lt;p>&lt;strong>ç¬¬äºŒç§ï¼Œæ¶‰åŠå›¢é˜Ÿé—´æ²Ÿé€šç­‰å¤æ‚é—®é¢˜çš„ï¼Œä»¥åä½œæ–‡æ¡£å½¢å¼æ²Ÿé€š&lt;/strong>ã€‚æœ€è¿‘æˆ‘è´Ÿè´£çš„ä¸šåŠ¡éœ€è¦æ¥å…¥å¦ä¸€ä¸ªä¸­å°å›¢é˜Ÿä»–ä»¬çš„æœåŠ¡ï¼Œä½†æ˜¯å› ä¸ºåªæœ‰ä¸€ä»½ç®€å•çš„æ–‡æ¡£ï¼Œåˆç¼ºå°‘å¾ˆå¤šä¸Šä¸‹æ–‡ï¼Œæ‰€ä»¥å¾ˆå¤šä¸œè¥¿çœ‹ä¸æ˜ç™½ã€‚åœ¨æ¶æ„å¸ˆåŒäº‹å¸®å¿™æ‹‰äº†ç¾¤ä¹‹åï¼Œæˆ‘å…ˆæ˜¯å¾ˆè®¤çœŸåœ°æ•´ç†äº†ä¸€ä»½é—®é¢˜æ¸…å•ï¼Œä¸Šé¢å†™æ¸…æ¥šæ¯ä¸€ä¸ªé—®é¢˜çš„èƒŒæ™¯ï¼ˆe.g. æˆ‘æƒ³è¦ç”¨ä»–ä»¬çš„æœåŠ¡åšä»€ä¹ˆäº‹ï¼‰ï¼Œä»¥åŠæˆ‘å‚è€ƒçš„ä»–ä»¬çš„æ–‡æ¡£çš„å‡ºå¤„ï¼ˆe.g. æˆ‘ç†è§£çš„æŸä¸ªæ¥å£æ˜¯æˆ‘å¯ä»¥ç”¨æ¥å®Œæˆæˆ‘æƒ³åšçš„äº‹ï¼‰ï¼Œä»¥åŠæˆ‘çš„å…·ä½“é—®é¢˜æ˜¯ä»€ä¹ˆï¼ˆe.g. æœ‰äº›åœ°æ–¹è·Ÿæˆ‘çš„éœ€æ±‚æœ‰å‡ºå…¥ï¼‰ï¼ŒåŒæ—¶å°½å¯èƒ½ä»¥æˆ‘è‡ªå·±çš„ç†è§£å¤è¿°äº†ä¸€è¾¹ï¼Œåœ¨æ–‡æ¡£ä¸Šè¯·æ±‚å¯¹æ–¹ç»™äºˆç¡®è®¤ã€‚åˆ°äº†ç¬¬äºŒä¸ªå·¥ä½œæ—¥çš„æ—¶å€™ï¼Œå¾ˆè®©æˆ‘æƒŠè®¶çš„æ˜¯ï¼ŒåŒäº‹åœ¨çœ‹åˆ°æ–‡æ¡£åï¼Œå¹¶æ²¡æœ‰åœ¨æ–‡æ¡£ä¸Šç›´æ¥å›å¤ï¼Œè€Œæ˜¯å¤åˆ¶äº†é—®é¢˜å†é€ä¸ªå‘å›ç¾¤é‡Œé€ä¸ªå›å¤ã€‚åæ¥æˆ‘å°†ä»–çš„å›å¤æ‹·è´å›æ–‡æ¡£ä¸Šï¼Œè€Œä»–å¯èƒ½ä¹Ÿæ„è¯†åˆ°äº†æˆ‘çš„ç”¨æ„ï¼Œæ‰å¼€å§‹åœ¨æ–‡æ¡£ä¸Šç›´æ¥å›å¤ã€‚å°±è¿™æ ·ï¼Œä¸€æ¬¡åŸºäºæ–‡æ¡£çš„å¼‚æ­¥æ²Ÿé€šå°±è¿™ä¹ˆå®Œæˆï¼Œè€Œä¸”ä¿¡æ¯å¾ˆèšç„¦ï¼Œå¯¹äºä¸€ä¸ªé—®é¢˜ï¼Œæ²Ÿé€šè¿‡ç¨‹å’Œç»“è®ºéƒ½åœ¨ä¸€ä»½æ–‡æ¡£é‡Œã€‚&lt;strong>æ–‡æ¡£æ²Ÿé€šçš„å½¢å¼ï¼Œä¸€ä¸ªæ˜¯ä¾¿äºå¼‚æ­¥æ²Ÿé€šï¼ŒåŒæ–¹ä¸ç”¨åå¤ç¿»çœ‹èŠå¤©è®°å½•å¯»æ‰¾ä¸Šä¸‹æ–‡ï¼›å¦ä¸€ä¸ªæ˜¯å¸®æˆ‘è‡ªå·±ç†æ¸…æ¥šçœŸæ­£çš„é—®é¢˜ï¼Œä»¥åŠé—®é¢˜çš„æ¡ç†è¡¨è¾¾ï¼Œè¿™æ—¢æ˜¯å¯¹å¯¹æ–¹æ—¶é—´çš„å°Šé‡ï¼Œä¹Ÿæ˜¯ç¡®ä¿æ²Ÿé€šé«˜æ•ˆçš„æ–¹å¼ã€‚&lt;/strong>&lt;/p>
&lt;h1 id="3-å»¶è¿Ÿå­¦ä¹ æ„å¤–çš„å‘ç°æ”¾è¿›-todo-list">3. å»¶è¿Ÿå­¦ä¹ â€”â€”æ„å¤–çš„å‘ç°æ”¾è¿› Todo list&lt;/h1>
&lt;p>åˆšå¼€å§‹å…¥è¡Œå·¥ä½œæ²¡å¤šä¹…çš„æ—¶å€™ï¼Œæˆ‘å°±å…»æˆäº†ä¸€ç§è‡³ä»Šéƒ½åœ¨ä½¿ç”¨çš„ä¹ æƒ¯ï¼šå»¶è¿Ÿå­¦ä¹ ã€‚è¿™ç§å»¶è¿Ÿå­¦ä¹ ä¸æ˜¯æŒ‡ä»€ä¹ˆçŸ¥è¯†çš„å­¦ä¹ éƒ½è¦å»¶è¿Ÿï¼Œè€Œæ˜¯æŒ‡ä¸€äº›ä¸å½“å‰éœ€è¦ä¼˜å…ˆå®Œæˆçš„äº‹æƒ…æ— å…³çš„æœ‰è¶£çš„ä¸œè¥¿éƒ½å¯ä»¥æ”¾è¿› Todo listï¼Œå¯ä»¥ç­‰ä¸šä½™æ—¶é—´å†å»å­¦ä¹ ç ”ç©¶ï¼Œäº«å—çŸ¥è¯†çš„å¿«ä¹ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªç¨å¾®å…·ä½“çš„ä¾‹å­ï¼Œç¨‹åºå‘˜å†™ä»£ç çš„æ—¶å€™ï¼Œä¸ºäº†è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œéƒ½ä¼šå°è¯•åœ¨æœç´¢å¼•æ“ä¸Šå¯»æ‰¾ç­”æ¡ˆæˆ–è€…çµæ„Ÿï¼Œå¾€å¾€åœ¨è¿™ä¸ªæ—¶å€™ä¼šå‘ç°ä¸€äº›è‡ªå·±ä»æ¥éƒ½ä¸çŸ¥é“çš„æŠ€æœ¯ï¼Œè¿™äº›æŠ€æœ¯æˆ–è€…æœ‰è¶£æˆ–è€…é…·ç‚«ï¼Œ&lt;/p>
&lt;blockquote>
&lt;p>â€œå“‡ï¼&lt;code>(âœ§â—¡âœ§)&lt;/code>å¥½æƒ³èµ¶ç´§å­¦ä¼šæŒæ¡ä½å•Šï¼â€&lt;/p>
&lt;/blockquote>
&lt;p>å°±åƒä¸€ä¸ªæ²™æ¼ é‡Œå¯»æ‰¾æ°´æºçš„äººçªç„¶å‘ç°äº†ä¸€ç®±é‡‘å­ï¼Œè¿™ä¸ªæ„å¤–å‘ç°å¾ˆè®©äººæ¿€åŠ¨ï¼Œä½†æ˜¯å®¹æ˜“è®©äººå¿˜äº†ç›®æ ‡ã€‚è€Œæˆ‘åœ¨å·¥ä½œè¿‡ç¨‹ä¸­ä¹Ÿç¡®å®å› ä¸ºå„ç§æ„å¤–æ”¶è·çš„æŠ€æœ¯æ€è·¯è€Œæ‹“å±•äº†å¾ˆå¤šæŠ€æœ¯è§†é‡ï¼Œå½“ç„¶ï¼Œéƒ½æ˜¯åœ¨æ²¡æœ‰å½±å“æœ¬èŒå·¥ä½œçš„å‰æä¸‹ï¼Œæ€ä¹ˆåšçš„å‘¢ï¼Ÿç”¨ Todo listï¼&lt;/p>
&lt;p>æœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä½¿ç”¨äº† Trello æ¥åˆ†é—¨åˆ«ç±»ç®¡ç†æˆ‘æƒ³å»¶åå®Œæˆçš„ä¸€äº›æŠ€æœ¯å­¦ä¹ ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/work-efficiency/my-trello-boards.png" alt="">
&lt;figcaption>å›¾2ï¼šæˆ‘çš„ Trello çœ‹æ¿&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;ul>
&lt;li>Blogï¼šæ˜¯æˆ‘ä¸€äº›å·²ç»åŸºæœ¬æŒæ¡çš„çŸ¥è¯†ï¼Œæˆ‘æƒ³è¦åœ¨ä¸šä½™æ—¶é—´æ•´ç†åˆ†äº«çš„å†…å®¹&lt;/li>
&lt;li>labsï¼šæ˜¯æˆ‘ä¸€äº›ä¸´æ—¶æƒ³åˆ°çš„æŠ€æœ¯ä¸Šæƒ³è¦æŠ˜è…¾çš„ç‚¹å­ï¼Œæ”¾åœ¨å¿ƒé‡Œæ‰‹ä¼šå‘ç—’ï¼Œæ‰€ä»¥å…ˆå†™ä¸‹æ¥ï¼Œå°±ä¸ä¼šæ€»æƒ¦è®°ç€äº†&lt;/li>
&lt;li>Topicsï¼šæ˜¯æˆ‘ä¸€äº›æƒ³è¦åœ¨ä¸€äº›æŠ€æœ¯åˆ†äº«ä¼šä¸Šäº¤æµçš„æƒ³æ³•ï¼Œå¯èƒ½ä¼šæ•´ç†æˆå¹»ç¯ç‰‡ç­‰&lt;/li>
&lt;/ul>
&lt;p>æ¯”å¦‚ï¼Œæˆ‘çš„ Blog çœ‹æ¿ä¸‹å°±æœ‰è¿™äº›ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/work-efficiency/Blog-board.png" alt="">
&lt;figcaption>å›¾3ï¼šæˆ‘çš„ Blog çœ‹æ¿&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>æœ‰äº›ç‚¹å­æ”¾äº†å¥½å‡ å¹´ï¼Œä¹Ÿéƒ½ä¸€ç›´æ²¡å»å†™ï¼Œä¹Ÿæœ‰äº›ç‚¹å­å¾ˆå¿«å°±æ”¾å¼ƒäº†ï¼Œä¹Ÿæœ‰ä¸€äº›å¹²ä¸€åŠï¼Œè¿˜æœ‰ä¸€äº›çœŸçš„å°±å»å†™äº†ï¼Œéƒ½å¾ˆæ­£å¸¸ã€‚æœ‰äº›æƒ³æ³•å½“æ—¶å¾ˆå†²åŠ¨ï¼Œä¹‹åå†å»çœ‹ä¸€çœ¼ï¼Œå°±è§‰å¾—å®åœ¨æ²¡å¿…è¦ï¼Œæ‰€ä»¥å»¶åæ˜¯ä¸€ç§éªŒè¯è‡ªå·±æ˜¯å¦åªæ˜¯ä¸‰åˆ†é’Ÿçƒ­åº¦çš„å¥½åŠæ³•ï¼ŒçœŸæ­£çš„çƒ­çˆ±ä¼šåœ¨ä¹‹åä¾æ—§å……æ»¡å¹²åŠ²ã€‚&lt;/p>
&lt;p>é™¤äº†è®°å½•ç‚¹å­ï¼Œæˆ‘ä¹Ÿä¼šæŠŠè¿‡ç¨‹ä¸­æƒ³åˆ°çš„ã€çœ‹åˆ°çš„ç›¸å…³ç‰‡æ®µè®°å½•åˆ°å¯¹åº”å¡ç‰‡ä¸Šï¼Œæ¯”å¦‚ä¸€äº›æˆªå›¾ã€æ—¥å¿—æˆ–è€…è‡ªå·±ç»™è‡ªå·±ç•™çš„é—®é¢˜ï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/work-efficiency/card-example.png" alt="">
&lt;figcaption>å›¾4ï¼šä¸€ä¸ªè®°å½•è¿‡ç¨‹ä¸­é›¶ç¢ä¿¡æ¯çš„ç¤ºä¾‹&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>è€Œç°åœ¨ï¼Œå› ä¸ºå–œæ¬¢ä½¿ç”¨ Notionï¼Œæˆ‘åœ¨ Notion è®°å½•äº†å¾ˆå¤šç±»ä¼¼çš„ä¸œè¥¿ï¼Œä¸€æ—¦åç»­æ•´ç†å®Œå†™æˆåšå®¢åï¼Œå°±ä¼šå°†å…¶ä»Notionä¸Šåˆ é™¤ï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/work-efficiency/notion-list.png" alt="">
&lt;figcaption>å›¾5ï¼šæˆ‘åœ¨ Notion ä¸Šè®°å½•çš„ä¸œè¥¿&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>åœ¨æ—¥å¸¸ä¸­ï¼Œå°†è¿™äº›æ„å¤–çš„æƒŠå–œéƒ½æ”¾è¿›ä¸€ä¸ªå»¶è¿Ÿå¤„ç†çš„åœ°æ–¹ï¼Œä¼šè®©æˆ‘è‡ªå·±ä¸è‡³äºåç¦»æ–¹å‘ï¼Œæ›´å¥½åœ°å›å½’ç›®æ ‡æœ¬èº«ã€‚å°±åƒæ˜¯é‚£ä¸ªæ„å¤–å‘ç°é‡‘å­çš„å¯»æ°´äººï¼Œæœ€å¥½è¿˜æ˜¯å…ˆåšäº†ä¸ªè®°å·ï¼Œç„¶åè¦å…ˆæ‰¾åˆ°æ°´æ´»ä¸‹å»ï¼Œæœ€åæœ‰å¯èƒ½çš„è¯ï¼Œå†å›å»å¸¦èµ°é‡‘å­ã€‚&lt;/p>
&lt;h1 id="4-åŠ³é€¸ç»“åˆè®©èº«ä½“èˆ’å±•è®©è„‘å­æ¸…ç†">4. åŠ³é€¸ç»“åˆâ€”â€”è®©èº«ä½“èˆ’å±•ï¼Œè®©è„‘å­æ¸…ç†&lt;/h1>
&lt;p>ä¿æŒé«˜æ•ˆå·¥ä½œçš„å…¶ä¸­ä¸€ä¸ªå¥½æ–¹æ³•ï¼Œå…¶å®æ˜¯é€‚å½“åœä¸‹å·¥ä½œã€‚ä»¥æˆ‘è‡ªå·±ä¸ºä¾‹ï¼Œè¿‡å»æˆ‘ä»¥åƒä¸€å¤´ç‰›ä¸€æ ·åŸ‹å¤´è‹¦å¹²ä¸ºè£ï¼Œæ‰€ä»¥å¯èƒ½ä¸€åŸ‹å¤´å°±æ˜¯ä¸€æ•´ä¸ªåŠå¤©ï¼Œä½†æ˜¯å¾€å¾€è¿‡ç¨‹ä¸­ä¸èƒœå›°é¡¿ï¼Œå†™ç€ä»£ç å¿«ç¡ç€çš„ä½“éªŒä¹Ÿæ˜¯å¸¸æœ‰çš„ã€‚æœ€ç³Ÿç³•çš„æ˜¯ï¼Œå¯èƒ½å¹²å®Œæ‰å‘ç°è‡ªå·±å¹²é”™æ–¹å‘äº†ï¼ŒçŠäº†åŠå¤©çš„ç”°ï¼ŒçŠåˆ°åˆ«äººå®¶çš„ç”°é‡Œå»äº†ã€‚åæ¥ä¹Ÿæ˜¯æ— æ„é—´å‘ç°ï¼Œåå€’æ˜¯æ—¶ä¸æ—¶åœä¸‹æ¥ä¼‘æ¯ä¸€ä¸‹ï¼Œå½“åœºå›é¡¾è‡ªå·±çš„å·¥ä½œï¼Œæ›´èƒ½å‘ç°æ½œåœ¨çš„é—®é¢˜ï¼Œæ›´æ—©çº æ­£é”™è¯¯çš„æ–¹å‘ã€‚&lt;/p>
&lt;p>åœ¨è¿™ç‚¹ä¸Šï¼Œæˆ‘çš„ä¸ªäººå®è·µæ˜¯ä½¿ç”¨ &lt;a href="https://hovancik.net/stretchly/">Stretchly&lt;/a> è¿™ä¸ªè½¯ä»¶ï¼Œå®ƒå¯ä»¥å¸®åŠ©ç”¨æˆ·åœ¨è®¾å®šçš„æ—¶é—´é—´éš”é‡Œå¼¹å‡ºå…¨å±çš„ä¼‘æ¯æé†’ï¼Œè®©ä½ è®°å¾—ä¼‘æ¯å’Œè°ƒæ•´ã€‚æˆ‘çš„ä¸ªäººä¹ æƒ¯æ˜¯æ¯ 55 åˆ†é’Ÿä¼‘æ¯ 5 åˆ†é’Ÿï¼Œåœ¨è¿™ 5 åˆ†é’Ÿé‡Œï¼Œæˆ‘ä¼šèµ°åŠ¨ä¸€ä¸‹ï¼Œæ‰­æ‰­è…°ï¼Œè¿œçœºä¸€ä¸‹ï¼Œä¸Šä¸ªæ´—æ‰‹é—´ï¼Œåƒä¸ªæ°´æœå•¥çš„ï¼Œè¿™æ ·æ—¢å¯ä»¥é¿å…è‡ªå·±é•¿æ—¶é—´ä¿æŒä¸€ä¸ªå§¿åŠ¿ï¼Œä¹Ÿå¯ä»¥è®©è‡ªå·±æ¢å¤å‡ åˆ†æ¸…é†’ï¼Œæˆ‘ä¸ªäººæ˜¯å¥½å‡ æ¬¡åœ¨è¿™ä¸ªè¿‡ç¨‹çªç„¶å‘ç°è‡ªå·±æŠ€æœ¯æ–¹æ¡ˆä¸Šçš„ç¼ºé™·ã€‚&lt;/p>
&lt;p>å¯¹äº†ï¼Œæˆ‘ä¸€èˆ¬ä¹Ÿä¼šåœ¨è¿™å‡ åˆ†é’Ÿé‡ŒæŸ¥çœ‹æ‰‹æœºï¼Œå›å¤é‡è¦æ¶ˆæ¯ç­‰ã€‚&lt;/p>
&lt;h1 id="5-ä½©æˆ´è€³æœºè†å¬éŸ³ä¹">5. ä½©æˆ´è€³æœºï¼Œè†å¬éŸ³ä¹&lt;/h1>
&lt;p>ä½©æˆ´è€³æœºä¹Ÿæ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„æ–¹æ³•ï¼Œä½†æ˜¯å…¶å®æˆ‘å¹¶ä¸æå€¡é•¿æ—¶é—´ä½©æˆ´è€³æœºï¼Œé™¤äº†å¼€ä¼šï¼Œæˆ‘è‡ªå·±ä¼šåœ¨ä¸¤ç§æƒ…å†µä¸‹ä½©æˆ´è€³æœºï¼š&lt;/p>
&lt;ol>
&lt;li>ç¯å¢ƒå˜ˆæ‚ï¼šæ¯”å¦‚å‘¨å›´å¾ˆå¤šäººåœ¨è®¨è®ºï¼›&lt;/li>
&lt;li>æˆ‘è‡ªå·±å¾ˆå…´å¥‹ï¼šæ¯”å¦‚æˆ‘å¾ˆæœŸå¾…æ¥ä¸‹æ¥çš„å·¥ä½œå†…å®¹ï¼Œæˆ‘æƒ³è¦æœ‰ä¸ªéŸ³ä¹æ¥åŠ©åŠ©å…´ã€‚&lt;/li>
&lt;/ol>
&lt;p>å¯¹äºå¬ä»€ä¹ˆï¼Œæœ€å¥½æ˜¯è½»éŸ³ä¹æˆ–è€…è‡ªå·±å¬ä¸æ‡‚çš„éŸ³ä¹ï¼Œæ¯”å¦‚éŸ©è¯­æ­Œæ›²ï¼Œå½“ç„¶æˆ‘æ˜¯è½»éŸ³ä¹æœ€å¤šï¼Œå› ä¸ºèƒ½å¤Ÿå®‰æŠšå†…å¿ƒï¼Œè®©è‡ªå·±å¹³é™ä¸€äº›ã€‚
&lt;strong>ä½©æˆ´è€³æœºçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œèƒ½å¤Ÿå¸®ä½ å±è”½æ‰ä¸€äº›ä¸å¿…è¦çš„æ‰“æ‰°&lt;/strong>ï¼Œæ¯”å¦‚æœ‰äº›äººçœ‹åˆ°ä½ æˆ´ç€è€³æœºï¼Œé‚£ä»–å¯èƒ½å°±ä¼šå¤šè¯„ä¼°ä¸‹ä¸€ä¸ªäº‹æƒ…æ˜¯å¦çœŸçš„éœ€è¦å½“é¢è·Ÿä½ æ²Ÿé€šï¼Œä¹Ÿè®¸ä¸€äº›ä¸å¿…è¦çš„å½“é¢æ²Ÿé€šä¹Ÿå°±è¿™æ ·çœç•¥äº†ã€‚&lt;/p>
&lt;h1 id="æ€»ç»“">æ€»ç»“&lt;/h1>
&lt;p>å·¥ä½œçš„é«˜æ•ˆï¼Œä¸€æ–¹é¢æ˜¯ä¸“ä¸šæŠ€èƒ½çš„å¾—å¿ƒåº”æ‰‹ï¼Œå¦ä¸€æ–¹é¢æ˜¯æ§åˆ¶è‡ªå·±çš„æ³¨æ„åŠ›ä¸è¢«å„ç§å½¢å½¢è‰²è‰²çš„ä¸œè¥¿æ‰€åˆ†æ•£ã€‚ä¸Šé¢æ€»ç»“çš„ 5 ä¸ªä¹ æƒ¯ï¼š&lt;/p>
&lt;ul>
&lt;li>å±è”½å¾®ä¿¡ç­‰è®©æˆ‘å‡å°‘èµ°ç¥çš„æœºä¼šï¼›&lt;/li>
&lt;li>å¼‚æ­¥æ²Ÿé€šè®©æˆ‘çµæ´»å·¥ä½œï¼Œå‡å°‘ç„¦è™‘ï¼›&lt;/li>
&lt;li>å»¶è¿Ÿå­¦ä¹ è®©æˆ‘èšç„¦ç›®æ ‡ï¼Œä¸å—çªå¦‚å…¶æ¥çš„è¯±æƒ‘æ§åˆ¶ï¼Œä½†æ˜¯ä¹Ÿä¸è€½è¯¯æˆ‘å¤šå­¦ä¹ æ–°çš„æŠ€èƒ½ï¼›&lt;/li>
&lt;li>åŠ³é€¸ç»“åˆè®©æˆ‘æ›´æ³¨é‡å·¥ä½œçš„ç­–ç•¥æ€§ï¼›&lt;/li>
&lt;li>é€‚åº¦ä½¿ç”¨è€³æœºå¯ä»¥å¸®åŠ©æˆ‘é™å¿ƒå·¥ä½œï¼ŒåŒæ—¶å‡å°‘å¹²æ‰°ã€‚&lt;/li>
&lt;/ul>
&lt;p>è¯šç„¶ï¼Œæˆ‘æ²¡æœ‰100%çš„æ—¶é—´é‡Œéƒ½åšåˆ°è¿™äº›ï¼Œä½†æ˜¯æ€»ä½“ä¸Šæˆ‘è‡ªå·±æ˜¯æœ‰å¾ˆå¤§å—ç›Šçš„ï¼Œæ‰€ä»¥å¸Œæœ›èƒ½å¤Ÿåˆ†äº«å‡ºæ¥ï¼Œæˆ–è®¸èƒ½å¤Ÿç»™å…¶ä»–äººæä¾›çµæ„Ÿã€‚&lt;/p></description></item><item><title>å¤šæ—¶é’Ÿè§£å†³é›ªèŠ±ç®—æ³•çš„æ—¶é—´å›æ‹¨é—®é¢˜</title><link>https://blog.hackerpie.com/posts/algorithms/snowflake/multiple-clocks-snowflake/</link><pubDate>Sun, 27 Mar 2022 16:18:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/algorithms/snowflake/multiple-clocks-snowflake/</guid><description>&lt;p>åˆ†å¸ƒå¼ ID ç”Ÿæˆç®—æ³•ç”¨äºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”Ÿæˆå…¨å±€å”¯ä¸€çš„ ID æ ‡è¯†ï¼Œè€Œ twitter æå‡ºçš„é›ªèŠ±ç®—æ³•ä¾¿æ˜¯å…¶ä¸­ä¸€ç§çŸ¥åçš„ç®—æ³•ï¼Œå…¶æ¯æ¬¡ä¼šç”Ÿæˆä¸€ä¸ª 64 ä½çš„å…¨å±€å”¯ä¸€æ•´æ•°ï¼Œç®—æ³•çš„åŸºæœ¬æ€æƒ³éå¸¸å·§å¦™ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span> 0 1010......101 1010101010 101010101010
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">\&lt;/span>_/ &lt;span style="">\&lt;/span>___________/ &lt;span style="">\&lt;/span>________/ &lt;span style="">\&lt;/span>__________/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ç¬¬1ä½ä¸ä½¿ç”¨ 41ä½æ¯«ç§’æ—¶é—´æˆ³ 10ä½æœºå™¨ID 12ä½åºåˆ—å·
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é™¤äº†å¼€å¤´çš„ç¬¬ 1 ä½ä¸ä½¿ç”¨ï¼Œæ¥ä¸‹æ¥çš„ 41 ä½æ—¶é—´æˆ³æ˜¯ä»æŒ‡å®šçš„èµ·å§‹æ—¶é—´åˆ°å½“å‰æ—¶é—´æ‰€ç»å†çš„æ¯«ç§’æ•°ï¼Œæ¯”å¦‚è®¾å®šç³»ç»Ÿèµ·å§‹æ—¶é—´ä¸º 2022 å¹´ 3 æœˆ 15 æ—¥ 0 ç‚¹æ•´ï¼Œåˆ™åœ¨ 2022 å¹´ 4 æœˆ 1 æ—¥ä¸­åˆ 12:00:00.123 æ—¶ï¼Œæ­¤æ—¶é—´æˆ³çš„å€¼åº”è¯¥ä¸º &lt;code>1,512,000,123&lt;/code>ï¼Œæ•´ä¸ªæ—¶é—´æˆ³ç‰‡æ®µï¼Œæ”¯æŒæœ€å¤š &lt;code>69.7&lt;/code> å¹´ï¼Œè¿™æ˜¾ç„¶ä¹Ÿè¶…å‡ºäº†ç»å¤§å¤šæ•° IT ç³»ç»Ÿçš„å­˜æ´»å¹´é™ã€‚&lt;/p>
&lt;p>è€Œ 10 ä½æœºå™¨ IDï¼Œå¯¹åº”æœ€å¤šå®¹çº³ä¸€ä¸ª 1024 ä¸ª ID ç”Ÿæˆå™¨å®ä¾‹çš„åˆ†å¸ƒå¼é›†ç¾¤ï¼Œ12 ä½åºåˆ—å·ä» 0 åˆ° 4095 å‘¨è€Œå¤å§‹è¿ç»­é€’å¢ï¼Œå¯ä»¥æ”¯æŒå•ä¸ªå®ä¾‹æ¯æ¯«ç§’ 4096 æ¬¡ ID ç”Ÿæˆè¯·æ±‚ï¼Œæ„å‘³ç€æ•´ä¸ª ID ç”Ÿæˆå™¨å®ä¾‹çš„é›†ç¾¤ï¼Œç†è®ºä¸Šæ¯æ¯«ç§’ä¾¿å¯ä»¥æ”¯æŒæœ€å¤š &lt;code>4194304&lt;/code> ä¸ª ID ç”Ÿæˆï¼Œæ•ˆç‡éå¸¸é«˜ã€‚&lt;/p>
&lt;p>é›ªèŠ±ç®—æ³•ç”Ÿæˆçš„ ID çš„å…¨å±€å”¯ä¸€çš„ç†è®ºåŸºç¡€æ˜¯å…¨å±€å”¯ä¸€æ€§ä¸å•å®ä¾‹å”¯ä¸€æ€§çš„ç»“åˆï¼Œå…¨å±€å”¯ä¸€æ€§ç”±å”¯ä¸€çš„æœºå™¨ ID ä¿è¯ï¼Œä¸åŒçš„æœºå™¨IDä¿è¯ä¸åŒå®ä¾‹ç”Ÿæˆçš„ ID å¿…ç„¶ä¸ä¼šä¸€è‡´ï¼Œè€Œå•å®ä¾‹å”¯ä¸€ç”±åŒä¸€æ¯«ç§’ç»“åˆä¸åŒçš„åºåˆ—å·æ¥ä¿è¯ï¼Œè¿™é‡Œçš„åºåˆ—å·åªèƒ½åšåˆ°ç†è®ºä¸Šé™ï¼Œå³ç†è®ºä¸Šä¸€æ¯«ç§’å†…ä¸ä¼šæœ‰è¶…è¿‡ 4096 æ¬¡çš„è¯·æ±‚ã€‚&lt;/p>
&lt;h2 id="é›ªèŠ±ç®—æ³•çš„æ—¶é—´å›æ‹¨é—®é¢˜">é›ªèŠ±ç®—æ³•çš„æ—¶é—´å›æ‹¨é—®é¢˜&lt;/h2>
&lt;p>æ—¶é—´å›æ‹¨é—®é¢˜æ˜¯æŒ‡ç³»ç»Ÿåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ç”±äºç½‘ç»œæ—¶é—´æ ¡å‡†æˆ–è€…äººå·¥è®¾ç½®ï¼Œå¯¼è‡´ç³»ç»Ÿæ—¶é—´ä¸»åŠ¨æˆ–è¢«åŠ¨åœ°è·³å›åˆ°è¿‡å»çš„æŸä¸ªæ—¶é—´ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/snowflake/time-back.png" alt="æ—¶é—´å›æ‹¨">
&lt;figcaption>æ—¶é—´å›æ‹¨&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>ç”±äºé›ªèŠ±ç®—æ³•é‡åº¦ä¾èµ–æœºå™¨çš„å½“å‰æ—¶é—´ï¼Œæ‰€ä»¥ä¸€æ—¦å‘ç”Ÿæ—¶é—´å›æ‹¨ï¼Œå°†æœ‰å¯èƒ½å¯¼è‡´ç”Ÿæˆçš„ ID å¯èƒ½ä¸æ­¤å‰å·²ç»ç”Ÿæˆçš„æŸä¸ª ID é‡å¤ï¼ˆ&lt;strong>å‰ææ˜¯åˆšå¥½åœ¨åŒä¸€æ¯«ç§’ç”Ÿæˆ ID æ—¶åºåˆ—å·ä¹Ÿåˆšå¥½ä¸€è‡´&lt;/strong>ï¼‰ï¼Œè¿™å°±æ˜¯é›ªèŠ±ç®—æ³•æœ€ç»å¸¸è®¨è®ºçš„é—®é¢˜â€”â€”æ—¶é—´å›æ‹¨ã€‚åœ¨é›ªèŠ±ç®—æ³•åŸæœ¬çš„å®ç°ä¸­ï¼Œé’ˆå¯¹è¿™ç§é—®é¢˜ï¼Œç®—æ³•æœ¬èº«åªæ˜¯è¿”å›é”™è¯¯ï¼Œç”±åº”ç”¨å¦è¡Œå†³å®šå¤„ç†é€»è¾‘ï¼Œå¦‚æœæ˜¯åœ¨ä¸€ä¸ªå¹¶å‘ä¸é«˜æˆ–è€…è¯·æ±‚é‡ä¸å¤§çš„ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œé”™è¯¯ç­‰å¾…æˆ–è€…é‡è¯•çš„ç­–ç•¥é—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯å¦‚æœæ˜¯åœ¨ä¸€ä¸ªé«˜å¹¶å‘çš„ç³»ç»Ÿä¸­ï¼Œè¿™ç§ç­–ç•¥æ˜¾å¾—è¿‡äºç²—æš´ã€‚&lt;/p>
&lt;h2 id="è§£å†³é›ªèŠ±ç®—æ³•çš„æ—¶é—´å›æ‹¨é—®é¢˜çš„ä¸€ç§æ€è·¯å¤šæ—¶é’Ÿ">è§£å†³é›ªèŠ±ç®—æ³•çš„æ—¶é—´å›æ‹¨é—®é¢˜çš„ä¸€ç§æ€è·¯â€”â€”å¤šæ—¶é’Ÿ&lt;/h2>
&lt;p>ç½‘ä¸Šæœ‰å¾ˆå¤šå¯¹äºè§£å†³é›ªèŠ±ç®—æ³•çš„æ—¶é—´å›æ‹¨é—®é¢˜çš„æ€è·¯å’Œè®¨è®ºï¼Œæˆ‘è¿™é‡Œä»‹ç»çš„æ˜¯ä¸€ç§åŸºäºæ‰©å±•ä½çš„æ€è·¯ï¼Œä½†æ˜¯ä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘è‡ªå·±å–åä¸ºå¤šæ—¶é’Ÿçš„é›ªèŠ±ç®—æ³•ã€‚&lt;/p>
&lt;p>ç®—æ³•çš„æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ—¢ç„¶æ—¶é—´å›æ‹¨é—®é¢˜çš„æœ¬è´¨ä¸Šæ˜¯æ—¶é—´å›åˆ°äº†â€œè¿‡å»â€ï¼Œé‚£ä¹ˆå“ªæ€•å›åˆ°äº†è¿‡å»ï¼Œåªè¦å®ç°â€œæ­¤æ—¶é—´éå½¼æ—¶é—´â€ä¸å°±å®ç°æ—¶é—´å”¯ä¸€äº†ï¼Ÿé¡ºç€è¿™ä¸ªæ€è·¯æƒ³çš„è¯ï¼Œä¸€ç§ç›´è§‚çš„æ€è·¯æ˜¯ï¼š&lt;strong>æ—¢ç„¶æˆ‘å·²ç»å‘ç°äº†æ—¶é—´å›æ‹¨ï¼Œé‚£æˆ‘å°±è®¤ä¸ºåŸå…ˆçš„â€œæ—¶é’Ÿâ€å·²ç»ä¸å¯ç”¨ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„â€œæ—¶é’Ÿâ€å³å¯&lt;/strong>ï¼Œå¹¶å°†æ–°çš„å½“å‰æ—¶é—´è®¤ä¸ºæ˜¯æ–°æ—¶é’Ÿçš„æ—¶é—´ã€‚&lt;/p>
&lt;h3 id="ç®—æ³•æè¿°">ç®—æ³•æè¿°&lt;/h3>
&lt;p>ç±»ä¼¼ç»å…¸çš„é›ªèŠ±ç®—æ³•ï¼ŒåŸºäºå¤šæ—¶é’Ÿæ”¹è¿›çš„é›ªèŠ±ç®—æ³•éœ€è¦å ç”¨å°‘é‡çš„ä½ç”¨äºå­˜å‚¨æ—¶é’Ÿ IDï¼Œæ‰€éœ€çš„ä½æ•°åªèƒ½ä»åŸæœ‰çš„æ—¶é—´æˆ³ã€æœºå™¨IDæˆ–è€…åºåˆ—å·ä¸­åˆ†å‰²ï¼Œå…·ä½“ä¸šåŠ¡å®ç°ä¸­éœ€è¦ç»“åˆä¸šåŠ¡çš„å¹¶å‘é‡ã€é›†ç¾¤è§„æ¨¡ç­‰ç»¼åˆè€ƒè™‘ï¼Œè¿™é‡Œä¸ºäº†è®¨è®ºæ–¹ä¾¿ï¼Œå‡è®¾ä»æœºå™¨ ID ä»¥åŠåºåˆ—å·ä¸­å„å– 2 ä½ï¼Œç”¨äº 1 ä¸ª 4 ä½çš„æ—¶é’Ÿ IDï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span> 0 1010......101 0001 10101010 1010101010
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">\&lt;/span>_/ &lt;span style="">\&lt;/span>___________/ &lt;span style="">\&lt;/span>__/ &lt;span style="">\&lt;/span>______/ &lt;span style="">\&lt;/span>________/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ç¬¬1ä½ä¸ä½¿ç”¨ 41ä½æ¯«ç§’æ—¶é—´æˆ³ 4ä½æ—¶é’ŸID 8ä½æœºå™¨ID 10ä½åºåˆ—å·
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>äºæ˜¯ï¼Œæ–°çš„ç®—æ³•ç†è®ºä¸Šï¼š&lt;/p>
&lt;ul>
&lt;li>è¿˜æ˜¯æ”¯æŒæœ€é•¿ 69 å¹´å¤šçš„è¿è¡Œæ—¶é—´ï¼›&lt;/li>
&lt;li>åˆ†å¸ƒå¼å®ä¾‹è§„æ¨¡ç¼©å°åˆ° 256ï¼›&lt;/li>
&lt;li>å•å®ä¾‹æ¯æ¯«ç§’æ”¯æŒæœ€å¤š 1024 æ¬¡è¯·æ±‚ï¼›&lt;/li>
&lt;li>å•å®ä¾‹æ”¯æŒæœ€å¤š 16 æ¬¡å›æ‹¨åŒä¸€æ—¶é—´èŒƒå›´ï¼ˆå¦‚æœæ—¶é—´å›æ‹¨å‘ç”Ÿåœ¨äº’ä¸äº¤å çš„æ—¶é—´æ®µï¼Œåˆ™ç†è®ºä¸Šå¯ä»¥å®Œç¾è§£å†³æ—¶é—´å›æ‹¨é—®é¢˜ï¼‰ï¼›&lt;/li>
&lt;/ul>
&lt;p>åœ¨å…·ä½“çš„å®ç°é€»è¾‘ä¸Šï¼Œä¸»è¦æ˜¯åœ¨æ¯æ¬¡å‘ç°æ—¶é—´å›æ‹¨ï¼ˆå³ä¹‹å‰æœ€åä¸€æ¬¡ç”Ÿæˆ ID çš„æ—¶é—´æˆ³å¤§äºç­‰äºå½“å‰æ—¶é—´æˆ³ï¼‰çš„æ—¶å€™ï¼Œä¾¿å°†æ—¶é’Ÿ ID åŠ  1ï¼Œç±»ä¼¼åºåˆ—å·ï¼Œå‘¨è€Œå¤å§‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>timeNow := å½“å‰ç³»ç»Ÿæ—¶é—´
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">if&lt;/span> last_time &amp;gt;= timeNow: &lt;span style="font-style:italic">// æ—¶é’Ÿå›æ‹¨
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> clock_id = (clock_id + 1) &amp;amp; (1&amp;lt;&amp;lt;4-1)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>last_time = timeNow
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>seq := ä¸‹ä¸€ä¸ªåºåˆ—å·
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">return&lt;/span> encode(timeNow, machineID, seq, clock_id)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åœºæ™¯åˆ†æ">åœºæ™¯åˆ†æ&lt;/h3>
&lt;p>è¿˜æ˜¯ä¸Šé¢å›¾ç‰‡ä¸­çš„ä¾‹å­ï¼Œå‡å¦‚åœ¨æŸä¸€æ—¶åˆ»ï¼Œç³»ç»Ÿç”Ÿæˆ IDï¼Œæ­¤æ—¶æ—¶é—´ä¸º 10:15:00ï¼Œä¹‹åç³»ç»Ÿç»å† 5 ç§’åï¼Œåœ¨å¦ä¸€æ—¶åˆ» 10:15:05ï¼Œç³»ç»Ÿå†æ¬¡ç”Ÿæˆ IDï¼Œåœ¨è¿™æ®µæ—¶é—´é‡Œï¼Œç³»ç»Ÿä¸€ç›´ä½¿ç”¨çš„æ—¶é’Ÿä¸º &lt;code>1&lt;/code>ã€‚åœ¨ä¸‹ä¸€æ¬¡ç”Ÿæˆ ID æ—¶ï¼Œç³»ç»Ÿå‘ç° &lt;code>lastTime&lt;/code> ä¸º &lt;code>10:15:05&lt;/code>ï¼Œè€Œç³»ç»ŸæŸ¥è¯¢æœºå™¨å½“å‰æ—¶é—´ä¸º &lt;code>10:15:00&lt;/code>ï¼Œåˆ¤å®šæ—¶é—´å›æ‹¨ï¼Œäºæ˜¯åˆ‡æ¢æ—¶é’Ÿä¸º &lt;code>2&lt;/code>ï¼Œæ­¤æ—¶ç”Ÿæˆçš„ ID å³ä¼šå¯¹åº”äº 2 å·æ—¶é’Ÿçš„ &lt;code>10:15:00&lt;/code>ï¼Œä¸æ­¤å‰æ—¶é’Ÿ 1 çš„ &lt;code>10:15:00&lt;/code> åœ¨é€»è¾‘ä¸Šå·²ç»æ˜¯ä¸¤ä¸ªä¸åŒçš„æ—¶é—´ï¼Œäºæ˜¯ç”Ÿæˆçš„ ID è‡ªç„¶ä¸åŒã€‚&lt;/p>
&lt;h3 id="æç«¯åœºæ™¯è¿›ç¨‹é‡å¯æ—¶é—´å›æ‹¨">æç«¯åœºæ™¯ï¼šè¿›ç¨‹é‡å¯+æ—¶é—´å›æ‹¨&lt;/h3>
&lt;p>ä¸Šé¢çš„ç®—æ³•ï¼Œèƒ½å¤Ÿå¾ˆå¥½åº”å¯¹è¿è¡Œè¿‡ç¨‹ä¸­çš„æ—¶é—´å›æ‹¨é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœéå¸¸ä¸å·§ï¼Œåœ¨è¿›ç¨‹åˆšå¥½é‡åˆ°å´©æºƒé‡å¯çš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿåˆæ­£å¥½å®Œæˆäº†æ—¶é—´å›æ‹¨ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¦‚ä½•ä¿è¯ä¸ä¼šå› ä¸ºä½¿ç”¨äº†ç›¸åŒçš„æ—¶é’Ÿè€Œå¯èƒ½äº§ç”Ÿä¸€æ ·çš„ ID å‘¢ï¼Ÿä¸€ç§ç»§ç»­æ”¹è¿›çš„æ€è·¯æ˜¯åœ¨ ID ç”Ÿæˆå™¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°è¯•ä»æœ¬åœ°ç£ç›˜æ–‡ä»¶ä¸­è·å–é‡å¯å‰çš„æ—¶é’Ÿ IDï¼Œå¹¶ä¸”åŠ  1ï¼Œæ„å‘³ç€æ¯æ¬¡é‡å¯ä¸€å®šä¸ä¼šä½¿ç”¨è¿›ç¨‹é€€å‡ºå‰çš„æ—¶é’Ÿï¼Œè€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡åˆ‡æ¢äº†æ—¶é’Ÿä¹‹åï¼Œéƒ½åº”è¯¥æŠŠæ–°çš„æ—¶é’Ÿ ID å†™å…¥ç£ç›˜ï¼Œè€ƒè™‘åˆ°æ€§èƒ½å‹å¥½ï¼Œè¿™ä¸ªæ“ä½œå°½å¯èƒ½å¼‚æ­¥å®Œæˆã€‚&lt;/p>
&lt;h3 id="é«˜å¹¶å‘ä¼˜åŒ–æ€è·¯æ—¶é’Ÿ-id-å¤ç”¨">é«˜å¹¶å‘ä¼˜åŒ–æ€è·¯ï¼šæ—¶é’Ÿ ID å¤ç”¨&lt;/h3>
&lt;p>è¿™ä¸ªåŸºäºå¤šæ—¶é’Ÿçš„ä¼˜åŒ–ç®—æ³•ï¼Œç”±äºéœ€è¦é¢å¤–çš„æ¯”ç‰¹ä½æ¥å­˜å‚¨æ—¶é’Ÿ IDï¼Œè€Œå ç”¨äº†ç”¨äºæ§åˆ¶å¹¶å‘çš„åºåˆ—å·çš„æ¯”ç‰¹ä½ï¼Œå‡å¦‚ç³»ç»Ÿç¡®å®æœ‰è¾ƒé«˜çš„å¹¶å‘ï¼Œè¿™é‡Œå¯ä»¥è€ƒè™‘çš„ä¼˜åŒ–æ˜¯å¤ç”¨æ—¶é’Ÿ IDï¼šæ¯æ¬¡åœ¨å½“å‰æ—¶é’Ÿä¸‹ï¼Œ&lt;strong>ä¸€æ—¦å½“å‰åºåˆ—å·è¾¾åˆ°ä¸Šé™é‡ç½®æ—¶ï¼Œéƒ½åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ—¶é’Ÿ&lt;/strong>ï¼Œè¿™æ ·çš„è¯ï¼Œç†è®ºä¸ŠåŒä¸€æ¯«ç§’é‡Œï¼Œå¹¶å‘è§„æ¨¡å¯ä»¥è¾¾åˆ° 2^14ï¼Œä¹Ÿå³æ˜¯ &lt;code>16384&lt;/code>ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ—¶é’Ÿå›æ‹¨åº”è¯¥æ˜¯ä¸ªæå°‘å‘ç”Ÿçš„ç°è±¡ï¼Œè¿™ç§å¤ç”¨æ—¶é’Ÿ ID çš„æ–¹æ³•ï¼Œèƒ½å¤Ÿæ›´å……åˆ†åœ°åˆ©ç”¨å¥½æ—¶é’Ÿ ID çš„ 4 ä¸ªæ¯”ç‰¹ä½ã€‚&lt;/p>
&lt;h2 id="å¤šæ—¶é’Ÿé›ªèŠ±ç®—æ³•çš„ä¸€äº›é—®é¢˜">å¤šæ—¶é’Ÿé›ªèŠ±ç®—æ³•çš„ä¸€äº›é—®é¢˜&lt;/h2>
&lt;p>å½“ç„¶ï¼Œè¿™ä¸ªç®—æ³•å¹¶ä¸å®Œç¾çš„ï¼Œå®ƒåŸºäºä¸€äº›å‡è®¾ï¼ŒåŒæ—¶ä½¿ç”¨å‰éœ€è¦è®¤çœŸè€ƒè™‘ä¸€äº›å®ƒä»æ— æ³•é¿å…çš„é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>æ—¶é—´å›æ‹¨ä¸ä¼šé¢‘ç¹å‘ç”Ÿåœ¨åŒä¸€ä¸ªæ—¶é—´æ®µï¼ˆåœ¨ä¸Šé¢ä¸¾ä¾‹ä¸­ï¼Œæ—¶é—´å›æ‹¨ä¸ä¼šåœ¨åŒä¸€æ—¶é—´æ®µä¸Šé‡å¤å‘ç”Ÿè¶…è¿‡ 16 æ¬¡ï¼‰ï¼›&lt;/li>
&lt;li>é€’å¢é—®é¢˜ï¼šå½“æ—¶é—´å›æ‹¨æ—¶ï¼ŒID é€’å¢æ€§ä¼šè¢«ç ´åï¼Œå¯¹äºéœ€è¦ä¸¥æ ¼é€’å¢çš„åœºæ™¯ï¼Œéœ€è¦è€ƒè™‘å…¶ä»–è§£å†³æ–¹æ¡ˆï¼Œæ¯”å¦‚åŸºäºâ€œå†å²æ—¶é—´â€çš„æ”¹è¿›ç®—æ³•ï¼›&lt;/li>
&lt;li>æœºå™¨IDå’Œåºåˆ—å·ç©ºé—´çš„è¯„ä¼°ï¼šå¦‚ä½•ä¿è¯è·å¾—å…¨å±€å”¯ä¸€çš„æœºå™¨ IDï¼Œä¹Ÿæ˜¯ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼Œå¦å¤–æ—¶é’Ÿ ID çš„å¼•å…¥ï¼Œä¼šå ç”¨é¢å¤–çš„æ¯”ç‰¹ä½ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘ä»å“ªäº›æ¯”ç‰¹ç‰‡æ®µä¸­è…¾å‡ºè¿™äº›éœ€è¦ç•™ç»™æ—¶é’Ÿ ID çš„æ¯”ç‰¹ä½ï¼›&lt;/li>
&lt;li>å¤šæ—¶é’Ÿé›ªèŠ±ç®—æ³•åªæ˜¯ç¼“è§£äº†æ—¶é’Ÿå›æ‹¨é—®é¢˜ï¼Œä½†æ˜¯ä¸èƒ½å®Œå…¨è§£å†³æ—¶é—´å›æ‹¨é—®é¢˜ï¼Œæ‰€ä»¥ä»ç„¶éœ€è¦è€ƒè™‘ä¸€ç§æç«¯æƒ…å†µä¸‹çš„å®¹é”™æ–¹æ¡ˆï¼Œä¸è¿‡æ—¢ç„¶æ˜¯æç«¯åœºæ™¯ï¼Œé‡‡ç”¨ç±»ä¼¼é”™è¯¯é‡è¯•ä¹‹ç±»çš„ç®€å•æ–¹æ¡ˆè¶³çŸ£ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="è§£å†³é›ªèŠ±ç®—æ³•æ—¶é—´å›æ‹¨é—®é¢˜çš„å…¶ä»–æ€è·¯">è§£å†³é›ªèŠ±ç®—æ³•æ—¶é—´å›æ‹¨é—®é¢˜çš„å…¶ä»–æ€è·¯&lt;/h2>
&lt;ul>
&lt;li>é‡‡ç”¨å†å²æ—¶é—´ï¼šè¯¦è§ &lt;a href="https://cloud.tencent.com/developer/news/678423">å½»åº•è§£å†³é›ªèŠ±ç®—æ³•æ—¶é—´å›æ‹¨é—®é¢˜æ–°æ–¹æ¡ˆ&lt;/a>&lt;/li>
&lt;li>ç­‰å¾…æ—¶é’Ÿæ ¡æ­£&lt;/li>
&lt;li>æ—¶é—´è¿½èµ¶&lt;/li>
&lt;li>é”™è¯¯é‡è¯•&lt;/li>
&lt;/ul>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;ul>
&lt;li>é€šè¿‡å¼•å…¥å¤šæ—¶é’Ÿæ¥å®ç°æ—¶é—´å›æ‹¨åœºæ™¯ä¸‹çš„æ—¶é—´å”¯ä¸€æ€§ï¼Œç†æƒ³åœºæ™¯ä¸‹å¯æ— é™æ¬¡åº”å¯¹æ—¶é—´å›æ‹¨&lt;/li>
&lt;li>å¤šæ—¶é’Ÿé›ªèŠ±ç®—æ³•å¯ä»¥é€šè¿‡å¤ç”¨æ—¶é’ŸIDæ¥ä¼˜åŒ–æ¯”ç‰¹ä½çš„åˆ©ç”¨æ•ˆç‡&lt;/li>
&lt;li>å¤šæ—¶é’Ÿé›ªèŠ±ç®—æ³•ä¹Ÿéœ€è¦ç»“åˆå…¶ä»–å®¹é”™å¤„ç†æ¥åº”å¯¹æç«¯åœºæ™¯ä¸‹çš„æ—¶é—´å›æ‹¨é—®é¢˜&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://cloud.tencent.com/developer/news/678423">å½»åº•è§£å†³é›ªèŠ±ç®—æ³•æ—¶é—´å›æ‹¨é—®é¢˜æ–°æ–¹æ¡ˆ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cloud.tencent.com/developer/article/1772047">åˆ†å¸ƒå¼å”¯ä¸€IDè§£å†³æ–¹æ¡ˆ-é›ªèŠ±ç®—æ³•&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æ•°æ®åº“æ•°æ®åŠ å¯†çš„ 4 ç§å¸¸è§æ€è·¯çš„å¯¹æ¯”</title><link>https://blog.hackerpie.com/posts/architecture/data-encrpytion/</link><pubDate>Sun, 20 Mar 2022 13:53:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/architecture/data-encrpytion/</guid><description>&lt;p>æœ€è¿‘ç”±äºå·¥ä½œéœ€è¦ï¼Œæˆ‘å¯¹æ¬§æ´²çš„é€šç”¨æ•°æ®ä¿æŠ¤æ¡ä¾‹åšäº†è°ƒç ”å’Œå­¦ä¹ ï¼Œå…¶ä¸­æœ‰éå¸¸é‡è¦çš„ä¸€ç‚¹ï¼Œä¹Ÿæ˜¯å¸¸è¯†æ€§çš„ä¸€æ¡ï¼Œå°±æ˜¯éœ€è¦å¯¹ç”¨æˆ·çš„ä¸ªäººéšç§æ•°æ®åšå¥½åŠ å¯†å­˜å‚¨ï¼Œé¿å…ç”¨æˆ·éšç§æ˜æ–‡æ•°æ®æ³„éœ²ã€‚&lt;/p>
&lt;h1 id="æ–¹æ¡ˆåˆ†æ">æ–¹æ¡ˆåˆ†æ&lt;/h1>
&lt;p>æ€è€ƒå¦‚ä½•å¯¹ç”¨æˆ·éšç§æ•°æ®åšå¥½åŠ å¯†å¤„ç†ï¼Œå¯ä»¥å…ˆä»åˆ†æå…¸å‹çš„æ•°æ®è¯»å†™é“¾è·¯å¼€å§‹ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code> _________ query _________ read _________
| | ----------------&amp;gt; | | ----------------&amp;gt; | |
| åº”ç”¨ | | DB | | Disk |
| | &amp;lt;================ | | &amp;lt;================ | |
--------- rows --------- data page ---------
&lt;/code>&lt;/pre>&lt;p>æŒ‰ç…§æ­¤é“¾è·¯åˆ†æï¼Œå¯ä»¥æŒ‰ç…§æ•°æ®åŠ å¯†çš„ç€æ‰‹ç‚¹ï¼Œåˆ’åˆ†æ•°æ®åŠ å¯†çš„ 4 ç±»è§£å†³æ–¹æ¡ˆï¼š&lt;/p>
&lt;ul>
&lt;li>åº”ç”¨å±‚åŠ è§£å¯†ï¼šç”±åº”ç”¨ç¨‹åºè‡ªè¡Œè´Ÿè´£æ•°æ®çš„åŠ è§£å¯†ï¼Œè¿™æ˜¯æœ€è‡ªç”±ï¼Œä½†ä¹Ÿæ˜¯æœ€ç¹ççš„ä¸€ç§æ–¹æ¡ˆï¼›&lt;/li>
&lt;li>DB å‰ç½®å¤„ç†ï¼šåœ¨æ•°æ®åº“æœåŠ¡å™¨å¼€å§‹æœåŠ¡ä¹‹å‰åµŒå…¥åŠ å¯†é€»è¾‘ï¼Œå…¸å‹ä»£è¡¨æ˜¯æ•°æ®åº“ä»£ç†æœåŠ¡ï¼›&lt;/li>
&lt;li>ç£ç›˜å­˜å–ç¯èŠ‚ï¼šè¿™ç§æ–¹æ¡ˆçš„åŸºæœ¬æ€è·¯åˆ™æ˜¯ç»•åˆ°æ•°æ®åº“çš„èº«åï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ³¨å…¥é’©å­è¿›ç¨‹ï¼Œè¿™æ ·å¯ä»¥åœ¨ç£ç›˜æ•°æ®è¯»å†™ä¹‹å‰åµŒå…¥åŠ å¯†é€»è¾‘ï¼Œä¸€èˆ¬&lt;/li>
&lt;li>DB åç½®å¤„ç†ï¼šåœ¨æ•°æ®åº“æœåŠ¡ä¹‹ååµŒå…¥åŠ å¯†é€»è¾‘ï¼Œä¾èµ–æ•°æ®åº“æä¾›çš„è§¦å‘å™¨ä»¥åŠå‡½æ•°å®šåˆ¶åŠŸèƒ½ç­‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸‹é¢å°±è¿™å‡ ç±»æ–¹æ¡ˆå±•å¼€åˆ†æã€‚&lt;/p>
&lt;h2 id="åº”ç”¨å±‚åŠ è§£å¯†æ–¹æ¡ˆ">åº”ç”¨å±‚åŠ è§£å¯†æ–¹æ¡ˆ&lt;/h2>
&lt;p>é‡‡ç”¨è¿™ç§æ–¹æ¡ˆçš„è¯ï¼Œæ•°æ®åŠ è§£å¯†å¯¹æ•°æ®åº“æ— æ„ŸçŸ¥ï¼Œç”±åº”ç”¨åœ¨å­˜å…¥æ•°æ®å‰å®ŒæˆåŠ å¯†ï¼Œåœ¨è¯»å–æ•°æ®åå®Œæˆè§£å¯†ã€‚è¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>è¿ç§»æ€§å¥½ï¼šå› ä¸ºä¸ä¾èµ–ä»»ä½•æ•°æ®åº“ç‰¹æ€§æˆ–è€…æ“ä½œç³»ç»Ÿç‰¹æ€§ï¼Œåªéœ€è¦éƒ¨ç½²ä»£ç å³å¯è¿è¡Œï¼›&lt;/li>
&lt;li>å®ç°çµæ´»ï¼šé€»è¾‘æ”¾åœ¨åº”ç”¨å±‚ï¼Œå„ç§å®šåˆ¶æˆ–è€…æ‰©å±•éƒ½éå¸¸æ–¹ä¾¿è¿›è¡Œï¼Œå¯ä»¥è½»æ¾å®ç°æŒ‰è¡¨/æŒ‰åˆ—çš„åŠ å¯†å­˜å‚¨ã€‚&lt;/li>
&lt;/ul>
&lt;p>å½“æ—¶ï¼Œç¼ºç‚¹ä¹Ÿéå¸¸æ˜æ˜¾ï¼š&lt;/p>
&lt;ul>
&lt;li>å½±å“ä½¿ç”¨æ•°æ®åº“é«˜çº§ç‰¹æ€§ï¼šæ¯”å¦‚æ•°æ®åº“ç´¢å¼•ä»¥åŠæ‰§è¡Œè®¡åˆ’ç­‰;&lt;/li>
&lt;li>å¤§å¹…å½±å“æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½ï¼šæ¯”å¦‚ Like çš„å‰ç¼€æŸ¥è¯¢ä»¥åŠ Where çš„èŒƒå›´æŸ¥è¯¢ç­‰ï¼Œéƒ½ä¼šå› ä¸ºæ•°æ®åŠ å¯†åè€Œåªèƒ½å…¨è¡¨æ‰«æï¼›&lt;/li>
&lt;li>å¼€å‘ç»´æŠ¤æˆæœ¬é«˜ï¼šæ¯æ¬¡æ–°å¢éœ€è¦åŠ è§£å¯†æ•°æ®æ—¶éƒ½éœ€è¦å¯¹åº”å®Œæˆå¼€å‘è°ƒè¯•ä¸æµ‹è¯•ï¼Œå¼€å‘äººå‘˜åœ¨åº”ç”¨é‡Œæ—¢è¦å…³æ³¨æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œè¿˜è¦å…³æ³¨å¤§é‡çš„æ•°æ®åŠ è§£å¯†çš„é€»è¾‘ï¼Œå½“æœ‰å¤šä¸ªåº”ç”¨æˆ–è€…ç³»ç»Ÿéœ€è¦é›†æˆåŠ è§£å¯†åŠŸèƒ½æ—¶ï¼Œæ¯ä¸ªåº”ç”¨æˆ–è€…ç³»ç»Ÿéƒ½éœ€è¦é‡å¤å»ºè®¾æ­¤èƒ½åŠ›ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨åº”ç”¨å±‚å®ç°åŠ è§£å¯†æ–¹æ¡ˆçš„è¯ï¼Œå®ç°ä¸Šå¯ä»¥è€ƒè™‘ç»“åˆå„ç±» orm çš„å›è°ƒå‡½æ•°æœºåˆ¶ï¼Œå¦‚ golang ä¸­æµè¡Œçš„ ORM æ¡†æ¶ gorm æ‰€æä¾›çš„ Callbacks æœºåˆ¶ï¼Œåˆæˆ–è€…æ˜¯ Ruby on Rails æ¡†æ¶ä¸­ Active Record çš„ Callbacks æœºåˆ¶ï¼Œè¿™äº›æœºåˆ¶éƒ½èƒ½æœ‰æ•ˆå¸®åŠ©æˆ‘ä»¬å°†ä¸šåŠ¡ä»£ç å’Œæ§åˆ¶ä»£ç è¿›è¡Œç›¸äº’éš”ç¦»ã€‚&lt;/p>
&lt;h2 id="æ•°æ®åº“å‰ç½®å¤„ç†æ–¹æ¡ˆ">æ•°æ®åº“å‰ç½®å¤„ç†æ–¹æ¡ˆ&lt;/h2>
&lt;p>é‡‡ç”¨æ•°æ®åº“å‰ç½®å¤„ç†æ–¹æ¡ˆï¼Œç®—æ˜¯å¯¹åº”ç”¨å±‚åŠ è§£å¯†æ–¹æ¡ˆçš„ä¼˜åŒ–ï¼Œæœ¬è´¨æ€æƒ³æ˜¯å°†åŠ è§£å¯†çš„å…³æ³¨ç‚¹ç‹¬ç«‹ï¼Œä»åº”ç”¨å†…éƒ¨å®Œå…¨æŠ½ç¦»ï¼Œç‹¬ç«‹æœåŠ¡ï¼ŒåŒæ—¶å®ç°åŠ è§£å¯†é€»è¾‘çš„å¤ç”¨æ€§ã€‚&lt;/p>
&lt;p>ä½¿ç”¨æ•°æ®åº“å‰ç½®å¤„ç†ï¼Œèƒ½å¤Ÿé›†æˆåº”ç”¨å±‚åŠ å¯†æ–¹æ¡ˆçš„ä¸€äº›ä¼˜ç‚¹ï¼ŒåŒæ—¶è§£å†³äº†åè€…å­˜åœ¨çš„ä¸€äº›é—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>çµæ´»æ€§ï¼šæ•°æ®åº“ä»£ç†åŒæ ·å…·å¤‡è¾ƒå¥½çš„çµæ´»æ€§ï¼Œå¯ä»¥å®ç°åˆ—çº§çš„åŠ è§£å¯†ï¼›&lt;/li>
&lt;li>å¤ç”¨æ€§è¾ƒå¥½ï¼šå¤šä¸ªåº”ç”¨æˆ–è€…ç³»ç»Ÿä¸å†éœ€è¦é‡å¤å»ºè®¾ï¼Œä½¿ç”¨ç‹¬ç«‹ç»´æŠ¤æœåŠ¡çš„æ•°æ®åº“ä»£ç†ï¼Œèƒ½å¤Ÿå®ç°å¿«é€Ÿçš„åŠ è§£å¯†åŠŸèƒ½çš„æ¥å…¥ï¼›&lt;/li>
&lt;li>è¾ƒé«˜çš„é€æ˜åº¦ï¼šåº”ç”¨å¼€å‘äººå‘˜æ— éœ€åœ¨è‡ªèº«å†…éƒ¨å…³æ³¨åŠ è§£å¯†é€»è¾‘ï¼Œä½†æ˜¯ç”±äºæ•°æ®åº“ä»£ç†çš„ SQL å…¼å®¹æ€§ä¸‹é™ï¼Œåº”ç”¨å¼€å‘è¿‡ç¨‹ä¸­ä¸å¾—ä¸ä¿æŒå¯¹ SQL å…¼å®¹æ€§çš„ç†è§£ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ•°æ®åº“å‰ç½®å¤„ç†æ–¹æ¡ˆä¹Ÿæœ‰è‡ªèº«çš„ä¸€äº›ç¼ºé™·ï¼š&lt;/p>
&lt;ol>
&lt;li>ç¨³å®šæ€§ä¸‹é™ï¼ŒåŠ å¤§è¿ç»´è´Ÿæ‹…ï¼šå› ä¸ºæ•´ä½“æ¶æ„å¼•å…¥äº†é¢å¤–çš„æœåŠ¡èŠ‚ç‚¹ï¼Œä¼šç»™æ•´ä½“çš„æœåŠ¡æˆæœ¬ä»¥åŠé—®é¢˜æ’éšœåœºæ™¯å¢åŠ è´Ÿæ‹…ï¼Œåœ¨é‡åˆ°æ•°æ®å¤„ç†é—®é¢˜æ—¶ï¼Œéœ€è¦å·å…¥æ•°æ®åº“ä»£ç†æœåŠ¡çš„ç»´æŠ¤äººå‘˜ä¸€èµ·æ’æŸ¥æ•…éšœï¼›&lt;/li>
&lt;li>æ— æ³•åˆ©ç”¨æ•°æ®åº“é«˜çº§ç‰¹æ€§ï¼šå’Œåº”ç”¨å±‚æ•°æ®åŠ è§£å¯†æ–¹æ¡ˆç±»ä¼¼ï¼Œæ­¤æ–¹æ¡ˆä¸‹ï¼Œç”±äºæ•°æ®åŠ å¯†åç»ç”±æ•°æ®åº“å­˜å‚¨å’Œç´¢å¼•ï¼Œåœ¨æŸ¥è¯¢åœºæ™¯ä¸­ï¼Œæ¶‰åŠèŒƒå›´ç±»å‹çš„æ•°æ®æ£€ç´¢éƒ½ä¼šå¯¼è‡´æ‰«è¡¨ï¼›&lt;/li>
&lt;li>ä¸€è‡´æ€§é—®é¢˜ï¼šç”±äºéœ€è¦åœ¨æ•°æ®åº“ä»£ç†ä¸­ç»´æŠ¤ä¸šåŠ¡æ•°æ®è¡¨/æˆ–åˆ—çš„å…ƒä¿¡æ¯ï¼Œå¼•å…¥äº†ä»£ç†å±‚çš„é…ç½®ä¿¡æ¯å’Œä¸šåŠ¡æ•°æ®åº“è®¾è®¡çš„ä¸€è‡´æ€§é—®é¢˜ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="ç£ç›˜å­˜å–ç¯èŠ‚é€æ˜æ•°æ®åŠ å¯†">ç£ç›˜å­˜å–ç¯èŠ‚ï¼šé€æ˜æ•°æ®åŠ å¯†&lt;/h2>
&lt;p>ç›®å‰å„å®¶äº‘æœåŠ¡å‚å•†åŸºæœ¬éƒ½æä¾›äº†è¿™ä¸ªæ–¹æ¡ˆçš„æœåŠ¡ï¼Œç®€ç§°é€æ˜æ•°æ®åŠ å¯†ï¼ˆTDEï¼‰ã€‚è¿™ä¸ªæ–¹æ¡ˆçš„å®ç°åŸç†æ¯”è¾ƒå·§å¦™ï¼Œå®ƒå·¥ä½œäºæ“ä½œç³»ç»Ÿå±‚é¢ï¼Œä½œç”¨äºæ•°æ®åº“æ•°æ®æ–‡ä»¶ï¼Œé€šè¿‡ i/o çš„é’©å­è¿›ç¨‹ï¼Œåœ¨æ•°æ®åº“å­˜å‚¨å¼•æ“è¯»å†™æ•°æ®åˆ°æ–‡ä»¶ç³»ç»Ÿçš„æ—¶å€™åµŒå…¥åŠ è§£å¯†é€»è¾‘ï¼Œåœ¨å†™å…¥æ•°æ®å‰å®ŒæˆåŠ å¯†ï¼Œè€Œåœ¨æ•°æ®è¯»å–åè¦è¿”å›ç»™å­˜å‚¨å¼•æ“è¿›ç¨‹ä¹‹å‰æ‰§è¡Œè§£å¯†ï¼Œè€Œæ•´ä¸ªè¿‡ç¨‹å¯¹æ•°æ®åº“å­˜å‚¨å¼•æ“æ˜¯å®Œå…¨é€æ˜çš„ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜ç‚¹è¯±äººå¾—å¤šï¼š&lt;/p>
&lt;ul>
&lt;li>é€æ˜æ€§ï¼šå› ä¸ºæ–¹æ¡ˆåœ¨æ•°æ®åº“æœåŠ¡å™¨ä¸Šå‘æŒ¥ä½œç”¨ï¼Œæ‰€ä»¥å¯¹åº”ç”¨å®Œå…¨é€æ˜ï¼Œåº”ç”¨ä»æ—§ç›´è¿æ•°æ®åº“ï¼Œè€Œä¸”å®Œå…¨ä¸ç”¨æ‹…å¿ƒ SQL å…¼å®¹æ€§é—®é¢˜ç­‰ï¼›&lt;/li>
&lt;li>æ”¯æŒæ‰€æœ‰æ•°æ®åº“é«˜çº§ç‰¹æ€§ï¼šç”±äºè¿™å¥—æ–¹æ¡ˆåŒæ—¶ä¹Ÿæ˜¯å¯¹æ•°æ®åº“å¼•æ“å®Œå…¨é€æ˜ï¼Œåœ¨æ•°æ®åº“è§†è§’ï¼Œæ˜¯å¦åŠ è§£å¯†åœ¨æ•°æ®æ£€ç´¢é€»è¾‘ä»¥åŠæ‰§è¡Œè®¡åˆ’ä¼˜åŒ–ã€äº‹åŠ¡ç®¡ç†ç­‰å„ä¸ªæ–¹é¢éƒ½æ²¡æœ‰åŒºåˆ«ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆèƒ½å¤Ÿå®Œç¾ä¿ç•™æ•°æ®åº“çš„é«˜çº§ç‰¹æ€§ï¼›&lt;/li>
&lt;/ul>
&lt;p>å½“ç„¶ï¼Œæ²¡æœ‰å®Œç¾çš„æ–¹æ¡ˆï¼Œè¿™ä¸ªæ–¹æ¡ˆå­˜åœ¨ä¸€å®šé™åˆ¶ï¼š&lt;/p>
&lt;ul>
&lt;li>ä»…èƒ½è¡¨çº§åŠ å¯†ï¼šç”±äºè¿™ä¸ªæ–¹æ¡ˆæ˜¯å¯¹æ•°æ®æ–‡ä»¶è¿›è¡Œçš„æ— æ„ŸåŠ è§£å¯†ï¼Œæ‰€ä»¥å®ƒæœ€å¤§çš„é™åˆ¶æ˜¯æ— æ³•å®ç°æŒ‡å®šæ•°æ®è¡¨ä¸­éƒ¨åˆ†åˆ—çš„åŠ å¯†ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡é‡Œï¼Œèƒ½å¤Ÿè®¾è®¡å‡ºåˆšå¥½å…¨è¡¨æˆ–è€…å‡ ä¹å…¨éƒ¨åˆ—éœ€è¦åŠ å¯†çš„ç»“æ„ï¼Œè¿™ç§é™åˆ¶å®Œå…¨ä¸æ˜¯é—®é¢˜ï¼›&lt;/li>
&lt;li>å¹³å°å…¼å®¹æ€§é—®é¢˜ï¼šç”±äºä¾èµ–äº†æ“ä½œç³»ç»Ÿå±‚é¢çš„è®¾è®¡ï¼Œæ‰€ä»¥è¿™å¥—æ–¹æ¡ˆå¯èƒ½åªèƒ½è¿è¡Œäºç‰¹å®šçš„å¹³å°ä¹‹ä¸Šï¼›å¦å¤–å¦‚æœæ˜¯äº‘åœºæ™¯ä¹‹ä¸‹ï¼Œè¿˜éœ€è¦è€ƒè™‘ä¸åŒå…¬æœ‰äº‘æ‰€æä¾›çš„æ–¹æ¡ˆå·®å¼‚ï¼Œç‰¹åˆ«æ˜¯ä½¿ç”¨æ–¹å¼ä¸Šçš„ç»†èŠ‚å·®å¼‚ï¼Œè¿™äº›éƒ½å¯èƒ½å¯¼è‡´åŒä¸€å¥—ç³»ç»Ÿåœ¨äº‘å‚å•†ä¹‹é—´è¿ç§»æ—¶å‡ºç°æ°´åœŸä¸æœçš„é—®é¢˜ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨æˆ‘è‡ªå·±çš„ä¸šåŠ¡ç³»ç»Ÿçš„è®¾è®¡æ–¹æ¡ˆä¸­ï¼Œæˆ‘ä»¬å¼•å…¥äº†ç”¨æˆ·éšç§åŸŸçš„æ¦‚å¿µï¼Œåœ¨è®¾è®¡ä¸Šä¼šå°†ç”¨æˆ·éšç§æ•°æ®å’Œä¸šåŠ¡æµç¨‹æ•°æ®åˆ†ç¦»ï¼Œå¤©ç„¶å®ç°ç”¨æˆ·éšç§æ•°æ®çš„é›†ä¸­å­˜å‚¨ï¼Œäºæ˜¯å…¨è¡¨æ•°æ®åŠ å¯†å¯¹æˆ‘ä»¬æ˜¯æœ€åˆé€‚çš„é€‰æ‹©ã€‚&lt;/p>
&lt;h2 id="db-åç½®å¤„ç†">DB åç½®å¤„ç†&lt;/h2>
&lt;p>DB åç½®å¤„ç†æ˜¯åŸºäºæ•°æ®åº“çš„è§¦å‘å™¨å’Œè‡ªå®šä¹‰å‡½æ•°åŠŸèƒ½ç­‰ï¼Œåœ¨æ•°æ®åº“æœåŠ¡å™¨æ‰§è¡ŒæŸ¥è¯¢è¿‡ç¨‹ä¸­è§¦å‘è‡ªå®šä¹‰åŠ è§£å¯†é€»è¾‘çš„æ‰§è¡Œã€‚è¿™ç§æ–¹æ¡ˆå¯ä»¥è¯´æ˜¯è§£å†³äº†å‰é¢å‡ ä¸ªæ–¹æ¡ˆå­˜åœ¨é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>é€æ˜æ€§ï¼šDB åç½®å¤„ç†ï¼Œå¯¹åº”ç”¨å®Œå…¨é€æ˜ï¼›&lt;/li>
&lt;li>æ•°æ®åº“é«˜çº§ç‰¹æ€§ï¼šå®Œå…¨å…¼å®¹ï¼›&lt;/li>
&lt;li>çµæ´»æ€§ï¼šå¯ä»¥çµæ´»å®ç°åˆ—çº§æ•°æ®åŠ å¯†ç­‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>å°½ç®¡è¿™ä¸ªæ–¹æ¡ˆçœ‹èµ·æ¥ä¹Ÿå¾ˆç¾ï¼Œä½†æ˜¯å®ƒä¾ç„¶ä¸å®Œç¾ï¼š&lt;/p>
&lt;ul>
&lt;li>åæ¨¡å¼ï¼šæˆ‘ä¸ªäººä¸€ç›´æŠ—æ‹’åœ¨æ•°æ®åº“æœåŠ¡å™¨ä¸Šç®¡ç†å‡½æ•°æˆ–è€…è§¦å‘å™¨ç­‰ï¼Œå› ä¸ºè¿™äº›ä¸œè¥¿éƒ½ä¸æ˜“äºç®¡ç†ï¼Œæ›´ä¸ç”¨è¯´å®ç°ç‰ˆæœ¬ç®¡ç†ç­‰ï¼›&lt;/li>
&lt;li>æ•°æ®åº“å…¼å®¹æ€§é—®é¢˜ï¼šç”±äºä¾èµ–æ•°æ®åº“æä¾›çš„ç‰¹æ€§ï¼Œåœ¨ä¸å¾—ä¸æ›´æ¢æ•°æ®åº“ç­‰åœºæ™¯ä¸‹ï¼Œè¿™å¥—æ–¹æ¡ˆåŸºæœ¬æ— æ³•å®ç°å¿«é€Ÿè¿ç§»ã€‚&lt;/li>
&lt;/ul>
&lt;h1 id="æ±‡æ€»å¯¹æ¯”">æ±‡æ€»å¯¹æ¯”&lt;/h1>
&lt;p>è¯´äº†è¿™ä¹ˆå¤šï¼Œå¯¹æ¯”ä¸‹å‡ å¥—æ–¹æ¡ˆçš„å·®å¼‚ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>æ–¹æ¡ˆåºå·&lt;/th>
&lt;th>åŠ å¯†æ‰€åœ¨ç¯èŠ‚&lt;/th>
&lt;th>æ–¹æ¡ˆç®€ä»‹&lt;/th>
&lt;th>æ–¹æ¡ˆæ¡ˆä¾‹&lt;/th>
&lt;th>ä¼˜ç‚¹&lt;/th>
&lt;th>é™åˆ¶&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>åº”ç”¨&lt;/td>
&lt;td>ç”±åº”ç”¨åœ¨å­˜å‚¨å‰è‡ªè¡ŒåŠ å¯†ï¼Œåœ¨æ£€ç´¢åè‡ªè¡Œè§£å¯†&lt;/td>
&lt;td>orm+å„ç±»é’©å­å®ç°&lt;/td>
&lt;td>çµæ´»/ç²’åº¦ç»†/å…¼å®¹æ€§å¼º&lt;/td>
&lt;td>æ— æ³•å¯¹åº”ç”¨é€æ˜ï¼Œå¢åŠ å¼€å‘è´Ÿæ‹…/é¢å¤–çš„ç§˜é’¥ç®¡ç†è´Ÿæ‹…&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>æ•°æ®åº“å‰ç½®ä»£ç†&lt;/td>
&lt;td>åœ¨åº”ç”¨å’Œæ•°æ®åº“ä¹‹é—´åŠ å…¥ä¸€å±‚ä»£ç†æœåŠ¡ï¼Œç”±ä»£ç†æœåŠ¡è´Ÿè´£åŠ è§£å¯†&lt;/td>
&lt;td>è…¾è®¯äº‘ CASB&lt;/td>
&lt;td>å¯¹åº”ç”¨é«˜ç¨‹åº¦é€æ˜ï¼Œæ— å¼€å‘è´Ÿæ‹…/æ”¯æŒåˆ—çº§åˆ«åŠ å¯†&lt;/td>
&lt;td>SQL è¯­æ³•å…¼å®¹æ€§ä¸‹é™ï¼Œå¯¹å¼€å‘ä¸æ˜¯å®Œå…¨é€æ˜/æ•°æ®åº“çš„ä¼˜åŒ–å¤„ç†ã€äº‹åŠ¡å¤„ç†ã€å¹¶å‘å¤„ç†ç­‰ç‰¹æ€§éƒ½æ— æ³•ä½¿ç”¨/å¼•å…¥é¢å¤–çš„ç¯èŠ‚ï¼Œæ€§èƒ½ä»¥åŠæ½œåœ¨æ’éšœè´Ÿæ‹…/æ•°æ®è†¨èƒ€å‰å®³ï¼Œ~4.5å€ç©ºé—´è†¨èƒ€&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>æ•°æ®åº“æ•°æ®æ–‡ä»¶&lt;/td>
&lt;td>å·¥ä½œåœ¨æ–‡ä»¶ç³»ç»Ÿå±‚é¢ï¼Œå¼•æ“æŒä¹…åŒ–å­˜å‚¨å‰å®ŒæˆåŠ å¯†ï¼Œæ•°æ®æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­å‰è§£å¯†ï¼Œå†…å­˜ä¸­ä¿ç•™æ˜æ–‡æ•°æ®&lt;/td>
&lt;td>è…¾è®¯äº‘é€æ˜æ•°æ®åŠ å¯†ï¼ˆTDEï¼‰&lt;/td>
&lt;td>å¯¹åº”ç”¨å®Œå…¨é€æ˜/äº‘æ•°æ®åº“å†…ç½®æ”¯æŒï¼Œå…¼å®¹æ•°æ®åº“é«˜çº§ç‰¹æ€§&lt;/td>
&lt;td>è¡¨ç©ºé—´åŠ å¯†ï¼Œä¸æ”¯æŒå­—æ®µçº§åˆ«åŠ å¯†/æ— æ³•è§„é¿ SQL æ³¨å…¥å¸¦æ¥çš„æ‹–åº“é£é™©&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>æ•°æ®åº“åç½®å¤„ç†&lt;/td>
&lt;td>ä½¿ç”¨â€œè§†å›¾â€+â€œè§¦å‘å™¨â€+â€œæ‰©å±•ç´¢å¼•â€+â€œå¤–éƒ¨è°ƒç”¨â€çš„æ–¹å¼å®ç°æ•°æ®åŠ å¯†ï¼ŒåŒæ—¶ä¿è¯åº”ç”¨å®Œå…¨é€æ˜ã€‚&lt;/td>
&lt;td>&amp;ndash;&lt;/td>
&lt;td>å¯¹åº”ç”¨å®Œå…¨é€æ˜/æ•°æ®åº“é«˜çº§ç‰¹æ€§å…¼å®¹æ€§/æ”¯æŒåˆ—çº§åˆ«åŠ å¯†&lt;/td>
&lt;td>éœ€è¦è¾ƒå¼ºè¿ç»´ï¼Œæ²¡æœ‰äº‘åŸç”Ÿæ”¯æŒ&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h1 id="å‡ ç§æ–¹æ¡ˆå…±å­˜çš„é—®é¢˜">å‡ ç§æ–¹æ¡ˆå…±å­˜çš„é—®é¢˜&lt;/h1>
&lt;p>å‰é¢åˆ†æä¸­å§‹ç»ˆæ²¡æœ‰å»è®¨è®ºçš„é—®é¢˜ï¼Œæ˜¯ä¸ç®¡å“ªç§æ–¹æ¡ˆéƒ½æ— æ³•ç»•å¼€çš„é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>æ€§èƒ½å¼€é”€ï¼šæ•°æ®åŠ è§£å¯†è¿‡ç¨‹çš„é¢å¤–å¼€é”€ï¼Œæ•°æ®åŠ è§£å¯†éœ€è¦å¤§é‡çš„è®¡ç®—è¿‡ç¨‹ï¼Œè¿™ä¸ªä¼šå¸¦æ¥ä¸å®¹å¿½è§†çš„æ€§èƒ½å¼€é”€ï¼Œåœ¨åŠ è§£å¯†ç®—æ³•çš„é€‰æ‹©ä¸Šï¼Œéœ€è¦åœ¨ç¡®ä¿æ•°æ®å®‰å…¨æ€§çš„å‰æä¸‹ï¼Œå°½å¯èƒ½é€‰æ‹©å°½å¯èƒ½é«˜æ•ˆçš„åŠ å¯†ç®—æ³•ï¼›&lt;/li>
&lt;li>ç©ºé—´è†¨èƒ€ï¼šé™¤äº†æ€§èƒ½å¼€é”€ä¼šå½±å“åŠ å¯†ç®—æ³•çš„é€‰æ‹©ï¼ŒåŠ å¯†ç®—æ³•å¯èƒ½è¿˜ä¼šå¸¦æ¥ç©ºé—´è†¨èƒ€çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯å¯†æ–‡æ¯”æ˜æ–‡å˜é•¿çš„é—®é¢˜ï¼Œå¦‚æœæ˜¯ç©ºé—´è†¨èƒ€ï¼Œæ•°æ®åº“åˆ—åœ¨å„ç±»é•¿åº¦çš„è®¾è®¡ä¸Šè¿˜éœ€è¦é¢å¤–è€ƒè™‘åˆ—æ•°æ®è†¨èƒ€åçš„é•¿åº¦ã€‚æˆ‘äº†è§£äº†ä¸‹ï¼ŒAES åŠ å¯†ç®—æ³•çš„ CTR æ¨¡å¼åˆ™èƒ½å®ç°å¯†æ–‡å’Œæ˜æ–‡é•¿åº¦ä¸€è‡´ï¼›&lt;/li>
&lt;li>å¯†é’¥ç®¡ç†é—®é¢˜ï¼šä¸ç®¡å“ªç§åŠ å¯†æ–¹æ¡ˆï¼Œéƒ½éœ€è¦æƒ³å¥½å¯†é’¥çš„ç§å¯†å­˜å‚¨ä»¥åŠå®šæœŸè½®æ¢é—®é¢˜ç­‰ï¼Œå¦åˆ™ä¸€æ—¦å¯†é’¥æ³„éœ²ï¼ŒåŠ å¯†å¾—å†å¥½çš„æ•°æ®ä¹Ÿå¯èƒ½è¢«ä¸€é”…ç«¯äº†ã€‚&lt;/li>
&lt;/ul>
&lt;h1 id="æ€»ç»“">æ€»ç»“&lt;/h1>
&lt;p>æ•°æ®å­˜å‚¨å®‰å…¨æ˜¯ä¸€ä¸ªè¶Šæ¥è¶Šé‡è¦ï¼Œä¹Ÿæ˜¯åº”ç”¨ç³»ç»Ÿè®¾è®¡é˜¶æ®µå¿…é¡»æå‰è€ƒè™‘å¥½çš„é—®é¢˜ï¼Œå› ä¸ºå®ƒæ¶‰åŠçš„æ˜¯æœåŠ¡è´¨é‡å’Œæˆæœ¬å¹³è¡¡çš„å¤æ‚é—®é¢˜ã€‚æ•°æ®åŠ å¯†åœ¨ä¸šåŠ¡åˆè§„ä»¥åŠéšç§ä¿æŠ¤ä¸­æ­£åœ¨é€æ­¥æ‰®æ¼”å¸¸è¯†æ€§çš„åœ°ä½ï¼Œå¦‚åŒå¤§å®¶å¦‚ä»Šéƒ½çŸ¥é“å¯†ç ä¸èƒ½æ˜æ–‡å­˜å‚¨ä¸€æ ·ï¼Œæœªæ¥å„ç±»ä¸ªäººéšç§æ•°æ®åŠ å¯†ä¹Ÿåº”è¯¥ä¼šæˆä¸ºç³»ç»Ÿä¸­çš„æ ‡é…è®¾è®¡ã€‚&lt;/p></description></item><item><title>Funny Pieces of Codes Make Weekend Happier</title><link>https://blog.hackerpie.com/posts/others/funny-code-pieces/</link><pubDate>Sun, 13 Mar 2022 16:10:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/others/funny-code-pieces/</guid><description>&lt;p>Sunny weekends make me cheerful always, and there are also some funny pieces of codes make it greater. Hope the following codes make you smile, too.&lt;/p>
&lt;p>Although I hardly use Ruby programming language for a long time, I still remember a piece of code from Sidekiq, which is a asynchronous jobs framework for Ruby:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq.rb#L51-L53&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">Sidekiq&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> self.&lt;span style="">â¨â•¯Â°â–¡Â°â©â•¯ï¸µâ”»â”â”»&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> puts &lt;span style="font-style:italic">&amp;#34;Calm down, yo.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Aha! It is a unused method of which the name is a emoticon, and seems that the author of the code is annoying while he or she was writing it. However, there is also a corresponding and serious unit test for it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>describe &lt;span style="font-style:italic">&amp;#34;â¨â•¯Â°â–¡Â°â©â•¯ï¸µâ”»â”â”»&amp;#34;&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> before { $stdout = StringIO.new }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> after { $stdout = STDOUT }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> it &lt;span style="font-style:italic">&amp;#34;allows angry developers to express their emotional constitution and remedies it&amp;#34;&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.&lt;span style="">â¨â•¯Â°â–¡Â°â©â•¯ï¸µâ”»â”â”»&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert_equal &lt;span style="font-style:italic">&amp;#34;Calm down, yo.&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\n&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>, $stdout.string
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>According some online discussion, I finally aware that the reason why the code is present is that the author was expecting to ensure that the code works normally with UTF-8 encoding.&lt;/p>
&lt;p>Beyond this funny example from Sidekiq, I searched some other examples by the way, they all make people laugh out loud.&lt;/p>
&lt;h2 id="time-for-funny-codes">Time for funny codes&lt;/h2>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>Exception up = &lt;span style="font-weight:bold">new&lt;/span> Exception(&lt;span style="font-style:italic">&amp;#34;Something is really wrong.&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">throw&lt;/span> up; &lt;span style="font-style:italic">//ha ha&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>What the hell does this guy lack of compassion? Why does he or she is able to smile after the program encountered something incorrect? Alright, I can only appreciate his optimism.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//When I wrote this, only God and I understood what I was doing
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//Now, God only knows
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Aha, it is a truth could not be more real. Not only the author of the code has this kind of trouble, but do I.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// drunk, fix later
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>What a conscientious programmer! How dangerous drunk coding is! Maybe it deserve considering punching somebody write codes after drinking.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="">#define TRUE FALSE
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Oh no! I hardly imagine what will happen once this line of code has been merged and deployed. How terrible if your world is reversed, you are wrong if you think you are right, and you are right if you think you are wrong. Stop it please, I get goose bumps all over now!&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">return&lt;/span> 1; &lt;span style="font-style:italic"># returns 1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>What a nonsense comment! But it is understandable if your boss pays you for the number of characters in your code.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>Catch (Exception e) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">//who cares?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Alright, you are so proud. â•­(â•¯^â•°)â•®&lt;/p>
&lt;p>I am not able to assert all people who care, but I can tell that your boss absolutely cares.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// I am not responsible of this code.
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>o(â•¯â–¡â•°)o Ok, but why you wanna left a footmark?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// it was hard to write
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// so it should be hard to read
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It looks like a impregnable argument. Who wanna challenge?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// I have to find a better job
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Wait, if you really find a better job, could you take me with you? (&lt;em>^â–½^&lt;/em>)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// If this code works, it was written by Paul DiLascia. If not, I don&amp;#39;t know
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// who wrote it
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>I only write excellent codes, and ugly codes are all out of thin air.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Linux Sex&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ date ; unzip ; strip ; touch ; grep ; finger ; mount ; fsck ; more ; yes ; umount ; sleep
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Em&amp;hellip; I don&amp;rsquo;t know it is, I am still a child and hiding my eyes from it.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="">long&lt;/span> &lt;span style="">long&lt;/span> ago; &lt;span style="font-style:italic">/* in a galaxy far far away */&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Are you telling a story?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c++" data-lang="c++">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"> * Always returns true.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">public&lt;/span> boolean isAvailable() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>How dare you lie?! But which part is really wrong? The comment, or the function body?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c++" data-lang="c++">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// Dear maintainer:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// Once you are done trying to &amp;#39;optimize&amp;#39; this routine,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// and have realized what a terrible mistake that was,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// please increment the following counter as a warning
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// to the next guy:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// total_hours_wasted_here = 42
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It was clear that here is a victims alliance.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c++" data-lang="c++">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">return&lt;/span> true; &lt;span style="font-style:italic">//true my ass! this doesn&amp;#39;t work
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>How shall I put it? Fairy tales are lying.&lt;/p>
&lt;h2 id="for-more-funny-codes">For more funny codes&lt;/h2>
&lt;p>The above funny codes are all included in these articles, just click the links if you feel unsatisfied.&lt;/p>
&lt;ol>
&lt;li>&lt;a href="http://fuzzzyblog.blogspot.hk/2014/09/40-most-funny-code-comments.html">Fuzzzy blog: 40 most funny code comments ever&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.quora.com/What-are-some-of-the-funniest-comments-in-source-code">What are some of the funniest comments in source code?&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Golang ç¼–å†™æ˜“äºå•å…ƒæµ‹è¯•çš„ä»£ç </title><link>https://blog.hackerpie.com/posts/testing/golang-write-testable-codes/</link><pubDate>Sun, 06 Mar 2022 17:40:19 +0800</pubDate><guid>https://blog.hackerpie.com/posts/testing/golang-write-testable-codes/</guid><description>&lt;h2 id="èŠèŠå•æµ‹è¿™ä¸ªäº‹">èŠèŠå•æµ‹è¿™ä¸ªäº‹&lt;/h2>
&lt;p>å•å…ƒæµ‹è¯•ä¸€ç›´æ˜¯å¤§å®¶è€ç”Ÿé•¿è°ˆçš„è¯é¢˜ä¹‹ä¸€ï¼Œå°½ç®¡å„ç§æµ‹è¯•æ–¹æ³•è®ºå’Œæµ‹è¯•å·¥å…·é›†å±‚å±‚å‡ºä¸ç©·ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œåœ¨æˆ‘æ‰€å·¥ä½œè¿‡çš„å…¬å¸ä¸­ï¼Œè¿˜æ²¡æœ‰è§è¿‡èƒ½æŠŠå•æµ‹åšæŒå¥½çš„å›¢é˜Ÿã€‚å•æµ‹çš„æ¦‚å¿µä¸å¤æ‚ï¼Œå•æµ‹çš„é‡è¦æ€§å¤§å®¶ä¹Ÿéƒ½æ˜¯è®¤åŒçš„ï¼Œä½†æ˜¯æ˜¯ä»€ä¹ˆé€ æˆå•æµ‹æ²¡æœ‰æ‰§è¡Œä¸‹æ¥å‘¢ï¼Ÿæˆ‘è§‰å¾—ä¸»è¦æ˜¯ä¸¤ç±»åŸå› å§ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>å¼€å‘å·¥æœŸå¤ªèµ¶&lt;/strong>ï¼šæ—¶é—´åªå¤Ÿå†™åŠŸèƒ½æ€§ä»£ç ï¼Œæµ‹è¯•ä»£ç åªèƒ½èˆå¼ƒï¼Œç³»ç»ŸåŠŸèƒ½ä¾èµ–ä¸å¯é‡å¤çš„äººåŠ›æ“ä½œ&lt;/li>
&lt;li>&lt;strong>é¡¹ç›®è®¾è®¡é—®é¢˜&lt;/strong>ï¼šé¡¹ç›®ä»£ç ç»“æ„è®¾è®¡ä¸è‰¯ï¼Œå¯¼è‡´å•æµ‹ä»£ç éš¾ä»¥ç¼–å†™ï¼Œæˆ–è€…è¿è¡Œéœ€è¦è¿‡å¤šå¤æ‚çš„ä¾èµ–ï¼ŒåŠ ä¸Šé¡¹ç›®å·²å­˜åœ¨å¤§é‡ä»£ç ï¼Œä¸æ•¢é‡æ„&lt;/li>
&lt;/ul>
&lt;p>ç¬¬ä¸€ä¸ªåŸå› è§ä»è§æ™ºï¼Œä¹Ÿä¸æ˜¯æˆ‘æƒ³èŠçš„é‡ç‚¹ã€‚æˆ‘æœ€è¿‘æ›´å¤šçš„å®è·µå’Œæ„Ÿæ‚Ÿæ˜¯ï¼Œå¦‚æœä¸€ä¸ªé¡¹ç›®ä»ä¸€å¼€å§‹å°±æ²¡æœ‰è€ƒè™‘å¥½å•æµ‹çš„éœ€è¦ï¼Œç­‰åˆ°åæœŸå°±å‡ ä¹éš¾ä»¥æ”¹é€ æˆæ˜“äºå•å…ƒæµ‹è¯•æ‰§è¡Œçš„ç»“æ„äº†ã€‚è€Œå¦ä¸€æ–¹é¢ï¼Œæˆ‘ä¹Ÿæ˜¯æœ€è¿‘æ‰å¯¹å•æµ‹è¿™ä¸ªäº‹æƒ…æœ‰ä¸€ç§é¡¿æ‚Ÿçš„æ„Ÿè§‰ã€‚æ‰€ä»¥ï¼Œä¸‹é¢ä¹Ÿæ˜¯æƒ³é€šè¿‡ä¸€ä¸ªå° demo é¡¹ç›®ï¼Œæ¥æ€»ç»“å¦‚ä½•è®¾è®¡åœ¨ golang é‡Œç¼–å†™æ˜“äºå•æµ‹å±•å¼€çš„ä»£ç ã€‚&lt;/p>
&lt;p>é¡¹ç›®è®¾è®¡é—®é¢˜å¯¼è‡´çš„å•æµ‹éš¾ä»¥å±•å¼€ï¼Œä¸€èˆ¬éƒ½æ˜¯å› ä¸ºä»£ç ç»„ä»¶ä¹‹é—´å½¢æˆäº†é™æ€çš„ä¾èµ–å…³ç³»ï¼Œæ¯”å¦‚å¯¹æ•°æ®åº“çš„ä¾èµ–ï¼Œå¯¹å¤–éƒ¨æœåŠ¡çš„ä¾èµ–ï¼Œç­‰ç­‰ã€‚è¿™äº›ä¾èµ–ï¼Œå¯èƒ½æ˜¯ç›´æ¥çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¾èµ–çš„ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯é—´æ¥çš„ã€‚è€ŒæŒ‰ç…§å•æµ‹çš„å®šä¹‰ï¼Œä¸€ä¸ªè¶³å¤Ÿå°çš„ä»£ç å•å…ƒçš„æµ‹è¯•ï¼Œåº”è¯¥åªå…³æ³¨è¿™ä¸ªå•å…ƒçš„è¾“å…¥å’Œè¾“å‡ºå³å¯ï¼Œå¤–åŠ è¶³ä»¥é©±åŠ¨å•æµ‹æ‰§è¡Œçš„æœ€å°ä¾èµ–é›†åˆï¼Œè€Œä¸åº”è¯¥æ‹…å¿ƒé™¤æ­¤ä¹‹å¤–çš„å…¶ä»–ä¸€åˆ‡ä¸œè¥¿ã€‚å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå°†ä»£ç è¿›è¡Œåˆ†å±‚è®¾è®¡ï¼ŒæŒ‰ç…§èŒè´£åˆ’åˆ†ä¸åŒçš„ä»£ç æ¨¡å—ï¼Œä½†æ˜¯ç”±äºä¾èµ–ç®¡ç†çš„è®¾è®¡æ„è¯†ä¸è¶³ï¼Œå¸¸ä¼šå‘ç°æ¨¡å—ä¹‹é—´å½¢æˆäº†é™æ€çš„ä¾èµ–å…³ç³»ï¼Œå¯¼è‡´ç¼–å†™å•æµ‹æ—¶ï¼Œä¸å¾—ä¸å»å…³æ³¨å„ç§é—´æ¥çš„ä¾èµ–ï¼Œè¿™å°±å¥½æ¯”ä¸€ä¸ªèŠ¯ç‰‡åœ¨ç”Ÿäº§é˜¶æ®µå°±å·²ç»ç„Šæ­»åœ¨äº†ä¸»æ¿ä¹‹ä¸Šï¼Œä»¥è‡³äºå¦‚æœæˆ‘ä»¬éœ€è¦å¯¹èŠ¯ç‰‡çš„åŠŸèƒ½è¿›è¡ŒéªŒè¯çš„è¯ï¼Œå°±åªèƒ½å°†æ•´ä¸ªä¸»æ¿åˆ¶ä½œå®Œæ•´ä¹‹åï¼Œæ‰èƒ½é€šè¿‡å¯åŠ¨ä¸»æ¿æ¥æ£€æŸ¥èŠ¯ç‰‡çš„åŠŸèƒ½ï¼Œæƒ³æƒ³è¿™æœ‰å¤šç¦»è°±ã€‚&lt;/p>
&lt;h3 id="è¯´æ˜">è¯´æ˜&lt;/h3>
&lt;p>å‡ºäºæ¼”ç¤ºç›®çš„ï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªé€»è¾‘ä¸Šä¸ä¸¥è°¨çš„å°ç¤ºä¾‹é¡¹ç›®ï¼Œä»£ç æ‰˜ç®¡åœ¨ &lt;a href="https://github.com/HackerPie/go-microblog">HackerPie/go-microblog&lt;/a>ã€‚demo å®ç°äº†ä¸¤ä¸ªç”¨äºç®¡ç†æŒ‡å®šç”¨æˆ·å¾®åšçš„ Restful APIï¼ŒæŒ‰ç…§åç»­è®¨è®ºç« èŠ‚çš„å†…å®¹ï¼Œè¿™ä»½ä»£ç ç›¸åº”åœ°é€šè¿‡å¤šä¸ª git tag æ¥è¯†åˆ«å¯¹åº”çš„ä»£ç ç‰ˆæœ¬ï¼Œåˆ†åˆ«ä¸º&lt;code>v1&lt;/code>ã€&lt;code>v2&lt;/code>ã€&lt;code>v3&lt;/code>å’Œ&lt;code>v4&lt;/code>ã€‚&lt;/p>
&lt;h4 id="æ¦‚è¿°">æ¦‚è¿°&lt;/h4>
&lt;p>å°½ç®¡åªæ˜¯ä¸€ä¸ªå° demoï¼Œæˆ‘è¿˜æ˜¯å¸Œæœ›æå‰è¯´æ˜ä¸‹è¿™ä¸ª demo çš„åˆ†å±‚è®¾è®¡ã€‚demo æ ¸å¿ƒé€»è¾‘å­˜æ”¾åœ¨ &lt;code>internal&lt;/code> ç›®å½•é‡Œï¼Œå› ä¸ºåªæ˜¯ demoï¼Œæ‰€ä»¥åªåˆ’åˆ†äº† &lt;code>service&lt;/code>ã€&lt;code>repo&lt;/code> ä»¥åŠ &lt;code>model&lt;/code> ä¸‰å±‚ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/unit-testing/demo_layers.png" alt="">
&lt;figcaption>demo åº”ç”¨åˆ†å±‚&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>å„å±‚è¯´æ˜ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>service&lt;/strong>: è¯¥å±‚ä»£ç è´Ÿè´£è¯·æ±‚çš„å¤„ç†ä¸å“åº”ï¼ŒåŒæ—¶è´Ÿè´£æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼Œä¸€èˆ¬çœŸå®é¡¹ç›®é‡Œï¼Œæˆ‘ä¼šè¿›ä¸€æ­¥åˆ†å¼€æœåŠ¡å¤„ç†å’Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ï¼Œä½†æ˜¯ä½œä¸ºç¤ºä¾‹é¡¹ç›®ï¼Œå°±ç®€åŒ–äº†ï¼›
&lt;ul>
&lt;li>&lt;strong>adapter&lt;/strong>: adapter ä¸»è¦å®šä¹‰å„ç±» dto å¯¹è±¡å’Œæ•°æ®åº“æ¨¡å‹å¯¹è±¡ä¹‹é—´çš„è½¬æ¢é€‚é…ï¼Œæˆ‘è®¤ä¸ºè¿™ä»æ—§å±äº &lt;code>service&lt;/code> å±‚çš„é€»è¾‘ï¼Œä½†æ˜¯åœ¨å®é™…ä»£ç ä¸­ï¼Œæˆ‘ä¼šç‹¬ç«‹ä¸€ä¸ªç›®å½•æ¥ç®¡ç†ï¼›&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>repo&lt;/strong>: è¯¥å±‚ä»£ç è´Ÿè´£å•ä¸€æ•°æ®æ¨¡å‹çš„æŒä¹…åŒ–æ“ä½œï¼Œå³æ•°æ®çš„ CURDï¼›&lt;/li>
&lt;li>&lt;strong>model&lt;/strong>: è¯¥å±‚å®šä¹‰å„ç±»æ•°æ®ç»“æ„ï¼ŒæŒ‰ç…§ä½¿ç”¨åœºæ™¯ä¸åŒï¼Œè¿›ä¸€æ­¥åˆ’åˆ† &lt;code>dto&lt;/code> å’Œ &lt;code>db&lt;/code>
&lt;ul>
&lt;li>&lt;strong>dto&lt;/strong>: æ•°æ®ä¼ è¾“å¯¹è±¡ï¼Œç”¨äºå®šä¹‰ä¸€äº›éœ€è¦è¿”å›ç»™å®¢æˆ·ç«¯æˆ–è€…ä»å®¢æˆ·ç«¯è¯·æ±‚ååºåˆ—åŒ–çš„æ•°æ®ç»“æ„ï¼›&lt;/li>
&lt;li>&lt;strong>db&lt;/strong>: æ•°æ®åº“æ¨¡å‹å®šä¹‰ï¼Œç”¨äºæè¿°æ•°æ®åº“è¡¨çš„ç»“æ„ï¼Œæ­¤å±‚ä¸è´Ÿè´£ä»»ä½•æ•°æ®è¯»å†™æ“ä½œã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>å„å±‚ä»£ç åœ¨é¡¹ç›®ä»£ç ç»“æ„ä¸­çš„ç®¡ç†å¦‚å›¾ï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/unit-testing/layout.png" alt="">
&lt;figcaption>internal ä»£ç ç»“æ„ç»„ç»‡&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h2 id="v1-ä¾èµ–å…·ä½“å®ç°çš„ç‰ˆæœ¬">v1: ä¾èµ–å…·ä½“å®ç°çš„ç‰ˆæœ¬&lt;/h2>
&lt;p>&lt;a href="https://github.com/HackerPie/go-microblog/tree/v1">v1 ç‰ˆæœ¬&lt;/a> ä»£ç ä¸­ï¼Œæ˜¯ä¸€ä¸ªç»å…¸çš„ä»£ç åˆ†å±‚ä¹‹é—´ç›´æ¥ä¾èµ–å…·ä½“å®ç°çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// cmd/api_server.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>r := gin.Default()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>r.GET(&lt;span style="font-style:italic">&amp;#34;/users/:user_id/blogs&amp;#34;&lt;/span>, service.ListUserMBlogs)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>r.POST(&lt;span style="font-style:italic">&amp;#34;/users/:user_id/blogs&amp;#34;&lt;/span>, service.PublishNewBlog)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>r.Run(&lt;span style="font-style:italic">&amp;#34;:8000&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/service/micro_blogs_service.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> ListUserMBlogs(c *gin.Context) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> mblogs, err := repo.ListUserMBlogs(userID)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> PublishNewBlog(c *gin.Context) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> err = repo.NewUserMBlog(userID, req.Content); err != &lt;span style="font-weight:bold">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// intrnal/repo/micro_blogs_repo.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> ListUserMBlogs(userID &lt;span style="">int&lt;/span>) ([]*dbModel.MicroBlog, &lt;span style="">error&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> err := db.Model(dbModel.MicroBlog{}).Where(&lt;span style="font-style:italic">&amp;#34;user_id = ?&amp;#34;&lt;/span>, userID).Scan(&amp;amp;mblogs).Error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> NewUserMBlog(userID &lt;span style="">int&lt;/span>, content &lt;span style="">string&lt;/span>) &lt;span style="">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">return&lt;/span> db.Create(&amp;amp;mblog).Error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°ä¸­ï¼ŒWeb æ¥å£ &lt;code>/users/:user_id/blogs&lt;/code> ä¾èµ–äº† &lt;code>service.ListUserMBlogs&lt;/code> çš„å®ç°ï¼Œè€Œå…¶åˆç›´æ¥ä¾èµ–äº† &lt;code>repo.ListUserMBlogs&lt;/code> å‡½æ•°ï¼Œè€Œåè€…åˆä¾èµ–äº† &lt;code>db&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ &lt;code>gorm.DB&lt;/code> å¯¹è±¡æŒ‡é’ˆï¼Œäº¦å³æ•°æ®åº“è¿æ¥ã€‚å‡å¦‚æˆ‘ä»¬éœ€è¦ä¸º &lt;code>service.ListUserMBlogs&lt;/code> ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œç”¨äºéªŒè¯å‡ ç±»æ˜¾è€Œæ˜“è§çš„æµ‹è¯•åœºæ™¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æ•°æ®æŸ¥è¯¢å¤±è´¥&lt;/li>
&lt;li>æ•°æ®æŸ¥è¯¢æˆåŠŸï¼Œä½†æ˜¯æ²¡æœ‰åŒ¹é…çš„æ•°æ®é›†&lt;/li>
&lt;li>æ•°æ®æŸ¥è¯¢æˆåŠŸï¼Œå¹¶ä¸”æœ‰åŒ¹é…çš„æ•°æ®é›†&lt;/li>
&lt;/ul>
&lt;p>é‚£ä¹ˆï¼ŒåŸºäºè¿™å¥—è®¾è®¡å’Œæµ‹è¯•éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–ä¸­å»ºç«‹å¥½æ•°æ®åº“è¿æ¥&lt;/li>
&lt;li>æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥å¤±è´¥ç­‰å¯èƒ½å¯¼è‡´æ•°æ®æŸ¥è¯¢å¤±è´¥çš„åœºæ™¯ï¼Œè¿™ä¼šè·Ÿä¸Šé¢çš„æ•°æ®åº“è¿æ¥ç®¡ç†é€ æˆçŸ›ç›¾&lt;/li>
&lt;li>è½½å…¥æŒ‡å®šæµ‹è¯•æ•°æ®é›†ï¼Œä»¥æ»¡è¶³ä¸åŒçš„åŒ¹é…ç»“æœçš„åœºæ™¯&lt;/li>
&lt;li>æœ€åéœ€è¦æ¸…ç†æ•°æ®åº“æ•°æ®ï¼Œä»¥é˜²æ­¢å¹²æ‰°å…¶ä»–å•å…ƒæµ‹è¯•ç”¨ä¾‹çš„ç»“æœ&lt;/li>
&lt;/ul>
&lt;p>å‡å¦‚æˆ‘ä»¬è¿˜å¸Œæœ›è¿™äº›å•æµ‹ç”¨ä¾‹å¯ä»¥æ‰§è¡Œäº CI æµç¨‹æˆ–è€…æ¯æ—¥è‡ªåŠ¨å›å½’ä¸­ï¼Œåˆä¼šæœ‰æ–°çš„é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>CI ç¯å¢ƒéœ€è¦æä¾›å¯ç”¨çš„ MySQL æ•°æ®åº“ç­‰ï¼›&lt;/li>
&lt;li>CI ç¯å¢ƒéœ€è¦åˆå§‹åŒ–è¿‡ç¨‹ä¸­é¢å¤–å®Œæˆ DDL æ“ä½œï¼Œä»¥å‡†å¤‡å¥½å•æµ‹ä¾èµ–çš„åº“è¡¨ç»“æ„ï¼›&lt;/li>
&lt;/ul>
&lt;p>é™¤äº†è¿™äº›ä¸€ä¸‹å­æƒ³åˆ°çš„é—®é¢˜ï¼Œè¿˜ä¼šæœ‰åä½œå±‚é¢çš„é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>æµ‹è¯•ç¯å¢ƒéš¾ä»¥ä¿æŒä¸€è‡´&lt;/strong>ï¼šå¦‚æœä½¿ç”¨æœ¬åœ°æ•°æ®åº“ï¼Œåˆ™å¤§å®¶å„è‡ªçš„æ•°æ®åº“ç®¡ç†çš„ä¸åŒä¼šå¯¼è‡´æ¯ä¸ªäººåœ¨æ‰§è¡ŒåŒä¸€å¥—æµ‹è¯•ç”¨ä¾‹æ—¶ï¼Œéœ€è¦é’ˆå¯¹æ€§å®šåˆ¶è‡ªå·±çš„ç¯å¢ƒä¿¡æ¯ç­‰ï¼›å¦‚æœä½¿ç”¨å…±äº«çš„è¿œç¨‹æ•°æ®åº“ï¼Œåˆ™å®¹æ˜“å› ä¸ºå¹¶è¡Œçš„å¼€å‘å’Œæµ‹è¯•å¯¼è‡´ç›¸äº’å¹²æ‰°ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸€è¶Ÿæ‹ä¸‹æ¥ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªç®€å•å‡½æ•°çš„å•å…ƒæµ‹è¯•ï¼Œåœ¨æœ¬æ¥å°±å·²ç»å¾ˆæœ‰é™çš„åœºæ™¯ä¸‹ï¼Œå°±å·²ç»ç‰µæ‰¯å‡ºè¿™ä¹ˆå¤šä»¤äººç”Ÿç•çš„é—®é¢˜ï¼Œæˆ‘æƒ³ï¼Œå¼€å‘æ²¡æœ‰åŠ¨åŠ›å†™å•æµ‹ï¼Œä¹Ÿæ˜¯è‡ªç„¶çš„äº‹æƒ…äº†ã€‚&lt;/p>
&lt;p>å¾ˆè‡ªç„¶çš„ï¼Œé’ˆå¯¹è¿™ç§è®¾è®¡é£æ ¼çš„ä»£ç ï¼Œæˆ‘ä»¬æ€¥éœ€ä¸€ä¸ªè§£å†³æ–¹æ¡ˆï¼Œæ–¹ä¾¿æˆ‘ä»¬åœ¨å•æµ‹ä¸­å®ç°ä¾èµ–çš„è§£è€¦ï¼è¿™å°±æ˜¯&lt;a href="https://blog.hackerpie.com/posts/2021/dependency-inversion-principle-introduce/">ä¾èµ–å€’ç½®åŸåˆ™&lt;/a>çš„ç”¨æ­¦ä¹‹åœ°ï¼&lt;/p>
&lt;h2 id="v2-ä¾èµ–å€’ç½®ä¾èµ–æ¥å£">v2: ä¾èµ–å€’ç½®ï¼šä¾èµ–æ¥å£&lt;/h2>
&lt;p>åœ¨æˆ‘å¦ä¸€ç¯‡åšæ–‡ã€Š&lt;a href="https://blog.hackerpie.com/posts/2021/dependency-inversion-principle-introduce/">ä¾èµ–å€’ç½®åŸåˆ™&lt;/a>ã€‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ä¾èµ–å€’ç½®å¯ä»¥å¸®åŠ©é¿å…è€¦åˆä¾èµ–åŒæ–¹å®ç°çš„ä»£ç ç»“æ„é—®é¢˜ã€‚è€ŒæŒ‰ç…§ä¾èµ–å€’ç½®åŸåˆ™ï¼Œæˆ‘ä»¬éœ€è¦å°†ä¾èµ–å®ç°çš„ä»£ç ï¼Œæ”¹ä¸ºä¾èµ–æ¥å£å®šä¹‰çš„ä»£ç ï¼Œå…·ä½“åˆ° golang ä¸­ï¼Œå°±æ˜¯ &lt;code>interface&lt;/code>ï¼Œäºæ˜¯ï¼Œåº”ç”¨äº†ä¾èµ–å€’ç½®åŸåˆ™çš„&lt;a href="https://github.com/HackerPie/go-microblog/tree/v2">æ–°ç‰ˆæœ¬&lt;/a>ä»£ç åº”è¿è€Œç”Ÿï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// cmd/api_server/main.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> buildService() *service.MicroBlogsService {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db := repo.NewDB()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repoImpl := repo.NewMicroBlogRepoImpl(db)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> srv := service.NewMicroBlogsService(repoImpl)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> srv
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> main() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> srv := buildService()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r := gin.Default()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.GET(&lt;span style="font-style:italic">&amp;#34;/users/:user_id/blogs&amp;#34;&lt;/span>, srv.ListUserMBlogs)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.POST(&lt;span style="font-style:italic">&amp;#34;/users/:user_id/blogs&amp;#34;&lt;/span>, srv.PublishNewBlog)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.Run(&lt;span style="font-style:italic">&amp;#34;:8000&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/service/micro_blogs_service.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> MicroBlogsService &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repo repo.MicroBlogRepoIface &lt;span style="font-style:italic">// ä¾èµ–äº† repo.MicroBlogRepoIface æ¥å£
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> NewMicroBlogsService(repo repo.MicroBlogRepoIface) *MicroBlogsService {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &amp;amp;MicroBlogsService{repo: repo}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (srv *MicroBlogsService) ListUserMBlogs(c *gin.Context) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ....
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> mblogs, err := srv.repo.ListUserMBlogs(userID)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (srv *MicroBlogsService) PublishNewBlog(c *gin.Context) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> err = srv.repo.NewUserMBlog(userID, req.Content); err != &lt;span style="font-weight:bold">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/repo/interfaces.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> MicroBlogRepoIface &lt;span style="font-weight:bold">interface&lt;/span> { &lt;span style="font-style:italic">// &amp;lt;----- MicroBlogRepoIface æ¥å£å®šä¹‰
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> ListUserMBlogs(userID &lt;span style="">int&lt;/span>) ([]*dbModel.MicroBlog, &lt;span style="">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> NewUserMBlog(userID &lt;span style="">int&lt;/span>, content &lt;span style="">string&lt;/span>) &lt;span style="">error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/repo/micro_blogs_repo.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> MicroBlogRepoImpl &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db *gorm.DB
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> NewMicroBlogRepoImpl(db *gorm.DB) *MicroBlogRepoImpl {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &amp;amp;MicroBlogRepoImpl{db: db}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (impl *MicroBlogRepoImpl) ListUserMBlogs(userID &lt;span style="">int&lt;/span>) ([]*dbModel.MicroBlog, &lt;span style="">error&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> err := impl.db.Model(dbModel.MicroBlog{}).Where(&lt;span style="font-style:italic">&amp;#34;user_id = ?&amp;#34;&lt;/span>, userID).Scan(&amp;amp;mblogs).Error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (impl *MicroBlogRepoImpl) NewUserMBlog(userID &lt;span style="">int&lt;/span>, content &lt;span style="">string&lt;/span>) &lt;span style="">error&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">return&lt;/span> impl.db.Create(&amp;amp;mblog).Error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ &lt;a href="https://github.com/HackerPie/go-microblog/tree/v2">v2 ç‰ˆæœ¬&lt;/a> ä»£ç ä¸­ï¼Œæœ€ä¸»è¦çš„é‡æ„æ˜¯æå–äº† &lt;code>repo.MicroBlogRepoIface&lt;/code> æ¥å£çš„å®šä¹‰ï¼Œè€Œ service å±‚é€»è¾‘ä¸å†ç›´æ¥ä¾èµ– repo å±‚çš„å…·ä½“å‡½æ•°ï¼Œè€Œæ˜¯ä¾èµ–æ­¤æ¥å£ã€‚è€Œä¸ºäº†æ•´ä¸ªç¨‹åºèƒ½å¤Ÿæ­£å¸¸åˆå§‹åŒ–ï¼Œåˆ™éœ€è¦æ‰‹å·¥å®Œæˆä¾èµ–çš„æ³¨å…¥ï¼Œå…·ä½“ä½“ç°åœ¨ &lt;code>cmd/api_server/main.go&lt;/code> çš„ &lt;code>buildService&lt;/code> å‡½æ•°ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>db := repo.NewDB()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>repoImpl := repo.NewMicroBlogRepoImpl(db)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>srv := service.NewMicroBlogsService(repoImpl)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>buildService&lt;/code> å‡½æ•°é¦–å…ˆé€šè¿‡å·¥å‚å‡½æ•°è·å–äº† &lt;code>*gorm.DB&lt;/code> å¯¹è±¡ï¼Œå°†å…¶æ³¨å…¥ &lt;code>repo.NewMicroBlogRepoImpl&lt;/code> å·¥å‚å‡½æ•°ï¼Œè¿›è€Œç”Ÿäº§å¾—åˆ° &lt;code>repo.MicroBlogRepoImpl&lt;/code> å¯¹è±¡ï¼Œå…¶å®ç°äº† &lt;code>repo.MicroBlogRepoIface&lt;/code> æ¥å£ï¼Œå› æ­¤å¯ä»¥ä½œä¸º &lt;code>MicroBlogsService&lt;/code> çš„ä¾èµ–ï¼Œå› æ­¤é€šè¿‡ &lt;code>service.NewMicroBlogsService&lt;/code> å®Œæˆä¾èµ–æ³¨å…¥ï¼Œæœ€ç»ˆå¾—åˆ°æˆ‘ä»¬éœ€è¦çš„ service å¯¹è±¡ã€‚&lt;/p>
&lt;p>è¿™ç§é€šè¿‡è¿è¡Œæ—¶å®Œæˆä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œä¸ºå•æµ‹æä¾›äº†ä¸€ä¸ªå¾ˆå…³é”®çš„æ‰©å±•å…¥å£ï¼šæˆ‘ä»¬å¯ä»¥åœ¨å•æµ‹åˆå§‹åŒ–æ—¶ä¸º service æ³¨å…¥ &lt;code>repo.MicroBlogRepoIface&lt;/code> æ¥å£çš„å…¶ä»–å®ç°ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°éš”ç¦»çœŸå®æ•°æ®åº“ä¾èµ–çš„ç›®çš„ï¼&lt;/p>
&lt;h2 id="v3-åŸºäºæ¥å£-mock-æ·»åŠ å•æµ‹">v3: åŸºäºæ¥å£ mock æ·»åŠ å•æµ‹&lt;/h2>
&lt;p>é€šè¿‡ v2 ç‰ˆæœ¬çš„é‡æ„ï¼Œé¡¹ç›®ä»£ç å·²ç»ä¸ºå•æµ‹ä»£ç ç¼–å†™æ‰“ä¸‹äº†å¾ˆå¥½çš„åŸºç¡€ã€‚æ˜¾ç„¶ï¼Œå¦‚æœéœ€è¦åœ¨ä¸åŒæµ‹è¯•ç”¨ä¾‹ä¸‹éœ€è¦ &lt;code>repo.MicroBlogRepoIface&lt;/code> çš„å®ç°èƒ½å¤Ÿä¸åŒè¡Œä¸ºæˆ–è€…è¿”å›å€¼ï¼Œæˆ‘ä»¬æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯å¯ä»¥åœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹é‡Œæ‰‹å†™ä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œå¹¶ä¸”è®©å…¶å®ç° &lt;code>repo.MicroBlogRepoIface&lt;/code> çš„æ¯ä¸€ä¸ªæ–¹æ³•å³å¯ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼æ¯”è¾ƒä½æ•ˆï¼Œè€Œä¸”ä¼šå¸¦æ¥ç»´æŠ¤çš„é—®é¢˜ï¼šä¸€æ—¦è¿™ä¸ªæ¥å£çš„å®šä¹‰å˜äº†ï¼Œå°†ä¼šè¦æ±‚æˆ‘ä»¬å°†å•æµ‹ä»£ç ä¸­çš„æ¯ä¸ªå®ç°éƒ½ç›¸åº”è¿›è¡Œä¿®æ”¹ï¼æœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å®ç°æ¥å£çš„ mock ä»£ç çš„è‡ªåŠ¨ç”Ÿæˆå‘¢ï¼Ÿæœ‰çš„ï¼Œ&lt;a href="https://github.com/golang/mock">gomock&lt;/a>ï¼&lt;/p>
&lt;p>gomock æ˜¯ golang å®˜æ–¹ç»´æŠ¤çš„ç”¨äºä¸ºæ¥å£è‡ªåŠ¨ç”Ÿæˆ mock å®ç°çš„å·¥å…·ï¼Œæ–¹ä¾¿å•æµ‹ä¸­å¤ç”¨ mock ä»£ç å®Œæˆè°ƒç”¨æ–­è¨€ã€è¿”å›å€¼å®šåˆ¶ç­‰ã€‚&lt;/p>
&lt;p>åœ¨ &lt;a href="https://github.com/HackerPie/go-microblog/tree/v3">v3 ç‰ˆæœ¬&lt;/a>ä»£ç ä¸­ï¼Œæˆ‘ä»¬å€ŸåŠ© gomock å®ç°äº† mock ä»£ç çš„ç”Ÿæˆï¼Œå¹¶ä¸”åº”ç”¨åˆ°äº†å•æµ‹ä»£ç ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/repo/interfaces.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//go:generate mockgen -destination=./mocks/mock_repo.go -package=repomocks -source=interfaces.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">type&lt;/span> MicroBlogRepoIface &lt;span style="font-weight:bold">interface&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ListUserMBlogs(userID &lt;span style="">int&lt;/span>) ([]*dbModel.MicroBlog, &lt;span style="">error&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> NewUserMBlog(userID &lt;span style="">int&lt;/span>, content &lt;span style="">string&lt;/span>) &lt;span style="">error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/repo/mocks/mock_repo.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> MockMicroBlogRepoIface &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctrl *gomock.Controller
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> recorder *MockMicroBlogRepoIfaceMockRecorder
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">type&lt;/span> MockMicroBlogRepoIfaceMockRecorder &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mock *MockMicroBlogRepoIface
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> NewMockMicroBlogRepoIface(ctrl *gomock.Controller) *MockMicroBlogRepoIface {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (m *MockMicroBlogRepoIface) EXPECT() *MockMicroBlogRepoIfaceMockRecorder {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// ListUserMBlogs indicates an expected call of ListUserMBlogs.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> (mr *MockMicroBlogRepoIfaceMockRecorder) ListUserMBlogs(userID &lt;span style="font-weight:bold">interface&lt;/span>{}) *gomock.Call {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (mr *MockMicroBlogRepoIfaceMockRecorder) NewUserMBlog(userID, content &lt;span style="font-weight:bold">interface&lt;/span>{}) *gomock.Call {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/service/micro_blogs_service_test.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> TestMicroBlogsService_ListUserMBlogs(t *testing.T) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">type&lt;/span> mockRepoReturn &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> list []*dbModel.MicroBlog
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> err &lt;span style="">error&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tests := []&lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name &lt;span style="">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> expectMsg &lt;span style="">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> expectDataLength &lt;span style="">int&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mock mockRepoReturn
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: &lt;span style="font-style:italic">&amp;#34;list is empty&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mock: mockRepoReturn{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> list: []*dbModel.MicroBlog{},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> expectMsg: &lt;span style="font-style:italic">&amp;#34;success&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> _, tt := &lt;span style="font-weight:bold">range&lt;/span> tests {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t.Run(tt.name, &lt;span style="font-weight:bold">func&lt;/span>(t *testing.T) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctrl := gomock.NewController(t)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">defer&lt;/span> ctrl.Finish()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mockRepo := repomocks.NewMockMicroBlogRepoIface(ctrl)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mockRepo.EXPECT().
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ListUserMBlogs(gomock.Eq(1)).
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Return(tt.mock.list, tt.mock.err)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> srv := &amp;amp;MicroBlogsService{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repo: mockRepo, &lt;span style="font-style:italic">// è¿™é‡Œå°† mock çš„å®ç°æ³¨å…¥äº† MicroBlogsService å®ä¾‹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> srv.ListUserMBlogs(c)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬é‡Œï¼Œé¦–å…ˆåœ¨ &lt;code>internal/repo/interfaces.go&lt;/code> ä¸­æ–°å¢äº† go generate æŒ‡ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//go:generate mockgen -destination=./mocks/mock_repo.go -package=repomocks -source=interfaces.go
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯¥æŒ‡ä»¤å°†ä¼šæŒ‡å¼•åç»­çš„ &lt;code>go generate&lt;/code> å‘½ä»¤ï¼Œå°†å½“å‰æ–‡ä»¶é‡Œçš„ interface çš„ mock å®ç°ä¿å­˜åˆ°ç›¸å¯¹äºå½“å‰æ–‡ä»¶çš„ &lt;code>mocks/mock_repo.go&lt;/code> æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨çš„ go åŒ…åä¸º &lt;code>repomocks&lt;/code>ã€‚&lt;/p>
&lt;p>æ¥ç€åœ¨å‘½ä»¤è¡Œé‡Œæ‰§è¡Œ &lt;code>go generate ./...&lt;/code> åï¼Œä¾¿ç¬¦åˆæœŸå¾…åœ°è‡ªåŠ¨ç”Ÿæˆäº† &lt;code>internal/repo/mocks/mock_repo.go&lt;/code> æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°é‡Œé¢çš„ç±»å‹ &lt;code>MockMicroBlogRepoIface&lt;/code> å®ç°äº† &lt;code>repo.MicroBlogRepoIface&lt;/code> æ¥å£ã€‚&lt;/p>
&lt;p>è€Œåœ¨æœ€åçš„å•æµ‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡è¡¨æ ¼é©±åŠ¨æµ‹è¯•çš„é£æ ¼ï¼Œå®šåˆ¶äº†å¯¹åº”æ¯ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸‹çš„ mock å®ç°çš„è¿”å›å€¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>mockRepo := repomocks.NewMockMicroBlogRepoIface(ctrl)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>mockRepo.EXPECT().
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ListUserMBlogs(gomock.Eq(1)).
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Return(tt.mock.list, tt.mock.err) &lt;span style="font-style:italic">// &amp;lt;------- å®šåˆ¶è¿”å›å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹åˆ°æ²¡æœ‰ï¼Ÿè¿™æ¬¡æˆ‘ä»¬çš„å•æµ‹é€»è¾‘é‡Œï¼Œæ˜¯ä¸ç”¨åœ¨æ„æ•°æ®åº“ç›¸å…³çš„ä¸œè¥¿çš„ï¼Œå¯¹äº service å±‚çš„å•æµ‹ä»£ç æ¥è¯´ï¼Œå®ƒåªéœ€è¦å…³æ³¨å®ƒä¾èµ–çš„ &lt;code>repo.MicroBlogRepoIface&lt;/code> æ¥å£çš„ç›´æ¥è¡Œä¸ºå³å¯ï¼Œè‡³äºèƒŒåçš„å®é™…å®ç°ï¼Œåˆ™æ˜¯æ— éœ€å…³å¿ƒçš„å†…å®¹äº†ã€‚å› ä¸ºéš”ç¦»äº†å¯¹ç¯å¢ƒçš„é—´æ¥ä¾èµ–ï¼Œæˆ‘ä»¬æœ‰ä¿¡å¿ƒå¯ä»¥å°†è¿™æ ·çš„å•æµ‹ä»£ç ä¸¢åˆ°å„ç§æ‰§è¡Œç¯å¢ƒä¸­å»è¿è¡Œï¼Œè€Œæ— éœ€æ‹…å¿ƒç¯å¢ƒæ”¹å˜å¯¼è‡´å•æµ‹å¯èƒ½æ‰§è¡Œå¤±è´¥çš„ç¹çé—®é¢˜ã€‚&lt;/p>
&lt;h2 id="v4-ä½¿ç”¨-googlewire-å®ç°ä¾èµ–æ³¨å…¥">v4: ä½¿ç”¨ google/wire å®ç°ä¾èµ–æ³¨å…¥&lt;/h2>
&lt;p>åœ¨ v2 ç‰ˆæœ¬ä»£ç ä¸­ï¼Œæˆ‘ä»¬çš„ &lt;code>buildService&lt;/code> å‡½æ•°ç”¨äºå®ç°ä¾èµ–æ³¨å…¥ï¼Œä½†æ˜¯åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬çš„ä¾èµ–ä¼šå¤æ‚å¾—å¤šï¼Œå¦‚æœä¾é äººå·¥ç¼–å†™è¿™ç§ä¾èµ–æ³¨å…¥ä»£ç ï¼Œä¼šéå¸¸ç¹çæ¯ç‡¥ï¼Œè€Œ &lt;a href="https://github.com/google/wire">google/wire&lt;/a> åˆ™æ˜¯å¯ä»¥ç”¨æ¥å¸®æˆ‘ä»¬æå‡å¹¸ç¦æ„Ÿçš„å·¥å…·ã€‚&lt;/p>
&lt;p>wire æ˜¯ä¸€ä¸ª google å…¬å¸å¼€å‘ç»´æŠ¤çš„ç”¨äºå®ç°ç¼–è¯‘æ—¶ä¾èµ–æ³¨å…¥çš„å·¥å…·ï¼Œå…¶å·¥ä½œçš„æ–¹å¼ä¹Ÿæ˜¯ä»£ç çš„è‡ªåŠ¨ç”Ÿæˆã€‚wire æœ‰ä¸¤ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼šinjector å’Œ providerï¼Œprovider å¯ä»¥ç†è§£å„ç§å¯ä»¥ç”Ÿæˆä¾èµ–ç»„ä»¶å®ä¾‹çš„å·¥å‚å‡½æ•°ï¼Œè€Œ injector åˆ™æ˜¯ç”¨äºå®šä¹‰æœ€ç»ˆä¾èµ–äº§ç‰©çš„å‡½æ•°ï¼Œé€šè¿‡ injector çš„è¿”å›å€¼å®šä¹‰ä»¥åŠé¡¹ç›®ä¸­æä¾›çš„ä¸€ç³»åˆ— providerï¼Œwire èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«å‡ºåº”ç”¨ç»„ä»¶ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå¹¶ä¸”è‡ªåŠ¨ç”Ÿæˆä¾èµ–æ³¨å…¥çš„å®Œæ•´ä»£ç ã€‚ä¸‹é¢çœ‹ &lt;a href="https://github.com/HackerPie/go-microblog/tree/v4">v4 ç‰ˆæœ¬&lt;/a>çš„ç›¸å…³ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// cmd/api_server/main.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> main() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> srv := buildService()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r := gin.Default()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.GET(&lt;span style="font-style:italic">&amp;#34;/users/:user_id/blogs&amp;#34;&lt;/span>, srv.ListUserMBlogs)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.POST(&lt;span style="font-style:italic">&amp;#34;/users/:user_id/blogs&amp;#34;&lt;/span>, srv.PublishNewBlog)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> r.Run(&lt;span style="font-style:italic">&amp;#34;:8000&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// cmd/api_server/wire.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> buildService() *service.MicroBlogsService {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> wire.Build(service.NewMicroBlogsService,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repo.WireSet,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repo.NewDB)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &amp;amp;service.MicroBlogsService{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// cmd/api_server/wire_gen.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> buildService() *service.MicroBlogsService {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db := repo.NewDB()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> microBlogRepoImpl := repo.NewMicroBlogRepoImpl(db)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> microBlogsService := service.NewMicroBlogsService(microBlogRepoImpl)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> microBlogsService
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/repo/wire_set.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">var&lt;/span> WireSet = wire.NewSet(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> NewMicroBlogRepoImpl,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> wire.Bind(new(MicroBlogRepoIface), new(*MicroBlogRepoImpl)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// internal/repo/conn.go
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> NewDB() *gorm.DB {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db, err := gorm.Open(mysql.Open(&lt;span style="font-style:italic">&amp;#34;root@tcp(127.0.0.1:3306)/micro_blog?charset=utf8mb4&amp;amp;parseTime=True&amp;amp;loc=Local&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> err != &lt;span style="font-weight:bold">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> panic(err)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> db
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬å°†åŸæ¥æ‰‹å†™çš„ &lt;code>buildService&lt;/code> å‡½æ•°ä» &lt;code>main.go&lt;/code> æ–‡ä»¶ä¸­æ¸…é™¤äº†ï¼Œå–è€Œä»£ä¹‹çš„ï¼Œåœ¨æ–°çš„ &lt;code>wire.go&lt;/code> æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª wire injector &lt;code>buildService&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> buildService() *service.MicroBlogsService {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> wire.Build(service.NewMicroBlogsService,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repo.WireSet,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repo.NewDB)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &amp;amp;service.MicroBlogsService{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ä¹‹å‰æ‰‹å†™ä»£ç ä¸åŒçš„æ˜¯ï¼Œè¿™é‡Œé€šè¿‡ &lt;code>wire.Build&lt;/code> æŒ‡æ˜äº†ç”¨äºå®ç°å®Œæ•´ä¾èµ–æ³¨å…¥æ‰€éœ€çš„æ‰€æœ‰ providerï¼Œæ‰€ä»¥è¿™é‡Œçš„ &lt;code>service.NewMicroBlogsService&lt;/code> å’Œ &lt;code>repo.NewDB&lt;/code> éƒ½æ˜¯ providerï¼Œè€Œ &lt;code>repo.WireSet&lt;/code> åˆ™æ˜¯ä¸€ä¸ª provider setï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">var&lt;/span> WireSet = wire.NewSet(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> NewMicroBlogRepoImpl,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> wire.Bind(new(MicroBlogRepoIface), new(*MicroBlogRepoImpl)),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>wire.NewSet&lt;/code> ç”¨äºå®šä¹‰ä¸€ç»„ provider çš„é›†åˆï¼Œå¥½å¤„æ˜¯æ–¹ä¾¿æ‰“åŒ…ä½¿ç”¨ï¼Œè¿™æ ·å°±ä¸ç”¨åœ¨ injector ä¸­é‡å¤ç½—åˆ—è¿™äº› providerã€‚è€Œ &lt;code>wire.Bind&lt;/code> åˆ™æ˜¯ç”¨äºæç¤º wireï¼š&lt;code>MicroBlogRepoImpl&lt;/code> ç±»å‹å®ç°äº† &lt;code>MicroBlogRepoIface&lt;/code> æ¥å£ï¼Œåº”è¯¥åœ¨ä¾èµ–æ³¨å…¥è¿‡ç¨‹ä¸­å°† &lt;code>MicroBlogRepoImpl&lt;/code> æ³¨å…¥ç»™æ‰€æœ‰ä¾èµ– &lt;code>MicroBlogRepoIface&lt;/code> æ¥å£çš„ç»„ä»¶ã€‚&lt;/p>
&lt;p>é€šè¿‡ wireï¼Œå‡è½»äº†æˆ‘ä»¬çš„ä¾èµ–æ³¨å…¥çš„è´Ÿæ‹…ï¼Œè®©è¿™ç§åº”ç”¨æ¶æ„å˜å¾—æ›´ç§°æ‰‹ã€‚&lt;/p>
&lt;h2 id="å…¶ä»–ç»„ä»¶-mock-çš„æ€è·¯">å…¶ä»–ç»„ä»¶ mock çš„æ€è·¯&lt;/h2>
&lt;p>ç”±äºæ˜¯ç¤ºä¾‹é¡¹ç›®ï¼Œä¸Šé¢çš„å†…å®¹æœ€æ ¸å¿ƒçš„å†…å®¹ï¼Œè¿˜æ˜¯åœ¨äºé€šè¿‡ä¾èµ–å€’ç½®çš„åŸåˆ™ï¼Œå°†åº”ç”¨å†…åˆ†å±‚ä¹‹é—´çš„è€¦åˆåˆ†ç¦»ï¼Œè®©å•å…ƒæµ‹è¯•æœ‰æ–½å±•çš„ç©ºé—´ã€‚ä½†æ˜¯ï¼Œå®é™…é¡¹ç›®ç”±äºå¤æ‚åº¦ç­‰ï¼Œé™¤äº†åˆ†å±‚æ¥å£çš„ mockï¼Œè¿˜å¯èƒ½ä¼šé‡åˆ°çš„æƒ…å†µæ˜¯å¯¹ç›¸åŒç»„ä»¶å†…éƒ¨çš„å…¶ä»–æ–¹æ³•æˆ–è€…å‡½æ•°çš„ä¾èµ–ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒåŸºäºæ¥å£çš„ä¾èµ–å€’ç½®æ²¡æœ‰å‘æŒ¥çš„ç©ºé—´ã€‚ä½œä¸ºè§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä¼šæ…é‡å¼•å…¥ &lt;a href="https://github.com/bouk/monkey">bouk/monkey&lt;/a> ä»¥çŒ´å­è¡¥ä¸çš„å½¢å¼åœ¨å•æµ‹ä¸­ä¸´æ—¶æ›¿æ¢è¢«ä¾èµ–å‡½æ•°æˆ–è€…æ–¹æ³•çš„å®ç°ã€‚&lt;/p>
&lt;h3 id="æ•°æ®åº“ä¾èµ–çš„é—®é¢˜">æ•°æ®åº“ä¾èµ–çš„é—®é¢˜&lt;/h3>
&lt;p>å‰é¢åœ¨ä»‹ç»é‡æ„å’Œå•æµ‹çš„è¿‡ç¨‹ä¸­ï¼Œå…¶å®æ²¡æœ‰è®²åˆ° repo å±‚è‡ªèº«çš„å•æµ‹çš„é—®é¢˜ã€‚è€Œå¦‚æœè€ƒè™‘ repo å±‚çš„å•æµ‹çš„è¯ï¼Œå°±éœ€è¦è§£å†³å¯¹ &lt;code>*gorm.DB&lt;/code> çš„ä¾èµ–çš„é—®é¢˜ï¼Œå› ä¸º &lt;code>gorm.DB&lt;/code> ä¸æ˜¯ä¸€ä¸ªæ¥å£å®šä¹‰ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡ mock ä»£ç ç”Ÿæˆçš„æ–¹å¼æ¥è§£å†³ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ‰ä¸¤ç§æ€è·¯ï¼š&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨ sqlite è¿™ç§æœ¬åœ°æ–‡ä»¶å‹æ•°æ®åº“&lt;/li>
&lt;li>ä½¿ç”¨ &lt;a href="DATA-DOG/go-sqlmock">go-sqlmock&lt;/a> è¿™ç±»ç”¨äº mock æ•°æ®è¿æ¥å±‚çš„å·¥å…·åº“&lt;/li>
&lt;/ul>
&lt;p>ç”±äº sqlite æœ¬è´¨ä¸Šè¿˜æ˜¯ç‰©ç†æ•°æ®åº“ï¼Œè€Œä¸”æœ‰é€ æ•°æ®å’Œæ¸…ç†æ•°æ®çš„è´Ÿæ‹…ï¼Œæˆ‘ä¸å¤§ä¼šä½œä¸ºé¦–é€‰çš„å·¥å…·ã€‚è€Œå¦‚æœä½¿ç”¨ sqlmockï¼Œåˆ™å¯ä»¥å¾ˆè½»æ¾åœ°å°† gorm ä¾èµ–çš„æ•°æ®åº“è¿æ¥è¿›è¡Œæ›¿æ¢ï¼Œè¿›è€Œå®ç° mock æ•°æ®åº“å±‚çš„ç›®çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>db, mock, err := sqlmock.New()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>gormDB := gorm.Open(db) &lt;span style="font-style:italic">// &amp;lt;---- æ³¨å…¥ sqlmockï¼Œä½œä¸º gorm.DB çš„ä¾èµ–
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>repo := NewMicroBlogRepoImpl(gormDB)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è¿œç¨‹è°ƒç”¨ä¾èµ–çš„é—®é¢˜">è¿œç¨‹è°ƒç”¨ä¾èµ–çš„é—®é¢˜&lt;/h3>
&lt;p>å·¥ç¨‹å®è·µä¸­ï¼Œå¦ä¸€ç±»å¸¸è§çš„ä¾èµ–ï¼Œå°±æ˜¯è¿œç¨‹è°ƒç”¨çš„ä¾èµ–ï¼Œæ—¢åŒ…å« HTTP åè®®æœåŠ¡çš„ä¾èµ–ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»– rpc æœåŠ¡çš„ä¾èµ–ã€‚å¦‚æœæ˜¯ HTTP ç±»æœåŠ¡çš„ä¾èµ–ï¼Œå¯ä»¥å€ŸåŠ© &lt;a href="https://github.com/jarcoal/httpmock">httpmock&lt;/a> å®ç° mockã€‚è€Œå¯¹äº rpc ç±»æœåŠ¡ï¼Œåˆ™æœ€å¥½æœŸå¾…ç›¸å…³ rpc æ¡†æ¶åœ¨ç”Ÿæˆåè®®æ¡©ä»£ç çš„æ—¶å€™ï¼Œèƒ½å¤Ÿé¡ºä¾¿æä¾›ç›¸å…³çš„æ¥å£å®šä¹‰ï¼Œè¿˜æ˜¯åŒæ ·çš„åŸåˆ™ï¼šä¾èµ–æ¥å£ï¼Œä¸ä¾èµ–å…·ä½“å®ç°ï¼&lt;/p>
&lt;h2 id="å…¶ä»–å¯èƒ½å½±å“ä»£ç å¯æµ‹è¯•æ€§çš„å› ç´ ">å…¶ä»–å¯èƒ½å½±å“ä»£ç å¯æµ‹è¯•æ€§çš„å› ç´ &lt;/h2>
&lt;p>ä¸Šé¢çš„æ€è€ƒï¼Œæ›´å¤šçš„æ˜¯æ€è€ƒå¦‚ä½•å®ç°å•æµ‹æœ€å°åŒ–ä¾èµ–çš„é—®é¢˜ï¼Œé¿å…ä¾èµ–é—®é¢˜æˆä¸ºå•æµ‹æ‰§è¡Œçš„é˜»ç¢ä»¥åŠä¸ç¨³å®šå› ç´ ã€‚è€Œå¦‚æœæ”¾å¼€ç‚¹æ€è€ƒï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–å› ç´ åŒæ ·ä¼šé™ä½ä»£ç çš„å¯æµ‹è¯•æ€§ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>å…¨å±€å˜é‡&lt;/strong>ï¼šå…¨å±€å˜é‡ç ´åäº†å•æµ‹ç”¨ä¾‹çš„ç›¸äº’ç‹¬ç«‹æ€§ï¼›&lt;/li>
&lt;li>&lt;strong>å‡½æ•°æˆ–æ–¹æ³•çš„å¤æ‚åº¦&lt;/strong>ï¼šå› ä¸ºå•æµ‹çš„å¯¹è±¡æ˜¯ä¸€ä¸ªè¶³å¤Ÿå°çš„é€»è¾‘å•å…ƒï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°æˆ–è€…æ–¹æ³•åŒ…å«äº†å¤ªå¤šçš„é€»è¾‘ï¼Œä¹Ÿä¼šåŒæ—¶å¾ˆå¤§ç¨‹åº¦åŠ å¤§å•æµ‹çš„å¤æ‚åº¦ï¼Œå¦‚æœæ¶‰åŠåˆ°å¤šä¸ªæ¥å£çš„ mockï¼Œè¿˜éœ€è¦è€ƒè™‘å¤šç§ mock ç»„åˆçš„è®¾è®¡ï¼Œæˆ‘ä»¬å°½å¯èƒ½ç®€åŒ–å•ä¸ªå‡½æ•°æˆ–è€…æ–¹æ³•çš„é€»è¾‘ï¼Œè®©ä¹˜æ³•ï¼ˆmockç»„åˆï¼‰å˜æˆç®€å•çš„åŠ æ³•ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å…¶ä»–æ€è€ƒ">å…¶ä»–æ€è€ƒ&lt;/h2>
&lt;p>å€¼å¾—è®°ä½çš„æ˜¯ï¼Œå•æµ‹å¹¶ä¸æ˜¯é“¶å¼¹ï¼Œå“ªæ€•å•æµ‹æµ‹è¯•è¦†ç›–ç‡å·²ç»è¾¾åˆ° 100%ï¼Œä¹Ÿä¸èƒ½ä»…å‡­å•æµ‹ç»“æœè¯æ˜ç³»ç»Ÿæ˜¯å®Œå…¨ç¬¦åˆé¢„æœŸçš„ã€‚å› ä¸ºå•æµ‹ä¸­å¯¹ç¯å¢ƒçš„éš”ç¦»ï¼Œä»¥åŠå•æµ‹æœªèƒ½è¦†ç›–ç»„ä»¶ä¹‹é—´ç»„è£…èµ·æ¥ä¹‹åè¿è¡Œçš„åœºæ™¯ï¼Œè¿™äº›é—®é¢˜éƒ½åªèƒ½äº¤ç»™é›†æˆæµ‹è¯•ç¯èŠ‚æ¥ä¿éšœã€‚ä½†æ˜¯è¯è¯´å›æ¥ï¼Œåœ¨å¾ˆå¤šäººéƒ½ä¸å†™æˆ–è€…å†™ä¸å¥½å•æµ‹çš„æƒ…å†µä¸‹ï¼Œèƒ½å¤ŸåšæŒå†™å¥½å•æµ‹çš„è¯ï¼Œå°±å·²ç»å¯ä»¥è·‘èµ¢å¾ˆå¤šäººäº†ã€‚&lt;/p>
&lt;p>ä¸ mock çš„æ–¹å¼ç›¸å¯¹çš„ï¼Œæœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬ä»ç„¶å¸Œæœ›åŸºäºçœŸå®çš„æ•°æ®åº“ç¯å¢ƒè¿è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œä½†æ˜¯ä¸ºäº†æµ‹è¯•ç”¨ä¾‹å¯ä»¥é‡å¤æ‰§è¡Œè€Œä¿æŒç¨³å®šçš„ç»“æœï¼Œéœ€è¦è€ƒè™‘å¦‚ä½•å®ç°æµ‹è¯•æ•°æ®çš„è£…è½½å’Œæ¸…ç†é—®é¢˜ã€‚å‚ç…§ Rails ä¸­çš„ &lt;code>test fixtures&lt;/code>ï¼Œæˆ‘ä¹Ÿå°è¯•è¿‡ç¼–å†™äº† golang ç‰ˆæœ¬çš„ &lt;a href="https://github.com/martin91/gofixtures">gofixtures&lt;/a>ï¼Œå…¶åŸç†æ˜¯å®ç° &lt;code>sql.Driver&lt;/code> æ¥å£ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•ç”¨ä¾‹å¯åŠ¨æ—¶å¼€å¯å…¨å±€äº‹åŠ¡ï¼Œåœ¨å®Œæˆæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œä¹‹åï¼Œå†å›æ»šè¿™ä¸ªå…¨å±€äº‹åŠ¡ï¼Œè€Œè¾¾åˆ°æ•°æ®å›æ»šçš„ç›®çš„ã€‚&lt;/p>
&lt;p>æœ€åä¸€ç‚¹æ€è€ƒæ˜¯ï¼Œå¦‚æœæƒ³è¦å†™å¥½å•æµ‹ï¼Œå°±åº”è¯¥è·Ÿå¯¹å¾…å…¶ä»–åŠŸèƒ½æ€§ä»£ç ä¸€æ ·çœ‹å¾…å•æµ‹ï¼Œå°†å•æµ‹çš„æ”¯æŒä¸€å¹¶è€ƒè™‘åˆ°é¡¹ç›®ä»£ç çš„è®¾è®¡ä¸­å»ï¼Œä¹Ÿå°±æ˜¯å†™ä»£ç é™¤äº†è¿½æ±‚å¸¸è§çš„æ˜“è¯»æ€§ã€å¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§ï¼Œè¿˜å¾—è¿½æ±‚æµ‹è¯•å‹å¥½æ€§ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://blog.hackerpie.com/posts/2021/dependency-inversion-principle-introduce/">ä¾èµ–å€’ç½®åŸåˆ™&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://medium.com/@rosaniline/unit-testing-gorm-with-go-sqlmock-in-go-93cbce1f6b5b">Unit testing GORM with go-sqlmock in Go&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/martin91/gofixtures">gofixtures&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/google/wire">google/wire&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/golang/mock">golang/mock&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/bouk/monkey">bouk/monkey&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/jarcoal/httpmock">httpmock&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>MySQL + go å¦‚ä½•å®‰å…¨å¤„ç† decimal ç±»å‹æ•°æ®</title><link>https://blog.hackerpie.com/posts/mysql/handle-decimal-fields/</link><pubDate>Wed, 02 Mar 2022 18:31:18 +0800</pubDate><guid>https://blog.hackerpie.com/posts/mysql/handle-decimal-fields/</guid><description>&lt;p>åœ¨ç”µå•†æˆ–è€…é‡‘èç›¸å…³çš„åœºæ™¯ä¸­ï¼Œå•†å“ä»·æ ¼ç­‰æ•°æ®éƒ½ä¼šæ¶‰åŠåˆ°å°æ•°çš„è¡¨ç¤ºæˆ–è€…è®¡ç®—ï¼Œå¦‚æœä½¿ç”¨ç¼–ç¨‹è¯­è¨€å†…ç½®çš„æµ®ç‚¹æ•°ç±»å‹ï¼Œä¼šæœ‰ç²¾åº¦ä¸¢å¤±çš„é£é™©ã€‚åœ¨åº”ç”¨é¢†åŸŸï¼Œ&lt;code>decimal&lt;/code> ç±»å‹åº”è¿è€Œç”Ÿï¼ŒMySQL æ•°æ®åº“ä¸­å†…ç½®æ”¯æŒ &lt;code>decimal&lt;/code> æ•°æ®ç±»å‹ï¼Œè€Œç¨‹åºè®¾è®¡ä¸Šï¼Œä¸€èˆ¬ç¼–ç¨‹è¯­è¨€éƒ½ä¼šæœ‰æ ‡å‡†åº“æˆ–è€…ç¬¬ä¸‰æ–¹åº“å¯¹ &lt;code>decimal&lt;/code> ç±»å‹æä¾›å®ç°ã€‚æœ¬æ–‡å¿«é€Ÿå±•ç¤ºä¸‹å¦‚ä½•å®ç°å…¨é“¾è·¯å¯¹ &lt;code>decimal&lt;/code> ç±»å‹æ•°æ®çš„è¯»å–å¤„ç†ï¼Œè€Œä¸ç”¨æ‹…å¿ƒä¼šä¸¢å¤±æ•°æ®çš„ç²¾åº¦ã€‚&lt;/p>
&lt;h2 id="æ•°æ®åº“å±‚---mysql">æ•°æ®åº“å±‚ - MySQL&lt;/h2>
&lt;p>åœ¨ MySQL å±‚ï¼Œ&lt;code>decimal&lt;/code> ç±»å‹çš„å€¼ä½¿ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºï¼Œå…¶å¤§è‡´è½¬æ¢è¿‡ç¨‹æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>å°†å¾…å­˜å‚¨çš„æ•°æ®æŒ‰ç…§æ•´æ•°å’Œå°æ•°éƒ¨åˆ†ä¸€åˆ†ä¸ºäºŒï¼Œæ¯”å¦‚ &lt;code>1234567890.1234&lt;/code>ï¼Œåˆ†ä¸º &lt;code>1234567890&lt;/code> å’Œ &lt;code>1234&lt;/code>ï¼›&lt;/li>
&lt;li>é’ˆå¯¹æ•´æ•°éƒ¨åˆ†ï¼Œä»ä½ä½åˆ°é«˜ä½ï¼ŒæŒ‰ç…§æ¯ 9 ä½æ•°å­—ä¸ºä¸€ç»„ï¼Œè¿›è¡Œåˆ†å‰²ï¼Œæ¯”å¦‚ &lt;code>1234567890&lt;/code> å°†åˆ†ä¸º &lt;code>1&lt;/code> å’Œ &lt;code>234567890&lt;/code>ï¼›&lt;/li>
&lt;li>ä½¿ç”¨æœ€çŸ­å­—èŠ‚åºåˆ—åˆ†åˆ«è¡¨ç¤ºæ¯ä¸ªåˆ†ç»„çš„æ•´æ•°ï¼Œä¸Šé¢çš„ &lt;code>1&lt;/code> å³ &lt;code>0b00000001&lt;/code>ï¼Œè€Œ &lt;code>234567890&lt;/code> åˆ™å¯¹åº” &lt;code>0x0D-FB-38-D2&lt;/code>ï¼›&lt;/li>
&lt;li>å¯¹äºå°æ•°éƒ¨åˆ†ï¼Œä½¿ç”¨ç±»ä¼¼çš„åˆ†ç»„ï¼ˆä»é«˜ä½åˆ°ä½ä½ï¼‰å¤„ç†æ–¹å¼ï¼Œå³ 1234 è¡¨ç¤ºä¸º &lt;code>0x04D2&lt;/code>ï¼›&lt;/li>
&lt;li>æœ€åï¼Œå°†æœ€é«˜ä½ç½®åï¼Œå¾—åˆ° &lt;code>0x81 0D FB 38 D2 04 D2&lt;/code>ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº† 7 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºè¿™ä¸ªæ•°å­—ã€‚&lt;/li>
&lt;/ol>
&lt;p>Bonus: å¦‚æœæ˜¯å°æ•°ï¼Œæ¯”å¦‚ &lt;code>-1234567890.1234&lt;/code>ï¼Œåˆ™åªéœ€è¦å°†ä¸Šé¢ç¬¬ 5 æ­¥çš„æ‰€æœ‰ä½ç½®åå³å¯ï¼Œä¹Ÿå°±æ˜¯ &lt;code>0x7E F2 04 C7 2D FB 2D&lt;/code>&lt;/p>
&lt;h3 id="å°ç»“">å°ç»“&lt;/h3>
&lt;p>MySQL é€šè¿‡è®¾è®¡å·§å¦™çš„å¯å˜é•¿åº¦çš„äºŒè¿›åˆ¶è½¬æ¢ï¼Œå®ç°äº†å¯¹ä¸¥æ ¼è¦æ±‚ç²¾åº¦çš„å°æ•°çš„è¡¨ç¤ºã€‚&lt;/p>
&lt;h2 id="ç½‘ç»œä¼ è¾“å±‚---mysql">ç½‘ç»œä¼ è¾“å±‚ - MySQL&lt;/h2>
&lt;p>å­˜å‚¨åœ¨ MySQL åº•å±‚å­˜å‚¨ä¸Šçš„ decimalï¼Œæˆ‘ä»¬çŸ¥é“æ˜¯äºŒè¿›åˆ¶äº†ä¹‹åï¼Œä¹Ÿå°±å¯¹ç²¾åº¦é—®é¢˜çš„æŒä¹…åŒ–å­˜å‚¨æ”¾å¿ƒäº†ï¼Œä½†æ˜¯ï¼Œåˆå¸¦æ¥ä¸¤ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>æ•°æ®ç»è¿‡äºŒè¿›åˆ¶è½¬æ¢ä¹‹åï¼Œå¦‚æœå°†è¿™ä¸ªå­—èŠ‚åºåˆ—ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯æ˜¾ç„¶æ˜¯ä¸èƒ½ç†è§£çš„ï¼Œè€Œä¸”è€¦åˆäº†è½¬æ¢é€»è¾‘ï¼Œæ˜¾ç„¶æ˜¯éœ€è¦ MySQL æœåŠ¡å™¨åšä¸€æ¬¡åå‘çš„ä»äºŒè¿›åˆ¶æ•°æ®åˆ°çœŸå®å°æ•°çš„è½¬æ¢ï¼›&lt;/li>
&lt;li>è½¬æ¢åçš„æ•°æ®åœ¨æ•°æ®åº“è¿æ¥ä¸­çš„ä¼ è¾“ï¼ŒMySQL åˆæ˜¯å¦‚ä½•ä¿è¯å®‰å…¨å‘¢ï¼Ÿ&lt;/li>
&lt;/ol>
&lt;p>ç­”æ¡ˆå¾ˆç®€å•ï¼šçº¯æ–‡æœ¬ã€‚&lt;/p>
&lt;p>é€šè¿‡å¯¹ MySQL è¿æ¥è¿›è¡ŒæŠ“åŒ…ï¼Œå¯ä»¥ç¡®è®¤è¿™ä¸€ç‚¹ï¼Œæˆªå›¾æ˜¯é€šè¿‡ Wireshark æŠ“åŒ… MySQL æœåŠ¡å™¨è¿”å›çš„ decimal æ•°æ®ï¼š&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/decimal/mysql_protocol.png" alt="screenshot">
&lt;figcaption>MySQL æœåŠ¡å™¨å“åº”çš„ decimal ç±»å‹æ•°æ®æ˜¯çº¯æ–‡æœ¬&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h3 id="å°ç»“-1">å°ç»“&lt;/h3>
&lt;p>å› ä¸ºä½¿ç”¨äº†çº¯æ–‡æœ¬ä¼ è¾“æ•°æ®ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒå°æ•°åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¼šæœ‰ç²¾åº¦é—®é¢˜&lt;/p>
&lt;h2 id="åº”ç”¨å±‚---golang">åº”ç”¨å±‚ - Golang&lt;/h2>
&lt;p>åœ¨æˆ‘çš„åº”ç”¨ç¨‹åºé‡Œï¼Œæˆ‘ä½¿ç”¨äº† golang æ¥å¼€å‘ç¨‹åºï¼Œä¾èµ–äº† &lt;a href="https://github.com/shopspring/decimal">shopspring/decimal&lt;/a> åŒ…æ¥å¤„ç† decimal ç±»å‹ï¼Œè€Œä¸”å®ƒåŒæ—¶å®ç°äº† &lt;a href="https://pkg.go.dev/database/sql#Scanner">sql.Scanner&lt;/a> æ¥å£ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘å¯ä»¥ç›´æ¥ç”¨å®ƒå®Œæˆå¯¹æ•°æ®åº“æŸ¥è¯¢è¿”å›æ•°æ®çš„ååºåˆ—åŒ–ã€‚æ¯”å¦‚æˆ‘çš„ä»£ç é‡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// Order ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> Order &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> OrderNo &lt;span style="">string&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> PurchaseAmount decimal.Decimal
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Status &lt;span style="">uint8&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>order := new(Order)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>db.Where(&lt;span style="font-style:italic">&amp;#34;order_no = ?&amp;#34;&lt;/span>, orderNo).First(order).Error
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸éœ€è¦é¢å¤–çš„é€»è¾‘ï¼Œ&lt;code>PurchaseAmount&lt;/code> èƒ½å¤Ÿç²¾ç¡®åœ°ååºåˆ—åŒ– decimal ç±»å‹çš„æ•°æ®ã€‚&lt;/p>
&lt;p>å°½ç®¡å¦‚æ­¤ï¼Œæˆ‘è¿˜æ˜¯çœ‹äº†ä¸‹ shopspring/decimal åŒ…é‡Œå¯¹ &lt;code>Scanner&lt;/code> æ¥å£çš„å®ç°ï¼Œä»¥ç¡®è®¤å®ƒç¡®å®æ˜¯å®‰å…¨çš„ï¼š&lt;/p>
&lt;p>é¦–å…ˆï¼Œæˆ‘åœ¨æºç å¤„åŠ äº†ä¸¤è¡Œä»£ç ï¼Œä»¥æ–¹ä¾¿æˆ‘ç¡®è®¤åº•å±‚æ•°æ®çš„ç±»å‹ï¼Œç¡®è®¤ååºåˆ—å‰ï¼Œæ˜¯ä¸€ä¸ªå­—èŠ‚åºåˆ—ï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/decimal/decimal_type.png" alt="screenshot">
&lt;figcaption>decimal è·å–çš„valueçš„ç±»å‹æ˜¯å­—èŠ‚åºåˆ—&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;p>ä¹‹åï¼Œæˆ‘è·Ÿè¸ªäº†ä»£ç çš„æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ° decimal åŒ…æŒ‰ç…§å­—ç¬¦ä¸²çš„æ–¹å¼å¯¹æ•°æ®ç›´æ¥è¿›è¡Œäº†ååºåˆ—åŒ–ï¼š
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/decimal/decimal_string.png" alt="screenshot">
&lt;figcaption>decimal æŒ‰ç…§å¤„ç†å­—ç¬¦ä¸²çš„æ–¹å¼å®Œæˆååºåˆ—åŒ–&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h2 id="ç½‘ç»œä¼ è¾“å±‚---protobuf">ç½‘ç»œä¼ è¾“å±‚ - protobuf&lt;/h2>
&lt;p>è€ƒè™‘åˆ°æ•´æ•°çš„æº¢å‡ºä»¥åŠæµ®ç‚¹æ•°ç²¾åº¦æŸå¤±é£é™©ï¼Œæˆ‘åœ¨å¯¹å¤–æœåŠ¡çš„åè®®è§„èŒƒä¸Šï¼Œä¹Ÿéƒ½ç»Ÿä¸€ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹ã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code class="language-pb" data-lang="pb">message Order {
string order_no = 1;
string purchase_amount = 2;
status int32 = 3;
}
&lt;/code>&lt;/pre>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;ul>
&lt;li>MySQL åº•å±‚ä½¿ç”¨å¯å˜é•¿åº¦çš„äºŒè¿›åˆ¶è¡¨ç¤º decimal ç±»å‹æ•°æ®ï¼›&lt;/li>
&lt;li>MySQL åœ¨ç½‘ç»œä¼ è¾“ä¸­ä½¿ç”¨çº¯æ–‡æœ¬è¡¨ç¤º decimal ç±»å‹æ•°æ®ï¼›&lt;/li>
&lt;li>Golang ç¨‹åºä¸­å€ŸåŠ© &lt;code>shopspring/decimal&lt;/code> å®ç° decimal ç±»å‹æ•°æ®çš„å¤„ç†ï¼›&lt;/li>
&lt;li>&lt;code>shopspring/decimal&lt;/code> åº•å±‚ä½¿ç”¨äº†ç§‘å­¦è®¡æ•°æ³•è¡¨ç¤º decimalï¼Œä½†æ˜¯æœ¬æ–‡å°±ä¸å±•å¼€äº†ï¼›&lt;/li>
&lt;li>åº”ç”¨å¯¹å¤–æœåŠ¡åè®®ä½¿ç”¨å­—ç¬¦ä¸²è¡¨ç¤º decimal ç±»å‹æ•°æ®ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="æ€è€ƒ">æ€è€ƒ&lt;/h2>
&lt;ul>
&lt;li>ä½¿ç”¨å­—ç¬¦ä¸²è¡¨ç¤º decimal ç±»å‹æ•°æ®å¯èƒ½å¸¦æ¥æ›´å¤šçš„å­—èŠ‚æ•°é‡ã€‚&lt;/li>
&lt;/ul></description></item><item><title>å½“åå°„ map[string]interface{} é‡ä¸Š MapIndex æ–¹æ³•ï¼Œè¿”å›å€¼çš„ Kind ä¸æ˜¯å…·ä½“ç±»å‹ï¼Ÿ</title><link>https://blog.hackerpie.com/posts/reflect/why-reflect-map-index-function-returns-interface/</link><pubDate>Sat, 19 Feb 2022 15:38:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/reflect/why-reflect-map-index-function-returns-interface/</guid><description>&lt;h2 id="ä»€ä¹ˆæ˜¯åå°„">ä»€ä¹ˆæ˜¯åå°„ï¼Ÿ&lt;/h2>
&lt;p>åå°„æ˜¯ä¸€ç§åœ¨è¿è¡Œæ—¶ç”¨äºæ¢æµ‹ç”šè‡³ä¿®æ”¹å†…å­˜æ•°æ®ä»¥åŠç¨‹åºè¡Œä¸ºçš„æœºåˆ¶ï¼Œåœ¨ go è¯­è¨€ä¸­é€šè¿‡ &lt;code>reflect&lt;/code> åŒ…å®ç°ã€‚ç›´ç™½æ¥è¯´ï¼Œåˆ©ç”¨åå°„ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åŒ…æ‹¬ä½†ä¸é™äºçš„ä»¥ä¸‹è¿™äº›åœºæ™¯ï¼š&lt;/p>
&lt;ul>
&lt;li>æ•°æ®çš„ååºåˆ—åŒ–ï¼Œæ¯”å¦‚ jsonã€yaml ç­‰æ ¼å¼æ•°æ®ä»çº¯æ–‡æœ¬åˆ°å†…å­˜æ•°æ®ç»“æ„çš„ååºåˆ—åŒ–è¿‡ç¨‹&lt;/li>
&lt;li>åŠ¨æ€ä¿®æ”¹å†…å­˜ä¸­çš„æ•°æ®ï¼Œæ¯”å¦‚åˆ›å»ºæ–°çš„å­—å…¸æ•°æ®ã€ä¿®æ”¹ç»“æ„ä½“çš„å­—æ®µçš„å€¼ç­‰&lt;/li>
&lt;li>åŠ¨æ€è°ƒç”¨å¯¹è±¡çš„æŸä¸ªæ–¹æ³•æˆ–è€…åŒ…é‡Œçš„æŸä¸ªå‡½æ•°ç­‰&lt;/li>
&lt;li>æ£€æŸ¥æ•°æ®çš„ç±»å‹ä»¥åŠå¯¹è±¡çš„æ–¹æ³•åˆ—è¡¨ç­‰&lt;/li>
&lt;/ul>
&lt;h2 id="æ‰€ä»¥è¿™æ¬¡æƒ³è¯´ä»€ä¹ˆé—®é¢˜å‘¢">æ‰€ä»¥ï¼Œè¿™æ¬¡æƒ³è¯´ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ&lt;/h2>
&lt;p>ä»Šå¤©æƒ³åˆ†äº«çš„ï¼Œæ˜¯æˆ‘å‰å‡ å¤©åœ¨ä¸€ä¸ªä½¿ç”¨ golang åå°„åŠŸèƒ½å¯¹ map[string]interface{} ç±»å‹çš„æ•°æ®åšå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°çš„ä¸€ä¸ªåç›´è§‰çš„é—®é¢˜ã€‚ä¸‹é¢æ˜¯ç›¸å…³ä»£ç ç‰‡æ–­ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>myData := &lt;span style="font-weight:bold">map&lt;/span>[&lt;span style="">string&lt;/span>]&lt;span style="font-weight:bold">interface&lt;/span>{}{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>json.Unmarshal(&lt;span style="font-style:italic">&amp;#34;{\&amp;#34;name\&amp;#34;: \&amp;#34;martin\&amp;#34;, \&amp;#34;score\&amp;#34;: 99}&amp;#34;&lt;/span>, &amp;amp;myData)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>HandleData(myData) &lt;span style="font-style:italic">// è¿›è¡Œæ•°æ®çš„å¤„ç†è¿‡ç¨‹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> HandleData(data &lt;span style="font-weight:bold">interface&lt;/span>{}) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> value := reflect.ValueOf(data)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ... å…¶ä»–ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> keyValue := value.MapIndex(reflect.ValueOf(&lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>)) &lt;span style="font-style:italic">// ä»æ•°æ®ä¸­å–å¯¹åº”é”® name çš„å€¼ï¼Œåº”è¯¥ä¸º &amp;#34;martin&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">switch&lt;/span> keyValue.Kind() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">case&lt;/span> reflect.String:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> doSth()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ... å…¶ä»– caseï¼Œä½†æ˜¯éƒ½æ²¡æœ‰åŒ…å« reflect.Interface çš„åŒ¹é…
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ... å…¶ä»–åç»­ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ç¼–å†™ä¸Šé¢çš„ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘æœŸå¾…ç¨‹åºä¼šè¿›å…¥ &lt;code>case reflect.String:&lt;/code> çš„é€»è¾‘åˆ†æ”¯è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯äº‹å®ä¸Šï¼Œå¹¶æ²¡æœ‰ã€‚åœ¨ç½‘ä¸Šæœç´¢äº†ä¸€ç•ªä¹‹åï¼ŒStackOverflow ä¸Šçš„è¿™ä¸ª&lt;a href="https://stackoverflow.com/questions/14142667/reflect-value-mapindex-returns-a-value-different-from-reflect-valueof">é—®ç­”&lt;/a>ç»™å‡ºäº†å¯ä»¥å¥æ•ˆçš„æ–¹æ³•ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>keyValue := reflect.ValueOf(value.MapIndex(reflect.ValueOf(&amp;#34;name&amp;#34;)).Interface())
&lt;/code>&lt;/pre>&lt;p>å¾ˆå¥‡æ€ªå•Šï¼ &lt;code>(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»&lt;/code>&lt;br>
å¤§å®¶åº”è¯¥éƒ½çŸ¥é“ï¼Œ&lt;code>reflect.ValueOf&lt;/code> å’Œ &lt;code>reflect.Interface()&lt;/code> æ˜¯ä¸€å¯¹ç›¸åçš„æ“ä½œå•Šï¼ˆçœ‹ä¸‹å›¾å³ä¾§éƒ¨åˆ†ï¼‰ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç»•ä¸€åœˆï¼Œè€Œä¸”ç»•å®Œè¿˜çœŸçš„å¯ä»¥äº†ï¼Ÿ&lt;/p>
&lt;p>
&lt;figure>
&lt;img src="https://blog.hackerpie.com/images/posts/reflect/golang-bidirectional-reflection.png" alt="test">
&lt;figcaption>å›¾ç‰‡æ¥è‡ªã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹åšå®¢ï¼Œhttps://draveness.me/golang&lt;/figcaption>
&lt;/figure>
&lt;/p>
&lt;h2 id="å‡ºå‘ä¹‹å‰è®©æˆ‘å‡†å¤‡ä¸ªå°-demo">å‡ºå‘ä¹‹å‰ï¼Œè®©æˆ‘å‡†å¤‡ä¸ªå° demo&lt;/h2>
&lt;p>æ—¢ç„¶ &lt;code>map[string]interface{}&lt;/code> æœ‰è¿™ä¸ªå¥‡æ€ªé—®é¢˜ï¼Œé‚£ &lt;code>map[string]string&lt;/code> è¿™ç§å€¼ç±»å‹ç¡®å®šçš„æ•°æ®ç»“æ„ï¼Œæ˜¯å¦å°±æ²¡æœ‰é—®é¢˜å‘¢ï¼Ÿæ¥ï¼Œä¸Šä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">package&lt;/span> main
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;fmt&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;reflect&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> main() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implicitMap := &lt;span style="font-weight:bold">map&lt;/span>[&lt;span style="">string&lt;/span>]&lt;span style="font-weight:bold">interface&lt;/span>{}{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;Martin&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> explicitMap := &lt;span style="font-weight:bold">map&lt;/span>[&lt;span style="">string&lt;/span>]&lt;span style="">string&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;Martin&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implicitRValue := reflect.ValueOf(implicitMap)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> explicitRValue := reflect.ValueOf(explicitMap)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implicitNameValue := implicitRValue.MapIndex(reflect.ValueOf(&lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> explicitNameValue := explicitRValue.MapIndex(reflect.ValueOf(&lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Printf(&lt;span style="font-style:italic">&amp;#34;the kind of name key value in implicitRValue is: %s\n&amp;#34;&lt;/span>, implicitNameValue.Kind())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Printf(&lt;span style="font-style:italic">&amp;#34;the kind of name key value in explicitRValue is: %s\n&amp;#34;&lt;/span>, explicitNameValue.Kind())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> implicitNameInterface := implicitNameValue.Interface()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(&lt;span style="font-style:italic">&amp;#34;the type of implicitNameValue is: &amp;#34;&lt;/span>, implicitNameValue.Type().String())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> directName, ok := implicitNameInterface.(&lt;span style="">string&lt;/span>); ok {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(&lt;span style="font-style:italic">&amp;#34;the directName is: &amp;#34;&lt;/span>, directName)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="font-weight:bold">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(&lt;span style="font-style:italic">&amp;#34;could not assert directName as string&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> convertedImplicitNameValue := reflect.ValueOf(implicitNameInterface)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Printf(&lt;span style="font-style:italic">&amp;#34;the kind of name key value after converting is: %s\n&amp;#34;&lt;/span>, convertedImplicitNameValue.Kind())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fmt.Println(&lt;span style="font-style:italic">&amp;#34;the converted value is: &amp;#34;&lt;/span>, convertedImplicitNameValue.Interface().(&lt;span style="">string&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>demo ä»£ç ç•¥å¤šï¼Œå¤§å®¶ä¸è¦æ€•ã€‚å¤§æ¦‚æ€è·¯å°±æ˜¯æƒ³çœ‹çœ‹ä¸¤ç§ä¸åŒå€¼ç±»å‹çš„ map é€šè¿‡åå°„åçš„ MapIndex æ–¹æ³•å¾—åˆ°çš„åå°„å€¼çš„ &lt;code>Kind&lt;/code> æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä»¥åŠï¼Œèƒ½å¦ç›´æ¥éƒ½è¿›è¡Œç±»å‹è½¬æ¢ã€‚&lt;/p>
&lt;p>æ€ä¹ˆæ ·ï¼Ÿæ€è·¯åº”è¯¥çŸ¥é“äº†å§ï¼Ÿé‚£ä½ è§‰å¾—è¿™æ®µç¨‹åºçš„è¾“å‡ºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæƒ³å¥½äº†çš„è¯ï¼Œæˆ‘ä»¬å¾€ä¸‹æ­æ™“ç­”æ¡ˆï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>the kind of name key value in implicitRValue is: interface
the kind of name key value in explicitRValue is: string
the type of implicitNameValue is: interface {}
the directName is: Martin
the kind of name key value after converting is: string
the converted value is: Martin
&lt;/code>&lt;/pre>&lt;p>çœ‹åˆ°æ²¡æœ‰ï¼Ÿ&lt;/p>
&lt;ol>
&lt;li>&lt;code>map[string]interface{}&lt;/code> ç±»å‹çš„æ•°æ®å¯¹åº”çš„åå°„å€¼åœ¨é€šè¿‡ &lt;code>MapIndex&lt;/code> æ–¹æ³•è·å–åˆ°çš„å€¼ï¼Œå¯¹åº”çš„ Kind æ˜¯ &lt;code>interface&lt;/code>ï¼›&lt;/li>
&lt;li>&lt;code>map[string]string&lt;/code> ç±»å‹çš„æ•°æ®å’Œ1çš„æ•°æ®å°½ç®¡äººç±»è§’åº¦ç†è§£ä¸€è‡´ï¼Œä½†æ˜¯å…¶åå°„å€¼åœ¨é€šè¿‡ &lt;code>MapIndex&lt;/code> æ–¹æ³•è·å–åˆ°çš„å€¼ï¼Œå¯¹åº”çš„ Kind æ˜¯ &lt;code>string&lt;/code>ï¼›&lt;/li>
&lt;li>&lt;code>map[string]interface{}&lt;/code> ç±»å‹çš„æ•°æ®çš„åå°„å€¼åœ¨é€šè¿‡ &lt;code>MapIndex&lt;/code> æ–¹æ³•è·å–åˆ°çš„å€¼ï¼Œå†ç»è¿‡ä¸€æ¬¡ &lt;code>reflect.Interface&lt;/code> å’Œ &lt;code>reflect.ValueOf&lt;/code> çš„å¾€è¿”åï¼Œæœ€åçš„å€¼çš„ Kind æˆåŠŸå˜æˆ &lt;code>string&lt;/code> äº†ï¼&lt;/li>
&lt;/ol>
&lt;p>æˆ‘æœ¬æ¥æƒ³ç©ä¸€ç©åå°„ï¼Œç»“æœæ²¡æƒ³åˆ°è¿™æ˜¯è¢«åå°„ç©äº†å•Šï¼åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;h2 id="å¼€å¯åŸç†åˆ†æä¹‹æ—…">å¼€å¯åŸç†åˆ†æä¹‹æ—…&lt;/h2>
&lt;h3 id="æå‡ºé—®é¢˜">æå‡ºé—®é¢˜&lt;/h3>
&lt;p>ä¸ºäº†æ‰¾å‡ºé—®é¢˜çš„ç­”æ¡ˆï¼Œæˆ‘æŠŠé—®é¢˜è¿›è¡Œäº†åˆ†è§£ï¼Œç›¸ä¿¡æ‰¾åˆ°è¿™äº›é—®é¢˜çš„ç­”æ¡ˆä¹‹åï¼Œä¸Šé¢çš„é—®é¢˜å°±è‡ªç„¶è¿åˆƒè€Œè§£äº†ã€‚&lt;/p>
&lt;ul>
&lt;li>é—®é¢˜ä¸€ï¼š&lt;code>reflect.Value#Kind&lt;/code> æ–¹æ³•å¦‚ä½•å·¥ä½œï¼Œå®ƒæ€ä¹ˆçŸ¥é“å…·ä½“çš„ Kind å€¼ï¼Ÿ&lt;/li>
&lt;li>é—®é¢˜äºŒï¼šåœ¨ &lt;code>reflect.Value#Interface&lt;/code> å’Œ &lt;code>reflect.ValueOf&lt;/code> è¿™ä¸€æ¥ä¸€å¾€ä¹‹é—´ï¼Œæ˜¯å“ªä¸ªæ“ä½œèµ·äº†å…³é”®ä½œç”¨ï¼Œè®©åå°„å€¼çš„ Kind å¾—åˆ°çº æ­£ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;p>æ—¢ç„¶æå‡ºæ¥é—®é¢˜ï¼Œæˆ‘ä»¬å°±é€ä¸ªé—®é¢˜å‡»ç ´å§ï¼Œlet&amp;rsquo;s go!&lt;/p>
&lt;h3 id="é—®é¢˜ä¸€reflectvaluekind-æ–¹æ³•å¦‚ä½•å·¥ä½œå®ƒæ€ä¹ˆçŸ¥é“å…·ä½“çš„-kind-å€¼">é—®é¢˜ä¸€ï¼š&lt;code>reflect.Value#Kind&lt;/code> æ–¹æ³•å¦‚ä½•å·¥ä½œï¼Œå®ƒæ€ä¹ˆçŸ¥é“å…·ä½“çš„ Kind å€¼ï¼Ÿ&lt;/h3>
&lt;p>è¦æƒ³çŸ¥é“ï¼Œä¸å¦¨è·Ÿç€æºç åˆ†æå‡ºå‘ï¼Ÿä»¥ä¸‹æ˜¯ &lt;code>Kind&lt;/code> æ–¹æ³•çš„æºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (v Value) Kind() Kind {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> v.kind()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ‰æ„æ€ï¼Œå®ƒå•¥ä¹Ÿä¸å¹²ï¼Œå–Šäº†è‡ªå·±çš„åˆ†èº« &lt;code>kind&lt;/code> æ–¹æ³•å‡ºæ¥å¹²æ´»ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (f flag) kind() Kind {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> Kind(f &amp;amp; flagKindMask)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¥½å®¶ä¼™ï¼Œè¿™é‡Œä¹Ÿå°±ä¸€è¡Œä»£ç ï¼Œå®šç›ä¸€çœ‹ï¼Œè¿™é‡Œä¸æ˜¯ &lt;code>Value&lt;/code> å®šä¹‰çš„æ–¹æ³•ï¼Œè€Œæ˜¯ &lt;code>Value&lt;/code> å€¼çš„ &lt;code>flag&lt;/code> åŒ¿åå­—æ®µçš„ &lt;code>kind&lt;/code> æ–¹æ³•ï¼Œå¹²äº†å•¥å‘¢ï¼Ÿå°±æ˜¯åšäº†ä¸‹ä½çš„æ©ç è¿ç®—ï¼Œç¿»äº†ä¸‹ä»£ç ï¼Œæ‰¾åˆ°æ–‡ä»¶å¼€å¤´ä¸€å¤„é‡ç‚¹ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">type&lt;/span> flag &lt;span style="">uintptr&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">const&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flagKindWidth = 5 &lt;span style="font-style:italic">// there are 27 kinds
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> flagKindMask flag = 1&amp;lt;&amp;lt;flagKindWidth - 1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">//...
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸Šé¢ &lt;code>kind()&lt;/code> æ–¹æ³•çš„å®ç°é€»è¾‘å°±æ˜¯å–è‡ªèº«çš„ flag å€¼çš„ä½ 5 ä½ï¼ˆä¹Ÿå°±æ˜¯ 0-31ï¼‰ï¼Œè€Œå¦‚æœç†Ÿæ‚‰åå°„çš„åŒå­¦éƒ½çŸ¥é“ï¼Œreflect åŒ…é‡Œæ€»çš„å®šä¹‰äº† 27 ä¸ª kind å¸¸é‡ï¼Œå…¶ä¸­ 0 æ˜¯éæ³• kindï¼Œæˆ‘ä»¬åˆšæ‰è®¨åŒçš„ &lt;code>interface&lt;/code> å¯¹åº”çš„å€¼æ˜¯ 20ï¼Œ&lt;code>map&lt;/code> æ˜¯ 21ï¼Œæˆ‘ä»¬æƒ³è¦çš„ &lt;code>string&lt;/code> æ˜¯ 24ã€‚&lt;/p>
&lt;h4 id="å°ç»“ä¸€ä¸ª">å°ç»“ä¸€ä¸ª&lt;/h4>
&lt;p>æ‰€ä»¥åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„é—®é¢˜çš„ç­”æ¡ˆå°±æ¸…æ¥šäº†ï¼Œ&lt;code>Kind&lt;/code> æ–¹æ³•å®é™…åªæ˜¯ä» &lt;code>reflect.Value&lt;/code> å¯¹è±¡è‡ªèº«çš„ &lt;code>flag&lt;/code> å­—æ®µçš„ä½ 5 ä½ä¸­å–å‡ºå¯¹åº”çš„ kind å€¼ã€‚é‚£ä¹ˆï¼Œé—®é¢˜åˆå˜äº†ï¼šè¿™ä¸ª &lt;code>flag&lt;/code> çš„ä½ 5 ä½æ˜¯æ€ä¹ˆèµ‹å€¼çš„ï¼Ÿ&lt;/p>
&lt;h3 id="é—®é¢˜ä¸€çš„å»¶ä¼¸reflectvalue-å¯¹è±¡çš„-flag-å­—æ®µçš„-ä½-5-ä½ä¹Ÿå°±æ˜¯-kindæ˜¯æ€ä¹ˆæ¥çš„">é—®é¢˜ä¸€çš„å»¶ä¼¸ï¼š&lt;code>reflect.Value&lt;/code> å¯¹è±¡çš„ &lt;code>flag&lt;/code> å­—æ®µçš„ ä½ 5 ä½ï¼Œä¹Ÿå°±æ˜¯ kindï¼Œæ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ&lt;/h3>
&lt;p>æƒ³è¦è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æ‰¾åˆ°äº†ä¸€ç‚¹é—´æ¥çš„çº¿ç´¢ã€‚ä»ã€ŠGoè¯­è¨€è®¾è®¡ä¸å®ç°ã€‹çš„ 4.3.2 èŠ‚ä¸­å¾—åˆ°çš„ä¸‹é¢ 2 ç‚¹ç»“è®ºéœ€è¦å¤§å®¶å…ˆè®°ä½ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>å¤§å®¶çŸ¥é“ &lt;code>reflect.ValueOf&lt;/code> å‡½æ•°çš„å‚æ•°åˆ—è¡¨æ˜¯ &lt;code>(i interface{}) Value&lt;/code>ï¼Œä¹Ÿå°±æ˜¯å…¥å‚æ˜¯ä¸€ä¸ª &lt;code>interface{}&lt;/code> ç±»å‹çš„å€¼ï¼Œä½†æ˜¯ï¼Œå¤–éƒ¨è°ƒç”¨æ—¶ï¼Œæ˜æ˜æ˜¯ &lt;code>reflect.ValueOf(implicitMap)&lt;/code>ï¼Œè¿™é‡Œ &lt;code>implicitMap&lt;/code> æ˜æ˜åªæ˜¯ä¸€ä¸ª &lt;code>map[string]interface{}&lt;/code> ç±»å‹çš„å‚æ•°å•Šï¼Œä¸ºä»€ä¹ˆèƒ½å·¥ä½œï¼Ÿé“ç†å¾ˆç®€å•ï¼Œä¸€åˆ‡ä½ æ²¡å¹²ï¼Œä½†æ˜¯åˆèƒ½å·¥ä½œçš„è¯­æ³•ï¼Œä¸€å®šæ˜¯ç¼–è¯‘å™¨åœ¨èƒŒåä¸ºä½ é»˜é»˜åšäº†ä¸€äº›äº‹æƒ…ã€‚äº‹å®ä¸Šï¼Œ&lt;strong>è¿™é‡Œçš„ç±»å‹è½¬æ¢å°±æ˜¯ç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆçš„&lt;/strong>ã€‚è¿™ä¸ªç»“è®ºæ€ä¹ˆè¯æ˜å‘¢ï¼Ÿæ±‡ç¼–ï¼æœ‰å…³äºè¿™ä¸ªç»“è®ºçš„æ±‡ç¼–ä»£ç å±•ç¤ºå’Œè¯´æ˜ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±å»çœ‹ï¼Œåªè®°ä½ç»“è®ºå°±è¶³ä»¥è·Ÿç€æˆ‘çš„è„šæ­¥å¾€ä¸‹äº†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è¿›ä¸€æ­¥ï¼ŒGo è¯­è¨€çš„ &lt;code>interface{}&lt;/code> ç±»å‹åœ¨è¯­è¨€å†…éƒ¨æ˜¯é€šè¿‡ &lt;code>reflect.emptyInterface&lt;/code> ç»“æ„ä½“è¡¨ç¤ºçš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// emptyInterface is the header for an interface{} value.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> emptyInterface &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> typ *rtype
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> word unsafe.Pointer
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­çš„ rtype å­—æ®µç”¨äºè¡¨ç¤ºå˜é‡çš„ç±»å‹ï¼Œå¦ä¸€ä¸ª word å­—æ®µæŒ‡å‘å†…éƒ¨å°è£…çš„æ•°æ®ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å›åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å½“æˆ‘ä»¬æ‰§è¡Œ &lt;code>reflect.ValueOf(xxx)&lt;/code> çš„æ—¶å€™ï¼Œ&lt;code>reflect.Value&lt;/code> çš„ flag æ˜¯æ€ä¹ˆæ¥çš„ã€‚ä¾ç„¶ä»æºç å…¥æ‰‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> ValueOf(i &lt;span style="font-weight:bold">interface&lt;/span>{}) Value {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ä¸ºäº†èšç„¦ï¼Œæ­¤å¤„çœç•¥ä¸€äº›ä¸å¤ªé‡è¦çš„ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> unpackEface(i)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæœ€é‡è¦çš„ä»£ç å°±è¿™ä¸€è¡Œ &lt;code>unpackEface&lt;/code>ï¼Œå…¶ä¸­ &lt;code>Eface&lt;/code> å°±æ˜¯ &lt;code>Empty Interface&lt;/code>ï¼Œæ‰€ä»¥ï¼Œunpack äº†å•¥å‘¢ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// unpackEface converts the empty interface i to a Value.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">func&lt;/span> unpackEface(i &lt;span style="font-weight:bold">interface&lt;/span>{}) Value {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> e := (*emptyInterface)(unsafe.Pointer(&amp;amp;i))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// NOTE: don&amp;#39;t read e.word until we know whether it is really a pointer or not.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> t := e.typ
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> t == &lt;span style="font-weight:bold">nil&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> Value{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> f := flag(t.Kind())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> ifaceIndir(t) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> f |= flagIndir
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> Value{t, e.word, f}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å—¯ï¼Œå¯ä»¥ï¼Œä»£ç ä¾æ—§ä¸å¤šã€‚é¦–å…ˆä»£ç å°†ç©ºæ¥å£ç±»å‹çš„å€¼ &lt;code>i&lt;/code> é€šè¿‡æŒ‡é’ˆå¼ºè½¬è½¬ä¸ºäº† &lt;code>emptyInterface&lt;/code> ç±»å‹çš„å€¼ï¼Œè¿˜è®°å¾—åˆšæ‰è¯´çš„ç¬¬2ç‚¹å—ï¼Ÿ&lt;/p>
&lt;blockquote>
&lt;p>Go è¯­è¨€çš„ &lt;code>interface{}&lt;/code> ç±»å‹åœ¨è¯­è¨€å†…éƒ¨æ˜¯é€šè¿‡ &lt;code>reflect.emptyInterface&lt;/code> ç»“æ„ä½“è¡¨ç¤º&lt;/p>
&lt;/blockquote>
&lt;p>æ¥ç€éš”å¼€5è¡Œï¼Œæ¥åˆ° &lt;code>f := flag(t.Kind())&lt;/code>ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œï¼Œå®šä¸‹äº† &lt;code>Value&lt;/code> çš„ kind å€¼ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ä¸ä¼šæ­¢æ­¥äºæ­¤ï¼Œå†çœ‹ &lt;code>*rtype#Kind&lt;/code> æ–¹æ³•çš„æºç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">const&lt;/span> (
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> kindMask = (1 &amp;lt;&amp;lt; 5) - 1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// rtype is the common implementation of most values.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// It is embedded in other struct types.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// rtype must be kept in sync with ../runtime/type.go:/^type._type.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> rtype &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ä¸ºäº†èšç„¦ï¼Œæ­¤å¤„çœç•¥ä¸€äº›ä¸å¤ªé‡è¦çš„ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> kind &lt;span style="">uint8&lt;/span> &lt;span style="font-style:italic">// enumeration for C
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (t *rtype) Kind() Kind { &lt;span style="font-weight:bold">return&lt;/span> Kind(t.kind &amp;amp; kindMask) }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œåˆæ˜¯ä¸€æ¬¡æ©ç è®¡ç®—ï¼Œ&lt;code>kindMask&lt;/code> ä»ç„¶æ˜¯ä¸€ä¸ªä½5ä½çš„æ©ç ï¼Œä¹Ÿå°±æ˜¯ &lt;code>11111&lt;/code>ã€‚è€Œ &lt;code>rtype&lt;/code> ç±»å‹ä¸­çš„ &lt;code>kind&lt;/code> æ•°å€¼ä¸­å­˜ç€å…·ä½“æ•°æ®ç±»å‹ã€‚&lt;/p>
&lt;p>è¿™é‡Œå°±èƒ½ç»“åˆèµ·æ¥å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼š&lt;/p>
&lt;blockquote>
&lt;p>å¯¹äºæ¯ä¸ªé€šè¿‡è°ƒç”¨ &lt;code>reflect.ValueOf&lt;/code> å‡½æ•°å¾—åˆ°çš„åå°„å€¼ï¼Œå®ƒçš„ &lt;code>Kind()&lt;/code> æ–¹æ³•çš„ç»“æœå–å†³äºç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µå®ç°çš„åˆ° &lt;code>emptyInterface&lt;/code> ç±»å‹çš„ç±»å‹è½¬æ¢è¿‡ç¨‹ä¸­å­˜åœ¨ &lt;code>typ&lt;/code> å­—æ®µæŒ‡å‘çš„ &lt;code>rtype&lt;/code> ç±»å‹çš„å€¼ä¸­çš„ &lt;code>kind&lt;/code> å­—æ®µçš„å€¼ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æœ‰ç‚¹æ‹—å£ï¼Œç”»ä¸ªå›¾ç¤ºæ„ï¼š&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/reflect/flag-sourcing.png" alt="">
&lt;/p>
&lt;p>è¿™å¥—å…³ç³»ä¹‹åï¼Œæˆ‘ä»¬é‡Œé—®é¢˜çš„çœŸç›¸æ›´è¿‘ä¸€æ­¥äº†ï¼Œåªè¦æˆ‘ä»¬çŸ¥é“ï¼š&lt;code>reflect.Value#MapIndex&lt;/code> æ–¹æ³•åˆæ˜¯æ€ä¹ˆç»™è¿”å›çš„ &lt;code>Value&lt;/code> å¯¹è±¡è®¾ç½®å®ƒçš„ &lt;code>flag&lt;/code> çš„å‘¢ï¼Ÿ&lt;/p>
&lt;p>ä½ çŒœåˆ°äº†å—ï¼Ÿç»§ç»­çœ‹æºç ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (v Value) MapIndex(key Value) Value {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tt := (*mapType)(unsafe.Pointer(v.typ))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ä¸ºäº†èšç„¦ï¼Œæ­¤å¤„çœç•¥ä¸€äº›ä¸å¤ªé‡è¦çš„ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> typ := tt.elem
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fl := (v.flag | key.flag).ro()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fl |= flag(typ.Kind())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> copyVal(typ, fl, e)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œæ–¹æ³•å†…éƒ¨ç¬¬ä¸€è¡Œçš„ &lt;code>v.typ&lt;/code> æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿå›é¡¾å‰é¢åˆšæ‰çœ‹çš„ &lt;code>unpackEface&lt;/code> å‡½æ•°ï¼ŒåŒæ—¶ç»“åˆ &lt;code>Value&lt;/code> çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> unpackEface(i &lt;span style="font-weight:bold">interface&lt;/span>{}) Value {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> e := (*emptyInterface)(unsafe.Pointer(&amp;amp;i))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t := e.typ
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ä¸ºäº†èšç„¦ï¼Œæ­¤å¤„çœç•¥ä¸€äº›ä¸å¤ªé‡è¦çš„ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">return&lt;/span> Value{t, e.word, f}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">type&lt;/span> Value &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// typ holds the type of the value represented by a Value.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> typ *rtype
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ä¸ºäº†èšç„¦ï¼Œæ­¤å¤„çœç•¥ä¸€äº›ä¸å¤ªé‡è¦çš„ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> flag
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€ä»¥ï¼Œè¿™é‡Œçš„ &lt;code>v.typ&lt;/code> å°±æ˜¯è¡¨ç¤ºå˜é‡çš„ç±»å‹ï¼Œå®ƒçš„ç±»å‹æ˜¯ &lt;code>rtype&lt;/code>ã€‚å›åˆ° &lt;code>MapIndex&lt;/code> çš„ä»£ç ï¼Œ&lt;code>tt&lt;/code> æ˜¯å°† &lt;code>rtype&lt;/code> ç±»å‹çš„å€¼è½¬æ¢ä¸º &lt;code>mapType&lt;/code> ç±»å‹çš„å€¼ï¼Œå…¶ä¸­ &lt;code>mapType&lt;/code> çš„å®šä¹‰å°±æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// mapType represents a map type.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>&lt;span style="font-weight:bold">type&lt;/span> mapType &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rtype
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> key *rtype &lt;span style="font-style:italic">// map key type
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> elem *rtype &lt;span style="font-style:italic">// map element (value) type
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">// ä¸ºäº†èšç„¦ï¼Œæ­¤å¤„çœç•¥ä¸€äº›ä¸å¤ªé‡è¦çš„ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­çš„ &lt;code>key&lt;/code> ä»£è¡¨é”®å€¼å¯¹ä¸­é”®çš„ç±»å‹ï¼Œè€Œ &lt;code>elem&lt;/code> ä»£è¡¨é”®å€¼å¯¹ä¸­å€¼çš„ç±»å‹ã€‚ç»§ç»­å›åˆ° &lt;code>MapIndex&lt;/code> çš„å‰©ä½™ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span> typ := tt.elem
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fl := (v.flag | key.flag).ro()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fl |= flag(typ.Kind())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> copyVal(typ, fl, e)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">func&lt;/span> copyVal(typ *rtype, fl flag, ptr unsafe.Pointer) Value {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ä¸ºäº†èšç„¦ï¼Œæ­¤å¤„çœç•¥ä¸€äº›ä¸å¤ªé‡è¦çš„ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">return&lt;/span> Value{typ, *(*unsafe.Pointer)(ptr), fl}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„ &lt;code>fl&lt;/code> é€šè¿‡ &lt;code>fl |= flag(typ.Kind())&lt;/code> åŠ ä¸Šäº†å¤åˆ¶äº† &lt;code>typ&lt;/code> çš„ &lt;code>kind&lt;/code>ï¼Œä¹Ÿå°±æ˜¯é”®å€¼å¯¹ä¸­å€¼çš„ç±»å‹çš„ &lt;code>kind&lt;/code>ã€‚&lt;/p>
&lt;p>äº†è§£äº†è¿™äº›åŸç†ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç„¶æƒ³åˆ°ï¼Œå›åˆ°æˆ‘ä»¬çš„ demoï¼Œé‚£æˆ‘ä»¬çœ‹ä¸‹ &lt;code>implicitRValue&lt;/code> å’Œ &lt;code>explicitRValue&lt;/code> åˆ†åˆ«å¯¹åº”çš„ &lt;code>typ&lt;/code> çš„ &lt;code>elem&lt;/code> çš„å€¼ä¸å°±çŸ¥é“ä¸ºä»€ä¹ˆåé¢çš„ &lt;code>MapIndex&lt;/code> æ–¹æ³•è¿”å›çš„ &lt;code>Value&lt;/code> å¯¹è±¡çš„ &lt;code>Kind()&lt;/code> ä¸ºä»€ä¹ˆä¸åŒäº†ï¼Ÿä»¥ä¸‹ä¸Šä¸ªè°ƒè¯•æˆªå›¾ï¼š&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/reflect/map-index-breakpoint-1.png" alt="">
&lt;img src="https://blog.hackerpie.com/images/posts/reflect/map-index-breakpoint-2.png" alt="">
&lt;/p>
&lt;h4 id="é—®é¢˜ä¸€æ€»ç»“">é—®é¢˜ä¸€æ€»ç»“&lt;/h4>
&lt;ol>
&lt;li>&lt;code>reflect.Value&lt;/code> çš„ &lt;code>Kind&lt;/code> æ–¹æ³•è¿”å›çš„æ˜¯è‡ªèº« &lt;code>flag&lt;/code> å­—æ®µçš„ä½ 5 ä½è¡¨ç¤ºçš„æšä¸¾å€¼ kindï¼›&lt;/li>
&lt;li>&lt;code>reflect.Value&lt;/code> çš„ &lt;code>MapIndex&lt;/code> æ–¹æ³•è¿”å›çš„æ–°çš„ &lt;code>Value&lt;/code> å¯¹è±¡çš„ &lt;code>flag&lt;/code> çš„ kind æ˜¯åŸ &lt;code>Value&lt;/code> å¯¹è±¡çš„å€¼ç±»å‹çš„ &lt;code>kind&lt;/code>ï¼Œå¯¹äº &lt;code>reflect.ValueOf(map[string]interface{})&lt;/code> çš„å€¼ï¼Œå®ƒçš„å€¼ç±»å‹çš„ kind æ˜¯ 20ï¼Œå³ interfaceï¼›è€Œ å¯¹äº &lt;code>reflect.ValueOf(map[string]interface{})&lt;/code> çš„å€¼ï¼Œå®ƒçš„å€¼ç±»å‹çš„ kind æ˜¯ 24, å³ stringã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="é—®é¢˜äºŒåœ¨-reflectvalueinterface-å’Œ-reflectvalueof-è¿™ä¸€æ¥ä¸€å¾€ä¹‹é—´æ˜¯å“ªä¸ªæ“ä½œèµ·äº†å…³é”®ä½œç”¨è®©åå°„å€¼çš„-kind-å¾—åˆ°çº æ­£">é—®é¢˜äºŒï¼šåœ¨ &lt;code>reflect.Value#Interface&lt;/code> å’Œ &lt;code>reflect.ValueOf&lt;/code> è¿™ä¸€æ¥ä¸€å¾€ä¹‹é—´ï¼Œæ˜¯å“ªä¸ªæ“ä½œèµ·äº†å…³é”®ä½œç”¨ï¼Œè®©åå°„å€¼çš„ Kind å¾—åˆ°çº æ­£ï¼Ÿ&lt;/h3>
&lt;p>æˆ‘ä»¬ä¸å¦¨å…ˆçœ‹çœ‹ &lt;code>Interface&lt;/code> æ–¹æ³•å¦‚ä½•å·¥ä½œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> (v Value) Interface() (i &lt;span style="font-weight:bold">interface&lt;/span>{}) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> valueInterface(v, &lt;span style="font-weight:bold">true&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> valueInterface(v Value, safe &lt;span style="">bool&lt;/span>) &lt;span style="font-weight:bold">interface&lt;/span>{} {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// ä¸ºäº†èšç„¦ï¼Œæ­¤å¤„çœç•¥ä¸€äº›ä¸å¤ªé‡è¦çš„ä»£ç 
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> v.kind() == Interface {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// Special case: return the element inside the interface.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">// Empty interface has one layout, all interfaces with
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">// methods have a second layout.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> v.NumMethod() == 0 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> *(*&lt;span style="font-weight:bold">interface&lt;/span>{})(v.ptr)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> *(*&lt;span style="font-weight:bold">interface&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> M()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> })(v.ptr)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// TODO: pass safe to packEface so we don&amp;#39;t need to copy if safe==true?
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">return&lt;/span> packEface(v)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨é—®é¢˜ä¸€çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®è®¤ &lt;code>reflect.ValueOf(map[string]interface{})&lt;/code> çš„å€¼è°ƒç”¨ &lt;code>MapIndex&lt;/code> ä¼šå¾—åˆ°çš„ &lt;code>Value&lt;/code> çš„ &lt;code>Kind()&lt;/code> ä¼šæ˜¯ &lt;code>Interface&lt;/code>ï¼Œäºæ˜¯æˆ‘ä»¬çš„ demo ä¼šèµ°åˆ° &lt;code>return *(*interface{})(v.ptr)&lt;/code> è¿™ä¸€è¡Œã€‚å…¶ä¸­ &lt;code>v.ptr&lt;/code> çš„å®šä¹‰æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">type&lt;/span> Value &lt;span style="font-weight:bold">struct&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// typ holds the type of the value represented by a Value.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> typ *rtype
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">// Pointer-valued data or, if flagIndir is set, pointer to data.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">// Valid when either flagIndir is set or typ.pointers() is true.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> ptr unsafe.Pointer
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæŒ‡å‘åå°„å€¼æ‰€åŒ…è£…çš„çœŸå®æ•°æ®ã€‚æ‰€ä»¥ï¼Œ&lt;code>reflect.Value&lt;/code> å¯¹è±¡çš„ &lt;code>Interface()&lt;/code> ä¼šè¿”å›å®é™…çš„æ•°æ®ã€‚&lt;/p>
&lt;p>å¼€å§‹æ„è¯†åˆ°ä»€ä¹ˆæ²¡æœ‰ï¼Ÿå¦‚æœæˆ‘ä»¬å†å°†è¿™ä¸ªå®é™…çš„æ•°æ®ä¼ ç»™ &lt;code>reflect.ValueOf()&lt;/code> å‡½æ•°ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå›æƒ³ä¸€ä¸‹ï¼å‰é¢å·²ç»åˆ†æè¿‡äº†ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å¯¹äºæ¯ä¸ªé€šè¿‡è°ƒç”¨ &lt;code>reflect.ValueOf&lt;/code> å‡½æ•°å¾—åˆ°çš„åå°„å€¼ï¼Œå®ƒçš„ &lt;code>Kind()&lt;/code> æ–¹æ³•çš„ç»“æœå–å†³äºç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µå®ç°çš„åˆ° &lt;code>emptyInterface&lt;/code> ç±»å‹çš„ç±»å‹è½¬æ¢è¿‡ç¨‹ä¸­å­˜åœ¨ &lt;code>typ&lt;/code> å­—æ®µæŒ‡å‘çš„ &lt;code>rtype&lt;/code> ç±»å‹çš„å€¼ä¸­çš„ &lt;code>kind&lt;/code> å­—æ®µçš„å€¼ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æƒ³ä¸èµ·æ¥çš„ï¼Œè¿”å›å»çœ‹çœ‹å‰é¢çš„å›¾ç‰‡ã€‚&lt;/p>
&lt;h4 id="é—®é¢˜äºŒçš„æ€»ç»“">é—®é¢˜äºŒçš„æ€»ç»“&lt;/h4>
&lt;ol>
&lt;li>&lt;code>reflect.ValueOf(xxx.Interface())&lt;/code> é€šè¿‡å…ˆè·å–çœŸå®çš„æ•°æ®å†è½¬å›åå°„å€¼ï¼Œä»è€Œèƒ½å¤Ÿé€šè¿‡ &lt;code>Kind&lt;/code> æ‹¿åˆ°çœŸå®æ•°æ®çš„å®é™…ç±»å‹ï¼Œè€Œä¸æ˜¯åœ¨ &lt;code>MapIndex&lt;/code> è¿‡ç¨‹ä¸­å¤åˆ¶çš„ &lt;code>kind&lt;/code>ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;ol>
&lt;li>é€šè¿‡ &lt;code>reflect.Value#Interface()&lt;/code> æ–¹æ³•ï¼Œæˆ‘ä»¬è·å¾—äº†å®é™…çš„æ•°æ®çš„ç©ºæ¥å£è¡¨ç¤ºï¼Œè€Œå†ç”¨ &lt;code>reflect#ValueOf&lt;/code> å‡½æ•°å°†ç©ºæ¥å£è½¬æˆåå°„å€¼ï¼Œå°±å¯ä»¥åˆ©ç”¨ &lt;code>Kind()&lt;/code> è·å–åˆ°çœŸå®æ•°æ®çš„å®é™…ç±»å‹äº†ï¼›&lt;/li>
&lt;li>é™¤äº†å­—å…¸ç±»å‹çš„ &lt;code>MapIndex&lt;/code> ä¼šæœ‰ä¸Šè¿°é—®é¢˜ï¼ŒåŒç†åˆ—è¡¨å‹æ•°æ®çš„ &lt;code>Index(i int)&lt;/code> æ–¹æ³•ä¹Ÿæœ‰ç›¸åŒé—®é¢˜ï¼›&lt;/li>
&lt;li>åœ¨é˜…è¯»åå°„æºç çš„è¿‡ç¨‹ä¸­ï¼Œçœ‹åˆ°äº†ä¸€äº›ç†è®ºä¸Šå½±å“ golang è¿è¡Œæ—¶æ€§èƒ½çš„æºç ï¼Œæ¯”å¦‚ &lt;code>ValueOf&lt;/code> å‡½æ•°ä¼šå…ˆå°†å˜é‡é€¸å‡ºåˆ°å †ç­‰ï¼Œåé¢å¯ä»¥å†å†™å†™å…³äºåå°„å¸¦æ¥çš„ä¸€äº›é—®é¢˜ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://stackoverflow.com/questions/14142667/reflect-value-mapindex-returns-a-value-different-from-reflect-valueof">StackOverflow: reflect.Value.MapIndex() returns a Value different from reflect.ValueOf()&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://draveness.me/golang/docs/part2-foundation/ch04-basic/golang-reflect/#432-%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%80%BC">ã€ŠGo è¯­è¨€è®¾è®¡ä¸å®ç°ã€‹4.3.2èŠ‚&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://pkg.go.dev/reflect">golang: reflect package&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Prefix or Suffix oh-my-zsh's shell prompt</title><link>https://blog.hackerpie.com/posts/skills/prefix-or-suffix-zsh-prompt/</link><pubDate>Wed, 16 Feb 2022 23:30:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/skills/prefix-or-suffix-zsh-prompt/</guid><description>&lt;p>Almost every developer loves his/her cool and colorful shell, so I install &lt;a href="https://ohmyz.sh/">oh-my-zsh&lt;/a> on my laptops and remote servers. However, as I use similar themes of oh-my-zsh and I also have the exactly same user name, most time I could not distinguish the actual machine on which I was operating.&lt;/p>
&lt;p>I tried to search online about how to decorate the zsh prompt so that I can insert a machine label within it. Unfortunetely, all articles which I could find specified that it has to overwrite the &lt;code>PS1&lt;/code> or &lt;code>PROMPT&lt;/code> environment variable in the &lt;code>~/.zshrc&lt;/code> file. These kinds of solutions will nail the prompt even though users change their zsh theme in the future.&lt;/p>
&lt;p>Fortunately, I suddenly realized that I could export the &lt;code>PROMPT&lt;/code> variable with shell substitution, that is my final solution:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># ~/.zshrc&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>source $ZSH/oh-my-zsh.sh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># ... some lines, it is worth mentioning that the below&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># line have to be after `source $ZSH/oh-my-zsh.sh`&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>export PROMPT=&lt;span style="font-style:italic">&amp;#34;[devcloud]&lt;/span>$PROMPT&lt;span style="font-style:italic">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Now my shell will always be prefixed a &lt;code>[devcloud]&lt;/code> label, I also added different labels on my different VPS so that I can judge if I am operating on a server quickly.&lt;/p>
&lt;p>The below shows the screenshot that prefix the prompt with a &lt;code>[devcloud]&lt;/code> label.&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/prefix-or-suffix-zsh-PROMPT.png" alt="">
&lt;/p></description></item><item><title>çèŠï¼šé¿å…æ‰‹æ¡é”¤å­çœ‹å•¥éƒ½æ˜¯é’‰å­</title><link>https://blog.hackerpie.com/posts/tittle-tattle/something-learned-from-techparty-blog-migration/</link><pubDate>Wed, 12 Jan 2022 11:24:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/tittle-tattle/something-learned-from-techparty-blog-migration/</guid><description>&lt;p>å‰ä¸¤å¤©åœ¨ç»™ &lt;a href="http://techparty.org/">TechParty&lt;/a> è®¾è®¡å’Œåˆ¶ä½œæ–°çš„å®˜ç½‘ï¼Œé€‰å‹äº†&lt;a href="http://www.sxl.cn/">ä¸Šçº¿äº†&lt;/a>ä½œä¸ºç½‘ç«™è®¾è®¡å’Œæ‰˜ç®¡çš„å¹³å°ã€‚æœ€åçš„ä¸€ä¸ªå¤§æ´»å°±æ˜¯å¦‚ä½•å°† TechParty åŸæ¥çš„ 218 ç¯‡åšå®¢æ–‡ç« è¿ç§»åˆ°æ–°çš„å®˜ç½‘ä¸Šï¼Œä¸€ç«™å¼ç®¡ç†ã€‚æ¯”è¾ƒé—æ†¾çš„æ˜¯ï¼Œä¸Šçº¿äº†çš„åšå®¢ç³»ç»Ÿå¹¶æ²¡æœ‰æä¾›ç¼–ç¨‹æ¥å£ç”¨äºè¿ç§»å·²æœ‰åšå®¢ï¼Œæ‰€ä»¥å”¯ä¸€çš„æ–¹å¼å°±æ˜¯è‡ªè¡Œæƒ³åŠæ³•å°†æ‰€æœ‰æ–‡ç« é€ä¸€æ‹·è´åˆ°ä»–ä»¬çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ä¸­ã€‚&lt;/p>
&lt;p>TechParty æ—§çš„åšå®¢ç³»ç»Ÿæ˜¯ç”¨çš„ Jekyllï¼Œä¸€ç§ä¸»è¦ä½¿ç”¨ markdown ä½œä¸ºåä½œè¯­è¨€çš„é™æ€åšå®¢ç«™ç‚¹ç”Ÿæˆå·¥å…·ï¼Œè€Œä¸Šçº¿äº†åªæ”¯æŒå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ï¼Œä¹Ÿä¸æ”¯æŒ markdownï¼Œæ‰€ä»¥å¤§ä½“æ€è·¯å°±æ˜¯ç›´æ¥æ‹·è´ Jekyll ç”Ÿæˆå¥½çš„ TechParty åšå®¢çš„ç½‘é¡µå†…å®¹åˆ°ä¸Šçº¿äº†çš„ç¼–è¾‘å™¨ä¸­ã€‚ä½†æ˜¯é—®é¢˜æ˜¯ï¼Œè¿™é‡Œé¢å¯æ˜¯æœ‰ 218 ç¯‡æ–‡ç« å‘¢ï¼ä¸æ˜¯ä¸€ä¸ªå°çš„å·¥ä½œé‡ï¼Œæ‰€ä»¥ä½œä¸ºç¨‹åºå‘˜ï¼Œç¬¬ä¸€ååº”å°±æ˜¯å°è¯•èƒ½ä¸èƒ½å°†è¿™ä¸ªè¿‡ç¨‹è‡ªåŠ¨åŒ–ï¼Ÿ&lt;/p>
&lt;h3 id="å°è¯•-python--selenium">å°è¯• python + selenium&lt;/h3>
&lt;p>ç¬¬ä¸€ä¸ªå°è¯•çš„æ–¹æ¡ˆå°±æ˜¯åŸºäº Python + Selenium çš„æ–¹å¼æ¥å®ç°æ•´ä¸ªè¿‡ç¨‹çš„è‡ªåŠ¨åŒ–ã€‚æ•´ä¸ªæ–¹æ¡ˆèŠ±äº†ä¸€ä¸‹åˆå¤§æ¦‚4ä¸ªå°æ—¶çš„æ—¶é—´ï¼ŒåŒ…æ‹¬è§£å†³ pip ä¾èµ–å®‰è£…çš„é—®é¢˜ã€å¦‚ä½•æ¨¡æ‹Ÿé¼ æ ‡é•¿æŒ‰é€‰ä¸­åšå®¢æ–‡ç« æ­£æ–‡çš„æ“ä½œã€å¦‚ä½•æ¨¡æ‹Ÿå¤åˆ¶ã€å¦‚ä½•æ¨¡æ‹Ÿäººå·¥åœ¨ä¸Šçº¿äº†ç¼–è¾‘å™¨é‡Œç‚¹å‡»å’Œç¼–è¾‘ç­‰ï¼Œæœ€ç»ˆæ•´ä¸ªæ–¹æ¡ˆå› ä¸ºæ— æ³•å®Œç¾æ¨¡æ‹Ÿäººå·¥ç‚¹å‡»ä¸Šçº¿äº†çš„å„ä¸ªç¼–è¾‘æ¡†ï¼ˆä¸ºäº†è¿›å…¥ç¼–è¾‘æ€ï¼Œéç¼–è¾‘æ€æ—¶ï¼Œé¡µé¢ä¸Šçš„å„ä¸ªæ§ä»¶æ˜¾ç¤ºä¸ºæ™®é€šçš„æ–‡æœ¬ï¼‰è€Œå¤±è´¥â€¦â€¦&lt;/p>
&lt;h3 id="äººè‚‰å¤åˆ¶ç²˜è´´">äººè‚‰å¤åˆ¶ç²˜è´´&lt;/h3>
&lt;p>ç¬¬äºŒå¤©æ—©ä¸Šï¼Œç—›å®šæ€ç—›ï¼Œè§‰å¾—è‡ªåŠ¨åŒ–çš„è·¯å­è™½ç„¶çœ‹èµ·æ¥æ¯”è¾ƒèªæ˜ï¼Œä½†æ˜¯å®é™…ä¸Šè¿˜æœ‰ä¸€äº›ç¼ºç‚¹æˆ–è€…æœªçŸ¥é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯å¤ç”¨æ€§ä½ï¼šå› ä¸ºè¿™ç§ä» Jekyll åšå®¢åˆ°ä¸Šçº¿äº†åšå®¢è¿ç§»çš„éœ€æ±‚æ˜¾ç„¶å¯¹æˆ‘è‡ªå·±æ˜¯ä¸€æ¬¡æ€§çš„ä»»åŠ¡ï¼Œè€Œå¯¹äºåˆ«äººå¯èƒ½å‹æ ¹æ²¡æœ‰ä»€ä¹ˆéœ€æ±‚&lt;/li>
&lt;li>æœªçŸ¥çš„å¼‚å¸¸å¤„ç†ï¼šå“ªæ€•æˆ‘è§£å†³äº†äº¤äº’æ¨¡æ‹Ÿçš„é—®é¢˜ï¼Œæˆ‘è¿˜æ˜¯æ— æ³•é¢„çŸ¥è„šæœ¬åç»­è‡ªåŠ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­è¿˜ä¼šä¸ä¼šæœ‰å…¶ä»–é—®é¢˜éœ€è¦è§£å†³ï¼Œå°½ç®¡è„šæœ¬è‡ªåŠ¨åŒ–å¾ˆé…·ï¼Œä½†æ˜¯å¹²è¿‡çš„äººéƒ½çŸ¥é“ï¼Œå®ƒä¸æ˜¯ä¸€åŠ³æ°¸é€¸çš„äº‹æƒ…ï¼Œå¾€å¾€ä½ è¿˜æ˜¯éœ€è¦äººç›¯ç€ï¼Œä»¥å¤‡éšæ—¶ä»‹å…¥å¤„ç†çªå‘çš„æƒ…å†µï¼Œè€Œä¸”ä¸€æ—¦ä¿®å¤å®Œé—®é¢˜ï¼Œä½ è¿˜éœ€è¦è„šæœ¬åˆ°åº•æ˜¯ä»å¤´å†æ¥ï¼Œè¿˜æ˜¯æ–­ç‚¹ä½œä¸šï¼Œé—®é¢˜åªå¤šä¸å°‘ï¼Œæ— ç©·æ— å°½â€¦â€¦&lt;/li>
&lt;/ul>
&lt;p>åœ¨å†³å®šæ˜¯å¦æ”¹ç”¨äººå·¥æ–¹å¼ä¹‹å‰ï¼Œæˆ‘ç®—äº†é“ç®€å•çš„æ•°å­¦é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>è¿ç§»ä¸€ç¯‡æ–‡ç« çš„ä¸»è¦æ“ä½œæ˜¯ï¼šæ‰“å¼€åŸæ–‡é“¾æ¥ -&amp;gt; å¤åˆ¶åŸæ–‡æ ‡é¢˜ -&amp;gt; åœ¨ä¸Šçº¿äº†æ–°å»ºä¸€ç¯‡åšå®¢ -&amp;gt; ç²˜è´´æ ‡é¢˜ -&amp;gt; å›åˆ°åŸæ–‡å¤åˆ¶åŸæ–‡å‘å¸ƒæ—¶é—´ -&amp;gt; ç²˜è´´åˆ°ä¸Šçº¿äº†çš„æ–‡ç« ä¸­ -&amp;gt; å¤åˆ¶åŸæ–‡æ­£æ–‡ -&amp;gt; ç²˜è´´åˆ°ä¸Šçº¿äº†çš„ç¼–è¾‘å™¨ä¸­ -&amp;gt; ç‚¹å‡»ä¸Šçº¿äº†çš„â€œä¸Šçº¿â€æŒ‰é’®ã€‚å¦‚æ­¤å¾€å¤å°±å¯ä»¥æŠŠæ‰€æœ‰æ–‡ç« éƒ½å¤åˆ¶å®Œã€‚&lt;/li>
&lt;li>ä»¥ä¸Šä¸€ç¯‡æ–‡ç« çš„å¤åˆ¶æ“ä½œï¼Œæˆ‘å¤§è‡´è§‰å¾— 60 ç§’ç»å¯¹è¶³å¤Ÿäº†ï¼Œäº‹å®ä¸Šå¯¹äºç†Ÿç»ƒæ“ä½œä¹‹ååº”è¯¥ä¸éœ€è¦è¿™ä¹ˆé•¿çš„æ—¶é—´&lt;/li>
&lt;li>æ‰€ä»¥ç†è®ºä¸Šå¤åˆ¶æ‰€æœ‰æ–‡ç« éœ€è¦çš„æ—¶é—´æ˜¯ï¼š &lt;code>218 x 60 = 13080 ç§’ = 218 åˆ†é’Ÿ = 3 å°æ—¶ 38 åˆ†é’Ÿ&lt;/code>&lt;/li>
&lt;li>è€Œæ›´åŠ åˆç†ä¸€ç‚¹çš„æ˜¯æŒ‰ç…§æ¯ä¸ªæ–‡ç«  30 ç§’ï¼Œé‚£æ€»ä½“çš„æ—¶é—´å°±æ˜¯å‡åŠçš„ï¼Œä¹Ÿå°±æ˜¯ &lt;code>1 å°æ—¶ 49 åˆ†é’Ÿ&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å¾ˆæœ‰æ„æ€ï¼Œå½“æˆ‘æƒ³çš„æ˜¯æˆ‘éœ€è¦å®Œæˆ &lt;code>218&lt;/code> ç¯‡æ–‡ç« çš„æ¬è¿çš„æ—¶å€™ï¼Œæˆ‘ä¸»è§‚ä¸Šè§‰å¾—è¿™æ˜¯ä¸€ä¸ªäººè‚‰æ“ä½œéš¾ä»¥çŸ­æ—¶é—´å†…å®Œæˆçš„ä»»åŠ¡ï¼Œè‡³å°‘å¯èƒ½è¦ä¸€æ•´å¤©éƒ½åœ¨å¹²è¿™ä¸ªäº‹æƒ…ï¼Œé™¤éç”¨ç¨‹åºæ¥è‡ªåŠ¨å®Œæˆã€‚ä½†æ˜¯é€šè¿‡åˆ†è§£å’Œè¯„ä¼°ï¼Œäº‹å®ä¸Šä¸ç®¡æ˜¯3ä¸ªå¤šå°æ—¶è¿˜æ˜¯2ä¸ªå°æ—¶ï¼Œæˆ‘éƒ½è§‰å¾—è¿™æ—¶é—´æ˜¯è¦æ¯”å†™ä»£ç å’Œè°ƒè¯•ç¨‹åºçš„æ—¶é—´çŸ­çš„ï¼Œè€Œä¸”ç»“æœå¯æ§çš„å¤šï¼šæˆ‘å¾ˆç¡®å®šè¿™æ˜¯ä¸€ä¸ªçº¯ç²¹çš„æ—¶é—´é—®é¢˜ï¼Œåªè¦æ— è„‘æ“ä½œï¼Œä¸€å®šæ—¶é—´åï¼Œè¿™ä¸ªäº‹æƒ…ä¸€å®šä¼šå®Œæˆï¼Œä¸ç”¨æ‹…å¿ƒè¿‡ç¨‹è¿˜æœ‰æ²¡æœ‰å¤§çš„é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="æœ€ç»ˆç»“æœäººè‚‰æ“ä½œå®Œæˆç”¨æ—¶-2-ä¸ªå°æ—¶å‡ºå¤´">æœ€ç»ˆç»“æœï¼šäººè‚‰æ“ä½œå®Œæˆï¼Œç”¨æ—¶ 2 ä¸ªå°æ—¶å‡ºå¤´&lt;/h3>
&lt;p>å› ä¸ºæˆ‘å¸Œæœ›è¿™ä¸ªäº‹æƒ…æ— è®ºå¦‚ä½•ï¼Œéƒ½è¦å°½å¿«å®Œæˆï¼Œæ‰€ä»¥æˆ‘ç”¨æœ€ç¬¨ä¹Ÿæ˜¯æœ€ç¡®å®šçš„æ–¹æ³•ï¼šäººè‚‰å¤åˆ¶ç²˜è´´ã€‚ä» 9:45 å·¦å³å¼€å§‹ï¼Œåˆ° 12:05 å·¦å³å®Œæˆï¼Œä¸­é—´ä¹Ÿå¤„ç†å°‘é‡çš„æ¯”å¦‚ä¸Šçº¿äº†ç½‘é¡µå´©æºƒå¿…é¡»åˆ·æ–°ä¹‹ç±»çš„é—®é¢˜ï¼Œå¦‚æœæ˜¯ç»§ç»­ç”¨åŸæ¥çš„è„šæœ¬çš„æ–¹å¼ï¼Œæƒ³å¿…è¿™ç±»é—®é¢˜å› ä¸ºè¿˜è¦ä¿®æ”¹å’Œè°ƒè¯•ä»£ç ä¼šè®©æˆ‘æŠ“ç‹‚ï¼Œä½†æ˜¯äººæ˜¯æœ€çµæ´»çš„ï¼Œæ‰€ä»¥æˆ‘äººè‚‰æ“ä½œçš„è¯éƒ½æ˜¯é¡ºä¾¿çš„äº‹ã€‚å°½ç®¡é¡ºåˆ©å®Œæˆï¼Œä½†æ˜¯è¿‡ç¨‹å…¶å®å¾ˆç—›è‹¦ï¼šç‰¹åˆ«æ¯ç‡¥ä¹å‘³ï¼Œé‡å¤çš„æ“ä½œå¤šäº†ä¹‹åï¼Œç‰¹åˆ«å®¹æ˜“çŠ¯å›°ã€‚æˆ‘æ˜¯ä¸€è¾¹å¬ç€æ¯”è¾ƒå—¨çš„éŸ³ä¹ä¸€è¾¹æŠ–è…¿æ‰åšæŒå¼„å®Œçš„ã€‚&lt;/p>
&lt;h2 id="æœ€åçš„æ„Ÿæ‚Ÿ">æœ€åçš„æ„Ÿæ‚Ÿ&lt;/h2>
&lt;p>è¿™ä¸ªäº‹æƒ…å…¶å®å¾ˆçç¢ï¼Œä½†æ˜¯å¯¹æˆ‘è‡ªå·±æŒºå¤§æ„Ÿè§¦ï¼Œè®°å½•ä¸€ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>ä¸è¦æ‹¿ç€é”¤å­çœ‹å•¥éƒ½æ˜¯é’‰å­ï¼Œä½ å¯èƒ½éœ€è¦ä¸€æŠŠèµ·å­&lt;/strong>ï¼šä½œä¸ºç¨‹åºå‘˜ï¼Œå¯èƒ½ä¹ æƒ¯äºç”¨ä¸“ä¸šçš„è§†è§’æ¥å¤„ç†ç”Ÿæ´»ä¸­çš„äº‹æƒ…ï¼Œä»€ä¹ˆéƒ½æƒ³è¦ä»¥ç¼–ç¨‹çš„å½¢å¼æ¥è§£å†³ï¼Œä½†æ˜¯é€‚ç”¨æ€§æ˜¯æœ‰å‰æçš„ï¼šé’ˆå¯¹é—®é¢˜çš„ç¨‹åºæœ‰å¾ˆå¤§çš„å¤ç”¨çš„ä»·å€¼ï¼Œæ¯”å¦‚äº‹æƒ…æ˜¯é‡å¤æ‰§è¡Œçš„ï¼Œæˆ–è€…ï¼Œè¿™ä¸ªæ–¹æ¡ˆå¯ä»¥ç§»æ¤åˆ°å…¶ä»–ç±»ä¼¼çš„äº‹æƒ…ä¸Šï¼Œå¦åˆ™ï¼Œæœ€ç¬¨çš„æ–¹æ³•åè€Œæ›´æœ‰æ•ˆï¼Œæ‰€ä»¥ä¸è¦æ’æ–¥é‚£äº›çœ‹èµ·æ¥å¤ªç¬¨ä¸å¤Ÿé…·çš„æ–¹æ³•ï¼Œå¯èƒ½å®ƒä»¬åå€’æ˜¯æœ€æœ‰æ•ˆçš„ï¼›&lt;/li>
&lt;li>&lt;strong>å¤±è´¥ä¹Ÿå¯ä»¥æœ‰æ‰€å¾—ï¼Œåªæ˜¯å¯èƒ½æ€§ä»·æ¯”ä½&lt;/strong>ï¼šå¤±è´¥äº†çš„æ–¹æ¡ˆåªæ˜¯ä¸€ç§æ¢ç´¢ï¼Œå¯ä»¥å‘æ˜æœªçŸ¥ï¼Œæ¯”å¦‚æˆ‘ç¬¬ä¸€æ¬¡çŸ¥é“äº† selenium çš„ action chains å¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿé¼ æ ‡å’Œé”®ç›˜æ“ä½œï¼Œè¿™ç§å‘ç°å’Œç»éªŒæ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œé•¿æœŸæ¥çœ‹å¯èƒ½æ˜¯æœ‰ä»·å€¼çš„ï¼Œåªæ˜¯å½“ä¸‹å¯¹å®Œæˆä»»åŠ¡æ²¡æœ‰ä»€ä¹ˆå¸®åŠ©&lt;/li>
&lt;li>&lt;strong>é‡åŒ–åˆ†æï¼Œå¸®åŠ©è‡ªå·±ç»•å¼€æƒ…æ„Ÿé™·é˜±&lt;/strong>ï¼šå¦‚æœä¸€å¼€å§‹æˆ‘èƒ½å¤Ÿç›´æ¥è®¡ç®—ä¸€ä¸‹äººè‚‰æ“ä½œçš„æ—¶é—´æˆæœ¬çš„è¯ï¼Œæˆ‘å¾ˆå¯èƒ½å°±ä¸ä¼šå»å°è¯•å…¶ä»–æ–¹æ¡ˆäº†ï¼Œå› ä¸ºæ˜¾ç„¶è¿™ç§æœ¬æ–¹æ³•ç¡®å®šæ€§é«˜ï¼Œæˆ‘æ—©ç‚¹å®Œæˆå®ƒï¼Œæˆ‘å°±æ—©ç‚¹å¯ä»¥æŠ•å…¥åˆ°å…¶ä»–æœ‰ä»·å€¼çš„äº‹æƒ…ä¸Šï¼Œæˆ‘å¯ä»¥åšæ—¶é—´çš„ä¸»äººï¼Œè€Œä¸æ˜¯æŠŠæ—¶é—´å½“æˆèµŒæ³¨ï¼ŒèµŒè‡ªåŠ¨åŒ–çš„æ–¹æ¡ˆèƒ½æˆåŠŸï¼Œå¹¶ä¸”ä¸€åˆ‡é¡ºåˆ©ï¼›&lt;/li>
&lt;li>&lt;strong>æŠŠä»¤äººç•æƒ§çš„å¤§ç›®æ ‡æ‹†æˆç»™æˆ‘ä¿¡å¿ƒçš„å°ç›®æ ‡&lt;/strong>ï¼šäººè‚‰å¤åˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘åˆ»æ„ä¸å»å…³æ³¨ç›®å‰å‰©ä½™çš„æ€»çš„æ–‡ç« æ•°é‡ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…ç»™è‡ªå·±é€ æˆå‹åŠ›ï¼Œåªä¸“æ³¨äºçœ¼ä¸‹æŸä¸€å—çš„ä»»åŠ¡å°±å¥½ï¼Œå‘Šè¯‰è‡ªå·±ï¼Œåªè¦æ…¢æ…¢å®Œæˆæ¯ä¸€ä¸ªå—å°±å¥½äº†ã€‚æ‰€ä»¥å¾€å¾€æˆ‘ä»¬ç›¯ç€ä¸€ä¸ªå¾ˆå¤§çš„ç›®æ ‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æ³„æ°”ï¼Œä½†æ˜¯å¦‚æœæŠŠå®ƒæ‹†è§£æˆä¸€ä¸ªä¸ªæ¯”è¾ƒå°çš„æˆ‘ä»¬æœ‰ä¿¡å¿ƒå®Œæˆçš„å°ç›®æ ‡æ—¶ï¼Œæˆ‘ä»¬åå€’å®¹æ˜“ä¿æŒä¸“æ³¨ï¼Œæœ€ç»ˆå®Œæˆã€‚&lt;/li>
&lt;/ol>
&lt;p>æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„ä¸¤ä¸ªæ„Ÿæ‚Ÿå°±æ˜¯ 1 å’Œ 3ã€‚&lt;/p></description></item><item><title>æˆ‘çš„åˆ»æ„ç»ƒä¹ â€”â€”åŒæ‹¼è¾“å…¥</title><link>https://blog.hackerpie.com/posts/skills/double-input-method/</link><pubDate>Thu, 23 Dec 2021 14:38:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/skills/double-input-method/</guid><description>&lt;p>ä½œä¸ºä¸€ä¸ªç¨‹åºå‘˜ï¼Œæ¯å¤©éƒ½éœ€è¦å’Œé”®ç›˜æ‰“äº¤é“ï¼Œè‡ªç„¶å°‘ä¸äº†æ‰“å­—è¿™ä¸ªäº‹æƒ…ï¼Œä»¥å‰å°±çŸ¥é“æœ‰äº”ç¬”è¾“å…¥æ³•ï¼Œä½†æ˜¯ä¹Ÿå¬è¯´ç»ƒä¹ èµ·æ¥å¾ˆéš¾ï¼ŒåŠ ä¸Šæ‹¼éŸ³è¾“å…¥æ³•å¾ˆç®€ä¾¿ï¼Œè‡ªç„¶å°±ä½¿ç”¨çš„æ‹¼éŸ³è¾“å…¥æ³•ã€‚ä½†æ˜¯ä¹…äº†ä¹‹åï¼Œæ€»æ˜¯è§‰å¾—å…¨æ‹¼è¾“å…¥æ³•å¤ªæ­»æ¿äº†ï¼Œæœ‰æ²¡æœ‰ä¸éœ€è¦é€ä¸ªæ‰“å…¥æ¯ä¸ªæ‹¼éŸ³å­—æ¯å°±å¯ä»¥å¿«é€Ÿæ‰“å‡ºéœ€è¦çš„å­—çš„è¾“å…¥æ³•çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰çš„ï¼šåŒæ‹¼è¾“å…¥æ³•ï¼Œæ˜¯çš„ï¼Œå°±æ˜¯æˆ‘åœ¨å†™è¿™ç¯‡æ–‡ç« æ—¶æ‰€ä½¿ç”¨çš„è¾“å…¥æ³•ã€‚å½“ç„¶ï¼Œæˆ‘ç°åœ¨çš„æ‰“å­—é€Ÿåº¦å°±è·Ÿä¹Œé¾Ÿçˆ¬è¡Œä¸€æ ·æ…¢â€¦â€¦&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯åŒæ‹¼è¾“å…¥æ³•å‘¢">ä»€ä¹ˆæ˜¯åŒæ‹¼è¾“å…¥æ³•å‘¢ï¼Ÿ&lt;/h2>
&lt;p>ä¸å…¨æ‹¼è¾“å…¥æ³•éœ€è¦æŒ¨ä¸ªè¾“å…¥æ‹¼éŸ³å­—æ¯ä¸åŒçš„æ˜¯ï¼ŒåŒæ‹¼æ˜¯å°†æ±‰è¯­æ‹¼éŸ³ä¸­çš„æ‰€æœ‰å£°æ¯å’ŒéŸµæ¯éƒ½æ˜ å°„åˆ°é”®ç›˜ä¸Šï¼Œæ‰€ä»¥æ‰“å­—çš„æ—¶å€™ï¼Œæˆ‘ä»¬çš„æ€ç»´è½¬å›è‡ªç„¶çš„æ‹¼éŸ³è§„å¾‹ï¼šå£°æ¯+éŸµæ¯ï¼Œéå¸¸ç®€å•ç›´è§‚ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºæ¯ä¸ªæ±‰å­—ï¼Œå›ºå®šåªéœ€è¦ 2 æ¬¡æ•²å‡»é”®ç›˜å°±å¯ä»¥äº†ï¼Œæ¯”èµ·å…¨æ‹¼è‡ªç„¶æ˜¯ä¼šæ›´é«˜æ•ˆçš„ï¼Œåªæ˜¯åˆšå¼€å§‹ä»å…¨æ‹¼åˆ‡æ¢è¿‡æ¥ç¡®å®å¾ˆç—›è‹¦ï¼Œæˆ‘è‡ªå·±ä¹Ÿæ˜¯åœ¨åˆ»æ„ç»ƒä¹ ä¸­ã€‚æ¯”å¦‚â€œåŒæ‹¼è¾“å…¥æ³•â€è¿™äº”ä¸ªå­—ï¼Œå¯¹åº”çš„æ‹¼éŸ³å°±æ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>shuang pin shu ru fa
&lt;/code>&lt;/pre>&lt;p>æŒ‰ç…§å£°æ¯å’ŒéŸµæ¯åˆ†å¼€çš„è¯ï¼Œå°±æ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>sh uang
p in
sh u
r u
f a
&lt;/code>&lt;/pre>&lt;p>ä»¥å°é¹¤åŒæ‹¼æ¥è®²ï¼Œå¯¹åº”çš„é”®ç›˜è¾“å…¥é¡ºåºå°±æ˜¯ï¼š&lt;code>u&lt;/code>ã€&lt;code>l&lt;/code>ã€&lt;code>p&lt;/code>ã€&lt;code>b&lt;/code>ã€&lt;code>u&lt;/code>ã€&lt;code>u&lt;/code>ã€&lt;code>r&lt;/code>ã€&lt;code>u&lt;/code>ã€&lt;code>f&lt;/code>ã€&lt;code>a&lt;/code>ã€‚&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/typewriting/double_input_method_example.png" alt="">
&lt;/p>
&lt;p>æ‰€ä»¥åŒæ‹¼è¾“å…¥æ³•çš„åŸç†æå…¶ç®€å•ï¼Œä½†æ˜¯ç»ƒä¹ èµ·æ¥è¿˜æ˜¯æœ‰ä¸€äº›ç—›è‹¦çš„ã€‚&lt;/p>
&lt;h2 id="ä¸ªäººç»ƒä¹ çš„å¿ƒå¾—ä½“ä¼š">ä¸ªäººç»ƒä¹ çš„å¿ƒå¾—ä½“ä¼š&lt;/h2>
&lt;h3 id="ç¬¬ä¸€å‘¨">ç¬¬ä¸€å‘¨&lt;/h3>
&lt;p>ç¬¬ä¸€å‘¨çš„æ‰“å­—é€Ÿåº¦è·Ÿé¾Ÿé€Ÿä¸€æ ·ï¼ŒåŸºæœ¬ä¸Šæ˜¯æ‰“æ¯ä¸ªå­—éƒ½å¾—åœé¡¿ä¸€ä¸‹æå‰æƒ³ä¸‹æ¥ä¸‹æ¥æ¯ä¸ªå­—çš„æ‹¼éŸ³ä»¥åŠå¯¹åº”çš„ç é”®ã€‚è¿™æœŸé—´ï¼Œæˆ‘å¯ä»¥æŠŠæˆ‘çš„ç”µè„‘å’Œæ‰‹æœºçš„è¾“å…¥æ³•éƒ½æ”¹ä¸ºåŒæ‹¼ï¼Œä½¿ç”¨çš„å°é¹¤åŒæ‹¼ï¼Œè™½ç„¶æ‰“å­—é€Ÿåº¦æ…¢å¾—å«äººåˆ«æ‰­ï¼Œä½†æ˜¯è¿˜æ˜¯å¯ä»¥å‹‰å¼ºå¿å—çš„ã€‚&lt;/p>
&lt;h3 id="ç¬¬äºŒå‘¨">ç¬¬äºŒå‘¨&lt;/h3>
&lt;p>ç»è¿‡ç¬¬ä¸€å‘¨çš„åˆ»æ„ç»ƒä¹ åï¼ŒåŸºæœ¬ä¸Šå°±èƒ½è®°ä½æ¯ä¸ªåŒæ‹¼ç çš„é”®ä½äº†ï¼Œæ‰€ä»¥æ‰“å­—é€Ÿåº¦æœ‰ä¸€å®šç¨‹åº¦çš„æå‡ï¼Œè¿™ä¸ªé˜¶æ®µçš„æœ€å¤§é—®é¢˜å°±æ˜¯ç»å¸¸ä¸è‡ªè§‰å°±æŒ‰ç…§å…¨æ‹¼çš„è¾“å…¥æ³•æ¥æ‰“å­—äº†ï¼Œæ¯”å¦‚æƒ³è¦æ‰“â€œæˆâ€å­—ï¼Œä¸€æ‰“å¾—å¿«äº†ï¼Œå°±æ˜¯å…ˆæ‰“äº†â€œcâ€ï¼Œå®é™…ä¸Šåº”è¯¥æ˜¯â€œiâ€ã€‚åˆæˆ–è€…æ˜¯â€œå°±â€è¿™ä¸ªå­—ï¼Œåº”è¯¥æ˜¯â€œjqâ€ï¼Œä½†æ˜¯æ€»æ˜¯ä¸€é¡ºæ‰‹å°±æ‰“æˆäº†â€œjiâ€ï¼Œå“ªæ€•ç°åœ¨å·²ç»æ˜¯ç¬¬ä¸‰å‘¨äº†ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚é™¤äº†è¾“å…¥ä¹ æƒ¯çš„é”™è¯¯ï¼Œå¦ä¸€ä¸ªé”™è¯¯å°±æ˜¯æ²¡æœ‰é€‰å¯¹å­—ï¼Œå› ä¸ºæ‰“å­—çš„æ—¶å€™æ³¨æ„åŠ›éƒ½åœ¨æ€è€ƒé”®ä½å’Œçº æ­£è¾“å…¥çš„é”®ä¸Šï¼Œæ‰€ä»¥æ€»æ˜¯ä¸è‡ªè§‰åˆšæŠŠæ‹¼éŸ³æ‰“å®Œï¼Œå°±ç›´æ¥ç©ºæ ¼äº†ï¼Œç»“æœå¾ˆå¯èƒ½é€‰åˆ°çš„è¯æ˜¯é”™è¯¯çš„ã€‚&lt;/p>
&lt;h3 id="ç¬¬ä¸‰å‘¨æ­¤åˆ»æ˜¯2022-01-12çš„ä¸Šåˆ">ç¬¬ä¸‰å‘¨ï¼ˆæ­¤åˆ»æ˜¯2022-01-12çš„ä¸Šåˆï¼‰&lt;/h3>
&lt;p>ç¬¬ä¸‰å‘¨ä¼šå’Œç¬¬äºŒå‘¨å·®ä¸å¤šï¼Œä¼šç¨å¾®æ›´æ³¨æ„å€™é€‰è¯çš„é—®é¢˜ï¼Œä½†æ˜¯ä»æ—§æ²¡æœ‰å½»åº•æ”¹æ‰å…¨æ‹¼é—ç•™çš„è¾“å…¥ä¹ æƒ¯ï¼Œå®¹æ˜“ä¸€å¿«äº†å°±æ•²é”™é”®ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æ—¶å€™çš„æ‰“å­—éƒ½è¿˜æ˜¯éœ€è¦åœ¨é€€æ ¼å’Œé‡æ–°è¾“å…¥ä¸­å¾€å¤ã€‚ä¸è¿‡å¥½çš„ä¸€ç‚¹æ˜¯ï¼Œæ‰“å­—é€Ÿåº¦è¿˜æ˜¯æœ‰ä¸€äº›æå‡çš„ï¼Œä¸€äº›å¸¸ç”¨å­—å¯ä»¥å¾ˆå¿«ç”šè‡³è‚Œè‚‰è®°å¿†èˆ¬æ•²å‡ºæ¥äº†ï¼Œæ•´ä½“é¡ºåˆ©å’Œæµç•…çš„è¯ï¼Œä¹Ÿèƒ½æ„Ÿå—åˆ°åŒæ‹¼å¸¦ç»™äººçš„èŠ‚å¥æ„Ÿï¼ŒæœŸå¾…æœªæ¥æŸä¸€å¤©èƒ½å¤Ÿé ç€åŒæ‹¼è¾“å…¥æ³•ä¸€â€œå†™â€åƒé‡Œã€‚&lt;/p>
&lt;h2 id="æ„Ÿæ‚Ÿ">æ„Ÿæ‚Ÿ&lt;/h2>
&lt;ul>
&lt;li>åˆ»æ„ç»ƒä¹ ï¼Œå°±æ˜¯å†³å¿ƒæŠŠè‡ªå·±ä¸¢è¿›ä¸é€‚åº”çš„çŠ¶æ€ä¸­ï¼Œå¹¶ä¸”å°è¯•åœ¨&lt;strong>ä¸æ”¹å˜ç¯å¢ƒ&lt;/strong>çš„å‰æä¸‹åŠªåŠ›æ”¹å˜çŠ¶æ€ï¼Œæ¯”å¦‚æˆ‘ä¸€å¼€å§‹å°±æ•…æ„å°†è‡ªå·±çš„æ‰€æœ‰è®¾å¤‡çš„è¾“å…¥æ³•éƒ½æ”¹ä¸ºåŒæ‹¼ï¼Œåæ¥è·Ÿåˆ«äººèŠå¤©çš„æ—¶å€™ï¼Œå‘ç°è‡ªå·±æ‰“å­—å¥½æ…¢ï¼Œè¿˜ç‰¹åˆ«å¤šé”™å­—ï¼Œç‰¹åˆ«ç€æ€¥ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™æˆ‘ä¹Ÿæ²¡æœ‰å»ä¸´æ—¶æ”¹å›å…¨æ‹¼ï¼Œè€Œæ˜¯åšæŒç»§ç»­ç”¨åŒæ‹¼ï¼Œæ…¢æ…¢å°±å‘ç°æ‰“å­—é€Ÿåº¦è¿˜æ˜¯èƒ½æå‡ï¼Œä¹Ÿå°±å†ä¹Ÿæ²¡æœ‰å¿…è¦è€ƒè™‘æ”¹å›åŒæ‹¼è¾“å…¥äº†ã€‚æƒ³èµ·ä»¥å‰æˆ‘çº æ­£è‡ªå·±æ‰“å­—æ—¶å€™çš„æŒ‡æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å¥½çœ‹çš„ç è¡¨å›¾">å¥½çœ‹çš„ç è¡¨å›¾&lt;/h2>
&lt;p>ä»¥ä¸‹å›¾ç‰‡æ˜¯æˆ‘ä»çŸ¥ä¹è®¨è®ºåŒºï¼ˆæ–‡æœ«é™„äº†é“¾æ¥ï¼‰çœ‹åˆ°çš„ä¸€ä¸ªå›¾ç‰‡ï¼Œæˆ‘è§‰å¾—æ¯”è¾ƒå¥½çœ‹ï¼Œå°±æ‹¿æ¥å½“å£çº¸äº†ï¼Œä»¥å¤‡å¯¹åŒæ‹¼ç è¡¨ä¸ç†Ÿæ‚‰çš„æ—¶å€™å¯ä»¥ç›´æ¥å›åˆ°æ¡Œé¢çœ‹çœ‹ï¼Œä½†æ˜¯å®é™…ä¸Šä¹ŸåŸºæœ¬æ²¡æœ‰ç”¨ä¸Šï¼Œåˆ†äº«ç»™æœ‰éœ€è¦çš„åŒå­¦ã€‚
&lt;img src="https://blog.hackerpie.com/images/posts/typewriting/xiaohe_shuangpin_keyboard.jpeg" alt="">
&lt;/p>
&lt;h2 id="å­¦ä¹ èµ„æ–™">å­¦ä¹ èµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.zhihu.com/question/20698750">çŸ¥ä¹ï¼šæ€æ ·è®°å¿†åŒæ‹¼è¾“å…¥æ³•çš„å›ç­”&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Unicodeï¼ŸUTF-8ï¼ŸGBKï¼Ÿâ€¦â€¦èŠèŠå­—ç¬¦é›†å’Œå­—ç¬¦ç¼–ç æ ¼å¼</title><link>https://blog.hackerpie.com/posts/text-processing/character-sets-and-encoding-formats/</link><pubDate>Sun, 12 Dec 2021 18:25:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/text-processing/character-sets-and-encoding-formats/</guid><description>&lt;h2 id="æŒ‰ç…§ä¹ æƒ¯èµ·ä¸ªè°ƒ">æŒ‰ç…§ä¹ æƒ¯èµ·ä¸ªè°ƒ&lt;/h2>
&lt;p>ä½œä¸ºç¨‹åºå‘˜ï¼Œç»å¸¸ä¼šåœ¨ç¼–ç¨‹è¯­è¨€ã€æ“ä½œç³»ç»Ÿã€ç½‘ç»œä»¥åŠæ–‡æœ¬ç¼–è¾‘ç­‰å¤šä¸ªå±‚é¢é‡ä¸Šå­—ç¬¦é›†æˆ–è€…å­—ç¬¦ç¼–ç çš„é—®é¢˜ï¼Œå°½ç®¡ä¸€èˆ¬éƒ½èƒ½å¿«é€Ÿé€šè¿‡æœç´¢å¼•æ“æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å¯¹äºè¿™ç§å­—ç¬¦é›†ä»¥åŠå…¶ç›¸å…³çš„å­—ç¬¦ç¼–ç æ ¼å¼çš„çŸ¥è¯†ï¼Œå€’æ˜¯æœªæ›¾ç³»ç»Ÿæ¢³ç†ã€‚æ°é€¢è¿‘æœŸæœ‰äº†ä¸€äº›æ”¶è·ï¼Œè¶çƒ­è®°å½•åˆ†äº«ä¸‹ã€‚&lt;/p>
&lt;h2 id="ä»-unicode-å’Œ-utf-8-è¯´èµ·">ä» Unicode å’Œ UTF-8 è¯´èµ·&lt;/h2>
&lt;p>å¯¹äºç±» Unix æ“ä½œç³»ç»Ÿï¼ˆæ¯”å¦‚ Mac OS ä»¥åŠ Linux æ“ä½œç³»ç»Ÿç­‰ï¼‰çš„ç”¨æˆ·æ¥è¯´ï¼Œä¼šæ›´å¤šåœ°æ¥è§¦ UTF-8 ç¼–ç æ ¼å¼ï¼Œæˆ‘ä¹Ÿæ˜¯å…¶ä¸­ä¸€ä¸ªã€‚è€Œæˆ‘è¿‡å¾€æ€»æ˜¯å®¹æ˜“è·Ÿå¦ä¸€ä¸ªè¯â€”â€” Unicode æ··æ·†ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åœ¨è®¨è®º UTF-8 å’Œ Unicode çš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨è®¨è®ºä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;h3 id="unicode-å­—ç¬¦é›†ç®€ä»‹">Unicode å­—ç¬¦é›†ç®€ä»‹&lt;/h3>
&lt;p>å½“æˆ‘ä»¬è¯´ Unicode çš„æ—¶å€™ï¼Œæ˜¯åœ¨è®¨è®ºä¸€ç§å­—ç¬¦é›†ï¼ˆcharacter setï¼‰ã€‚Unicode ç¿»è¯‘æˆä¸­æ–‡å«â€œç»Ÿä¸€ç â€ï¼Œæ˜¯ä¸€ç§å¯ä»¥ç®€å•ç†è§£ä¸ºæ”¶å½•äº†ä¸–ç•Œä¸Šæ‰€æœ‰è¯­è¨€çš„æ–‡å­—å’Œç¬¦å·çš„å…¨çƒæ ‡å‡†ã€‚å¤§å®¶çŸ¥é“ï¼Œè‹±è¯­çš„åŸºæœ¬ç»„æˆå…ƒç´ æ˜¯ 26 ä¸ªè‹±æ–‡å­—æ¯åŠ ä¸Šå„ç§æ ‡ç‚¹ç¬¦å·ï¼›è€Œæ±‰è¯­çš„æ–‡å­—åˆ™ç›¸å¯¹ç¹æ‚ï¼Œå¤§é‡æ±‰å­—ï¼Œæ¯ä¸ªæ–‡å­—éƒ½æœ‰å„è‡ªçš„æ‹¼éŸ³ï¼Œæ‹¼éŸ³é‡Œè¿˜è¦åŒºåˆ†éŸ³è°ƒï¼Œè¿™é‡Œæåˆ°çš„æ±‰å­—ã€æ‹¼éŸ³ã€éŸ³è°ƒä»¥åŠæ±‰å­—è‡ªèº«çš„æ ‡ç‚¹ç¬¦å·ï¼Œè·Ÿè‹±è¯­çš„è‹±æ–‡å­—æ¯ä»¥åŠæ ‡ç‚¹ç¬¦å·ç­‰ï¼Œç»Ÿç»Ÿæ”¶å½•åœ¨äº† Unicode å­—ç¬¦é›†ä¸­ï¼Œè€Œç±»ä¼¼çš„ï¼Œè¿˜æœ‰ç¹ä½“ä¸­æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡ã€ä¿„ç½—æ–¯è¯­ã€è¶Šå—è¯­ã€æ³°è¯­ã€è’™å¤è¯­ç­‰ç­‰ã€‚&lt;/p>
&lt;p>æ”¶å½•äº†è¿™ä¹ˆå¤šçš„å­—ç¬¦ï¼Œå°±ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šæ€ä¹ˆæ•´ç†å’Œç¼–æ’è®°å½•è¿™äº›å†…å®¹å‘¢ï¼Ÿç¼–å·ï¼ç±»æ¯”åœ¨ä¸€äº›å¸¸è§çš„åœºæ™¯ä¸­ï¼Œå½“ä¸€ä¸ªé›†ä½“ä¸­åŒ…å«å¾ˆå¤šçš„ä¸ªä½“æ—¶ï¼Œä¸ºäº†ç”¨ä¸€ç§ç»Ÿä¸€ä¸”ç®€å•çš„æ–¹å¼åŒºåˆ†ï¼Œæˆ‘ä»¬æœ€å®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯ç¼–å·ã€‚æ¯”å¦‚ï¼Œç»™ç­é‡Œçš„åŒå­¦å®‰æ’åº§ä½å·ï¼Œç»™å­¦ç”Ÿå®‰æ’å­¦å·ï¼Œç»™å‘˜å·¥å®‰æ’å·¥å·ï¼Œç­‰ç­‰ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œè®¡ç®—æœºæ˜¯ä¸èƒ½ç›´æ¥ç†è§£åè¿›åˆ¶è¿™ç§äººç±»æ˜“äºç†è§£çš„æ•°å­—çš„ï¼Œå®ƒåªèƒ½ç†è§£äºŒè¿›åˆ¶çš„æ•°å€¼ï¼Œæ‰€ä»¥ï¼Œåœ¨è®¡ç®—æœºé‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ç¼–ç ï¼ˆä½¿ç”¨ç‰¹å®šçš„äºŒè¿›åˆ¶åºåˆ—æ¥è¡¨ç¤ºä¸€ä¸ªç‰¹å®šçš„å€¼ï¼‰çš„æ–¹å¼æ¥ç»™è¿™äº›å­—ç¬¦å’Œç¬¦å·è¿›è¡Œä¸€ä¸€æ˜ å°„ã€‚ç›®å‰ Unicode å®é™…åº”ç”¨ç‰ˆæœ¬ UCS-2 åœ¨è®¡ç®—æœºä¸­ä½¿ç”¨äº† 2 ä¸ªå­—èŠ‚æ¥ç¼–ç ä¸€ä¸ªå­—ç¬¦ï¼Œä¹Ÿå°±æ˜¯ 16 ä½çš„ç¼–ç ç©ºé—´ï¼Œåœ¨è¡¨ç¤ºä¸Šï¼Œé‡‡ç”¨ç±»å¦‚ &lt;code>U+????&lt;/code> çš„å½¢å¼ï¼Œå…¶ä¸­æ¯ä¸ªâ€œ?â€éƒ½æ˜¯ä¸€ä¸ªåå…­è¿›åˆ¶æ•°ã€‚æ³¨æ„ï¼ŒUnicode è¿˜æœ‰ä¸ª 4 å­—èŠ‚ç¼–ç ç‰ˆæœ¬ï¼Œäº¦å³ UCS-4ï¼Œä¸åœ¨è¿™é‡Œè®¨è®ºã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹çš„ Unicode å­—ç¬¦åŠå…¶å¯¹åº”ç¼–ç ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å­—ç¬¦&lt;/th>
&lt;th>ç¼–ç å€¼&lt;/th>
&lt;th>è¯´æ˜&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>ç‰›&lt;/td>
&lt;td>U+725B&lt;/td>
&lt;td>æ±‰å­—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Ã¹&lt;/td>
&lt;td>U+00F9&lt;/td>
&lt;td>æ‹¼éŸ³ u çš„å››å£°&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>,&lt;/td>
&lt;td>U+002C&lt;/td>
&lt;td>è‹±æ–‡é€—å·&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ï¼Œ&lt;/td>
&lt;td>U+FF0C&lt;/td>
&lt;td>ä¸­æ–‡é€—å·&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ğŸ˜&lt;/td>
&lt;td>U+D83D&lt;/td>
&lt;td>emoji è¡¨æƒ…ï¼šç¬‘è„¸&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>âš”&lt;/td>
&lt;td>U+2694&lt;/td>
&lt;td>emoji è¡¨æƒ…ï¼šå‰‘&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æ˜¯ä¸æ˜¯æŒºæœ‰æ„æ€çš„ï¼Ÿå¦å¤–æ˜¯å¦ä¹Ÿæ³¨æ„åˆ°ï¼ŒåŒæ ·æ˜¯é€—å·ï¼Œä½†æ˜¯è‹±æ–‡çš„é€—å·å’Œä¸­æ–‡çš„é€—å·ï¼Œå¹¶ä¸æ˜¯åŒä¸€ä¸ªç¬¦å·ï¼Œå“ªæ€•çœ‹èµ·æ¥éå¸¸ç›¸ä¼¼ï¼ç›¸ä¿¡å¾ˆå¤šåˆå­¦ç¼–ç¨‹çš„åŒå­¦ä¹Ÿéƒ½è¸©è¿‡åœ¨ä»£ç ä¸­è¾“å…¥äº†ä¸­æ–‡é€—å·å¯¼è‡´ä»£ç ç¼–è¯‘å‡ºé”™çš„å‘å§ï¼&lt;/p>
&lt;h3 id="utf-8--ä¸€ç§å˜é•¿çš„-unicode-å­—ç¬¦ç¼–ç è½¬æ¢æ ¼å¼">UTF-8 â€”â€” ä¸€ç§å˜é•¿çš„ Unicode å­—ç¬¦ç¼–ç è½¬æ¢æ ¼å¼&lt;/h3>
&lt;p>ä¸Šé¢ Unicode çš„ç¼–ç æ–¹å¼å·²ç»ç†è§£äº†ï¼Œä½†æ˜¯é‚£è¿˜åªæ˜¯è¡¨ç¤ºå±‚é¢çš„ï¼Œå­—ç¬¦åœ¨è®¡ç®—æœºä¸–ç•Œé‡Œï¼Œéœ€è¦è¢«ä¼ è¾“å’Œå­˜å‚¨ç­‰ï¼Œè¿™ç§æƒ…å†µä¸‹åˆè¯¥è®¾è®¡å‘¢ï¼Ÿæœ€ç®€å•çš„æ–¹å¼å½“ç„¶æ˜¯ç›´æ¥åŸæ ·ä½¿ç”¨æ¯ä¸ªå­—ç¬¦çš„ä¸¤ä¸ªå­—èŠ‚å³å¯ï¼ˆäº‹å®ä¸Šï¼ŒUTF-16 å³æ˜¯è¿™ç§æ€è·¯ï¼‰ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼æœ‰ä¸¤ç§é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹äºè‹±è¯­è¿™ç±»åªéœ€è¦ä¸€äº›éå¸¸ç®€å•çš„å­—ç¬¦å°±è¶³å¤Ÿçš„è¯­è¨€æ¥è¯´ï¼Œå•å­—èŠ‚çš„ ASCII å­—ç¬¦é›†(ä¸€ç§ä¸»è¦åŒ…å«è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œæ ‡ç‚¹ç¬¦å·ä»¥åŠå…¶ä»–ä¸å¯è§å­—ç¬¦çš„å­—ç¬¦é›†ï¼Œæ€»å…± 128 ä¸ªå­—ç¬¦)åˆšå¥½å°±è¶³ä»¥ä½¿ç”¨ï¼Œå¦‚æœä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚ï¼Œæ— ç–‘æ˜¯æµªè´¹äº†ä¸€åŠçš„å­˜å‚¨ç©ºé—´ï¼›&lt;/li>
&lt;li>å–å†³äºå…·ä½“çš„å­—èŠ‚åºï¼Œæˆ‘ä»¬åœ¨å­˜å‚¨å’Œä¼ è¾“å±‚é¢è¿˜å¾—è€ƒè™‘å­—ç¬¦ç¼–ç çš„å¤§ç«¯åºæˆ–è€…å°ç«¯åºé—®é¢˜ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œ&lt;code>UTF-8&lt;/code> åº”è¿è€Œç”Ÿã€‚UTF å…¨ç§° Unicode Transformation Formatï¼Œä¸­æ–‡â€œUnicode è½¬æ¢æ ¼å¼â€ã€‚UTF-8 æ˜¯ä¸€ç§å˜é•¿ç¼–ç ï¼Œå…¶æœ€å¤§çš„ç‰¹ç‚¹æ˜¯å®Œå…¨å…¼å®¹ ASCII å­—ç¬¦ç¼–ç ï¼ˆæœ¬è´¨ä¸Šå¾—ç›Šäº Unicode å®Œå…¨å…¼å®¹ ASCII å­—ç¬¦é›†ï¼‰ï¼Œå¯¹äºæ‰€æœ‰åœ¨ ASCII å­—ç¬¦é›†ä¸­å‡ºç°çš„å­—ç¬¦ï¼Œå…¶åœ¨ UTF-8 ä¸­ä¹Ÿæ˜¯ä½¿ç”¨å®Œå…¨ä¸€æ ·çš„å•å­—èŠ‚è¡¨ç¤ºï¼Œä¸”äºŒè¿›åˆ¶ç å€¼å®Œå…¨ä¸€è‡´ã€‚&lt;/p>
&lt;p>æ¯”å¦‚å¯¹æ¯”ä»¥ä¸‹çš„å­—ç¬¦ï¼Œåœ¨ ASCII å­—ç¬¦é›†ä¸‹ä»¥åŠ Unicode å­—ç¬¦é›†ä¸­ï¼Œå’Œä½¿ç”¨ UTF-8 è¡¨ç¤ºçš„å€¼ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å­—ç¬¦&lt;/th>
&lt;th>ASCII ç å€¼ï¼ˆåè¿›åˆ¶è¡¨ç¤ºï¼‰&lt;/th>
&lt;th>Unicode ç å€¼&lt;/th>
&lt;th>UTF-8 è¡¨ç¤º&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>A&lt;/td>
&lt;td>65&lt;/td>
&lt;td>U+0041&lt;/td>
&lt;td>0100 0001&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>a&lt;/td>
&lt;td>97&lt;/td>
&lt;td>U+0061&lt;/td>
&lt;td>0110 0001&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>9&lt;/td>
&lt;td>57&lt;/td>
&lt;td>U+0039&lt;/td>
&lt;td>0011 1001&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>,&lt;/td>
&lt;td>44&lt;/td>
&lt;td>U+002C&lt;/td>
&lt;td>0010 1100&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>å› æ­¤ï¼Œå¯¹äºéœ€è¦å­˜å‚¨æˆ–è€…ä¼ è¾“åŒ…å«æœ‰è¾ƒå¤šçº¯è‹±æ–‡å­—ç¬¦çš„æ–‡æœ¬ï¼ŒUTF-8 çš„è¿™ç§æ ¼å¼èƒ½å¤ŸèŠ‚çœæ›´å¤šçš„å­˜å‚¨ç©ºé—´ï¼Œæ¯”å¦‚ç£ç›˜æˆ–è€…å†…å­˜ä»¥åŠç½‘ç»œå¸¦å®½ç­‰ï¼å¯¹äº UTF-8 çš„å®Œæ•´æ ¼å¼ï¼Œç¨åä¼šæœ‰å•ç‹¬çš„ä¸€ç« æ¥å…·ä½“åˆ†æã€‚&lt;/p>
&lt;h3 id="æ‰©å±•èŠèŠä¸»è¦é’ˆå¯¹æ±‰å­—çš„å­—ç¬¦é›†gbk-å’Œ-gb18030">æ‰©å±•ï¼šèŠèŠä¸»è¦é’ˆå¯¹æ±‰å­—çš„å­—ç¬¦é›†â€”â€”GBK å’Œ GB18030&lt;/h3>
&lt;p>ä¸Šé¢èŠåˆ° UTF-8 ä¼˜åŒ–äº†è‹±æ–‡å­˜å‚¨ç©ºé—´å ç”¨çš„é—®é¢˜ï¼Œè€Œä¸” Unicode ä¹Ÿæ˜¯ä¼˜å…ˆæ”¶å½•äº†å„ç±»è¥¿æ–¹è¯­è¨€çš„å­—ç¬¦ã€‚é‚£æœ‰æ²¡æœ‰ä¸“é—¨é’ˆå¯¹æˆ‘ä»¬æ±‰å­—çš„æ–¹æ¡ˆå‘¢ï¼Ÿæœ‰çš„ï¼ŒGBKï¼&lt;/p>
&lt;p>GBKï¼Œå…¨ç§°â€œæ±‰å­—å†…ç æ‰©å±•è§„èŒƒâ€ï¼Œå…¨åä¸ºã€Šæ±‰å­—å†…ç æ‰©å±•è§„èŒƒ(GBK)ã€‹1.0ç‰ˆã€‚GBKå…±æ”¶å½•21886ä¸ªæ±‰å­—å’Œå›¾å½¢ç¬¦å·ï¼Œå…¶ä¸­æ±‰å­—ï¼ˆåŒ…æ‹¬éƒ¨é¦–å’Œæ„ä»¶ï¼‰21003ä¸ªï¼Œå›¾å½¢ç¬¦å·883ä¸ªã€‚æ‰€ä»¥ GBK æ˜¯ä¸€ç§ä¸»è¦æ”¶å½•æ±‰å­—çš„å­—ç¬¦é›†ã€‚&lt;/p>
&lt;p>GBK äº 1995 å¹´ 12 æœˆ 15 æ—¥å‘å¸ƒï¼Œè€Œ 2000 å¹´å›½å®¶è´¨é‡æŠ€æœ¯ç›‘ç£å±€æ¨å‡ºäº† GB18030-2000 æ ‡å‡†ï¼Œç”¨ä»¥å–ä»£ GBKï¼ŒGB18030 å®Œå…¨å…¼å®¹ GBKã€‚è€Œ GB18030 åœ¨æœ¬è´¨ä¸Šä¹Ÿç®—å¾—ä¸Šæ˜¯ä¸€ç§ Unicode çš„è½¬æ¢æ ¼å¼ï¼ˆUTFï¼‰ï¼Œåªä¸è¿‡å…¶è½¬æ¢è¦æ¯” UTF-8 å¤æ‚å¾—å¤šï¼Œåœ¨æ­¤å°±ä¸å±•å¼€äº†ã€‚&lt;/p>
&lt;p>ç¨åçš„ä¸€äº›ä¾‹å­ä¸­è¿˜ä¼šæåˆ° GBK æˆ–è€… GB18030ï¼Œè¿™é‡Œä»…ä½œç®€å•ä»‹ç»ï¼Œæœ‰ä¸ªå°è±¡ï¼Œå¤§è‡´çŸ¥é“æ˜¯ä¸ªå•¥å³å¯ã€‚&lt;/p>
&lt;h2 id="utf-8-ç¼–ç æ ¼å¼åˆ†æ">UTF-8 ç¼–ç æ ¼å¼åˆ†æ&lt;/h2>
&lt;p>UTF-8 æ˜¯ä¸€ç§å˜é•¿ï¼ˆé•¿åº¦èŒƒå›´ä¸º 1-4 ä¸ªå­—èŠ‚ï¼‰çš„å­—ç¬¦ç¼–ç æ ¼å¼ï¼Œæ‰€ä»¥ä¸€ä¸ªå­—ç¬¦å¯¹åº”çš„å­—èŠ‚é•¿åº¦ï¼Œéœ€è¦ç»“åˆæ¯ä¸ªå­—èŠ‚å¼€å¤´çš„æ¯”ç‰¹ä½æ¥ç¡®è®¤ï¼Œå…·ä½“çš„è§„åˆ™æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹äºUTF-8ç¼–ç ä¸­çš„ä»»æ„å­—èŠ‚Bï¼Œå¦‚æœBçš„ç¬¬ä¸€ä½ä¸º0ï¼Œåˆ™Bç‹¬ç«‹çš„è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦(ASCIIç )ï¼›&lt;/li>
&lt;li>å¦‚æœBçš„ç¬¬ä¸€ä½ä¸º1ï¼Œç¬¬äºŒä½ä¸º0ï¼Œåˆ™Bä¸ºä¸€ä¸ªå¤šå­—èŠ‚å­—ç¬¦ä¸­çš„ä¸€ä¸ªå­—èŠ‚(éASCIIå­—ç¬¦)ï¼›&lt;/li>
&lt;li>å¦‚æœBçš„å‰ä¸¤ä½ä¸º1ï¼Œç¬¬ä¸‰ä½ä¸º0ï¼Œåˆ™Bä¸ºä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºçš„å­—ç¬¦ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼›&lt;/li>
&lt;li>å¦‚æœBçš„å‰ä¸‰ä½ä¸º1ï¼Œç¬¬å››ä½ä¸º0ï¼Œåˆ™Bä¸ºä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºçš„å­—ç¬¦ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼›&lt;/li>
&lt;li>å¦‚æœBçš„å‰å››ä½ä¸º1ï¼Œç¬¬äº”ä½ä¸º0ï¼Œåˆ™Bä¸ºå››ä¸ªå­—èŠ‚è¡¨ç¤ºçš„å­—ç¬¦ä¸­çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ‰€ä»¥ï¼Œå¯¹äºæœ€é•¿çš„ 4 å­—èŠ‚ç¼–ç ï¼Œå…¶å¯è¡¨ç¤ºçš„æœ€å¤§ä½æ•°ä¸º 21ï¼ˆé¦–å­—èŠ‚å‰©ä½™ 3 ä½ï¼Œåç»­ 3 ä¸ªå­—èŠ‚ï¼Œæ¯ä¸ªå­—èŠ‚æœ‰ 6 ä½ï¼Œ 3+3x6=21ï¼‰ã€‚&lt;br>
ä¸Šé¢çš„è§„åˆ™æ¯”è¾ƒç»•ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬æ¥åˆ—ä¸¾ä¸‹æ‰€æœ‰å¯èƒ½çš„æ¯”ç‰¹åºåˆ—ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>â‘  å•å­—èŠ‚çš„æƒ…å†µï¼Œå¯¹åº” ASCIIï¼š
0???????
â‘¡ åŒå­—èŠ‚çš„æƒ…å†µï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚å¿…é¡» 110 å¼€å¤´ï¼Œç¬¬äºŒä¸ªå­—èŠ‚å¼€å¤´å¿…é¡»æ˜¯ 10ï¼Œå‰©ä½™ 11 ä½ç”¨äºç¼–ç ï¼š
110????? 10??????
â‘¢ ä¸‰å­—èŠ‚çš„æƒ…å†µï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚å¿…é¡» 1110 å¼€å¤´ï¼Œç¬¬äºŒã€ä¸‰ä¸ªå­—èŠ‚å¼€å¤´éƒ½å¿…é¡»æ˜¯ 10ï¼Œå‰©ä½™ 16 ä½ç”¨äºç¼–ç ï¼š
1110???? 10?????? 10??????
â‘£ å››å­—èŠ‚çš„æƒ…å†µï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚å¿…é¡» 11110 å¼€å¤´ï¼Œåç»­ä¸‰ä¸ªå­—èŠ‚å¼€å¤´éƒ½å¿…é¡»æ˜¯ 10ï¼Œå‰©ä½™ 21 ä½ç”¨äºç¼–ç ï¼š
11110??? 10?????? 10?????? 10??????
&lt;/code>&lt;/pre>&lt;p>ä¸€äº›ç¤ºä¾‹çš„å¯¹åº”çš„ Unicode å­—ç¬¦åŠå…¶å¯¹åº”çš„ UTF-8 ç¼–ç ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>ç±»å‹&lt;/th>
&lt;th>Block&lt;/th>
&lt;th>å­—ç¬¦&lt;/th>
&lt;th>Unicode ç¼–ç &lt;/th>
&lt;th>UTF-8 ç¼–ç ï¼ˆ16è¿›åˆ¶ï¼‰&lt;/th>
&lt;th>UTF-8 ç¼–ç ï¼ˆäºŒè¿›åˆ¶è¡¨ç¤ºï¼‰&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>å•å­—èŠ‚&lt;/td>
&lt;td>åŸºæœ¬æ‹‰ä¸å­—æ¯&lt;/td>
&lt;td>&lt;code>a&lt;/code>&lt;/td>
&lt;td>U+0061&lt;/td>
&lt;td>\x61&lt;/td>
&lt;td>01100001&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>åŒå­—èŠ‚&lt;/td>
&lt;td>æ‹‰ä¸æ–‡è¡¥å……é›†&lt;/td>
&lt;td>&lt;code>Â£&lt;/code>&lt;/td>
&lt;td>U+00A3&lt;/td>
&lt;td>\xC2\xA3&lt;/td>
&lt;td>11000010 10100011&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ä¸‰å­—èŠ‚&lt;/td>
&lt;td>æ—¥æ–‡å¹³å‡å&lt;/td>
&lt;td>&lt;code>ã®&lt;/code>&lt;/td>
&lt;td>U+306E&lt;/td>
&lt;td>\xE3\x81\xAE&lt;/td>
&lt;td>11100011 10000001 10101110&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å››å­—èŠ‚&lt;/td>
&lt;td>è¶Šå—è¯­&lt;/td>
&lt;td>&lt;code>ğ¦“¡&lt;/code>&lt;/td>
&lt;td>U+D859&lt;/td>
&lt;td>\xF0\xA6\x93\xA1&lt;/td>
&lt;td>11110000 10100110 10010011 10100001&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>è€Œæˆ‘ä»¬ç†Ÿæ‚‰çš„å¸¸è§çš„æ±‰å­—ä½¿ç”¨çš„éƒ½æ˜¯ 3 å­—èŠ‚çš„ç¼–ç ã€‚&lt;/p>
&lt;h2 id="ä¸€äº›æœ‰è¶£çš„å­—ç¬¦ç¼–ç æ ¼å¼çš„ä¾‹å­">ä¸€äº›æœ‰è¶£çš„å­—ç¬¦ç¼–ç æ ¼å¼çš„ä¾‹å­&lt;/h2>
&lt;h3 id="æ“ä½œç³»ç»Ÿä¸­çš„é»˜è®¤å­—ç¬¦é›†å’Œè½¬æ¢æ ¼å¼">æ“ä½œç³»ç»Ÿä¸­çš„é»˜è®¤å­—ç¬¦é›†å’Œè½¬æ¢æ ¼å¼&lt;/h3>
&lt;p>åœ¨ Windows 10 ç®€ä½“ä¸­æ–‡ç‰ˆç³»ç»Ÿä¸­ï¼Œé€šè¿‡åœ¨å‘½ä»¤æç¤ºç¬¦ç¨‹åºä¸­è¾“å…¥å‘½ä»¤ &lt;code>chcp&lt;/code>ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°ç³»ç»Ÿæ´»åŠ¨ä»£ç é¡µä¸º 936ï¼Œå¯¹åº”çš„ç¼–ç æ ¼å¼ä¸ºGBKã€‚
&lt;img src="https://blog.hackerpie.com/images/posts/win10_active_page_code.png" alt="Windows 936">
&lt;/p>
&lt;p>è€Œåœ¨ Linux æœåŠ¡å™¨å’Œæˆ‘ä¸ªäººçš„ Macbook ç”µè„‘ï¼ˆæ“ä½œç³»ç»Ÿ macOS Catalina 10.15.7ï¼‰ä¸Šï¼Œé€šè¿‡æ‰“å° &lt;code>LC_CTYPE&lt;/code> å˜é‡å¯ä»¥ç¡®è®¤ç³»ç»Ÿç¼ºçœä½¿ç”¨ UTF-8 æ ¼å¼ã€‚
&lt;img src="https://blog.hackerpie.com/images/posts/character-encoding/macOS_CTYPE.png" alt="macOS">
&lt;img src="https://blog.hackerpie.com/images/posts/character-encoding/Linux_CTYPE.png" alt="linux">
&lt;/p>
&lt;p>ç³»ç»Ÿé—´çš„è¿™ç§ç¼ºçœå­—ç¬¦ç¼–ç æ ¼å¼çš„å·®å¼‚ï¼Œå¾€å¾€ä¼šå¯¼è‡´ä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸‹ç¼–è¾‘ä¿å­˜å¥½çš„æ–‡ä»¶ï¼Œåˆ°äº†å¦ä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸‹å°±ä¼šå‡ºç°ä¹±ç ã€‚é™¤äº†æ–‡ä»¶å†…å®¹ä¹±ç ï¼Œä¹Ÿä¼šå­˜åœ¨æ–‡ä»¶åä¹±ç çš„æƒ…å†µç­‰ï¼ŒåŸå› éƒ½æ˜¯ç±»ä¼¼çš„ã€‚&lt;/p>
&lt;h3 id="mysql-æ•°æ®åº“ä¸­çš„å­—ç¬¦é›†å¤„ç†">MySQL æ•°æ®åº“ä¸­çš„å­—ç¬¦é›†å¤„ç†&lt;/h3>
&lt;p>æœ‰è¿‡ MySQL æ•°æ®åº“ä½¿ç”¨ç»éªŒçš„åŒå­¦ä¸€å®šå¯¹å­—ç¬¦é›†çš„é€‰æ‹©ä½¿ç”¨ä¼šæœ‰ä¸€äº›ç»éªŒå¿ƒå¾—ï¼š&lt;/p>
&lt;ul>
&lt;li>æ³¨æ„é¿å…é»˜è®¤çš„ &lt;code>latin1&lt;/code> å­—ç¬¦é›†&lt;/li>
&lt;li>å¦‚æœéœ€è¦æ”¯æŒ emoji è¡¨æƒ…å­—ç¬¦ï¼Œè¿˜éœ€è¦æ³¨æ„ä½¿ç”¨ &lt;code>utf8mb4&lt;/code> å­—ç¬¦é›†&lt;/li>
&lt;/ul>
&lt;p>è¿™åˆæ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿå†å²åŸå› ï¼&lt;/p>
&lt;p>é¦–å…ˆï¼Œ&lt;code>latin1&lt;/code> å­—ç¬¦é›†æ˜¯å¤šå­—èŠ‚å­—ç¬¦ç¼–ç æŠ€æœ¯ä¹‹å‰çš„æŠ€æœ¯ï¼Œåœ¨ MySQL 4.0 åŠæ›´æ—©ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ç¼ºçœä½¿ç”¨ï¼Œå¯èƒ½å‡ºäºå‘ä¸‹å…¼å®¹çš„å› ç´ ï¼Œè¿™ä¸ªç¼ºçœé€»è¾‘ä¸€ç›´ä¿ç•™åˆ° 5.7 ç‰ˆæœ¬ï¼Œåˆ°äº†å½“å‰æœ€æ–°ç‰ˆ 8.0 ä¸­ï¼Œå·²ç»æ”¹ä¸ºç¼ºçœ &lt;code>utf8mb4&lt;/code>ã€‚&lt;/p>
&lt;p>å¦å¤–ï¼ŒMySQL å­—ç¬¦é›†åœ¨ MySQL ä¸­æœ‰ä¸¤å¥— UTF-8 çš„å®ç°ï¼Œå¤§å®¶å®¹æ˜“æƒ³åˆ°çš„åŒåâ€œutf8â€çš„æ–¹æ¡ˆï¼Œæ¯ä¸ªå­—ç¬¦æœ€å¤šå æ® 3 ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œæ˜¯ä¸€å¥—éå®Œæ•´çš„å®ç°ï¼Œå› æ­¤ MySQL åæ¥å°†å…¶æ­£å¼åå­—æ”¹ä¸ºâ€œutf8mb3â€ï¼Œç”¨ä»¥æŒ‡ç¤ºè¿™æ˜¯ä¸€å¥—æœ‰ç¼ºé™·çš„å®ç°ï¼Œè€Œä¿ç•™ä¸‹æ¥çš„â€œutf8â€åªä¸è¿‡æ˜¯ä¸ªåˆ«åè€Œå·²äº†ï¼›å¦‚æœéœ€è¦å®Œæ•´çš„å®ç°ï¼Œéœ€è¦ä½¿ç”¨â€œutf8mb4â€ã€‚è‡³äºä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œæ ¹æœ¬åŸå› è¿˜æ˜¯å†å²ã€‚MySQL åœ¨4.1 ç‰ˆæœ¬å¼€å§‹æ”¯æŒ UTF-8 ç¼–ç æ ¼å¼ï¼Œå½“æ—¶å¯¹ utf-8 çš„å®ç°å¹¶æœªå½¢æˆç»Ÿä¸€æ ‡å‡†ï¼Œè€Œ MySQL åœ¨å…¶å®ç°ä¸­é™åˆ¶äº†ç¼–ç ç©ºé—´æœ€å¤šä¸º3ä¸ªå­—èŠ‚ï¼Œè€Œ UTF-8 æ­£å¼å½¢æˆä¸šç•Œçš„æ ‡å‡†åŒ–æ–‡æ¡£åœ¨è¿™ä¸ªäº‹æƒ…ä¹‹åã€‚&lt;/p>
&lt;h3 id="ç¼–ç¨‹è¯­è¨€å¯¹å­—ç¬¦é›†çš„å¤„ç†">ç¼–ç¨‹è¯­è¨€å¯¹å­—ç¬¦é›†çš„å¤„ç†&lt;/h3>
&lt;p>æ¥åˆ°ç¼–ç¨‹è¯­è¨€å±‚é¢ï¼Œéšç€ utf-8 æ ¼å¼æ­£å¼åŒ–ä»¥åŠå‘å±•ï¼Œç¼–ç¨‹è¯­è¨€åœ¨å­—ç¬¦é›†å¤„ç†çš„æ–¹å¼ä¸Šï¼Œåœ¨ä¸åŒç‰ˆæœ¬ä¸Šä¹Ÿæœ‰ä¸€äº›æœ‰è¶£çš„å†å²ã€‚&lt;/p>
&lt;ul>
&lt;li>Ruby 2.0 ä»¥å‰çš„ç‰ˆæœ¬ï¼ˆä¸åŒ…å« 2.0ï¼‰ï¼Œå¦‚æœéœ€è¦æŒ‡å®šæºç çš„ç¼–ç æ ¼å¼ä¸º utf-8ï¼Œéœ€è¦åœ¨ä»£ç æ–‡ä»¶çš„å¼€å¤´åŠ ä¸Šé­”æ³•æ³¨é‡Šï¼š&lt;code># encoding: utf-8&lt;/code>&lt;/li>
&lt;li>åœ¨ Python 3.0 ä»¥å‰çš„ç‰ˆæœ¬ï¼ˆä¸åŒ…å« 3.0ï¼‰ï¼Œå¦‚æœéœ€è¦æŒ‡å®šæºç çš„ç¼–ç æ ¼å¼ä¸º utf-8ï¼Œéœ€è¦åœ¨ä»£ç æ–‡ä»¶çš„å¼€å¤´åŠ ä¸Šé­”æ³•æ³¨é‡Šï¼š&lt;code># -*- coding: utf-8 -*-&lt;/code>&lt;/li>
&lt;li>åœ¨ Golang ä¸­ï¼Œç”±äºè¿™é—¨è¯­è¨€æœ¬èº«æ¯”è¾ƒæ–°ï¼Œæ²¡æœ‰è¿™ç±»åœ¨è€ç‰ˆæœ¬ä»£ç ä¸­æ˜¾å¼å£°æ˜ç¼–ç æ ¼å¼çš„éœ€è¦&lt;/li>
&lt;/ul>
&lt;h3 id="http-ä¸­ç”¨-accept-charset-åå•†å­—ç¬¦é›†">HTTP ä¸­ç”¨ &lt;code>Accept-Charset&lt;/code> åå•†å­—ç¬¦é›†&lt;/h3>
&lt;p>&lt;code>Accept-Charset&lt;/code> è¯·æ±‚å¤´ç”¨æ¥å‘ŠçŸ¥ï¼ˆæœåŠ¡å™¨ï¼‰å®¢æˆ·ç«¯å¯ä»¥å¤„ç†çš„å­—ç¬¦é›†ç±»å‹ã€‚å€ŸåŠ©å†…å®¹åå•†æœºåˆ¶ï¼ŒæœåŠ¡å™¨å¯ä»¥ä»è¯¸å¤šå¤‡é€‰é¡¹ä¸­é€‰æ‹©ä¸€é¡¹è¿›è¡Œåº”ç”¨ï¼Œ å¹¶ä½¿ç”¨ &lt;code>Content-Type&lt;/code> åº”ç­”å¤´é€šçŸ¥å®¢æˆ·ç«¯å®ƒçš„é€‰æ‹©ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®é™…çš„ HTTP åè®®ä¸­åå•† charset çš„å®é™…ä¾‹å­ï¼š
&lt;img src="https://blog.hackerpie.com/images/posts/character-encoding/%e5%8d%8f%e5%95%86charset.png" alt="linux">
&lt;/p>
&lt;h3 id="html-æ ‡è®°è¯­è¨€ä¸­æŒ‡å®šå­—ç¬¦ç¼–ç ">HTML æ ‡è®°è¯­è¨€ä¸­æŒ‡å®šå­—ç¬¦ç¼–ç &lt;/h3>
&lt;p>é€šå¸¸åœ¨ HTML é‡Œå£°æ˜ UTF-8 å­—ç¬¦ç¼–ç ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="font-weight:bold">meta&lt;/span> charset=&lt;span style="font-style:italic">&amp;#34;utf-8&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>å­—ç¬¦é›†å’Œå­—ç¬¦ç¼–ç æŠ€æœ¯æ— å¤„ä¸åœ¨ï¼Œé€šè¿‡è¯¸å¤šå®é™…æ¡ˆä¾‹å±•ç¤ºå’ŒåŸç†åˆ†æï¼Œçœ‹åˆ°äº†å…¶æœ‰è¶£ä¸”åº”ç”¨å¹¿æ³›çš„ä¸€é¢ã€‚å¸Œæœ›è¿™ç¯‡æ–‡ç« ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ æ›´åŠ ç³»ç»Ÿå…¨é¢åœ°äº†è§£æŒæ¡å¯¹å®ƒçš„è®¤è¯†å’Œåº”ç”¨ï¼&lt;/p>
&lt;p>æœ€åé™„ä¸Šä¸€å¼ å›¾ï¼Œçœ‹ä¸‹ä¸€äº›å‰é¢æåˆ°çš„ä¾‹å­ä¸­ï¼Œæ¯”å¦‚ç¼–ç¨‹è¯­è¨€æˆ–è€…æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå¯¹ UTF-8 çš„åº”ç”¨å’Œç›¸ä¼´å‘å±•æ¦‚å†µï¼Œæ¥ç»“æŸè¿™ç¯‡æ–‡ç« ï¼š&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/character-encoding/unicode_and_utf8_development_history.jpg" alt="">
&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/Unicode">Wikipediaï¼šUnicode&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://unicode.yunser.com/unicode">Unicode æŸ¥è¯¢&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zh.wikipedia.org/zh-hans/ASCII">Wikipediaï¼šASCII&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/%E6%B1%89%E5%AD%97%E5%86%85%E7%A0%81%E6%89%A9%E5%B1%95%E8%A7%84%E8%8C%83">Wikipediaï¼šæ±‰å­—å†…ç æ‰©å±•è§„èŒƒ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/GB_18030">Wikipediaï¼šGB18030&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/UTF-8">Wikipediaï¼šUTF-8&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mothereff.in/utf-8">UTF-8 encoder/decoder&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.kermitproject.org/utf8.html">UTF-8 Sampler&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tool.oschina.net/hexconvert/">OSCHINAï¼šåœ¨çº¿è¿›åˆ¶è½¬æ¢&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/a/16521949">StackOverflow: Unicode sample text file for testing for Unicode related problems?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cloud.tencent.com/developer/article/1353937">äº‘+ç¤¾åŒºï¼šå¦‚ä½•æŸ¥çœ‹windowsæ“ä½œç³»ç»Ÿçš„é»˜è®¤ç¼–ç ï¼Ÿ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.csdn.net/yinshuilan/article/details/86081541">CSDNï¼šæŸ¥çœ‹windowsä¸Macçš„é»˜è®¤ç³»ç»Ÿç¼–ç &lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.ibm.com/docs/en/integration-bus/10.0?topic=locales-changing-your-locale-linux-unix-systems">IBM: Changing your locale on Linux and UNIX systems&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/a/3936094">StackOverflow: Why does MySQL use latin1_swedish_ci as the default?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://dev.mysql.com/doc/refman/5.7/en/charset.html">MySQL :: MySQL 5.7 Reference&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://dev.mysql.com/doc/refman/8.0/en/charset.html">MySQL :: MySQL 8.0 Reference&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/a/20523482">StackOverflow: Set UTF-8 as default for Ruby 1.9.3&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/a/6289494">StackOverlfow: Working with UTF-8 encoding in Python source&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/MySQL">Wikipedia: MySQL&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/Python">Wikipedia: Python&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Charset">MDN: Accept-Charset&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://developer.mozilla.org/zh-CN/docs/Glossary/character_encoding">MDN: Character encodingï¼ˆå­—ç¬¦ç¼–ç ï¼‰&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://adamhooper.medium.com/in-mysql-never-use-utf8-use-utf8mb4-11761243e434">Medium: In MySQL, never use â€œutf8â€. Use â€œutf8mb4â€.&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://downloads.mysql.com/docs/mysql-5.5-relnotes-en.pdf">MySQL 5.5 Release notes&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>Kafka æ ¸å¿ƒè®¾è®¡æ€è€ƒâ€”â€”æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„æ€»ç»“</title><link>https://blog.hackerpie.com/posts/kafka/kakfa-main-design/</link><pubDate>Thu, 09 Dec 2021 10:16:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/kafka/kakfa-main-design/</guid><description>&lt;h2 id="å‰è¨€">å‰è¨€&lt;/h2>
&lt;p>æœ€è¿‘åœ¨å­¦ä¹  Kafka çš„ä¸€äº›è®¾è®¡åŸç†ï¼Œå¶ç„¶é—´å‘ç° Kafka å®˜æ–¹æ–‡æ¡£ä¸­ç‹¬åˆ—äº† &lt;a href="https://kafka.apache.org/documentation/#design">Design&lt;/a> ä¸€ç« ã€‚ä¸¤å¤©çœ‹å®Œåè§‰å¾—å¾ˆå…´å¥‹ï¼Œå› ä¸ºæ–‡æ¡£ä¸­å¾ˆè¯¦ç»†åœ°ä»å„æ–¹é¢é˜è¿°äº† Kafka å®˜æ–¹å¯¹äº Kafka è®¾è®¡çš„ç›®æ ‡ä»¥åŠè®¾è®¡æƒè¡¡ç­‰ï¼Œè®©æˆ‘æç„¶å¤§æ‚Ÿ Kafka çš„ç‹¬ç‰¹ä¸ç®€æ´ã€‚è¿™ç§å¿«ä¹æ˜¯é˜…è¯»ç½‘ä¸Šå„ç§é›¶æ•£çš„åšå®¢æ–‡ç« æ— æ³•æ¯”æ‹Ÿçš„ã€‚æˆ‘æ­¤å¤„æ€»ç»“æ›´å¤šæ˜¯ä¸ºäº†æå‡è‡ªå·±çš„é¢†æ‚Ÿå’Œç†è§£ç¨‹åº¦ï¼Œè¡Œæ–‡ä¹‹ä¸­ä¼šå¤¹æ‚ä¸ªäººä¸»è§‚ç†è§£ï¼Œæˆ‘å»ºè®®å¤§å®¶æŠ½å‡ºæ—¶é—´é˜…è¯»åŸæ±åŸå‘³çš„&lt;a href="https://kafka.apache.org/documentation/#design">å®˜æ–¹æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;h2 id="kafka-è®¾è®¡ç›®æ ‡ä¸è®¾è®¡æ¦‚è¿°">Kafka è®¾è®¡ç›®æ ‡ä¸è®¾è®¡æ¦‚è¿°&lt;/h2>
&lt;p>è®¾è®¡ä¸€ä¸ªç³»ç»Ÿï¼Œç²¾å‡†çš„ç›®æ ‡æ˜¯ç¬¬ä¸€æ­¥ã€‚Kafka å®˜æ–¹åœ¨æœ€å¼€å§‹çš„æ—¶å€™ï¼Œå¯¹ Kafka çš„è®¾è®¡ç†æƒ³æ˜¯å°†å…¶åšæˆä¸€ä¸ªå¯ä»¥å¸®åŠ©å¤§å‹å…¬å¸åº”å¯¹å„ç§å¯èƒ½çš„å®æ—¶æ•°æ®æµå¤„ç†çš„é€šç”¨å¹³å°ã€‚è¿™å¥è¯é‡Œè¾¹æœ‰å‡ ä¸ªé‡ç‚¹ï¼šâ€œå¤§å‹å…¬å¸â€ã€â€œå®æ—¶â€ã€â€œé€šç”¨â€ï¼Œå¯¹åº”åˆ°ç³»ç»Ÿè®¾è®¡ä¸Šï¼Œå°±æ˜¯éœ€è¦æ”¯æŒå¤§é‡æ•°æ®çš„ä½å»¶è¿Ÿå¤„ç†ï¼Œå¹¶ä¸”éœ€è¦è€ƒè™‘å„ç§ä¸åŒçš„æ•°æ®å¤„ç†åœºæ™¯ã€‚åœ¨å®˜æ–¹é˜è¿°ä¸­ï¼ŒKafka ç€çœ¼äºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæŒ‡æ ‡ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>é«˜ååé‡&lt;/strong>ï¼šå› ä¸º Kafka éœ€è¦å¤„ç†å¤§é‡çš„æ¶ˆæ¯ï¼›&lt;/li>
&lt;li>&lt;strong>ä½å»¶è¿Ÿ&lt;/strong>ï¼šæ¶ˆæ¯ç³»ç»Ÿçš„å…³é”®è®¾è®¡æŒ‡æ ‡ï¼›&lt;/li>
&lt;li>&lt;strong>æ”¯æŒåŠ è½½ç¦»çº¿æ•°æ®&lt;/strong>ï¼šè¿™æ˜¯ Kafka è€ƒè™‘çš„æ‰€è°“â€œå„ç§å¯èƒ½çš„â€æ•°æ®å¤„ç†åœºæ™¯ï¼Œæ”¯æŒä»ç¦»çº¿ç³»ç»Ÿä¸­åŠ è½½æ•°æ®ï¼Œæˆ–è€…å°†æ•°æ®åŠ è½½åˆ°ç¦»çº¿ç³»ç»Ÿä¸­ï¼Œéƒ½æ˜¯æ— æ³•é€ƒé¿çš„ï¼›&lt;/li>
&lt;li>&lt;strong>æ”¯æŒåˆ†åŒºçš„ã€åˆ†å¸ƒå¼çš„ã€å®æ—¶çš„æ•°æ®æµå¤„ç†ä»¥äº§ç”Ÿæ–°çš„ã€æ´¾ç”Ÿçš„æ•°æ®æµ&lt;/strong>ï¼šè¿™ä¸ªæŒ‡å¯¼äº† Kafka é‡Œ topic åˆ†åŒºæ¨¡å‹ä»¥åŠæ¶ˆè´¹è€…æ¨¡å‹çš„è®¾è®¡ï¼›&lt;/li>
&lt;li>&lt;strong>å®¹é”™ä¸å¯é æ€§&lt;/strong>ï¼šKafka ä½œä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ ¸å¿ƒåœºæ™¯ä¹‹ä¸€å°±æ˜¯ä½œä¸ºç³»ç»Ÿé—´çš„è¿æ¥å™¨ï¼Œéœ€è¦ä¿è¯æ•´ä½“ä¸šåŠ¡çš„æ­£å¸¸è¿ä½œï¼Œå¯é çš„æ¶ˆæ¯æŠ•é€’æœºåˆ¶ä»¥åŠåº”å¯¹èŠ‚ç‚¹æ•…éšœçš„é«˜å¯ç”¨è®¾è®¡ç­‰ï¼Œå¿…ä¸å¯å°‘ã€‚&lt;/li>
&lt;/ul>
&lt;p>ç†è§£äº† Kafka çš„è®¾è®¡ç›®æ ‡ä»¥åŠæ ¸å¿ƒæŒ‡æ ‡ï¼Œåç»­å¯¹ Kafka çš„æ•´ä½“æ¶æ„è®¾è®¡å°±ä¼šæœ‰ä¸€ä¸ªæ–¹å‘äº†ï¼Œå› ä¸º Kafka çš„æ•´ä½“è®¾è®¡ç»†èŠ‚è¿˜ç®—æ¯”è¾ƒå¤šï¼Œä½†æ˜¯å½’æ ¹ç»“åº•éƒ½æ˜¯å›´ç»•è¿™å‡ ä¸ªæ ¸å¿ƒæŒ‡æ ‡å»åšçš„è®¾è®¡ï¼Œæˆ‘å°è¯•åˆ†é—¨åˆ«ç±»å…ˆæ±‡æ€»ä¸€ä¸‹ï¼Œå¯èƒ½ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œå¸Œæœ›è¯·å¤§å®¶çœ‹çš„æ—¶å€™é¡ºä¾¿èµæ•™ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>æ ¸å¿ƒæŒ‡æ ‡&lt;/th>
&lt;th>å®ç°çš„è§’åº¦&lt;/th>
&lt;th>å…·ä½“è®¾è®¡æ‰‹æ®µ&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>é«˜ååé‡&lt;/td>
&lt;td>è¯»å†™ç¼“å­˜&lt;/td>
&lt;td>ä¾èµ–æ–‡ä»¶ç³»ç»Ÿè‡ªèº«çš„ Page Cacheï¼Œè€Œä¸æ˜¯è‡ªå·±å®ç°å†…å­˜ç¼“å­˜&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é«˜ååé‡&lt;/td>
&lt;td>é«˜æ•ˆçš„æ•°æ®ç»“æ„&lt;/td>
&lt;td>é‡‡ç”¨é¡ºåºè¯»å†™çš„ç»“æ„ï¼Œè€Œä¸æ˜¯ B æ ‘ç­‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é«˜ååé‡&lt;/td>
&lt;td>é™ä½å¤§é‡å°çš„ I/O&lt;/td>
&lt;td>æ¶ˆæ¯åˆ†æ‰¹å‘å¸ƒï¼ŒæŒ‰æ‰¹æŠ•é€’&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é«˜ååé‡&lt;/td>
&lt;td>æé«˜æ¶ˆæ¯æŠ•é€’ååé‡&lt;/td>
&lt;td>ç”±æ¶ˆè´¹è€…æ‰¹é‡æ‹‰å–&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>é«˜ååé‡&lt;/td>
&lt;td>æ”¯æŒåˆ†æ‰¹æ¶ˆæ¯&lt;/td>
&lt;td>æ”¯æŒå¼‚æ­¥å‘é€æ¶ˆæ¯&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ä½å»¶è¿Ÿ&lt;/td>
&lt;td>é¿å…æ˜‚è´µçš„å­—èŠ‚æ‹·è´&lt;/td>
&lt;td>ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼ï¼Œé›¶æ‹·è´æŠ€æœ¯&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ä½å»¶è¿Ÿ&lt;/td>
&lt;td>ä¼˜åŒ–ä¼ è¾“æ€§èƒ½&lt;/td>
&lt;td>é€šè¿‡æ‰¹é‡æ¶ˆæ¯å‹ç¼©å‡å°ä¼ è¾“æ•°æ®é‡&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ä½å»¶è¿Ÿ&lt;/td>
&lt;td>æå‡è¯»å–æ€§èƒ½&lt;/td>
&lt;td>é¡ºåºè¯»ï¼Œæ—¥å¿—æ–‡ä»¶åˆ†æ®µå­˜å‚¨ï¼Œåº”ç”¨äºŒåˆ†æŸ¥æ‰¾&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ä½å»¶è¿Ÿ&lt;/td>
&lt;td>é™ä½è´Ÿè½½å‡è¡¡å»¶è¿Ÿ&lt;/td>
&lt;td>producer ç›´è¿ broker&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ç¦»çº¿æ•°æ®åŠ è½½&lt;/td>
&lt;td>æ”¯æŒå‘¨æœŸæ€§å¤§é‡æ•°æ®åŠ è½½&lt;/td>
&lt;td>ä¾èµ–å­˜å‚¨å±‚é¡ºåºè¯»å†™çš„å¸¸é‡æ—¶é—´å¤æ‚åº¦çš„è®¿é—®ä¼˜åŠ¿ä»¥åŠä½å»‰çš„ç£ç›˜æˆæœ¬è¦æ±‚&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ç¦»çº¿æ•°æ®å¤„ç†&lt;/td>
&lt;td>æ”¯æŒå¹¶è¡Œå¤„ç†&lt;/td>
&lt;td>é€šè¿‡åˆ†åŒºè®¾è®¡ä»¥åŠ consumer çš„ offsetï¼Œæ”¯æŒ Hadoop ä¸€ç±»çš„å¹¶è¡Œä½œä¸šä»¥åŠæ–­ç‚¹ä½œä¸š&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å¯é æ€§&lt;/td>
&lt;td>æ”¯æŒâ€œæœ‰ä¸”ä»…æœ‰ä¸€æ¬¡â€çš„æ¶ˆæ¯æŠ•é€’è¯­ä¹‰&lt;/td>
&lt;td>producer çš„ ID ä¸æ¶ˆæ¯ Sequence Numberï¼Œç±»äº‹åŠ¡æäº¤è¯­ä¹‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å¯é æ€§&lt;/td>
&lt;td>å®¹é”™å¤„ç†ä¸é«˜å¯ç”¨&lt;/td>
&lt;td>ISR æœºåˆ¶ä¸ Leader å‡åŒ€åˆ†å¸ƒè®¾è®¡&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>é™¤äº†ä¸Šè¡¨æ‰€åˆ—å†…å®¹ï¼Œè¿˜æœ‰å°‘é‡è®¾è®¡æ€è€ƒæš‚æ—¶ä¸å¥½å½’ç±»ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;ul>
&lt;li>æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦çš„å­˜å‚¨è®¾è®¡æ€è€ƒ&lt;/li>
&lt;li>æ—¥å¿—å‹ç¼©ï¼ˆLog Compactionï¼‰çš„è®¾è®¡&lt;/li>
&lt;li>å…¶ä»–â€¦â€¦&lt;/li>
&lt;/ul>
&lt;p>ä»¥ä¸Šçš„æ€»ä½“è®¾è®¡ï¼Œè®© Kafka çœ‹èµ·æ¥ä¹Ÿæ›´åƒæ˜¯ä¸€ä¸ªæ—¥å¿—å‹ç³»ç»Ÿï¼Œè€Œä¸ä»…ä»…æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚&lt;/p>
&lt;h2 id="é«˜ååé‡çš„è®¾è®¡æ€è€ƒ">é«˜ååé‡çš„è®¾è®¡æ€è€ƒ&lt;/h2>
&lt;h3 id="è¯»å†™ç¼“å­˜çš„åˆ©ç”¨">è¯»å†™ç¼“å­˜çš„åˆ©ç”¨&lt;/h3>
&lt;p>Kafka çš„è®¾è®¡ä¸­ï¼Œå­˜å‚¨å±‚ç›´æ¥åŸºäºæ–‡ä»¶ç³»ç»Ÿå®ç°ï¼Œè€Œä¸æ˜¯é¢å¤–å®ç°å¤æ‚çš„å­˜å‚¨å±‚æŠ½è±¡ï¼Œæ¯”å¦‚å¼•å…¥ç¼“å­˜å’Œç¼“å†²ç­‰ã€‚&lt;/p>
&lt;p>ä¸€èˆ¬æåˆ°æ–‡ä»¶ç³»ç»Ÿæˆ–è€…ç£ç›˜å­˜å‚¨ï¼Œå¤§å®¶ç¬¬ä¸€ååº”å°±æ˜¯â€œè¿™ä¸œè¥¿ä¸æ˜¯å¾ˆæ…¢å—â€ï¼Ÿæ˜¯çš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œç£ç›˜çš„è¯»å†™é€Ÿåº¦æ˜¯å¾ˆæ…¢ï¼Œä½†ä¹Ÿé™äºéšæœºè®¿é—®çš„å‰æä¸‹ï¼Œè€Œäº‹å®ä¸Šï¼Œç‰¹å®šæ¡ä»¶ä¸‹ï¼Œç£ç›˜çš„é¡ºåºè¯»å†™æ€§èƒ½å ªæ¯”å†…å­˜çš„éšæœºè®¿é—®æ€§èƒ½ï¼æ˜¯ä¸æ˜¯å¾ˆå‡ºä¹æ„æ–™ï¼Ÿ&lt;/p>
&lt;p>å¦å¤–ï¼Œç°ä»£æ“ä½œç³»ç»Ÿå†…éƒ¨éƒ½å·²ç»å®ç°å¯¹åº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„ç»Ÿä¸€æŠ½è±¡ï¼Œç‰¹åˆ«æ˜¯å¯¹è¯»å†™æ€§èƒ½çš„ä¼˜åŒ–ï¼Œå¤§å®¶å¯èƒ½äº†è§£çš„æ˜¯é¢„è¯»ï¼ˆRead-Aheadï¼‰å’Œåå†™ï¼ˆWrite-Behindï¼‰ã€‚ç»“åˆé¡ºåºè¯»å†™çš„ç‰¹æ€§ï¼Œè¿™ç§æ“ä½œç³»ç»Ÿçš„ä¼˜åŒ–èƒ½å¤Ÿè¢«å‘æŒ¥åˆ°æè‡´ã€‚&lt;/p>
&lt;p>å¦‚æœè€ƒè™‘åº”ç”¨å±‚çš„ç¼“å­˜è®¾è®¡æ–¹æ¡ˆï¼Œå°±ä¼šè€ƒè™‘åˆ° Kafka è¿è¡Œäº JVM ä¹‹ä¸Šï¼ŒJVM ä¸­å¯¹è±¡çš„å°è£…è¡¨ç¤ºéƒ½ä¼šæœ‰é¢å¤–çš„å†…å­˜å¼€é”€ï¼Œè¿™ç§é¢å¤–å¼€é”€ä¸å¯¹è±¡æœ¬èº«æ•°æ®çš„å¤§å°ç›¸å½“ã€‚æ‰€ä»¥ï¼Œå¦‚æœæ˜¯åœ¨åº”ç”¨å±‚è‡ªè¡Œå®ç°ç¼“å­˜å±‚ï¼Œåˆ™æ„å‘³ç€ä¼šæœ‰é¢å¤–çš„å¤§è‡´ä¸¤å€äºæ¶ˆæ¯ä½“ç§¯çš„å†…å­˜å¼€é”€ã€‚è¿™ä¸ªæˆæœ¬å¯¹äºå¤§æ•°æ®å¤„ç†åœºæ™¯æ¥è¯´ï¼Œå¯ä¸æ˜¯é—¹ç€ç©çš„ã€‚å¼€é”€ä¹Ÿä¸ä»…é™äºå†…å­˜å¼€é”€ï¼ŒJava æœ¬èº«çš„ GC ç®—æ³•ä¼šéšç€åº”ç”¨å †å†…å­˜çš„å¢åŠ è€Œæ„ˆåŠ é¢‘ç¹ä¸”è¿Ÿé’ã€‚&lt;/p>
&lt;p>æœ€åï¼Œç¼“å­˜çš„è®¾è®¡è¿˜ç»•ä¸å¼€ç¼“å­˜é¢„çƒ­çš„æ€è€ƒï¼Œç”±äºæ“ä½œç³»ç»Ÿæœ¬èº«å¯¹äºè¯»å†™æ€§èƒ½ä¼˜åŒ–çš„è®¾è®¡ï¼Œå¯ä»¥è®¤ä¸ºé¢„è¯»å’Œåå†™ç­‰ç‰¹æ€§å·²ç»å¸®åŠ©åº”ç”¨é€æ˜åœ°å®ç°äº†ç¼“å­˜çš„é¢„çƒ­å’Œè½ç›˜ã€‚è€Œå¦‚æœæ˜¯åœ¨åº”ç”¨å±‚é¢ï¼Œåˆ™ä¸å¾—ä¸é‡å¤é€ è½®å­ï¼Œä¸”éœ€è¦è€ƒè™‘çš„ç»†èŠ‚å¾ˆå¤šã€‚&lt;/p>
&lt;p>ç»¼ä¸Šï¼ŒKafka å®˜æ–¹è®¤ä¸ºç›´æ¥åŸºäºæ–‡ä»¶ç³»ç»Ÿå®ç°å­˜å‚¨ï¼Œæ˜¯ä¸€ä¸ªéå¸¸æ˜æ™ºçš„å†³å®šã€‚&lt;/p>
&lt;h3 id="é¡ºåºæ•°æ®ç»“æ„çš„å¦™å¤„">é¡ºåºæ•°æ®ç»“æ„çš„å¦™å¤„&lt;/h3>
&lt;p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒKafka é‡‡ç”¨äº†è¿½åŠ å†™ä¹Ÿå°±æ˜¯é¡ºåºå†™çš„æ–¹å¼æ¥å®Œæˆæ•°æ®æŒä¹…åŒ–ï¼Œæ¶ˆæ¯æŠ•é€’è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯æŒ‰ç…§é¡ºåºè¯»çš„æ–¹å¼å®ç°ã€‚åœ¨ Kafka çœ‹æ¥ï¼Œé¡ºåºè¯»å†™å¸¦æ¥äº†è¯¸å¤šå¥½å¤„ã€‚&lt;/p>
&lt;p>åœ¨ B æ ‘ç­‰æ•°æ®ç»“æ„ä¸Šæ“ä½œçš„æ—¶é—´å¤æ‚åº¦æ˜¯ log(n)ï¼Œä¸€ç§ä¸€èˆ¬çœ‹æ¥è¿‘ä¼¼äºå¸¸é‡æ—¶é—´å¤æ‚åº¦çš„ç®—æ³•ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œè€ƒè™‘åˆ°ç£ç›˜çš„ç‰¹æ®Šç»“æ„ä»¥åŠé¢å¤–çš„ç£ç›˜å®šä½ï¼ˆäº‹å®ä¸Šï¼Œå®šä½ä¸æ˜¯ä¸€æ­¥åˆ°ä½çš„ï¼Œåˆ†ä¸ºå¯»é“å’Œæ—‹è½¬ä¸¤ä¸ªé˜¶æ®µï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥é˜…è¯»ã€Š&lt;a href="https://tech.meituan.com/2017/05/19/about-desk-io.html">ç£ç›˜I/Oé‚£äº›äº‹&lt;/a>ã€‹ï¼‰ç­‰ï¼Œè¿™ç§æ•°æ®ç»“æ„çš„æ“ä½œæ€§èƒ½çš„ä¸‹é™é€Ÿåº¦ï¼Œå…¶å®æ˜¯é«˜äºæ•°æ®æœ¬èº«ä½“ç§¯çš„å¢é•¿çš„ï¼Œä¹Ÿå°±æ˜¯éšç€æ•°æ®è¶Šæ¥è¶Šå¤§ï¼Œè¿™ç§æ•°æ®ç»“æ„çš„æ€§èƒ½ä¸‹é™è¶Šæ¥è¶Šå¿«ã€‚&lt;/p>
&lt;p>è€Œé‡‡ç”¨é¡ºåºè¯»å†™ï¼Œç”±äºåªéœ€è¦ä¸€æ¬¡ç£ç›˜å®šä½ï¼Œå¯ä»¥è®¤ä¸ºå…¶æ“ä½œæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚å› ä¸ºä¸€èˆ¬è€Œè¨€ï¼Œä¸€æ¬¡ I/O æ“ä½œçš„æ€»ä½“å»¶è¿Ÿï¼Œä¸»è¦æ˜¯ç£ç›˜å®šä½çš„å»¶è¿Ÿï¼Œè€Œæ•°æ®ä¼ è¾“çš„å»¶è¿Ÿä¸ä¹‹ç›¸æ¯”ä¸å€¼ä¸€æã€‚æ‰€ä»¥è¿™ç§å¸¸é‡æ—¶é—´å¤æ‚åº¦çš„è®¿é—®æ“ä½œï¼Œå¤©ç„¶çš„å¥½å¤„æ˜¯æˆ‘ä»¬å¯ä»¥ä¸ç”¨æ‹…å¿ƒè®¿é—®æ•°æ®çš„å¤§å°ã€‚å› æ­¤ï¼Œè¿™ç§æ•°æ®ç»“æ„åœ¨é¢å¯¹å¤§é‡æ•°æ®çš„è¯»å†™æ—¶ï¼Œä¼šæœ‰æ›´åŠ ç¨³å®šçš„æ€§èƒ½è¡¨ç°ã€‚åœ¨ Kafka å›¢é˜Ÿçœ‹æ¥ï¼ŒKafka å¯ä»¥æ”¾å¿ƒåœ°ä»¥æ›´ä½æˆæœ¬å®ç°å­˜å‚¨ï¼Œç‰¹åˆ«æ˜¯å¯ä»¥ä»¥ç£ç›˜è½¬é€Ÿæ¢å–ç©ºé—´ï¼Œè¿™ä¹Ÿæ˜¯ Kafka å¯ä»¥æ”¾å¿ƒåœ°ä¿ç•™å†å²æ¶ˆæ¯è€Œä¸åšå³åˆ»æ¸…é™¤çš„åŸå› ã€‚&lt;/p>
&lt;p>è¿™é‡Œè¡¥å……ä¸€ç‚¹æ¥è‡ªã€Š&lt;a href="https://tech.meituan.com/2017/05/19/about-desk-io.html">ç£ç›˜I/Oé‚£äº›äº‹&lt;/a>ã€‹ï¼‰çš„å‚è€ƒä¿¡æ¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>ç›®å‰ç£ç›˜çš„å¹³å‡å¯»é“æ—¶é—´ä¸€èˆ¬åœ¨3-15ms&lt;br>
7200rpmçš„ç£ç›˜å¹³å‡æ—‹è½¬å»¶è¿Ÿå¤§çº¦ä¸º60*1000/7200/2 = 4.17ms&lt;br>
ç›®å‰IDE/ATAèƒ½è¾¾åˆ°133MB/sï¼ŒSATA IIå¯è¾¾åˆ°300MB/sçš„æ¥å£æ•°æ®ä¼ è¾“ç‡ï¼Œæ•°æ®ä¼ è¾“æ—¶é—´é€šå¸¸è¿œå°äºå‰ä¸¤éƒ¨åˆ†æ¶ˆè€—æ—¶é—´&lt;/p>
&lt;/blockquote>
&lt;p>é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºæ˜¯è¿½åŠ å†™é¡ºåºè¯»ï¼Œè¿˜å¯ä»¥ç®€åŒ–è¯»å†™æ“ä½œå¹¶å‘çš„é—®é¢˜ã€‚æˆ‘ä»¬ä¸éœ€è¦æ‹…å¿ƒå„ç§é”æˆ–è€…é˜»å¡é—®é¢˜ï¼Œè¯»å†™äº’ä¸å¹²æ‰°ã€‚&lt;/p>
&lt;h3 id="é¿å…è¿‡å¤šçš„å°-io-æ“ä½œ">é¿å…è¿‡å¤šçš„å° I/O æ“ä½œ&lt;/h3>
&lt;p>Kafka ä¸­çš„ I/O æ“ä½œä¸»è¦æ˜¯ä¸¤ä¸ªç¯èŠ‚ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´çš„ç½‘ç»œ I/Oï¼Œä»¥åŠæœåŠ¡å™¨å†…éƒ¨æŒä¹…åŒ–æ“ä½œä¸­çš„ç£ç›˜ I/Oã€‚åœ¨ Kafka çš„æ•´ä½“è®¾è®¡é‡Œï¼Œå¤§çš„æ€è·¯å°±æ˜¯é™ I/Oï¼Œå¢ååã€‚&lt;/p>
&lt;p>Kafka åœ¨è®¾è®¡ä¸Šæ”¯æŒæ¶ˆæ¯åˆ†æ‰¹æŠ•é€’ï¼Œå¹¶ä¸”åœ¨æŒä¹…åŒ–å­˜å‚¨ä¸ŠåŸæ ·ä¿å­˜ï¼Œæœ€åä¹Ÿæ˜¯æŒ‰æ‰¹äº¤ä»˜ç»™æ¶ˆè´¹è€…ï¼Œå…¨ç¨‹ä¸ä¼šå¯¹æ­¤æ‰¹æ•°æ®è¿›è¡Œåˆ†è§£æˆ–è€…åˆå¹¶ã€‚è¿™ç§è®¾è®¡æœ‰å‡ ä¸ªå¥½å¤„ï¼š&lt;/p>
&lt;ul>
&lt;li>è¶³å¤Ÿå¤§çš„ç½‘ç»œåˆ†åŒ…&lt;/li>
&lt;li>è¶³å¤Ÿå¤§çš„ç£ç›˜é¡ºåºæ“ä½œ&lt;/li>
&lt;li>æ¯—é‚»çš„å†…å­˜ç©ºé—´ç­‰&lt;/li>
&lt;/ul>
&lt;p>è¿™é‡Œæ¶ˆæ¯åŸæ ·å­˜å‚¨å’ŒæŠ•é€’è¿˜æœ‰ä¸€äº›é›¶æ‹·è´ä»¥åŠæ¶ˆæ¯å‹ç¼©æ–¹é¢çš„è€ƒè™‘ï¼Œç¨åä¹Ÿä¼šèŠåˆ°ã€‚&lt;/p>
&lt;p>è¿™é‡Œåˆšå¥½ç”±æ¶ˆæ¯åˆ†æ‰¹å°±æƒ³åˆ°äº†å‘å¸ƒè€…çš„å¼‚æ­¥æ¶ˆæ¯å‘é€ï¼Œè¿™æ˜¯ç”±å®¢æˆ·ç«¯ SDK å®Œæˆçš„åŠŸèƒ½ï¼Œå…¶å¯ä»¥é…ç½®åœ¨è¶…è¿‡æŒ‡å®šæ—¶é—´æˆ–è€…è¶…å‡ºæŒ‡å®šæ¶ˆæ¯é‡çš„æƒ…å†µä¸‹è§¦å‘æ¶ˆæ¯æŠ•é€’åˆ° brokerï¼Œè™½ç„¶ä¼šç‰ºç‰²ä¸€äº›æŠ•é€’æ—¶æœºçš„å»¶è¿Ÿï¼Œä½†æ˜¯èµ¢å–äº†åˆ†æ‰¹æŠ•é€’æ‰€å¸¦æ¥çš„ååé‡çš„æå‡ã€‚&lt;/p>
&lt;p>ç›®å‰ä¸ºæ­¢ï¼Œå…³äºæé«˜ååé‡çš„è®¾è®¡ï¼Œç”»äº†ä¸ªå›¾ï¼Œä»¥åŠ©åŠ æ·±å°è±¡ï¼š&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/kafka-how-to-improve-thoughput.jpg" alt="kafka å¦‚ä½•æé«˜ååé‡æ¶æ„">
&lt;/p>
&lt;h2 id="ä½å»¶è¿Ÿçš„è®¾è®¡æ€è€ƒ">ä½å»¶è¿Ÿçš„è®¾è®¡æ€è€ƒ&lt;/h2>
&lt;h3 id="é¿å…æ˜‚è´µçš„å­—èŠ‚æ‹·è´ç­‰æ“ä½œ">é¿å…æ˜‚è´µçš„å­—èŠ‚æ‹·è´ç­‰æ“ä½œ&lt;/h3>
&lt;p>ä¸ºäº†é™ä½å»¶è¿Ÿï¼Œbroker æœ€å¥½æ˜¯è¶Šå°‘å¹²é¢„æ¶ˆæ¯çº¦å¥½ã€‚ä¸ºæ­¤ï¼ŒKafka è®¾è®¡äº†ç»Ÿä¸€çš„äºŒè¿›åˆ¶æ¶ˆæ¯æ ¼å¼ï¼Œè€Œä¸”åœ¨æ¶ˆæ¯æŠ•é€’çš„å…¨è¿‡ç¨‹ä¸­ï¼Œéƒ½éœ€è¦ä¿®æ”¹æ¶ˆæ¯å†…å®¹ï¼Œå¸¦æ¥çš„å¥½å¤„æ˜¯äºŒè¿›åˆ¶æ¶ˆæ¯æ— éœ€ç»è¿‡ broker çš„ä»»ä½•è½¬åŒ–å¤„ç†ï¼ŒåŸæ ·è½ç›˜ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œç”±äºæ¶ˆæ¯åŸæ ·æŠ•é€’ç»™æ¶ˆè´¹è€…ï¼Œå¯ä»¥æ–¹ä¾¿ç»“åˆé›¶æ‹·è´æŠ€æœ¯å®ç°æ¶ˆæ¯åœ¨ç½‘ç»œçš„å¿«é€Ÿä¼ è¾“ã€‚ç‰¹åˆ«æ˜¯å¯¹äºå¤šæ¶ˆè´¹è€…ç»„çš„åœºæ™¯ï¼Œæ¶ˆæ¯çš„æŠ•é€’ç›´æ¥ä» Page Cache è¯»å–ï¼Œä¸ç”¨æ‹…å¿ƒå¹¿æ’­å¸¦æ¥çº¿æ€§çš„è®¿é—®å¼€é”€ã€‚æœ€åé€šè¿‡ç½‘ç»œä¼ è¾“ï¼Œç†è®ºä¸Šæ¶ˆæ¯æŠ•é€’çš„é€Ÿç‡å¯ä»¥é€¼è¿‘ç½‘ç»œè¿æ¥ä¼ è¾“é€Ÿç‡çš„ä¸Šé™ã€‚&lt;/p>
&lt;h3 id="ç«¯åˆ°ç«¯æ¶ˆæ¯å‹ç¼©">ç«¯åˆ°ç«¯æ¶ˆæ¯å‹ç¼©&lt;/h3>
&lt;p>å¦‚æœè¯´é›¶æ‹·è´æ˜¯ä¸ºäº†é¿å…æ— è°“çš„å¼€é”€ï¼Œé‚£å°†æ¶ˆæ¯ä½“è¿›è¡Œå‹ç¼©ï¼Œåˆ™æ˜¯ä¸ºäº†é™ä½æ•°æ®ä¼ è¾“çš„ä½“ç§¯ã€‚Kafka ä½¿ç”¨äº†ç«¯åˆ°ç«¯çš„åˆ†æ‰¹æ¶ˆæ¯å‹ç¼©åè®®ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯åˆ†æ‰¹å‘¢ï¼Ÿå› ä¸ºä¸€èˆ¬æ¥è¯´ï¼Œåœ¨åŒä¸ª topic é‡Œï¼Œæˆ‘ä»¬å€¾å‘äºä¼ è¾“åŒç±»æˆ–è€…ç›¸ä¼¼çš„æ¶ˆæ¯ç±»å‹ï¼Œè¿™äº›ç±»å‹çš„æ¶ˆæ¯ä¼šæœ‰å¤§é‡é‡å¤çš„å­—æ®µåï¼Œå¦‚æœæŒ‰æ‰¹å‹ç¼©ï¼Œèƒ½å¤Ÿè·å¾—è¿œæ¯”å•æ¡æ¶ˆæ¯å¤§çš„å‹ç¼©ç‡ã€‚ç”±äºæ˜¯ç«¯åˆ°ç«¯å‹ç¼©è§£å‹ï¼ŒKafka broker ä¹Ÿå°±æ— éœ€è€ƒè™‘æ¶ˆæ¯æœ¬èº«å®é™…ä½¿ç”¨çš„å‹ç¼©æ ¼å¼ï¼Œè¿™ä¹Ÿç¬¦åˆä¸Šé¢è¯´çš„äºŒè¿›åˆ¶æ¶ˆæ¯æ ¼å¼ä¸­ï¼Œbroker ä¸å‚ä¸æ¶ˆæ¯è½¬æ¢çš„è®¾è®¡æ€æƒ³ã€‚ç›®å‰ï¼ŒKafka æ”¯æŒçš„å‹ç¼©åè®®æœ‰ GZIPã€Snappyã€LZ4 ä»¥åŠ ZStandardã€‚&lt;/p>
&lt;h3 id="å‘å¸ƒè€…çš„ä½å»¶è¿Ÿè®¾è®¡">å‘å¸ƒè€…çš„ä½å»¶è¿Ÿè®¾è®¡&lt;/h3>
&lt;p>å‘å¸ƒè€…çš„ä½å»¶è¿Ÿè®¾è®¡ä¸»è¦æ˜¯é™ä½è´Ÿè½½å‡è¡¡çš„å»¶è¿Ÿã€‚Kafka é‡‡ç”¨äº† producer ç›´è¿ broker çš„è®¾è®¡ï¼Œè€Œä¸ä¾èµ–å…¶ä»–ä»»ä½•ä¸­é—´çš„è·¯ç”±å±‚ï¼Œå¥½å¤„æ˜¯ç›´æ¥é«˜æ•ˆï¼Œå‡å°‘äº†ä¸€å±‚å°±æ˜¯å»é™¤äº†ä¸€ä¸ªç¯èŠ‚çš„å›è·¯ï¼ŒåŒæ—¶é™ä½äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œæ— éœ€é¢å¤–è€ƒè™‘è·¯ç”±å±‚çš„é«˜å¯ç”¨é—®é¢˜ã€‚ä½†æ˜¯å°±è¦æ±‚æ‰€æœ‰ broker èŠ‚ç‚¹éƒ½èƒ½å¤Ÿè·çŸ¥é›†ç¾¤çš„èŠ‚ç‚¹åˆ†å¸ƒä»¥åŠæ¯ä¸ªåˆ†åŒºçš„ leader æ‰€åœ¨èŠ‚ç‚¹ç­‰ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ç”± ZooKeeper ç®¡ç†ã€‚&lt;/p>
&lt;p>å¦å¤–ï¼Œæ¶ˆæ¯æŠ•é€’åˆ†åŒºç”±å®¢æˆ·ç«¯ä¹Ÿå°±æ˜¯ producer å†³å®šï¼Œæ—¢æ”¯æŒéšæœºæˆ–è€…è½®è¯¢ç­‰ç®€å•çš„å‡è¡¡ç®—æ³•ï¼Œä¹Ÿæ”¯æŒæŒ‰ Key å“ˆå¸Œçš„åˆ†åŒºç®—æ³•ç­‰ï¼Œè¿™äº›åœ¨ producer ä¸Šå®Œæˆã€‚&lt;/p>
&lt;h3 id="æ¶ˆè´¹è€…çš„ä½å»¶è¿Ÿè®¾è®¡">æ¶ˆè´¹è€…çš„ä½å»¶è¿Ÿè®¾è®¡&lt;/h3>
&lt;p>æ¶ˆè´¹è€…çš„ä½å»¶è¿Ÿï¼Œä¸€æ–¹é¢æ˜¯ä¾èµ–å‰é¢è®²çš„é›¶æ‹·è´æŠ€æœ¯çš„åº”ç”¨ï¼Œå¦ä¸€æ–¹é¢æ˜¯ç»“åˆæ‰¹é‡æ‹‰å–æ¶ˆæ¯ï¼Œç”±äºå‰é¢éƒ½æœ‰ä»‹ç»ï¼Œè¿™é‡Œåªæ˜¯å¸¦è¿‡ã€‚&lt;/p>
&lt;h2 id="å¯é æ€§çš„è®¾è®¡æ€è€ƒ">å¯é æ€§çš„è®¾è®¡æ€è€ƒ&lt;/h2>
&lt;h3 id="å®ç°æœ‰ä¸”ä»…æœ‰ä¸€æ¬¡çš„æ¶ˆæ¯æŠ•é€’è¯­ä¹‰">å®ç°â€œæœ‰ä¸”ä»…æœ‰ä¸€æ¬¡â€çš„æ¶ˆæ¯æŠ•é€’è¯­ä¹‰&lt;/h3>
&lt;p>æƒ³è¦å®ç°åˆšå¥½ä¸€æ¬¡çš„æ¶ˆæ¯æŠ•é€’ï¼Œéœ€è¦åˆ†å¼€ä»å‘å¸ƒç«¯å’Œæ¶ˆè´¹ç«¯æ¥çœ‹ã€‚&lt;/p>
&lt;p>åœ¨å‘å¸ƒç«¯ï¼Œæ¯ä¸ªå‘å¸ƒè€…éƒ½ä¼šè·å¾— broker æˆäºˆçš„ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œç»“åˆæ¶ˆæ¯æœ¬èº«éšå«çš„é¡ºåºçš„åºå·ï¼Œå¯ä»¥æ–¹ä¾¿ broker è¯†åˆ«é‡å¤æŠ•é€’çš„æ¶ˆæ¯ã€‚å…¶æ¬¡ï¼Œè€ƒè™‘åˆ°åœ¨ä¸€æ¬¡äº‹åŠ¡å‹æ“ä½œä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ªæ¶ˆæ¯åŒæ—¶å‘å¸ƒåˆ°å¤šä¸ªåˆ†åŒºçš„éœ€æ±‚ï¼ŒKafka ä¹Ÿæä¾›äº†ç±»ä¼¼äº‹åŠ¡çš„è¯­ä¹‰ï¼Œå…·ä½“å¤§å®¶å¯ä»¥æœç´¢äº†è§£ä¸€ä¸‹ã€‚&lt;/p>
&lt;p>æ¥åˆ°æ¶ˆè´¹ç«¯ï¼Œå®ç°åˆšå¥½ä¸€æ¬¡çš„æ¶ˆæ¯æŠ•é€’ä¹Ÿç›¸å¯¹ç®€å•ã€‚ç”±äºæ¶ˆæ¯æ‹‰å–èµ·ç‚¹ç”±æ¶ˆè´¹è€…æ§åˆ¶ï¼Œæ‰€ä»¥åªéœ€è¦æ€è€ƒæ¶ˆè´¹è€…å¦‚ä½•é¿å…é‡å¤æ‹‰å–å°±å¥½äº†ã€‚åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå»ºè®®çš„æ–¹å¼æ˜¯æ¶ˆè´¹è€…å°†å·²æ¶ˆè´¹çš„æ¶ˆæ¯åç§»é‡ä¸€åŒè®°å½•åˆ°æ¶ˆè´¹æ¶ˆè´¹å¤„ç†ç»“æœçš„è¾“å‡ºä¸­ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¶ˆè´¹è€…ï¼ˆå¯èƒ½æ˜¯åŸæ¥çš„æ¶ˆè´¹è€…é‡å¯äº†ï¼Œä¹Ÿå¯èƒ½æ˜¯æ¶ˆè´¹è€…æŒ‚äº†åæœ‰å…¶ä»–æ¶ˆè´¹è€…åˆ†æ‹…äº†æ­¤æ¶ˆè´¹è€…åŸæ¥çš„åˆ†åŒºï¼‰åœ¨å¼€å§‹æ‹‰å–ä¹‹å‰ç¡®è®¤æœ€åæ¶ˆè´¹è¿›åº¦ã€‚&lt;/p>
&lt;h3 id="é«˜å¯ç”¨çš„è®¾è®¡æ€è€ƒ">é«˜å¯ç”¨çš„è®¾è®¡æ€è€ƒ&lt;/h3>
&lt;p>é«˜å¯ç”¨çš„è®¾è®¡ä¸»è¦æ¶‰åŠä¸¤ä¸ªå†…å®¹ï¼šå¤åˆ¶å’Œå®¹ç¾é€‰ä¸»ã€‚&lt;/p>
&lt;p>å¤åˆ¶ä¸Šï¼ŒKafka çš„æ¯ä¸ªåˆ†åŒºéƒ½å¯ä»¥é…ç½® 0 ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬æ•°é‡ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªåˆ†åŒºå¯¹åº” 1 ä¸ªæˆ–å¤šä¸ª broker èŠ‚ç‚¹ã€‚follower ä½¿ç”¨å’Œæ¶ˆè´¹è€…ä¸€è‡´çš„æ‰¹é‡æ‹‰å–æœºåˆ¶æ¥åŒæ­¥ leader èŠ‚ç‚¹çš„æ—¥å¿—ã€‚&lt;/p>
&lt;p>åœ¨èŠ‚ç‚¹æ´»æ€§æ–¹é¢ï¼ŒKafka è®¤ä¸ºå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ»¡è¶³ä»¥ä¸‹ä¸¤ç‚¹ï¼Œå³å¯ç§°ä¸º &lt;code>In-Sync&lt;/code> èŠ‚ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>èŠ‚ç‚¹ä¿æŒäº†åˆ° ZooKeeper çš„å¿ƒè·³&lt;/li>
&lt;li>èŠ‚ç‚¹ç´§è·Ÿ Leader çš„æ—¥å¿—å¤åˆ¶ï¼Œæ²¡æœ‰ â€œæ˜æ˜¾è½åâ€ Leader èŠ‚ç‚¹çš„æ—¥å¿—&lt;/li>
&lt;/ul>
&lt;p>åœ¨è€ƒè™‘ Leader æ•…éšœä¸Šï¼ŒKafka æ”¾å¼ƒäº†å¤§å¤šæ•°é€‰ä¸¾çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§æ–¹æ¡ˆï¼Œè€Œæ˜¯é‡‡ç”¨åä¸º ISR ï¼ˆIn-Sync Replicaï¼‰çš„æ–¹æ¡ˆã€‚å› ä¸ºä¼ ç»Ÿçš„å¤§å¤šæ•°é€‰ä¸¾ï¼Œä¸ºäº†å®¹å¿ &lt;code>n&lt;/code> æ¬¡ leader æ•…éšœï¼Œå¿…é¡»éƒ¨ç½² &lt;code>2n+1&lt;/code> ä¸ªèŠ‚ç‚¹ï¼Œå¯¹äºéœ€è¦å­˜å‚¨å¤§é‡æ•°æ®çš„ Kafka æ¥è¯´ï¼Œè¿™ä¸ªæˆæœ¬æ˜¾ç„¶è¿‡å¤§ã€‚è€Œé‡‡ç”¨ ISR çš„æ–¹æ¡ˆï¼Œåªéœ€è¦ &lt;code>n+1&lt;/code> ä¸ªèŠ‚ç‚¹ï¼Œå°±å¯ä»¥åšåˆ°å®¹å¿ &lt;code>n&lt;/code> æ¬¡æ•…éšœçš„æƒ…å†µï¼Œæˆæœ¬ç›¸æ¯”è€Œè¨€é™ä½äº†æ¥è¿‘ä¸€åŠã€‚&lt;/p>
&lt;p>åœ¨ ISR çš„æ–¹æ¡ˆä¸‹ï¼Œæ¶ˆæ¯è¢«æˆåŠŸæäº¤çš„åˆ¤æ–­å°±æ˜¯ In-Sync é›†åˆä¸­çš„æ‰€æœ‰èŠ‚ç‚¹è¿”å›ç¡®è®¤æˆåŠŸã€‚ä¸€ä¸ªæˆåŠŸæäº¤çš„æ¶ˆæ¯å¯ä»¥ä¿è¯ä¸ä¼šä¸¢å¤±ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ ISR çš„æ–¹æ¡ˆè¿˜éœ€è¦è€ƒè™‘ä¸€ç§æç«¯åœºæ™¯ï¼šå¦‚æœæ‰€æœ‰ In-Sync èŠ‚ç‚¹éƒ½æ•…éšœäº†ï¼Œæ€æ ·é€‰å–æ–°çš„ Leaderï¼Ÿæœ‰ä¸¤ç§ä¸åŒçš„å–èˆï¼š&lt;/p>
&lt;ul>
&lt;li>ç‰ºç‰²å¯ç”¨æ€§ï¼šåšå†³ç­‰å¾… In-Sync æœºå™¨æ¢å¤ï¼Œä¸å¯ç”¨çš„æ—¶é—´å¯èƒ½æ›´é•¿&lt;/li>
&lt;li>ç‰ºç‰²ä¸€è‡´æ€§ï¼šé€‰å–ä»»æ„ä¸€å°å¯ç”¨çš„æœºå™¨ä½œä¸º Leaderï¼Œè¿™ä¸ªæœºå™¨å¯èƒ½æ˜¯ In-Syncï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯&lt;/li>
&lt;/ul>
&lt;p>åœ¨ Kafka é»˜è®¤é€‰é¡¹ä¸­ï¼Œä½¿ç”¨äº†å‰é¢çš„æ–¹æ¡ˆï¼Œå°±æ˜¯ Kafka è®¤ä¸ºä¸€èˆ¬æ¥è¯´ä¸€è‡´æ€§æ›´é‡è¦ã€‚&lt;/p>
&lt;p>å¦å¤–ï¼ŒKafka è¿˜ä¼šå°½å¯èƒ½å°†æ‰€æœ‰åˆ†åŒºçš„ Leader å‡åŒ€åˆ†æ•£åˆ°ä¸åŒçš„ broker ä¸Šã€‚&lt;/p>
&lt;h2 id="å…¶ä»–è®¾è®¡æ€è€ƒ">å…¶ä»–è®¾è®¡æ€è€ƒ&lt;/h2>
&lt;h3 id="åˆ†æ®µå­˜å‚¨æå‡æŸ¥æ‰¾æ•ˆç‡">åˆ†æ®µå­˜å‚¨æå‡æŸ¥æ‰¾æ•ˆç‡&lt;/h3>
&lt;p>ç†Ÿæ‚‰ Kafka çš„åŒå­¦ä¹Ÿéƒ½çŸ¥é“ï¼Œå°½ç®¡ Kafka çš„ topic ä¼šè¿›ä¸€æ­¥åˆ†ä¸ºå¤šä¸ªåˆ†åŒºï¼ˆpartitionï¼‰ï¼Œåˆ†åŒºä¹Ÿæ˜¯å¤‡ä»½çš„æœ€å°å•å…ƒï¼Œä½†æ˜¯å•ä¸ªåˆ†åŒºçš„æ—¥å¿—åœ¨ç£ç›˜ä¸Šè¿˜ä¼šè¿›ä¸€æ­¥åˆ†è§£ä¸ºå¤šä¸ªæ®µï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªç‹¬ç«‹çš„æ–‡ä»¶ï¼Œé€»è¾‘ä¸Šå¯ä»¥è§ä¸‹é¢è¿™ä¸ªå®˜æ–¹æ–‡æ¡£çš„å›¾ï¼š&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/kafka_log.png" alt="">
&lt;/p>
&lt;p>å¥½å¤„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå½“ç„¶æ˜¯æ–¹ä¾¿æŸ¥æ‰¾äº†ï¼Œä½ æƒ³æƒ³ï¼Œæ—¢ç„¶æ¶ˆæ¯çš„æ—¥å¿—æ˜¯é¡ºåºå­˜å‚¨çš„ï¼Œé‚£æˆ‘ç»“åˆäºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œä¸å°±å¯ä»¥æ”¯æŒå¿«é€Ÿå®šä½åˆ°æŒ‡å®šçš„æ¶ˆæ¯äº†å—ï¼Ÿ&lt;/p>
&lt;h3 id="æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦æ ‡è®°consumer-offset">æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦æ ‡è®°â€”â€”consumer offset&lt;/h3>
&lt;p>ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œbrokeréƒ½éœ€è¦è€ƒè™‘ä¸€ç§åŠŸèƒ½ï¼šè®°å½•æ¶ˆæ¯è¢«æ¶ˆè´¹çš„çŠ¶æ€ã€‚ä¸€ç§ç»å…¸çš„æ€è·¯æ˜¯æ ‡è®°æ¯ä¸ªæ¶ˆæ¯çš„çŠ¶æ€ï¼šå·²æŠ•é€’ã€å·²ç¡®è®¤ã€‚ä½†æ˜¯è¿™ç§æ–¹æ¡ˆæœ‰å‡ ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯èƒ½é‡å¤æŠ•é€’æ¶ˆæ¯ï¼šå¯¹äº broker æ¥è¯´ï¼Œç­‰å¾…ç¡®è®¤æ¶ˆæ¯çš„è¿‡ç¨‹ä¸­æœ‰å¾ˆå¤šæœªçŸ¥å› ç´ ï¼Œå¯èƒ½å¯¼è‡´æ¶ˆæ¯æœªèƒ½è¢«æ­£ç¡®ç¡®è®¤ï¼Œbroker å¯èƒ½ä¼šè¢«è®¾è®¡æˆå†æ¬¡æŠ•é€’æœªç¡®è®¤æ¶ˆæ¯ï¼›&lt;/li>
&lt;li>é¢å¤–çš„å­˜å‚¨ç©ºé—´å¼€é”€ï¼šå¯¹äºæ¯ä¸ªæ¶ˆæ¯ï¼Œéƒ½éœ€è¦é¢å¤–çš„å­˜å‚¨ç©ºé—´ç”¨äºæ ‡è®°ä¿¡æ¯ï¼›&lt;/li>
&lt;li>éœ€è¦è€ƒè™‘æç«¯åœºæ™¯ï¼šå¤§é‡æ¶ˆæ¯å‘é€åæœªè¢«ç¡®è®¤ã€‚&lt;/li>
&lt;/ul>
&lt;p>Kafka çš„åšæ³•æ¯”è¾ƒç®€å•ç²—æš´ï¼šé™å®šæ¯ä¸ªåˆ†åŒºä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è¿™æ ·ä¸€æ¥ï¼Œç”±äºä¸€ä¸ªåˆ†åŒºåªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œè€Œä¸”æ¶ˆæ¯é¡ºåºæŠ•é€’ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„æ•´æ•°è¡¨ç¤ºä¸€ä¸ªæ¶ˆè´¹è€…ç»„åœ¨ä¸€ä¸ªåˆ†åŒºä¸Šçš„æ¶ˆè´¹è¿›åº¦ï¼Œè€Œä¸æ˜¯è®°å½•æ¯ä¸ªæ¶ˆæ¯çš„æ¶ˆè´¹çŠ¶æ€ï¼Œè¿™æ˜¯ä¸€ä¸ªæä½çš„ O(1) çš„å¸¸é‡ç©ºé—´å¼€é”€ã€‚å¦å¤–æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦å¯ä»¥å‘¨æœŸæ€§æ›´æ–°ï¼Œè€Œä¸”åªéœ€è¦æ›´æ–° offset ä¿¡æ¯ï¼Œæ•´ä½“ç»´æŠ¤æ¶ˆæ¯ç¡®è®¤è¿›åº¦çš„æˆæœ¬æ˜¾ç„¶æ›´ä½ã€‚&lt;/p>
&lt;p>æœ€åï¼ŒKafka ç”±äºä¿ç•™äº†å†å²æ¶ˆæ¯ï¼Œé…åˆå‰é¢è¯´çš„åˆ†æ®µå­˜å‚¨å’ŒæŸ¥æ‰¾ï¼Œæ‰€ä»¥ Kafka å¯ä»¥æ–¹ä¾¿åœ°æ”¯æŒå›é€€ offset çš„åœºæ™¯ï¼Œä»¥ä¾¿é‡æ”¾æ¶ˆæ¯ã€‚&lt;/p>
&lt;h3 id="æ—¥å¿—å‹ç¼©log-compaction">æ—¥å¿—å‹ç¼©ï¼ˆLog Compactionï¼‰&lt;/h3>
&lt;p>è¿™é‡Œçš„æ—¥å¿—å‹ç¼©ä¸åŒäºå‰é¢æåˆ°çš„æ¶ˆæ¯å‹ç¼©ï¼Œè¿™é‡Œç‰¹æŒ‡å¯¹æ—¥å¿—è¿›è¡Œåˆå¹¶é‡å†™ï¼Œä»¥åªä¿ç•™åŒä¸ª key çš„æ¶ˆæ¯çš„æœ€æ–°ç‰ˆæœ¬ã€‚ç»è¿‡æ—¥å¿—å‹ç¼©åï¼Œä¿ç•™ä¸‹æ¥çš„æ¶ˆæ¯ä»æ—§ä¿æŒæ—¶åºæ€§ä¸å˜ï¼Œoffset ä¹Ÿä¸å˜ï¼Œä½†æ˜¯æ•´ä¸ªåˆ†åŒºå†…çš„æ¶ˆæ¯çš„ offset ä¸å†è¿ç»­ã€‚&lt;/p>
&lt;p>è‡³äºæ—¥å¿—å‹ç¼©çš„ä½œç”¨ï¼Œåº”è¯¥ç±»ä¼¼ Redis çš„ AOF é‡å†™ï¼Œæ›´å¤šæ˜¯ä¸ºäº†å‡å°å­˜å‚¨ç©ºé—´çš„å ç”¨å§ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>æœ¬æ–‡ä»¥èµ°é©¬è§‚èŠ±çš„æ–¹å¼ä»‹ç»äº† Kafka å®˜æ–¹å¯¹äº Kafka è®¾è®¡æ€è€ƒä»¥åŠè¯¸å¤šæƒè¡¡ï¼Œä»¥ä¾¿æˆ‘è‡ªå·±èƒ½å¤Ÿå¿«é€Ÿç†è§£ Kafka ä¸­çš„å¾ˆå¤šè®¾è®¡çš„å‡ºå‘ç‚¹ï¼Œè¿›è€Œèƒ½å¤Ÿæ›´å¥½åœ°ç†è§£ Kafka çš„å¾ˆå¤šåº•å±‚è®¾è®¡æ€è·¯ã€‚æ­¤å‰æˆ‘å¯¹äº Kafka çš„è®¤è¯†ä»…é™äºå®ƒçš„åˆ†åŒºè®¾è®¡ä»¥åŠoffsetï¼Œç‰¹åˆ«æ˜¯æ¶ˆè´¹è€…ç»„çš„è®¾è®¡ç­‰ç­‰ï¼Œä½†æ˜¯åªæ˜¯çŸ¥å…¶ç„¶ï¼Œå®˜æ–¹æ–‡æ¡£çš„è®¾è®¡æ€è€ƒå†…å®¹å¸®æˆ‘è‡ªå·±è¡¥å…¨äº†å¯¹äº Kafka çŸ¥å…¶æ‰€ä»¥ç„¶çš„è®¤è¯†ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://kafka.apache.org/documentation/#design">Kafka Documentation: 4. Design&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tech.meituan.com/2017/05/19/about-desk-io.html">ç¾å›¢æŠ€æœ¯å›¢é˜Ÿåšå®¢ï¼šç£ç›˜I/Oé‚£äº›äº‹&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>åç¼€è¡¨è¾¾å¼ä¹‹é€†æ³¢å…°è¡¨ç¤ºæ³•</title><link>https://blog.hackerpie.com/posts/algorithms/queue-and-stack/reverse-polish-representation/</link><pubDate>Sun, 05 Dec 2021 20:56:28 +0800</pubDate><guid>https://blog.hackerpie.com/posts/algorithms/queue-and-stack/reverse-polish-representation/</guid><description>&lt;h2 id="ä»ä¸­ç¼€è¡¨è¾¾å¼è¯´èµ·">ä»ä¸­ç¼€è¡¨è¾¾å¼è¯´èµ·&lt;/h2>
&lt;p>å¯¹äºäººç±»æ¥è¯´ï¼Œä¸­ç¼€è¡¨è¾¾å¼æ˜¯æœ€ç›´è§‚è‡ªç„¶çš„ï¼Œæ¯”å¦‚â€œ3+5x4â€æˆ–è€…â€œ(3+5)x4â€ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¯¹äºä¸­ç¼€è¡¨è¾¾å¼ï¼Œåœ¨ç¨‹åºä¸­ä¼šç”¨ä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘æ¥è¡¨ç¤ºè¡¨è¾¾å¼å’Œæ±‚å€¼ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code> 3+5x4
+
/ \
/ \
3 x
/ \
/ \
5 4
--------------------------------
(3+5)x4
x
/ \
/ \
+ 4
/ \
/ \
3 5
&lt;/code>&lt;/pre>&lt;p>åç»­è¡¨è¾¾å¼æ±‚å€¼ä½¿ç”¨äºŒå‰æ ‘çš„ä¸­åºéå†ä¾¿å¯ã€‚&lt;/p>
&lt;p>ä½†æ˜¯è¿™ç§è¡¨è¾¾å¼å¯¹äºè®¡ç®—æœºæ¥è¯´ï¼Œä¼šæœ‰2ä¸ªå¯ä»¥è€ƒè™‘æå‡çš„é—®é¢˜ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹äºè®¡ç®—æœºä¸å¤Ÿç›´è§‚ï¼Œéœ€è¦åœ¨æ ‘çš„ç»“æ„ä¸Šè¿›è¡Œéå†å’Œæ±‚å€¼ï¼›&lt;/li>
&lt;li>é¢å¤–çš„æ‹¬å·æ¥ç”¨äºæ˜ç¡®è¿ç®—ä¼˜å…ˆçº§ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="åç¼€è¡¨è¾¾å¼">åç¼€è¡¨è¾¾å¼&lt;/h2>
&lt;p>åç¼€è¡¨è¾¾å¼ï¼Œä¹Ÿå«&lt;a href="https://zh.wikipedia.org/wiki/%E9%80%86%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">é€†æ³¢å…°è¡¨è¾¾å¼&lt;/a>ï¼Œå‰è¿°çš„è¡¨è¾¾å¼å¯¹åº”çš„åç¼€è¡¨è¾¾å¼ä¸ºï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>3+5x4&lt;/code>ï¼š&lt;code>3 5 4 x +&lt;/code>&lt;/li>
&lt;li>&lt;code>(3+5)x4&lt;/code>ï¼š&lt;code>3 5 + 4 x&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>å¯ä»¥çœ‹å‡ºåç¼€è¡¨è¾¾å¼çš„ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>æ“ä½œç¬¦åœ¨æ“ä½œæ•°çš„æœ«å°¾ï¼Œæ¯”å¦‚ &lt;code>5 x 4&lt;/code> è¡¨ç¤ºä¸º &lt;code>5 4 x&lt;/code>ï¼›&lt;/li>
&lt;li>æ— éœ€æ‹¬å·è¡¨è¾¾ä¼˜å…ˆçº§&lt;/li>
&lt;/ul>
&lt;p>ä»è®¡ç®—æœºçš„è§’åº¦ï¼Œåç¼€è¡¨è¾¾å¼è¿˜æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š&lt;/p>
&lt;ul>
&lt;li>ç”±äºæ²¡æœ‰æ‹¬å·ï¼Œå¯ä»¥èŠ‚çœå†…å­˜&lt;/li>
&lt;li>å¯ä»¥åŸºäºæ ˆç»“æ„å®ç°åç¼€è¡¨è¾¾å¼çš„æ±‚å€¼&lt;/li>
&lt;li>&lt;strong>å¦‚æœå¯¹æŠ½è±¡è¯­æ³•æ ‘è¿›è¡Œæœ«åºéå†ï¼Œåˆšå¥½å¯ä»¥å¾—åˆ°é€†æ³¢å…°è¡¨è¾¾å¼ï¼Œè¿™ç‚¹æ¯”è¾ƒæœ‰æ„æ€&lt;/strong>&lt;/li>
&lt;/ul>
&lt;h3 id="å°†ä¸­ç¼€è¡¨è¾¾å¼è½¬ä¸ºåç¼€è¡¨è¾¾å¼">å°†ä¸­ç¼€è¡¨è¾¾å¼è½¬ä¸ºåç¼€è¡¨è¾¾å¼&lt;/h3>
&lt;p>ä¸ºäº†å°†ä¸­ç¼€è¡¨è¾¾å¼è½¬ä¸ºåç¼€è¡¨è¾¾å¼ï¼Œä¸€èˆ¬éœ€è¦ç”¨åˆ°çš„æ˜¯&lt;a href="https://zh.wikipedia.org/wiki/%E9%80%86%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">è°ƒåº¦åœºç®—æ³•&lt;/a>ï¼Œç®—æ³•ä¸­éœ€è¦ç”¨åˆ°ä¸€ä¸ªè¾“å‡ºé˜Ÿåˆ—å’Œä¸€ä¸ªæ“ä½œç¬¦æ ˆï¼Œå®Œæ•´çš„ç®—æ³•ç»†èŠ‚æ¯”è¾ƒå¤šï¼Œè¿™é‡Œç®€åŒ–ä¸ºç®€å•çš„å››åˆ™è¿ç®—ï¼ˆæ”¯æŒæ‹¬å·ï¼‰æ¥æè¿°ç²¾ç®€ç‰ˆç®—æ³•ï¼Œå¦‚æœéœ€è¦æ”¯æŒå®Œæ•´çš„è¿ç®—ç¬¦æˆ–è€…å‡½æ•°ç­‰ï¼Œéœ€è¦è‡ªè¡Œå­¦ä¹ å®Œæ•´çš„è°ƒåº¦åœºç®—æ³•ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹ç”¨ä¼ªä»£ç æè¿°ï¼ˆ&lt;strong>æ³¨æ„ï¼š&lt;/strong> ç®—æ³•ä¸­çš„â€œå•è¯ç¬¦å·â€ä¸€è¯å‚è€ƒç¼–è¯‘åŸç†ä¸­çš„â€œtokenâ€ä¸€è¯ï¼Œæ„æ€æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä¸ºäº†ä¼ªä»£ç ä¸ä¼šä¸­è‹±æ··æ‚ï¼Œæ‰å†™äº†ä¸­æ–‡åå­—ï¼Œä¸ä¸€å®šç²¾ç¡®ï¼‰ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>å£°æ˜ Qï¼šè¾“å‡ºé˜Ÿåˆ—
å£°æ˜ Sï¼šæ“ä½œç¬¦æ ˆ
éå†ä¸­ç¼€è¡¨è¾¾å¼ä¸­çš„æ¯ä¸€ä¸ªå•è¯ç¬¦å· xï¼š
å¦‚æœ x æ˜¯ä¸€ä¸ªæ“ä½œæ•°ï¼Œç›´æ¥å°† x è¿½åŠ åˆ°è¾“å‡ºé˜Ÿåˆ— Q æœ«å°¾ï¼Œå¦åˆ™å¾€ä¸‹æ£€æŸ¥ï¼›
å¦‚æœ x æ˜¯ä¸€ä¸ªå·¦æ‹¬å·â€œ(â€ï¼Œå°† x å‹å…¥æ“ä½œç¬¦æ ˆ S æ ˆé¡¶ï¼Œå¦åˆ™å¾€ä¸‹æ£€æŸ¥ï¼›
å¦‚æœ x æ˜¯ä¸€ä¸ªæ“ä½œç¬¦ï¼š
å¦‚æœæ“ä½œç¬¦æ ˆ S æ ˆé¡¶ä¸ºä¸€ä¸ªä¼˜å…ˆçº§å¤§äºç­‰äº x çš„æ“ä½œç¬¦ï¼Œåˆ™å°† S æ ˆé¡¶çš„è¿ç®—ç¬¦å¼¹å‡ºå¹¶ä¸”è¿½åŠ åˆ°è¾“å‡ºé˜Ÿåˆ— Q æœ«å°¾ï¼Œæœ€åå°† x å‹å…¥æ ˆé¡¶ï¼›
å¦‚æœæ“ä½œç¬¦æ ˆ S æ ˆé¡¶ä¸ºä¸€ä¸ªä¼˜å…ˆçº§å°äº x çš„æ“ä½œç¬¦ï¼Œæˆ–è€…ä¸ä¸ºæ“ä½œç¬¦ï¼ˆåœ¨è¿™ä¸ªç®€åŒ–ç®—æ³•é‡Œï¼Œåªæœ‰å¯èƒ½æ˜¯å·¦æ‹¬å·ï¼‰ï¼Œåˆ™ç›´æ¥å°† x å‹å…¥æ ˆé¡¶å³å¯ã€‚
å¦‚æœ x æ˜¯ä¸€ä¸ªå³æ‹¬å·â€œ)â€ï¼Œåˆ™å°†æ“ä½œç¬¦æ ˆ S æ ˆé¡¶åˆ°å¾€ä¸‹ç¬¬ä¸€ä¸ªå·¦æ‹¬å·â€œ(â€ä¹‹é—´çš„å…ƒç´ ä¾æ¬¡å¼¹å‡ºå¹¶ä¸”è¿½åŠ åˆ°è¾“å‡ºé˜Ÿåˆ—æœ«å°¾ï¼Œå°†â€œ(â€å‡ºæ ˆä¸¢å¼ƒï¼Œx ä¹Ÿä¸ç”¨å…¥æ ˆã€‚æ³¨æ„ï¼šå¦‚æœæ ˆåˆ°åº•åä»æ²¡æœ‰æ‰¾åˆ°å·¦æ‹¬å·ï¼Œåˆ™è¯´æ˜è¡¨è¾¾å¼ä¸åˆæ³•ï¼Œå·¦å³æ‹¬å·ä¸åŒ¹é…ã€‚
æœ€åå°†æ ˆ S ä¸­çš„å…ƒç´ å…¨éƒ¨ä¾æ¬¡å¼¹å‡ºå¹¶ä¸”å…¥é˜Ÿåˆ— Qã€‚
&lt;/code>&lt;/pre>&lt;h4 id="å®ä¾‹æ¼”ç¤º">å®ä¾‹æ¼”ç¤º&lt;/h4>
&lt;p>ç”¨ä¸€ä¸ªç¨å¾®å¤æ‚çš„å››åˆ™è¿ç®—è¡¨è¾¾å¼æ¥ä¸¾ä¾‹ï¼š&lt;code>(12+5)x(8-1)-6x6&lt;/code>ã€‚&lt;/p>
&lt;p>åˆ™ç®—æ³•å¯¹åº”æ¯ä¸€æ­¥çš„è¿‡ç¨‹ä»¥åŠé˜Ÿåˆ—å’Œæ ˆçš„çŠ¶æ€å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>éå†åºå·&lt;/th>
&lt;th>å•è¯ç¬¦å·&lt;/th>
&lt;th>è¾“å‡ºé˜Ÿåˆ—ï¼ˆå·¦è¾¹ä¸ºé˜Ÿé¦–ï¼‰&lt;/th>
&lt;th>æ“ä½œç¬¦æ ˆï¼ˆå·¦ä¾§ä¸ºæ ˆåº•ï¼‰&lt;/th>
&lt;th>è§£é‡Šè¯´æ˜&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>(&lt;/td>
&lt;td>ï¼ˆç©ºï¼‰&lt;/td>
&lt;td>(&lt;/td>
&lt;td>é‡åˆ°å·¦æ‹¬å·ï¼Œç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>12&lt;/td>
&lt;td>12&lt;/td>
&lt;td>(&lt;/td>
&lt;td>12 ä¸ºæ“ä½œæ•°ï¼Œç›´æ¥å…¥é˜Ÿåˆ—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>+&lt;/td>
&lt;td>12&lt;/td>
&lt;td>(, +&lt;/td>
&lt;td>+ ä¸ºæ“ä½œç¬¦ï¼Œæ ˆé¡¶æ­¤æ—¶ä¸ºéæ“ä½œç¬¦ï¼Œç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>5&lt;/td>
&lt;td>12, 5&lt;/td>
&lt;td>(, +&lt;/td>
&lt;td>5 ä¸ºæ“ä½œæ•°ï¼Œç›´æ¥å…¥é˜Ÿåˆ—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5&lt;/td>
&lt;td>)&lt;/td>
&lt;td>12, 5, +&lt;/td>
&lt;td>(ç©º)&lt;/td>
&lt;td>) ä¸ºå³æ‹¬å·ï¼Œéœ€è¦å°†æ ˆé¡¶åˆ°ç¬¬ä¸€ä¸ªå·¦æ‹¬å·ä¹‹é—´çš„å…ƒç´ å‡ºæ ˆå…¥é˜Ÿåˆ—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6&lt;/td>
&lt;td>x&lt;/td>
&lt;td>12, 5, +&lt;/td>
&lt;td>x&lt;/td>
&lt;td>x ä¸ºæ“ä½œç¬¦ï¼Œæ ˆé¡¶ä¸ºç©ºï¼Œç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7&lt;/td>
&lt;td>(&lt;/td>
&lt;td>12, 5, +&lt;/td>
&lt;td>x, (&lt;/td>
&lt;td>å·¦æ‹¬å·ç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8&lt;/td>
&lt;td>8&lt;/td>
&lt;td>12, 5, +, 8&lt;/td>
&lt;td>x, (&lt;/td>
&lt;td>8 ä¸ºæ“ä½œæ•°ï¼Œç›´æ¥å…¥é˜Ÿåˆ—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>9&lt;/td>
&lt;td>-&lt;/td>
&lt;td>12, 5, +, 8&lt;/td>
&lt;td>x, (, -&lt;/td>
&lt;td>- ä¸ºæ“ä½œç¬¦ï¼Œæ ˆé¡¶ä¸ºéæ“ä½œç¬¦ï¼Œç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>10&lt;/td>
&lt;td>1&lt;/td>
&lt;td>12, 5, +, 8, 1&lt;/td>
&lt;td>x, (, -&lt;/td>
&lt;td>1 ä¸ºæ“ä½œæ•°ï¼Œç›´æ¥å…¥é˜Ÿåˆ—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>11&lt;/td>
&lt;td>)&lt;/td>
&lt;td>12, 5, +, 8, 1, -&lt;/td>
&lt;td>x&lt;/td>
&lt;td>é‡åˆ°å³æ‹¬å·ï¼Œéœ€è¦å°†æ ˆé¡¶åˆ°ç¬¬ä¸€ä¸ªå·¦æ‹¬å·ä¹‹é—´çš„å…ƒç´ å‡ºæ ˆå…¥é˜Ÿåˆ—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>12&lt;/td>
&lt;td>-&lt;/td>
&lt;td>12, 5, +, 8, 1, -, x&lt;/td>
&lt;td>-&lt;/td>
&lt;td>- ä¸ºæ“ä½œç¬¦ï¼Œæ­¤æ—¶æ ˆé¡¶å…ƒç´ ä¹Ÿä¸ºæ“ä½œç¬¦ï¼Œä¸”ä¼˜å…ˆçº§æ›´é«˜ï¼Œåˆ™å°†æ ˆé¡¶å¼¹å‡ºå…¥é˜Ÿåˆ—ï¼Œå†å°† - å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>13&lt;/td>
&lt;td>6&lt;/td>
&lt;td>12, 5, +, 8, 1, -, x, 6&lt;/td>
&lt;td>-&lt;/td>
&lt;td>6 ä¸ºæ“ä½œæ•°ï¼Œç›´æ¥å…¥é˜Ÿåˆ—&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>14&lt;/td>
&lt;td>x&lt;/td>
&lt;td>12, 5, +, 8, 1, -, x, 6&lt;/td>
&lt;td>-, x&lt;/td>
&lt;td>x ä¸ºæ“ä½œç¬¦ï¼Œæ­¤æ—¶æ ˆé¡¶å…ƒç´ ä¹Ÿä¸ºæ“ä½œç¬¦ï¼Œä½†ä¼˜å…ˆçº§è¾ƒä½ï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥å°† x å…¥æ ˆå³å¯&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>15&lt;/td>
&lt;td>6&lt;/td>
&lt;td>12, 5, +, 8, 1, -, x, 6, 6&lt;/td>
&lt;td>-, x&lt;/td>
&lt;td>6 ä¸ºæ“ä½œæ•°ï¼Œç›´æ¥å…¥é˜Ÿåˆ—&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>éå†ç»“æŸåï¼Œæ“ä½œç¬¦æ ˆä¸ä¸ºç©ºï¼Œå°†æ ˆé‡Œå…ƒç´ ä¾æ¬¡å¼¹å‡ºå¹¶ä¸”è¿½åŠ åˆ°è¾“å‡ºé˜Ÿåˆ—æœ«å°¾ï¼Œå¯å¾—è¾“å‡ºé˜Ÿåˆ—ç»“æœä¸ºï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>12, 5, +, 8, 1, -, x, 6, 6, x, -
&lt;/code>&lt;/pre>&lt;p>ä¹Ÿå°±æ˜¯å¾—åˆ°çš„åç¼€è¡¨è¾¾å¼æ˜¯ &lt;code>12 5 + 8 1 - x 6 6 x -&lt;/code>ã€‚&lt;/p>
&lt;h3 id="æ±‚å€¼è®¡ç®—">æ±‚å€¼è®¡ç®—&lt;/h3>
&lt;p>åç¼€è¡¨è¾¾å¼çš„æ±‚å€¼è¿‡ç¨‹ç›¸å¯¹æ¯”è¾ƒç®€å•ç›´è§‚ï¼ŒåŒæ ·éœ€è¦å€ŸåŠ©æ ˆæ¥å®ç°ï¼Œä»¥ä¸‹ä¸ºç®€è¦çš„å››åˆ™è¿ç®—å¯¹åº”çš„åç¼€è¡¨è¾¾å¼æ±‚å€¼ç®—æ³•æè¿°ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>å£°æ˜ Sï¼šæ±‚å€¼æ ˆ
éå†åç¼€è¡¨è¾¾å¼ä¸­çš„æ¯ä¸€ä¸ªå•è¯ç¬¦å· x:
å¦‚æœ x ä¸ºæ“ä½œæ•°ï¼Œåˆ™ç›´æ¥å°† x å‹å…¥æ±‚å€¼æ ˆ Sï¼Œå¦åˆ™å¾€ä¸‹ç»§ç»­ï¼›
å¦‚æœ x ä¸ºæ“ä½œç¬¦ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œåªæœ‰å¯èƒ½æ˜¯+-âœ–ï¸Ã·ä¹‹ä¸€ï¼‰ï¼Œåˆ™ä»æ ˆä¸­å¼¹å‡º2ä¸ªå…ƒç´  a å’Œ bï¼Œå°† b å’Œ a æ‰§è¡Œå¯¹åº”æ“ä½œç¬¦çš„è¿ç®—ï¼Œå°†è¿ç®—ç»“æœå‹å…¥æ ˆã€‚
æœ€åæ ˆä¸­åº”è¯¥åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œå³ä¸ºè¡¨è¾¾å¼çš„æœ€ç»ˆç»“æœã€‚
&lt;/code>&lt;/pre>&lt;p>ä»¥å‰ä¸€å°èŠ‚å¾—åˆ°çš„åç¼€è¡¨è¾¾å¼ &lt;code>12 5 + 8 1 - x 6 6 x -&lt;/code> ä¸ºä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ±‚å€¼è¿‡ç¨‹ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>éå†åºå·&lt;/th>
&lt;th>å•è¯ç¬¦å·&lt;/th>
&lt;th>æ±‚å€¼æ ˆï¼ˆå·¦ä¾§ä¸ºæ ˆåº•ï¼‰&lt;/th>
&lt;th>è§£é‡Šè¯´æ˜&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>12&lt;/td>
&lt;td>12&lt;/td>
&lt;td>æ“ä½œæ•°ç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>2&lt;/td>
&lt;td>5&lt;/td>
&lt;td>12, 5&lt;/td>
&lt;td>æ“ä½œæ•°ç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3&lt;/td>
&lt;td>+&lt;/td>
&lt;td>17&lt;/td>
&lt;td>é‡åˆ°æ“ä½œç¬¦ï¼Œå¼¹å‡ºæ ˆä¸­çš„ 5 å’Œ 12ï¼ŒåšåŠ æ³• &lt;code>12 + 5&lt;/code>ï¼Œå¾—åˆ° 17ï¼Œå‹å›æ ˆä¸­&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4&lt;/td>
&lt;td>8&lt;/td>
&lt;td>17, 8&lt;/td>
&lt;td>æ“ä½œæ•°ç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>5&lt;/td>
&lt;td>1&lt;/td>
&lt;td>17, 8, 1&lt;/td>
&lt;td>æ“ä½œæ•°ç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>6&lt;/td>
&lt;td>-&lt;/td>
&lt;td>17, 7&lt;/td>
&lt;td>é‡åˆ°æ“ä½œç¬¦ï¼Œå¼¹å‡ºæ ˆä¸­çš„ 1 å’Œ 8ï¼Œåšå‡æ³• &lt;code>8 - 1&lt;/code>ï¼Œå¾—åˆ° 7ï¼Œå‹å›æ ˆä¸­&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>7&lt;/td>
&lt;td>x&lt;/td>
&lt;td>119&lt;/td>
&lt;td>é‡åˆ°æ“ä½œç¬¦ï¼Œå¼¹å‡ºæ ˆä¸­çš„ 7 å’Œ 17ï¼Œåšä¹˜æ³• &lt;code>17 x 7&lt;/code>ï¼Œå¾—åˆ° 119ï¼Œå‹å›æ ˆä¸­&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8&lt;/td>
&lt;td>6&lt;/td>
&lt;td>119, 6&lt;/td>
&lt;td>æ“ä½œæ•°ç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>9&lt;/td>
&lt;td>6&lt;/td>
&lt;td>119, 6, 6&lt;/td>
&lt;td>æ“ä½œæ•°ç›´æ¥å…¥æ ˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>10&lt;/td>
&lt;td>x&lt;/td>
&lt;td>119, 36&lt;/td>
&lt;td>é‡åˆ°æ“ä½œç¬¦ï¼Œå¼¹å‡ºæ ˆä¸­çš„ 6 å’Œ 6ï¼Œåšä¹˜æ³• &lt;code>6 x 6&lt;/code>ï¼Œå¾—åˆ° 36ï¼Œå‹å›æ ˆä¸­&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>11&lt;/td>
&lt;td>-&lt;/td>
&lt;td>83&lt;/td>
&lt;td>é‡åˆ°æ“ä½œç¬¦ï¼Œå¼¹å‡ºæ ˆä¸­çš„ 36 å’Œ 119ï¼Œåšä¹˜æ³• &lt;code>119 - 36&lt;/code>ï¼Œå¾—åˆ° 83ï¼Œå‹å›æ ˆä¸­&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>æœ€åï¼Œæ ˆé‡Œåˆšå¥½åªå‰©ä¸€ä¸ªå…ƒç´  83ï¼Œå³ä¸ºæˆ‘ä»¬çš„æ±‚å€¼ç»“æœã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>é€†æ³¢å…°è¡¨è¾¾å¼æ˜¯ä¸€ç§æ›´é€‚åˆè®¡ç®—æœºç†è§£çš„è¡¨è¾¾å¼è¡¨ç¤ºæ–¹æ³•ï¼Œç›¸æ¯”è¾ƒæŠ½è±¡è¯­æ³•æ ‘çš„å½¢å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨è¡¨ç¤ºä¸Šï¼Œå®ƒèƒ½å¤ŸèŠ‚çœæ›´å¤šçš„å†…å­˜ï¼ˆå¦‚æœç”¨æ ‘ï¼Œä¸€æ–¹é¢çš„å†…å­˜å¼€é”€åœ¨äºæ‹¬å·èŠ‚ç‚¹ï¼Œå¦ä¸€æ–¹é¢çš„å†…å­˜å¼€é”€åœ¨äºæ ‘èŠ‚ç‚¹ä¹‹é—´çš„æŒ‡é’ˆï¼Œå¦‚æœè€ƒè™‘åˆ°éå†ï¼Œè¿˜ä¼šæœ‰é€’å½’è°ƒç”¨å¸¦æ¥çš„è°ƒç”¨æ ˆçš„å†…å­˜å¼€é”€ï¼‰ï¼›&lt;/li>
&lt;li>åœ¨æ±‚å€¼ä¸Šï¼Œé€†æ³¢å…°è¡¨è¾¾å¼ä¹Ÿæ›´ç®€æ´ï¼ŒåŒæ—¶å¯ä»¥é¿å…æ ‘éå†è¿‡ç¨‹ä¸­çš„é€’å½’å½¢å¼ï¼Œé€’å½’æ˜¯ä¸€ç§äººç±»é˜…è¯»èµ·æ¥æ¯”è¾ƒè´¹è„‘çš„ä»£ç ç»“æ„ï¼›&lt;/li>
&lt;li>æ”¯æŒæ— æ­§ä¹‰çš„è¿ç®—ä¼˜å…ˆçº§è€Œæ— éœ€å¼•å…¥æ‹¬å·ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>å†æ¬¡å£°æ˜ï¼Œæœ¬æ–‡ä¸­çš„è°ƒåº¦åœºç®—æ³•å’Œæ±‚å€¼ç®—æ³•å‡ä¸ºç®€åŒ–æ¨¡å‹ï¼Œå¦‚æœéœ€è¦äº†è§£å­¦ä¹ å®Œæ•´çš„ç®—æ³•ï¼Œè¯·è‡ªè¡ŒæŸ¥é˜…ç»´åŸºç™¾ç§‘ç­‰ï¼Œæœ¬æ–‡æœ«å°¾é™„æœ‰å‚è€ƒèµ„æ–™é“¾æ¥ã€‚&lt;/strong>&lt;/p>
&lt;h2 id="æ‰©æ•£æ€è€ƒ">æ‰©æ•£æ€è€ƒ&lt;/h2>
&lt;ul>
&lt;li>å‰ç¼€è¡¨è¾¾å¼ä¹Ÿåº”è¯¥å…·å¤‡ç±»ä¼¼çš„ç‰¹ç‚¹ï¼Ÿ&lt;/li>
&lt;li>æ—¢ç„¶æ˜¯å«é€†æ³¢å…°è¡¨è¾¾å¼ï¼Œé‚£æ˜¯ä¸æ˜¯ä¹Ÿåº”è¯¥æœ‰æ³¢å…°è¡¨è¾¾å¼ï¼Ÿæˆ‘çŒœå°±æ˜¯å‰ç¼€è¡¨è¾¾å¼ï¼Ÿ&lt;/li>
&lt;li>ç»“åˆåç¼€è¡¨è¾¾å¼çš„æ±‚å€¼ç®—æ³•ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å¿«é€Ÿå¾—åˆ°å°†åç¼€è¡¨è¾¾å¼è¿˜åŸä¸ºä¸­ç¼€è¡¨è¾¾å¼çš„ç®—æ³•ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/%E9%80%86%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">é€†æ³¢å…°è¡¨è¾¾å¼&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/%E9%80%86%E6%B3%A2%E5%85%B0%E8%A1%A8%E7%A4%BA%E6%B3%95">è°ƒåº¦åœºç®—æ³•&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://juejin.cn/post/6844904094306402312">ç¼–è¯‘åŸç†-è¯æ³•åˆ†æ&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æŠ€æœ¯é¢è¯•å¦‚ä½•â€œè¯•â€</title><link>https://blog.hackerpie.com/posts/2021/interview-thinking/</link><pubDate>Sun, 07 Nov 2021 13:03:10 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2021/interview-thinking/</guid><description>&lt;p>æ¯•ä¸š7å¹´äº†ï¼Œç»å†è¿‡å¤šå®¶ä¸åŒå…¬å¸çš„é¢è¯•ï¼Œè¿™äº›å…¬å¸çš„é¢è¯•æ–¹å¼ä¸å°½ç›¸åŒï¼Œç»™æˆ‘çš„å–œæ¶ç¨‹åº¦ä¸ä¸€ï¼›åè¿‡æ¥ï¼Œè‡ªå·±ä½œä¸ºé¢è¯•å®˜ï¼Œå‰åä¹Ÿä¸ºå…¬å¸ç­›é€‰ç‰©è‰²äº†ä¸å°‘å€™é€‰äººï¼Œæˆ‘å¸Œæœ›æˆ‘æ‰€è®¤å¯çš„äººèƒ½åœ¨åç»­çš„å·¥ä½œè¡¨ç°ä¸­è¯æ˜æˆ‘æ²¡çœ‹é”™äººã€‚æˆ‘æ—¶ä¸æ—¶ä¼šæƒ³ï¼šåœ¨æŠ€æœ¯é¢è¯•ä¸­ï¼Œä»¥æ€æ ·çš„æ–¹å¼å¯¹å€™é€‰äººè¿›è¡Œè¯„ä¼°ç­›é€‰ï¼Œæ‰è¶³å¤Ÿé«˜æ•ˆç²¾å‡†ï¼Ÿä¸å¦¨å…ˆä»è‡ªå·±æ‰€ç»å†è¿‡çš„é¢è¯•å½¢å¼èŠèµ·å§ã€‚&lt;/p>
&lt;h2 id="æˆ‘æ‰€ç»å†è¿‡çš„å‡ ç±»é¢è¯•é£æ ¼">æˆ‘æ‰€ç»å†è¿‡çš„å‡ ç±»é¢è¯•é£æ ¼&lt;/h2>
&lt;p>ç»†æƒ³ä¸€è·¯èµ°æ¥ï¼Œæˆ‘æ‰€ç»å†è¿‡çš„é¢è¯•é£æ ¼å¤§è‡´åˆ†ä¸ºå‡ ç±»ï¼š&lt;/p>
&lt;ol>
&lt;li>å…¨å‡­ä¸€å¼ å˜´ï¼ŒåŒæ–¹ç›´æ¥èŠ&lt;/li>
&lt;li>å®¶åº­ä½œä¸šå‹&lt;/li>
&lt;li>ç†è®ºçŸ¥è¯†é—®ç­”&lt;/li>
&lt;li>ç®—æ³•èƒ½åŠ›è€ƒæŸ¥&lt;/li>
&lt;/ol>
&lt;h3 id="å…¨å‡­ä¸€å¼ å˜´åŒæ–¹ç›´æ¥èŠ">å…¨å‡­ä¸€å¼ å˜´ï¼ŒåŒæ–¹ç›´æ¥èŠ&lt;/h3>
&lt;p>è¿™ç§é¢è¯•é£æ ¼ï¼Œå­˜åœ¨äºæ—©æœŸçš„äº’è”ç½‘ä¼ä¸šé¢è¯•ä¸­ï¼Œè€Œæ®æˆ‘äº†è§£ï¼Œç›®å‰ä¸€äº›å°å…¬å¸ä¹Ÿä¼šé‡‡ç”¨è¿™ç§æ–¹å¼ã€‚å°±æˆ‘è‡ªå·±æ¥è¯´ï¼Œ15å¹´æˆ‘é¢è¯• 4399 ä»¥åŠå¤§ç–†çš„æ—¶å€™ï¼Œå‡æ˜¯é‡‡ç”¨çš„è¿™ç§é£æ ¼çš„é¢è¯•ã€‚&lt;/p>
&lt;p>é¢è¯•åŒæ–¹å°±ç®€å†ä¸Šçš„é¡¹ç›®å±•å¼€è®¨è®ºï¼Œäº†è§£å€™é€‰äººåœ¨é¡¹ç›®ä¸­çš„å…·ä½“å·¥ä½œå’Œæˆæœï¼Œä»¥åŠå€™é€‰äººåœ¨ç¼–ç¨‹ç´ å…»ç­‰æ–¹é¢çš„æ°´å¹³ã€‚è¿™ç§é¢è¯•æ–¹å¼ç®€å•å¿«é€Ÿï¼Œä½†æ˜¯æœ‰æ•ˆä¸å¦ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–å€™é€‰äººçš„è¡¨è¾¾èƒ½åŠ›ä»¥åŠé¢è¯•å®˜è‡ªèº«ç»éªŒèƒ½åŠ›æ°´å¹³ä»¥åŠå¯¹äººæ‰çš„åˆ¤æ–­èƒ½åŠ›ã€‚&lt;/p>
&lt;p>é‡‡ç”¨è¿™ç§é¢è¯•é£æ ¼çš„å…¬å¸ï¼Œå¤§æŠµæ˜¯ä¸€äº›å°å‹å…¬å¸æˆ–è€…åˆåˆ›å…¬å¸ï¼Œå› ä¸ºè¿™ç±»å…¬å¸ä¸€èˆ¬ç›¸å¯¹éš¾ä»¥å¸å¼•åˆ°æ‹¥æœ‰â€œä¼˜ç§€â€èƒŒæ™¯çš„äººæ‰å‰æ¥é¢è¯•ï¼Œé™¤éäº‹å‰åŒæ–¹éƒ½æ˜¯çŸ¥æ ¹çŸ¥åº•çš„ï¼Œäºæ˜¯å…¬å¸å¿…ç„¶ä¼šåœ¨äººæ‰æ‹›å‹Ÿä¸ŠåŠ¡å®ã€‚å¦‚æœæœ¬èº«å¸å¼•åˆ°çš„äººæ‰æ•°é‡æœ‰é™èƒŒæ™¯æœ‰é™ï¼Œå…¬å¸è‡ªå·±è¿˜å¹³æ·»å¾ˆå¤šç¹ççš„é¢è¯•ç¯èŠ‚æˆ–è€…æé«˜é€šè¿‡é—¨æ§›ï¼Œæœ€ç»ˆå¯èƒ½ä¸€ä¸ªäººéƒ½æ‹›ä¸åˆ°ã€‚æ‰€ä»¥ï¼Œå¼€é—¨è§å±±ï¼Œç›´å¥”ä¸»é¢˜ã€‚&lt;/p>
&lt;h3 id="å®¶åº­ä½œä¸šå‹">å®¶åº­ä½œä¸šå‹&lt;/h3>
&lt;p>è¿™ç§é¢è¯•å½¢å¼ï¼Œæ˜¯åœ¨ç®€å†é€šè¿‡ç­›é€‰åï¼Œé¢è¯•å®˜ç»™å€™é€‰äººå‘é€ä¸€ä»½å®¶åº­ä½œä¸šä¸€æ ·çš„é¡¹ç›®éœ€æ±‚ï¼Œæè¿°ä¸€ä¸ªæå°å‹é¡¹ç›®çš„è®¾è®¡è¦æ±‚ï¼Œç„¶åè®©å€™é€‰äººè‡ªå·±åœ¨ä¸šä½™æ—¶é—´å®Œæˆã€‚ä¹‹åçš„æŠ€æœ¯é¢è¯•åˆ™ä¸€æ–¹é¢ç»“åˆè¿™ä¸ªå°é¡¹ç›®è¿›è¡Œå®ç°æ€è·¯ä»¥åŠæ¶æ„è®¾è®¡äº¤æµï¼Œå¦ä¸€æ–¹é¢åˆ™é€šè¿‡è¿‡å¾€é¡¹ç›®ç»éªŒäº†è§£å€™é€‰äººçš„èƒ½åŠ›æ°´å¹³ã€‚æˆ‘åœ¨ 15 å¹´é¢è¯• ThoughtWorks ä»¥åŠ 20 å¹´é¢è¯• crypto.com å…¬å¸çš„æ—¶å€™ï¼Œéƒ½ä½“éªŒè¿‡è¿™ç§é¢è¯•å½¢å¼ï¼Œä¹Ÿæ˜¯æˆ‘ä¸ªäººæœ€ä¸ºå–œæ¬¢çš„å½¢å¼ã€‚è€Œæ ¹æ®æœ‹å‹çš„åˆ†äº«ï¼Œæˆ‘äº†è§£åˆ° AWS ä¸­å›½ä¹Ÿæ˜¯é‡‡ç”¨çš„æ­¤ç±»é¢è¯•å½¢å¼ã€‚&lt;/p>
&lt;p>æˆ‘ä¹‹æ‰€ä»¥å–œæ¬¢è¿™ç§é¢è¯•é£æ ¼ï¼Œä¸»è¦æ˜¯å› ä¸ºæ–¹å¼çµæ´»ä»¥åŠä»£ç æ›´å®¹æ˜“è®©æŠ€æœ¯é¢è¯•åŒæ–¹å»ºç«‹å…±åŒè¯­è¨€ã€‚çµæ´»æ€§æ–¹é¢ï¼Œå®ƒç»™æˆ‘è‡ªå·±å‘æŒ¥çš„ç©ºé—´æœ€å¤§ï¼Œæ¯”å¦‚æˆ‘æƒ³å‘é¢è¯•å®˜å±•ç°æˆ‘çš„å¼€å‘ä¹ æƒ¯ï¼Œæ¯”å¦‚å•å…ƒæµ‹è¯•å’Œä»£ç æ³¨é‡Šç­‰ï¼Œé‚£æˆ‘å°±ä¼šåœ¨è¿™ç§ä½œä¸šå‹é¡¹ç›®ä¸Šç”¨å¿ƒå®Œå–„å•æµ‹å’Œæ³¨é‡Šã€‚å…¶æ¬¡æˆ‘ä¹Ÿä¼šæ³¨æ„æ–‡æ¡£çš„ç¼–å†™å’Œæ³¨é‡Šï¼Œç‰¹åˆ«æ˜¯ä¸€ä»½å¸®åŠ©é¢è¯•å®˜æ–¹ä¾¿å¿«é€Ÿè¿è¡Œä½ çš„ä»£ç çš„ README æ–‡æ¡£ã€‚è¿™äº›ï¼Œéƒ½ä¸éœ€è¦åƒå…¶ä»–é¢è¯•ä¸€æ ·ä¸´åœºå‘æŒ¥ï¼Œæˆ‘åªéœ€è¦æ€è€ƒå¦‚ä½•å‡†å¤‡å¾—æ›´å¥½å°±è¡Œäº†ã€‚å¦ä¸€æ–¹é¢ï¼Œä»£ç æ˜¯æŠ€æœ¯äººä¹‹é—´çš„å…±åŒè¯­è¨€ï¼Œè¿™ç§æ–¹å¼æ‹‰è¿‘äº†æˆ‘å’Œé¢è¯•å®˜ä¹‹é—´çš„è·ç¦»ã€‚æ¯”å¦‚æˆ‘åœ¨å»å¹´é¢è¯• crypto.com çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘åœ¨äº¤å®Œä½œä¸šåˆ°å¼€å§‹æ­£å¼é¢è¯•ä¸­é—´çš„è¿™æ®µæ—¶é—´é‡Œï¼Œæˆ‘å’Œ crypto.com çš„é¢è¯•å®˜åœ¨å¾®ä¿¡ä¸Šå°±å·²ç»å¼€å§‹å°±ä»£ç é—®é¢˜è¿›è¡Œäº†å¤šæ¬¡è®¨è®ºã€‚åœ¨è¿™ç§éæ­£å¼çš„äº¤æµè¿‡ç¨‹ä¸­ï¼Œæˆ‘å¾—ä»¥ä¸€ç§æ¯”è¾ƒè½»æ¾è‡ªåœ¨çš„æ–¹å¼å»è¡¨è¾¾æˆ‘çš„æ€è€ƒï¼Œè€Œé¢è¯•å®˜ä¹Ÿåœ¨æ­¤è¿‡ç¨‹ä¸­å‘æˆ‘å±•ç¤ºäº†ä»–è‡ªèº«çš„æŠ€æœ¯æ°´å¹³ï¼Œè¿™ç§æ–¹å¼è®©æˆ‘æ„Ÿè§‰å°±æ˜¯åœ¨è¿›è¡Œå¦‚å¸¸çš„æŠ€æœ¯äº¤æµè€Œå·²ï¼Œä»¿ä½›æ˜¯åœ¨ä¸€ä¸ªåŒäº‹æˆ–è€…åŒè¡Œä¸€èµ·æ¢è®¨è€Œå·²ã€‚&lt;/p>
&lt;p>å°½ç®¡æˆ‘è‡ªå·±å–œæ¬¢è¿™ç§é¢è¯•é£æ ¼ï¼Œä½†æ˜¯èº«è¾¹è¿˜æ˜¯ä¼šæœ‰æœ‹å‹æˆ–è€…åŒäº‹å¹¶ä¸è®¤åŒè¿™ç§æ–¹å¼ï¼Œç”šè‡³è§‰å¾—æ¶å¿ƒã€‚ä¸»è¦åŸå› æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯è¿™ç§æ–¹å¼ä¼šæ›´å¤šåœ°å ç”¨å€™é€‰äººçš„ä¸šä½™æ—¶é—´ï¼ŒäºŒæ˜¯è¿™ç§æ–¹å¼å¯èƒ½ä¼šå­˜åœ¨å€™é€‰äººä½œå¼Šï¼Œç”±ä»–äººä»£ä¸ºå®Œæˆäº†ä½œä¸šã€‚åªä¸è¿‡æˆ‘çœŸè§‰å¾—è¿™ä¸¤å¯¹æˆ‘è€Œè¨€éƒ½ä¸æ˜¯é—®é¢˜ã€‚å‡å¦‚æˆ‘éœ€è¦è¿½æ±‚ä¸€ä¸ªæœªæ¥3-5å¹´é€‚åˆæˆ‘çš„å…¬å¸ï¼Œæˆ‘è§‰å¾—å……åˆ†çš„å‡†å¤‡ä»¥å®Œæ•´å±•ç°è‡ªå·±ï¼Œæ˜¯å€¼å¾—æŠ•å…¥æ—¶é—´çš„ã€‚è€Œç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘è§‰å¾—é…åˆé¢è¯•æµç¨‹ä¸­å¯¹ä½œä¸šä¸­çš„å®ç°ç»†èŠ‚ä»¥åŠæ¶æ„æ€è·¯ç­‰è¿›è¡Œè®¨è®ºï¼Œæ˜¯å¯ä»¥å¿«é€Ÿåˆ¤æ–­è¿™ä¸ªä»£ç æ˜¯ä¸æ˜¯å€™é€‰äººè‡ªå·±ç‹¬ç«‹å®Œæˆçš„ã€‚&lt;/p>
&lt;h3 id="ç†è®ºçŸ¥è¯†é—®ç­”">ç†è®ºçŸ¥è¯†é—®ç­”&lt;/h3>
&lt;p>è¿™ç§å°±æ˜¯å¤§å®¶å¸¸è¯´çš„â€œå…«è‚¡æ–‡â€äº†ï¼Œå°±æ˜¯é¢è¯•å®˜æŒ‰ç…§é¢˜åº“ç»™å‡ºæ•°æ®ç»“æ„ã€æ•°æ®åº“ã€è®¡ç®—æœºç½‘ç»œä»¥åŠç¼–ç¨‹è¯­è¨€ç­‰ç­‰ç§‘ç›®ç›¸å…³çš„åŸºç¡€çŸ¥è¯†é—®é¢˜ï¼Œç”±å€™é€‰äººåšå‡ºæ­£ç¡®çš„å›ç­”ã€‚å¤§å®¶å¸¸åæ§½çš„é¢˜ç›®æ¯”å¦‚çº¢é»‘æ ‘çš„åŸç†ã€MySQL innoDB å­˜å‚¨å¼•æ“çš„ç´¢å¼•è®¾è®¡ã€TCP ä¸‰æ¬¡æ¡æ‰‹/å››æ¬¡æŒ¥æ‰‹ä»¥åŠ Golang è¯­è¨€çš„ goroutine è°ƒåº¦åŸç†ç­‰ç­‰ã€‚è€Œç”±äºè¿™ç§é¢è¯•ç¯èŠ‚ä¸­çš„é¢˜ç›®è¿‡äºåŸºç¡€å’Œå®¢è§‚ï¼Œå¯¼è‡´å€™é€‰äººä¸å¾—ä¸åœ¨é¢è¯•ä¹‹å‰èŠ±è´¹å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›è¿›è¡Œå¤ä¹ ï¼Œä½†æ˜¯å…¥èŒååœ¨å·¥ä½œå²—ä½ä¸Šå´ç”±äºæ²¡æœ‰å®è·µæœºä¼šåå¿«é€Ÿé—å¿˜ï¼Œç•™ä¸‹äº†â€œé¢è¯•é€ ç«ç®­ï¼Œæ—¥å¸¸æ‹§èºä¸â€çš„è°ƒä¾ƒã€‚&lt;/p>
&lt;p>è‡³äºé‡‡ç”¨è¿™ç§é¢è¯•é£æ ¼çš„å…¬å¸ï¼Œçš†æ˜¯å„ç±»æ ¡æ‹›ç¤¾æ‹›äººæ‰çƒ­æ§çš„å¤§å…¬å¸ï¼Œæ¯”å¦‚å›½å†…çš„ BATï¼Œç¾å›¢å­—èŠ‚ä»¥åŠ Shopee ç­‰ç­‰ã€‚è¿™äº›å…¬å¸æ‰€æä¾›çš„è–ªèµ„æ°´å¹³åœ¨ä¸šç•Œå‡ºäºä¸­ä¸Šç”šè‡³å¤©èŠ±æ¿æ°´å¹³ï¼Œè‡ªç„¶æ¯å¹´éƒ½èƒ½å¤Ÿå¸å¼•åˆ°å¤§é‡ä¼˜ç§€äººæ‰å‰å¾€åº”è˜ã€‚&lt;/p>
&lt;p>æˆ‘è‡ªå·±åœ¨å»å¹´é¢è¯•è…¾è®¯å’Œå­—èŠ‚çš„ç»å†ä¸­ï¼Œä¸€è·¯æ‘¸çˆ¬æ»šæ‰“ï¼Œæ¯å¤©èµ·æ—©æ‘¸é»‘å¤ä¹ åŸºç¡€çŸ¥è¯†ï¼Œæˆ–è€…æ˜¯æ ¹æ®é¢è¯•è¿‡ç¨‹ä¸­æš´éœ²çš„è–„å¼±çŸ¥è¯†ç‚¹è¿›è¡Œå¼ºåŒ–å¤ä¹ ï¼Œæœ€ç»ˆæ‰ç»ˆäºé€šè¿‡è¿™äº›å…¬å¸çš„æŠ€æœ¯åŸºç¡€å…³ã€‚&lt;/p>
&lt;p>å°½ç®¡æˆ‘å¹¶ä¸å–œæ¬¢è¿™ç§æ–¹å¼ï¼Œä½†æ˜¯åœ¨ Shopee å…¬å¸æ‹…ä»»é¢è¯•å®˜çš„æ—¶å€™ï¼ŒæŒ‰ç…§éƒ¨é—¨ç»Ÿä¸€é¢è¯•è¦æ±‚ï¼Œæˆ‘è¿˜æ˜¯ä¸å¾—ä¸æœºæ¢°åœ°ä»é¢˜åº“ä¸­æŒ‘é€‰å„ä¸ªçŸ¥è¯†ç‚¹çš„é¢˜ç›®ï¼Œé€ä¸€å‘å€™é€‰äººæé—®ã€‚åœ¨ä¸€ä¸ªåŠå°æ—¶çš„æ—¶é—´é‡Œï¼Œæˆ‘éœ€è¦æŒ‰åºå®Œæˆå¯¹å€™é€‰äººé¡¹ç›®ç»éªŒã€ç¼–ç¨‹è¯­è¨€åŸºç¡€ã€æ•°æ®ç»“æ„ã€è®¡ç®—æœºç½‘ç»œã€æ•°æ®åº“ç†è®ºã€æ“ä½œç³»ç»ŸåŸç†ã€ç½‘ç»œå®‰å…¨çš„ç†è®ºçŸ¥è¯†è€ƒæŸ¥ï¼Œå¦å¤–è¿˜åŒ…å«ä¸€é“ä¸­ç­‰éš¾åº¦çš„ç¼–ç¨‹é¢˜ï¼Œå› ä¸ºé¢è¯•è¯„ä¼°é‡‡ç”¨å„ç¯èŠ‚å¾—åˆ†ç´¯åŠ çš„å½¢å¼ï¼Œæˆ‘æ— æ³•è·³è¿‡å…¶ä¸­æŸä¸€éƒ¨åˆ†ã€‚æˆ‘ä»…æœ‰çš„å‘æŒ¥ç©ºé—´ï¼Œå¤§æ¦‚å°±æ˜¯é¢è¯•å¼€åœºçš„é¡¹ç›®ç»éªŒäº¤æµä»¥åŠå¯¹å€™é€‰äººçš„å›ç­”å†³å®šæ˜¯å¦è¿½é—®äº†ã€‚&lt;/p>
&lt;p>è¿™ç§é¢è¯•å½¢å¼ï¼Œæ›´åƒæ˜¯ä¸€ç§åº”è¯•è€ƒæ ¸ï¼Œå°½ç®¡ä¸å¤Ÿä¸ªæ€§åŒ–ï¼Œä½†æ˜¯å´ä»ç„¶ä¸å¤±ä¸ºä¸€ç§ç­›é€‰äººæ‰çš„æ–¹å¼ã€‚å› ä¸ºæœ¬èº«è¿™ç±»çƒ­é—¨å…¬å¸å°±èƒ½å¤Ÿå¸å¼•åˆ°è¶…çº§å¤šä¼˜ç§€äººæ‰ï¼Œåœ¨ç®€å†ç­›é€‰ç¯èŠ‚ç•™ä¸‹æ¥çš„äººé€‰ï¼Œç»å¤§éƒ¨åˆ†äººåŸºç¡€éƒ½ä¸ä¼šå¤ªå·®ï¼ŒåŸºæœ¬ç´ å…»ä¹Ÿä¸è‡³äºå¤ªç³Ÿç³•ï¼Œè€Œå¤§å…¬å¸åœ¨å®ç°ä¸€ç§ç›ˆåˆ©æœºåˆ¶çš„ç¨³å®šä¹‹åï¼Œå¹¶ä¸éœ€è¦å¤ªå¤šé¢†å†›å‹äººæ‰ï¼Œæ›´å¤šæ˜¯éœ€è¦ä¸€äº›è¸å®å‹¤å¥‹çš„äººå»ä¿è¯è¿™å¥—æœºåˆ¶çš„è¿ä½œå¦‚å¸¸ï¼Œç”šè‡³å…è®¸éƒ¨åˆ†è›€è™«çš„å­˜åœ¨ã€‚åœ¨è¿™ç§èƒŒæ™¯ä¸‹ï¼Œå¤§å…¬å¸çš„é¢è¯•ç­›é€‰æœºåˆ¶ä¾¿å¯ä»¥ç›¸å¯¹ç®€å•ç²—æš´ï¼Œå…¬å¸åªéœ€è¦ç¡®ä¿æŒ‘é€‰å‡ºæ¥çš„äººåœ¨æŸä¸ªè§’åº¦å®¢è§‚ä¸Šæ¯”å…¶ä»–äººçªå‡ºå³å¯ã€‚å¤ä»£ç§‘ä¸¾è€ƒè¯•ä»¥åŠç°ä»£é«˜è€ƒæˆ–è€…å…¬åŠ¡å‘˜è€ƒè¯•åˆ¶åº¦ï¼Œå¤§è‡´å¦‚æ­¤ï¼Œè™½è¯´æ— æ³•æŒ–æ˜äººçš„ç‰¹é•¿æˆ–è€…ä¸ªæ€§ï¼Œä½†æ˜¯ç¡®å®å…¬å¹³ã€‚&lt;/p>
&lt;h3 id="ç®—æ³•èƒ½åŠ›è€ƒæŸ¥">ç®—æ³•èƒ½åŠ›è€ƒæŸ¥&lt;/h3>
&lt;p>é™¤å¼€ä¸Šé¢å‡ ç§ç±»å‹ï¼Œæˆ‘é‡åˆ°çš„è¿™ç§ç±»å‹ç‰¹ç‚¹æ˜¯é¢è¯•ç»ä¸å¯’æš„ï¼Œä¹Ÿä¸å¤šèŠç†è®ºï¼Œç®€å•è‡ªæˆ‘ä»‹ç»åï¼Œé¢è¯•å®˜ç›´æ¥ç»™å‡ºç®—æ³•é¢˜ç›®ï¼Œè¦æ±‚ç›´æ¥å®Œæˆç®—æ³•é¢˜å®ç°ã€‚å»å¹´åœ¨ flexport å…¬å¸å°±æ˜¯è¿™ç§é¢è¯•å½¢å¼ï¼Œå½“ç„¶ï¼Œæˆ‘æ²¡æœ‰é€šè¿‡ã€‚è€Œä¼—æ‰€å‘¨çŸ¥ï¼Œè°·æ­Œã€å¾®è½¯ã€å­—èŠ‚è·³åŠ¨ã€pony.ai ç­‰å…¬å¸éƒ½æ˜¯æ¯”è¾ƒé‡è§†ç®—æ³•èƒ½åŠ›çš„ï¼Œå¦‚æœå€™é€‰äººæƒ³è¦è¿½æ±‚è¿™ç±»å…¬å¸çš„å²—ä½æœºä¼šï¼Œç®—æ³•èƒ½åŠ›å¤ªå·®æ˜¯æ³¨å®šä¸è¡Œçš„ã€‚è€Œä»Šå¹´åœ¨å’Œä¸€ä¸ªæµ·å½’çš„æœ‹å‹èŠçš„æ—¶å€™ï¼Œä»–ä¹ŸèŠåˆ°ç¾ä¼æ™®éé‡è§†ç®—æ³•èƒ½åŠ›ï¼Œæ‰€ä»¥é¢è¯•å¤šæ˜¯ç®€å•ç²—æš´çš„å¤šé“ç®—æ³•é¢˜ã€‚è¿™å°±è®©äººå¿ä¸ä½åˆå¾—æä¸€ä¸‹ Homebrew ä½œè€… Max Howell å› ä¸ºæ²¡æœ‰å®Œæˆç¿»è½¬äºŒå‰æ ‘çš„ç®—æ³•é¢˜è€Œæ²¡æœ‰é€šè¿‡è°·æ­Œé¢è¯•çš„æ•…äº‹ã€‚&lt;/p>
&lt;p>å°½ç®¡å¥½çš„ç®—æ³•å¯¹äºè½¯ä»¶è®¾è®¡æ¥è¯´ç¡®å®å¯ä»¥é™æœ¬å¢æ•ˆï¼Œä½†æ˜¯å¯¹äºå¤§éƒ¨åˆ†å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œæ›´å¤šæ—¶å€™ä»–ä»¬éœ€è¦å®Œæˆçš„æ˜¯å¦‚ä½•é€šè¿‡æŠ€æœ¯æ–¹æ¡ˆçš„ç»„åˆæ¥ç»™å‡ºä¸€ä¸ªå•†ä¸šäº§å“çš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä¹Ÿè®©æˆ‘æƒ³èµ·18å¹´åº•çš„æ—¶å€™ï¼Œä¸€ä¸ªåˆšå…¥èŒå¾®è½¯åŠå¹´å·¦å³çš„æœ‹å‹ï¼Œé€šè¿‡çŒå¤´æ‰¾åˆ°æˆ‘ï¼Œå¸Œæœ›è·Ÿæˆ‘äº†è§£ Shopee çš„å·¥ä½œæƒ…å†µï¼Œä»–æ­£åœ¨è€ƒè™‘è·³æ§½ Shopeeã€‚å› ä¸ºä»–è§‰å¾—å…¥èŒå¾®è½¯ä¹‹åå¤§å¤±æ‰€æœ›ï¼Œå°½ç®¡ä»–å‡†å¤‡å¾®è½¯çš„é¢è¯•ä¸ŠèŠ±äº†å¾ˆå¤§åŠ›æ°”ï¼Œå¾®è½¯åœ¨ä»–çš„æƒ³è±¡é‡Œï¼Œä¸€ç›´æ˜¯ä¸ªé«˜æ•ˆä¸“ä¸šçš„å…¬å¸ï¼Œä½†æ˜¯å®é™…ä»–å½“æ—¶æ‰€åœ¨çš„å›¢é˜Ÿæ‰€ç»´æŠ¤çš„ä»£ç ï¼Œå®åœ¨éš¾ä»¥æ­ç»´ï¼Œè€Œä¸”å¾ˆå¤šæ‰€å­¦æ¯«æ— ç”¨æ­¦ä¹‹åœ°ã€‚&lt;/p>
&lt;h3 id="å°ç»“">å°ç»“&lt;/h3>
&lt;p>è¿™é‡Œæˆ‘ä»¬å…ˆæ±‡æ€»å¯¹æ¯”ä¸‹å‡ ç§é¢è¯•é£æ ¼ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>å½¢å¼&lt;/th>
&lt;th>å½¢å¼ç®€è¿°&lt;/th>
&lt;th>ä¸¾ä¾‹å…¬å¸&lt;/th>
&lt;th>å¥½å¤„&lt;/th>
&lt;th>ä¸è¶³&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>çº¯å£å¤´äº¤æµ&lt;/td>
&lt;td>å…¨ç¨‹å£å¤´æ²Ÿé€šï¼Œäº¤æµæŠ€æœ¯æƒ³æ³•ç­‰&lt;/td>
&lt;td>æ—©æœŸçš„å¤§ç–†ã€4399&lt;/td>
&lt;td>ç®€å•å¿«é€Ÿï¼Œæˆæœ¬ä½&lt;/td>
&lt;td>é‡åº¦ä¾èµ–å€™é€‰äººè¡¨è¾¾èƒ½åŠ›ä»¥åŠé¢è¯•å®˜æ…§çœ¼è¯†äººèƒ½åŠ›&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å®¶åº­ä½œä¸šå‹&lt;/td>
&lt;td>é¢è¯•å‰å®Œæˆä½œä¸šï¼Œé¢è¯•ä¸­äº¤æµä½œä¸šå®ç°æ€è·¯ç­‰&lt;/td>
&lt;td>thoughtworksã€crypto.comã€AWS&lt;/td>
&lt;td>ç»™å€™é€‰äººæ›´å¤šå‘æŒ¥ç©ºé—´ï¼Œèƒ½æ›´çœŸå®è€ƒæŸ¥å€™é€‰äººçš„ç¼–ç ä¹ æƒ¯å’Œè§„èŒƒç­‰&lt;/td>
&lt;td>åŠ å¤§ä¸šä½™æ—¶é—´æˆæœ¬ï¼Œéœ€è¦é¿å…å€™é€‰äººä½œå¼Šï¼Œéš¾ä»¥é€šè¿‡ä½œä¸šè€ƒæŸ¥å¤æ‚æ¶æ„èƒ½åŠ›&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ç†è®ºçŸ¥è¯†é—®ç­”&lt;/td>
&lt;td>ç»“æ„åŒ–é¢è¯•ï¼Œä¸€é—®ä¸€ç­”ï¼Œå®¢è§‚é—®é¢˜ä½œç­”&lt;/td>
&lt;td>è…¾è®¯ã€å­—èŠ‚è·³åŠ¨&lt;/td>
&lt;td>ç®€å•ç²—æš´ã€ç›¸å¯¹å…¬å¹³&lt;/td>
&lt;td>ç›¸å¯¹æ­»æ¿ï¼Œå¯èƒ½é”™è¿‡é«˜æ½œäººæ‰&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ç®—æ³•èƒ½åŠ›è€ƒæŸ¥&lt;/td>
&lt;td>ç›´æ¥å®Œæˆç®—æ³•ç¼–å†™ï¼Œæ¯è½®é¢è¯•ä»¥ç¼–å†™ç®—æ³•ä»£ç ä¸ºä¸»&lt;/td>
&lt;td>å¾®è½¯ã€flexport&lt;/td>
&lt;td>ç›¸å¯¹å…¬å¹³&lt;/td>
&lt;td>ç›¸å¯¹æ­»æ¿ï¼Œå¯èƒ½é”™è¿‡é«˜æ½œäººæ‰&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="é¢è¯•æ–¹å¼ä¸ä½“éªŒ">é¢è¯•æ–¹å¼ä¸ä½“éªŒ&lt;/h2>
&lt;p>è¿™é‡Œæƒ³æ’å…¥è¯´ä¸€å£°çš„æ˜¯ï¼Œé¢è¯•æ˜¯å…¬å¸å½¢è±¡å®£ä¼ çš„ç¬¬ä¸€ç«™ï¼Œå¥½çš„é¢è¯•ä½“éªŒå¸¦ç»™å€™é€‰äººå¥½çš„å°è±¡ï¼Œç”šè‡³å¯ä»¥æˆä¸ºå£ç¢‘ä¼ æ’­çš„åŸºç¡€ï¼Œæ‰€ä»¥å¯¹äºé¢è¯•å½¢å¼çš„é€‰æ‹©ï¼Œé™¤äº†æ•ˆç‡ï¼Œè¿˜è¦è€ƒè™‘å€™é€‰äººçš„ä½“éªŒã€‚å°±æˆ‘è‡ªå·±è€Œè¨€ï¼Œç”±äºæˆ‘éå¸¸å–œæ¬¢å®¶åº­ä½œä¸šå‹çš„é¢è¯•é£æ ¼ï¼Œæˆ‘ä¸ªäººä¹Ÿæ„Ÿè§‰åœ¨è¿™ç±»é¢è¯•ä¸­ï¼Œæˆ‘çš„è¡¨ç°æ˜¯æœ€å¥½çš„ã€‚å°½ç®¡ç”±äºå®¢è§‚åŸå› ï¼Œæˆ‘éƒ½æ²¡æœ‰å»æˆè¿™äº›å…¬å¸ï¼Œä½†æ˜¯æˆ‘è‡³ä»Šä»å¯¹è¿™äº›å…¬å¸å­˜æœ‰å¥½æ„Ÿï¼Œä»¥è‡³äºåœ¨é¢è¯•åçš„å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œæˆ‘éƒ½ä¼šæŒç»­åœ°å‘èº«è¾¹æ‰¾å·¥ä½œçš„æœ‹å‹å®‰åˆ©è¿™ç±»å…¬å¸ã€‚æˆ‘çš„é€»è¾‘å¾ˆç®€å•ï¼šèƒ½ç»™å€™é€‰äººå‘æŒ¥ç©ºé—´çš„å…¬å¸ï¼Œç›¸ä¿¡åœ¨å…¬å¸å†…éƒ¨ï¼Œæ–‡åŒ–ä¹Ÿä¼šç›¸å¯¹æ›´å¼€æ”¾ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æ˜¯20å¹´åº•åˆ°ç°åœ¨æ‰¾æˆ‘æ¨èå…¬å¸çš„æœ‹å‹ï¼Œå¾ˆå¤§æ¦‚ç‡éƒ½ä¼šå¬æˆ‘æåˆ° crypto.comã€‚&lt;/p>
&lt;h2 id="æŠ€æœ¯é¢è¯•ä½•å»ä½•ä»">æŠ€æœ¯é¢è¯•ä½•å»ä½•ä»ï¼Ÿ&lt;/h2>
&lt;p>çºµè§‚å½“ä¸‹çš„æŠ€æœ¯é¢è¯•è¯„ä¼°æ–¹å¼ï¼Œå„æœ‰å„çš„é€‚ç”¨æ–¹å¼ï¼Œå³æ‰€è°“å­˜åœ¨å³åˆç†ã€‚å°å…¬å¸å¸å¼•åŠ›æœ‰é™ï¼Œä¸å¾—ä¸ç›´å¥”ä¸»é¢˜ï¼Œå¤§å…¬å¸æ€»ä½“ä¾›å¤§äºæ±‚ï¼Œå¯ä»¥ä»»æ€§é‡‡ç”¨å®¢è§‚è€ƒé¢˜ç­‰ç­‰ã€‚ä½†æ˜¯åˆç†ä¹‹ä½™ï¼Œæ˜¯å¦å¯ä»¥æ›´é«˜æ•ˆï¼Ÿ&lt;/p>
&lt;p>ä¸å¦¨å›å½’åˆ°é¢è¯•æœ¬èº«çš„ä¾›éœ€åŒæ–¹ï¼Œä½œä¸ºå€™é€‰äººï¼Œ&lt;strong>æˆ‘å¸Œæœ›é¢è¯•ä¸è¦æ˜¯ä¸€ç§å†…å·çš„å½¢å¼ï¼Œæˆ‘éœ€è¦å±•ç°çš„æ˜¯æˆ‘æ—¥å¸¸å·¥ä½œçš„çœŸå®èƒ½åŠ›æ°´å¹³ä»¥åŠæˆ‘æ‰€ç§¯ç´¯çš„ç»éªŒç­‰ç­‰&lt;/strong>ï¼›è€Œä½œä¸ºé›‡ä¸»ï¼Œé¦–å…ˆéœ€è¦&lt;strong>æƒ³æ˜ç™½åˆ°åº•è‡ªå·±éœ€è¦çš„æ˜¯æ€æ ·çš„äººæ‰ï¼Œå…¶æ¬¡åœ¨ä¿è¯å€™é€‰äººçœŸå®å±•ç°ä»–çš„èƒ½åŠ›æ°´å¹³ä¹‹åï¼Œæˆ‘å¯ä»¥å¿«é€Ÿè¯„ä¼°æˆ‘çš„å²—ä½éœ€æ±‚ä¸ä»–çš„èƒ½åŠ›æ°´å¹³æ˜¯å¦è¶³å¤Ÿå¥‘åˆ&lt;/strong>ï¼Œå¦‚æœä¸å¤Ÿï¼Œä»–æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ½œåŠ›åœ¨ä¸ä¹…çš„å°†æ¥èƒœä»»è¿™ä¸ªå·¥ä½œï¼Ÿè¡Œä¸šå’Œä¸–ç•ŒæŒç»­æ¼”å˜ï¼Œç›®å‰æŠ€æœ¯é¢è¯•è¯„ä¼°çš„å½¢å¼ä¸ä¼šæ˜¯ç»ˆç‚¹ï¼Œä½†æ˜¯å®ƒä¼šå¾€å“ªå»å‘¢ï¼Ÿå¦å¤–è€ƒè™‘åˆ°ç¨‹åºå‘˜è¡Œä¸šäººæ‰çš„æŒç»­é¥±å’Œä»¥åŠå›½å†…çš„ä¸šåŠ¡å‘å±•è¿›å…¥ä¸€ä¸ªå­˜é‡å¸‚åœºçš„è§’é€ï¼Œè¿˜æœ‰æœ€è¿‘å±¡å±¡ä¼ é—»çš„å¤§å‚å–æ¶ˆ 996 ç”šè‡³æ¨è¡Œ 1075 å·¥ä½œåˆ¶çš„æ–°é—»ï¼Œæœªæ¥ä¸€å®šæ˜¯ä¸€ä¸ªå„ä¸ªä¼ä¸šç²¾æ‰“ç»†ç®—è¿‡æ—¥å­çš„ä¸–ç•Œï¼Œæœªæ¥æ˜¯ä¸€ä¸ªè¿½æ±‚é«˜æ•ˆçš„å¸‚åœºã€‚é‚£ä¹ˆæ‰€è°“é«˜æ•ˆæ„å‘³ç€ä»€ä¹ˆï¼Ÿ&lt;/p>
&lt;h3 id="ç†æƒ³çš„é«˜æ•ˆ">ç†æƒ³çš„â€œé«˜æ•ˆâ€&lt;/h3>
&lt;p>å€™é€‰äººä¸€æ–¹çš„é«˜æ•ˆï¼Œæ˜¯ä¸éœ€è¦åœ¨é¢è¯•ä¹‹å‰é¢å¤–èŠ±è´¹å¤§é‡çš„æ—¶é—´å’Œç²¾åŠ›å»åˆ»æ„å­¦ä¹ ä¸€äº›ä¸æ—¥å¸¸å·¥ä½œå…³ç³»ä¸å¤§çš„ä¸œè¥¿ï¼Œè€Œæ˜¯èƒ½å¤Ÿæœ‰ä¸€ç§æ–¹å¼æ”¯æŒå€™é€‰äººå°†æ—¥å¸¸å·¥ä½œä¸­çš„ç§¯ç´¯è½¬æ¢ä¸ºä¸€ç§çœ‹å¾—è§çš„çœŸå®çš„å¯è€ƒæŸ¥çš„å½¢å¼ã€‚æˆ–è®¸æˆ‘ä»¬å¯ä»¥å¯¹å€™é€‰äººåœ¨å…¨ç½‘å£°èª‰ï¼ˆåšå®¢ã€å¼€æºä»£ç ç­‰ï¼‰è¿›è¡Œä¸€ç§é‡åŒ–è¯„ä¼°ï¼Œä¹Ÿå¯èƒ½ç»™å€™é€‰äººæä¾›ä¸€ä¸ªç²¾å‡†çš„ä¸ªæ€§åŒ–é—®é¢˜ï¼Œè®©å€™é€‰äººå¯ä»¥åœ¨é¢è¯•è¿‡ç¨‹ä¸­éšæœºåº”å˜è¿ç”¨è‡ªèº«ç§¯ç´¯å¯¹é—®é¢˜æ±‚è§£å®ç°ã€‚&lt;/p>
&lt;p>åœ¨é›‡ä¸»ä¸€æ–¹çš„é«˜æ•ˆï¼Œæ˜¯å¸Œæœ›å°½å¯èƒ½è¿˜åŸçœŸå®çš„å€™é€‰äººçš„å½¢è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸´æ—¶æŠ±ä½›è„šæ‰€ä¿®é¥°å‡ºæ¥çš„å½¢è±¡ï¼Œä»¥ä¾¿å®¢è§‚åœ°å°†å€™é€‰äººä¸è‡ªèº«ä¸šåŠ¡æ‰€éœ€äººæ‰çš„ç‰¹å¾è¿›è¡Œå¥‘åˆåº¦è¯„ä¼°ï¼Œä»¥æ±‚é€šè¿‡é¢è¯•çš„äººæ‰èƒ½å¤Ÿèƒœä»»å·¥ä½œå¹¶ä¸”å’Œå›¢é˜Ÿä¸€èµ·èµ°å¾—æ›´è¿œã€‚æ›´é•¿è¿œçœ‹ï¼Œé›‡ä¸»è‚¯å®šå¸Œæœ›æ‹›å‹Ÿåˆ°å‡ºæ´»æ›´å¥½æ›´å¿«çš„äººæ‰ï¼Œç§°æ‰‹é«˜æ•ˆçš„æŠ€æœ¯è¯„ä¼°æ‰‹æ®µå¿…ç„¶æ˜¯å…³é”®ä¸€ç¯ã€‚æœ€ç†æƒ³çš„é¢è¯•ï¼Œè‡ªç„¶æ˜¯å®Œæ•´è¿˜åŸå·¥ä½œåœºæ™¯ï¼Œè®©å€™é€‰äººä»£å…¥åˆ°å…¶ä¸­ã€‚æ¯”å¦‚å›¢é˜Ÿå‘å€™é€‰äººç›´æ¥å‘ˆç°è‡ªå·±æ‰€æ›¾ç»æˆ–è€…ç°åœ¨é¢å¯¹çš„é—®é¢˜æˆ–è€…æŒ‘æˆ˜ï¼Œè¿›è€Œè§‚å¯Ÿå€™é€‰äººåœ¨é—®é¢˜æˆ–è€…æŒ‘æˆ˜é¢å‰æ‰€é‡‡å–çš„è§£å†³é—®é¢˜çš„æ€è·¯å’Œæ‰€åšçš„å°è¯•ç­‰ç­‰ã€‚ä½†æ˜¯ç¢äºå¾ˆå¤šå¹²æ‰°å› ç´ ï¼Œæ¯”å¦‚æŠ€æœ¯é€‰å‹ã€å•†ä¸šæœºå¯†æ€§ç­‰ç­‰ï¼Œæˆ‘ä»¬å®é™…ä¸Šè¿˜æ˜¯éœ€è¦å±è”½æ‰å¾ˆå¤šæ— å…³ä¿¡æ¯ï¼Œç›´å‡»è¦å®³ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¿…ç„¶è¦å¯¹æ¯ä¸ªé—®é¢˜è¿›è¡ŒæŠ½è±¡ï¼Œå†ç”±å€™é€‰äººå°è¯•åšå‡ºè§£ç­”ã€‚&lt;/p>
&lt;p>è®¾æƒ³è¿™æ ·çš„æœªæ¥ï¼šå€™é€‰äººæ²¡å¿…è¦åˆ»æ„åˆ·é¢˜ï¼Œä¹Ÿæ²¡å¾—åˆ·ï¼Œéšæ—¶éƒ½å¯ä»¥åœ¨é¢è¯•ä¸­æ·‹æ¼“å°½è‡´åœ°å±•ç°çœŸå®çš„è‡ªå·±ï¼Œå°†æ›´å¤šçš„ä¸šä½™æ—¶é—´ç•™ç»™çœŸæ­£éœ€è¦è‡ªæˆ‘æå‡çš„åœ°æ–¹ï¼›è€Œä¼ä¸šå¯ä»¥æœ‰æ›´é«˜æ•ˆçš„æ–¹å¼ç­›é€‰å€™é€‰äººï¼Œé¢è¯•å®˜ä¸å†æ˜¯ä¸€ä¸ªæ²¡æœ‰æ„Ÿæƒ…çš„æé—®æœºå™¨ã€‚è¿™ä¸ªæœªæ¥æ‰€éœ€è¦çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä¹Ÿè¿˜æ²¡æœ‰ç­”æ¡ˆï¼Œä¹Ÿæ²¡æœ‰åœ¨å¸‚é¢ä¸Šæ‰¾åˆ°ç­”æ¡ˆï¼Œä½†æ˜¯æˆ–è®¸ï¼Œä¼šæ˜¯ä¸‹ä¸€ä¸ªæœºä¼šã€‚&lt;/p>
&lt;p>è€Œæœ€åï¼Œè¿™çœŸçš„æ˜¯äººæ€§æ·±å¤„çš„éœ€è¦å—ï¼Ÿè¦æ˜¯ï¼Œä¸ç®¡å·¥å…·å¤šå®Œç¾ï¼Œäººæœ€ç»ˆçš„å½’å®¿æ˜¯æƒ³ç€åŠæ³•å·èµ·æ¥å‘¢ï¼Ÿ&lt;/p></description></item><item><title>éƒ¨åˆ†åº”ç”¨ä¸æŸ¯ç†åŒ–</title><link>https://blog.hackerpie.com/posts/programming-paradigm/partial-application-and-currying/</link><pubDate>Sun, 15 Aug 2021 21:18:18 +0800</pubDate><guid>https://blog.hackerpie.com/posts/programming-paradigm/partial-application-and-currying/</guid><description>&lt;p>åœ¨æœ€è¿‘å­¦ä¹ å‡½æ•°å¼ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œåå¤æ¥è§¦åˆ°çš„å°±æ˜¯â€œæŸ¯ç†åŒ–â€è¿™ä¸ªæ¦‚å¿µï¼Œç‰¹åˆ«æ•°å­¦èŒƒæœ‰æ²¡æœ‰ï¼Ÿè™½ç„¶çœ‹è¿‡å¤šæ¬¡ï¼Œä½†æ˜¯ä¸€ç›´ä¸æ˜¯å¾ˆå¥½åœ°ç†è§£å®ƒï¼Œæ°é€¢ä»Šå¤©åœ¨é˜…è¯»ã€ŠScala å‡½æ•°å¼ç¼–ç¨‹ã€‹è¿™æœ¬ä¹¦çš„è¿‡ç¨‹ä¸­åŠ æ·±äº†ç†è§£ï¼Œä¾¿å†™ä¸ªæ–‡ç« ï¼Œæ€»ç»“ä¸€ä¸‹ã€‚&lt;/p>
&lt;h2 id="æŸ¯ç†åŒ–">æŸ¯ç†åŒ–&lt;/h2>
&lt;p>æŸ¯ç†åŒ–ï¼Œè‹±æ–‡å«â€œCurryingâ€ï¼Œå‘½åæºè‡ªé€»è¾‘å­¦å®¶ Haskell Curry çš„åå­—ã€‚åœ¨æ•°å­¦å’Œç¼–ç¨‹é¢†åŸŸï¼Œ&lt;strong>æŸ¯ç†åŒ–&lt;/strong>ç”¨äºå°†ä¸€ä¸ªæ¥æ”¶å¤šä¸ªå‚æ•°çš„å‡½æ•°è½¬æ¢ä¸ºä¸€ç³»åˆ—åªæ¥æ”¶å•ä¸ªè¾“å…¥å‚æ•°çš„å‡½æ•°ã€‚æ¯”å¦‚ï¼Œå°†ä¸€ä¸ªæ¥æ”¶ä¸‰ä¸ªå‚æ•°çš„å‡½æ•° &lt;code>f&lt;/code> è¿›è¡ŒæŸ¯ç†åŒ–ï¼Œä¼šå¾—åˆ°ä¸‰ä¸ªæ–°çš„å‡½æ•°ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>x = f(a, b, c) å˜ä¸ºï¼š
h = g(a)
i = h(b)
x = i(c)
æˆ–è€…ä½¿ç”¨åŒ¿åå‡½æ•°æŒ‰åºè°ƒç”¨çš„å½¢å¼ï¼Œåˆ™ä¸ºï¼š
x = g(a)(b)(c)
&lt;/code>&lt;/pre>&lt;p>è¿™æ ·è®²æˆ–è®¸ä»æœ‰ç‚¹ä¸å¥½ç†è§£ï¼Œæˆ‘ä»¬ç”¨ä¸ªæ•°å­¦å‡½æ•°çš„ä¾‹å­æ¥åˆ†è§£ã€‚å‡å¦‚æˆ‘ä»¬æœ‰å‡½æ•° &lt;code>f(a, b, c) = aÂ² + b - c&lt;/code>ï¼Œå¹¶ä¸”æœ‰ &lt;code>a = 2&lt;/code>ã€&lt;code>b = 3&lt;/code>ã€&lt;code>c = 1&lt;/code>ï¼Œåˆ™ä¸€èˆ¬æ•°å­¦æ±‚è§£è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°† aã€bã€c çš„å€¼å¯¹åº”ä»£å…¥å‡½æ•°å³ä¾§å¼å­ï¼Œå¾—åˆ° &lt;code>2Â² + 3 - 1 = 6&lt;/code>ï¼Œäºæ˜¯æˆ‘ä»¬çŸ¥é“ &lt;code>f(2, 3, 1) = 6&lt;/code>ã€‚è¿™ä¸ªè¿‡ç¨‹å¾ˆç›´è§‚å¾ˆå¥½ç†è§£ï¼Œä¹Ÿå¾ˆäº²åˆ‡å¯¹ä¸å¯¹ï¼Ÿ&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå‡å¦‚æˆ‘ä»¬è¦æ±‚æ¯æ¬¡åªèƒ½ä»£å…¥å‡½æ•°çš„ä¸€ä¸ªè¾“å…¥å€¼ï¼Œä¼šæ˜¯æ€æ ·çš„è¿‡ç¨‹å‘¢ï¼Ÿ&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬ä»£å…¥ &lt;code>a = 2&lt;/code>ï¼Œæˆ‘ä»¬å°†å¾—åˆ° &lt;code>f(2, b, c) = 2Â² + b - c&lt;/code>ï¼Œæˆ‘ä»¬å¯ä»¥è®° &lt;code>g(b, c) = f(2, b, c) = 4 + b - c&lt;/code>ï¼›&lt;/li>
&lt;li>ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬ä»£å…¥ &lt;code>b = 3&lt;/code>ï¼Œæˆ‘ä»¬å¾—åˆ° &lt;code>g(3, c) = 4 + 3 - c&lt;/code>ï¼Œæˆ‘ä»¬å¯ä»¥è®° &lt;code>h(c) = g(3, c) = 7 - c&lt;/code>ï¼›&lt;/li>
&lt;li>æœ€åä¸€æ­¥ï¼Œæˆ‘ä»¬ä»£å…¥ &lt;code>c = 1&lt;/code>ï¼Œæˆ‘ä»¬å¾—åˆ° &lt;code>h(1) = 7 - 1 = 6&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸Šè¿°çš„è¿‡ç¨‹ï¼Œå‘æˆ‘ä»¬å±•ç¤ºäº†æˆ‘ä»¬æ˜¯å¦‚ä½•é€šè¿‡æ¯æ¬¡ä»£å…¥ä¸€ä¸ªè¾“å…¥å€¼è€Œå¾—åˆ°ä¸€ä¸ªè¾“å…¥å€¼æ•°é‡å‡ 1 çš„æ–°å‡½æ•°ã€‚&lt;/p>
&lt;ul>
&lt;li>ç¬¬ä¸€æ­¥ï¼Œ&lt;code>a&lt;/code> åœ¨ &lt;code>f(a, b, c)&lt;/code> ä¸Šçš„ä»£å…¥å¾—åˆ°äº† &lt;code>g(b, c)&lt;/code>ï¼›&lt;/li>
&lt;li>ç¬¬äºŒæ­¥ï¼Œ&lt;code>b&lt;/code> åœ¨ &lt;code>g(b, c)&lt;/code> ä¸Šçš„ä»£å…¥å¾—åˆ°äº† &lt;code>h(c)&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿›ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ç»„æ–°çš„å‡½æ•°ï¼š&lt;/p>
&lt;ul>
&lt;li>å¯¹åº”ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°å‡½æ•° &lt;code>F(a)&lt;/code>ï¼Œç”±äºå¯¹ &lt;code>a&lt;/code> çš„ä»£å…¥å¾—åˆ°äº† &lt;code>g(b, c)&lt;/code>ï¼Œäºæ˜¯ &lt;code>F(a) = g(b, c)&lt;/code>ï¼Œå³ &lt;code>F(a)&lt;/code> æ˜¯ä¸€ä¸ªè¾“å…¥ä¸º &lt;code>a&lt;/code>ï¼Œè¾“å‡ºä¸ºå‡½æ•° &lt;code>g(b, c)&lt;/code> çš„å‡½æ•°ï¼›&lt;/li>
&lt;li>å¯¹åº”ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°å‡½æ•° &lt;code>G(b)&lt;/code>ï¼Œç”±äºå¯¹ &lt;code>b&lt;/code> çš„ä»£å…¥å¾—åˆ°äº† &lt;code>h(c)&lt;/code>ï¼Œäºæ˜¯ &lt;code>G(b) = h(c)&lt;/code>ï¼Œå³ &lt;code>G(b)&lt;/code> æ˜¯ä¸€ä¸ªè¾“å…¥ä¸º &lt;code>b&lt;/code>ï¼Œè¾“å‡ºä¸ºå‡½æ•° &lt;code>h(c)&lt;/code> çš„å‡½æ•°ï¼›&lt;/li>
&lt;li>å¯¹åº”ç¬¬ä¸‰æ­¥ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–°å‡½æ•° &lt;code>H(c)&lt;/code>ï¼Œç”±äºå¯¹ &lt;code>c&lt;/code> çš„ä»£å…¥å¾—åˆ°äº†æœ€ç»ˆå¼å­ï¼Œè¿™é‡Œå¯ä»¥æš‚æ—¶è®°ä¸º &lt;code>H(c) =&amp;gt; R&lt;/code>ï¼ŒR è¡¨ç¤ºå®æ•°é›†åˆã€‚&lt;/li>
&lt;li>ä»¥ä¸Šä¸‰æ­¥ï¼Œç»“åˆåˆ°ä¸€èµ·ï¼Œå°±æœ‰ &lt;code>f(a, b, c) = F(a)(b)(c)&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿™æ ·å¾ªç¯é€šè¿‡æ¯æ¬¡åªä»£å…¥ä¸€ä¸ªè¾“å…¥å€¼æœ€åå¾—åˆ°ä¸€ç»„æ¯ä¸ªå‡½æ•°éƒ½åªæœ‰ä¸€ä¸ªè¾“å…¥å€¼çš„æ–°å‡½æ•°çš„è¿‡ç¨‹ï¼Œå°±å«&lt;strong>æŸ¯ç†åŒ–&lt;/strong>ï¼Œè€Œ &lt;code>F(a)&lt;/code>ã€&lt;code>G(b)&lt;/code>ä»¥åŠ &lt;code>H(c)&lt;/code> å°±æ˜¯æˆ‘ä»¬åœ¨&lt;strong>æŸ¯ç†åŒ–&lt;/strong>è¿‡ç¨‹ä¸­é—´å¾—åˆ°çš„ä¸­é—´å‡½æ•°ã€‚&lt;/p>
&lt;h2 id="éƒ¨åˆ†åº”ç”¨">éƒ¨åˆ†åº”ç”¨&lt;/h2>
&lt;p>ä»ä¸Šé¢çš„åˆ†è§£è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œä¸æˆ‘ä»¬ä¹ ä»¥ä¸ºå¸¸çš„ç›´æ¥å°† &lt;code>a, b, c&lt;/code> çš„å€¼å…¨éƒ¨ä»£å…¥åˆ°å¼å­ä¸­ä¸åŒï¼Œæˆ‘ä»¬åœ¨æŸ¯ç†åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡åªä»£å…¥ä¸€ä¸ªè¾“å…¥å€¼ï¼Œä»è€Œå¾—åˆ°ä¸€ä¸ªæ–°çš„è¿”å›å‡½æ•°çš„å‡½æ•°ï¼Œè¿™ç§è¿‡ç¨‹å°±å«&lt;strong>éƒ¨åˆ†åº”ç”¨&lt;/strong>ã€‚ä»¥ä¸‹æ˜¯éƒ¨åˆ†åº”ç”¨çš„å®šä¹‰ï¼š&lt;/p>
&lt;blockquote>
&lt;p>éƒ¨åˆ†åº”ç”¨ï¼ˆpartial applicationï¼‰è¿™ä¸ªåè¯ï¼Œè¡¨ç¤ºå‡½æ•°è¢«åº”ç”¨çš„å‚æ•°ä¸æ˜¯å®ƒæ‰€éœ€è¦çš„å®Œæ•´çš„å‚æ•°ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ä¾ç„¶æ‹—å£ï¼Œæ˜¯ä¸æ˜¯ï¼Ÿç°åœ¨ç»“åˆä¸Šé¢çš„ä¾‹å­ï¼Œå…¶å®å°±å¥½ç†è§£äº†ï¼Œæ­£å¸¸æ¥è¯´ï¼Œæˆ‘ä»¬è¦å¯¹ &lt;code>f(a, b, c)&lt;/code> æ±‚è§£ï¼Œè‚¯å®šæ˜¯è¦åº”ç”¨ &lt;code>a&lt;/code>ã€&lt;code>b&lt;/code>ã€&lt;code>c&lt;/code> ä¸‰ä¸ªå‚æ•°çš„ï¼Œä½†æ˜¯ç¬¬ä¸€æ¬¡åªèƒ½åº”ç”¨ &lt;code>a&lt;/code> è¿™ä¸ªè¾“å…¥å€¼ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬è¿˜ä¸èƒ½çŸ¥é“ &lt;code>f(a, b, c)&lt;/code> å‡½æ•°çš„å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œè¿™ä¸ªæ–°çš„å‡½æ•°å°†ä¸å†ä¾èµ– &lt;code>a&lt;/code> è¿™ä¸ªå‚æ•°ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼ŒæŸ¯ç†åŒ–çš„è¿‡ç¨‹å¿…ç„¶ä¼šæœ‰éƒ¨åˆ†åº”ç”¨çš„èº«å½±ï¼Œä½†æ˜¯åªæ˜¯ç›¸å…³ï¼Œå¹¶éç­‰ä»·ï¼Œå› ä¸ºæŒ‰ç…§éƒ¨åˆ†åº”ç”¨çš„å®šä¹‰ï¼Œæ»¡è¶³éƒ¨åˆ†åº”ç”¨çš„è¿‡ç¨‹ä¸ä¸€å®šå°±æ˜¯æŸ¯ç†åŒ–çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªå¾ˆå¥½è¯ä¼ªï¼Œå°±ä¸èµ˜è¿°äº†ã€‚&lt;/p>
&lt;h2 id="æŸ¯ç†åŒ–ä¸å‡½æ•°é—­åŒ…">æŸ¯ç†åŒ–ä¸å‡½æ•°é—­åŒ…&lt;/h2>
&lt;p>åœ¨å‰é¢å‡½æ•°æŸ¯ç†åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å‡½æ•°è¾“å…¥å€¼ä»£å…¥ä¹‹åçš„è¾“å‡ºéƒ½æ˜¯ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œå¯¹åº”åˆ°ç¼–ç¨‹ä¸­å°±æ˜¯è¿”å›å‡½æ•°çš„å‡½æ•°ï¼Œè€Œç¼–ç¨‹è¯­è¨€ä¸­æŸ¯ç†åŒ–å®ç°çš„åŸºç¡€å°±ä¾èµ–äº†é—­åŒ…çš„åŠŸèƒ½ï¼Œå³è¿”å›çš„æ–°å‡½æ•°éšå«äº†å¯¹äºå¤–éƒ¨å‡½æ•°çš„è¾“å…¥å€¼çš„å¼•ç”¨ã€‚è¿™ç‚¹ä¹Ÿæ˜¯å°†å‡½æ•°é—­åŒ…å’ŒæŸ¯ç†åŒ–å…³è”èµ·æ¥çš„æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€ç‚¹ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>ã€ŠScala å‡½æ•°å¼ç¼–ç¨‹ã€‹â€”â€” Paul Chiusano, Runar Bjarnason è‘—&lt;/li>
&lt;li>Wikipedia: &lt;a href="https://en.wikipedia.org/wiki/Currying">Currying&lt;/a>&lt;/li>
&lt;li>Wikipedia: &lt;a href="https://zh.wikipedia.org/zh-hans/%E9%97%AD%E5%8C%85_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">é—­åŒ… (è®¡ç®—æœºç§‘å­¦)&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>æ•°æ®ç»“æ„ï¼šå•è°ƒæ ˆ</title><link>https://blog.hackerpie.com/posts/algorithms/monotonous-stacks/monotonous-stacks/</link><pubDate>Wed, 04 Aug 2021 23:13:28 +0800</pubDate><guid>https://blog.hackerpie.com/posts/algorithms/monotonous-stacks/monotonous-stacks/</guid><description>&lt;h1 id="ä»€ä¹ˆæ˜¯å•è°ƒæ ˆ">ä»€ä¹ˆæ˜¯å•è°ƒæ ˆ&lt;/h1>
&lt;p>å•è°ƒæ ˆæ˜¯æŒ‡ä»æ ˆé¡¶åˆ°æ ˆåº•ï¼Œæ ˆå†…å…ƒç´ çš„å€¼ç¬¦åˆå•è°ƒæ€§çš„ä¸€ç§ç‰¹æ®Šæ•°æ®ç»“æ„ã€‚ä»æ ˆé¡¶åˆ°æ ˆåº•ï¼Œå…ƒç´ çš„å€¼å•è°ƒé€’å‡ï¼Œç§°ä¸ºå•è°ƒé€’å‡æ ˆï¼›åä¹‹ï¼Œç§°ä¸ºå•è°ƒé€’å¢æ ˆã€‚&lt;/p>
&lt;pre tabindex="0">&lt;code> \ 9 / \ 1 /
| 7 | | 3 |
| 5 | | 5 |
| 3 | | 7 |
| 2 | | 9 |
------- -------
å•è°ƒé€’å‡æ ˆ å•è°ƒé€’å¢æ ˆ
&lt;/code>&lt;/pre>&lt;h1 id="å•è°ƒæ ˆçš„ç»´æŠ¤">å•è°ƒæ ˆçš„ç»´æŠ¤&lt;/h1>
&lt;p>ä¸ºäº†ç»´æŒæ ˆçš„å•è°ƒæ€§ï¼Œåœ¨å¾€æ ˆå†…æ’å…¥å…ƒç´ æ—¶ï¼Œéœ€è¦æ¯”è¾ƒå¾ªç¯æ¯”è¾ƒæ ˆé¡¶å…ƒç´ ä¸å¾…æ’å…¥å…ƒç´ çš„å€¼çš„å¤§å°ï¼Œä»¥å•è°ƒé€’å¢æ ˆä¸¾ä¾‹ï¼Œéœ€è¦å§‹ç»ˆç¡®ä¿æ ˆé¡¶å…ƒç´ çš„å€¼å¤§äºç­‰äºå¾…æ’å…¥å…ƒç´ çš„å€¼æ–¹å¯æ’å…¥ï¼Œå¦åˆ™éœ€è¦å…ˆå¼¹å‡ºæ ˆé¡¶å…ƒç´ ä¹‹åï¼Œé‡å¤â€œæ£€æŸ¥-å¼¹å‡ºâ€çš„æµç¨‹ï¼Œç›´åˆ°æ ˆä¸ºç©ºï¼Œæˆ–è€…æ ˆé¡¶å…ƒç´ çš„å€¼å¤§äºç­‰äºå¾…æ’å…¥å…ƒç´ çš„å€¼ã€‚&lt;/p>
&lt;p>å‡è®¾éœ€è¦æ’å…¥çš„å…ƒç´ æŒ‰ç…§åºåˆ— &lt;code>5, 2, 3, 7, 1&lt;/code> ä»å·¦åˆ°å³éå†ï¼Œä¸”éœ€è¦ç»´æŠ¤å•è°ƒé€’å¢æ ˆï¼Œåˆ™æ’å…¥è¿‡ç¨‹ä¸ºï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code> \ / \ / \ / \ / \ /
| | | 2 | | 3 | | | | 1 |
| 5 | | 5 | | 5 | | 7 | | 7 |
------- ------- ------- ------- -------
(1) (2) (3) (4) (5)
&lt;/code>&lt;/pre>&lt;p>(1) å¾…æ’å…¥ 5ï¼Œæ ˆä¸ºç©ºï¼Œç›´æ¥æ’å…¥ 5ï¼›&lt;br>
(2) å¾…æ’å…¥ 2ï¼Œæ ˆé¡¶å…ƒç´ ä¸º 5ï¼Œå¤§äºå¾…æ’å…¥å…ƒç´  2ï¼Œ2 å¯ä»¥ç›´æ¥æ’å…¥ï¼›&lt;br>
(3) å¾…æ’å…¥ 3ï¼Œæ ˆé¡¶å…ƒç´ ä¸º 2ï¼Œä¸æ»¡è¶³å¤§äºç­‰äº 3 çš„è¦æ±‚ï¼Œæ‰€ä»¥å¼¹å‡ºæ ˆé¡¶å…ƒç´  2ï¼›æ­¤æ—¶æ–°çš„æ ˆé¡¶å…ƒç´ ä¸º 5ï¼Œå¤§äº 3ï¼Œ3 ç›´æ¥å…¥æ ˆï¼›&lt;br>
(4) å¾…æ’å…¥ 7ï¼Œæ ˆé¡¶å…ƒç´ ä¸º 3ï¼Œä¸æ»¡è¶³å¤§äºç­‰äº 7 çš„è¦æ±‚ï¼Œæ‰€ä»¥å¼¹å‡ºæ ˆé¡¶å…ƒç´  3ï¼›æ­¤æ—¶æ–°çš„æ ˆé¡¶å…ƒç´ ä¸º 5ï¼Œä»ç„¶å°äº 7ï¼Œäºæ˜¯ä¹Ÿå¼¹å‡ºæ ˆé¡¶å…ƒç´  5ï¼›æœ€åæ ˆä¸ºç©ºï¼Œç›´æ¥æ’å…¥ 7ï¼›&lt;br>
(5) å¾…æ’å…¥ 1ï¼Œæ ˆé¡¶å…ƒç´ ä¸º 7ï¼Œå¤§äºå¾…æ’å…¥å…ƒç´  1ï¼Œ1 å¯ä»¥ç›´æ¥å…¥æ ˆã€‚&lt;/p>
&lt;p>ç±»ä¼¼åœ°ï¼Œå‡å¦‚æˆ‘ä»¬ç¿»è½¬ä¸‹æ’å…¥çš„é¡ºåºï¼Œå³æŒ‰ç…§æŒ‰ç…§åºåˆ— &lt;code>5, 2, 3, 7, 1&lt;/code> ä»å³åˆ°å·¦é¡ºåºæ’å…¥å•è°ƒé€’å¢æ ˆï¼Œåˆ™æ’å…¥è¿‡ç¨‹ä¸ºï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code> \ / \ / \ / \ 2 / \ /
| | | | | 3 | | 3 | | 5 |
| 1 | | 7 | | 7 | | 7 | | 7 |
------- ------- ------- ------- -------
&lt;/code>&lt;/pre>&lt;h2 id="å•è°ƒæ ˆçš„æ€§è´¨æ€»ç»“">å•è°ƒæ ˆçš„æ€§è´¨æ€»ç»“&lt;/h2>
&lt;p>é€šè¿‡ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­ï¼Œå¯ä»¥æ€»ç»“å‡ºå•è°ƒé€’å¢æ ˆçš„æ€§è´¨ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å•è°ƒé€’å¢æ ˆå¯ä»¥è¡¨ç¤ºï¼šæŒ‰ç…§å…ƒç´ å…¥æ ˆé¡ºåºï¼Œå…¥æ ˆå…ƒç´ å‰é¢æ¯”å®ƒ&lt;strong>å¤§&lt;/strong>çš„æ‰€æœ‰å…ƒç´ ä¸­ç¦»å®ƒæœ€è¿‘çš„å…ƒç´ ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>æ›´å…·ä½“åœ°è®²ï¼Œå½“æˆ‘ä»¬ä»å·¦åˆ°å³è®¿é—®åºåˆ—æ—¶ï¼Œåˆ™å•è°ƒé€’å¢åºåˆ—è¡¨ç¤ºå…¥æ ˆå…ƒç´ å·¦è¾¹æ‰€æœ‰æ¯”å®ƒå¤§çš„å…ƒç´ ä¸­ï¼Œè·ç¦»å®ƒæœ€è¿‘çš„å…ƒç´ ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªä¾‹å­ä¸­ï¼Œ3å·¦è¾¹ç¬¬ä¸€ä¸ªæ¯”å®ƒå¤§çš„å…ƒç´ æ˜¯5ï¼Œè€Œ7å·¦è¾¹æ²¡æœ‰æ¯”å®ƒå¤§çš„å…ƒç´ ï¼›åè¿‡æ¥ï¼Œå½“æˆ‘ä»¬ä»å³åˆ°å·¦è®¿é—®åºåˆ—æ—¶ï¼Œåˆ™å•è°ƒé€’å¢åºåˆ—è¡¨ç¤ºå…¥æ ˆå…ƒç´ å³è¾¹æ‰€æœ‰æ¯”å®ƒå¤§çš„å…ƒç´ ä¸­ï¼Œè·ç¦»å®ƒæœ€è¿‘çš„å…ƒç´ ï¼Œæ¯”å¦‚7å³è¾¹æ²¡æœ‰æ¯”7å¤§çš„å…ƒç´ ï¼Œ1å³è¾¹ä¹Ÿæ²¡æœ‰æ¯”1å¤§çš„å…ƒç´ ï¼Œè€Œ2å³è¾¹ç¬¬ä¸€ä¸ªæ¯”2å¤§çš„å…ƒç´ åˆšå¥½æ˜¯3ï¼Œ5å³è¾¹æ¯”5å¤§çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯7ã€‚&lt;/p>
&lt;p>å¾ˆå®¹æ˜“é€šè¿‡ç±»ä¼¼çš„æ¼”ç¤ºå½’çº³æ€»ç»“å•è°ƒé€’å‡æ ˆçš„æ€§è´¨ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å•è°ƒé€’å¢æ ˆå¯ä»¥è¡¨ç¤ºï¼šæŒ‰ç…§å…ƒç´ å…¥æ ˆé¡ºåºï¼Œå…¥æ ˆå…ƒç´ å‰é¢æ¯”å®ƒ&lt;strong>å°&lt;/strong>çš„æ‰€æœ‰å…ƒç´ ä¸­ç¦»å®ƒæœ€è¿‘çš„å…ƒç´ ã€‚&lt;/p>
&lt;/blockquote></description></item><item><title>ç®—æ³•é¢˜è§£ï¼šäºŒå‰æ ‘å¯»è·¯</title><link>https://blog.hackerpie.com/posts/algorithms/binary-tree/binary-tree-routine/</link><pubDate>Sat, 31 Jul 2021 18:20:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/algorithms/binary-tree/binary-tree-routine/</guid><description>&lt;p>æœ¬é¢˜æ¥è‡ª Leetcode çš„ &lt;a href="https://leetcode-cn.com/problems/path-in-zigzag-labelled-binary-tree/">1104 é¢˜&lt;/a>ï¼Œæ˜¯ä¸€é“å¾ˆæœ‰è¶£çš„è€ƒå¯ŸäºŒå‰æ ‘æ•°æ®ç»“æ„çš„é¢˜ï¼ŒåŒæ—¶ç”±äºäºŒå‰æ ‘çˆ¶å­èŠ‚ç‚¹ä¹‹é—´çš„ç‰¹æ®Šå…³ç³»ï¼ŒåŒæ—¶è¿˜å¯ä»¥è¿ç”¨åˆ°ä½è¿ç®—æ¥å·§å¦™è§£é¢˜ã€‚&lt;/p>
&lt;p>å…ˆè´´ä¸€ä¸‹é¢˜ç›®ï¼š&lt;/p>
&lt;blockquote>
&lt;p>åœ¨ä¸€æ£µæ— é™çš„äºŒå‰æ ‘ä¸Šï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œæ ‘ä¸­çš„èŠ‚ç‚¹ é€è¡Œ ä¾æ¬¡æŒ‰Â â€œä¹‹â€ å­—å½¢è¿›è¡Œæ ‡è®°ã€‚&lt;br>
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨å¥‡æ•°è¡Œï¼ˆå³ï¼Œç¬¬ä¸€è¡Œã€ç¬¬ä¸‰è¡Œã€ç¬¬äº”è¡Œâ€¦â€¦ï¼‰ä¸­ï¼ŒæŒ‰ä»å·¦åˆ°å³çš„é¡ºåºè¿›è¡Œæ ‡è®°ï¼›&lt;br>
è€Œå¶æ•°è¡Œï¼ˆå³ï¼Œç¬¬äºŒè¡Œã€ç¬¬å››è¡Œã€ç¬¬å…­è¡Œâ€¦â€¦ï¼‰ä¸­ï¼ŒæŒ‰ä»å³åˆ°å·¦çš„é¡ºåºè¿›è¡Œæ ‡è®°ã€‚
&lt;img src="https://assets.leetcode-cn.com/aliyun-lc-upload/uploads/2019/06/28/tree.png" alt="">
ç»™ä½ æ ‘ä¸ŠæŸä¸€ä¸ªèŠ‚ç‚¹çš„æ ‡å· labelï¼Œè¯·ä½ è¿”å›ä»æ ¹èŠ‚ç‚¹åˆ°è¯¥æ ‡å·ä¸º label èŠ‚ç‚¹çš„è·¯å¾„ï¼Œè¯¥è·¯å¾„æ˜¯ç”±é€”ç»çš„èŠ‚ç‚¹æ ‡å·æ‰€ç»„æˆçš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç¤ºä¾‹ 1ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>è¾“å…¥ï¼šlabel = 14
è¾“å‡ºï¼š[1,3,4,14]
&lt;/code>&lt;/pre>&lt;p>ç¤ºä¾‹ 2ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>è¾“å…¥ï¼šlabel = 26
è¾“å‡ºï¼š[1,2,6,10,26]
&lt;/code>&lt;/pre>&lt;h3 id="ç®—æ³•é¢˜è§£æ€è·¯1è¿ç”¨äºŒå‰æ ‘çš„èŠ‚ç‚¹çš„æ•°å€¼ç‰¹æ€§æ¨å¯¼å‡ºå…¬å¼æ±‚è§£">ç®—æ³•é¢˜è§£æ€è·¯1ï¼šè¿ç”¨äºŒå‰æ ‘çš„èŠ‚ç‚¹çš„æ•°å€¼ç‰¹æ€§æ¨å¯¼å‡ºå…¬å¼æ±‚è§£&lt;/h3>
&lt;p>è§‚å¯Ÿè¿™ä¸ªâ€œä¹‹â€å­—å½¢äºŒå‰æ ‘ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºå‡ ä¸ªç‰¹ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>å‡å¦‚æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯æŒ‰ç…§ä»å·¦åˆ°å³ä¾æ¬¡é€’å¢ï¼ŒæŒ‰ç…§äºŒå‰æ ‘çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å½’çº³æ€»ç»“å‡ºï¼š
&lt;pre tabindex="0">&lt;code>è®° vi = æŸä¸ªèŠ‚ç‚¹çš„æ•°å€¼
v(å·¦å­èŠ‚ç‚¹) = 2 x vi
v(å³å­èŠ‚ç‚¹) = 2 x vi + 1
ç›¸åï¼š
v(çˆ¶èŠ‚ç‚¹) = vi / 2
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>å¯¹äºæ¯å±‚(ç¬¬ä¸€å±‚ä¸ºæ ¹èŠ‚ç‚¹)çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¼šæœ‰ï¼š
&lt;pre tabindex="0">&lt;code>vï¼ˆç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼‰= 2^(n-1) // 2 çš„ n-1 æ¬¡æ–¹ï¼Œnä¸ºå½“å‰å±‚æ•°
vï¼ˆæœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼‰= 2^n - 1 // 2 çš„ n æ¬¡æ–¹å‡ 1ï¼Œnä¸ºå½“å‰å±‚æ•°
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>å¯¹äºä»»æ„ä¸€ä¸ªæ•°å€¼ï¼Œå¯ä»¥æ±‚å‡ºå…¶æ‰€åœ¨çš„å±‚æ•°ä¸ºï¼š
&lt;pre tabindex="0">&lt;code>level = log2(N) + 1
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œæ‰€æœ‰å¥‡æ•°å±‚çš„èŠ‚ç‚¹æ˜¯ä»å·¦åˆ°å³ä¾æ¬¡é€’å¢çš„ï¼›è€Œæ‰€æœ‰å¶æ•°å±‚çš„èŠ‚ç‚¹æ˜¯ä»å³åˆ°å·¦ä¾æ¬¡é€’å¢çš„ï¼›&lt;/li>
&lt;li>å¯¹äºæŸä¸€å±‚çš„æ‰€æœ‰èŠ‚ç‚¹æ¥è¯´ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸€ä¸ªç­‰å·®æ•°åˆ—ï¼Œæ‰€ä»¥æ•°åˆ—å¯¹ç§°ä½ç½®ä¸Šçš„ä¸¤ä¸ªèŠ‚ç‚¹æ•°å€¼ä¹‹å’Œæ€»æ˜¯ç›¸ç­‰ï¼Œå³ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹çš„å€¼ä¹‹å’Œä¸€å®šç­‰äºç¬¬äºŒä¸ªèŠ‚ç‚¹å’Œå€’æ•°ç¬¬äºŒä¸ªèŠ‚ç‚¹çš„å€¼ä¹‹å’Œã€‚ç»“åˆç¬¬ 2 ç‚¹ï¼Œè¿™ä¸ªå’Œå§‹ç»ˆä¸º 2^(n-1) + 2^n - 1ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç»“åˆä»¥ä¸Š5ç‚¹æ€§è´¨ï¼Œæˆ‘ä»¬å†™å‡ºæ±‚ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„ä¼ªä»£ç ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>def getParentLabel(label: &lt;span style="">int&lt;/span>) -&amp;gt; label: &lt;span style="">int&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> level := log2(label) + 1 &lt;span style="font-style:italic">// æ±‚ label æ‰€åœ¨å±‚çº§
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> å¦‚æœ level ä¸ºå¶æ•°&lt;span style="">ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> åˆ™è·å¾—å½“å‰èŠ‚ç‚¹çš„å¯¹ç§°èŠ‚ç‚¹çš„å€¼&lt;span style="">ï¼Œ&lt;/span>å†æ±‚çˆ¶èŠ‚ç‚¹çš„å€¼
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> å¦‚æœ level ä¸ºå¥‡æ•°&lt;span style="">ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> åˆ™ç›´æ¥æ±‚çˆ¶èŠ‚ç‚¹çš„å€¼&lt;span style="">ï¼Œ&lt;/span>å†æ±‚çˆ¶èŠ‚ç‚¹çš„å¯¹ç§°èŠ‚ç‚¹çš„å€¼
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>def pathInZigZagTree(label: &lt;span style="">int&lt;/span>) -&amp;gt; path: []&lt;span style="">int&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path := [label] &lt;span style="font-style:italic">// label æ˜¯è·¯å¾„çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> loop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> å¦‚æœ label ç­‰äº 1&lt;span style="">ï¼Œ&lt;/span>åˆ™è·³å‡ºå¾ªç¯&lt;span style="">ï¼Œ&lt;/span>å› ä¸ºæ­¤æ—¶å·²ç»åˆ°è¾¾æ ¹èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> çˆ¶èŠ‚ç‚¹ := getParentLabel(label)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> å°†çˆ¶èŠ‚ç‚¹åŠ åˆ° path çš„å¼€å¤´ä½ç½®
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> label := çˆ¶èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> è¿”å› path
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹åº”çš„ Golang ä»£ç ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> &lt;span style="font-style:italic">&amp;#34;math&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> getParentLabel(label &lt;span style="">int&lt;/span>) &lt;span style="">int&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> n := int(math.Log2(float64(label))) + 1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> n % 2 == 0 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> label = int(math.Pow(2, float64(n-1)) + math.Pow(2, float64(n))) - 1- label &lt;span style="font-style:italic">// å…ˆå¯¹ç§°ç¿»è½¬
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">return&lt;/span> label / 2 &lt;span style="font-style:italic">// å†ç®—çˆ¶èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> int(math.Pow(2, float64(n-2)) + math.Pow(2, float64(n-1))) - 1 - label / 2 &lt;span style="font-style:italic">// ç›´æ¥ç®—çˆ¶èŠ‚ç‚¹çš„å¯¹ç§°ç¿»è½¬èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> pathInZigZagTree(label &lt;span style="">int&lt;/span>) []&lt;span style="">int&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> label == 1 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> []&lt;span style="">int&lt;/span>{1}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> original := label
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path := []&lt;span style="">int&lt;/span>{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> label == 1 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> label = getParentLabel(label)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path = append(path, label)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> i := 0; i &amp;lt; len(path) / 2; i++ {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path[i], path[len(path) - 1 - i] = path[len(path) - 1 - i], path[i]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path = append(path, original)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> path
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æäº¤è¿è¡Œï¼Œç»“æœä¸ºåŒ 100ã€‚&lt;/p>
&lt;h3 id="ç®—æ³•é¢˜è§£æ€è·¯2ä½è¿ç®—">ç®—æ³•é¢˜è§£æ€è·¯2ï¼šä½è¿ç®—&lt;/h3>
&lt;p>è¿™ä¸ªæ€è·¯å…¶å®è¿˜æ˜¯åŸºäºæ€è·¯1çš„å½’çº³æ€»ç»“ï¼Œä½†æ˜¯æ›´å·§å¦™çš„æ˜¯å¯ä»¥ç»“åˆä½è¿ç®—çš„ç‰¹æ€§ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå¯¹äºå¯¹2ä¹˜æ³•å’Œå¯¹2é™¤æ³•ï¼Œåœ¨ä½è¿ç®—é‡Œéƒ½æ˜¯ç®€å•çš„ä½ç§»æ“ä½œï¼Œå¾€å·¦ç§»1ä½å°±æ˜¯ä¹˜ä»¥2ï¼Œåä¹‹ï¼Œå¾€å³ç§»å°±æ˜¯é™¤ä»¥2ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆå¥½ï¼Œæ€æ ·å°†ä½è¿ç®—æŠ€å·§è¿ç”¨è¿›æ¥ï¼Ÿæˆ‘ä»¬é‡æ–°å›é¡¾ä¸Šé¢ 5 ä¸ªæ€§è´¨ä¸­çš„éƒ¨åˆ†æ€§è´¨ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>çˆ¶èŠ‚ç‚¹çš„è®¡ç®—ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>v(çˆ¶èŠ‚ç‚¹) = vi / 2
// æ¢æˆä½è®¡ç®—ï¼Œå°±æ˜¯ï¼š
v(çˆ¶èŠ‚ç‚¹) = vi &amp;gt;&amp;gt; 1 // å³å³ç§»1ä½
&lt;/code>&lt;/pre>&lt;/li>
&lt;li>
&lt;p>å¯¹ç§°èŠ‚ç‚¹çš„å’Œä¸º &lt;code>2^(n-1) + 2^n - 1&lt;/code>ï¼Œä¹Ÿå°±æ˜¯äºŒè¿›åˆ¶çš„ &lt;code>0b100...0&lt;/code>ï¼ˆ&lt;code>n-1&lt;/code>ä¸ª&lt;code>0&lt;/code>ï¼‰åŠ ä¸Š &lt;code>0b00...00&lt;/code>ï¼ˆ&lt;code>n&lt;/code>ä¸ª&lt;code>0&lt;/code>ï¼‰å†å‡å» &lt;code>0b1&lt;/code>ï¼Œå³ &lt;code>0b1011...11&lt;/code>ï¼ˆ&lt;code>n-1&lt;/code>ä¸ªä½ä½å‡ä¸º&lt;code>1&lt;/code>ï¼‰ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>è€Œå¯¹äºæŸä¸€å±‚çš„èŠ‚ç‚¹çš„å€¼ï¼Œå…¶å€¼çš„èŒƒå›´ä¸º&lt;code>[2^(n-1), 2^n-1]&lt;/code>ï¼Œäº¦å³&lt;code>[0b100...00ï¼Œ0b111...11]&lt;/code>ï¼Œæ€»ä½æ•°ä¸º&lt;code>n&lt;/code>ï¼Œç»“åˆä¸Šé¢æ–°çš„ç¬¬ 2 ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæ¯ä¸ªèŠ‚ç‚¹ï¼Œä¸å…¶å¯¹ç§°èŠ‚ç‚¹çš„å„è‡ªçš„å€¼çš„ &lt;code>n-1&lt;/code> ä¸ªä½ä½ç›¸åŠ åˆšå¥½ç­‰äº &lt;code>0b11...11&lt;/code>ï¼ˆ&lt;code>n-1&lt;/code>ä½çš„äºŒè¿›åˆ¶ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªèŠ‚ç‚¹çš„å¯¹ç§°èŠ‚ç‚¹çš„å€¼ï¼Œåˆšå¥½ç­‰äºè¿™ä¸ªèŠ‚ç‚¹çš„å€¼çš„æœ€é«˜1ä½ï¼ŒåŠ ä¸Šå‰©ä½™&lt;code>n-1&lt;/code>ä½çš„åç ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆ†æƒ…å†µè®¨è®ºï¼š&lt;br>
4.1. å¦‚æœå½“å‰è¡Œæ˜¯å¶æ•°ï¼Œåˆ™è®¡ç®—çˆ¶èŠ‚ç‚¹å€¼çš„è¿‡ç¨‹æ˜¯ï¼š&lt;/p>
&lt;pre>&lt;code> value = (value &amp;amp; 100...00 + !(val &amp;amp; 11...11)) // 100...00 è¡¨ç¤ºä¿ç•™é«˜1ä½ï¼Œ1...11 è¡¨ç¤ºä¿ç•™ä½ n - 1 ä½
value &amp;gt;&amp;gt; 1
&lt;/code>&lt;/pre>
&lt;p>4.2. å¦‚æœå½“å‰è¡Œæ˜¯å¥‡æ•°ï¼Œåˆ™è®¡ç®—çˆ¶èŠ‚ç‚¹å€¼çš„è¿‡ç¨‹æ˜¯ï¼š
value &amp;raquo; 1
value = (value &amp;amp; 100&amp;hellip;00 + !(val &amp;amp; 11&amp;hellip;11)) // 100&amp;hellip;00 è¡¨ç¤ºä¿ç•™é«˜1ä½ï¼Œ1&amp;hellip;11 è¡¨ç¤ºä¿ç•™ä½ n - 2 ä½
å½“ value â‰  1 æ—¶ï¼Œå¯ä»¥ç®€å•å³ç§»æ“ä½œä¸ç®¡æ”¾åœ¨å‰é¢è¿˜æ˜¯åé¢æ‰§è¡Œï¼Œéƒ½ä¸ä¼šå½±å“è®¡ç®—ç»“æœã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>æŒ‰ç…§æ–°çš„æ€è·¯ï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç®—æ³•å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> &lt;span style="font-style:italic">&amp;#34;math&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> getParentLabel(label &lt;span style="">int&lt;/span>) &lt;span style="">int&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> n := int(math.Log2(float64(label)))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> label = label &amp;gt;&amp;gt; 1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mask := 1 &amp;lt;&amp;lt; (n-1) &lt;span style="font-style:italic">// 0b1000000, n-1ä¸ª0ï¼Œç”¨æ¥ä¿ç•™æœ€é«˜ä½
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> lowMask := mask - 1 &lt;span style="font-style:italic">// 0b0111111, n-1ä¸ª1ï¼Œç”¨æ¥å–ä½n-1ä½
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> label = label &amp;amp; mask + (^label &amp;amp; lowMask)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> label
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> pathInZigZagTree(label &lt;span style="">int&lt;/span>) []&lt;span style="">int&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> label == 1 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> []&lt;span style="">int&lt;/span>{1}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> original := label
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path := []&lt;span style="">int&lt;/span>{}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> label == 1 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> label = getParentLabel(label)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path = append(path, label)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> i := 0; i &amp;lt; len(path) / 2; i++ {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path[i], path[len(path) - 1 - i] = path[len(path) - 1 - i], path[i]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> path = append(path, original)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> path
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æäº¤åï¼ŒåŒæ ·åŒ100é€šè¿‡ï¼Œå¯¹æ¯”ä¸¤ç§è§£é¢˜æ€è·¯ï¼ŒåŸºæœ¬æ€è·¯ä¸€è‡´ï¼Œä»ç»“æœçœ‹ï¼Œæ‰§è¡Œç”¨æ—¶å’Œå†…å­˜æ¶ˆè€—ä¹Ÿç¡®å®ä¸€è‡´ï¼Œåªä¸è¿‡ä¸€ç§æ˜¯ç›´è§‚è¡¨è¾¾ï¼Œä¸€ç§æ˜¯ä½è¿ç®—è§’åº¦è®¡ç®—ï¼Œè€Œåè€…è¿˜ç»Ÿä¸€äº†è®¡ç®—é€»è¾‘ã€‚&lt;/p></description></item><item><title>ç®—æ³•é¢˜è§£ï¼šæ‰£åˆ†åçš„æœ€å¤§å¾—åˆ†</title><link>https://blog.hackerpie.com/posts/algorithms/dynamic-programming/maximum-number-of-points-with-cost/</link><pubDate>Sun, 18 Jul 2021 16:48:43 +0800</pubDate><guid>https://blog.hackerpie.com/posts/algorithms/dynamic-programming/maximum-number-of-points-with-cost/</guid><description>&lt;p>é¢˜ç›®æ¥è‡ª Leetcode çš„ &lt;a href="https://leetcode-cn.com/problems/maximum-number-of-points-with-cost/">5815 é¢˜&lt;/a>ã€‚&lt;/p>
&lt;p>é¢˜ç›®çš„æ ¸å¿ƒæ˜¯ï¼šä»äºŒç»´çŸ©é˜µä¸­çš„æ¯è¡Œä¸­é€‰å–ä¸€ä¸ªæ ¼å­ï¼Œæ¯æ¬¡é€‰æ‹©ä¸€ä¸ªæ ¼å­åï¼Œæ‰€ç´¯è®¡çš„æœ€æ–°ç§¯åˆ†ç­‰äºå‰é¢å·²è·ç§¯åˆ†åŠ ä¸Šè¢«é€‰æ ¼å­çš„åˆ†æ•°å‡å»ä¸Šä¸€ä¸ªæ ¼å­å’Œå½“å‰è¢«é€‰æ ¼å­çš„åˆ—å·®ã€‚ç”¨å…¬å¼è¡¨è¾¾æ›´æ¸…æ™°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-golang" data-lang="golang">&lt;span style="display:flex;">&lt;span>points &lt;span style="font-style:italic">// è¡¨ç¤º m x n çš„äºŒç»´çŸ©é˜µæ¯ä¸ªæ ¼å­çš„åˆ†æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>score(r, c) &lt;span style="font-style:italic">// è¡¨ç¤ºé€‰å–åˆ° r è¡Œ c åˆ—æ‰€è·å¾—çš„æœ€å¤§å¾—åˆ†
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>score(r+1, c^) = score(r, c) + points[r+1, c^] - abs(c - c^)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡è¿™ä¸ªå…³ç³»ï¼Œå¯ä»¥ç¡®å®šä¸¤ä¸ªäº‹æƒ…ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„åŠ¨æ€è§„åˆ’é—®é¢˜&lt;/strong>ï¼šé—®é¢˜çš„æœ€ä¼˜è§£ä¾èµ–å­é—®é¢˜çš„æœ€ä¼˜è§£ï¼Œä¸”å­é—®é¢˜çš„æœ€ä¼˜è§£ç›¸äº’å½±å“ï¼Œè¿™ä¸€ç‚¹æ˜¯å’Œè´ªå¿ƒç®—æ³•æœ€å¤§çš„ä¸åŒï¼›&lt;/li>
&lt;li>åœ¨ä¸ºæ¯ä¸€è¡Œé€‰æ‹©ä¸€ä¸ªæ ¼å­æ—¶ï¼Œè¦ä½¿ &lt;code>score(r+1, c^)&lt;/code> çš„å€¼æœ€å¤§ï¼Œéœ€è¦æ‰¾åˆ°ä¸€å¯¹ç‰¹æ®Šçš„ &lt;code>(c, c^)&lt;/code> çš„å€¼ï¼Œè¿™ä¹Ÿå°±æ˜¯æ„å‘³ç€ï¼šæ¯æ¬¡åœ¨ä¸ºæ¯ä¸€è¡ŒæŒ‘é€‰æœ€ä¼˜çš„æ ¼å­æ—¶ï¼Œéœ€è¦é’ˆå¯¹ç»“åˆä¸Šä¸€è¡Œçš„æ¯ä¸€åˆ—ï¼Œä¸å½“å‰è¡Œçš„æ¯ä¸€åˆ—ï¼Œæ‰¾å‡ºæœ€ä¼˜ç»„åˆã€‚&lt;/li>
&lt;/ol>
&lt;p>æŒ‰ç…§è¿™ä¸ªæ€è·¯æ¥å†™ä»£ç çš„è¯ï¼Œæ•´ä¸ªç®—æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯ &lt;code>O(RCÂ²)&lt;/code>ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ &lt;code>O(C)&lt;/code>ã€‚ç›´æ¥æäº¤ï¼Œä¼šè§¦å‘ TLEï¼ˆTime Limit Exceedï¼‰ã€‚&lt;/p>
&lt;h3 id="ä¼˜åŒ–æ€è·¯">ä¼˜åŒ–æ€è·¯&lt;/h3>
&lt;p>å›åˆ°æœ€å¼€å§‹åˆ—çš„å¼å­é‚£é‡Œï¼Œè°ƒæ•´å¼å­çš„å†™æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-golang" data-lang="golang">&lt;span style="display:flex;">&lt;span>score(r+1, c^) = score(r, c) - abs(c-c^) + points[r+1, c^]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯è§ï¼Œå…¶ä¸­ points[r+1, c^] æ˜¯ä¸å˜é‡ï¼Œè¦ä½¿ &lt;code>score(r+1, c^)&lt;/code> çš„å€¼æœ€å¤§ï¼Œåªéœ€è¦æ»¡è¶³ &lt;code>score(r, c) - abs(c-c^)&lt;/code> æœ€å¤§å³å¯ã€‚&lt;/p>
&lt;p>ç”±äº &lt;code>abs(c-c^)&lt;/code> è¡¨ç¤ºç›¸é‚»ä¸¤è¡Œçš„ä¸¤ä¸ªæ ¼å­çš„åˆ—å·®ï¼Œ&lt;code>(c-c^)&lt;/code>çš„æ­£è´Ÿç»“æœå—ä¸¤è€…çš„ç›¸å¯¹ä½ç½®å…³ç³»å½±å“ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬åˆ†å¼€ä¸¤ç§æƒ…å†µæ¥è€ƒè™‘ï¼š&lt;/p>
&lt;ol>
&lt;li>ä¸Šä¸€è¡Œçš„æ ¼å­æ‰€åœ¨åˆ— &lt;code>c&lt;/code> ä¸ºä¸‹ä¸€è¡Œçš„æ ¼å­æ‰€åœ¨åˆ— &lt;code>c^&lt;/code> çš„å·¦è¾¹æˆ–æ­£ä¸Šæ–¹ï¼Œå‡è®¾ &lt;code>lmax&lt;/code> è¡¨ç¤º &lt;code>score(r, c) - (c^-c)&lt;/code> çš„æœ€å¤§å€¼ï¼Œåˆ™å½“&lt;code>c^&lt;/code> ä»å·¦åˆ°å³ç§»åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œæ¯å‘å³ç§»åŠ¨ä¸€ä¸ªæ ¼å­ï¼Œå¯¹äºæ–°çš„ &lt;code>c^^&lt;/code> è€Œè¨€ï¼Œå®ƒçš„ &lt;code>lmax&lt;/code> ç­‰äº &lt;code>max(lmax - 1, score(r, c^^))&lt;/code>ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºä¸ç®¡ä¸Šä¸€è¡Œé€‰æ‹©çš„æ ¼å­åœ¨å·¦ä¾§çš„å“ªä¸€åˆ—ï¼Œå¯¹äºä¸‹ä¸€è¡Œæ¥è¯´ï¼Œåªè¦å®ƒå‘å³ç§»åŠ¨ä¸€æ ¼ï¼Œå®ƒå’Œä¸Šä¸€è¡Œæ‰€é€‰æ ¼å­åœ¨æ¨ªå‘ä¸Šçš„è·ç¦»å°±å¤§äº† 1ï¼Œäºæ˜¯æœ‰ &lt;code>lmax - 1&lt;/code>ï¼Œè€Œæ–°çš„ &lt;code>lmax&lt;/code> è¦ä¹ˆæ˜¯ä»åŸæ¥çš„ &lt;code>lmax&lt;/code> èµ°ä¸‹æ¥ï¼Œè¦ä¹ˆæ˜¯ä» &lt;code>c^^&lt;/code> çš„æ­£ä¸Šæ–¹èµ°ä¸‹æ¥ï¼Œåè€…åˆ™ä¸éœ€è¦æ‰£å‡åˆ†æ•°ï¼Œäºæ˜¯å¾—å‡º &lt;code>lmax = max(lmax - 1, score(r, c^^))&lt;/code>ã€‚&lt;/li>
&lt;li>ä¸Šä¸€è¡Œçš„æ ¼å­æ‰€åœ¨åˆ— &lt;code>c&lt;/code> ä¸ºä¸‹ä¸€è¡Œçš„æ ¼å­æ‰€åœ¨åˆ— &lt;code>c^&lt;/code> çš„å·¦è¾¹æˆ–æ­£ä¸Šæ–¹ï¼Œè¿™ç§æƒ…å†µç±»ä¼¼ï¼Œåªä¸è¿‡æ¯æ¬¡ä¸‹ä¸€è¡Œéƒ½æ˜¯ä»å³å¾€å·¦ç§»åŠ¨ä¸€ä¸ªæ ¼å­ã€‚æ‰€ä»¥ï¼Œç±»ä¼¼çš„ï¼Œåœ¨è¿™ä¸ªåœºæ™¯é‡Œï¼Œæˆ‘ä»¬è®°ä»ä¸Šä¸€è¡Œå³ä¾§åˆ°ä¸‹ä¸€è¡Œçš„æœ€å¤§åˆ†æ•°ä¸º &lt;code>rmax&lt;/code>ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç»¼åˆä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬åªè¦æ‰¾å‡º &lt;code>max(lmax, rmax)&lt;/code> çš„ç»“æœå³å¯ã€‚&lt;/p>
&lt;h3 id="ç¼–ç å®ç°">ç¼–ç å®ç°&lt;/h3>
&lt;p>æ¯æ¬¡ä¸ºæ–°çš„ä¸€è¡Œé€‰æ‹©æ ¼å­æ—¶ï¼Œéœ€è¦å‚è€ƒä¸Šä¸€è¡Œçš„é€‰æ‹©ç»“æœï¼Œæ‰€ä»¥éœ€è¦ç©ºé—´ä¸Šéœ€è¦ä¸¤ä¸ªæ•°ç»„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-golang" data-lang="golang">&lt;span style="display:flex;">&lt;span>dp []&lt;span style="">int64&lt;/span> &lt;span style="font-style:italic">// è¡¨ç¤ºä¸Šä¸€è¡Œæ¯ä¸€åˆ—æ±‚å¾—çš„æœ€å¤§åˆ†æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span>ndp []&lt;span style="">int64&lt;/span> &lt;span style="font-style:italic">// è¡¨ç¤ºæ–°ä¸€è¡Œæ¯ä¸€åˆ—æ±‚å¾—çš„æœ€å¤§åˆ†æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åçš„ä»£ç æ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-golang" data-lang="golang">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> max(a, b &lt;span style="">int64&lt;/span>) &lt;span style="">int64&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> a &amp;gt;= b {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> a
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> b
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">func&lt;/span> maxPoints(points [][]&lt;span style="">int&lt;/span>) &lt;span style="">int64&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rows := len(points)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> rows == 0 {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cols := len(points[0])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dp := make([]&lt;span style="">int64&lt;/span>, cols)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> r := 0; r &amp;lt; rows; r++ {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ndp := make([]&lt;span style="">int64&lt;/span>, cols)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> lmax := int64(0)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> c := 0; c &amp;lt; cols; c++ {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> lmax = max(lmax - 1, dp[c])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ndp[c] = max(ndp[c], lmax)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rmax := int64(0)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> c := cols - 1; c &amp;gt;= 0; c-- {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rmax = max(rmax - 1, dp[c])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ndp[c] = max(ndp[c], rmax)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> c := 0; c &amp;lt; cols; c++ {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ndp[c] += int64(points[r][c])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> dp = ndp
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret := int64(0)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">for&lt;/span> _, v := &lt;span style="font-weight:bold">range&lt;/span> dp {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> ret &amp;lt; v {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ret = v
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> ret
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æäº¤åç»“æœæ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>æ‰§è¡Œç”¨æ—¶: 216 ms
å†…å­˜æ¶ˆè€—: 15.3 MB
&lt;/code>&lt;/pre>&lt;p>åŒ100é€šè¿‡ã€‚&lt;/p>
&lt;h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://leetcode-cn.com/circle/discuss/8o9q5h/">Leetcode ç¬¬250åœºå‘¨èµ›è®¨è®ºåŒº-å´è‡ªåçš„å›ç­”&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>ä¾èµ–å€’ç½®åŸåˆ™</title><link>https://blog.hackerpie.com/posts/2021/dependency-inversion-principle-introduce/</link><pubDate>Wed, 07 Jul 2021 21:22:20 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2021/dependency-inversion-principle-introduce/</guid><description>&lt;p>è¯´èµ·ä¾èµ–å€’ç½®åŸåˆ™ï¼Œå·²ç»ä¸æ˜¯ä¸ªæ–°é²œçš„è¯äº†ï¼Œè™½ç„¶ä¹ŸçŸ¥é“ä¾èµ–å€’ç½®åŸåˆ™çš„å…·ä½“è®¾è®¡æ¨¡å¼ï¼Œä½†æ˜¯ä¸€ç›´è§‰å¾—éš¾ä»¥ç†è§£ä½•ä¸ºâ€œå€’ç½®â€ï¼Œç›´åˆ°ä»Šæ™šé‡æ–°é™å¿ƒé˜…è¯»äº† Wikipedia æ‰æç„¶å¤§æ‚Ÿï¼æ¬£å–œä¹‹ä½™ï¼Œèµ¶ç´§å†™ç¯‡æ–‡ç« æ€»ç»“ã€‚&lt;/p>
&lt;h3 id="ä¼ ç»Ÿè½¯ä»¶åˆ†å±‚è®¾è®¡æ¨¡å¼">ä¼ ç»Ÿè½¯ä»¶åˆ†å±‚è®¾è®¡æ¨¡å¼&lt;/h3>
&lt;p>åœ¨è½¯ä»¶è®¾è®¡å¼€å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½ä¼šè‡ªç„¶è€Œç„¶æ€è€ƒç³»ç»Ÿçš„åˆ†å±‚è®¾è®¡ï¼Œæ¯”å¦‚ä»¥ä¸€ä¸ªå…¸å‹çš„ä¸‰å±‚æ¶æ„æ¥ä¸¾ä¾‹ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>---------------
æœåŠ¡å±‚ ï¼ˆæä¾› API æœåŠ¡ï¼‰
---------------
â†“
---------------
ä¸šåŠ¡é€»è¾‘å±‚ ï¼ˆå°è£…å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ï¼‰
---------------
â†“
---------------
å­˜å‚¨å±‚ ï¼ˆå¤„ç†æ•°æ®å­˜å–ï¼‰
---------------
&lt;/code>&lt;/pre>&lt;p>ä¾ç…§æ­¤æ¶æ„è®¾è®¡ï¼Œæˆ‘ä»¬å¯èƒ½è‡ªç„¶è€Œç„¶åœ°å°†å„å±‚ä»£ç å®ç°ç›´æ¥å°è£…åœ¨ä¸‰ä¸ªä¸åŒçš„ä»£ç åŒ…ï¼Œå…¶ä¸­ &lt;code>package.service&lt;/code> ç›´æ¥ä¾èµ– &lt;code>package.business&lt;/code>ï¼Œè€Œ &lt;code>package.business&lt;/code> åˆ™ç›´æ¥ä¾èµ– &lt;code>package.repository&lt;/code>ã€‚å› æ­¤å½¢æˆä»¥ä¸‹é“¾å¼ä¾èµ–é“¾ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>package.service ---&amp;gt; package.business ---&amp;gt; package.repository
&lt;/code>&lt;/pre>&lt;p>è¿™ç§åˆ†å±‚ä»£ç è®¾è®¡é£æ ¼ç›´æ¥&lt;strong>è€¦åˆäº†ä¾èµ–åŒæ–¹çš„å®ç°&lt;/strong>ï¼Œå‡å¦‚è¢«ä¾èµ–çš„åŒ…éœ€è¦ä¿®æ”¹ä»£ç é€»è¾‘ï¼Œåˆ™å¾ˆå¯èƒ½å¯¼è‡´ä¾èµ–å®ƒçš„ä¸Šå±‚ä»£ç éœ€è¦ç›¸åº”ä¿®æ”¹ï¼Œæç«¯åœºæ™¯ä¸‹ï¼Œè¿™ç§è€¦åˆå¸¦æ¥çš„å˜åŠ¨å½±å“å¯èƒ½æ‰©æ•£åˆ°æ•´ä¸ªä¾èµ–é“¾ã€‚&lt;br>
å…¶æ¬¡ï¼Œç”±äºä¸Šå±‚ä»£ç ä¾èµ–äº†ä¸‹å±‚ä»£ç çš„å…·ä½“å®ç°ï¼Œå¯¼è‡´äº†ä¸Šå±‚ä»£ç çš„å¯å¤ç”¨æ€§é™ä½ã€‚ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªè¿è¡Œäº†å¾ˆä¹…çš„ç³»ç»Ÿï¼Œå‡ºäºæŠ€æœ¯è€ƒé‡ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶å­˜å‚¨å±‚ä» MySQL ç§»æ¤åˆ° MongoDB ä¸Šï¼Œè€Œæ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¹¶ä¸éœ€è¦ä¹Ÿä¸åº”è¯¥æœ‰ä»»ä½•æ”¹å˜ï¼Œå¦‚æœæ˜¯é‡‡ç”¨ä¸Šè¿°è¿™ç§åˆ†å±‚æ¶æ„ï¼Œåˆ™ä¼šå¯¼è‡´æˆ‘ä»¬é™¤äº†æ›¿æ¢å­˜å‚¨å±‚ä»£ç å®ç°ï¼Œè¿˜è¦ç›¸åº”ä¿®æ”¹ä¸šåŠ¡é€»è¾‘å±‚çš„ä»£ç ï¼Œè¿™å°±æ˜¯æˆ‘è¯´çš„ç›´æ¥ä¾èµ–å®ç°ä¼šé™ä½ä¾èµ–ä¸€æ–¹çš„å¯å¤ç”¨æ€§é™ä½ã€‚&lt;/p>
&lt;h3 id="ä¾èµ–å€’ç½®åŸåˆ™">ä¾èµ–å€’ç½®åŸåˆ™&lt;/h3>
&lt;p>å…ˆç…§æœ¬å®£ç§‘è®²ä¸‹ä¾èµ–å€’ç½®åŸåˆ™çš„å«ä¹‰ï¼š&lt;/p>
&lt;blockquote>
&lt;p>é«˜å±‚çº§çš„æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚çº§çš„æ¨¡å—ã€‚å®ƒä»¬éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡ï¼ˆæ¯”å¦‚ï¼Œæ¥å£ï¼‰&lt;br>
æŠ½è±¡ä¸åº”è¯¥ä¾èµ–å®ç°ç»†èŠ‚ã€‚å®ç°ç»†èŠ‚ï¼ˆå…·ä½“çš„å®ç°ï¼‰åº”è¯¥ä¾èµ–æŠ½è±¡&lt;/p>
&lt;/blockquote>
&lt;p>æœ‰ç‚¹æŠ½è±¡ï¼Œæœ‰ç‚¹æ‹—å£ï¼Œæœ‰ç‚¹æ— æƒ…ï¼Œæœ‰ç‚¹æ— ç†å–é—¹å¯¹ä¸å¯¹ï¼Ÿ&lt;br>
è¿˜æ˜¯å°è¯•ç”¨å¤§ç™½è¯è§£é‡Šä¸€ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>é«˜å±‚çº§çš„æ¨¡å—åº”è¯¥ä¾èµ–çš„æ˜¯ä½å±‚çº§çš„æ¨¡å—çš„è¡Œä¸ºçš„æŠ½è±¡ï¼Œå–å†³äºå…·ä½“ç¼–ç¨‹è¯­è¨€ï¼Œå¯ä»¥æ˜¯æŠ½è±¡ç±»æˆ–è€…æ¥å£ç­‰æŠ€æœ¯ï¼›&lt;/li>
&lt;li>ç¬¬2å¥è¯å…¶å®å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªæ„æ€ï¼šåªè¦ä¾èµ–äº†å®ç°ï¼Œå°±æ˜¯è€¦åˆäº†ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å§‹ç»ˆä¾èµ–çš„æ˜¯æŠ½è±¡ï¼Œè€Œä¸æ˜¯å®ç°ã€‚&lt;/li>
&lt;/ol>
&lt;p>å°†ä¸Šé¢ä¸¾çš„ä¾‹å­æŒ‰ç…§ä¾èµ–å€’ç½®åŸåˆ™è®¾è®¡ï¼Œå°±æ˜¯è¿™æ ·å­äº†ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>package.service ---&amp;gt; package.business.interface
â†‘
â†‘ å®ç°
â†‘
package.business ---&amp;gt; package.repository.interface
â†‘
â†‘ å®ç°
â†‘
package.repository
&lt;/code>&lt;/pre>&lt;p>ä»¥ä¸Šé¢çš„æ¨¡å¼æ¥è¯´ï¼Œ&lt;code>package.service&lt;/code> ä¸å†ç›´æ¥ä¾èµ–äº &lt;code>package.business&lt;/code>ï¼Œè€Œæ˜¯ä¾èµ–äº† &lt;code>package.business.interface&lt;/code> æ¥å£ï¼Œä¹Ÿå°±æ˜¯ &lt;code>package.business&lt;/code> çš„æŠ½è±¡ã€‚&lt;br>
å¦ä¸€æ–¹é¢ï¼Œ&lt;code>package.business&lt;/code> ä¹Ÿä¸å†æ˜¯ä¸€ä¸ªè¢«ä¾èµ–æ–¹ï¼Œè€Œæ˜¯å¯¹ &lt;code>package.business.interface&lt;/code> çš„å®ç°ï¼Œä¹Ÿå°±æ˜¯ä¹Ÿä¾èµ–äº† &lt;code>package.business.interface&lt;/code> æŠ½è±¡ã€‚&lt;code>package.business&lt;/code> ä»ä¼ ç»Ÿåˆ†å±‚ç»“æ„é‡Œçš„è¢«ä¾èµ–æ–¹å˜æˆäº†ä¸Šé¢æ¨¡å¼ä¸­çš„å®ç°æŠ½è±¡æ¥å£çš„ä¾èµ–æ–¹ï¼Œè¿™å°±æ˜¯â€œå€’ç½®â€ä¸€è¯çš„æ¥ç”±ã€‚å€’ç½®å¹¶ä¸æ˜¯è¯´è¿™ç§æ¨¡å¼åè½¬äº†ä¾èµ–çš„æ–¹å‘ï¼Œå˜æˆä½å±‚çº§ä»£ç ä¾èµ–é«˜å±‚çº§ä»£ç ï¼Œè€Œæ˜¯è¯´åŸæ¥çš„è¢«ä¾èµ–æ–¹ä¹Ÿå˜æˆäº†ä¾èµ–æ–¹ï¼Œå‡å°‘äº†é«˜å±‚çº§ä»£ç åˆ°ä½å±‚çº§å®ç°ä¹‹é—´çš„ä¾èµ–ã€‚&lt;/p>
&lt;blockquote>
&lt;p>the &amp;ldquo;inversion&amp;rdquo; concept does not mean that lower-level layers depend on higher-level layers directly&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ä¸Šé¢çš„æ¨¡å¼ä¸­ï¼Œç”±äºä¸Šå±‚ä»£ç ä¸ä¸‹å±‚ä»£ç å®ç°è§£è€¦ï¼Œåªè¦ä¸‹å±‚ä»£ç çš„æŠ½è±¡ï¼ˆä¹Ÿå°±æ˜¯ä¸Šå±‚ä¾èµ–çš„æ¥å£ï¼‰ä¸å˜ï¼Œå°±ä¸ä¼šå¯¹ä¸Šå±‚æœ‰ä»»ä½•å½±å“ã€‚è¿™æ ·ï¼Œå‡å¦‚æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªç³»ç»Ÿçš„å­˜å‚¨å±‚è¿ç§»åˆ°å¦å¤–çš„æ•°æ®åº“ï¼Œå°±åªéœ€è¦åˆ‡æ¢å­˜å‚¨å±‚å®ç°çš„ä»£ç å³å¯ï¼Œè¿™æ ·ä¸šåŠ¡é€»è¾‘å±‚å°±ä¸ç”¨è·Ÿç€åšä»»ä½•è°ƒæ•´ã€‚&lt;/p>
&lt;p>ä»è¿™ç§æ¨¡å¼å¾ˆå®¹æ˜“å°±å¯ä»¥çœ‹å‡ºï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬è®¾è®¡å‡ºä½è€¦åˆã€é«˜å¤ç”¨æ€§çš„ä»£ç ã€‚&lt;/p>
&lt;h3 id="å…¶ä»–å¥½å¤„">å…¶ä»–å¥½å¤„&lt;/h3>
&lt;p>ï¼ˆæœªå®Œå¾…ç»­ï¼ŒæŒç»­æ›´æ–°ï¼‰&lt;/p>
&lt;h3 id="ä¾èµ–æ³¨å…¥">ä¾èµ–æ³¨å…¥&lt;/h3>
&lt;p>ï¼ˆæœªå®Œå¾…ç»­ï¼ŒæŒç»­æ›´æ–°ï¼‰&lt;/p>
&lt;h1 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h1>
&lt;ul>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">Dependency inversion principle&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>å¯¹äºæµ‹è¯•æ•°æ®ç®¡ç†çš„æ€è€ƒ</title><link>https://blog.hackerpie.com/posts/2021/test-data-management-thinking/</link><pubDate>Sat, 03 Jul 2021 12:25:10 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2021/test-data-management-thinking/</guid><description>&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>åœ¨ç ”å‘æµç¨‹ç®¡ç†ä¸­ï¼Œæµ‹è¯•ç¯èŠ‚ï¼Œä¸ç®¡æ˜¯ç™½ç›’æµ‹è¯•è¿˜æ˜¯é»‘ç›’æµ‹è¯•ï¼Œéƒ½æ˜¯ç¡®ä¿ç ”å‘äº¤ä»˜è´¨é‡çš„å…³é”®ã€‚åœ¨è¿‡å¾€çš„å·¥ä½œç»éªŒä¹‹ä¸­ï¼Œæµ‹è¯•æ•°æ®æ„é€ ä¸€ç›´æ˜¯å½±å“å¼€å‘äººå‘˜è‡ªæµ‹å’Œæµ‹è¯•äººå‘˜æµ‹è¯•è´¨é‡çš„ä¸€ä¸ªé‡è¦å› ç´ ï¼Œå¼€å‘äººå‘˜ç–²äºä¸ºæµ‹è¯•æˆ–è€…äº§å“ä½“éªŒæ„é€ ç‰¹å®šåœºæ™¯æ‰€éœ€çš„æµ‹è¯•æ•°æ®ï¼Œè€Œæµ‹è¯•äººå‘˜å¾€å¾€æ€»å› ä¸ºæµ‹è¯•æ•°æ®ä¸ç¬¦åˆç”¨ä¾‹å‰ç½®æ¡ä»¶çš„è¦æ±‚ï¼Œè¢«è¿«ç­‰å¾…å¼€å‘äººå‘˜æ„é€ æ•°æ®ï¼Œæœ€ç»ˆå¯¼è‡´å¤§é‡çš„æ²Ÿé€šæˆæœ¬å’Œæ—¶é—´æˆæœ¬ã€‚&lt;/p>
&lt;p>ä¸ºä»€ä¹ˆæµ‹è¯•æ•°æ®æ„é€ ä¼šå¦‚æ­¤éº»çƒ¦ï¼Ÿæˆ‘è®¤ä¸ºä¸»è¦è¿˜æ˜¯ä¸šåŠ¡æœ¬èº«çš„æµç¨‹è¿‡é•¿å¸¦æ¥çš„é—®é¢˜ï¼Œæ¯”å¦‚çœ‹ä¸€ä¸ªå…¸å‹çš„ä¾›åº”é“¾å•†å“é‡‡è´­ä»“å‚¨ç¯èŠ‚çš„æµç¨‹ï¼š
&lt;img src="https://blog.hackerpie.com/images/posts/2021/%e6%b5%81%e7%a8%8b.jpg" alt="">
&lt;/p>
&lt;p>åœ¨ä¸€ä¸ªé»‘ç›’æµ‹è¯•çš„åœºæ™¯ä¸‹ï¼Œå‡å¦‚æµ‹è¯•äººå‘˜éœ€è¦é’ˆå¯¹â€œå…¥åº“é¢„çº¦â€ç¯èŠ‚è¿›è¡Œæµ‹è¯•ï¼Œä¸ºäº†é¿å…è„æ•°æ®å¯¼è‡´ä¸šåŠ¡æµç¨‹ä¸­æ–­ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯ä»æµç¨‹èµ·ç‚¹é‡æ–°æ„é€ æ•´å¥—æµ‹è¯•æ•°æ®ï¼Œç„¶è€Œåœ¨äººæ‰‹æ“ä½œçš„æƒ…å†µä¸‹ï¼Œè¿™æ˜¾ç„¶æ˜¯éš¾ä»¥å®Œæˆçš„ã€‚&lt;/p>
&lt;h2 id="æµ‹è¯•æ•°æ®ç®¡ç†">æµ‹è¯•æ•°æ®ç®¡ç†&lt;/h2>
&lt;p>æˆ‘è°ƒç ”äº†å›½å†…å¤–å…³äºæµ‹è¯•æ•°æ®æ„é€ ç›¸å…³çš„ä¸€äº›è®¨è®ºï¼Œå‘ç°äº†æµ‹è¯•æ•°æ®ç®¡ç†ï¼Œè‹±æ–‡ Test Data Managementï¼Œä¸ºäº†é€¼æ ¼ï¼Œå¯ä»¥ç®€ç§°â€œTDMâ€ï¼Œè¿™ä¸ªæœ¯è¯­çš„å­˜åœ¨ã€‚å…³äºæµ‹è¯•æ•°æ®ç®¡ç†ï¼Œå¤§å®¶éƒ½åœ¨è¯´å®ƒçš„æˆæœ¬æœ‰å¤šé«˜ï¼Œä½†æ˜¯è‡³ä»Šå´ä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç›¸å¯¹é€šç”¨çš„è§£å†³æ–¹æ¡ˆï¼Œæ›´åˆ«è¯´æˆç†Ÿçš„è§£å†³æ–¹æ¡ˆäº†ã€‚&lt;/p>
&lt;h3 id="æµ‹è¯•æ•°æ®ç®¡ç†çš„æ–¹æ¡ˆæ€è€ƒ">æµ‹è¯•æ•°æ®ç®¡ç†çš„æ–¹æ¡ˆæ€è€ƒ&lt;/h3>
&lt;p>æŒ‰ç…§æµ‹è¯•æ•°æ®ç®¡ç†çš„åˆ‡å…¥ç‚¹ä»¥åŠæ‰§è¡Œçš„æ–¹å¼ï¼Œæˆ‘è§‰å¾—å¯ä»¥å½’çº³æ€»ç»“å‡ºä»¥ä¸‹å‡ ç§å½¢å¼ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>å¤åˆ¶ç”Ÿäº§ç¯å¢ƒæ•°æ®&lt;/strong>ï¼šè¿™ç§æ–¹å¼äº§ç”Ÿçš„æ•°æ®ï¼Œä¸€èˆ¬éƒ½æ»¡è¶³ä¸¥æ ¼çš„ä¸šåŠ¡æµ‹è¯•éœ€æ±‚ï¼Œæ•°æ®çš„è´¨é‡æ¯”è¾ƒé«˜ï¼Œä½†æ˜¯å¼•å…¥éšç§å®‰å…¨å’Œç›‘ç®¡é£é™©ï¼Œä¸”æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œå­˜å‚¨æˆæœ¬é«˜ï¼›&lt;/li>
&lt;li>&lt;strong>å¤åˆ¶éƒ¨åˆ†ç”Ÿäº§ç¯å¢ƒæ•°æ®&lt;/strong>ï¼šè¿™ç§æ–¹å¼é™ä½å­˜å‚¨æˆæœ¬ï¼Œä½†æ˜¯æé«˜äº†ç»´æŠ¤æˆæœ¬ï¼Œç‰¹åˆ«æ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Œåœ¨æ‰€è°“â€œéƒ¨åˆ†â€æ•°æ®çš„å‰æä¸‹ï¼Œéœ€è¦é’ˆå¯¹ä¸åŒåº“è¡¨æŒ‡å®šä¸åŒçš„æ•°æ®è¿‡æ»¤æ–¹æ¡ˆï¼›&lt;/li>
&lt;li>&lt;strong>å¤åˆ¶ç”Ÿäº§æ•°æ®ï¼Œè¿›è¡Œæ•°æ®æ··æ·†å¤„ç†&lt;/strong>ï¼šè¿™ç§æ–¹å¼å¯ä»¥èµ·åˆ°ä¸€å®šçš„éšç§å®‰å…¨é˜²æŠ¤ï¼Œä½†æ˜¯ç±»ä¼¼å¤åˆ¶ç”Ÿäº§ç¯å¢ƒæ•°æ®çš„æ–¹æ¡ˆï¼Œéœ€è¦é’ˆå¯¹ä¸åŒåº“è¡¨æŒ‡å®šä¸åŒçš„æ•°æ®æ··æ·†è§„åˆ™ï¼ŒåŒæ—¶éœ€è¦æ³¨æ„å…³ç³»æ•°æ®åº“çš„ä¸»é”®å¤–é”®å…³ç³»ç­‰ï¼›&lt;/li>
&lt;li>&lt;strong>æ‰§è¡Œæ¥å£è°ƒç”¨ï¼Œç”Ÿæˆä¸šåŠ¡æ•°æ®&lt;/strong>ï¼šè¿™ç§æ–¹å¼åœ¨æ¥å£æ­£å¸¸ç¬¦åˆå’Œé€»è¾‘æ­£ç¡®çš„å‰æä¸‹ï¼Œæ–¹ä¾¿è·å¾—ç¬¦åˆæµ‹è¯•æ¡ä»¶çš„æ•°æ®ã€‚ä½†æ˜¯æœ‰ç»´æŠ¤å¼€å‘æˆæœ¬ï¼Œéœ€è¦è·Ÿç€æ¥å£è®¾è®¡è°ƒæ•´ï¼Œæ”¹åŠ¨ç›¸å¯¹é«˜é¢‘ã€‚å¦å¤–ç‰¹å®šåœºæ™¯ï¼Œæ¯”å¦‚æ”¯ä»˜ï¼Œéœ€æä¾›åé—¨æ¥å£ï¼Œä»¥ä¾¿æµ‹è¯•è„šæœ¬ç»•è¿‡æ”¯ä»˜ç­‰æ¶‰åŠç¬¬ä¸‰æ–¹æœåŠ¡çš„ä¸šåŠ¡ï¼Œç•™ä¸‹å®‰å…¨éšæ‚£ã€‚å¦å¤–è„šæœ¬ä¸å¾—ä¸é€‚é…ä¸åŒçš„æ¥å£åè®®å’Œå¤æ‚æ¥å£è®¤è¯æµç¨‹ç­‰ï¼›&lt;/li>
&lt;li>&lt;strong>ç›´æ¥å‘æ•°æ®åº“æ’å…¥ç¬¦åˆæµ‹è¯•å‰ç½®æ¡ä»¶çš„æ–°æ•°æ®&lt;/strong>ï¼šè‡ªç”±åº¦æœ€é«˜ï¼Œæ•°æ®å®Œæ•´åº¦å¯æ§ï¼Œèƒ½å¤Ÿè·å¾—éš”ç¦»æ€§æœ€é«˜çš„æµ‹è¯•æ•°æ®é›†ã€‚ç»´æŠ¤æˆæœ¬é«˜ï¼Œè€¦åˆæŠ€æœ¯æ–¹æ¡ˆå­˜å‚¨å±‚è®¾è®¡ã€‚ç®¡ç†æˆæœ¬é«˜ï¼Œéœ€è¦ä¸€ç§é«˜æ•ˆç»„ç»‡å’Œæ£€ç´¢çš„æ–¹å¼ä»¥é¿å…é‡å¤å’Œå‡Œä¹±çš„æµ‹è¯•æ•°æ®é›†ã€‚ä½†æ˜¯è¿™ç§æ–¹å¼æ˜¯ç›¸å¯¹ç¨³å®šçš„æ–¹æ¡ˆã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="æˆ‘çš„æ–¹æ¡ˆ">æˆ‘çš„æ–¹æ¡ˆ&lt;/h3>
&lt;p>ï¼ˆå¾…ç»­â€¦â€¦ï¼‰&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://www.informatica.com/services-and-training/glossary-of-terms/test-data-management-definition.html">What is Test Data Management?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.delphix.com/glossary/what-is-test-data-management">What is Test Data Management?&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>è§£å†³ Mac OS ä¸‹ MySQL å®¢æˆ·ç«¯è¿æ¥ caching_sha2_password æ’ä»¶åŠ è½½å¤±è´¥é—®é¢˜</title><link>https://blog.hackerpie.com/posts/2021/fix-mysql-caching-sha2-password-problem/</link><pubDate>Sun, 20 Jun 2021 11:29:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2021/fix-mysql-caching-sha2-password-problem/</guid><description>&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>åœ¨å¼€å‘æˆ‘è‡ªå·±çš„ &lt;a href="https://github.com/Martin91/gofixtures">&lt;code>gofixtures&lt;/code>&lt;/a> é¡¹ç›®æ—¶ï¼Œé¡¹ç›®å•æµ‹éœ€è¦ç”¨åˆ° MySQLï¼Œäºæ˜¯æ¨¡ä»¿ go-txdb çš„æ–¹å¼ï¼Œä½¿ç”¨ docker åœ¨æœ¬åœ°èµ·äº† MySQL å®¹å™¨ã€‚æ‰§è¡Œæµ‹è¯•æ—¶ï¼Œå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>mysql: [Warning] Using a password on the command line interface can be insecure.
ERROR 2059 (HY000): Authentication plugin &amp;#39;caching_sha2_password&amp;#39; cannot be loaded: dlopen(/usr/local/mysql/lib/plugin/caching_sha2_password.so, 2): image not found
&lt;/code>&lt;/pre>&lt;h2 id="åŸå› åˆ†æ">åŸå› åˆ†æ&lt;/h2>
&lt;p>ç»“è®ºï¼šæœ¬åœ°å®¢æˆ·ç«¯ç‰ˆæœ¬è¿‡ä½ï¼Œä¸æ”¯æŒæœåŠ¡å™¨ç«¯ç‰ˆæœ¬çš„é‰´æƒæ–¹å¼ã€‚&lt;/p>
&lt;h3 id="ç¯å¢ƒ">ç¯å¢ƒ&lt;/h3>
&lt;p>å®¢æˆ·ç«¯ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>mysql Ver 14.14 Distrib 5.7.13, for osx10.11 (x86_64) using EditLine wrapper&lt;/code>&lt;/li>
&lt;li>macOS 10.14.6 Mojave&lt;/li>
&lt;/ul>
&lt;p>æœåŠ¡å™¨ç«¯ï¼š&lt;/p>
&lt;ul>
&lt;li>version: 8.0.25&lt;/li>
&lt;li>runtime environment: docker container&lt;/li>
&lt;/ul>
&lt;h3 id="åŸå› ">åŸå› &lt;/h3>
&lt;p>MySQL ä» 8.0 ç‰ˆæœ¬å¼€å§‹ç¼ºçœä½¿ç”¨ &lt;code>caching_sha2_password&lt;/code> ä½œä¸ºéªŒè¯æ–¹å¼ï¼Œè€Œ 5.7 å¹¶ä¸æ”¯æŒè¿™ç§éªŒè¯æ–¹å¼ï¼ˆ5.7 é»˜è®¤ä½¿ç”¨ &lt;code>mysql_native_password&lt;/code>ï¼‰ã€‚&lt;/p>
&lt;h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h2>
&lt;h3 id="æ–¹æ¡ˆä¸€å‡çº§å®¢æˆ·ç«¯ç‰ˆæœ¬">æ–¹æ¡ˆä¸€ï¼šå‡çº§å®¢æˆ·ç«¯ç‰ˆæœ¬&lt;/h3>
&lt;p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä¸ç”¨å±•å¼€ã€‚&lt;/p>
&lt;h3 id="æ–¹æ¡ˆäºŒè®¾ç½®ä½¿ç”¨æ—§çš„-mysql_native_password-æ–¹å¼">æ–¹æ¡ˆäºŒï¼šè®¾ç½®ä½¿ç”¨æ—§çš„ &lt;code>mysql_native_password&lt;/code> æ–¹å¼&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>é¦–å…ˆé€šè¿‡å‘½ä»¤è¡Œç™»é™†å®¹å™¨ shellï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>docker exec -it mysql /bin/bash &lt;span style="font-style:italic"># mysql æ˜¯ä½ çš„å®¹å™¨åå­—ï¼Œæˆ‘çš„å°±å« mysql&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨å®¹å™¨å†…çš„ mysql å‘½ä»¤è¿æ¥æœåŠ¡å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>mysql -uroot &lt;span style="font-style:italic"># ä½ å¯èƒ½éœ€è¦åˆ«çš„è¿æ¥å‚æ•°ï¼Œæˆ‘çš„æ²¡æœ‰å¯†ç &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>ä¿®æ”¹ root è´¦å·çš„éªŒè¯æ–¹å¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sql" data-lang="sql">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">ALTER&lt;/span> &lt;span style="font-weight:bold">USER&lt;/span> &lt;span style="font-style:italic">&amp;#39;root&amp;#39;&lt;/span>@&lt;span style="font-style:italic">&amp;#39;%&amp;#39;&lt;/span> IDENTIFIED &lt;span style="font-weight:bold">WITH&lt;/span> mysql_native_password &lt;span style="font-weight:bold">BY&lt;/span> &lt;span style="font-style:italic">&amp;#39;&amp;#39;&lt;/span>;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ol>
&lt;p>å®Œæˆï¼&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://blog.csdn.net/u010358168/article/details/81253744">å®Œç¾è§£å†³ERROR 2059 (HY000): Authentication plugin &amp;lsquo;caching_sha2_password&amp;rsquo; cannot be loadedé—®é¢˜&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.51cto.com/fengfeng688/2147169">MySQL8.0æ–°ç‰¹æ€§â€”â€”é»˜è®¤ä½¿ç”¨caching_sha2_passwordä½œä¸ºèº«ä»½éªŒè¯æ’ä»¶&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>ã€ŠPaxos Made Simpleã€‹ä¸­æ–‡ç¿»è¯‘ï¼šPaxos å¦‚æ­¤ç®€å•</title><link>https://blog.hackerpie.com/posts/2020/paxos-made-simple-translation/</link><pubDate>Wed, 28 Oct 2020 19:48:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2020/paxos-made-simple-translation/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢&lt;/h2>
&lt;p>ä¸ªäººåœ¨å­¦ä¹ ç†è§£ Paxos ç®—æ³•çš„è¿‡ç¨‹ä¸­ï¼ŒèŠ±äº†æ¯”è¾ƒå¤šçš„æ—¶é—´ï¼Œä»æœ€å¼€å§‹ç›´æ¥æŸ¥çœ‹ä¸­æ–‡åšå®¢èµ„æ–™ï¼Œæ„Ÿè§‰éƒ½æ˜¯çœ‹å®Œä¸çŸ¥æ‰€ä»¥ç„¶æˆ–è€…æœ‰å¾ˆå¤šç–‘é—®ï¼Œäºæ˜¯å†³å®šæ­»ç£•ã€ŠPaxos Made Simpleã€‹è®ºæ–‡åŸæ–‡ã€‚ä½†æ˜¯ç”±äºæœ‰äº›è‹±æ–‡çš„æ„æ€æˆ‘è‡ªå·±ç†è§£èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹å›°æƒ‘ï¼Œäºæ˜¯è¿‡ç¨‹ä¸­é‡åˆ°æ— æ³•ç†è§£çš„å†…å®¹ï¼Œä¸€æ–¹é¢æ˜¯ä¼šç¿»é˜…å‰è¾ˆä»¬å·²ç»å†™è¿‡çš„è®ºæ–‡çš„ç¿»è¯‘ä½œä¸ºå‚è€ƒï¼ŒäºŒæ˜¯åœ¨æœç´¢å¼•æ“é‡Œå°±ä¸€äº›éš¾ä»¥ç†è§£çš„ç‚¹æœç´¢ä¸­è‹±æ–‡çš„è®¨è®ºï¼Œä»¥æ­¤è§£å†³è‡ªå·±å¿ƒä¸­çš„å›°æƒ‘ã€‚åœ¨ç£•ç£•ç¢°ç¢°ä¸­å®Œæˆè®ºæ–‡çš„é˜…è¯»ä¹‹åï¼Œä»æœ‰ä¸€äº›ä¸å°½é€å½»ä¹‹å¤„ï¼ŒåŠ ä¸Šä¸ªäººè®¤ä¸ºæ­¤è®ºæ–‡å·²æœ‰çš„ç¿»è¯‘è´¨é‡å‚å·®ä¸é½ï¼Œæ‰€ä»¥æ–—èƒ†æƒ³é€šè¿‡ç¿»è¯‘ä»¥åŠå¿…è¦è¯‘æ³¨å†æ¬¡åŠ æ·±è‡ªå·±çš„ç†è§£ï¼Œå¦å¤–å¯èƒ½çš„è¯ï¼Œä¹Ÿå¸Œæœ›æœ¬æ¬¡ç¿»è¯‘èƒ½å¤Ÿå¸®åŠ©åˆ°æœªæ¥å¯èƒ½ä¼šé‡åˆ°å’Œæˆ‘ä¸€æ ·å›°æƒ‘çš„äººã€‚&lt;/p>
&lt;h3 id="éƒ¨åˆ†å…³é”®æœ¯è¯­è¡¨">éƒ¨åˆ†å…³é”®æœ¯è¯­è¡¨&lt;/h3>
&lt;p>è®ºæ–‡ä¸­æœ‰ä¸€äº›å…³é”®æœ¯è¯­ï¼Œæˆ‘å·²ç»åŠ›æ±‚ç”¨è¯å‡†ç¡®ï¼Œå¹¶åœ¨è®ºæ–‡ä¸­å°½åŠ›ä¿æŒæœ¯è¯­ç¿»è¯‘çš„ä¸€è‡´æ€§ï¼Œç›®çš„æ˜¯å°½é‡å……åˆ†ä¼ è¾¾è®ºæ–‡æœ¬èº«ç”¨è¯çš„ç²¾å‡†ï¼Œå»ºè®®è¯»è€…å¯å…ˆä»”ç»†é˜…è¯»æ­¤è¡¨ã€‚&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>åŸæ–‡æœ¯è¯­&lt;/th>
&lt;th>ç¿»è¯‘ä¸­ä½¿ç”¨æœ¯è¯­&lt;/th>
&lt;th>è¯‘è€…æ³¨&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>value(s)&lt;/td>
&lt;td>å€¼&lt;/td>
&lt;td>å€¼å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œè§‰å¾—å¤ªæŠ½è±¡çš„è¯»è€…å»ºè®®ç†è§£ä¸ºææ¡ˆçš„â€œå†…å®¹â€äº¦å¯&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>learn&lt;/td>
&lt;td>è·çŸ¥&lt;/td>
&lt;td>æœ‰äº›æ–‡ç« è¯‘ä½œâ€œäº†è§£â€æˆ–è€…â€œå­¦ä¹ â€ï¼Œä½†æ˜¯è¿™é‡Œåå¤æ–Ÿé…Œï¼Œè¿˜æ˜¯è§‰å¾—â€œè·çŸ¥â€æ›´è´´åˆ‡ï¼Œç›®çš„æ€§æ›´å¼ºçƒˆ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>propose&lt;/td>
&lt;td>æè®®&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>chosen&lt;/td>
&lt;td>é€‰å®š&lt;/td>
&lt;td>ä¸€ä¸ªè¢«é€‰å®šçš„å€¼ï¼Œæ„å‘³ç€ä¸€ä¸ªè¢«â€œä¸€è‡´â€ç¡®è®¤ä¸‹æ¥çš„å€¼&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>agent&lt;/td>
&lt;td>ä»£ç†&lt;/td>
&lt;td>ä¾æ—§è§‰å¾—ç¿»è¯‘æˆâ€œä»£ç†â€è¿‡äºå­—é¢åŒ–&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>proposer(s)&lt;/td>
&lt;td>æè®®è€…&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>acceptor(s)&lt;/td>
&lt;td>æ¥å—è€…&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>learner(s)&lt;/td>
&lt;td>å­¦ä¹ è€…&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>fail / failure&lt;/td>
&lt;td>å¤±æ•ˆ/æ•…éšœ&lt;/td>
&lt;td>æ„å‘³ç€ç³»ç»Ÿå·²ç»å®Œå…¨ä¸èƒ½å·¥ä½œ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>proposal&lt;/td>
&lt;td>ææ¡ˆ&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>accept&lt;/td>
&lt;td>æ¥å—&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>number&lt;/td>
&lt;td>ç¼–å·&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>distinguished&lt;/td>
&lt;td>ç‰¹å®šçš„&lt;/td>
&lt;td>æ–‡ä¸­ç”¨äºå½¢å®¹æŸä¸ªç»è¿‡é€‰ä¸¾è€Œè¢«é€‰ä¸­çš„è§’è‰²&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h2 id="ç¿»è¯‘å…¨æ–‡">ç¿»è¯‘å…¨æ–‡&lt;/h2>
&lt;h3 id="paxos-å¦‚æ­¤ç®€å•">Paxos å¦‚æ­¤ç®€å•&lt;/h3>
&lt;p>2001å¹´11æœˆ1æ—¥&lt;/p>
&lt;h3 id="æ‘˜è¦">æ‘˜è¦&lt;/h3>
&lt;p>å½“ç”¨æµ…æ˜¾æ˜“æ‡‚çš„è‹±è¯­æ¥è¡¨è¾¾çš„è¯ï¼ŒPaxos æ˜¯éå¸¸ç®€å•çš„ã€‚&lt;/p>
&lt;h3 id="1-å¯¼å¼•">1 å¯¼å¼•&lt;/h3>
&lt;p>Paxos ç®—æ³•â€”â€”ä¸€ä¸ªç”¨äºå®ç°ä¸€ä¸ªå®¹å¿é”™è¯¯çš„åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç®—æ³•ï¼Œè®©å¾ˆå¤šäººè§‰å¾—éš¾ä»¥ç†è§£ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºå¯¹äºå¾ˆå¤šè¯»è€…ä»¬è€Œè¨€ï¼ŒåŸæ¥çš„è¡¨è¿°å¤ªè¿‡äºè®©äººæ‘¸ä¸ç€å¤´è„‘&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>äº†ã€‚äº‹å®ä¸Šï¼Œå®ƒæ˜¯æœ€ç®€å•æµ…æ˜¾çš„åˆ†å¸ƒå¼ç®—æ³•ã€‚å®ƒçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªä¸€è‡´æ€§ç®—æ³•â€”â€”â€œsynodâ€ç®—æ³•&lt;sup id="fnref:2">&lt;a href="#fn:2" class="footnote-ref" role="doc-noteref">2&lt;/a>&lt;/sup>ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œå°†ä¼šçœ‹åˆ°è¿™ä¸ªä¸€è‡´æ€§ç®—æ³•ä¸å¯é¿å…åœ°éµå¾ªä¸€äº›æˆ‘ä»¬å¸Œæœ›å®ƒèƒ½å¤Ÿæ»¡è¶³çš„ç‰¹æ€§ã€‚æœ€åä¸€èŠ‚é˜è¿°äº†å®Œæ•´çš„ Paxos ç®—æ³•ï¼Œè¿™ä¸ªç®—æ³•æ˜¯é€šè¿‡å°†ä¸€è‡´æ€§ï¼ˆçš„å®ç°ï¼‰ç›´æ¥åº”ç”¨åˆ°ç”¨äºæ„å»ºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ï¼ˆå¤šå‰¯æœ¬ï¼‰çŠ¶æ€æœº&lt;sup id="fnref:3">&lt;a href="#fn:3" class="footnote-ref" role="doc-noteref">3&lt;/a>&lt;/sup>è¿™ç§æ–¹æ³•ä¸­å¾—åˆ°çš„â€”â€”è¿™ç§æ‰€è°“çš„æ–¹æ³•åº”è¯¥æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ï¼Œå› ä¸ºå®ƒæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸­æœ€å¸¸è¢«å¼•ç”¨çš„è®ºæ–‡çš„ä¸»é¢˜ã€‚&lt;/p>
&lt;h3 id="2-ä¸€è‡´æ€§ç®—æ³•">2 ä¸€è‡´æ€§ç®—æ³•&lt;/h3>
&lt;h4 id="21-é—®é¢˜æè¿°">2.1 é—®é¢˜æè¿°&lt;/h4>
&lt;p>å‡è®¾æœ‰ä¸€ä¸ªç”±å¤šä¸ªè¿›ç¨‹ç»„æˆçš„é›†åˆï¼Œé›†åˆé‡Œçš„æ¯ä¸ªè¿›ç¨‹éƒ½å¯ä»¥æè®®ï¼ˆå¯èƒ½ä¸åŒçš„ï¼‰å€¼&lt;sup id="fnref:4">&lt;a href="#fn:4" class="footnote-ref" role="doc-noteref">4&lt;/a>&lt;/sup>ã€‚ä¸€è‡´æ€§ç®—æ³•ä¿è¯åœ¨è¢«æè®®çš„è¿™äº›å€¼ä¸­åªæœ‰ä¸€ä¸ªå€¼èƒ½å¤Ÿè¢«é€‰å®šã€‚ä¸€æ—¦ä¸€ä¸ªå€¼è¢«é€‰å®šï¼Œåˆ™æ‰€æœ‰è¿›ç¨‹éƒ½éœ€è¦èƒ½å¤Ÿè·çŸ¥ï¼ˆlearnï¼‰è¿™ä¸ªè¢«é€‰å®šçš„å€¼ã€‚ä¸€è‡´æ€§çš„å®‰å…¨æ€§è¦æ±‚åšåˆ°ï¼š&lt;/p>
&lt;ul>
&lt;li>åªæœ‰è¢«æè®®çš„å€¼æ‰å¯ä»¥è¢«é€‰å®šï¼Œ&lt;/li>
&lt;li>åªèƒ½æœ‰ä¸€ä¸ªå€¼èƒ½è¢«é€‰å®šï¼Œ&lt;/li>
&lt;li>åªæœ‰ä¸€ä¸ªå€¼çœŸçš„å·²ç»â€œç¡®å®šâ€è¢«é€‰å®šï¼Œè¿›ç¨‹æ‰èƒ½è·çŸ¥è¿™ä¸ªå€¼å·²è¢«é€‰å®š&lt;sup id="fnref:5">&lt;a href="#fn:5" class="footnote-ref" role="doc-noteref">5&lt;/a>&lt;/sup>ï¼ˆè¯‘æ³¨ï¼šåªæœ‰ä¸€è‡´åŒæ„åçš„å€¼ï¼Œä¸”ä¸å¯èƒ½ä¼šè¢«æ¨ç¿»ï¼Œæ‰èƒ½å¤Ÿå‘¨çŸ¥ç»™é›†åˆé‡Œçš„è¿›ç¨‹ï¼Œç»“æœå°±èƒ½ä½¿æ‰€æœ‰è¿›ç¨‹è¾¾æˆå…±è¯†ï¼‰&lt;/li>
&lt;/ul>
&lt;p>æˆ‘ä»¬ä¸ä¼šå°è¯•å»æ˜ç¡®ç²¾å‡†çš„æ´»æ€§è¦æ±‚&lt;sup id="fnref:6">&lt;a href="#fn:6" class="footnote-ref" role="doc-noteref">6&lt;/a>&lt;/sup>ã€‚æ— è®ºå¦‚ä½•ï¼Œï¼ˆç®—æ³•çš„ï¼‰ç›®æ ‡æ˜¯è¦ä¿è¯è¢«æè®®çš„å€¼ä¸­æœ‰æŸä¸ªå€¼èƒ½å¤Ÿè¢«é€‰å®šï¼Œå¹¶ä¸”ä¸€æ—¦ä¸€ä¸ªå€¼è¢«é€‰å®šäº†ï¼Œè¿›ç¨‹æœ€ç»ˆèƒ½å¤Ÿè·çŸ¥è¿™ä¸ªè¢«é€‰å®šçš„å€¼ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬è®©ä¸‰ç±»ä»£ç†ï¼ˆagentï¼‰æ¥æ‰§è¡Œè¿™ä¸ªä¸€è‡´æ€§ç®—æ³•ä¸­çš„ä¸‰ä¸ªè§’è‰²ï¼šæè®®è€…ï¼ˆproposersï¼‰ã€æ¥å—è€…ï¼ˆacceptorsï¼‰ä»¥åŠå­¦ä¹ è€…ï¼ˆlearnersï¼‰ã€‚åœ¨å®é™…å®ç°ä¸­ï¼Œä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹å¯ä»¥å……å½“ä¸æ­¢ä¸€ä¸ªä»£ç†ï¼Œä½†æ˜¯ä»ä»£ç†åˆ°è¿›ç¨‹ä¹‹é—´çš„æ˜ å°„å…³ç³»ä¸æ˜¯æˆ‘ä»¬è¿™é‡Œå…³æ³¨çš„é‡ç‚¹ã€‚&lt;/p>
&lt;p>è®¾æƒ³ä»£ç†ä¹‹é—´å¯ä»¥é€šè¿‡å‘é€æ¶ˆæ¯çš„æ–¹å¼ç›¸äº’é€šä¿¡ã€‚æˆ‘ä»¬ä½¿ç”¨ä¼ ç»Ÿçš„å¼‚æ­¥ï¼ˆæ¨¡å‹ï¼‰ï¼Œè€Œä¸æ˜¯æ‹œå åº­é—®é¢˜æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š&lt;/p>
&lt;ul>
&lt;li>ä»£ç†ä»¥ä»»æ„é€Ÿåº¦è¿è¡Œï¼Œå¯èƒ½å› åœæ­¢è€Œå¤±æ•ˆï¼ˆæŒ‡ä¸èƒ½æ­£å¸¸å·¥ä½œï¼‰ï¼Œä¹Ÿå¯èƒ½é‡å¯ã€‚ç”±äºæ‰€æœ‰ä»£ç†éƒ½æœ‰å¯èƒ½åœ¨ä¸€ä¸ªå€¼è¢«é€‰å®šä¹‹åå¤±æ•ˆå†æ¥ç€é‡å¯ï¼Œé™¤éå¤±æ•ˆæˆ–è€…é‡å¯çš„ä»£ç†èƒ½å¤Ÿè®°ä½ä¸€äº›å…³é”®ä¿¡æ¯ï¼Œå¦åˆ™æ²¡æœ‰ä»»ä½•è§£å†³æ–¹æ¡ˆã€‚&lt;/li>
&lt;li>æ¶ˆæ¯å‘é€çš„é•¿åº¦å¯ä»¥æ˜¯ä»»æ„çš„ï¼Œæ¶ˆæ¯ä¹Ÿå¯ä»¥é‡å¤æˆ–è€…ä¸¢å¤±ï¼Œä½†æ¶ˆæ¯ä¸ä¼šè¢«ç¯¡æ”¹&lt;sup id="fnref:7">&lt;a href="#fn:7" class="footnote-ref" role="doc-noteref">7&lt;/a>&lt;/sup>ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="22-å€¼çš„é€‰å®š">2.2 å€¼çš„é€‰å®š&lt;/h4>
&lt;p>é€‰å®šä¸€ä¸ªå€¼çš„æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åªæœ‰ä¸€ä¸ªæ¥å—è€…çš„ä»£ç†ï¼šä¸€ä¸ªæè®®è€…å°†ä¸€ä¸ªææ¡ˆå‘é€ç»™è¿™ä¸ªæ¥å—è€…ï¼Œè€Œåè€…ç›´æ¥é€‰å®šå®ƒæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªæè®®çš„å€¼å³å¯ã€‚è¿™ç§æ–¹æ¡ˆè™½ç„¶ç®€å•ï¼Œå´æ˜¯æ— æ³•å«äººæ»¡æ„çš„ï¼Œå› ä¸ºè¿™ä¸ªï¼ˆå”¯ä¸€çš„ï¼‰æ¥å—è€…ä¸€æ—¦å¤±æ•ˆï¼Œå°†å¯¼è‡´åç»­çš„æ“ä½œæ— æ³•ç»§ç»­ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬æ¥å°è¯•é€‰å®šå€¼çš„å¦ä¸€ç§æ–¹æ³•å§ã€‚ä¸å†æ˜¯å•ä¸€çš„æ¥å—è€…ï¼Œæˆ‘ä»¬ç°åœ¨å°è¯•ä½¿ç”¨å¤šä¸ªæ¥å—è€…ä»£ç†çš„æ–¹å¼ã€‚ä¸€ä¸ªæè®®è€…å°†ä¸€ä¸ªæè®®çš„å€¼å‘é€ç»™ä¸€ç¾¤æ¥å—è€…ã€‚ä¸€ä¸ªæ¥å—è€…å¯èƒ½*æ¥å—ï¼ˆacceptï¼‰*è¿™ä¸ªè¢«æè®®çš„å€¼ã€‚ä¸€æ—¦ä¸€ä¸ªè¶³å¤Ÿå¤§æ•°é‡çš„æ¥å—è€…çš„é›†åˆéƒ½æ¥å—äº†ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å°±å¯ä»¥ç®—æ˜¯è¢«é€‰å®šäº†ã€‚å¤šå¤§çš„æ•°é‡æ‰ç®—è¶³å¤Ÿå¤§ï¼Ÿä¸ºäº†ç¡®ä¿æœ‰ä¸”åªæœ‰ä¸€ä¸ªå€¼è¢«é€‰å®šï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸€ä¸ªæ‰€è°“è¶³å¤Ÿå¤§çš„é›†åˆç­‰åŒäºè¿™äº›ä»£ç†ä¸­çš„â€œå¤§å¤šæ•°â€ç»„æˆçš„é›†åˆã€‚å› ä¸ºä»»æ„ä¸¤ä¸ªâ€œå¤§å¤šæ•°â€çš„é›†åˆå¿…ç„¶æ‹¥æœ‰è‡³å°‘ä¸€ä¸ªå…±åŒçš„æ¥å—è€…ï¼Œå¹¶ä¸”å‡å¦‚ä¸€ä¸ªæ¥å—è€…æœ€å¤šåªèƒ½æ¥å—ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯è¡Œå¾—é€šçš„ã€‚ï¼ˆåœ¨å¾ˆå¤šçš„è®ºæ–‡ä¸­éƒ½æœ‰å¯¹äºâ€œå¤§å¤šæ•°â€çš„æµ…æ˜¾çš„æ¦‚æ‹¬ï¼‰&lt;/p>
&lt;p>åœ¨ä¸è€ƒè™‘ï¼ˆç³»ç»Ÿï¼‰æ•…éšœæˆ–è€…æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœŸæœ›åœ¨å“ªæ€•åªæœ‰ä¸€ä¸ªæè®®è€…æå‡ºå€¼çš„æ—¶å€™ä¹Ÿèƒ½é€‰å®šä¸€ä¸ªå€¼ã€‚è¿™å¼•å‡ºäº†æ¡ä»¶ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>P1. æ¥å—è€…å¿…é¡»æ¥å—å®ƒæ”¶åˆ°çš„ç¬¬ä¸€ä¸ªææ¡ˆã€‚
&lt;/code>&lt;/pre>&lt;p>ä½†æ˜¯è¿™ä¸ªæ¡ä»¶å¼•å…¥äº†å¦ä¸€ä¸ªé—®é¢˜ã€‚åœ¨å‡ ä¹åŒä¸€æ—¶é—´ï¼Œå¤šä¸ªä¸åŒçš„æè®®è€…å¯èƒ½æè®®å¤šä¸ªä¸åŒçš„å€¼ï¼Œå¹¶ä¸”å‘ç”Ÿäº†ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼šæ¯ä¸ªæ¥å—è€…éƒ½æ¥å—äº†å…¶ä¸­ä¸€ä¸ªå€¼ï¼Œä½†æ˜¯æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå€¼è¢«æ¥å—è€…ä¸­çš„â€œå¤§å¤šæ•°â€æ‰€æ¥å—ã€‚ç”šè‡³åªæœ‰ä¸¤ä¸ªæè®®çš„å€¼ï¼Œä¸€æ—¦å®ƒä»¬å„è‡ªè¢«å·®ä¸å¤šä¸€åŠçš„æ¥å—è€…æ‰€æ¥å—ï¼Œæ­¤æ—¶å³ä½¿åªæœ‰ä¸€ä¸ªæ¥å—è€…æ•…éšœéƒ½å¯èƒ½ä½¿å¾—æ— æ³•ç¡®å®šè¯¥é€‰å®šå“ªä¸ªææ¡ˆ&lt;sup id="fnref:8">&lt;a href="#fn:8" class="footnote-ref" role="doc-noteref">8&lt;/a>&lt;/sup>ã€‚&lt;/p>
&lt;p>ç»“åˆ&lt;code>P1&lt;/code>ä»¥åŠâ€œåªæœ‰è¢«å¤§å¤šæ•°æ¥å—è€…æ‰€æ¥å—çš„å€¼æ‰èƒ½è¢«é€‰ä¸­â€çš„è¦æ±‚ï¼Œå¯ä»¥å‘ç°éšå«æ¡ä»¶ï¼šå¿…é¡»å…è®¸æ¥å—è€…æ¥å—ä¸æ­¢ä¸€ä¸ªææ¡ˆã€‚æˆ‘ä»¬ä½¿ç”¨å¯¹æ¯ä¸ªææ¡ˆè¿›è¡Œï¼ˆè‡ªç„¶ï¼‰ç¼–å·çš„æ–¹å¼æ¥è·Ÿè¸ªæ¥å—è€…å¯ä»¥æ¥å—çš„ä¸åŒçš„ææ¡ˆï¼Œè¿™æ ·çš„è¯ï¼Œæ¯ä¸ªææ¡ˆéƒ½åŒ…å«äº†ä¸€ä¸ªææ¡ˆç¼–å·ä»¥åŠå¯¹åº”çš„å€¼ã€‚ä¸ºäº†é˜²æ­¢æ··æ·†ï¼Œæˆ‘ä»¬è¦æ±‚ä¸åŒçš„ææ¡ˆå¿…é¡»è¦æœ‰ä¸åŒçš„ç¼–å·ã€‚è‡³äºæ€ä¹ˆå®ç°ä¸åŒçš„ç¼–å·åˆ™å–å†³äºå®ç°çš„æ–¹æ¡ˆ&lt;sup id="fnref:9">&lt;a href="#fn:9" class="footnote-ref" role="doc-noteref">9&lt;/a>&lt;/sup>ï¼Œè¿™é‡Œæˆ‘ä»¬åªè¦åšå‡è®¾å°±å¥½äº†ã€‚å½“ä¸€ä¸ªå¸¦æœ‰æŸä¸ªå€¼çš„ææ¡ˆè¢«å¤§å¤šæ•°çš„æ¥å—è€…æ¥å—äº†ä¹‹åï¼Œè¿™ä¸ªå€¼å°±ç®—æ˜¯è¢«é€‰å®šäº†ã€‚åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è¯´è¿™ä¸ªææ¡ˆï¼ˆä»¥åŠå®ƒçš„å€¼ï¼‰å·²ç»è¢«é€‰å®šäº†ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å¯ä»¥å…è®¸å¤šä¸ªææ¡ˆè¢«é€‰å®šï¼Œä½†æ˜¯å¿…é¡»ä¿è¯æ‰€æœ‰è¢«é€‰å®šçš„ææ¡ˆæ‹¥æœ‰ä¸€æ ·çš„å€¼ã€‚ç»“åˆææ¡ˆç¼–å·å½’çº³æ¨ç†ï¼Œåªè¦ä¿è¯ä»¥ä¸‹æ¡ä»¶å°±å¤Ÿäº†ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>P2. å¦‚æœä¸€ä¸ªæ‹¥æœ‰å€¼ v çš„ææ¡ˆè¢«é€‰å®šï¼Œåˆ™æ¯ä¸€ä¸ªï¼ˆæ¯”è¿™ä¸ªææ¡ˆï¼‰æ›´é«˜ç¼–å·ä¸”è¢«é€‰å®šçš„ææ¡ˆä¹Ÿéƒ½æ‹¥æœ‰å€¼ v
&lt;/code>&lt;/pre>&lt;p>ç”±äºï¼ˆææ¡ˆï¼‰ç¼–å·æ˜¯å®Œå…¨æœ‰åºçš„ï¼Œæ¡ä»¶ P2 ä¿è¯äº†è‡³å…³é‡è¦çš„å®‰å…¨æ€§å±æ€§ï¼šåªæœ‰ä¸€ä¸ªå€¼è¢«é€‰å®šã€‚&lt;/p>
&lt;p>ä¸ºäº†è¢«é€‰å®šï¼Œä¸€ä¸ªææ¡ˆå¿…é¡»è¢«è‡³å°‘ä¸€ä¸ªæ¥å—è€…æ‰€æ¥å—ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬é€šè¿‡æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ¥æ»¡è¶³ P2ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>P2a. å¦‚æœä¸€ä¸ªæ‹¥æœ‰å€¼ v çš„ææ¡ˆè¢«é€‰å®šï¼Œåˆ™æ¯ä¸€ä¸ªï¼ˆæ¯”è¿™ä¸ªææ¡ˆï¼‰æ›´é«˜ç¼–å·ä¸”è¢«ä»»æ„ä¸€ä¸ªæ¥å—è€…æ¥å—çš„ææ¡ˆä¹Ÿéƒ½æ‹¥æœ‰å€¼ v
&lt;/code>&lt;/pre>&lt;p>æˆ‘ä»¬ä»éœ€åšæŒ P1 ä»¥ä¿è¯æŸä¸ªææ¡ˆèƒ½è¢«é€‰å®šã€‚ï¼ˆå¹¶ä¸”ï¼‰å› ä¸ºæ¶ˆæ¯é€šä¿¡æ˜¯å¼‚æ­¥çš„ï¼Œä¸€ä¸ªææ¡ˆå¯èƒ½ä¼šè¢«æŸä¸ªä»æ¥æ²¡æœ‰æ”¶åˆ°è¿‡ä»»ä½•ææ¡ˆçš„ç‰¹æ®Šæ¥å—è€… &lt;em>c&lt;/em> æ‰€æ¥å—ã€‚è®¾æƒ³ä¸€ä¸ªæ–°çš„æè®®è€…â€œé†’æ¥â€å¹¶ä¸”æè®®äº†ä¸€ä¸ªæ›´é«˜ç¼–å·ä¸”å€¼ä¸åŒçš„ææ¡ˆçš„åœºæ™¯ã€‚P1è¦æ±‚ &lt;em>c&lt;/em> ä¸å¾—ä¸æ¥å—è¿™ä¸ªææ¡ˆï¼Œä½†è¿™åˆä¼šæ‰“ç ´ P2a çš„æ¡ä»¶ã€‚ä¸ºäº†åŒæ—¶æ»¡è¶³ P1 å’Œ P2aï¼Œéœ€è¦å¯¹ P2a åšè¿›ä¸€æ­¥åŠ å¼ºï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>P2b. å¦‚æœä¸€ä¸ªæ‹¥æœ‰å€¼ v çš„ææ¡ˆè¢«é€‰å®šï¼Œåˆ™æ¯ä¸€ä¸ªï¼ˆæ¯”è¿™ä¸ªææ¡ˆï¼‰æ›´é«˜ç¼–å·ä¸”è¢«ä»»æ„ä¸€ä¸ªæè®®è€…æè®®çš„ææ¡ˆä¹Ÿéƒ½æ‹¥æœ‰å€¼ v
&lt;/code>&lt;/pre>&lt;p>ç”±äºåªæœ‰è¢«æè®®è€…æè®®çš„ææ¡ˆï¼Œæ‰å¯ä»¥è¢«æ¥å—è€…æ¥å—ï¼Œæ‰€ä»¥ P2b éšå«äº† P2aï¼Œä¹Ÿè¿›ä¸€æ­¥éšå«äº† P2ã€‚&lt;/p>
&lt;p>ä¸ºäº†å‘ç°å¦‚ä½•æ»¡è¶³ P2bï¼Œæˆ‘ä»¬è€ƒè™‘å¦‚ä½•è¯æ˜å®ƒæˆç«‹ã€‚æˆ‘ä»¬å…ˆå‡è®¾æŸä¸ªç¼–å·ä¸º&lt;em>m&lt;/em>ï¼Œä¸”å€¼ä¸º &lt;em>v&lt;/em> çš„ææ¡ˆå·²ç»è¢«é€‰å®šï¼Œç„¶åè¯æ˜ä»»ä½•ç¼–å·ä¸º &lt;em>n&lt;/em> ï¼ˆ&lt;em>n&lt;/em> &amp;gt; &lt;em>m&lt;/em>ï¼‰çš„ææ¡ˆä¹Ÿéƒ½æ‹¥æœ‰å€¼ &lt;em>v&lt;/em>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹ &lt;em>n&lt;/em> é‡‡ç”¨æ•°å­¦å½’çº³æ³•&lt;sup id="fnref:10">&lt;a href="#fn:10" class="footnote-ref" role="doc-noteref">10&lt;/a>&lt;/sup>ä»¥ä½¿è¯æ˜è¿‡ç¨‹æ›´è½»æ¾ï¼Œäºæ˜¯åœ¨ä»¥ä¸‹é¢å¤–çš„å‡è®¾ä¸‹å¯è¯æ˜ç¼–å·ä¸º &lt;em>n&lt;/em> çš„ææ¡ˆæ‹¥æœ‰å€¼ &lt;em>v&lt;/em>ï¼š&lt;/p>
&lt;blockquote>
&lt;p>å½’çº³å‡è®¾ï¼šæ¯ä¸€ä¸ªç¼–å·åœ¨ &lt;em>m&lt;/em>..(&lt;em>n-1&lt;/em>) ä¹‹é—´çš„ææ¡ˆéƒ½æ‹¥æœ‰å€¼ &lt;em>v&lt;/em>ï¼Œè¿™é‡Œçš„ &lt;em>i..j&lt;/em> çš„è®°æ³•ä»£è¡¨ä» &lt;em>i&lt;/em> åˆ° &lt;em>j&lt;/em> çš„ä¸€ç»„ç¼–å·ã€‚&lt;sup id="fnref:11">&lt;a href="#fn:11" class="footnote-ref" role="doc-noteref">11&lt;/a>&lt;/sup>&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>é›†åˆ &lt;em>C&lt;/em> é‡Œçš„æ¯ä¸ªæ¥å—è€…éƒ½æ¥å—äº†ç¼–å·åœ¨ &lt;em>m&lt;/em>..(&lt;em>n-1&lt;/em>) ä¹‹é—´çš„ä¸€ä¸ªææ¡ˆ&lt;sup id="fnref:12">&lt;a href="#fn:12" class="footnote-ref" role="doc-noteref">12&lt;/a>&lt;/sup>ï¼Œå¹¶ä¸”è¢«ä»»ä½•ä¸€ä¸ªæ¥å—è€…æ‰€æ¥å—çš„æ¯ä¸€ä¸ªç¼–å·åœ¨ &lt;em>m&lt;/em>..(&lt;em>n-1&lt;/em>) ä¹‹é—´çš„ææ¡ˆéƒ½æ‹¥æœ‰å€¼ vã€‚&lt;/p>
&lt;/blockquote>
&lt;p>ç”±äºä»»æ„ä¸€ä¸ªç”±å¤§å¤šæ•°æ¥å—è€…ç»„æˆçš„é›†åˆ &lt;em>S&lt;/em> éƒ½å¿…ç„¶åŒ…å«é›†åˆ &lt;em>C&lt;/em> çš„è‡³å°‘ä¸€ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç»´æŠ¤ä»¥ä¸‹ä¸å˜æ€§ä»¥ä¿è¯ç¼–å·ä¸º &lt;em>n&lt;/em> çš„ææ¡ˆæ‹¥æœ‰å€¼ &lt;em>v&lt;/em>ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>P2c. å¯¹äºä»»æ„çš„ v å’Œ nï¼Œå¦‚æœä¸€ä¸ªç¼–å·ä¸º n ä¸”æ‹¥æœ‰å€¼ v çš„ææ¡ˆè¢«æè®®ï¼Œåˆ™å­˜åœ¨ä¸€ä¸ªç”±å¤§å¤šæ•°æ¥å—è€…ç»„æˆçš„é›†åˆ S æ»¡è¶³è¿™é‡Œå…¶ä¸­ä¸€ä¸ªæ¡ä»¶ï¼šï¼ˆaï¼‰é›†åˆ S é‡Œæ²¡æœ‰æ¥å—è€…æ¥å—äº†ä»»ä½•ä¸€ä¸ªç¼–å·å°äº n çš„ææ¡ˆï¼›æˆ–è€…æ˜¯ï¼šï¼ˆbï¼‰v æ˜¯é›†åˆ S ä¸­çš„æ¥å—è€…å·²ç»æ¥å—è¿‡çš„æ‰€æœ‰ç¼–å·å°äº n çš„ææ¡ˆä¸­ç¼–å·æœ€é«˜çš„ææ¡ˆçš„å€¼ã€‚
&lt;/code>&lt;/pre>&lt;p>å› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»´æŠ¤ P2c çš„ä¸å˜æ€§æ¥æ»¡è¶³ P2b çš„æ¡ä»¶ã€‚&lt;/p>
&lt;p>ä¸ºäº†ç»´æŠ¤ P2c çš„ä¸å˜æ€§ï¼Œæƒ³è¦æè®®ç¼–å·ä¸º &lt;em>n&lt;/em> çš„ææ¡ˆçš„æè®®è€…å¿…é¡»è·çŸ¥ç¼–å·å°äº &lt;em>n&lt;/em> çš„æœ€å¤§ç¼–å·çš„ææ¡ˆï¼Œå¦‚æœå­˜åœ¨è¿™æ ·çš„ææ¡ˆçš„è¯ï¼Œé‚£å®ƒè‚¯å®šæ˜¯å·²ç»æˆ–è€…å³å°†è¢«å¤§å¤šæ•°æ¥å—è€…æ‰€æ¥å—çš„ææ¡ˆã€‚è·çŸ¥å·²ç»è¢«æ¥å—çš„ææ¡ˆæ˜¯è¶³å¤Ÿç®€å•çš„ï¼Œä½†æ˜¯é¢„æµ‹æœªæ¥å“ªäº›ï¼ˆææ¡ˆä¼šè¢«ï¼‰æ¥å—åˆ™æ˜¯å›°éš¾çš„ã€‚ä¸å…¶å°è¯•å»é¢„æµ‹æœªæ¥ï¼Œä¸å¦‚è®©æè®®è€…é€šè¿‡è·å–ä¸€ä¸ª**â€œå°†ä¸ä¼šå­˜åœ¨ä»»ä½•ä¸€ä¸ªè¿™æ ·çš„æ¥å—â€**çš„æ‰¿è¯ºæ¥æ§åˆ¶è¿™ä¸ªè¿‡ç¨‹ã€‚æ¢å¥è¯è¯´ï¼Œæè®®è€…è¯·æ±‚æ¥å—è€…ä»¬ä¸å†æ¥å—ä»»ä½•ç¼–å·æ¯” &lt;em>n&lt;/em> å°çš„ææ¡ˆã€‚è¿™å°±å¼•å‡ºäº†ä»¥ä¸‹ç”¨äºæè®®è¿‡ç¨‹çš„ç®—æ³•ï¼š&lt;/p>
&lt;ol>
&lt;li>ä¸€ä¸ªæè®®è€…é€‰æ‹©ä¸€ä¸ªæ–°çš„ææ¡ˆç¼–å· &lt;em>n&lt;/em>ï¼Œç„¶åç»™ç”±æŸäº›æ¥å—è€…ç»„æˆçš„é›†åˆä¸­çš„æ¯ä¸€ä¸ªæˆå‘˜å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¦æ±‚å®ƒå“åº”ä»¥ä¸‹ä¿¡æ¯ï¼š
a. ä¸€ä¸ªæ‰¿è¯ºï¼šä¸å†æ¥å—ä»»ä½•ä¸€ä¸ªç¼–å·æ¯” *n * å°çš„ææ¡ˆï¼Œå¹¶ä¸”
b. å¦‚æœå®ƒå·²ç»æœ‰æ¥å—è¿‡ææ¡ˆçš„è¯ï¼Œåˆ™è¿˜è¦è¿”å›å®ƒå·²ç»æ¥å—è¿‡çš„ç¼–å·æ¯” &lt;em>n&lt;/em> å°çš„æœ€å¤§ç¼–å·çš„ææ¡ˆ&lt;sup id="fnref:13">&lt;a href="#fn:13" class="footnote-ref" role="doc-noteref">13&lt;/a>&lt;/sup>
æˆ‘æŠŠè¿™æ ·ä¸€ä¸ªè¯·æ±‚ç§°ä¹‹ä¸ºå¯¹ç¼–å· &lt;em>n&lt;/em> çš„ &lt;em>prepare&lt;/em> è¯·æ±‚ã€‚&lt;/li>
&lt;li>å¦‚æœæè®®è€…ä»å¤§å¤šæ•°çš„æ¥å—è€…æˆåŠŸæ”¶åˆ°æœŸå¾…çš„å“åº”ï¼Œåˆ™å®ƒå¯ä»¥æ¥ç€æè®®ä¸€ä¸ªç¼–å·ä¸º &lt;em>n&lt;/em> ä¸”å€¼ä¸º &lt;em>v&lt;/em> çš„ææ¡ˆï¼Œè¿™é‡Œ &lt;em>v&lt;/em> å°±æ˜¯å®ƒä»1b ä¸­æ”¶åˆ°çš„å“åº”é‡Œæœ€å¤§ç¼–å·çš„ææ¡ˆçš„å€¼ï¼Œå¦‚æœæ‰€æœ‰å“åº”éƒ½è¡¨æ˜æ²¡æœ‰æ¥å—è¿‡ä»»ä½•ææ¡ˆï¼Œåˆ™æè®®è€…å¯ä»¥è‡ªç”±é€‰æ‹©ä¸€ä¸ªå€¼ã€‚
æè®®è€…é€šè¿‡å‘ä¸€ç»„æ¥å—è€…å‘é€ä¸€ä¸ªè¯·æ±‚æ¥æè®®ææ¡ˆã€‚ï¼ˆè¿™é‡Œçš„è¿™ç»„æ¥å—è€…å¹¶ä¸éœ€è¦å’Œå“åº” &lt;em>request&lt;/em> è¯·æ±‚çš„æ¥å—è€…ä¸€è‡´ï¼‰ã€‚è®©æˆ‘ä»¬æŠŠè¿™ä¸ªè¯·æ±‚ç§°ä¹‹ä¸º &lt;em>accept&lt;/em> è¯·æ±‚ã€‚&lt;/li>
&lt;/ol>
&lt;p>å‰é¢è¿™äº›å†…å®¹æè¿°äº†æè®®è€…çš„ç®—æ³•ï¼Œä½†æ˜¯å¯¹äºæ¥å—è€…è€Œè¨€åˆè¯¥æ˜¯æ€æ ·å­çš„å‘¢ï¼Ÿå®ƒå¯ä»¥æ¥æ”¶æ¥è‡ªæè®®è€…çš„ä¸¤ç§è¯·æ±‚ï¼š&lt;em>prepare&lt;/em> è¯·æ±‚å’Œ &lt;em>accept&lt;/em> è¯·æ±‚ã€‚æ¥å—è€…å¯ä»¥å¿½ç•¥ä»»ä½•è¯·æ±‚è€Œä¸å½±å“å®‰å…¨æ€§ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦è®¨è®ºåªåœ¨å“ªäº›æƒ…å†µä¸‹å®ƒå¯ä»¥å“åº”è¯·æ±‚ã€‚å®ƒæ€»ä¼šå“åº” &lt;em>prepare&lt;/em> è¯·æ±‚ï¼›å®ƒä¹Ÿå¯ä»¥å“åº” &lt;em>accept&lt;/em> è¯·æ±‚ï¼Œæ¥å—ææ¡ˆï¼Œåªè¦å®ƒï¼ˆäº‹å…ˆï¼‰æ²¡æœ‰æ‰¿è¯ºä¸è¿™æ ·åšã€‚æ¢å¥è¯è¯´ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>P1a. æ¥å—è€…å¯ä»¥æ¥å—ç¼–å·ä¸º n çš„ææ¡ˆï¼Œåªè¦å®ƒæ²¡æœ‰å“åº”è¿‡ç¼–å·å¤§äº n çš„ prepare è¯·æ±‚
&lt;/code>&lt;/pre>&lt;p>å¯è§ P1a åŒ…å«äº† P1ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç°åœ¨å·²ç»å¾—åˆ°äº†ä¸€ä¸ªè¶³ä»¥æ»¡è¶³å®‰å…¨æ€§å±æ€§çš„ç”¨äºé€‰å®šå€¼çš„å®Œæ•´ç®—æ³•â€”â€”åœ¨å‡è®¾ææ¡ˆå·å”¯ä¸€çš„åŸºç¡€ä¸Šã€‚æœ€ç»ˆçš„ç®—æ³•è¿˜éœ€è¦é€šè¿‡é¢å¤–çš„ä¸€ç‚¹ä¼˜åŒ–æ¥å¾—åˆ°ã€‚&lt;/p>
&lt;p>è®¾æƒ³ä¸€ä¸ªæ¥å—è€…æ”¶åˆ°äº†ä¸€ä¸ªç¼–å·ä¸º &lt;em>n&lt;/em> çš„ &lt;em>prepare&lt;/em> è¯·æ±‚ï¼Œä½†æ˜¯å®ƒå·²ç»å“åº”è¿‡ä¸€ä¸ªç¼–å·æ¯” &lt;em>n&lt;/em> å¤§çš„ &lt;em>prepare&lt;/em> è¯·æ±‚ï¼Œå› æ­¤ä¹Ÿå°±æ‰¿è¯ºäº†ä¸å†æ¥å—ä»»ä½•ç¼–å·ä¸º &lt;em>n&lt;/em> çš„æ–°çš„ææ¡ˆã€‚äºæ˜¯æ¥å—è€…æ²¡æœ‰ç†ç”±è¦å»å“åº”è¿™ä¸ªæ–°çš„ &lt;em>prepare&lt;/em> è¯·æ±‚ï¼Œå› ä¸ºå®ƒå¹¶ä¸ä¼šè€ƒè™‘æ¥å—ç¼–å·ä¸º &lt;em>n&lt;/em> çš„ææ¡ˆï¼Œä¹Ÿå°±æ˜¯æè®®è€…æƒ³è¦æè®®çš„ææ¡ˆã€‚æ‰€ä»¥æˆ‘ä»¬è®©æ¥å—è€…ç›´æ¥å¿½ç•¥è¿™æ ·ä¸€ä¸ª &lt;em>prepare&lt;/em> è¯·æ±‚ã€‚æˆ‘ä»¬ä¹Ÿè®©æ¥å—è€…ç›´æ¥å¿½ç•¥å®ƒå·²ç»æ¥å—çš„ææ¡ˆçš„ &lt;em>prepare&lt;/em> è¯·æ±‚ã€‚&lt;/p>
&lt;p>åŠ ä¸Šè¿™ä¸ªä¼˜åŒ–ï¼Œæ¥å—è€…åªéœ€è¦è®°å½•å®ƒå·²ç»æ¥å—è¿‡çš„æœ€é«˜ç¼–å·çš„ææ¡ˆä»¥åŠå®ƒå·²ç»å“åº”è¿‡çš„æœ€é«˜ç¼–å·çš„ &lt;em>prepare&lt;/em> è¯·æ±‚çš„ç¼–å·å³å¯ã€‚å› ä¸ºæ— è®ºå¤±è´¥ä¸å¦ï¼ŒP2c éƒ½å¿…é¡»ä¿æŒä¸å˜ï¼Œæ‰€ä»¥æ¥å—è€…å¿…é¡»èƒ½å¤Ÿè®°å½•è¿™äº›ä¿¡æ¯ï¼Œå“ªæ€•å®ƒå¯èƒ½å´©æºƒï¼Œä»¥åŠé‡å¯ã€‚æ³¨æ„æè®®è€…æ€»æ˜¯å¯ä»¥æ”¾å¼ƒæŸä¸ªææ¡ˆå¹¶ä¸”è£…ä½œä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿè¿‡â€”â€”åªè¦æè®®è€…ä¸ä¼šå°è¯•ç”¨ç›¸åŒçš„ç¼–å·æè®®å¦ä¸€ä¸ªææ¡ˆã€‚&lt;/p>
&lt;p>å°†æè®®è€…å’Œæ¥å—è€…çš„è¡Œä¸ºéƒ½æ”¾åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªç®—æ³•çš„æ“ä½œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªé˜¶æ®µï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>é˜¶æ®µ 1ï¼š
ï¼ˆaï¼‰æè®®è€…é€‰æ‹©ä¸€ä¸ªææ¡ˆç¼–å· nï¼Œå‘â€œå¤§å¤šæ•°â€æ¥å—è€…å‘é€ä¸€ä¸ªå¸¦æœ‰ç¼–å· n çš„ prepare è¯·æ±‚ï¼›
ï¼ˆbï¼‰å¦‚æœæ¥å—è€…æ”¶åˆ°ä¸€ä¸ªç¼–å·ä¸º n çš„ prepare è¯·æ±‚ï¼Œä¸” n æ¯”å®ƒå·²ç»å“åº”è¿‡çš„ä»»ä½•ä¸€ä¸ª prepare è¯·æ±‚çš„ç¼–å·éƒ½å¤§ï¼Œåˆ™å®ƒä¼šå‘è¿™ä¸ªè¯·æ±‚å›å¤å“åº”ï¼Œå†…å®¹åŒ…æ‹¬ï¼šä¸€ä¸ªä¸å†æ¥å—ä»»ä½•ç¼–å·å°äº n çš„ææ¡ˆçš„æ‰¿è¯ºï¼Œä»¥åŠå®ƒå·²ç»æ¥å—è¿‡çš„æœ€å¤§ç¼–å·çš„ææ¡ˆï¼ˆå‡å¦‚æœ‰çš„è¯ï¼‰ã€‚
é˜¶æ®µ 2ï¼š
ï¼ˆaï¼‰å¦‚æœæè®®è€…ä»â€œå¤§å¤šæ•°â€æ¥å—è€…æ”¶åˆ°äº†å¯¹å®ƒå‰é¢å‘å‡ºçš„ prepare è¯·æ±‚çš„å“åº”ï¼Œå®ƒå°±ä¼šæ¥ç€ç»™é‚£æ¯ä¸€ä¸ªæ¥å—è€…å‘é€ä¸€ä¸ªé’ˆå¯¹ç¼–å·ä¸º n ä¸”å€¼ä¸º v çš„ææ¡ˆçš„ accept è¯·æ±‚ï¼Œè€Œ v å°±æ˜¯å®ƒæ‰€æ”¶åˆ°çš„å“åº”ä¸­æœ€å¤§ç¼–å·çš„ææ¡ˆçš„å€¼ï¼Œæˆ–è€…æ˜¯å®ƒåœ¨æ‰€æœ‰å“åº”éƒ½è¡¨æ˜æ²¡æœ‰æ¥å—è¿‡ä»»ä½•ææ¡ˆçš„å‰æä¸‹è‡ªç”±é€‰æ‹©çš„å€¼ vï¼›
ï¼ˆbï¼‰å¦‚æœæ¥å—è€…æ”¶åˆ°äº†ä¸€ä¸ªé’ˆå¯¹ç¼–å·ä¸º n çš„ææ¡ˆçš„ accept è¯·æ±‚ï¼Œå®ƒå°±ä¼šæ¥å—è¿™ä¸ªè¯·æ±‚ï¼Œé™¤éå®ƒä¹‹å‰å·²ç»å“åº”è¿‡ç¼–å·å¤§äº n çš„ request è¯·æ±‚ã€‚
&lt;/code>&lt;/pre>&lt;p>æè®®è€…å¯ä»¥æè®®å¤šä¸ªææ¡ˆï¼Œåªè¦å®ƒåœ¨æ¯ä¸€ä¸ªææ¡ˆä¸­éƒ½éµå¾ªä¸Šé¢çš„ç®—æ³•ã€‚å®ƒä¹Ÿå¯ä»¥åœ¨åè®®ä¸­é—´çš„ä»»ä½•æ—¶å€™ä¸¢å¼ƒææ¡ˆã€‚ï¼ˆæ­£ç¡®æ€§è¿˜ä¼šè¢«ä¿æŒï¼Œå“ªæ€•æ˜¯å¯¹åºŸå¼ƒææ¡ˆçš„è¯·æ±‚æˆ–è€…å“åº”å¯èƒ½åœ¨ææ¡ˆè¢«ä¸¢å¼ƒå¾ˆä¹…ä¹‹åæ‰åˆ°è¾¾ç›®çš„åœ°ï¼‰ã€‚åœ¨æŸäº›æè®®è€…å·²ç»å¼€å§‹å°è¯•æè®®æ›´é«˜ç¼–å·çš„ææ¡ˆçš„æƒ…å†µä¸‹ï¼Œï¼ˆå°½æ—©ï¼‰æ”¾å¼ƒï¼ˆå½“å‰è¾ƒä½ç¼–å·çš„ï¼‰ææ¡ˆæˆ–è®¸æ˜¯ä¸€ä¸ªå¥½çš„ä¸»æ„ã€‚æ‰€ä»¥ï¼Œå¦‚æœæ¥å—è€…ç”±äºå®ƒè‡ªèº«å·²ç»æ”¶åˆ°äº†æ›´é«˜ç¼–å·çš„ &lt;em>prepare&lt;/em> è¯·æ±‚è€Œé€‰æ‹©å¿½ç•¥ï¼ˆå½“å‰çš„ï¼‰&lt;em>prepare&lt;/em> æˆ–è€… &lt;em>accept&lt;/em> è¯·æ±‚ï¼Œé‚£å®ƒåº”è¯¥é€šçŸ¥æè®®è€…ï¼Œæè®®è€…åº”è¯¥åœ¨æ”¶åˆ°é€šçŸ¥åæ”¾å¼ƒææ¡ˆã€‚æ€»ä½“è€Œè¨€ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸ä¼šå½±å“æ­£ç¡®æ€§çš„æ€§èƒ½ä¼˜åŒ–ã€‚&lt;/p>
&lt;h4 id="23-è·çŸ¥é€‰å®šçš„å€¼">2.3 è·çŸ¥é€‰å®šçš„å€¼&lt;/h4>
&lt;p>ä¸ºäº†è·çŸ¥å€¼å·²è¢«é€‰å®šï¼Œå­¦ä¹ è€…å¿…é¡»æ‰¾å‡ºæŸä¸ªå·²ç»è¢«å¤§å¤šæ•°æ¥å—è€…æ¥å—çš„ææ¡ˆã€‚æœ€æ˜¾è€Œæ˜“è§çš„ç®—æ³•å°±æ˜¯è®©æ¯ä¸€ä¸ªæ¥å—è€…ä¸€æ—¦æ¥å—äº†ææ¡ˆï¼Œå°±å“åº”ç»™æ‰€æœ‰å­¦ä¹ è€…ï¼Œå¹¶ç»™å®ƒä»¬å‘é€æ¥å—äº†çš„ææ¡ˆä¿¡æ¯ã€‚è¿™ç§æ–¹æ³•å…è®¸å­¦ä¹ è€…ä»¬å°½å¯èƒ½å¿«åœ°æ‰¾å‡ºè¢«é€‰å®šçš„å€¼ï¼Œä½†è¿™ç§æ–¹æ³•ä¹Ÿè¦æ±‚æ¯ä¸ªæ¥å—è€…è¦å“åº”æ¯ä¸ªå­¦ä¹ è€…â€”â€”å“åº”çš„æ•°é‡ç­‰äºæ¥å—è€…æ•°é‡å’Œå­¦ä¹ è€…æ•°é‡çš„ä¹˜ç§¯ã€‚&lt;/p>
&lt;p>æ²¡æœ‰æ‹œå åº­å¼é”™è¯¯çš„è¿™æ ·ä¸€ä¸ªå‡è®¾ä½¿å¾—ä¸€ä¸ªå­¦ä¹ è€…å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡å…¶ä»–çš„å­¦ä¹ è€…æ¥è·çŸ¥æŸä¸ªå€¼å·²è¢«æ¥å—çš„äº‹å®ã€‚æˆ‘ä»¬å¯ä»¥è®©æ¥å—è€…å°†å®ƒä»¬çš„æ¥å—äº‹ä»¶å“åº”ç»™æŸä¸ªç‰¹å®šçš„å­¦ä¹ è€…ï¼Œè¿™ä¸ªç‰¹å®šçš„å­¦ä¹ è€…è¦è´Ÿè´£åœ¨æ¯æ¬¡ä¸€ä¸ªå€¼è¢«é€‰å®šä¹‹åé€šçŸ¥å…¶ä»–çš„å¤šä¸ªå­¦ä¹ è€…ã€‚è¿™ç§æ–¹æ³•è¦æ±‚æ‰€æœ‰çš„å­¦ä¹ è€…èŠ±è´¹é¢å¤–ä¸€è½®çš„æ—¶é—´ç”¨äºè·çŸ¥è¢«é€‰å®šçš„å€¼ï¼Œä¹Ÿé™ä½äº†å¯é æ€§ï¼Œå› ä¸ºé‚£ä¸ªç‰¹å®šçš„å­¦ä¹ è€…å¯èƒ½ä¼šæ•…éšœã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ³•è¦æ±‚çš„å“åº”æ•°é‡åªç­‰äºæ¥å—è€…çš„æ•°é‡å’Œå­¦ä¹ è€…çš„æ•°é‡ä¹‹å’Œã€‚&lt;/p>
&lt;p>æ›´ä¸€èˆ¬çš„ï¼Œæ¥å—è€…å¯ä»¥å°†å®ƒä»¬çš„æ¥å—äº‹ä»¶å“åº”ç»™ç”±å¤šä¸ªç‰¹å®šçš„å­¦ä¹ è€…ç»„æˆçš„æŸä¸ªé›†åˆï¼Œé›†åˆä¸­çš„æ¯ä¸ªå­¦ä¹ è€…éƒ½ä¼šåœ¨æ¯æ¬¡ä¸€ä¸ªå€¼è¢«é€‰å®šä¹‹åé€šçŸ¥æ‰€æœ‰çš„å­¦ä¹ è€…ã€‚ä½¿ç”¨è¿™æ ·ä¸€ä¸ªè¾ƒå¤§çš„ç‰¹å®šçš„å­¦ä¹ è€…ç»„æˆçš„é›†åˆå¯ä»¥åœ¨æ›´å¤§çš„é€šä¿¡å¤æ‚åº¦ä¸Šæä¾›æ›´å¤§çš„å¯é æ€§ã€‚&lt;/p>
&lt;p>ç”±äºæ¶ˆæ¯ä¸¢å¤±ï¼Œå€¼å¯èƒ½åœ¨å­¦ä¹ è€…æ— æ³•å‘ç°çš„æƒ…å†µä¸‹è¢«é€‰å®šã€‚å­¦ä¹ è€…å¯ä»¥è¯¢é—®æ¥å—è€…ï¼šç°åœ¨å·²ç»æ¥å—äº†ä»€ä¹ˆææ¡ˆï¼Ÿä½†æ˜¯æ¥å—è€…çš„å¤±æ•ˆå¯èƒ½å¯¼è‡´ä¸å¯èƒ½çŸ¥é“æ˜¯å¦æœ‰ä¸€ä¸ªå¤§å¤šæ•°çš„ï¼ˆæ¥å—è€…ï¼‰å·²ç»æ¥å—äº†æŸä¸ªç‰¹å®šçš„ææ¡ˆã€‚åœ¨é‚£ç§åœºæ™¯ä¸‹ï¼Œå­¦ä¹ è€…åªèƒ½åœ¨ä¸€ä¸ªæ–°çš„ææ¡ˆè¢«é€‰å®šçš„æƒ…å†µä¸‹æ‰èƒ½æ‰¾å‡ºå“ªä¸ªå€¼è¢«é€‰å®šäº†ã€‚å¦‚æœå­¦ä¹ è€…éœ€è¦çŸ¥é“ä¸€ä¸ªå€¼æ˜¯å¦å·²ç»è¢«é€‰å®šï¼Œå®ƒå¯ä»¥è®©æè®®è€…ä½¿ç”¨ä¸Šé¢æè¿°çš„ç®—æ³•æè®®ä¸€ä¸ªææ¡ˆå³å¯ã€‚&lt;/p>
&lt;h4 id="24-å¯è¿›è¡Œæ€§">2.4 å¯è¿›è¡Œæ€§&lt;/h4>
&lt;p>æ„å»ºè¿™æ ·ä¸€ä¸ªåœºæ™¯æ˜¯å®¹æ˜“çš„ï¼šä¸¤ä¸ªæè®®è€…ç›¸ç»§æè®®ä¸€ç³»åˆ—é€’å¢ç¼–å·çš„ææ¡ˆï¼Œä½†æ˜¯æ²¡æœ‰å“ªä¸€ä¸ªææ¡ˆèƒ½è¢«é€‰å®šã€‚æè®®è€… &lt;em>p&lt;/em> å®Œæˆäº†ç¼–å· &lt;em>n1&lt;/em> çš„ææ¡ˆçš„é˜¶æ®µ1ï¼Œæ¥ç€å¦ä¸€ä¸ªæè®®è€… &lt;em>q&lt;/em> ä¹Ÿå®Œæˆäº†ç¼–å· &lt;em>n2&lt;/em>ï¼ˆ&lt;em>n2 &amp;gt; n1&lt;/em>ï¼‰çš„ææ¡ˆçš„é˜¶æ®µ1.ç”±äºæ¥å—è€…å·²ç»æ‰¿è¯ºä¸ä¼šå†æ¥å—ä»»ä½•ç¼–å·å°äº &lt;em>n2&lt;/em> çš„æ–°ææ¡ˆï¼Œæ‰€ä»¥æè®®è€… &lt;em>p&lt;/em> åœ¨é˜¶æ®µ2ä¸ºææ¡ˆ &lt;em>n1&lt;/em> å‘é€çš„ &lt;em>accept&lt;/em> è¯·æ±‚ä¼šè¢«å¿½ç•¥ã€‚æ‰€ä»¥ï¼Œæè®®è€… &lt;em>p&lt;/em> åˆæ¥ç€å¼€å§‹å¹¶ä¸”å®Œæˆäº†ä¸€ä¸ªæ–°çš„ææ¡ˆ &lt;em>n3&lt;/em>ï¼ˆ&lt;em>n3 &amp;gt; n2&lt;/em>ï¼‰çš„é˜¶æ®µ1ï¼Œå¯¼è‡´ææ¡ˆ &lt;em>q&lt;/em> çš„é˜¶æ®µ2çš„ &lt;em>accept&lt;/em> è¯·æ±‚ä¹Ÿè¢«å¿½ç•¥äº†ï¼Œä»¥æ­¤ç±»æ¨â€¦â€¦&lt;/p>
&lt;p>ä¸ºäº†ä¿è¯ï¼ˆè¿‡ç¨‹ï¼‰å¯è¿›è¡Œï¼Œä¸€ä¸ªç‰¹å®šçš„æè®®è€…å¿…é¡»è¢«é€‰ä¸ºå”¯ä¸€ä¸€ä¸ªæè®®ææ¡ˆçš„ã€‚å¦‚æœè¿™ä¸ªç‰¹å®šçš„æè®®è€…å¯ä»¥æˆåŠŸåœ°å’Œå¤§å¤šæ•°æ¥å—è€…é€šä¿¡ï¼Œå¹¶ä¸”å®ƒä½¿ç”¨äº†ç¼–å·æ¯”ä»»ä½•å·²ç»ä½¿ç”¨çš„ç¼–å·å¤§çš„ææ¡ˆï¼Œé‚£ä¹ˆå®ƒå°†ä¼šæˆåŠŸå®Œæˆæè®®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œææ¡ˆä¼šè¢«æ¥å—ã€‚é€šè¿‡åœ¨å‘ç°æŸä¸ªè¯·æ±‚å·²ç»ä½¿ç”¨äº†æ›´é«˜çš„ææ¡ˆç¼–å·çš„æƒ…å†µä¸‹ä¸»åŠ¨æ”¾å¼ƒææ¡ˆç„¶åé‡è¯•ï¼ˆé˜¶æ®µ1ï¼‰ï¼Œè¿™ä¸ªç‰¹å®šçš„æè®®è€…ç»ˆå°†èƒ½å¤Ÿé€‰åˆ°ä¸€ä¸ªè¶³å¤Ÿé«˜çš„ææ¡ˆç¼–å·ã€‚&lt;/p>
&lt;p>å¦‚æœç³»ç»Ÿæœ‰è¶³å¤Ÿå¤šçš„ç»„ä»¶ï¼ˆæè®®è€…ã€æ¥å—è€…ä»¥åŠé€šä¿¡ç½‘ç»œï¼‰æ­£å¸¸å·¥ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡é€‰ä¸¾ä¸€ä¸ªå•ä¸€çš„ç‰¹å®šçš„æè®®è€…æ¥å®ç°æ´»æ€§ã€‚Fischer, Lynch å’Œ Patterson çš„è‘—åï¼ˆå®éªŒï¼‰ç»“æœæŒ‡å‡ºï¼šé€‰ä¸¾ä¸€ä¸ªæè®®è€…çš„å¯é ç®—æ³•å¿…é¡»ä½¿ç”¨éšæœºæ€§æˆ–è€…å®æ—¶æ€§â€”â€”ä¸¾ä¾‹æ¥è¯´ï¼Œä½¿ç”¨è¶…æ—¶æœºåˆ¶ã€‚æ— è®ºå¦‚ä½•ï¼Œä¸ç®¡é€‰ä¸¾æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œå®‰å…¨æ€§éƒ½æ˜¯å¯ä»¥ä¿è¯çš„ã€‚&lt;/p>
&lt;h4 id="25-å®ç°">2.5 å®ç°&lt;/h4>
&lt;p>Paxos ç®—æ³•å‡è®¾äº†ä¸€ä¸ªå¤šè¿›ç¨‹ç»„æˆçš„ç½‘ç»œã€‚åœ¨å®ƒçš„ä¸€è‡´æ€§ç®—æ³•é‡Œï¼Œæ¯ä¸ªè¿›ç¨‹åŒæ—¶æ‰®æ¼”äº†æè®®è€…ã€æ¥å—è€…å’Œå­¦ä¹ è€…ã€‚è¿™ä¸ªç®—æ³•ä¹Ÿä¼šé€‰å®šä¸€ä¸ª leaderï¼Œç”±å®ƒåŒæ—¶æ‰®æ¼”ç‰¹å®šçš„æè®®è€…ä»¥åŠç‰¹å®šçš„å­¦ä¹ è€…ã€‚Paxos ä¸€è‡´æ€§ç®—æ³•æ­£æ˜¯ä¸Šé¢æè¿°çš„ç®—æ³•ï¼Œå…¶ä¸­è¯·æ±‚å’Œå“åº”éƒ½ä½œä¸ºæ™®é€šæ¶ˆæ¯å‘é€ã€‚ï¼ˆå“åº”çš„æ¶ˆæ¯éƒ½ä¼šç”¨å¯¹åº”çš„ææ¡ˆçš„ç¼–å·åšæ ‡è®°ï¼Œä»¥é˜²æ··æ·†ã€‚ï¼‰éœ€è¦æŒä¹…åŒ–å­˜å‚¨å™¨åœ¨æ•…éšœæ—¶å‘æŒ¥ä½œç”¨ï¼Œç”¨äºç»´æŠ¤æ¥å—è€…å¿…é¡»è®°ä½çš„ä¿¡æ¯ã€‚æ¥å—è€…éœ€è¦åœ¨çœŸæ­£å‘å‡ºå“åº”ä¹‹å‰åœ¨æŒä¹…åŒ–å­˜å‚¨ä¸Šè®°å½•å®ƒè®¡åˆ’çš„å“åº”ã€‚&lt;/p>
&lt;p>å‰©ä¸‹çš„å°±æ˜¯æè¿°ä¸€ç§èƒ½å¤Ÿä¿è¯ä¸åŒçš„ææ¡ˆä¸ä¼šä½¿ç”¨ç›¸åŒçš„ç¼–å·æè®®çš„æœºåˆ¶ã€‚åªè¦ä¸åŒçš„æè®®è€…ä»ä¸ç›¸äº¤çš„ç¼–å·é›†åˆä¸­é€‰æ‹©ç¼–å·ï¼Œè¿™ä¸¤ä¸ªä¸åŒçš„æè®®è€…æè®®çš„ææ¡ˆå°±ä¸€å®šä¸ä¼šæ‹¥æœ‰ç›¸åŒçš„ç¼–å·ã€‚æ¯ä¸ªæè®®è€…åœ¨ç¨³å®šçš„å­˜å‚¨ä¸Šè®°å½•å„è‡ªå·²ç»å°è¯•æè®®çš„æœ€é«˜ç¼–å·çš„ææ¡ˆï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªæ¯”å®ƒå·²ç»ç”¨è¿‡çš„ç¼–å·æ›´é«˜çš„ææ¡ˆç¼–å·å†æ¬¡å¼€å§‹é˜¶æ®µ1çš„è¿‡ç¨‹ã€‚&lt;/p>
&lt;h3 id="3-å®ç°ä¸€ä¸ªçŠ¶æ€æœº">3 å®ç°ä¸€ä¸ªçŠ¶æ€æœº&lt;/h3>
&lt;p>å®ç°åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ç§ç®€å•æ–¹å¼æ˜¯ä½œä¸ºå‘ä¸­å¤®æœåŠ¡å™¨å‘å‡ºå‘½ä»¤çš„å®¢æˆ·ç«¯çš„é›†åˆã€‚å¯ä»¥å°†æœåŠ¡å™¨æè¿°ä¸ºä¸€ä¸ªæŒ‰ç…§æ—¶åºæ‰§è¡Œå®¢æˆ·ç«¯å‘½ä»¤çš„ç¡®å®šçŠ¶æ€æœºã€‚è¿™ä¸ªçŠ¶æ€æœºæ‹¥æœ‰ä¸€ä¸ªå½“å‰çš„çŠ¶æ€ï¼Œå®ƒé€šè¿‡æ¥å—ä¸€ä¸ªå‘½ä»¤ä½œä¸ºè¾“å…¥æ¥æ‰§è¡Œä¸€ä¸ªæ­¥éª¤ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ªç›¸åº”çš„è¾“å‡ºä»¥åŠä¸€ä¸ªæ–°çš„çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼šä¸€ä¸ªåˆ†å¸ƒå¼çš„é“¶è¡Œç³»ç»Ÿçš„å®¢æˆ·ç«¯å¯èƒ½æ˜¯å‡ºçº³å‘˜ï¼Œè€ŒçŠ¶æ€æœºçš„çŠ¶æ€åˆ™ç”±æ‰€æœ‰ç”¨æˆ·çš„è´¦å·ä½™é¢ç»„æˆã€‚ä¸€ä¸ªå–æ¬¾æ“ä½œå¯ä»¥é€šè¿‡è¿è¡Œä¸€ä¸ªçŠ¶æ€æœºå‘½ä»¤æ¥å®Œæˆï¼šè¿™ä¸ªå‘½ä»¤å½“ä¸”ä»…å½“ä½™é¢å¤§äºå–æ¬¾æ•°é‡çš„æ—¶å€™æ‰å¯ä»¥æ‰£å‡è´¦æˆ·ä½™é¢ï¼Œå¹¶ç”Ÿæˆæ–°æ—§ä½™é¢ä½œä¸ºè¾“å‡ºã€‚&lt;/p>
&lt;p>ä½¿ç”¨å•ä¸ªä¸­å¤®æœåŠ¡å™¨çš„å®ç°æ–¹æ¡ˆä¼šéšç€æœåŠ¡å™¨çš„å´©æºƒè€Œå¤±æ•ˆã€‚äºæ˜¯ï¼Œæˆ‘ä»¬æƒ³åˆ°äº†å¯ä»¥ä½¿ç”¨ä¸€ç»„æœåŠ¡å™¨ï¼Œæ¯ä¸ªæœåŠ¡å™¨å½¼æ­¤ç‹¬ç«‹åœ°å®ç°åŒæ ·çš„çŠ¶æ€æœºã€‚ç”±äºçŠ¶æ€æœºæ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥å¦‚æœæ‰€æœ‰æœåŠ¡å™¨éƒ½æ‰§è¡Œäº†ç›¸åŒçš„ä¸€ç³»åˆ—å‘½ä»¤ï¼Œé‚£ä¹ˆæ‰€æœ‰æœåŠ¡å™¨éƒ½å°†ä¼šäº§ç”ŸåŒæ ·çš„ä¸€ç³»åˆ—çŠ¶æ€ä»¥åŠè¾“å‡ºã€‚ä¸€ä¸ªå‘å‡ºå‘½ä»¤çš„å®¢æˆ·ç«¯åˆ™å¯ä»¥ä»»æ„é‡‡ç”¨ä¸€å°æœåŠ¡å™¨ç”Ÿæˆçš„è¾“å‡ºã€‚&lt;/p>
&lt;p>ä¸ºäº†ä¿è¯æ‰€æœ‰æœåŠ¡å™¨è¿è¡Œç›¸åŒçš„ä¸€ç³»åˆ—çŠ¶æ€æœºå‘½ä»¤ï¼Œæˆ‘ä»¬ï¼ˆéœ€è¦ï¼‰å®ç° Paxos ä¸€è‡´æ€§ç®—æ³•çš„ä¸€ç³»åˆ—ç‹¬ç«‹çš„å®ä¾‹ï¼Œç¬¬ &lt;em>i&lt;/em> ä¸ªé€‰å®šçš„å€¼å°±æ˜¯åºåˆ—ä¸­çš„ç¬¬ &lt;em>i&lt;/em> ä¸ªçŠ¶æ€æœºå‘½ä»¤ã€‚æ¯ä¸€ä¸ªæœåŠ¡å™¨éƒ½åœ¨æ¯ä¸€ä¸ªå®ä¾‹ä¸­æ‰®æ¼”è¿™ä¸ªç®—æ³•çš„æ‰€æœ‰è§’è‰²ï¼ˆæè®®è€…ã€æ¥å—è€…å’Œå­¦ä¹ è€…ï¼‰ã€‚å°±ç°åœ¨è€Œè¨€ï¼Œæˆ‘å‡è®¾æœåŠ¡å™¨çš„é›†åˆæ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥è¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„æ‰€æœ‰å®ä¾‹ä½¿ç”¨ç›¸åŒçš„ä¸€ç¾¤ä»£ç†ã€‚&lt;/p>
&lt;p>åœ¨æ­£å¸¸æ“ä½œä¸­ï¼Œä¸€ä¸ªå•ç‹¬çš„æœåŠ¡å™¨è¢«é€‰ä¸¾ä¸ºäº† leaderï¼Œç”±å®ƒåœ¨è¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„æ‰€æœ‰å®ä¾‹ä¸­æ‰®æ¼”ç‰¹å®šçš„æè®®è€…ï¼ˆåªæœ‰å®ƒä¼šå°è¯•æè®®ææ¡ˆï¼‰ã€‚ï¼ˆå¤šä¸ªï¼‰å®¢æˆ·ç«¯å‘é€å‘½ä»¤åˆ° leaderï¼Œleader å†³å®šæ¯ä¸ªå‘½ä»¤çš„æ—¶åºã€‚å‡å¦‚ leader å†³å®šæŸæ¡å®¢æˆ·ç«¯å‘½ä»¤åº”è¯¥æ˜¯ç¬¬ 135 ä¸ªå‘½ä»¤ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå°è¯•é€šè¿‡è¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„ç¬¬135ä¸ªå®ä¾‹æ¥æè®®é€‰å®šä¸€ä¸ªææ¡ˆï¼Œå‘½ä»¤æœ¬èº«å°±æ˜¯è¿™ä¸ªææ¡ˆçš„å€¼ã€‚è¿™ä¸ªè¿‡ç¨‹é€šå¸¸ä¼šé¡ºåˆ©å®Œæˆã€‚ä½†å®ƒä¹Ÿå¯èƒ½å› ä¸ºæ•…éšœè€Œå¤±è´¥ï¼Œæˆ–è€…å› ä¸ºæœ‰å¦ä¸€ä¸ªæœåŠ¡å™¨è®¤ä¸ºå®ƒè‡ªå·±æ‰æ˜¯ leader å¹¶ä¸”å®ƒè®¤ä¸ºç¬¬ 135 ä¸ªå‘½ä»¤åº”è¯¥å¦æœ‰ä»–å€¼ã€‚ä½†æ˜¯è¿™ä¸ªä¸€è‡´æ€§ç®—æ³•ç¡®ä¿ç¬¬ 135 ä½ä¸Šæœ€å¤šåªæœ‰ä¸€ä¸ªå‘½ä»¤èƒ½å¤Ÿè¢«é€‰å®šã€‚&lt;/p>
&lt;p>åœ¨ Paxos ä¸€è‡´æ€§ç®—æ³•é‡Œï¼Œè¿™ä¸ªæ–¹æ³•çš„æ•ˆç‡çš„å…³é”®åœ¨äºï¼Œè¢«æè®®çš„å€¼è¦åˆ°é˜¶æ®µ2æ‰ä¼šè¢«é€‰å®šã€‚å›æƒ³ä¸€ä¸‹ï¼Œåœ¨å®Œæˆæè®®è€…çš„ç®—æ³•çš„é˜¶æ®µ1ä¹‹åï¼Œè¦ä¹ˆè¦æè®®çš„å€¼å·²ç»ç¡®å®šä¸‹æ¥ï¼Œè¦ä¹ˆæè®®è€…å¯ä»¥è‡ªç”±æè®®ä»»ä½•å€¼ã€‚&lt;/p>
&lt;p>æˆ‘ç°åœ¨å°†è¦æè¿° Paxos çŠ¶æ€æœºçš„å®ç°æ˜¯å¦‚ä½•åœ¨æ­£å¸¸æ“ä½œä¸‹å‘æŒ¥ä½œç”¨çš„ã€‚ç¨åçš„è¯ï¼Œæˆ‘ä¹Ÿå°†ä¼šè®¨è®ºæˆ‘ä»¬å¯èƒ½ä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ã€‚æˆ‘è€ƒè™‘çš„æ˜¯åœ¨å‰ä¸€ä¸ª leader åˆšå‘ç”Ÿæ•…éšœè€Œæ–°çš„ leader å·²ç»è¢«é€‰ä¸¾å‡ºæ¥çš„æ—¶å€™ï¼Œä¼šæœ‰ä»€ä¹ˆäº‹æƒ…å‘ç”Ÿã€‚ï¼ˆç³»ç»Ÿå¯åŠ¨æ˜¯ä¸€ä¸ªç‰¹æ®Šåœºæ™¯ï¼Œè¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰ä»»ä½•å‘½ä»¤è¢«æè®®ï¼‰&lt;/p>
&lt;p>è¿™ä¸ªæ–°çš„ leader ä¹Ÿæ˜¯è¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„æ‰€æœ‰å®ä¾‹ä¸­çš„å­¦ä¹ è€…ï¼Œå®ƒåº”è¯¥çŸ¥é“å¤§å¤šæ•°å·²ç»è¢«é€‰å®šçš„å‘½ä»¤ã€‚å‡è®¾å®ƒçŸ¥é“ 1-134ã€138 ä»¥åŠ 139 å·å‘½ä»¤ï¼Œä¹Ÿå°±æ˜¯ä¸€è‡´æ€§ç®—æ³•çš„ 1-134ã€138 ä»¥åŠ 139 å·å®ä¾‹çš„å€¼ã€‚ï¼ˆæˆ‘ä»¬ç¨åå°†ä¼šçœ‹åˆ°å‘½ä»¤åºåˆ—ä¸­çš„è¿™æ ·ä¸€ä¸ªç©ºç¼ºæ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚ï¼‰ç„¶åå®ƒæ‰§è¡Œå®ä¾‹135-137ä»¥åŠæ‰€æœ‰å¤§äº139çš„å®ä¾‹çš„é˜¶æ®µ1ï¼Œå‡è®¾è¿™äº›æ‰§è¡Œçš„ç»“æœåªç¡®å®šäº†å®ä¾‹ 135 å’Œ 140 ä¸­æè®®çš„å€¼ï¼Œä½†æ˜¯å…¶ä»–å®ä¾‹ä¸­æ²¡æœ‰æè®®å€¼çš„çº¦æŸ&lt;sup id="fnref:14">&lt;a href="#fn:14" class="footnote-ref" role="doc-noteref">14&lt;/a>&lt;/sup>ã€‚leader æ‰§è¡Œå®ä¾‹ 135 å’Œ 140 çš„é˜¶æ®µ2ï¼Œå¹¶å› æ­¤å¯ä»¥é€‰å®š 135 å’Œ 140 å·å‘½ä»¤ã€‚&lt;/p>
&lt;p>leader è‡ªèº«å°±åƒå…¶ä»–å‘ leader å­¦ä¹  leader æ‰€çŸ¥é“çš„æ‰€æœ‰å‘½ä»¤çš„åˆ«çš„æœåŠ¡å™¨ä¸€æ ·ï¼Œç°åœ¨å¯ä»¥è¿è¡Œå‘½ä»¤ 1-135ã€‚å› ä¸º136å·å’Œ137å·å‘½ä»¤è¿˜æ²¡æœ‰é€‰å®šï¼Œæ‰€ä»¥å®ƒè¿˜ä¸èƒ½è¿è¡Œ 138-140 å·å‘½ä»¤ï¼Œå°½ç®¡å®ƒçŸ¥é“ 138-140 å·å‘½ä»¤ã€‚äºæ˜¯ï¼Œæˆ‘ä»¬è®©å®ƒé€šè¿‡æè®®å°†ä¸€ä¸ªç‰¹æ®Šçš„ä¸ä¼šå¯¼è‡´çŠ¶æ€æœºçŠ¶æ€åˆ‡æ¢çš„â€œno-opâ€å‘½ä»¤ä½œä¸ºç¬¬136å·å’Œ137å·å‘½ä»¤ï¼ˆå®ƒå¯ä»¥é€šè¿‡æ‰§è¡Œä¸€è‡´æ€§ç®—æ³•çš„ 136 å·å’Œ 137 å·å®ä¾‹çš„é˜¶æ®µ 2 æ¥å®Œæˆï¼‰ï¼Œä»¥æ­¤å¿«é€Ÿå¡«è¡¥ç©ºç¼ºã€‚ä¸€æ—¦è¿™äº› no-op å‘½ä»¤è¢«é€‰å®šï¼Œé‚£ 138-140 å·å‘½ä»¤å°±å¯ä»¥è¢«æ‰§è¡Œäº†ã€‚&lt;/p>
&lt;p>ç°åœ¨ä» 1 åˆ° 140 çš„å‘½ä»¤éƒ½è¢«é€‰å®šäº†ã€‚ leader å®Œæˆäº†ä¸€è‡´æ€§ç®—æ³•ä¸­å¤§äº 140 çš„æ‰€æœ‰å®ä¾‹çš„é˜¶æ®µ 1ï¼Œå®ƒå¯ä»¥åœ¨è¿™äº›ï¼ˆå®Œæˆé˜¶æ®µ1çš„ï¼‰å®ä¾‹çš„é˜¶æ®µ2ä¸­è‡ªç”±åœ°æè®®ä»»æ„çš„å€¼ã€‚å®ƒç»™æŸä¸ªå®¢æˆ·ç«¯è¯·æ±‚çš„ä¸‹ä¸€ä¸ªå‘½ä»¤åˆ†é…äº† 141 å·å‘½ä»¤ï¼ŒæŠŠå®ƒä½œä¸ºè¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„ 141 å·å®ä¾‹çš„é˜¶æ®µ2æè®®çš„å€¼ã€‚å®ƒæ¥ç€å°†å®ƒæ”¶åˆ°çš„ä¸‹ä¸€ä¸ªå®¢æˆ·ç«¯å‘½ä»¤æè®®ä¸ºç¬¬ 142 å·å‘½ä»¤ï¼Œä»¥æ­¤ç±»æ¨ã€‚&lt;/p>
&lt;p>leader å¯ä»¥åœ¨å®ƒè·çŸ¥å®ƒæè®®çš„ 141 å·å‘½ä»¤å·²è¢«é€‰å®šä¹‹å‰æè®® 142 å·å‘½ä»¤ã€‚å®ƒåœ¨æè®®ç¬¬ 141 å·å‘½ä»¤ä¸­å‘é€çš„æ‰€æœ‰æ¶ˆæ¯æœ‰å¯èƒ½ä¸¢å¤±ï¼Œè€Œç¬¬ 142 å·å‘½ä»¤ä¼šåœ¨å…¶ä»–æœåŠ¡å™¨è·çŸ¥åˆ° leader æè®®çš„ç¬¬ 141 å·å‘½ä»¤ä¹‹å‰è¢«é€‰å®šã€‚å½“ leader åœ¨å®ä¾‹ 141 ä¸­æ²¡æœ‰æ”¶åˆ°å¯¹å®ƒçš„é˜¶æ®µ2çš„é¢„æœŸå“åº”æ—¶ï¼Œå®ƒå°†ä¼šé‡å‘è¿™äº›æ¶ˆæ¯ã€‚å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œå®ƒæè®®çš„å‘½ä»¤ä¼šè¢«é€‰å®šã€‚æ— è®ºå¦‚ä½•ï¼Œå®ƒè¿˜æ˜¯æœ‰å¯èƒ½åœ¨å‰é¢æœ‰å¤±è´¥ï¼Œåœ¨é€‰å®šçš„å‘½ä»¤çš„åºåˆ—ä¸Šç•™ä¸‹ä¸€æ®µç©ºç¼ºã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå‡è®¾ä¸€ä¸ª leader å¯ä»¥æå‰è·å¾— &lt;em>Î±&lt;/em> ä¸ªå‘½ä»¤â€”â€”ä¹Ÿå°±æ„å‘³ç€ï¼Œå®ƒå¯ä»¥åœ¨ 1 åˆ° i å·å‘½ä»¤è¢«é€‰å®šä¹‹åæè®®ç¬¬ &lt;em>i&lt;/em> + 1 åˆ° &lt;em>i&lt;/em> + &lt;em>Î±&lt;/em> å·å‘½ä»¤ã€‚ä¸€ä¸ªå¤šè¾¾ &lt;em>Î±&lt;/em> - 1 ä¸ªå‘½ä»¤çš„ç©ºç¼ºå¯èƒ½éšä¹‹å½¢æˆã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæ–°çš„è¢«é€‰å®šçš„ leader æ‰§è¡Œä¸€è‡´æ€§ç®—æ³•ä¸­çš„æ— é™å¤šçš„å®ä¾‹çš„é˜¶æ®µ1â€”â€”å¦‚æœæ˜¯åœ¨ä¸Šé¢çš„åœºæ™¯ä¸­ï¼Œå°±æ˜¯å®ä¾‹ 135-137ï¼Œä»¥åŠæ‰€æœ‰å¤§äº139çš„å®ä¾‹ã€‚è®©æ‰€æœ‰å®ä¾‹ä½¿ç”¨ä¸€æ ·çš„ææ¡ˆç¼–å·ï¼Œå®ƒå¯ä»¥é€šè¿‡å‘å…¶ä»–çš„æœåŠ¡å™¨å‘é€ä¸€ä¸ªåˆç†çš„çŸ­æ¶ˆæ¯æ¥å®ç°è¿™ä¸€ç‚¹ã€‚åœ¨é˜¶æ®µ1ä¸­ï¼Œæ¥å—è€…å½“ä¸”ä»…å½“å®ƒå·²ç»æ”¶åˆ°äº†æŸä¸ªæè®®è€…çš„é˜¶æ®µ2çš„æ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒæ‰ä¼šå“åº”ä¸æ­¢1ä¸ªç®€å•çš„OKã€‚ï¼ˆåœ¨è¿™ä¸ªåœºæ™¯é‡Œï¼Œè¿™æ˜¯ä»…é’ˆå¯¹å®ä¾‹ 135 å’Œ 140 çš„ä¾‹å­ã€‚ï¼‰æ‰€ä»¥ï¼Œä¸€ä¸ªï¼ˆæ‰®æ¼”æ¥å—è€…çš„ï¼‰æœåŠ¡å™¨å¯ä»¥ç”¨ä¸€ä¸ªå•ä¸€ä¸”åˆç†çŸ­çš„æ¶ˆæ¯å›åº”æ‰€æœ‰çš„å®ä¾‹ã€‚å› æ­¤ï¼Œæ‰§è¡Œé˜¶æ®µ1çš„æ— ç©·å¤šä¸ªå®ä¾‹ä¸ä¼šå¸¦æ¥ä»»ä½•é—®é¢˜ã€‚&lt;/p>
&lt;p>ç”±äº leader çš„æ•…éšœä»¥åŠæ–° leader çš„é€‰ä¸¾ç†åº”å¾ˆå°‘å‘ç”Ÿï¼Œå› æ­¤æ‰§è¡ŒçŠ¶æ€æœºå‘½ä»¤â€”â€”å¯¹å‘½ä»¤/å€¼è¾¾æˆä¸€è‡´çš„è¿‡ç¨‹çš„æœ‰æ•ˆæˆæœ¬ï¼Œä»…ä¸ºè¿è¡Œè¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„é˜¶æ®µ2çš„æˆæœ¬ã€‚å¯ä»¥çœ‹å‡ºï¼ŒPaxos ä¸€è‡´æ€§ç®—æ³•çš„ç¬¬2é˜¶æ®µåœ¨å­˜åœ¨æ•…éšœçš„æƒ…å†µä¸‹ï¼Œå…¶è¾¾æˆåè®®çš„å¯èƒ½ä»£ä»·æ˜¯æ‰€æœ‰ç®—æ³•ä¸­æœ€å°çš„ã€‚äºæ˜¯ï¼ŒPaxos ç®—æ³•æœ¬è´¨ä¸Šæ˜¯æœ€ä¼˜çš„ã€‚&lt;/p>
&lt;p>å¯¹äºç³»ç»Ÿæ­£å¸¸æ“ä½œçš„è®¨è®ºä¸­å‡è®¾äº†æ€»æ˜¯åªæœ‰ä¸€ä¸ªå•ç‹¬çš„ Leaderï¼Œæ’é™¤äº†ç°ä»» Leader æ•…éšœå’Œæ–°ä»» Leader é€‰ä¸¾ä¹‹é—´çš„ä¸€å°æ®µæ—¶é—´ã€‚åœ¨å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼ŒLeader é€‰ä¸¾å¯èƒ½å¤±è´¥ã€‚å¦‚æœæ²¡æœ‰æœåŠ¡å™¨æ‹…ä»» Leaderï¼Œä¹Ÿå°±æ²¡æœ‰æ–°çš„è®¤é¢†ä¼šè¢«æè®®ã€‚å¦‚æœå¤šä¸ªæœåŠ¡å™¨è®¤ä¸ºå®ƒä»¬è‡ªå·±éƒ½æ˜¯ Leaderï¼Œåˆ™å®ƒä»¬éƒ½å¯ä»¥åœ¨è¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„åŒä¸€ä¸ªå®ä¾‹ä¸Šæè®®å€¼ï¼Œè¿™å¯èƒ½å¯¼è‡´æ²¡æœ‰å€¼èƒ½å¤Ÿè¢«é€‰å®šã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®‰å…¨æ€§è¿˜æ˜¯ä¿è¯çš„â€”â€”ä¸¤ä¸ªä¸åŒçš„æœåŠ¡å™¨å°†ä¸ä¼šå¯¹è¢«é€‰å®šçš„ç¬¬ &lt;em>i&lt;/em> ä¸ªçŠ¶æ€æœºå‘½ä»¤æŒæœ‰ä¸åŒæ„è§ã€‚å•ä¸ª Leader çš„é€‰ä¸¾åªæœ‰åœ¨ç¡®ä¿ï¼ˆæ•´ä¸ªè¿‡ç¨‹ï¼‰å¯è¿›è¡Œçš„æ—¶å€™æ‰éœ€è¦ã€‚&lt;/p>
&lt;p>å¦‚æœæœåŠ¡å™¨çš„é›†åˆå¯ä»¥å˜åŒ–ï¼Œé‚£å¿…ç„¶å­˜åœ¨æŸäº›æ–¹å¼ç”¨äºå†³å®šå“ªäº›æœåŠ¡å™¨å®ç°è¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„å“ªäº›å®ä¾‹ã€‚æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯é€šè¿‡çŠ¶æ€æœºè‡ªå·±ã€‚å½“å‰çš„æœåŠ¡å™¨é›†åˆå¯ä»¥æˆä¸ºçŠ¶æ€çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡æ™®é€šçš„çŠ¶æ€æœºå‘½ä»¤ä¿®æ”¹ã€‚é€šè¿‡è®©è¿è¡Œç¬¬ &lt;em>i&lt;/em> ä¸ªçŠ¶æ€æœºå‘½ä»¤åæ‰€æŒ‡æ˜çš„æœåŠ¡å™¨çš„é›†åˆæ¥è¿è¡Œè¿™ä¸ªä¸€è‡´æ€§ç®—æ³•çš„ç¬¬ &lt;em>i&lt;/em> + &lt;em>Î±&lt;/em> å·å®ä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å…è®¸ Leader æå‰è·å¾— &lt;em>Î±&lt;/em> ä¸ªå‘½ä»¤ã€‚è¿™å…è®¸äº†ä¸€ä¸ªä»»æ„å¤æ‚çš„æ”¯æŒé‡é…ç½®çš„ç®—æ³•çš„ç®€å•å®ç°ã€‚&lt;/p>
&lt;h2 id="åŸè®ºæ–‡å‚è€ƒæ–‡çŒ®">åŸè®ºæ–‡å‚è€ƒæ–‡çŒ®&lt;/h2>
&lt;p>[1] Â Michael J. Fischer, Nancy Lynch, and Michael S. Paterson. Impossibility of distributed consensus with one faulty process. Journal of the ACM, 32(2):374â€“382, April 1985.
[2] Â Idit Keidar and Sergio Rajsbaum. On the cost of fault-tolerant consensus when there are no faultsâ€”a tutorial. TechnicalReport MIT-LCS-TR-821, Laboratory for Computer Science, Massachusetts Institute Technology, Cambridge, MA, 02139, May 2001. also published in SIGACT News 32(2) (June 2001).
[3] Â Leslie Lamport. The implementation of reliable distributed multiprocess systems. Computer Networks, 2:95â€“114, 1978.
[4] Â Leslie Lamport. Time, clocks, and the ordering of events in a distributed system. Communications of the ACM, 21(7):558â€“565, July 1978. &lt;br>
[5] Â Leslie Lamport. The part-time parliament. ACM Transactions on Com- puter Systems, 16(2):133â€“169, May 1998.&lt;/p>
&lt;h2 id="ç¿»è¯‘è¿‡ç¨‹å‚è€ƒèµ„æ–™">ç¿»è¯‘è¿‡ç¨‹å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://www.microsoft.com/en-us/research/publication/paxos-made-simple/">Paxos Made Simple&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Paxos_%28computer_science%29">Wikipedia: Paxos (Computer Science)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cstheory.stackexchange.com/questions/33504/paxos-made-simple-invariant-p2c">StackExchange Discussion: Paxos made simple, invariant P2c&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://cstheory.stackexchange.com/questions/27391/the-proof-of-p2b-in-paxos-made-simple">StackExchange Discussion: The proof of P2b in Paxos made simple&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.iteblog.com/archives/2337.html">Paxos Made Simple è¯‘æ–‡&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://zh.wikipedia.org/wiki/%E7%8A%B6%E6%80%81%E6%9C%BA%E5%A4%8D%E5%88%B6">ç»´åŸºç™¾ç§‘: çŠ¶æ€æœºå¤åˆ¶&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.doc.ic.ac.uk/~jnm/book/firstbook/pdf/ch7.pdf">Safety &amp;amp; Liveness Properties&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://dockone.io/article/967">å½»åº•å˜æ¸…çœŸå®ä¸–ç•Œä¸­çš„åˆ†å¸ƒå¼ç³»ç»Ÿ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://baike.baidu.com/item/%E7%AC%AC%E4%BA%8C%E6%95%B0%E5%AD%A6%E5%BD%92%E7%BA%B3%E6%B3%95">ç™¾åº¦ç™¾ç§‘ï¼šç¬¬äºŒå½’çº³æ³•&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="è¾…åŠ©ç¿»è¯‘å·¥å…·">è¾…åŠ©ç¿»è¯‘å·¥å…·&lt;/h2>
&lt;ul>
&lt;li>æœ‰é“è¯å…¸&lt;/li>
&lt;/ul>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>è®©äººæ‘¸ä¸ç€å¤´è„‘ï¼šåŸæ–‡ä¸­çš„è¯æ˜¯â€œGreekâ€ï¼Œæˆ‘ä¸ªäººçŒœæƒ³è¿™é‡Œå…¶å®æ˜¯ä¸€è¯­åŒå…³ï¼Œä¸€ä¸ªæ„æ€æ˜¯æŒ‡ Leslie Lamport ç¬¬ä¸€æ¬¡é˜è¿° Paxos ç®—æ³•çš„è®ºæ–‡ã€ŠThe Part-Time Parliamentã€‹é‡Œç”¨äº†å¤å¸Œè…Šçš„æ•…äº‹æƒ…èŠ‚æ¥é˜è¿°ç®—æ³•æ€è·¯ï¼Œå¦ä¸€ä¸ªæ„æ€è¡¨è¾¾ä»¤äººæ‘¸ä¸ç€å¤´è„‘ï¼Œå¯å‚è€ƒæœ‰é“è¯å…¸åŒè¯­ä¾‹å¥ï¼š&lt;em>&lt;!-- raw HTML omitted -->&lt;strong>Reporter&lt;/strong>: The new version will promote &amp;ldquo;The Painted&amp;rdquo; as &amp;ldquo;Eastern magic of the new&amp;rdquo;, is not it a bit &lt;strong>too&lt;/strong> exaggerated and &lt;strong>Greek&lt;/strong>?Positioning yourself how this movie? &lt;!-- raw HTML omitted -->&lt;strong>è®°è€…&lt;/strong>ï¼šå®£ä¼ æ–¹å°†æ–°ç‰ˆã€Šç”»çš®ã€‹å®šä½ä¸ºâ€œä¸œæ–¹æ–°é­”å¹»â€ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹å„¿å¤ªå¤¸å¼ å¹¶ä¸”ä»¤äººæ‘¸ä¸ç€å¤´è„‘?ä½ è‡ªå·±æ€ä¹ˆå®šä½è¿™éƒ¨ç”µå½±?ã€‚&lt;/em>&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:2">
&lt;p>synod ç®—æ³•ï¼šè®ºæ–‡ä½œè€…åœ¨ã€ŠThe Part-Time Parliamentã€‹ä¸­å¯¹å…¶ç®—æ³•çš„å‘½åä¸º synodã€‚&amp;#160;&lt;a href="#fnref:2" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:3">
&lt;p>æ¥è‡ªç»´åŸºç™¾ç§‘çš„â€œçŠ¶æ€æœºå¤åˆ¶â€è¯æ¡ï¼š&lt;em>å¤šä¸ªç›¸åŒçŠ¶æ€æœºçš„æ‹·è´ï¼Œä»åŒæ ·çš„â€œåˆå§‹â€çŠ¶æ€å¼€å§‹ï¼Œç»å†äº†ç›¸åŒçš„è¾“å…¥åºåˆ—åï¼Œä¼šè¾¾åˆ°åŒæ ·çš„çŠ¶æ€ï¼Œå¹¶ä¸”è¾“å‡ºåŒæ ·çš„ç»“æœã€‚&lt;/em>&amp;#160;&lt;a href="#fnref:3" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:4">
&lt;p>åŸæ–‡ä¸­ä¸ºå•è¯&lt;code>values&lt;/code>ï¼Œç¿»è¯‘è¿‡ç¨‹ä¸­ç»“åˆä¸Šä¸‹æ–‡ç†è§£ï¼Œè®¤ä¸ºåŠ ä¸Šâ€œå¯èƒ½ä¸åŒçš„â€ä¼šæ›´è´´åˆæƒ…å¢ƒã€‚&amp;#160;&lt;a href="#fnref:4" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:5">
&lt;p>åŸæ–‡å†…å®¹ä¸ºâ€œA process never learns that a value has been chosen unless it actually has been.â€&amp;#160;&lt;a href="#fnref:5" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:6">
&lt;p>å…³äºå®‰å…¨æ€§å±æ€§ä»¥åŠæ´»æ€§å±æ€§ï¼Œå¯æŸ¥é˜…â€œæœ¬æ–‡å‚è€ƒèµ„æ–™â€ä¸€èŠ‚çš„â€œSafety &amp;amp; Liveness Propertiesâ€&amp;#160;&lt;a href="#fnref:6" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:7">
&lt;p>åŸæ–‡å•è¯â€œcorruptedâ€ï¼Œç›´è¯‘åº”ä¸ºâ€œæŸåâ€ï¼Œä½†æ˜¯è¿™é‡Œç»“åˆä¸ªäººç†è§£ï¼Œè¯‘ä½œâ€œç¯¡æ”¹â€æ›´è´´åˆ‡ï¼Œæ„ä¸ºä¸ä¼šå‘ç”Ÿæ‹œå åº­å¼çš„é—®é¢˜&amp;#160;&lt;a href="#fnref:7" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:8">
&lt;p>ç”±äºæ‰€è°“çš„å¤§å¤šæ•°ç­‰äº N/2+1ï¼Œæ‰€ä»¥å¦‚æœæœ‰ä¸€ä¸ªæ¥å—è€…æ•…éšœï¼Œå¯èƒ½å¯¼è‡´ä¸¤è¾¹æè®®éƒ½åªèƒ½å¾—åˆ° N/2 ç¥¨ï¼Œéƒ½æ— æ³•è¡Œæˆå¤§å¤šæ•°ã€‚&amp;#160;&lt;a href="#fnref:8" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:9">
&lt;p>ä¸€ç§å¸¸è§ä¸”å¯è¡Œçš„æ–¹æ¡ˆæ˜¯ä½¿ç”¨æ—¶é—´æˆ³+æœºå™¨IDçš„å½¢å¼ï¼Œä½†æ˜¯å®é™…ä¸Šè®ºæ–‡ä¸­å¹¶æ²¡æœ‰å¯¹ææ¡ˆç¼–å·çš„ç”Ÿæˆåšå…·ä½“çš„è§„å®šï¼Œåªè¦ä¿è¯ç¼–å·é€’å¢ä¸”å”¯ä¸€å³å¯ï¼Œæ‰€ä»¥å®é™…çš„å®ç°ä¸­å¯ä»¥æœ‰å¤šç§å¤šæ ·çš„å®ç°æ–¹å¼&amp;#160;&lt;a href="#fnref:9" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:10">
&lt;p>è®ºæ–‡ä½œè€…é‡‡ç”¨äº†æ•°å­¦ä¸Šçš„ç¬¬äºŒå½’çº³æ³•ï¼Œäº¦ç§°â€œå¼ºå½’çº³æ³•â€&amp;#160;&lt;a href="#fnref:10" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:11">
&lt;p>ç»“åˆåé¢çš„æ¨ç†ç»“è®ºï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªé—­åŒºé—´çš„æ ‡è®°æ³•ï¼Œå³&lt;code>i..j&lt;/code>å¯¹åº”æ•°å­¦è®°æ³• &lt;code>[i, j]&lt;/code>ã€‚
ç”±äºç¼–å·ä¸º &lt;em>m&lt;/em> çš„ææ¡ˆå·²ç»è¢«é€‰å®šï¼Œé‚£å°±å¿…ç„¶å­˜åœ¨ä¸€ä¸ªç”±â€œå¤§å¤šæ•°â€æ¥å—è€…ç»„æˆçš„é›†åˆ &lt;em>C&lt;/em>ï¼Œä¸”é›†åˆé‡Œçš„æ¯ä¸€ä¸ªæ¥å—è€…éƒ½æ¥å—äº†è¿™ä¸ªææ¡ˆã€‚ç»“åˆè¿™ä¸ªï¼ˆæ¨ç†ï¼‰ä»¥åŠå‰é¢çš„å½’çº³å‡è®¾ï¼Œ&lt;em>m&lt;/em> è¢«é€‰å®šçš„å‡è®¾åˆ™æ„å‘³ç€ï¼š&amp;#160;&lt;a href="#fnref:11" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:12">
&lt;p>è‡³å°‘æ¥å—äº† &lt;em>m&lt;/em> å·ææ¡ˆï¼Œæ‰€ä»¥è¿™ä¸ªç»“è®ºæ˜¯æˆç«‹çš„&amp;#160;&lt;a href="#fnref:12" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:13">
&lt;p>è®°å¾—ä¸€ä¸ªâ€œææ¡ˆâ€å§‹ç»ˆæ„å‘³ç€ï¼šä¸€ä¸ªç¼–å·åŠ ä¸Šä¸€ä¸ªææ¡ˆçš„å€¼ã€‚&amp;#160;&lt;a href="#fnref:13" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;li id="fn:14">
&lt;p>å›æƒ³åŸºæœ¬çš„ Paxos çš„ä¸¤ä¸ªé˜¶æ®µä¸­çš„é˜¶æ®µä¸€ï¼Œåªè¦å½“å‰å®ä¾‹ä¸­ï¼Œè¿˜æ²¡æœ‰ä»»ä½•ææ¡ˆè¢«æ¥å—è€…æ¥å—è¿‡ï¼Œåˆ™æè®®è€…å¯ä»¥æå‡ºä»»æ„å€¼ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ„å‘³ç€åŸæ¥æ—§çš„ Leader è¿˜æ²¡æœ‰æ¥å¾—åŠå¼€å§‹å®ä¾‹ 136 å’Œ 137 çš„é˜¶æ®µäºŒã€‚&amp;#160;&lt;a href="#fnref:14" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>è°¨é˜²çŒ´å­è¡¥ä¸ä»¥åŠPythonä¸­æ’æŸ¥æŠ€å·§</title><link>https://blog.hackerpie.com/posts/2019/pay-attention-to-monkey-patch/</link><pubDate>Sun, 22 Sep 2019 19:48:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2019/pay-attention-to-monkey-patch/</guid><description>&lt;h3 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h3>
&lt;p>å‰ä¸¤å¤©æ™šä¸Šçº¿ä¸Šç³»ç»Ÿçªå‘æ•…éšœï¼Œåœ¨ç«‹é©¬æ‰“å¼€çº¿ä¸Šé”™è¯¯æ—¥å¿—ä¹‹åï¼Œå´åªèƒ½å¾—åˆ°ä¸€å †æ¯«æ— æ„ä¹‰çš„ç¨‹åºè°ƒç”¨æ ˆ(traceback)çš„è¾“å‡ºï¼Œäºæ˜¯å›¢é˜Ÿæˆå‘˜é™·å…¥æ¼«é•¿è€ŒåˆæŠ“ççš„é—®é¢˜æ’æŸ¥è¿‡ç¨‹ä¸­ã€‚é—®é¢˜å¾ˆå¹¸è¿åœ°å¾—åˆ°äº†è§£å†³ï¼Œä½†æ˜¯æˆ‘ä¸€ç›´æƒ³ä¸æ˜ç™½ä¸ºä»€ä¹ˆæ—¥å¿—é‡Œæ‰“å°çš„è°ƒç”¨æ ˆæ¯«æ— æ„ä¹‰ï¼ŒæŒ‰ç…§ç»éªŒï¼Œå®ƒåº”è¯¥æ‰“å°çš„æ˜¯å¼‚å¸¸äº§ç”Ÿè¿‡ç¨‹ä¸­çš„è°ƒç”¨æ ˆæ‰æ˜¯ã€‚åœ¨ç»è¿‡åç»­çš„æºç åˆ†æå’Œæ’æŸ¥ä¹‹åï¼Œæˆ‘æ‰å‘ç°å…¶å®æ˜¯å› ä¸ºé¡¹ç›®ä¸­ä¸€ä¸ªè€æ—§çš„ä»£ç ä½¿ç”¨äº†&lt;strong>çŒ´å­è¡¥ä¸&lt;/strong>å¯¼è‡´ï¼Œè¿™ä¹Ÿæ˜¯è¿™ç¯‡æ–‡ç« æƒ³è¦è®¨è®ºçš„å†…å®¹ã€‚&lt;/p>
&lt;h3 id="ä»€ä¹ˆæ˜¯çŒ´å­è¡¥ä¸">ä»€ä¹ˆæ˜¯çŒ´å­è¡¥ä¸&lt;/h3>
&lt;p>çŒ´å­è¡¥ä¸æ˜¯ä¸€ç§ç”¨æ¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹ï¼ˆå¢åŠ ã€å˜æ›´ã€åˆ é™¤ç­‰ï¼‰ç³»ç»Ÿè½¯ä»¶è¡Œä¸ºçš„ç¼–ç¨‹æ–¹å¼ã€‚åœ¨åŠ¨æ€è¯­è¨€é‡Œæœ‰å¹¿æ³›çš„çŒ´å­è¡¥ä¸åº”ç”¨çš„å½±å­ï¼Œæ¯”å¦‚ Ruby çš„æ‰“å¼€ç±»çš„ç‰¹æ€§æ”¯æŒè¿è¡Œæ—¶æ‰©å±•ç±»çš„å®šä¹‰ç”šè‡³æ›¿æ¢æ–¹æ³•çš„å®ç°ï¼ŒPython çš„æ–¹æ³•æˆ–è€…å‡½æ•°ç”±äºå¯ä»¥åœ¨è¿è¡Œæ—¶è¿›è¡Œæ›¿æ¢è€Œä½¿å¾—çŒ´å­è¡¥ä¸çš„åº”ç”¨éå¸¸æ–¹ä¾¿ï¼Œå…¶ä»–åƒ JavaScript è¯­è¨€åŒæ ·å¯ä»¥åº”ç”¨çŒ´å­è¡¥ä¸ã€‚&lt;/p>
&lt;h4 id="çŒ´å­è¡¥ä¸æ˜¯æŠŠåŒåˆƒå‰‘">çŒ´å­è¡¥ä¸æ˜¯æŠŠåŒåˆƒå‰‘&lt;/h4>
&lt;p>çŒ´å­è¡¥ä¸ä»¥å…¶çµæ´»æ€§ï¼Œå¯ä»¥å®ç°è¡¥ä¸ä»£ç å’Œåº”ç”¨ä»£ç çš„å®Œå…¨åˆ†ç¦»ï¼ŒåŒæ—¶ä½¿å¾—åº”ç”¨ä»£ç åœ¨è°ƒç”¨æ–¹å¼ä¸Šä¿æŒè°ƒç”¨æ–¹å¼å§‹ç»ˆä¸å˜ã€‚
ä»åº”ç”¨ä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒè°ƒç”¨çš„å°±æ˜¯æŸä¸ªæ¨¡å—çš„åŸå§‹å®šä¹‰çš„æ–¹æ³•æˆ–è€…å‡½æ•°ï¼›è€Œä»è¢«è°ƒç”¨çš„æ–¹æ³•æˆ–è€…å‡½æ•°çš„è§’åº¦æ¥çœ‹ï¼ŒçŒ´å­è¡¥ä¸çš„å­˜åœ¨å¯¹å®ƒæ˜¯é€æ˜çš„å­˜åœ¨ï¼Œä»¥ä¸‹å±•ç¤ºä¸€ä¸ª Python è¯­è¨€çš„ Demoï¼š&lt;/p>
&lt;p>æˆ‘ä»¬ä»ä¸€ä¸ªæç®€ä¾‹å­å¼€å§‹ï¼Œå‘è¿™ä¸ªç¾å¥½çš„ä¸–ç•Œé—®å¥½ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> greet():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="font-style:italic">&amp;#34;Hello World!&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">if&lt;/span> __name__ == &lt;span style="font-style:italic">&amp;#34;__main__&amp;#34;&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> greet()
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡å¦‚æ‰§è¡Œä»¥ä¸Šè„šæœ¬ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ python demo.py
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hello World!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªå¾ˆç®€å•ï¼Œæ¥ä¸‹æ¥å‡å¦‚æ‰“ä¸€ä¸ªçŒ´å­è¡¥ä¸ï¼šæˆ‘ä»¬æ‰©å……åŸæ¥çš„ &lt;code>greet&lt;/code> çš„è¡Œä¸ºï¼Œç°åœ¨é™¤äº†æ‰“å°ä¿¡æ¯ï¼Œè¿˜è¦æ‰“å°ä¸‹å½“å‰çš„æ—¶é—´ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">from&lt;/span> &lt;span style="font-weight:bold">datetime&lt;/span> &lt;span style="font-weight:bold">import&lt;/span> datetime
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> greet():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="font-style:italic">&amp;#34;Hello World!&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># monkey patch&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>original_greet = greet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> greet_with_time():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> original_greet()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(datetime.now())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>greet = greet_with_time &lt;span style="font-style:italic"># replace the implementation&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># monkey patch&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">if&lt;/span> __name__ == &lt;span style="font-style:italic">&amp;#34;__main__&amp;#34;&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> greet() &lt;span style="font-style:italic"># è¿™é‡Œçš„è°ƒç”¨å’ŒåŸæ¥æ²¡æœ‰å˜åŒ–&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿è¡Œå®ƒï¼Œå¾—åˆ°çš„ç»“æœæ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ python demo.py
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Hello World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>2019-09-21 23:40:42.575782
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å¾—åˆ°äº†é¢„æœŸçš„ç»“æœï¼&lt;br>
ä»ä»£ç åˆ†æï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å‡½æ•° &lt;code>greet_with_time&lt;/code>ï¼Œå…¶ä¼šè°ƒç”¨åŸæ¥çš„ &lt;code>greet&lt;/code> å‡½æ•°ï¼Œç„¶åæ‰“å°å½“å‰æ—¶é—´ï¼Œæœ€åå°† &lt;code>greet&lt;/code> å‡½æ•°é€šè¿‡å°†å‡½æ•°èµ‹å€¼ç»™å˜é‡çš„æ–¹å¼å®Œæˆå¯¹ &lt;code>greet&lt;/code> å‡½æ•°çš„æ›¿æ¢ã€‚è€Œå¯¹äºæœ€åçš„ &lt;code>greet&lt;/code> å‡½æ•°çš„è°ƒç”¨ï¼Œå´æ— éœ€ä»»ä½•æ”¹åŠ¨ï¼Œä»¥æ­¤è¾¾åˆ°äº†åŒæ ·è¿˜æ˜¯è°ƒç”¨ &lt;code>greet&lt;/code> å‡½æ•°ï¼Œè¡Œä¸ºå´å¤§ç›¸å¾„åº­çš„ç›®çš„ã€‚&lt;br>
ä¸Šé¢çš„ demo åªæ˜¯é™äºç¯‡å¹…ç®€åŒ–äº†ä»£ç ï¼ŒçœŸå®é¡¹ç›®é‡Œçš„çŒ´å­è¡¥ä¸ä»£ç æ€»æ˜¯åœ¨å¦å¤–çš„æ¨¡å—æˆ–è€…æ–‡ä»¶é‡Œã€‚æƒ³è±¡åœ¨ä¸€ä¸ªå¤æ‚çš„å¤§å‹å·¥ç¨‹é‡Œï¼Œå¦‚æœä½ çš„ä»£ç é‡ŒçŒ´å­è¡¥ä¸æ³›æ»¥ï¼Œå¯æƒ³å¯¹äºç³»ç»Ÿçš„è¡Œä¸ºåˆ†æä»¥åŠé—®é¢˜æ’æŸ¥ï¼Œå°†æ˜¯ä¸€ç§ç¾éš¾æ€§çš„æŒ‘æˆ˜ã€‚&lt;/p>
&lt;p>ç°åœ¨å¯¹çŒ´å­è¡¥ä¸æœ‰äº†ä¸€å®šçš„äº†è§£ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­é‡åˆ°çš„ä¾‹å­ã€‚&lt;/p>
&lt;h3 id="ä¸€å †æ¯«æ— æ„ä¹‰çš„å †æ ˆä¿¡æ¯">ä¸€å †æ¯«æ— æ„ä¹‰çš„å †æ ˆä¿¡æ¯&lt;/h3>
&lt;p>æˆ‘åœ¨æœ¬åœ°é‡ç°äº†æˆ‘å¼€å¤´æåˆ°çš„æˆ‘ä»¬æ‰€é‡åˆ°çš„å¼‚å¸¸ï¼Œä»¥ä¸‹æ˜¯å’Œçº¿ä¸Šç¯å¢ƒä¸€è‡´çš„å †æ ˆä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-plain" data-lang="plain">&lt;span style="display:flex;">&lt;span>2019-09-19 17:30:11.103|CRITICAL|138:140147476383488|log.py:282|log.log|Task command.celery.crontab_task.some_task[538ddb72-89b0-45fe-811e-107202dc665b] INTERNAL ERROR: AttributeError(&amp;#34;&amp;#39;long&amp;#39; object has no attribute &amp;#39;insert&amp;#39;&amp;#34;,)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Traceback (most recent call last):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> File &amp;#34;/usr/local/bin/celery&amp;#34;, line 10, in &amp;lt;module&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sys.exit(main())
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/__main__.py&amp;#34;, line 30, in main
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> main()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ...... é™äºç¯‡å¹…ï¼Œè¿™é‡Œçœç•¥å¾ˆå¤šæ— æ„ä¹‰çš„å†…å®¹
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/worker/job.py&amp;#34;, line 384, in on_success
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> return self.on_failure(ret_value)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/worker/job.py&amp;#34;, line 443, in on_failure
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self._log_error(exc_info, send_failed_event=send_failed_event)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/worker/job.py&amp;#34;, line 511, in _log_error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &amp;#39;internal&amp;#39;: internal}})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/utils/log.py&amp;#34;, line 282, in log
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> return Logger.log(self, *args, **kwargs)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>None
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»è¿™ä¸ªå †æ ˆä¿¡æ¯çœ‹ï¼Œå®ƒæ‰“å°çš„å®é™…ä¸Šæ˜¯è°ƒç”¨äº† &lt;code>Logger.log&lt;/code> å‡½æ•°çš„å †æ ˆï¼Œå…¶ä¸­æ ¹æœ¬æ²¡æœ‰ä»»ä½•ä»£ç çœ‹åˆ°æœ‰ &lt;code>.insert&lt;/code> ç›¸å…³å­—çœ¼ï¼Œå…¶ä¸ &lt;code>AttributeError(&amp;quot;'long' object has no attribute 'insert'&amp;quot;,)&lt;/code> æ ¹æœ¬æ¯«æ— å…³ç³»ï¼Œè¿™æ ·çš„å †æ ˆä¿¡æ¯ï¼Œæœ‰å’Œæ²¡æœ‰åŸºæœ¬ä¸€ä¸ªæ ·ã€‚äºæ˜¯ä¹ï¼Œæˆ‘æ¥ç€é€šè¿‡ç¼–è¾‘å™¨é€šè¿‡æºç è¿›è¡Œäº†æ›´å¤šçš„æ¢ç´¢ã€‚&lt;/p>
&lt;p>é¦–å…ˆè¿˜æ˜¯å€ŸåŠ©ä¸Šé¢çš„å †æ ˆå»åˆ†æåˆ°åº•å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘å…ˆçœ‹äº† &lt;code>celery/worker/job.py:504-511&lt;/code> å¤„çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span> context = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;hostname&amp;#39;&lt;/span>: self.hostname,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;id&amp;#39;&lt;/span>: self.id,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;name&amp;#39;&lt;/span>: self.name,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;exc&amp;#39;&lt;/span>: exception,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;traceback&amp;#39;&lt;/span>: traceback,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;args&amp;#39;&lt;/span>: sargs,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;kwargs&amp;#39;&lt;/span>: skwargs,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;description&amp;#39;&lt;/span>: description,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.log(severity, format.strip(), context,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exc_info=exc_info,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> extra={&lt;span style="font-style:italic">&amp;#39;data&amp;#39;&lt;/span>: {&lt;span style="font-style:italic">&amp;#39;id&amp;#39;&lt;/span>: self.id,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;name&amp;#39;&lt;/span>: self.name,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;args&amp;#39;&lt;/span>: sargs,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;kwargs&amp;#39;&lt;/span>: skwargs,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;hostname&amp;#39;&lt;/span>: self.hostname,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;internal&amp;#39;&lt;/span>: internal}})
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œè°ƒç”¨äº† &lt;code>logger.log&lt;/code> æ–¹æ³•ï¼ˆlogger çš„æ¥æºåœ¨ Celery çš„ä»£ç é‡Œå¯åˆ†æï¼Œä½†æ˜¯ä¸æ˜¯è¿™ç¯‡æ–‡ç« çš„é‡ç‚¹ï¼Œæ•…æ­¤ä¸å±•å¼€ï¼‰å¹¶ä¸”é€šè¿‡ &lt;code>context&lt;/code> å¯¹è±¡ä¼ å…¥äº†ä¸¤ä¸ªé‡è¦çš„ä¿¡æ¯ï¼š&lt;code>exception&lt;/code> å’Œ &lt;code>traceback&lt;/code>ã€‚åœ¨å¯¹ &lt;code>logger.log&lt;/code> æºç çš„è¿›ä¸€æ­¥é˜…è¯»ä¸­ï¼Œæˆ‘ç¡®è®¤äº†è¿™å—&lt;strong>æ—¥å¿—æ‰“å°çš„æ ¸å¿ƒä¾èµ–äºå¯¹ &lt;code>traceback.print_exception&lt;/code> å‡½æ•°çš„è°ƒç”¨&lt;/strong>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> formatException(self, ei):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"> Format and return the specified exception information as a string.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"> This default implementation just uses
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"> traceback.print_exception()
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sio = io.StringIO()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> tb = ei[2]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traceback.print_exception(ei[0], ei[1], tb, &lt;span style="font-weight:bold">None&lt;/span>, sio)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>äºæ˜¯ä¹ï¼Œæˆ‘å›åˆ°äº† &lt;code>celery/worker/job.py:504-511&lt;/code> å¤„çš„ä»£ç ï¼Œåœ¨ &lt;code>logger.log&lt;/code> å‰é¢æ’å…¥äº†ä¸¤ç§æ‰“å°é”™è¯¯å †æ ˆä¿¡æ¯çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># context = ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">################################################################&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">import&lt;/span> &lt;span style="font-weight:bold">traceback&lt;/span> &lt;span style="font-weight:bold">as&lt;/span> &lt;span style="font-weight:bold">_traceback&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Method 1: like what logger.log does&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _traceback.print_exception(*exc_info)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Method 2: use `format_exception` instead&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print(&lt;span style="font-style:italic">&amp;#39;&amp;#39;&lt;/span>.join(_traceback.format_exception(*exc_info)))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">################################################################&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.log(....
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‡æ–°å¯åŠ¨ celery åï¼Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡åï¼Œå¾—åˆ°çš„ç¬¬ä¸€ç§é”™è¯¯å †æ ˆå’Œå‰é¢æˆ‘è´´å‡ºæ¥çš„å †æ ˆä¿¡æ¯æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œè¿™ä¸ªå€’ä¹Ÿå¥½ç†è§£ï¼Œæ¯•ç«Ÿè¿™é‡Œçš„ &lt;code>print_exception&lt;/code> å‡½æ•°çš„è°ƒç”¨å°±æ˜¯ &lt;code>logger.log&lt;/code> é‡Œçš„æ ¸å¿ƒå®ç°ã€‚è€Œ &lt;code>format_exception&lt;/code> çš„è°ƒç”¨ç»™äº†æˆ‘çœŸæ­£æœ‰æ„ä¹‰çš„é”™è¯¯å †æ ˆä¿¡æ¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>Traceback (most recent call last):
File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/app/trace.py&amp;#34;, line 283, in trace_task
uuid, retval, SUCCESS, request=task_request,
File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/backends/base.py&amp;#34;, line 271, in store_result
request=request, **kwargs)
File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/backends/base.py&amp;#34;, line 505, in _store_result
self.set(self.get_key_for_task(task_id), self.encode(meta))
File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/backends/redis.py&amp;#34;, line 161, in set
return self.ensure(self._set, (key, value), **retry_policy)
File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/backends/redis.py&amp;#34;, line 150, in ensure
**retry_policy
File &amp;#34;/usr/local/lib/python2.7/dist-packages/kombu/utils/__init__.py&amp;#34;, line 246, in retry_over_time
return fun(*args, **kwargs)
File &amp;#34;/usr/local/lib/python2.7/dist-packages/celery/backends/redis.py&amp;#34;, line 170, in _set
pipe.execute()
File &amp;#34;/usr/local/lib/python2.7/dist-packages/redis/client.py&amp;#34;, line 2879, in execute
return execute(conn, stack, raise_on_error)
File &amp;#34;/usr/local/lib/python2.7/dist-packages/redis/client.py&amp;#34;, line 2785, in _execute_transaction
response.insert(i, e)
AttributeError: &amp;#39;long&amp;#39; object has no attribute &amp;#39;insert&amp;#39;
&lt;/code>&lt;/pre>&lt;p>å¥½å®¶ä¼™ï¼Œè¿™ä¸‹å°±æ¸…æ™°äº†ï¼ŒåŸæ¥è¿™ä¸ªä»£ç çš„å¼‚å¸¸çœŸæ­£å‡ºå¤„æ˜¯è¿™é‡Œï¼&lt;br>
ä½†æ˜¯é—®é¢˜å°±æ¥äº†ï¼Œä¸ºä»€ä¹ˆ&lt;code>print_exception&lt;/code>å’Œ &lt;code>format_exception&lt;/code>ç»™å‡ºçš„å †æ ˆä¿¡æ¯ä¸ä¸€æ ·å‘¢ï¼Ÿæˆ‘å……æ»¡ç–‘é—®åœ°å»æŸ¥æ‰¾äº†å®˜æ–¹æ–‡æ¡£ï¼Œä½†æ˜¯å›°æƒ‘æ›´é‡äº†ï¼š&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>traceback.format_exception(etype, value, tb[, limit])&lt;/strong>
Format a stack trace and the exception information. The arguments have the same meaning as the corresponding arguments to print_exception(). The return value is a list of strings, each ending in a newline and some containing internal newlines. When these lines are concatenated and printed, exactly the same text is printed as does print_exception().&lt;/p>
&lt;/blockquote>
&lt;p>é‡ç‚¹åœ¨æœ€åä¸€å¥ï¼ŒPython å®˜æ–¹æ–‡æ¡£è¯´äº†ï¼Œä¸¤ä¸ªå‡½æ•°è¾“å‡ºçš„é”™è¯¯å †æ ˆæ˜¯ä¸€æ ·(exactly the same text)çš„ï¼&lt;/p>
&lt;h3 id="æªå‡ºçŒ´å­è¡¥ä¸">æªå‡ºçŒ´å­è¡¥ä¸&lt;/h3>
&lt;p>å…¶å®ï¼Œé—®é¢˜çš„çœŸæ­£æ’æŸ¥è¿‡ç¨‹è€—è´¹äº†æˆ‘å¥½å¤šæ—¶é—´ï¼Œæˆ‘ä¸€ç›´æ²¡æœ‰å¾€çŒ´å­è¡¥ä¸ä¸Šæƒ³ï¼Œæœ€åå€’æ˜¯åœ¨å‡ºé—¨èµ´æœ‹å‹çš„é¥­çº¦çš„åœ°é“ä¸Šçµæœºä¸€åŠ¨ï¼Œç”¨æ‰‹æœºç¿»çœ‹äº†å…¬å¸ GitLab ä¸Šçš„é¡¹ç›®ä»£ç ï¼Œä¸€ä¸‹æ‰¾åˆ°äº†å…ƒå‡¶ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> _patch_print_exception():
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">import&lt;/span> &lt;span style="font-weight:bold">traceback&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> custom_print_exception(etype, value, tb, limit=&lt;span style="font-weight:bold">None&lt;/span>, file=&lt;span style="font-weight:bold">None&lt;/span>):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exc_info = sys.exc_info()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stack = traceback.extract_stack()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ... omit other source codes &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> traceback.print_exception = custom_print_exception
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»è¡¥ä¸ä»£ç çœ‹ï¼Œè¡¥ä¸ç›´æ¥è¦†ç›–äº†åŸç‰ˆçš„ä»£ç ï¼Œå¹¶ä¸”å®ç°ä¸Šä¹Ÿç›´æ¥ç²—æš´åœ°æ— è§†äº†ä¼ å…¥çš„å‡ ä¸ªå¼‚å¸¸ä¿¡æ¯å‚æ•°ï¼æ‰€ä»¥æ‰ä¼šå‡ºç°è¿™ä¹ˆå¤§çš„ä¹Œé¾™ï¼Œå‡ºç°æ¯«æ— å…³ç³»çš„å¼‚å¸¸å †æ ˆä¿¡æ¯ï¼(â•¯â€µâ–¡â€²)â•¯ï¸µâ”»â”â”»&lt;/p>
&lt;h3 id="æ’æŸ¥çŒ´å­è¡¥ä¸çš„æŠ€å·§">æ’æŸ¥çŒ´å­è¡¥ä¸çš„æŠ€å·§&lt;/h3>
&lt;p>çŒ´å­è¡¥ä¸è¿™ç±»ç¼–ç¨‹æŠ€å·§å›ºç„¶ä¼šåˆ©å¼Šå…±å­˜ï¼Œä½¿ç”¨ä¸Šå¿…ç„¶éœ€è¦é¢å¤–æ…é‡ï¼Œä½†ä¹Ÿå¹¶ééœ€è¦æ•¬è€Œè¿œä¹‹ï¼Œé‡ç‚¹æ˜¯æŒæ¡å¿…è¦çš„æ’æŸ¥æŠ€å·§ï¼Œä»¥ä¸‹æˆ‘é’ˆå¯¹è¿™æ¬¡çš„æ•™è®­åˆå»æ‰¾ä¸‹ä¸€äº›å¯èƒ½æœ‰å¸®åŠ©çš„æ–¹æ³•ï¼š&lt;/p>
&lt;h4 id="1-é€šè¿‡å‡½æ•°æˆ–æ–¹æ³•è‡ªèº«å±æ€§æ£€æŸ¥æ–¹æ³•æˆ–è€…å‡½æ•°çš„ä¿¡æ¯">1. é€šè¿‡å‡½æ•°æˆ–æ–¹æ³•è‡ªèº«å±æ€§æ£€æŸ¥æ–¹æ³•æˆ–è€…å‡½æ•°çš„ä¿¡æ¯&lt;/h4>
&lt;p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒPython çš„æ‰€æœ‰å¯¹è±¡éƒ½æœ‰ä¸€å †&lt;a href="https://docs.python.org/2/library/inspect.html#types-and-members">å†…ç½®çš„å±æ€§&lt;/a>ï¼Œå‡½æ•°ä¹Ÿä¸ä¾‹å¤–ï¼Œä»¥æˆ‘é¡¹ç›®ä¸­çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># django shell&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>In [1]: traceback.print_exception.func_code
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Out[1]: &amp;lt;code object custom_print_exception at 0x109e9f030, file &lt;span style="font-style:italic">&amp;#34;/Users/boy/work_area/project/project-source/lib/common/logger.py&amp;#34;&lt;/span>, line 295&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€çœ‹å°±çŸ¥é“ï¼Œè¿™ä¸ªå‡½æ•°çš„çœŸå®ä»£ç å…¶å®å°±æ˜¯é¡¹ç›®ä¸­çš„è¡¥ä¸ä»£ç ï¼&lt;/p>
&lt;h4 id="2-å€ŸåŠ©-inspect-åŒ…æ¥æ£€æŸ¥">2. å€ŸåŠ© inspect åŒ…æ¥æ£€æŸ¥&lt;/h4>
&lt;p>Python è‡ªèº«æä¾›çš„å·¥å…·åŒ…éå¸¸å¤šï¼Œinspect è‡ªç„¶ä¹Ÿæ˜¯åˆ©å™¨ä¹‹ä¸€ï¼Œå…¶å¯ä»¥ç”¨æ¥å¯¹å‡ ä¹æ‰€æœ‰ç±»å‹åšè¿è¡Œæ—¶çš„æ£€æŸ¥ï¼Œè¿˜æ˜¯ä»¥æˆ‘çš„å®é™…ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># django shell&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>In [1]: &lt;span style="font-weight:bold">import&lt;/span> &lt;span style="font-weight:bold">inspect&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>In [2]: inspect.getfile(traceback.print_exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Out[2]: &lt;span style="font-style:italic">&amp;#39;/Users/boy/work_area/project/project-source/lib/common/logger.py&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>In [3]: inspect.getsource(traceback.print_exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Out[3]: &lt;span style="font-style:italic">&amp;#39;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\t&lt;/span>&lt;span style="font-style:italic">def custom_print_exception(etype, value, tb, limit=None, file=None): ......&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\n&lt;/span>&lt;span style="font-style:italic">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>In [4]: print inspect.getsource(traceback.print_exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Out[4]: &lt;span style="font-weight:bold">def&lt;/span> custom_print_exception(etype, value, tb, limit=&lt;span style="font-weight:bold">None&lt;/span>, file=&lt;span style="font-weight:bold">None&lt;/span>):disable=redefined-builtin
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> file &lt;span style="font-weight:bold">is&lt;/span> &lt;span style="font-weight:bold">None&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> file = sys.stderr
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exc_info = sys.exc_info()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stack = traceback.extract_stack()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ€»ä¹‹ï¼Œå¦‚æœé‡ä¸Šä»£ç è¡Œä¸ºä¸é¢„æœŸä¸ç¬¦å´åˆæ— æ³•å’Œå®˜æ–¹æ–‡æ¡£æˆ–è€…å®˜æ–¹æºç å¯¹åº”ï¼Œé‚£ä¹ˆå¯èƒ½å°±æ˜¯ä¾èµ–çš„æ–¹æ³•æˆ–è€…å‡½æ•°è¢«æ‰“äº†çŒ´å­è¡¥ä¸ï¼Œè€Œæœ€å¿«é€Ÿç¡®è®¤çŒ´å­è¡¥ä¸çš„æ–¹å¼ï¼Œå°±æ˜¯ç¬¬ä¸€æ—¶é—´æ£€æŸ¥æ‰€è°ƒç”¨çš„å‡½æ•°æˆ–è€…æ–¹æ³•çš„å®é™…å®šä¹‰ï¼Œå³åº”ç”¨ä¸Šè¿°æ–¹æ³•å³å¯ï¼&lt;/p>
&lt;h4 id="é¢˜å¤–è¯">é¢˜å¤–è¯&lt;/h4>
&lt;p>åš Ruby å¼€å‘æ—¶ï¼Œæˆ‘ä¹Ÿé‡åˆ°è¿‡çŒ´å­è¡¥ä¸çš„é™·é˜±ï¼ŒRuby é‡Œä¹Ÿæœ‰ç±»ä¼¼çš„æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>file, line = A.new.method(&lt;span style="font-style:italic">:foo&lt;/span>).source_location
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>puts &lt;span style="font-style:italic">&amp;#34;Method foo is defined in &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>file&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">, line &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>line&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># =&amp;gt; &amp;#34;Method foo is defined in temp.rb, line 2&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Monkey_patch">Wikipedia: Monkey patch&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.python.org/2/library/traceback.html#traceback.format_exception">Python&amp;rsquo;s official document: traceback.format_exception&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.python.org/2/library/inspect.html#types-and-members">Python&amp;rsquo;s official document: inspect&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stackoverflow.com/a/3393706/2547108">How can I get source code of a method dynamically and also which file is this method locate in&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Mac OS ç¯å¢ƒ Rails 6.0 ä¸‹ webpack-dev-server wrong version é—®é¢˜è§£å†³æ–¹æ¡ˆ</title><link>https://blog.hackerpie.com/posts/2019/fix-webpack-dev-server-wrong-version-in-rails-6/</link><pubDate>Fri, 06 Sep 2019 15:18:30 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2019/fix-webpack-dev-server-wrong-version-in-rails-6/</guid><description>&lt;h3 id="é”™è¯¯ä¿¡æ¯">é”™è¯¯ä¿¡æ¯&lt;/h3>
&lt;p>æ˜¨å¤©è£…ä¸Šäº† Ruby on Rails 6.0ï¼Œæ»¡å¿ƒæ¬¢å–œåˆå§‹åŒ–é¡¹ç›®å¹¶ä¸”æŒ‰ç…§æŒ‡å¼•å®‰è£…äº† webpacker ä¹‹åï¼Œæ‰§è¡Œç†Ÿæ‚‰æ— æ¯”çš„ &lt;code>rails c&lt;/code> å‘½ä»¤ï¼Œå´ç»™äº†ä¸€ä¸ªæŠ¥é”™ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code># é”™è¯¯ä¿¡æ¯ç‰‡æ®µ
yarn check v1.7.0
success Folder in sync.
Done in 0.15s.
yarn check v1.7.0
error &amp;#34;webpack-dev-server#yargs#cliui&amp;#34; is wrong version: expected &amp;#34;^4.0.0&amp;#34;, got &amp;#34;5.0.0&amp;#34;
error &amp;#34;webpack-dev-server#yargs#yargs-parser&amp;#34; is wrong version: expected &amp;#34;^11.1.1&amp;#34;, got &amp;#34;13.1.1&amp;#34;
error Found 2 errors.
info Visit https://yarnpkg.com/en/docs/cli/check for documentation about this command.
&lt;/code>&lt;/pre>&lt;h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h3>
&lt;p>ç›®å‰å…³äº Rails 6.0 ç›¸å…³çš„èµ„æ–™æ„Ÿè§‰ä¸å¤šï¼Œæ‰€å¹¸æ‰¾åˆ°äº†ä¸€ç¯‡æ—¥æ–‡ç‰ˆçš„å¸–å­ï¼ŒæˆåŠŸè§£å†³äº†ä¸Šè¾¹çš„é—®é¢˜ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ brew upgrade yarn
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ yarn upgrade
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€ç»ˆé—®é¢˜è§£å†³ï¼Œåˆèƒ½æ„‰å¿«åœ°å‰è¿›äº†ï¼&lt;/p>
&lt;p>**æ³¨æ„ï¼š**æˆ‘è‡ªå·±å·²ç»ä¸€å¹´å¤šæ²¡æ€ä¹ˆå¼€å‘ Rails é¡¹ç›®äº†ï¼Œå…¨æ ˆå¼€å‘é‚£å°±æ›´ä¹…è¿œäº†ã€‚Rails 6.0 æ”¹åŠ¨æ¯”è¾ƒå¤§ï¼Œå¾ˆå¤šæ–°çš„ç»„ä»¶æˆ‘è‡ªå·±ä¹Ÿè¿˜æ²¡æœ‰æ¥å¾—åŠç†Ÿæ‚‰ï¼Œæ‰€ä»¥è¿™ç¯‡æ–‡ç« å°±å…ˆä¸åšä¸Šé¢è§£å†³æ–¹æ¡ˆçš„åŸç†åˆ†æäº†ï¼Œä»…ä¸ºå¤‡å¿˜ï¼Œå¯èƒ½ä¼šæœ‰å…¶ä»–äººé‡åˆ°ä¸€æ ·çš„é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h3>
&lt;ul>
&lt;li>&lt;a href="https://qiita.com/NaokiIshimura/items/8203f74f8dfd5f6b87a0">Rails6 é–‹ç™ºæ™‚ã«ã¤ã¾ã¥ããã†ãª webpacker, yarn é–¢ä¿‚ã®ã‚¨ãƒ©ãƒ¼ã¨è§£æ±ºæ–¹æ³•&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>pymysql å¼€å¯è°ƒè¯•æ¨¡å¼</title><link>https://blog.hackerpie.com/posts/2019/enable-debug-mode-of-pymysql/</link><pubDate>Sun, 18 Aug 2019 18:32:01 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2019/enable-debug-mode-of-pymysql/</guid><description>&lt;p>ä»Šå¤©åœ¨æ’æŸ¥çº¿ä¸Šä¸€ä¸ªå¥‡æ€ªçš„æ•°æ®åº“è¿æ¥é—®é¢˜ï¼Œæ‰€ä»¥æ‰“å¼€äº† pymysql çš„æºç åœ¨é˜…è¯»ï¼Œå‘ç° pymysql åœ¨å…¶ &lt;code>connections&lt;/code> æ¨¡å—é‡Œå†…ç½®äº†ä¸€ä¸ª &lt;code>DEBUG&lt;/code> å˜é‡ç”¨äºæ§åˆ¶æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼ï¼Œæ˜¯çš„è¯ï¼Œä¼šå°†å½“å‰è¿æ¥çš„æ“ä½œä»¥åŠæŠ¥æ–‡å†…å®¹éƒ½æ‰“å°åˆ°æ§åˆ¶å°ã€‚&lt;/p>
&lt;h4 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•&lt;/h4>
&lt;p>åœ¨ä½ çš„æœåŠ¡å™¨åˆå§‹åŒ–ä»£ç é‡Œï¼ŒåŠ ä¸Šå¯¹ &lt;code>DEBUG&lt;/code> çš„è®¾ç½®ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-python" data-lang="python">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">import&lt;/span> &lt;span style="font-weight:bold">pymysql&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>pymysql.install_as_MySQLdb()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>pymysql.connections.DEBUG = &lt;span style="font-weight:bold">True&lt;/span> &lt;span style="font-style:italic"># è¿™æ˜¯æˆ‘æ–°åŠ çš„ä¸€è¡Œ&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‡å¯æœåŠ¡å™¨åï¼Œè®¿é—®ç›¸å…³æ¥å£ï¼Œä¼šçœ‹åˆ°æ ‡å‡†è¾“å‡ºé‡Œæœ‰ç±»ä¼¼ä¸‹é¢çš„ä¸€äº›è¾“å‡ºï¼š&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/pymysql-debug.png" alt="clipboard.png">
&lt;/p></description></item><item><title>django å¿«é€Ÿå¯åŠ¨æ•°æ®åº“å®¢æˆ·ç«¯ç¨‹åº</title><link>https://blog.hackerpie.com/posts/2019/quick-launch-database-client-in-django/</link><pubDate>Thu, 15 Aug 2019 08:18:30 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2019/quick-launch-database-client-in-django/</guid><description>&lt;p>å®é™…å·¥ä½œç»å†ä¸­ï¼Œå…ä¸äº†æœ‰æ—¶å€™éœ€è¦è¿æ¥æ•°æ®åº“è¿›è¡Œé—®é¢˜æ’æŸ¥åˆ†æçš„åœºæ™¯ï¼Œä¹‹å‰ä¸€ç›´ä¹ æƒ¯é€šè¿‡ &lt;code>mysql -uxxx -hxxxx -P1234 ...&lt;/code> è¿™æ ·çš„æ–¹å¼æ¥å¯åŠ¨å‘½ä»¤è¡Œå½¢å¼çš„ MySQL æ•°æ®åº“å®¢æˆ·ç«¯ç¨‹åºï¼Œåªæ˜¯ç”¨èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯æ¬¡éƒ½è¦æ‹·è´å„ä¸ªé…ç½®å‚æ•°ï¼Œè¿˜è¦è®°å¾—ä¸è¦åœ¨å‘½ä»¤é‡Œæ˜¾å¼æ‰“å°å¯†ç ã€‚åæ¥æƒ³èµ·æ¥åœ¨å¼€å‘ Ruby on Rails ç¨‹åºçš„æ—¶å€™ï¼Œå…¶æä¾›äº† &lt;code>rails dbconsole&lt;/code> çš„å‘½ä»¤ï¼Œå¯ä»¥æ–¹ä¾¿ç›´æ¥å¯åŠ¨å¯¹åº”çš„æ•°æ®åº“å®¢æˆ·ç«¯å‘½ä»¤è¡Œç¨‹åºï¼Œè”æƒ³åˆ° Django ç†è®ºä¸Šä¹Ÿæœ‰ï¼Œæ‰€ä»¥æ‰¾åˆ°äº† &lt;code>python manage.py dbshell&lt;/code> è¿™ä¸ªå‘½ä»¤ï¼Œä½¿ç”¨æ•ˆæœå’Œè‡ªå·±æ‰‹åŠ¨æ•² mysql å‘½ä»¤è¡Œæ˜¯ä¸€æ ·çš„ï¼Œçœå»ç¹ççš„å‚æ•°è®¾å®šæ­¥éª¤ã€‚&lt;/p>
&lt;h4 id="ä½¿ç”¨æ•ˆæœ">ä½¿ç”¨æ•ˆæœ&lt;/h4>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/dbshell.png" alt="clipboard.png">
&lt;/p>
&lt;h4 id="ç”¨æ³•">ç”¨æ³•&lt;/h4>
&lt;p>å…¶ç”¨æ³•å¯ä»¥ç›´æ¥æŸ¥è¯¢å‘½ä»¤è¡Œå¸®åŠ©æ–‡æ¡£ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code># python manage.py dbshell -h
Usage: manage.py dbshell [options]
Runs the command-line client for specified database, or the default database if none is provided.
Options:
-v VERBOSITY, --verbosity=VERBOSITY
Verbosity level; 0=minimal output, 1=normal output,
2=verbose output, 3=very verbose output
--settings=SETTINGS The Python path to a settings module, e.g.
&amp;#34;myproject.settings.main&amp;#34;. If this isn&amp;#39;t provided, the
DJANGO_SETTINGS_MODULE environment variable will be
used.
--pythonpath=PYTHONPATH
A directory to add to the Python path, e.g.
&amp;#34;/home/djangoprojects/myproject&amp;#34;.
--traceback Raise on exception
--database=DATABASE Nominates a database onto which to open a shell.
Defaults to the &amp;#34;default&amp;#34; database.
--version show program&amp;#39;s version number and exit
-h, --help show this help message and exit
&lt;/code>&lt;/pre></description></item><item><title>ä¸ä¸¥è°¨çš„ä¸åŒè¯­è¨€ä¸‹å¤§ Excel æ–‡ä»¶å†™å…¥çš„æ€§èƒ½æ¯”è¾ƒ</title><link>https://blog.hackerpie.com/posts/2019/general-excel-writor-benchmark-comparation-among-different-languages/</link><pubDate>Sat, 23 Mar 2019 21:11:06 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2019/general-excel-writor-benchmark-comparation-among-different-languages/</guid><description>&lt;h3 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h3>
&lt;p>å»å¹´å› ä¸ºçº¿ä¸Šç³»ç»Ÿéœ€è¦å¯¼å‡ºå¤§é‡æ•°æ®ï¼ˆå¤§æ¦‚æ˜¯ 11 ä¸‡è¡Œï¼‰åˆ° Excelï¼Œä»£ç æ˜¯ Python 2.7 å†™çš„ï¼Œé™¤å»æ•°æ®åº“æŸ¥è¯¢è€—æ—¶ï¼Œæ•´ä¸ªçš„ Excel æ–‡ä»¶ç”Ÿæˆä¹Ÿè¿˜è¦è€—è´¹å‡ åç§’çš„æ—¶é—´ï¼Œè¿™å¬èµ·æ¥çœŸæ˜¯ä¸€ä¸ªéå¸¸å¤¸å¼ çš„äº‹æƒ…ã€‚åæ¥ä¸ºå…¶æ›´æ¢äº†å·ç§°æ€§èƒ½è¡¨ç°æœ€å¥½çš„ pyexcelerate åº“ï¼Œæ€§èƒ½ç¡®å®æœ‰æå‡ï¼Œä½†æ˜¯ä»æ˜¯å·®å¼ºäººæ„çš„åœ¨å°å‡ åç§’ã€‚&lt;/p>
&lt;p>æ˜¨å¤©çªå‘å¥‡æƒ³ï¼Œå¦‚æœæ˜¯æ¢æˆå…¶ä»–è¯­è¨€ï¼Œè¿™ä¸ª excel å¯¼å‡ºæ˜¯å¦è¿˜éœ€è¦è¿™ä¹ˆé•¿æ—¶é—´ï¼Ÿäºæ˜¯ç»è¿‡ä¸€ç•ªè¯•éªŒä¹‹åï¼Œå°±æœ‰äº†ä»Šå¤©çš„è¿™ç¯‡æ–‡ç« ã€‚&lt;/p>
&lt;p>**ç‰¹åˆ«å£°æ˜ï¼š**è¯•éªŒåªæ˜¯ä¸ºäº†æ„Ÿå®˜ä¸Šåšä¸ªç®€å•å¯¹æ¯”ï¼Œæµ‹è¯•ç»“æœé‡‡é›†æ•°æ®åªè€ƒè™‘äº†è€—æ—¶ï¼Œæ²¡æœ‰è€ƒè™‘èµ„æºæ¶ˆè€—ç­‰æƒ…å†µï¼Œéœ€è¦ä¸¥è°¨çš„æ€§èƒ½å¯¹æ¯”çš„è¯»è€…ï¼Œå¯ä»¥æ”¾å¼ƒé˜…è¯»äº†ã€‚&lt;/p>
&lt;h3 id="æµ‹è¯•å†…å®¹">æµ‹è¯•å†…å®¹&lt;/h3>
&lt;p>ä½¿ç”¨ä¸åŒçš„è¯­è¨€åŠå…¶ç‰ˆæœ¬ï¼Œæµ‹è¯•å„è‡ªå®ŒæˆåŒ…å« 100,000 è¡Œ x 50 åˆ—å•å…ƒæ ¼çš„ excel æ–‡ä»¶çš„ç”Ÿæˆï¼Œå¯¹æ¯”å…¶å„è‡ªè€—è´¹æ—¶é—´ï¼Œ3æ¬¡é‡å¤æ‰§è¡Œå–å…¶å¹³å‡å€¼åè¿›è¡Œæ¨ªå‘æ¯”è¾ƒã€‚&lt;/p>
&lt;h4 id="å·²ç»æµ‹è¯•çš„è¯­è¨€åŠç‰ˆæœ¬">å·²ç»æµ‹è¯•çš„è¯­è¨€åŠç‰ˆæœ¬&lt;/h4>
&lt;ul>
&lt;li>Ruby 2.6 + axlsx 2.0.1&lt;/li>
&lt;li>Python 2.7 + pyexcelerate 0.7.3&lt;/li>
&lt;li>Python 3.6 + pyexcelerate 0.7.3&lt;/li>
&lt;li>Go 1.10.1 + gooxml 0.8&lt;/li>
&lt;/ul>
&lt;h4 id="æµ‹è¯•ä»£ç ">æµ‹è¯•ä»£ç &lt;/h4>
&lt;p>&lt;a href="https://github.com/Martin91/excel-writors-benchmark">https://github.com/Martin91/excel-writors-benchmark&lt;/a>&lt;/p>
&lt;h4 id="ç»“æœ">ç»“æœ&lt;/h4>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/benchmark-excel.png" alt="benchmark.png">
&lt;/p>
&lt;h4 id="ç»“è®º">ç»“è®º&lt;/h4>
&lt;p>å°±è¿™ä¸ªæµ‹è¯•åœºæ™¯æ¥è¯´ï¼š&lt;/p>
&lt;ol>
&lt;li>Go 1.10.1 + gooxml 0.8 æ˜¯æœ€å¿«çš„ï¼›&lt;/li>
&lt;li>åŒæ ·æ˜¯ pyexcelerate 0.7.3ï¼ŒPython 2.7 æ€§èƒ½ä¼˜äº Python 3.6;&lt;/li>
&lt;li>Ruby 2.6 + axlsx 2.0.1 è¡¨ç°æœ€ä¸ç»™åŠ›ï¼Œè¿™é‡Œæœ‰ä¸ªé¢˜å¤–è¯ï¼Œé€‰æ‹©çš„ axlsx æœ¬èº«å¹¶ä¸æ˜¯æ€§èƒ½æœ€å¥½çš„ gemï¼Œåªæ˜¯æµè¡Œåº¦å¤Ÿé«˜ï¼ŒRuby æœ‰ä¸€ä¸ªä¸“é—¨é’ˆå¯¹æ€§èƒ½ä¼˜åŒ–åçš„ gemï¼Œä½†æ˜¯å› ä¸ºçŸ¥ä¹‹ç”šå°‘ï¼Œæ²¡æœ‰é‡‡ç”¨ã€‚&lt;/li>
&lt;/ol></description></item><item><title>åˆ©ç”¨ Postman Chrome app å’Œ Chrome æµè§ˆå™¨å…±äº«ç½‘ç«™ cookie</title><link>https://blog.hackerpie.com/posts/2019/share-cookies-between-chrome-and-postman/</link><pubDate>Mon, 14 Jan 2019 09:22:19 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2019/share-cookies-between-chrome-and-postman/</guid><description>&lt;h3 id="å£°æ˜">å£°æ˜&lt;/h3>
&lt;p>æ–‡ç« å†…å®¹å·²è¿‡æœŸï¼ŒPostman æ¡Œé¢ç‰ˆå·²å®ç°æœ¬æ–‡æœ«å°¾çš„ç¼ºæ†¾ï¼Œå¯ç›´æ¥é˜…è¯»&lt;a href="https://blog.postman.com/introducing-interceptor-integration-for-native-postman-apps/">å®˜æ–¹åšå®¢&lt;/a>ã€‚&lt;/p>
&lt;h3 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h3>
&lt;p>ä½œä¸ºä¸€ä¸ªWebå·¥ç¨‹å¸ˆï¼Œæœ€ç†Ÿæ‚‰çš„æ—¥å¸¸å·¥ä½œè«è¿‡äºåå°æ¥å£å¼€å‘ä¸è”è°ƒæµ‹è¯•ï¼Œè€Œåœ¨æ¥å£æµ‹è¯•ä¸Šï¼Œå¤§å®¶æœ€å–œçˆ±çš„å·¥å…·æ¸…å•é‡Œï¼Œå¿…ç„¶å°‘ä¸äº† Postman è¿™ä¸€åˆ©å™¨ã€‚ç„¶è€Œï¼Œæœ‰æ—¶æ¥å£æµ‹è¯•éœ€è¦å‡†å¤‡å¥½ç™»å½•æ€ï¼Œæˆ–è€…å…¶ä»–çŠ¶æ€æ•°æ®ï¼Œè€Œè¿™äº›æ•°æ®å¾€å¾€å°±å­˜åœ¨æµè§ˆå™¨ Cookie é‡Œè¾¹ã€‚ç»“åˆæœ¬æ–‡ä»‹ç»çš„å·¥å…·ï¼Œä¾¿å¯ä»¥æ— ç¼åœ¨ Postman Chrome app ï¼ˆä¸ºä»€ä¹ˆå¼ºè°ƒæ˜¯ Postman Chrome appï¼Œæ–‡ç« æœ«å°¾ä¼šè¯´æ˜ï¼‰å’Œ Chrome æµè§ˆå™¨ä¹‹é—´å…±äº« Cookieï¼Œè€Œè¿™ä¸ªå…±äº«è¿‡ç¨‹å¯¹ç”¨æˆ·æ˜¯é€æ˜çš„ã€‚&lt;/p>
&lt;h3 id="å·¥å…·æ¸…å•">å·¥å…·æ¸…å•&lt;/h3>
&lt;p>ä»¥ä¸‹å·¥å…·è¯·è‡ªè¡Œå®‰è£…ï¼Œæˆ‘åªè´´ä¸‹å®˜æ–¹çš„è½¯ä»¶ç•Œé¢æˆªå›¾ã€‚&lt;/p>
&lt;ol>
&lt;li>Chrome æµè§ˆå™¨&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop?hl=en">Postman Chrome app&lt;/a>
&lt;img src="https://blog.hackerpie.com/images/posts/postman-app.png" alt="clipboard.png">
&lt;/li>
&lt;li>&lt;a href="https://chrome.google.com/webstore/detail/postman-interceptor/aicmkgpgakddgnaphhhpliifpcfhicfo?hl=en">Postman Interceptor&lt;/a>
&lt;img src="https://blog.hackerpie.com/images/posts/postman-interceptor.png" alt="clipboard.png">
&lt;/li>
&lt;/ol>
&lt;h3 id="ä½¿ç”¨æ­¥éª¤">ä½¿ç”¨æ­¥éª¤&lt;/h3>
&lt;p>ä»¥ä¸‹æˆ‘ä»¬ä»¥ Github ç½‘ç«™ä¸ºä¾‹ï¼Œæ¼”ç¤ºä¸‹å¦‚ä½•å®ç° Cookie å…±äº«ã€‚&lt;/p>
&lt;h4 id="ä¸€ç¡®è®¤-postman-interceptor-æ’ä»¶å®‰è£…æˆåŠŸå¦‚å›¾æ‰€ç¤º">ä¸€ã€ç¡®è®¤ &lt;strong>Postman Interceptor&lt;/strong> æ’ä»¶å®‰è£…æˆåŠŸï¼ˆå¦‚å›¾æ‰€ç¤ºï¼‰&lt;/h4>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/postman-interceptor-installed.png" alt="clipboard.png">
&lt;/p>
&lt;h4 id="äºŒå¯åŠ¨-postmanåœ¨å³ä¸Šè§’çš„å«æ˜Ÿå°å›¾æ ‡é‚£é‡Œå¼€å¯-chrome-interceptor">äºŒã€å¯åŠ¨ Postmanï¼Œåœ¨å³ä¸Šè§’çš„å«æ˜Ÿå°å›¾æ ‡é‚£é‡Œå¼€å¯ Chrome Interceptor&lt;/h4>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/enable-postman-interceptor.png" alt="clipboard.png">
&lt;/p>
&lt;h4 id="ä¸‰åœ¨-chrome-æµè§ˆå™¨é‡Œæ­£å¸¸ç™»é™†-github-ç½‘ç«™æ­¤æ­¥éª¤æ²¡ä»€ä¹ˆå¥½æ¼”ç¤ºçš„-">ä¸‰ã€åœ¨ Chrome æµè§ˆå™¨é‡Œæ­£å¸¸ç™»é™† GitHub ç½‘ç«™ï¼ˆæ­¤æ­¥éª¤æ²¡ä»€ä¹ˆå¥½æ¼”ç¤ºçš„ â•­(â•¯^â•°)â•®ï¼‰&lt;/h4>
&lt;h4 id="å››åœ¨-postman-chrome-app-ä¸­ç›´æ¥æ¨¡æ‹Ÿè¯·æ±‚é€šçŸ¥æ¥å£">å››ã€åœ¨ Postman Chrome app ä¸­ç›´æ¥æ¨¡æ‹Ÿè¯·æ±‚é€šçŸ¥æ¥å£&lt;/h4>
&lt;p>æ¥å£è·¯å¾„ï¼šhttps://github.com/notifications?_pjax=%23js-pjax-container
&lt;img src="https://blog.hackerpie.com/images/posts/chrome-visit.png" alt="clipboard.png">
ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è™½ç„¶æ²¡æœ‰å¯¹ Postman åšç‰¹æ®Šçš„ Cookie è®¾ç½®ï¼Œä½†æ˜¯å®ƒçš„è¯·æ±‚çš„ç™»å½•æ€éƒ½è¢«æœåŠ¡å™¨éªŒè¯é€šè¿‡äº†ï¼Œcookie å…±äº«æˆåŠŸï¼&lt;/p>
&lt;h3 id="å‡å¦‚è¿™ä¸ªæ—¶å€™é€€å‡ºæµè§ˆå™¨çš„ç™»å½•æ€å‘¢">å‡å¦‚è¿™ä¸ªæ—¶å€™é€€å‡ºæµè§ˆå™¨çš„ç™»å½•æ€å‘¢ï¼Ÿ&lt;/h3>
&lt;p>æˆ‘ä»¬å…ˆä» GitHub é€€å‡ºç™»å½•ï¼Œè¿˜æ˜¯åˆšæ‰çš„è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™çš„å“åº”æ˜¯ï¼š
&lt;img src="https://blog.hackerpie.com/images/posts/chrome-visit2.png" alt="clipboard.png">
æ˜¯çš„ï¼Œå› ä¸º Chrome é‡Œå·²ç»é€€å‡ºç™»å½•ï¼Œæ‰€ä»¥ Postman è¿™è¾¹ä¹Ÿè‡ªç„¶å¤±å»ç™»å½•æ€äº†ï¼Œè¯´æ˜ä¸¤è¾¹ Cookie æ˜¯åŒæ­¥çš„ã€‚&lt;/p>
&lt;h3 id="postman-interceptor-çš„-bonus">Postman Interceptor çš„ Bonus&lt;/h3>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/postman-inteceptor-configuration.png" alt="clipboard.png">
Postman Interceptor è¿˜æœ‰ä¸€ç‚¹æ¯”è¾ƒçˆ½çš„æ˜¯ï¼Œå®ƒçš„ &lt;code>Request Capture&lt;/code> æ”¯æŒæ•æ‰ Chrome æµè§ˆå™¨é‡Œçš„è¯·æ±‚è®°å½•ï¼Œå¹¶ä¸”è‡ªåŠ¨åŒæ­¥åˆ° Postman Chrome app é‡Œè¾¹ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ–¹ä¾¿ç›´æ¥åœ¨ Postman é‡Œè·å–åˆ°æˆ‘ä»¬éœ€è¦æµ‹è¯•çš„ç½‘ç»œè¯·æ±‚ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªè‡ªå·±å¡«å†™å‚æ•°ä¹‹ç±»çš„äº†ã€‚
&lt;img src="https://blog.hackerpie.com/images/posts/postman-history.png" alt="clipboard.png">
&lt;/p>
&lt;h3 id="ç¼ºé™·">ç¼ºé™·&lt;/h3>
&lt;p>é—æ†¾çš„æ˜¯ï¼ŒæŒ‰ç…§å®˜æ–¹è¯´æ˜ï¼Œç°åœ¨ Postman Interceptor çš„è¿™ä¸ªCookie å…±äº«è¿˜ä¸èƒ½æ”¯æŒç‹¬ç«‹å®‰è£…çš„æ¡Œé¢ç‰ˆï¼ˆä»å®˜æ–¹ä¸‹è½½è€Œä¸æ˜¯ä» Chrome åº”ç”¨å¸‚åœºä¸‹è½½ï¼‰çš„ Postman Desktopï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½ å¸Œæœ›ä½¿ç”¨ä¸Šè¿°åŠŸèƒ½ï¼Œä½ åªèƒ½å®‰è£…å› Postman Chrome appï¼Œè€Œè¿™ä¸ªç‰ˆæœ¬ç›¸å¯¹æ¡Œé¢ç‰ˆï¼ŒåŠŸèƒ½è‡ªç„¶ä¹Ÿä¼šå°‘ã€‚&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Note&lt;/strong>: Interceptor feature is supported only in our Postman Chrome Apps and is not available in Postman Desktop Apps at the moment.&lt;/p>
&lt;/blockquote>
&lt;p>å¦ä¸€æ–¹é¢ï¼Œè€ƒè™‘åˆ° Chrome æµè§ˆå™¨å°†ä¼šåœ¨ä¸ä¹…çš„å°†æ¥åœæ‰ Chrome apps çš„æ”¯æŒï¼Œå¯èƒ½è¿™ä¸ªæ–¹æ¡ˆä¹Ÿæ’‘ä¸äº†å¤ªä¹…ã€‚&lt;/p>
&lt;p>å¦‚æœä½ çœŸå¿ƒå¸Œæœ› Postman å°†ä¸Šè¿°åŠŸèƒ½åŠ åˆ°ä»–ä»¬çš„æ¡Œé¢ç‰ˆé‡Œï¼Œå¯ä»¥åˆ°&lt;a href="https://github.com/postmanlabs/postman-app-support/issues/1667">ä»–ä»¬çš„å®˜æ–¹GitHub issues&lt;/a>å»è¯·æ„¿ï¼Œä»–ä»¬æ­£åœ¨æ”¶é›†å¤§å®¶çš„æ„è§ã€‚ä½†æ˜¯â€¦â€¦è¿™ä¸ªè¯·æ„¿å¸–å·²ç»ä¸¤å¹´å¤šäº†ï¼Œè€Œå°±åœ¨æˆ‘è¡¨è¾¾è¯·æ±‚ä¹‹å‰çš„å‡ ä¸ªå°æ—¶åˆ°å‡ å¤©ä¹‹å‰ï¼Œéƒ½æœ‰äººé™†ç»­å»è¯·æ„¿ï¼Œæ‰€ä»¥ä¹Ÿä¸çŸ¥é“ä¼šä¸ä¼šçœŸçš„å¦‚æ„¿äº†ã€‚&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>å¯¹äºç¡®å®éœ€è¦è·å–ç½‘ç«™ cookie æ‰èƒ½å®Œæˆæ¥å£æµ‹è¯•çš„åœºæ™¯ï¼Œä¸Šè¿°æ–¹æ³•æœ‰ä¸€å®šçš„ä¾¿åˆ©æ€§ï¼Œä¹Ÿæ‰æœ‰å¿…è¦ä½¿ç”¨æˆ‘çš„æ–¹æ³•ï¼Œå…¶ä»–åœºæ™¯çš„æ¥å£æµ‹è¯•ï¼Œä½ ä»¬å°±æ— è§†æˆ‘å§ã€‚&lt;/p>
&lt;h3 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="http://blog.getpostman.com/2014/11/28/using-the-interceptor-to-read-and-write-cookies/">Postman: Using the Interceptor to read and write cookies&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://support.getpostman.com/hc/en-us/articles/203779012-How-do-I-access-Chrome-s-cookies-in-Postman-s-Chrome-App-">Postman Help Center: How do I access Chrome&amp;rsquo;s cookies in Postman&amp;rsquo;s Chrome App?&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://learning.getpostman.com/docs/postman/sending_api_requests/interceptor_extension/">Postman Learning Center: Interceptor extension&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.engadget.com/2016/08/19/google-ending-chrome-apps-for-mac-and-windows/">Google is phasing out Chrome apps for Mac and Windows&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>è®°ä¸€æ¬¡Redisæ•°æ®åº“é…ç½®å¯¼è‡´çš„è¿æ¥æ•°æ³„éœ²çš„é—®é¢˜</title><link>https://blog.hackerpie.com/posts/2018/ji-yi-ci-redisshu-ju-ku-pei-zhi-dao-zhi-de-lian-jie-shu-xie-lou-de-wen-ti/</link><pubDate>Sat, 10 Feb 2018 20:35:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/2018/ji-yi-ci-redisshu-ju-ku-pei-zhi-dao-zhi-de-lian-jie-shu-xie-lou-de-wen-ti/</guid><description>&lt;h3 id="é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯&lt;/h3>
&lt;p>å»å¹´åœ£è¯èŠ‚å½“å¤©ï¼Œçªç„¶æ”¶åˆ°ä¸€ä¸ªæˆ‘ç»æ‰‹è¿‡çš„é¡¹ç›®çš„å‘Šè­¦é‚®ä»¶ï¼Œé”™è¯¯æ¶ˆæ¯æ˜¾ç¤º**â€œRedis::CommandError: ERR max number of clients reachedâ€**ã€‚
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.002.jpeg" alt="Redis è¿æ¥æ•°å‘Šè­¦">
&lt;/p>
&lt;p>ä»€ä¹ˆæƒ…å†µï¼Ÿéš¾é“è¿™ä¸ªé¡¹ç›®ç¿»è½¦äº†ï¼Ÿç¬¬ä¸€ååº”æ˜¯è¿™å°æœåŠ¡å™¨è¿è¡Œç€è‡ªå»ºçš„ Redis æ•°æ®åº“ï¼Œä½†æ˜¯å®¢æˆ·ç«¯åªæœ‰åŒä¸ªå†…ç½‘çš„ä¸€ä¸ª Ruby on Rails çš„åº”ç”¨ï¼Œæ€ä¹ˆä¼šæœ‰è¿æ¥æ•°çˆ†æ‰çš„å¯èƒ½ï¼Ÿ&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h4 id="ç†è®ºè¿æ¥æ•°è®¡ç®—">ç†è®ºè¿æ¥æ•°è®¡ç®—&lt;/h4>
&lt;p>è€è¡²ææŒ‡ä¸€ç®—ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>sidekiq å®¢æˆ·ç«¯æ‰€éœ€è¿æ¥æ•°&lt;/strong>: å¯¹é¢ Rails åº”ç”¨æœ‰ 10 ä¸ª Unicorn å·¥ä½œè¿›ç¨‹ï¼Œæ¯ä¸ªunicornè¿›ç¨‹åˆå§‹åŒ–ä¸€ä¸ª sidekiq å®¢æˆ·ç«¯ï¼Œä¸€ä¸ª sidekiq å®¢æˆ·ç«¯é»˜è®¤è¿æ¥æ± å¤§å°æ˜¯ 5ï¼Œè€Œä¸”æ˜¯æ‡’æƒ°ç­–ç•¥ï¼ŒæŒ‰éœ€è¿æ¥çš„ï¼Œæœ€å¤§å€¼æ˜¯ 10 x 5 = 50ï¼›&lt;/li>
&lt;li>&lt;strong>æ˜¾å¼ Redis è¿æ¥&lt;/strong>: ç¨‹åºä»£ç é‡Œæœ‰ä¸€ä¸ª $redis å…¨å±€å˜é‡ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ª redis è¿æ¥ï¼Œ10ä¸ªå·¥ä½œè¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯ 10 ä¸ªè¿æ¥ï¼›&lt;/li>
&lt;li>&lt;strong>sidekiq æœåŠ¡ç«¯æ‰€éœ€è¿æ¥æ•°&lt;/strong>: sidekiq server ç«¯ concurrency é…ç½®æ˜¯ 10ï¼Œé‚£ä¹ˆæŒ‰ç…§å®˜æ–¹æ–‡æ¡£ï¼Œå¦æœ‰åŠ ä¸Š 2 ä¸ªè¿æ¥ï¼Œä¹Ÿå°±æ˜¯12ä¸ªè¿æ¥ï¼›&lt;/li>
&lt;li>&lt;strong>Rails cache æ‰€éœ€è¿æ¥æ•°&lt;/strong>: æŒ‰ç…§&lt;code>redis-store&lt;/code> gem æºç ï¼Œé»˜è®¤è¿æ¥æ± å¤§å°åº”è¯¥æ˜¯ 5ï¼Œ10ä¸ª unicorn å·¥ä½œè¿›ç¨‹ï¼ŒæŒ‰éœ€è¿æ¥ï¼Œæœ€å¤§å€¼æ˜¯ 10 x 5 = 50ã€‚&lt;/li>
&lt;/ol>
&lt;p>åœ¨ä¸è€ƒè™‘å…¶ä»–å¯èƒ½è¿˜ç”¨åˆ° Redis è¿æ¥çš„æƒ…å†µä¸‹ï¼Œç›®å‰å·²çŸ¥çš„æœ€å¤§ Redis è¿æ¥æ•°éœ€æ±‚æ˜¯ 122ï¼Œè¿™ä¸ªæ•°è¿œå°äº Redis ç†è®ºæœ€å¤§è¿æ¥æ•°å•Šï¼Œè€Œä¸”å½“æ—¶æ˜¾ç¤ºè¿æ¥æ•°åˆ°è¾¾ä¸Šä¸‡ï¼è€Œä¸”è¿™ä¸ªé¡¹ç›®å·²ç»å¾ˆå°‘è®¿é—®ï¼Œå‹åŠ›æå…¶å°ï¼Œä¸å¤§å¯èƒ½ä¼šè¾¾åˆ°ç†è®ºæ‰€éœ€è¿æ¥æ•°å•Šï¼&lt;/p>
&lt;p>ä¸€å®šæ˜¯æœ‰&lt;strong>æŸç§ç¥ç§˜åŠ›é‡&lt;/strong>åœ¨ä¸»å¯¼è¿™ä¸€åˆ‡ï¼ï¼ï¼&lt;/p>
&lt;h3 id="ç›‘æ§ä¸åˆ†æ">ç›‘æ§ä¸åˆ†æ&lt;/h3>
&lt;p>ä»¥ä¸Šç†è®ºæœ€å¤§è¿æ¥æ•°åˆ†æåªæ˜¯å®šæ€§åˆ†æï¼Œåªèƒ½å¤§æ¦‚è¯´æ˜æœ‰ä¸€äº›è¯¡å¼‚çš„ä¸œè¥¿å­˜åœ¨ï¼Œè€Œæƒ³çœŸæ­£ç¡®è®¤é—®é¢˜æ ¹æºï¼Œè¿˜å¾—åšå®šé‡åˆ†æï¼Œåªæœ‰æ•°æ®æ‰èƒ½è¯´æ˜ä¸€åˆ‡ï¼&lt;/p>
&lt;h4 id="åˆæ­¥è§‚å¯Ÿredis-æ•°æ®åº“æœåŠ¡å™¨ç«¯ç›‘æ§">åˆæ­¥è§‚å¯Ÿï¼šRedis æ•°æ®åº“æœåŠ¡å™¨ç«¯ç›‘æ§&lt;/h4>
&lt;p>äº‹ä¸å®œè¿Ÿï¼Œè¦é‡‡é›†æ•°æ®ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯åŠ ç›‘æ§ï¼Œæ‰€ä»¥å½“æ—¶å°±ç´§æ€¥å†™äº†ä¸€ä¸ªå®šæ—¶é‡‡é›† Redis å®¢æˆ·ç«¯æ•°é‡ï¼ˆä½¿ç”¨ redis å†…å»º &lt;code>CLIENT LIST&lt;/code> å‘½ä»¤ï¼‰çš„è„šæœ¬ï¼Œç»“åˆ crontab å®šæ—¶è¿è¡Œï¼Œå°†ç»“æœå†™å…¥æ–‡ä»¶ï¼Œä½œä¸ºåç»­åˆ†æçš„åŸºç¡€ã€‚
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.003.jpg" alt="ç›‘æ§è„šæœ¬">
&lt;/p>
&lt;p>é€šè¿‡ç›‘æ§è„šæœ¬ï¼Œå‘ç°å‡ ä¸ªæœ‰æ„æ€çš„ç°è±¡ï¼š&lt;/p>
&lt;ol>
&lt;li>ä» Redis æ•°æ®åº“æœåŠ¡ç«¯é‡‡é›†çš„æ•°æ®çœ‹ï¼Œ&lt;strong>ä¸€ç›´åªæœ‰æ¥è‡ªä¸€å°å†…ç½‘æœºå™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘å‰é¢è¯´çš„ Rails ç¨‹åºæ‰€åœ¨çš„æœåŠ¡å™¨çš„è¿æ¥&lt;/strong>ï¼Œè¯´æ˜è¿™ä¸ª Redis æ•°æ®åº“ä¸å­˜åœ¨å…±äº«ç»™å…¶ä»–åº”ç”¨çš„å¯èƒ½æ€§ï¼›&lt;/li>
&lt;li>ç»è¿‡3å¤©å·¦å³çš„ç›‘æ§ï¼Œå³ä»12.25åˆ°12.28ï¼Œè¿ç»­3å¤©ï¼ŒRedis è¿æ¥æ•°ä¸€ç›´ç¨³æ­¥ä¸Šå‡ï¼Œå¹³å‡æ¯æ—¥å¢åŠ  70-80ã€‚åœ¨å…¸å‹çš„ç³»ç»Ÿèµ„æºæ³„éœ²ç±»ï¼ˆæ¯”å¦‚å†…å­˜æ³„éœ²ï¼‰é—®é¢˜çš„åœºæ™¯ä¸­ï¼Œè¿™æ ·çš„çº¿æ¡çœ‹èµ·æ¥ç‰¹åˆ«ç†Ÿæ‚‰ï¼Œæ‰€ä»¥ï¼ŒçœŸçš„æ˜¯&lt;strong>è¿æ¥æ•°æ³„éœ²&lt;/strong>äº†ï¼Ÿ
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.004.jpeg" alt="è¿æ¥æ•°æ•°é‡ç¨³æ­¥æ”€å‡">
&lt;/li>
&lt;/ol>
&lt;h4 id="è¿›ä¸€æ­¥åˆ†æredis-æ•°æ®åº“æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯è¿æ¥æ•°å¯¹æ¯”åˆ†æ">è¿›ä¸€æ­¥åˆ†æï¼šRedis æ•°æ®åº“æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯è¿æ¥æ•°å¯¹æ¯”åˆ†æ&lt;/h4>
&lt;p>åœ¨æœ‰äº†ä¸Šä¸€æ­¥çš„å‘ç°ä¹‹åï¼Œæˆ‘ç»§ç»­ç”¨ç³»ç»Ÿå‘½ä»¤ &lt;code>sudo netstat -apnt&lt;/code> æ£€æŸ¥ &lt;code>6379&lt;/code> ç«¯å£è¿æ¥æ•°å‘ç°ï¼Œå®¢æˆ·ç«¯æœºå™¨ä¹Ÿæ‰åªæœ‰ 42 ä¸ªå·¦å³çš„è¿æ¥åˆ° redis æœåŠ¡å™¨ç«¯ï¼Œç»“åˆæœ€å¼€å§‹çš„ç†è®ºè¿æ¥æ•°åˆ†æï¼Œè¿™ä¸ªæ•°é‡æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼ä½†æ˜¯ï¼åè¿‡æ¥å»æœåŠ¡ç«¯æœºå™¨ç”¨åŒæ ·çš„å‘½ä»¤æ£€æŸ¥ï¼Œåœ¨æœåŠ¡ç«¯è§†è§’ï¼Œå´æœ‰å¤šè¾¾300+ä¸ªå®¢æˆ·ç«¯å»ºç«‹çš„è¿æ¥ï¼Œè€Œä¸”éƒ½æ˜¯åœ¨ ESTABLISHED çŠ¶æ€ï¼è¿™ä¸ªæ•°é‡å’Œä¸Šé¢å¦ä¸€ç§ç›‘æ§æ–¹å¼å¾—åˆ°çš„æ•°é‡ä¸€è‡´ï¼
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.005.jpeg" alt="æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯ TCP è¿æ¥æ•°ä¸åŒ¹é…">
&lt;/p>
&lt;p>åˆ°åº•æ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿè¿˜èƒ½æœ‰è¿™ç§æ“ä½œï¼Ÿ
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.006.jpeg" alt="æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯è°çœŸè°å‡">
&lt;/p>
&lt;h3 id="é—®é¢˜æ ¹æº">é—®é¢˜æ ¹æº&lt;/h3>
&lt;p>è‡³æ­¤ï¼ŒRedis è¿æ¥æ•°æ³„éœ²æ˜¯æ¿ä¸Šé’‰é’‰çš„äº‹æƒ…äº†ï¼Œå¯æ˜¯åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸ºæ­¤ï¼Œæˆ‘åœ¨ç½‘ä¸Šæœç´¢äº†å¾ˆå¤šé—®ç­”è·Ÿæ–‡ç« ï¼Œåæ¥æ€»ç®—æ‰¾åˆ°äº†ç­”æ¡ˆï¼Œæœä¸å…¶ç„¶ï¼Œè¿˜æ˜¯é»˜è®¤é…ç½®çš„é—®é¢˜ã€‚&lt;/p>
&lt;h4 id="redis-é»˜è®¤é…ç½®">Redis é»˜è®¤é…ç½®&lt;/h4>
&lt;blockquote>
&lt;p>redis ä¸ºäº†é¿å…å®¢æˆ·ç«¯è¿æ¥æ•°è¿‡å¤šï¼Œæœ‰ä¸€ä¸ªtimeouté…ç½®ï¼Œæ„æ€æ˜¯å¦‚æœè¿æ¥çš„ç©ºé—²æ—¶é—´è¶…è¿‡äº†timeoutçš„å€¼ï¼Œåˆ™å…³é—­è¿æ¥ã€‚é»˜è®¤é…ç½®æ˜¯0ï¼Œæ„æ€æ˜¯æ²¡æœ‰è¶…æ—¶é™åˆ¶ï¼Œæ°¸è¿œä¸å…³é—­è¿æ¥ã€‚ç”Ÿäº§ä¸Šæ˜¾ç„¶ä¸ä¼šé…ç½®0â€¦â€¦
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.007.jpeg" alt="redis timeouté…ç½®è§£é‡Š">
&lt;/p>
&lt;/blockquote>
&lt;p>OMGï¼èµ¶ç´§æ‰“å¼€æˆ‘ä»¬çš„ redis çš„é…ç½®æ–‡ä»¶éªŒè¯æ˜¯å¦å¦‚æ­¤ï¼Œæœä¸å…¶ç„¶ï¼Œredisä¸€ç›´ä¿æŒç€é»˜è®¤é…ç½®ï¼
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.008.jpeg" alt="redis timeout é»˜è®¤é…ç½®">
&lt;/p>
&lt;p>è‡³æ­¤ï¼Œå¾ˆå¥½è§£é‡Šä¸ºä»€ä¹ˆè¿æ¥æ•°ä¼šæ³„éœ²äº†ï¼Œå› ä¸ºæœ‰å¾ˆå¤šç©ºé—²æˆ–è€…å®é™…ä¸Šå®¢æˆ·ç«¯å·²ç»æ–­å¼€çš„è¿æ¥ï¼Œåœ¨æœåŠ¡å™¨ç«¯ä¸€ä¾§ä»ç„¶ä¿æŒç€ã€‚é‚£ä»€ä¹ˆæƒ…å†µä¼šå¯¼è‡´è¿™æ ·çš„æƒ…å†µå‘ç”Ÿå‘¢ï¼Ÿ&lt;/p>
&lt;p>æˆ‘çŒœæµ‹ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>ç½‘ç»œé€šä¿¡å·®&lt;/strong>: æŒ‰ç…§ TCP åè®®ï¼Œå®¢æˆ·ç«¯æ–­å¼€è¿æ¥æ—¶ï¼Œå‘æœåŠ¡å™¨ç«¯å‘é€ FIN ä¿¡å·ï¼Œä½†æ˜¯æœåŠ¡ç«¯æœªæ¥æ”¶åˆ°ï¼Œå®¢æˆ·ç«¯è¶…æ—¶åæ”¾å¼ƒç­‰å¾…ï¼Œç›´æ¥æ–­å¼€ï¼ŒæœåŠ¡ç«¯ç”±äºé€šä¿¡æ•…éšœï¼Œä¿æŒäº† ESTABLISHED çŠ¶æ€ï¼Œä¸è¿‡ç”±äºä¸¤ç«¯æœºå™¨åœ¨åŒä¸ªå†…ç½‘ï¼Œç½‘ç»œè´¨é‡æ²¡æœ‰ç†ç”±ä¸è¡Œï¼›&lt;/li>
&lt;li>&lt;strong>å®¢æˆ·ç«¯å¼‚å¸¸&lt;/strong>: å®¢æˆ·ç«¯è¿æ¥ä¹‹åï¼Œç”±äºä»£ç è¿è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´æœªæ­£å¸¸é‡Šæ”¾æˆ–è€…å…³é—­è¿æ¥ï¼Œsidekiq çš„workerå¾ˆå¯èƒ½å°±æœ‰è¿™ç±»é—®é¢˜ã€‚è¿™ä¸ªçš„å¯èƒ½æ€§éå¸¸å¤§ï¼Œæ¯•ç«Ÿæˆ‘æ—¥å¸¸å†™ bug (&lt;em>/Ï‰â•²&lt;/em>)ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="é—®é¢˜ä¿®å¤">é—®é¢˜ä¿®å¤&lt;/h3>
&lt;p>æ‰¾åˆ°é—®é¢˜æ ¹æºä¹‹åï¼Œä¿®å¤èµ·æ¥å°±ç®€ç›´å¤ªç®€å•äº†ã€‚äº‹å®ä¸Šï¼Œå¼€å‘é¢†åŸŸå°±æ˜¯å¦‚æ­¤ï¼Œç»å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†æ‰¾ bug ä¸Šï¼Œè€Œæ”¹æ‰bugï¼Œå¯èƒ½åªéœ€è¦ä¸€åˆ†é’Ÿä¸åˆ°ã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œä¿®æ”¹äº†ä¸‹ redis æ•°æ®åº“é…ç½®ï¼š
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.009.jpeg" alt="redis ä¿®æ”¹æˆå»ºè®®é…ç½®">
&lt;/p>
&lt;p>æˆåŠŸé‡å¯ redis ä¹‹åï¼Œé‡æ–°è¿è¡Œå‰é¢çš„ç›‘æ§è„šæœ¬ï¼Œä»¥ä¾¿è§‚å¯Ÿä¿®å¤åæƒ…å†µï¼Œåˆæ­¥å¯ä»¥ç¡®è®¤è¿™ä¸‹æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„è¿æ¥æ•°ä¸€è‡´äº†ï¼š&lt;/p>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.010.jpeg" alt="é…ç½®ç”Ÿæ•ˆé‡å¯åï¼Œå¤šæ¬¡é‡æ–°æ£€æŸ¥ä¸¤ç«¯çœ‹åˆ°çš„è¿æ¥æ•°ï¼Œéƒ½ä¸€ç›´ä¿æŒä¸€è‡´äº†ï¼Œè¯´æ˜æœåŠ¡ç«¯èƒ½æ­£å¸¸é‡Šæ”¾ä¸€äº› idle è¿æ¥äº†ã€‚">
&lt;/p>
&lt;p>å†åˆç»è¿‡å‡ å¤©çš„è„šæœ¬è‡ªåŠ¨é‡‡é›†æ•°æ®ååˆ†æï¼Œç³»ç»Ÿåˆæ¢å¤å¹³ç¨³è¿è¡Œäº†ï¼Œè¿æ¥æ•°ä¸€ç›´ç¨³å®šåœ¨ç†è®ºæœ€å¤§è¿æ¥æ•°ä¹‹ä¸‹ã€‚
&lt;img src="https://blog.hackerpie.com/images/posts/20180210/redis%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%b3%84%e9%9c%b2%e9%97%ae%e9%a2%98.011.jpeg" alt="redis è¿æ¥æ•°ç¨³å®šï¼Œç¨³å®šåœ¨ç†è®ºæœ€å¤§è¿æ¥æ•°ä¹‹ä¸‹">
&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>è¿™ä¸ªé—®é¢˜çš„æ ¹æºå…¶å®å¾ˆå°ï¼Œä½†æ˜¯æ’æŸ¥è¿‡ç¨‹è¿˜æ˜¯èŠ±äº†æŒºå¤šæ—¶é—´ï¼Œä¸»è¦æ˜¯éœ€è¦ç­‰å¾…é‡‡é›†åˆ°è¶³å¤Ÿçš„æ•°æ®åç”¨äºåˆ†æã€‚å…¶ä»–å¿ƒå¾—ä½“ä¼šï¼š&lt;/p>
&lt;ol>
&lt;li>ä¿æŠ¤â€œæ¡ˆå‘ç°åœºâ€å¾ˆé‡è¦ï¼Œè¦æƒ³æŒ–æ˜é—®é¢˜æ ¹æºï¼Œå¿…é¡»ä¿æŒç¯å¢ƒå¯é‡ç°ï¼Œè¿™æ¬¡å‡ºç°é—®é¢˜çš„æ—¶å€™è™½ç„¶ç¬¬ä¸€æ—¶é—´é‡å¯äº† redis ä½¿æœåŠ¡æ¢å¤ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰ä¿®æ”¹ä»»ä½•é…ç½®ï¼Œæ‰€ä»¥ä½¿å¾—åæ¥çš„ç›‘æ§èƒ½å¤Ÿå‘ç°é—®é¢˜æ ¹æºï¼›&lt;/li>
&lt;li>ä½¿ç”¨å¼€æºè½¯ä»¶ï¼Œå¿…é¡»å¯¹é»˜è®¤é…ç½®ä¿æŒè­¦æƒ•ï¼Œç›¸ä¿¡åº”è¯¥æœ‰äººä»¥å‰å¬è¯´è¿‡ redis é»˜è®¤ç›‘å¬&lt;code>0.0.0.0&lt;/code>æ¥æºè¯·æ±‚çš„å®‰å…¨æ¼æ´ï¼›&lt;/li>
&lt;li>è¿™ä¸ªé¡¹ç›®ç”±äºå¼€å§‹è¾ƒæ—©ï¼Œå½“æ—¶å¹¶æ²¡æœ‰è€ƒè™‘ä½¿ç”¨ Redis äº‘æ•°æ®åº“ï¼Œè‡ªå»ºæ•°æ®åº“æœ‰é£é™©ï¼Œéœ€è¦æ…é‡å¯¹å¾…ï¼Œå°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œä¸“ä¸šçš„äº‹æƒ…ï¼Œäº¤ç»™ä¸“ä¸šçš„äººå»åšã€‚&lt;/li>
&lt;/ol></description></item><item><title>è§£è¯» Rails: Migrations</title><link>https://blog.hackerpie.com/posts/archive/jie-du-rails-migrations/</link><pubDate>Sat, 14 Oct 2017 22:29:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/jie-du-rails-migrations/</guid><description>&lt;p>æ­¤æ–‡ç¿»è¯‘è‡ª&lt;a href="http://www.monkeyandcrow.com/blog/reading_rails_migrations/">Reading Rails - Migrations&lt;/a>ï¼Œé™äºæœ¬äººæ°´å¹³ï¼Œç¿»è¯‘ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡æ•™ï¼&lt;/p>
&lt;p>ä»Šå¤©æˆ‘ä»¬å°†ä¼šæ¢è®¨ä¸€ä¸‹ Rails ç»å¸¸è¢«å¿½è§†çš„å¯é çš„å·¥ä½œä¼™ä¼´ â€”â€” Migratorã€‚å®ƒæ˜¯å¦‚ä½•æœå¯»ä½ çš„ migrations å¹¶ä¸”æ‰§è¡Œå®ƒä»¬çš„å‘¢ï¼Ÿæˆ‘ä»¬å°†å†ä¸€æ¬¡æ…¢æ…¢åœ°æŒ–æ˜ Rails çš„æºä»£ç ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­æ…§æµ·æ‹¾ç ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>ä¸ºäº†è·Ÿéšæœ¬æ–‡çš„æ­¥éª¤ï¼Œè¯·ä½¿ç”¨&lt;a href="https://github.com/adamsanderson/qwandry">qwandry&lt;/a>æ‰“å¼€ç›¸å…³çš„ä»£ç åº“ï¼Œæˆ–è€…ç›´æ¥åœ¨&lt;a href="https://github.com/rails/rails/tree/5505c1d700f17e2009e1189a7aa6dafafe7062a4">Github&lt;/a>ä¸ŠæŸ¥çœ‹è¿™äº›ä»£ç ã€‚&lt;/p>
&lt;h3 id="åŠ¨èº«å¯ç¨‹">åŠ¨èº«å¯ç¨‹&lt;/h3>
&lt;p>åœ¨å±•å¼€è®¨è®ºä¹‹å‰ï¼Œæ­¤å¤„å¹¶æ— ç‰¹æ®Šå‡†å¤‡è¦æ±‚ã€‚æˆ–è®¸ä½ å·²ç»åˆ›å»ºå¥½äº†é¡¹ç›®æ‰€éœ€è¦çš„ä½†æ˜¯ä»æ˜¯ç©ºçš„æ•°æ®åº“ã€‚å¦‚æœä½ æ‰§è¡Œ &lt;code>rake db:migrate&lt;/code>ï¼Œæ‰€æœ‰çš„æœªæ‰§è¡Œçš„ migrations å°±ä¼šå¼€å§‹æ‰§è¡Œã€‚è®©æˆ‘ä»¬ä»æŸ¥çœ‹ &lt;code>databases.rake&lt;/code> é‡Œçš„ Rake ä»»åŠ¡çš„æºç å¼€å§‹åŠ¨èµ·æ¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>desc &lt;span style="font-style:italic">&amp;#34;Migrate the database (options: VERSION=x, VERBOSE=false, SCOPE=blog).&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>task &lt;span style="font-style:italic">:migrate&lt;/span> =&amp;gt; [&lt;span style="font-style:italic">:environment&lt;/span>, &lt;span style="font-style:italic">:load_config&lt;/span>] &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ActiveRecord::Migration.verbose = ENV[&lt;span style="font-style:italic">&amp;#34;VERBOSE&amp;#34;&lt;/span>] ? ENV[&lt;span style="font-style:italic">&amp;#34;VERBOSE&amp;#34;&lt;/span>] == &lt;span style="font-style:italic">&amp;#34;true&amp;#34;&lt;/span> : &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ActiveRecord::Migrator.migrate(ActiveRecord::Migrator.migrations_paths, ENV[&lt;span style="font-style:italic">&amp;#34;VERSION&amp;#34;&lt;/span>] ? ENV[&lt;span style="font-style:italic">&amp;#34;VERSION&amp;#34;&lt;/span>].to_i : &lt;span style="">nil&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è™½ç„¶æˆ‘ä»¬å¹¶ä¸æ‰“ç®—æ­éœ² Rake æœ¬èº«çš„å·¥ä½œæœºåˆ¶ï¼Œä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ‰§è¡Œ &lt;code>migrate&lt;/code> è¦æ±‚å¦å¤–ä¸¤ä¸ªä»»åŠ¡ &lt;code>[:environment, :load_config]&lt;/code> çš„é¦–å…ˆæ‰§è¡Œã€‚è¿™èƒ½ç¡®ä¿ Rails çš„è¿è¡Œç¯å¢ƒä»¥åŠä½ çš„ &lt;code>database.yml&lt;/code> æ–‡ä»¶è¢«åŠ è½½è¿›æ¥ã€‚&lt;/p>
&lt;p>ä¸Šé¢çš„ rake ä»»åŠ¡é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®äº† &lt;code>ActiveRecord::Migration&lt;/code> ä»¥åŠ &lt;code>ActiveRecord::Migrator&lt;/code>ã€‚ç¯å¢ƒå˜é‡æ˜¯ä¸€ç§éå¸¸æœ‰æ•ˆçš„å¯ç”¨äºå‘ä½ çš„åº”ç”¨ç¨‹åºä¼ é€’ä¿¡æ¯çš„æ–¹å¼ã€‚ç¼ºçœåœ°ï¼Œè¯¸å¦‚&lt;code>USER&lt;/code>çš„å¾ˆå¤šï¼ˆç¯å¢ƒï¼‰å˜é‡éƒ½æ˜¯å·²ç»è®¾ç½®å¥½çš„ï¼Œä»–ä»¬ä¹Ÿå¯ä»¥åœ¨æ¯ä¸ªï¼ˆç»ˆç«¯ï¼‰å‘½ä»¤æ‰§è¡Œæ—¶å•ç‹¬è®¾ç½®ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ é€šè¿‡ &lt;code>VERBOSE=false rake db:migrate&lt;/code> è°ƒç”¨äº† Rake ä»»åŠ¡ï¼Œ&lt;code>ENV[&amp;quot;VERBOSE&amp;quot;]&lt;/code>çš„å€¼å°±ä¼šæ˜¯å­—ç¬¦ä¸²&lt;code>&amp;quot;false&amp;quot;&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># é€šè¿‡ç¯å¢ƒå˜é‡å¯åŠ¨ irbï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># &amp;gt; FOOD=cake irb&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ENV[&lt;span style="font-style:italic">&amp;#39;FOOD&amp;#39;&lt;/span>] &lt;span style="font-style:italic">#=&amp;gt; &amp;#39;cake&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ENV[&lt;span style="font-style:italic">&amp;#39;USER&amp;#39;&lt;/span>] &lt;span style="font-style:italic">#=&amp;gt; &amp;#39;adam&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>ENV[&lt;span style="font-style:italic">&amp;#39;WAFFLES&amp;#39;&lt;/span>] &lt;span style="font-style:italic">#=&amp;gt; nil&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>migration çš„çœŸæ­£å·¥ä½œæ˜¯ä» &lt;code>ActiveRecord::Migrator.migrate&lt;/code> å¼€å§‹çš„ï¼Œè¿™ä¸ªæ–¹æ³•æ¥å—äº†ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºè¡¨ç¤º migrations æ–‡ä»¶å¯èƒ½å­˜åœ¨çš„è·¯å¾„çš„é›†åˆï¼Œå¦å¤–è¿˜æœ‰ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œç”¨äºè¡¨ç¤º migrate æ‰§è¡Œçš„ç›®æ ‡ç‰ˆæœ¬ã€‚&lt;/p>
&lt;h3 id="æœå¯»-migrations">æœå¯» migrations&lt;/h3>
&lt;p>ç°åœ¨å°±æ‰“å¼€ ActiveRecord é‡Œçš„ &lt;code>migration.rb&lt;/code> æ–‡ä»¶ï¼Œä¸è¿‡åœ¨æ·±å…¥æ¢ç©¶ä¹‹å‰ï¼Œå…ˆæŸ¥çœ‹ä¸‹åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œæœ€ä¸Šé¢å®šä¹‰çš„å¼‚å¸¸ã€‚å®šä¹‰è‡ªå®šä¹‰çš„å¼‚å¸¸æ˜¯éå¸¸å®¹æ˜“çš„ï¼Œ&lt;code>migration.rb&lt;/code> é‡Œå°±æœ‰ä¸€äº›ä¸é”™çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">ActiveRecord&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># å¯ä»¥ç”¨äºåœ¨å›æ»šè¿‡ç¨‹ä¸­ä¸­æ­¢ migrations çš„å¼‚å¸¸ç±»&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">IrreversibleMigration&lt;/span> &amp;lt; ActiveRecordError
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">IllegalMigrationNameError&lt;/span> &amp;lt; ActiveRecordError&lt;span style="font-style:italic">#:nodoc:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> initialize(name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">super&lt;/span>(&lt;span style="font-style:italic">&amp;#34;Illegal name for migration file: &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>name&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\n\t&lt;/span>&lt;span style="font-style:italic">(only lower case letters, numbers, and &amp;#39;_&amp;#39; allowed)&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åƒæˆ‘ä»¬åœ¨ä¹‹å‰è®² &lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/05/jie-du-rails-chu-li-yi-chang/">Rails å¤„ç†å¼‚å¸¸&lt;/a> çš„æ–‡ç« ä¸­ä¸€æ ·ï¼Œè‡ªå®šä¹‰å¼‚å¸¸èƒ½å¤Ÿè¢«ç‰¹åˆ«å¤„ç†ã€‚åœ¨è¿™ä¸ªæ¡ˆä¾‹é‡Œï¼Œ&lt;code>IrreversibleMigration&lt;/code> è¡¨ç¤ºå½“å‰çš„ &lt;code>migration&lt;/code> ä¸èƒ½è¢«å›æ»šã€‚å¦å¤–ä¸€ä¸ªéœ€è¦å®šä¹‰ä½ è‡ªå·±çš„å¼‚å¸¸çš„åŸå› æ˜¯ï¼Œå¯ä»¥åƒ&lt;code>IllegalMigrationNameError&lt;/code>ä¸€æ ·ï¼Œé€šè¿‡é‡å®šä¹‰&lt;code>initialize&lt;/code>æ–¹æ³•æ¥å®ç°ç”Ÿæˆä¸€è‡´çš„é”™è¯¯æ¶ˆæ¯ã€‚åŒæ—¶ï¼Œè¦ç¡®ä¿ä½ è°ƒç”¨äº† &lt;code>super&lt;/code>ã€‚&lt;/p>
&lt;p>ç°åœ¨å‘ä¸‹æ»šåŠ¨ï¼ˆæ–‡ä»¶ï¼‰ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ &lt;code>Migrator.migrate&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Migrator&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">class&lt;/span> &amp;lt;&amp;lt; self
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> migrate(migrations_paths, target_version = &lt;span style="">nil&lt;/span>, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">case&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">when&lt;/span> target_version.nil?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> up(migrations_paths, target_version, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">when&lt;/span> current_version &amp;gt; target_version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> down(migrations_paths, target_version, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> up(migrations_paths, target_version, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å–å†³äº &lt;code>target_version&lt;/code>ï¼Œæˆ‘ä»¬å°†é€šè¿‡ &lt;code>up&lt;/code> æˆ–è€… &lt;code>down&lt;/code> å®Œæˆ migrateã€‚è¿™ä¸¤ä¸ªæ–¹æ³•éµå¾ªäº†åŒæ ·çš„æ¨¡å¼ï¼Œéƒ½æ˜¯æ‰«æäº† &lt;code>migration_paths&lt;/code> é‡Œçš„å¯æ‰§è¡Œçš„ migrationsï¼Œç„¶ååˆå§‹åŒ–ä¸€ä¸ªæ–°çš„ &lt;code>Migrator&lt;/code> çš„å®ä¾‹ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™äº› migrations æ˜¯å¦‚ä½•è¢«æœå¯»åˆ°çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Migrator&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">class&lt;/span> &amp;lt;&amp;lt; self
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> migrations(paths)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> paths = Array(paths)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> files = Dir[*paths.map { |p| &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>p&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">/**/[0-9]*_*.rb&amp;#34;&lt;/span> }]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> migrations = files.map &lt;span style="font-weight:bold">do&lt;/span> |file|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> version, name, scope = file.scan(&lt;span style="font-style:italic">/([0-9]+)_([_a-z0-9]*)\.?([_a-z0-9]*)?\.rb\z/&lt;/span>).first
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span> IllegalMigrationNameError.new(file) &lt;span style="font-weight:bold">unless&lt;/span> version
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> version = version.to_i
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name = name.camelize
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> MigrationProxy.new(name, version, file, scope)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> migrations.sort_by(&amp;amp;&lt;span style="font-style:italic">:version&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªæ–¹æ³•é‡Œæ»¡æ˜¯éå¸¸å€¼å¾—å­¦ä¹ çš„å®ä¾‹ï¼Œè®©æˆ‘ä»¬åœç•™å‡ åˆ†é’Ÿå¹¶ä¸”ä»”ç»†é˜…è¯»å®ƒã€‚æœ€å¼€å§‹ï¼Œä»£ç é‡Œé€šè¿‡ä¸€ä¸ª &lt;code>Array()&lt;/code> æ–¹æ³•è¿™æ ·çš„å°æŠ€å·§ï¼Œç¡®ä¿äº†å‚æ•°å§‹ç»ˆæ˜¯æ•°ç»„ç±»å‹ã€‚â€œä½ è¯´è¿™ï¼ˆArrayï¼‰æ˜¯ä¸ªæ–¹æ³•ï¼Ÿâ€æ˜¯çš„ï¼è¿™è™½ç„¶ä¸æ˜¯å¾ˆæ­£ç»Ÿï¼Œä½†å®šä¹‰ä¸€ä¸ªé©¼å³°å¼å‘½åçš„æ–¹æ³•æ˜¯åˆæ³•çš„ï¼Œç”šè‡³è¿™æ ·çš„æ–¹æ³•åè¿˜å¯ä»¥å’Œç±»åŒåï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Flummox&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> Flummox()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;confusing&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Flummox &lt;span style="font-style:italic">#=&amp;gt; Flummox&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Flummox.new &lt;span style="font-style:italic">#=&amp;gt; #&amp;lt;Flummox:0x0000000bf0b5d0&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Flummox() &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;confusing&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ruby ä½¿ç”¨äº†è¿™ä¸ªç‰¹æ€§å®šä¹‰äº†ä¸€ä¸ª &lt;code>Array()&lt;/code> æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å§‹ç»ˆè¿”å›ä¸€ä¸ªæ•°ç»„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>Array(&lt;span style="">nil&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; []&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Array([]) &lt;span style="font-style:italic">#=&amp;gt; []&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Array(1) &lt;span style="font-style:italic">#=&amp;gt; [1]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Array(&lt;span style="font-style:italic">&amp;#34;Hello&amp;#34;&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; [&amp;#34;Hello&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Array([&lt;span style="font-style:italic">&amp;#34;Hello&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;World&amp;#34;&lt;/span>]) &lt;span style="font-style:italic">#=&amp;gt; [&amp;#34;Hello&amp;#34;, &amp;#34;World&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªæ–¹æ³•ç±»ä¼¼äº &lt;code>to_a&lt;/code>ï¼Œä½†æ˜¯å¯ä»¥åœ¨ä»»ä½•ï¼ˆç±»å‹çš„ï¼‰å¯¹è±¡ä¸Šè°ƒç”¨ã€‚Rails é€šè¿‡ &lt;code>paths = Array(paths)&lt;/code>ä½¿ç”¨äº†è¿™ä¸ªï¼ˆæ–¹æ³•ï¼‰ï¼Œå¾—ä»¥ç¡®ä¿ &lt;code>paths&lt;/code> å°†æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚&lt;/p>
&lt;p>åœ¨æ¥ä¸‹æ¥ä¸€è¡Œçš„ä»£ç é‡Œï¼ŒRails æœå¯»äº†æŒ‡å®šçš„è·¯å¾„å¹¶ä¸”è¿›è¡Œäº†è¿‡æ»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>files = Dir[*paths.map { |p| &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>p&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">/**/[0-9]*_*.rb&amp;#34;&lt;/span> }]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®©æˆ‘ä»¬å°†è¿™ä¸ªä»£ç åˆ†è§£ä¸€ä¸‹ã€‚&lt;code>paths.map { |p| &amp;quot;#{p}/**/[0-9]*_*.rb&amp;quot; }&lt;/code>å°†æ¯ä¸€ä¸ªè·¯å¾„è½¬æ¢æˆä¸€ä¸ª [&lt;code>shell glob&lt;/code>](&lt;a href="http://en.wikipedia.org/wiki/Glob_(programming">http://en.wikipedia.org/wiki/Glob_(programming&lt;/a>))ã€‚ä¸€ä¸ªç±»ä¼¼ &lt;code>&amp;quot;db/migrate&amp;quot;&lt;/code> çš„è·¯å¾„å°±å˜æˆäº† &lt;code>&amp;quot;db/migrate/**/[0-9]*_*.rb&amp;quot;&lt;/code>ï¼Œè¿™å°†ä¼šåœ¨ &lt;code>&amp;quot;db/migrate&amp;quot;&lt;/code> æˆ–è€…å®ƒçš„æ‰€æœ‰å­ç›®å½•é‡ŒåŒ¹é…æ‰€æœ‰ç”¨æ•°å­—å¼€å¤´çš„æ–‡ä»¶ã€‚è¿™äº›ï¼ˆshell glob è¡¨ç¤ºçš„ï¼‰è·¯å¾„é€šè¿‡ &lt;code>*&lt;/code> æ“ä½œç¬¦åˆ†æˆï¼ˆå•ä¸ªå…ƒç´ ï¼‰å¹¶ä¸”ä¼ é€’ç»™äº† &lt;code>Dir[]&lt;/code>ã€‚&lt;/p>
&lt;p>&lt;code>Dir[]&lt;/code> æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚å®ƒæ¥æ”¶ç±»ä¼¼ &lt;code>&amp;quot;db/migrate/**/[0-9]*_*.rb&amp;quot;&lt;/code> è¿™æ ·çš„æ¨¡å¼ï¼ˆä½œä¸ºå‚æ•°ï¼‰ï¼Œç„¶åè¿”å›åŒ¹é…çš„æ–‡ä»¶åˆ—è¡¨ã€‚å½“ä½ éœ€è¦åœ¨æŒ‡å®šè·¯å¾„é‡ŒæŸ¥æ‰¾æ–‡ä»¶çš„æ—¶å€™ï¼Œ&lt;code>Dir[]&lt;/code> å°±æ˜¯ç§°æ‰‹åˆ©å™¨ã€‚å…¶ä¸­ï¼Œ&lt;code>**&lt;/code> è¡¨ç¤ºé€’å½’åœ°åœ¨æ‰€æœ‰å­ç›®å½•ä¸­æ‰§è¡ŒåŒ¹é…ï¼Œè€Œ &lt;code>*&lt;/code> åˆ™è¡¨ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦çš„é€šé…ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå‰é¢çš„è¿™ä¸ªæ¨¡å¼å°±æ˜¯ä¸ºäº†åŒ¹é…ç±»ä¼¼ &lt;code>20131127051346_create_people.rb&lt;/code> çš„ migrations ï¼ˆæ–‡ä»¶ï¼‰ã€‚&lt;/p>
&lt;p>Rails éå†æ¯ä¸€ä¸ªåŒ¹é…çš„æ–‡ä»¶ï¼Œå¹¶ä¸”é€šè¿‡ &lt;code>String#scan&lt;/code> ç»“åˆæ­£åˆ™è¡¨è¾¾å¼æå–ä¿¡æ¯ã€‚å¦‚æœä½ å¯¹æ­£åˆ™è¡¨è¾¾å¼ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œé‚£ç°åœ¨å°±åº”è¯¥æŠ›å¼€ä¸€åˆ‡ï¼Œå…ˆå­¦ä¹ å¥½æ­£åˆ™è¡¨è¾¾å¼å†è¯´ã€‚&lt;code>String#scan&lt;/code> ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›æ‰€æœ‰åŒ¹é…çš„ç»“æœã€‚å¦‚æœè¡¨è¾¾å¼é‡Œè¿˜åŒ…å«äº† capturing groupsï¼ˆåŒ¹é…åˆ†ç»„ï¼‰ï¼Œå®ƒä»¬å°†ä¼šä»¥å†…åµŒæ•°ç»„ï¼ˆsubarraysï¼‰çš„æ–¹å¼è¿”å›ã€‚æ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>s = &lt;span style="font-style:italic">&amp;#34;123 abc 456&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># æ²¡æœ‰ capturing groups:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>s.scan(&lt;span style="font-style:italic">/\d+/&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; [&amp;#34;123&amp;#34;, &amp;#34;456&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>s.scan(&lt;span style="font-style:italic">/\d+\s\w+/&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; [&amp;#34;123 abc&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># å…ˆåŒ¹é…æ•°å­—ï¼Œå†åŒ¹é…å•è¯ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>s.scan(&lt;span style="font-style:italic">/(\d+)\s+(\w+)/&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; [[&amp;#34;123&amp;#34;, &amp;#34;abc&amp;#34;]]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€ä»¥ &lt;code>file.scan&lt;/code> å°†ä¼šåŒ¹é…ç‰ˆæœ¬å·&lt;code>([0-9]+)&lt;/code>ï¼Œåå­—&lt;code>([_a-z0-9]*)&lt;/code>ï¼Œä»¥åŠä¸€ä¸ªå¯é€‰çš„ scope &lt;code>([_a-z0-9]*)?&lt;/code>ã€‚ç”±äº &lt;code>String#scan&lt;/code> å§‹ç»ˆè¿”å›æ•°ç»„ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ¨¡å¼åªä¼šå‡ºç°ä¸€æ¬¡ï¼Œæ‰€ä»¥ Rails ç›´æ¥æå–ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœã€‚Rails ä¸€æ¬¡æ€§æ‰§è¡Œäº†å¤šä¸ªå˜é‡èµ‹å€¼ &lt;code>version, name, scope = ...&lt;/code>ã€‚è¿™æ˜¯å¾—ç›Šäºæ•°ç»„çš„è§£æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>version, name, scope = [&lt;span style="font-style:italic">&amp;#34;20131127051346&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;create_people&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>version &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;20131127051346&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>name &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;create_people&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>scope &lt;span style="font-style:italic">#=&amp;gt; nil&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„ä¸€ä¸‹ï¼Œå¦‚æœï¼ˆç­‰å·å·¦è¾¹ï¼‰å˜é‡çš„æ•°é‡å¤§äºï¼ˆç­‰å·å³è¾¹ï¼‰æ•°ç»„çš„å…ƒç´ çš„æ•°é‡ï¼Œå¤šä½™å˜é‡çš„å€¼å°†ä¼šè¢«èµ‹å€¼ä¸º&lt;code>nil&lt;/code>ã€‚è¿™æ˜¯ä¸€ç§ä»æ­£åˆ™è¡¨è¾¾å¼ï¼ˆåŒ¹é…åçš„å€¼ï¼‰è¿›è¡Œå¤šä¸ªèµ‹å€¼çš„å¿«æ·æŠ€å·§ã€‚&lt;/p>
&lt;p>åŒ¹é…çš„ç‰ˆæœ¬å· version é€šè¿‡ &lt;code>to_i&lt;/code> æ–¹æ³•è½¬æ¢ä¸ºä¸€ä¸ªæ•´æ•°ï¼ˆFixnumï¼‰ï¼Œè€ŒåŒæ—¶ï¼Œåå­— name é€šè¿‡ &lt;code>name.camelize&lt;/code> å®Œæˆäº†æ ¼å¼è½¬æ¢ã€‚&lt;code>String#camelize&lt;/code>æ˜¯ &lt;code>ActiveSupport&lt;/code> é‡Œçš„æ–¹æ³•ï¼Œç”¨äºä¸‹åˆ’çº¿å‘½å &lt;code>snake_case&lt;/code> å’Œ é©¼å³°å¼å‘½å &lt;code>CamelCase&lt;/code> ä¹‹é—´çš„ç›¸äº’è½¬æ¢ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥å°† &lt;code>&amp;quot;create_people&amp;quot;&lt;/code> è½¬æ¢ä¸º &lt;code>CreatePeople&lt;/code>ã€‚&lt;/p>
&lt;p>è®©æˆ‘ä»¬è¿‡ä¼šå†çœ‹ä¸‹ &lt;code>MigrationProxy&lt;/code>ï¼Œç°åœ¨å…ˆçœ‹ä¸‹ &lt;code>Migrator#migrations&lt;/code> è¿™ä¸ªæ–¹æ³•çš„æœ€åä¸€ä¸ªéƒ¨åˆ†ï¼Œ&lt;code>migrations.sort_by(&amp;amp;:version)&lt;/code>ã€‚è¿™ä¸ªè¡¨è¾¾å¼å°†æ‰€æœ‰ migrations åŸºäºç‰ˆæœ¬å·è¿›è¡Œäº†æ’åºã€‚å¦‚ä½•æ’åºçš„æ–¹å¼ä¼šæ˜¯æ›´æœ‰è¶£çš„å†…å®¹ã€‚&lt;/p>
&lt;p>ä» Ruby 1.9 å¼€å§‹ï¼Œ&lt;code>&amp;amp;&lt;/code>æ“ä½œå°†ä¼šåœ¨è¢«å®ƒä½œç”¨çš„å¯¹è±¡ä¸Šè°ƒç”¨ &lt;code>to_proc&lt;/code> æ–¹æ³•ã€‚å½“åœ¨ä¸€ä¸ª symbol ä¸Šè°ƒç”¨æ—¶ï¼Œè¿”å›çš„ç»“æœæ˜¯ä¸€ä¸ªä»£ç å—é‡Œè°ƒç”¨ä¸ symbol åŒå‘½åçš„æ–¹æ³•çš„ &lt;code>Proc&lt;/code> å¯¹è±¡ã€‚æ‰€ä»¥ &lt;code>&amp;amp;:version&lt;/code> ç­‰åŒäºæŸè¡Œä»£ç çš„ &lt;code>{|obj| obj.version }&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>Library = Struct.new(&lt;span style="font-style:italic">:name&lt;/span>, &lt;span style="font-style:italic">:version&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>libraries = [
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Library.new(&lt;span style="font-style:italic">&amp;#34;Rails&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;4.0.1&amp;#34;&lt;/span>),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Library.new(&lt;span style="font-style:italic">&amp;#34;Rake&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;10.1.0&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>libraries.map{|lib| lib.version } &lt;span style="font-style:italic">#=&amp;gt; [&amp;#34;4.0.1&amp;#34;, &amp;#34;10.1.0&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># &amp;amp;:version =&amp;gt; Proc.new{|lib| lib.version } (Roughly)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>libraries.map(&amp;amp;&lt;span style="font-style:italic">:version&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; [&amp;#34;4.0.1&amp;#34;, &amp;#34;10.1.0&amp;#34;]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ Rails é‡Œï¼Œè¿™ç§æŠ€å·§åœ¨æ’åºæˆ–è€…æ˜ å°„çš„æ—¶å€™éå¸¸å¸¸è§ã€‚å’Œä¼—å¤šçš„æŠ€å·§ä¸€æ ·ï¼Œè¯·ç¡®è®¤ä½ çš„å›¢é˜Ÿèƒ½å¤Ÿé€‚åº”è¿™ç§è¯­æ³•ã€‚å¦‚æœ‰ç–‘è™‘ï¼Œæ›´å¥½çš„æ–¹æ¡ˆå°±æ˜¯ä¸å†ä½¿ç”¨ï¼ˆè¿™ç§æŠ€å·§ï¼‰ï¼Œè¿™ä¼šè®©ä»£ç æ›´æ¸…æ™°ã€‚&lt;/p>
&lt;h3 id="the-migration">The Migration&lt;/h3>
&lt;p>ç°åœ¨ï¼Œå›åˆ° &lt;code>MigrationProxy&lt;/code>ã€‚é¡¾åæ€ä¹‰ï¼Œåªæ˜¯ä¸€ä¸ª &lt;code>Migration&lt;/code> çš„å®ä¾‹çš„ä»£ç†ã€‚ä»£ç†å¯¹è±¡ï¼ˆProxy objectsï¼‰æ˜¯ä¸€ä¸ªå¸¸è§çš„ç”¨äºé€æ˜åœ°å°†ä¸€ä¸ªå¯¹è±¡æ›¿æ¢ä¸ºå¦ä¸€ä¸ªå¯¹è±¡çš„è®¾è®¡æ¨¡å¼ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ&lt;code>MigrationProxy&lt;/code>ä»£æ›¿äº†ä¸€ä¸ªçœŸæ­£çš„ &lt;code>Migration&lt;/code> å¯¹è±¡ï¼Œè€Œä¸”é™¤éå¿…éœ€ï¼Œå®ƒä¼šå»¶ç¼“å¯¹ migration çš„æºç çš„å®é™…çš„åŠ è½½ã€‚&lt;code>MigrationProxy&lt;/code> é€šè¿‡å§”æ‰˜æ–¹æ³•ï¼ˆdelegating methodsï¼‰è¾¾åˆ°ç›®çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">MigrationProxy&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> delegate &lt;span style="font-style:italic">:migrate&lt;/span>, &lt;span style="font-style:italic">:announce&lt;/span>, &lt;span style="font-style:italic">:write&lt;/span>, &lt;span style="font-style:italic">:disable_ddl_transaction&lt;/span>, &lt;span style="font-style:italic">to&lt;/span>: &lt;span style="font-style:italic">:migration&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">private&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> migration
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @migration ||= load_migration
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> load_migration
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> require(File.expand_path(filename))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name.constantize.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>delegate&lt;/code> æ–¹æ³•å°†å®ƒçš„æ¯ä¸€ä¸ªå‚æ•°éƒ½å‘é€ç»™äº† &lt;code>to:&lt;/code> é€‰é¡¹è¿”å›çš„å¯¹è±¡ï¼Œåœ¨è¿™é‡Œï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯æˆ‘ä»¬çš„ &lt;code>migration&lt;/code>ã€‚å¦‚æœ &lt;code>@migration&lt;/code> å®ä¾‹å˜é‡å°šæœªå®šä¹‰æˆ–èµ‹å€¼ï¼Œ&lt;code>migration&lt;/code> æ–¹æ³•å°†ä¼šæ‰§è¡Œæ‡’åŠ è½½migration &lt;code>load_migration&lt;/code>ã€‚&lt;code>load_migration&lt;/code> æ–¹æ³•æŒ‰åºåŠ è½½(require) ruby æºç ï¼Œç„¶åä½¿ç”¨ &lt;code>name.constantize.new&lt;/code> åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚&lt;code>String#constantize&lt;/code> æ˜¯ ActiveSupport ä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œç”¨äºè¿”å›åå­—ä¸å­—ç¬¦ä¸²ç›¸åŒçš„å¸¸é‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&amp;#34;Person&amp;#34;&lt;/span>.constantize &lt;span style="font-style:italic">#=&amp;gt; Person&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&amp;#34;Person&amp;#34;&lt;/span>.constantize.class &lt;span style="font-style:italic">#=&amp;gt; Class&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&amp;#34;person&amp;#34;&lt;/span>.constantize &lt;span style="font-style:italic">#=&amp;gt; NameError: wrong constant name person&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ä½ æƒ³è¦åŠ¨æ€åœ°å¼•ç”¨ä¸€ä¸ªç±»æ—¶ï¼Œè¿™ä¸ªæŠ€å·§éå¸¸æœ‰æ•ˆã€‚&lt;/p>
&lt;p>é€šè¿‡ &lt;code>MigrationProxy&lt;/code>ï¼ŒRails åªåŠ è½½å¹¶ä¸”å®ä¾‹åŒ–å¿…è¦çš„ migrationsï¼Œè¿™èƒ½ä¸º migration çš„å¤„ç†æé€Ÿï¼ŒåŒæ—¶èŠ‚çº¦æ›´å¤šå†…å­˜ã€‚&lt;/p>
&lt;p>çœŸæ­£çš„ &lt;code>Migration&lt;/code> ç±»åœ¨ä»£ç†å§”æ‰˜äº† &lt;code>migrate&lt;/code> æ–¹æ³•çš„æ—¶å€™æ‰è¢« &lt;code>Migrator&lt;/code> è°ƒç”¨ã€‚è¿™ä¸ªæŒ‰åºè°ƒç”¨ &lt;code>Migration#up&lt;/code> æˆ–è€… &lt;code>Migration#down&lt;/code> å–å†³äº migration æ˜¯åœ¨å…ˆå‰æ‰§è¡Œï¼Œè¿˜æ˜¯åœ¨æ‰§è¡Œå›æ»šã€‚&lt;/p>
&lt;h3 id="æ€»ç»“recap">æ€»ç»“ï¼ˆRecapï¼‰&lt;/h3>
&lt;p>æˆ‘ä»¬ä»…ä»…åªæ˜¯ä¸€ç¥äº† Rails çš„ migration æœºåˆ¶çš„æºç çš„è¡¨é¢ï¼Œä½†æ˜¯æˆ‘ä»¬å´å·²ç»å­¦åˆ°äº†ä¸€äº›æœ‰è¶£çš„çŸ¥è¯†ã€‚Migrations ç”±ä¸€ä¸ªè°ƒç”¨äº† &lt;code>Migrator&lt;/code> çš„ Rake ä»»åŠ¡å¯åŠ¨ï¼Œ&lt;code>Migrator&lt;/code> åˆæŒ‰åºæŸ¥æ‰¾åˆ°äº†æˆ‘ä»¬çš„ migrationsï¼Œå¹¶ä¸”ä½¿ç”¨äº† &lt;code>MigrationProxy&lt;/code> å¯¹è±¡å¯¹è¿™äº› migrations è¿›è¡Œäº†åŒ…è£…ï¼Œç›´åˆ°çœŸæ­£çš„ &lt;code>Migration&lt;/code> éœ€è¦è¢«æ‰§è¡Œçš„æ—¶å€™ã€‚&lt;/p>
&lt;p>ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†ä¸€äº›æœ‰è¶£çš„æ–¹æ³•ã€ä¹ æƒ¯ä»¥åŠæŠ€å·§ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¯å¢ƒå˜é‡å¯ä»¥é€šè¿‡ &lt;code>ENV&lt;/code> å¸¸é‡è®¿é—®ï¼›&lt;/li>
&lt;li>å®šä¹‰è‡ªå®šä¹‰çš„å¼‚å¸¸ç±»ï¼Œæ˜¯ä¸€ç§å¸¸è§çš„å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†çš„æ‰‹æ®µï¼›&lt;/li>
&lt;li>&lt;code>Array()&lt;/code> æ–¹æ³•å°†ä»»æ„å¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„ï¼›&lt;/li>
&lt;li>&lt;code>Dir[]&lt;/code> ä½¿ç”¨ &lt;code>shell glob&lt;/code> è¯­æ³•æœç´¢æ–‡ä»¶ï¼›&lt;/li>
&lt;li>&lt;code>String#scan&lt;/code> è¿”å›å­—ç¬¦ä¸²é‡Œæ‰€æœ‰åŒ¹é…çš„ç»“æœï¼Œå¹¶ä¸”æ”¯æŒåŒ¹é…åˆ†ç»„ï¼ˆcapturing groupsï¼‰ï¼›&lt;/li>
&lt;li>&lt;code>String#camelize&lt;/code> å°†ä¸‹åˆ’çº¿å½¢å¼ï¼ˆsnake_caseï¼‰å­—ç¬¦ä¸²è½¬æ¢ä¸ºé©¼å³°å¼ï¼ˆCamelCaseï¼‰;&lt;/li>
&lt;li>&lt;code>&amp;amp;&lt;/code> æ“ä½œç¬¦åœ¨ç¬¦å·ç±»å‹çš„å¯¹è±¡ä¸Šè°ƒç”¨æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ª &lt;code>Proc&lt;/code> å¯¹è±¡&lt;/li>
&lt;li>&lt;code>delegate&lt;/code> å¯ä»¥ç”¨äºå®ç°ä»£ç†çš„è®¾è®¡æ¨¡å¼&lt;/li>
&lt;li>å¯ä»¥é€šè¿‡ &lt;code>String#contantize&lt;/code> æ–¹æ³•åŠ¨æ€åŠ è½½å¸¸é‡&lt;/li>
&lt;/ul>
&lt;p>ä¸‹ä¸€æ¬¡ï¼Œæˆ–è®¸æˆ‘ä»¬å°±èƒ½å¼„æ˜ç™½ &lt;code>Migrator&lt;/code> æ˜¯å¦‚ä½•ç¡®åˆ‡çŸ¥é“å“ªäº› migrations å·²ç»åœ¨ä½ çš„æ•°æ®åº“é‡Œæ‰§è¡Œè¿‡ã€‚&lt;/p>
&lt;h3 id="å–œæ¬¢è¿™ç¯‡æ–‡ç« ">å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Ÿ&lt;/h3>
&lt;p>&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/02/jie-du-rails-xi-lie-fan-yi/">é˜…è¯»æ›´å¤š&lt;/a>â€œè§£è¯»Railsâ€ä¸­çš„æ–‡ç« ã€‚â€œè§£è¯»Railsâ€ä¸­çš„æ–‡ç« ã€‚&lt;/p></description></item><item><title>åŠ¨æ€å¯†ç ç®—æ³•ä»‹ç»ä¸å®ç°</title><link>https://blog.hackerpie.com/posts/archive/dong-tai-mi-ma-suan-fa-jie-shao-yu-shi-xian/</link><pubDate>Sat, 18 Feb 2017 09:54:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/dong-tai-mi-ma-suan-fa-jie-shao-yu-shi-xian/</guid><description>&lt;p>åŠ¨æ€å¯†ç ï¼Œäº¦ç§°ä¸€æ¬¡æ€§å¯†ç ï¼ˆOne Time Password, ç®€ç§° OTPï¼‰ï¼Œæ˜¯ä¸€ç§é«˜æ•ˆç®€å•åˆæ¯”è¾ƒå®‰å…¨çš„å¯†ç ç”Ÿæˆç®—æ³•ï¼Œåœ¨æˆ‘ä»¬çš„ç”Ÿæ´»ä»¥åŠå·¥ä½œä¸­éšå¤„å¯è§ï¼Œèº«ä¸ºå¼€å‘è€…ï¼Œä¹Ÿæˆ–å¤šæˆ–å°‘åœ¨è‡ªå·±çš„ä¸šåŠ¡ç³»ç»Ÿä¸­é›†æˆäº†äºŒæ­¥éªŒè¯æœºåˆ¶ï¼Œé‚£ä¹ˆï¼ŒæŠ€æœ¯è¿ç”¨ï¼Œæ—¢è¦çŸ¥å…¶ç„¶ï¼Œæ›´è¦çŸ¥å…¶æ‰€ä»¥ç„¶ï¼ŒåŠ¨æ€å¯†ç ç®—æ³•æ˜¯æ€æ ·çš„ï¼Ÿ&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2 id="è¯»å‰æŒ‡å¼•">è¯»å‰æŒ‡å¼•&lt;/h2>
&lt;ul>
&lt;li>é€šè¿‡è¿™ç¯‡æ–‡ç« ï¼Œä½ å¯ä»¥äº†è§£ä»¥ä¸‹çŸ¥è¯†ï¼š
&lt;ul>
&lt;li>åŠ¨æ€å¯†ç çš„èƒŒæ™¯çŸ¥è¯†&lt;/li>
&lt;li>åŠ¨æ€å¯†ç çš„åˆ†ç±»&lt;/li>
&lt;li>ä¸åŒåŠ¨æ€å¯†ç çš„ç”Ÿæˆç®—æ³•ï¼ŒHOTP ä»¥åŠ TOTP&lt;/li>
&lt;li>HOTP ä»¥åŠ TOTP çš„ç®€å•çš„ Ruby ç¼–ç¨‹è¯­è¨€çš„å®ç°&lt;/li>
&lt;li>ä¸¤ç±»ç®—æ³•å„è‡ªæ³¨æ„äº‹é¡¹&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>é™äºç¯‡å¹…ï¼Œæˆ‘ä¸ä¼šè®¨è®ºä»¥ä¸‹å‡ ç‚¹ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒæˆ‘æ–‡ç« æœ«å°¾ç»™å‡ºçš„å‚è€ƒèµ„æ–™äº†è§£ï¼š
&lt;ul>
&lt;li>ä¸åŒåŠ¨æ€å¯†ç çš„å®‰å…¨æ€§åˆ†æ&lt;/li>
&lt;li>è®¡æ—¶åŠ¨æ€å¯†ç å¦‚ä½•ç¡®ä¿æœ‰æ•ˆæœŸé—´å†…ï¼Œå¯†ç ä¸è¢«äºŒæ¬¡ä½¿ç”¨&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="åŠ¨æ€å¯†ç èƒŒæ™¯ä»‹ç»">åŠ¨æ€å¯†ç èƒŒæ™¯ä»‹ç»&lt;/h2>
&lt;p>ä»æˆ‘çš„è§’åº¦ç†è§£ï¼ŒåŠ¨æ€å¯†ç æ˜¯æŒ‡éšç€æŸä¸€äº‹ä»¶ï¼ˆå¯†ç è¢«ä½¿ç”¨ã€ä¸€å®šçš„æ—¶é—´æµé€ç­‰ï¼‰çš„å‘ç”Ÿè€Œé‡æ–°ç”Ÿæˆçš„å¯†ç ï¼Œå› ä¸ºåŠ¨æ€å¯†ç æœ¬èº«æœ€å¤§ä¼˜ç‚¹æ˜¯é˜²é‡å¤æ‰§è¡Œæ”»å‡»(replay attack)ï¼Œå®ƒèƒ½å¾ˆå¥½åœ°é¿å…ç±»ä¼¼é™æ€å¯†ç å¯èƒ½è¢«æš´åŠ›ç ´è§£ç­‰çš„ç¼ºé™·ï¼Œç°å®è¿ç”¨ä¸­ï¼Œä¸€èˆ¬é‡‡ç”¨â€œé™æ€å¯†ç +åŠ¨æ€å¯†ç â€ç›¸ç»“åˆçš„åŒå› ç´ è®¤è¯ï¼Œæˆ‘ä»¬ä¹Ÿç§°äºŒæ­¥éªŒè¯ã€‚&lt;/p>
&lt;p>è€ŒåŠ¨æ€å¯†ç å…¶å®å¾ˆæ—©å°±å‡ºç°åœ¨æˆ‘ä»¬çš„ç”Ÿæ´»é‡Œäº†ï¼Œåœ¨ç§»åŠ¨æ”¯ä»˜å‘å±•èµ·æ¥ä¹‹å‰ï¼Œç½‘é“¶æ˜¯å½“æ—¶æœ€ä¸ºæµè¡Œçš„åœ¨çº¿æ”¯ä»˜æ¸ é“ï¼Œå½“æ—¶é“¶è¡Œä¸ºäº†ç¡®ä¿å¤§å®¶çš„ç½‘é“¶è´¦å·æ”¯ä»˜å®‰å…¨ï¼Œéƒ½ä¼šç»™ç½‘é“¶å®¢æˆ·é…å‘åŠ¨æ€å¯†ç å¡ï¼Œæ¯”å¦‚ä¸­å›½é“¶è¡Œç”µå­å£ä»¤å¡ï¼ˆæŒ‰æ—¶é—´å·®å®šæ—¶ç”Ÿæˆæ–°å¯†ç ï¼Œå£ä»¤å¡è‡ªå¸¦ç”µæ± ï¼Œå¯ä¿è¯è¿ç»­ä½¿ç”¨å‡ å¹´ï¼‰ï¼Œæˆ–è€…å·¥å•†é“¶è¡Œçš„ç”µå­é“¶è¡Œå£ä»¤å¡ï¼ˆç½‘é“¶æ”¯ä»˜ç½‘é¡µæ¯æ¬¡ç”Ÿæˆä¸åŒçš„è¡Œåˆ—åºå·ï¼Œç”¨æˆ·æ ¹æ®æŒ‡å®šè¡Œåˆ—ç»„åˆåˆ®å¼€å¯†ç å¡ä¸Šçš„æ¶‚å±‚è·å–å¯†ç ï¼Œå¯†ç ä½¿ç”¨åå¤±æ•ˆï¼‰ï¼Œåˆæˆ–è€…é“¶è¡Œå¼ºåˆ¶è¦æ±‚çš„çŸ­ä¿¡éªŒè¯ç ï¼Œè¿™äº›éƒ½å¯ä»¥çº³å…¥åŠ¨æ€å¯†ç çš„èŒƒç•´ã€‚&lt;br>
&lt;img src="https://blog.hackerpie.com/images/secureRSA.jpeg" alt="ä¸­è¡Œç”µå­å£ä»¤å¡">
&lt;img src="https://blog.hackerpie.com/images/password_card.jpg" alt="å·¥è¡Œç”µå­é“¶è¡Œå£ä»¤å¡">
&lt;/p>
&lt;p>è€Œéšç€ç§»åŠ¨äº’è”ç½‘çš„å‘å±•ä»¥åŠç§»åŠ¨è®¾å¤‡çš„æ™ºèƒ½åŒ–çš„ä¸æ–­æé«˜ï¼Œè®¾å¤‡é—´çš„åŒæ­¥èƒ½åŠ›å¤§å¹…æå‡ï¼Œä»¥å‰ä¾èµ–ç‹¬ç«‹è®¾å¤‡çš„åŠ¨æ€å¯†ç ç”ŸæˆæŠ€æœ¯å¾ˆå¿«æ¼”å˜æˆäº†æ‰‹æœºä¸Šçš„åŠ¨æ€å¯†ç ç”Ÿæˆè½¯ä»¶ï¼Œä»¥æ‰‹æœºè½¯ä»¶çš„å½¢å¼ç”ŸæˆåŠ¨æ€å¯†ç çš„æ–¹å¼æå¤§æé«˜äº†åŠ¨æ€å¯†ç çš„ä¾¿æºæ€§ï¼Œä¸€ä¸ªç”¨æˆ·ä¸€ä¸ªæ‰‹æœºå°±å¯ä»¥ç®¡ç†ä»»æ„å¤šä¸ªåŠ¨æ€å¯†ç çš„ç”Ÿæˆï¼Œè¿™ä¹Ÿä½¿å¾—åœ¨ç½‘ç«™ä¸Šæ¨åŠ¨äºŒæ­¥éªŒè¯å‡å°‘äº†å¾ˆå¤šé˜»åŠ›ï¼Œå› ä¸ºä»¥å¾€å®¢æˆ·å¯èƒ½å› ä¸ºä½¿ç”¨å£ä»¤å¡å¤ªéº»çƒ¦ï¼Œè€Œæ‹’ç»æ‰“å¼€äºŒæ­¥éªŒè¯æœºåˆ¶ï¼Œä»è€Œè®©è‡ªå·±çš„è´¦å·æš´éœ²åœ¨é£é™©ä¹‹ä¸‹ã€‚æœ€ä¸ºçŸ¥åçš„åŠ¨æ€å¯†ç ç”Ÿæˆè½¯ä»¶ï¼Œå½“å± Google çš„ Authenticator APPã€‚&lt;br>
&lt;img src="https://blog.hackerpie.com/images/google-auth.jpeg" alt="Google Authenticator">
&lt;/p>
&lt;h2 id="åŠ¨æ€å¯†ç ç®—æ³•æ¢ç´¢ä¹‹æ—…">åŠ¨æ€å¯†ç ç®—æ³•æ¢ç´¢ä¹‹æ—…&lt;/h2>
&lt;h3 id="åŠ¨æ€å¯†ç çš„åˆ†ç±»">åŠ¨æ€å¯†ç çš„åˆ†ç±»&lt;/h3>
&lt;p>ä¸€èˆ¬æ¥è¯´ï¼Œå¸¸è§çš„åŠ¨æ€å¯†ç æœ‰ä¸¤ç±»ï¼š&lt;/p>
&lt;ul>
&lt;li>**è®¡æ¬¡ä½¿ç”¨ï¼š**è®¡æ¬¡ä½¿ç”¨çš„OTPäº§å‡ºåï¼Œå¯åœ¨ä¸é™æ—¶é—´å†…ä½¿ç”¨ï¼ŒçŸ¥é“ä¸‹æ¬¡æˆåŠŸä½¿ç”¨åï¼Œè®¡æ•°å™¨åŠ  1ï¼Œç”Ÿæˆæ–°çš„å¯†ç ã€‚ç”¨äºå®ç°è®¡æ¬¡ä½¿ç”¨åŠ¨æ€å¯†ç çš„ç®—æ³•å« HOTPï¼Œæ¥ä¸‹æ¥ä¼šå¯¹è¿™ä¸ªç®—æ³•å±•å¼€ä»‹ç»ï¼›&lt;/li>
&lt;li>**è®¡æ—¶ä½¿ç”¨ï¼š**è®¡æ—¶ä½¿ç”¨çš„OTPåˆ™å¯è®¾å®šå¯†ç æœ‰æ•ˆæ—¶é—´ï¼Œä»30ç§’åˆ°ä¸¤åˆ†é’Ÿä¸ç­‰ï¼Œè€ŒOTPåœ¨è¿›è¡Œè®¤è¯ä¹‹åå³åºŸå¼ƒä¸ç”¨ï¼Œä¸‹æ¬¡è®¤è¯å¿…é¡»ä½¿ç”¨æ–°çš„å¯†ç ã€‚ç”¨äºå®ç°è®¡æ—¶ä½¿ç”¨åŠ¨æ€å¯†ç çš„ç®—æ³•å« TOTPï¼Œæ¥ä¸‹æ¥ä¼šå¯¹è¿™ä¸ªç®—æ³•å±•å¼€ä»‹ç»ã€‚&lt;/li>
&lt;/ul>
&lt;p>åœ¨çœŸæ­£å¼€å±•ç®—æ³•ä»‹ç»ä¹‹å‰ï¼Œéœ€è¦è¡¥å……ä»‹ç»çš„æ˜¯ï¼šåŠ¨æ€å¯†ç çš„åŸºæœ¬è®¤è¯åŸç†æ˜¯åœ¨è®¤è¯åŒæ–¹å…±äº«å¯†é’¥ï¼Œä¹Ÿç§°ç§å­å¯†é’¥ï¼Œå¹¶ä½¿ç”¨çš„åŒä¸€ä¸ªç§å­å¯†é’¥å¯¹æŸä¸€ä¸ªäº‹ä»¶è®¡æ•°ã€æˆ–æ—¶é—´å€¼è¿›è¡Œå¯†ç ç®—æ³•è®¡ç®—ï¼Œä½¿ç”¨çš„ç®—æ³•æœ‰å¯¹ç§°ç®—æ³•ã€HASHã€HMACç­‰ã€‚è®°ä½è¿™ä¸€ç‚¹ï¼Œè¿™ä¸ªæ˜¯æ‰€æœ‰åŠ¨æ€å¯†ç ç®—æ³•å®ç°çš„åŸºç¡€ã€‚&lt;/p>
&lt;h3 id="hotp">HOTP&lt;/h3>
&lt;p>HOTP ç®—æ³•ï¼Œå…¨ç§°æ˜¯â€œAn HMAC-Based One-Time Password Algorithmâ€ï¼Œæ˜¯ä¸€ç§åŸºäºäº‹ä»¶è®¡æ•°çš„ä¸€æ¬¡æ€§å¯†ç ç”Ÿæˆç®—æ³•ï¼Œè¯¦ç»†çš„ç®—æ³•ä»‹ç»å¯ä»¥æŸ¥çœ‹ &lt;a href="https://tools.ietf.org/html/rfc4226">RFC 4226&lt;/a>ã€‚å…¶å®ç®—æ³•æœ¬èº«éå¸¸ç®€å•ï¼Œç®—æ³•æœ¬èº«å¯ä»¥ç”¨ä¸¤æ¡ç®€çŸ­çš„è¡¨è¾¾å¼æè¿°ï¼š&lt;/p>
&lt;blockquote>
&lt;p>HOTP(K,C) = Truncate(HMAC-SHA-1(K,C))
PWD(K,C,digit) = HOTP(K,C) mod 10^Digit&lt;/p>
&lt;/blockquote>
&lt;p>ä¸Šå¼ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>K ä»£è¡¨æˆ‘ä»¬åœ¨è®¤è¯æœåŠ¡å™¨ç«¯ä»¥åŠå¯†ç ç”Ÿæˆç«¯ï¼ˆå®¢æˆ·è®¾å¤‡ï¼‰ä¹‹é—´å…±äº«çš„å¯†é’¥ï¼Œåœ¨ RFC 4226 ä¸­ï¼Œä½œè€…è¦æ±‚å…±äº«å¯†é’¥æœ€å°é•¿åº¦æ˜¯ 128 ä½ï¼Œè€Œä½œè€…æœ¬èº«æ¨èä½¿ç”¨ 160 ä½é•¿åº¦çš„å¯†é’¥&lt;/li>
&lt;li>C è¡¨ç¤ºäº‹ä»¶è®¡æ•°çš„å€¼ï¼Œ8 å­—èŠ‚çš„æ•´æ•°ï¼Œç§°ä¸ºç§»åŠ¨å› å­ï¼ˆmoving factorï¼‰ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ C çš„æ•´æ•°å€¼éœ€è¦ç”¨äºŒè¿›åˆ¶çš„å­—ç¬¦ä¸²è¡¨è¾¾ï¼Œæ¯”å¦‚æŸä¸ªäº‹ä»¶è®¡æ•°ä¸º 3ï¼Œåˆ™Cæ˜¯ &lt;code>&amp;quot;11&amp;quot;&lt;/code>ï¼ˆæ­¤å¤„çœç•¥äº†å‰é¢çš„äºŒè¿›åˆ¶çš„æ•°å­—0ï¼‰&lt;/li>
&lt;li>HMAC-SHA-1 è¡¨ç¤ºå¯¹å…±äº«å¯†é’¥ä»¥åŠç§»åŠ¨å› å­è¿›è¡Œ HMAC çš„ SHA1 ç®—æ³•åŠ å¯†ï¼Œå¾—åˆ° 160 ä½é•¿åº¦ï¼ˆ20å­—èŠ‚ï¼‰çš„åŠ å¯†ç»“æœ&lt;/li>
&lt;li>Truncate å³æˆªæ–­å‡½æ•°ï¼Œåé¢ä¼šè¯¦è¿°&lt;/li>
&lt;li>digit æŒ‡å®šåŠ¨æ€å¯†ç é•¿åº¦ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸è§çš„éƒ½æ˜¯ 6 ä½é•¿åº¦çš„åŠ¨æ€å¯†ç &lt;/li>
&lt;/ul>
&lt;h4 id="truncate-æˆªæ–­å‡½æ•°">Truncate æˆªæ–­å‡½æ•°&lt;/h4>
&lt;p>ç”±äº SHA-1 ç®—æ³•æ˜¯æ—¢æœ‰ç®—æ³•ï¼Œä¸æ˜¯æˆ‘ä»¬è®¨è®ºé‡ç‚¹ï¼Œæ•…è€Œ Truncate å‡½æ•°å°±æ˜¯æ•´ä¸ªç®—æ³•ä¸­æœ€ä¸ºå…³é”®çš„éƒ¨åˆ†äº†ã€‚ä»¥ä¸‹å¼•ç”¨ Truncate å‡½æ•°çš„æ­¥éª¤è¯´æ˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>DT(String) // String = String[0]&amp;hellip;String[19]
Let OffsetBits be the low-order 4 bits of String[19]
Offset = StToNum(OffsetBits) // 0 &amp;lt;= OffSet &amp;lt;= 15
Let P = String[OffSet]&amp;hellip;String[OffSet+3]
Return the Last 31 bits of P&lt;/p>
&lt;/blockquote>
&lt;p>ç»“åˆä¸Šé¢çš„å…¬å¼ç†è§£ï¼Œå¤§æ¦‚çš„æè¿°å°±æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>å…ˆä»ç¬¬ä¸€æ­¥é€šè¿‡ SHA-1 ç®—æ³•åŠ å¯†å¾—åˆ°çš„ 20 å­—èŠ‚é•¿åº¦çš„ç»“æœä¸­é€‰å–æœ€åä¸€ä¸ªå­—èŠ‚çš„ä½å­—èŠ‚ä½çš„ 4 ä½ï¼ˆæ³¨æ„ï¼šåŠ¨æ€å¯†ç ç®—æ³•ä¸­é‡‡ç”¨çš„å¤§ç«¯(big-endian)å­˜å‚¨ï¼‰ï¼›&lt;/li>
&lt;li>å°†è¿™ 4 ä½çš„äºŒè¿›åˆ¶å€¼è½¬æ¢ä¸ºæ— æ ‡ç‚¹æ•°çš„æ•´æ•°å€¼ï¼Œå¾—åˆ° 0 åˆ° 15ï¼ˆåŒ…å« 0 å’Œ 15ï¼‰ä¹‹é—´çš„ä¸€ä¸ªæ•°ï¼Œè¿™ä¸ªæ•°å­—ä½œä¸º 20 ä¸ªå­—èŠ‚ä¸­ä» 0 å¼€å§‹çš„åç§»é‡ï¼›&lt;/li>
&lt;li>æ¥ç€ä»æŒ‡å®šåç§»ä½å¼€å§‹ï¼Œè¿ç»­æˆªå– 4 ä¸ªå­—èŠ‚ï¼ˆ32 ä½ï¼‰ï¼Œæœ€åè¿”å› 32 ä½ä¸­çš„åé¢ 31 ä½ã€‚&lt;/li>
&lt;/ol>
&lt;p>å›åˆ°ç®—æ³•æœ¬èº«ï¼Œåœ¨è·å¾— 31 ä½çš„æˆªæ–­ç»“æœä¹‹åï¼Œæˆ‘ä»¬å°†å…¶åˆè½¬æ¢ä¸ºæ— æ ‡ç‚¹çš„å¤§ç«¯è¡¨ç¤ºçš„æ•´æ•°å€¼ï¼Œè¿™ä¸ªå€¼çš„å–å€¼èŒƒå›´æ˜¯ 0 ~ 2^31ï¼Œä¹Ÿå³ 0 ~ 2.147483648E9ï¼Œæœ€åæˆ‘ä»¬å°†è¿™ä¸ªæ•°å¯¹10çš„ä¹˜æ–¹ï¼ˆdigit æŒ‡æ•°èŒƒå›´ 1-10ï¼‰å–æ¨¡ï¼Œå¾—åˆ°ä¸€ä¸ªä½™å€¼ï¼Œå¯¹å…¶å‰é¢è¡¥0å¾—åˆ°æŒ‡å®šä½æ•°çš„å­—ç¬¦ä¸²ã€‚&lt;/p>
&lt;h4 id="ä»£ç ç¤ºä¾‹">ä»£ç ç¤ºä¾‹&lt;/h4>
&lt;p>ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä¹Ÿå¯è®¿é—® &lt;a href="https://gist.github.com/Martin91/15a3a29acd9d138b0d6e125d8fbd5ab0">Gist&lt;/a> è·å–ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>require &lt;span style="font-style:italic">&amp;#39;openssl&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> hotp(secret, counter, digits = 6)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hash = OpenSSL::HMAC.digest(OpenSSL::Digest.new(&lt;span style="font-style:italic">&amp;#39;sha1&amp;#39;&lt;/span>), secret, int_to_bytestring(counter)) &lt;span style="font-style:italic"># SHA-1 ç®—æ³•åŠ å¯†&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;%0&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>digits&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">i&amp;#34;&lt;/span> % (truncate(hash) % 10**digits) &lt;span style="font-style:italic"># å–æ¨¡è·å–æŒ‡å®šé•¿åº¦æ•°å­—å¯†ç &lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> truncate(string)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> offset = string.bytes.last &amp;amp; 0xf &lt;span style="font-style:italic"># å–æœ€åä¸€ä¸ªå­—èŠ‚&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> partial = string.bytes[offset..offset+3] &lt;span style="font-style:italic"># ä»åç§»é‡å¼€å§‹ï¼Œè¿ç»­å– 4 ä¸ªå­—èŠ‚&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> partial.pack(&lt;span style="font-style:italic">&amp;#34;C*&amp;#34;&lt;/span>).unpack(&lt;span style="font-style:italic">&amp;#34;N&amp;#34;&lt;/span>).first &amp;amp; 0x7fffffff &lt;span style="font-style:italic"># å–åé¢ 31 ä½ç»“æœåå¾—åˆ°æ•´æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> int_to_bytestring(int, padding = 8)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = []
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">until&lt;/span> int == 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result &amp;lt;&amp;lt; (int &amp;amp; 0xFF).chr
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> int &amp;gt;&amp;gt;= 8
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result.reverse.join.rjust(padding, 0.chr)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ç®—æ³•å®ç°ä»£ç é‡å¾ˆå°‘ï¼Œæ ¸å¿ƒéƒ½æ˜¯æŒ‰ç…§ç®—æ³•æè¿°è¿›è¡Œå¤šä¸ªæ©ç è¿ç®—è·Ÿä½æ“ä½œè€Œå·²ã€‚&lt;/p>
&lt;h4 id="å¯†ç å¤±æ•ˆæœºåˆ¶">å¯†ç å¤±æ•ˆæœºåˆ¶&lt;/h4>
&lt;p>ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹åˆ°ï¼Œä¸€ä¸ªåŠ¨æ€å¯†ç çš„ç”Ÿæˆï¼Œå–å†³äºå…±äº«å¯†é’¥ä»¥åŠç§»åŠ¨å› å­çš„å€¼ï¼Œè€Œå…±äº«å¯†é’¥æ˜¯ä¿æŒä¸å˜çš„ï¼Œæœ€ç»ˆå°±åªæœ‰ç§»åŠ¨å› å­å†³å®šäº†å¯†ç çš„ç”Ÿæˆç»“æœã€‚æ‰€ä»¥åœ¨ HOTP ç®—æ³•ä¸­ï¼Œè¦æ±‚æ¯æ¬¡å¯†ç éªŒè¯æˆåŠŸåï¼Œè®¤è¯æœåŠ¡å™¨ç«¯ä»¥åŠå¯†ç ç”Ÿæˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰éƒ½è¦å°†è®¡æ•°å™¨çš„å€¼åŠ 1ï¼Œå·²ç¡®ä¿å¾—åˆ°æ–°çš„å¯†ç ã€‚&lt;/p>
&lt;p>ä½†æ˜¯åœ¨è¿™é‡Œå°±ä¼šå¼•å…¥ä¸€ä¸ªé—®é¢˜ï¼Œå‡å¦‚è®¤è¯æœåŠ¡å™¨ç«¯ä¸å¯†ç ç”Ÿæˆå™¨ä¹‹é—´ç”±äºé€šä¿¡æ•…éšœæˆ–è€…å…¶ä»–æ„å¤–æƒ…å†µï¼Œå¯¼è‡´ä¸¤è¾¹è®¡æ•°å™¨çš„å€¼ä¸åŒæ­¥äº†ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´ä¸¤è¾¹ç”Ÿæˆçš„å¯†ç æ— æ³•æ­£ç¡®åŒ¹é…ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç®—æ³•åœ¨åˆ†æä¸­å»ºè®®è®¤è¯æœåŠ¡å™¨ç«¯åœ¨éªŒè¯å¯†ç å¤±è´¥åï¼Œå¯ä»¥ä¸»åŠ¨å°è¯•è®¡æ•°å™¨å‡1ä¹‹åé‡æ–°ç”Ÿæˆçš„æ–°å¯†ç æ˜¯å¦ä¸å®¢æˆ·ç«¯æäº¤å¯†ç ä¸€è‡´ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¯ä»¥è®¤å®šæ˜¯å®¢æˆ·ç«¯è®¡æ•°å™¨æœªåŒæ­¥å¯¼è‡´ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥é€šè¿‡éªŒè¯ï¼Œå¹¶ä¸”è¦æ±‚å®¢æˆ·ç«¯é‡æ–°åŒæ­¥è®¡æ•°å™¨çš„å€¼ã€‚&lt;/p>
&lt;p>å‡ºäº†ä¸Šé¢æåˆ°çš„è®¡æ•°å™¨ä¸åŒæ­¥çš„é—®é¢˜ï¼Œæˆ‘å¦å¤–æƒ³çš„æ˜¯ï¼Œå¦‚æœå®¢æˆ·æœ‰å¤šä¸ªå¯†ç ç”Ÿæˆå™¨ï¼ˆå‡è®¾ iPad å’Œ iPhoneï¼‰ä¸ºåŒä¸ªè´¦å·ç”Ÿæˆå¯†ç ï¼Œé‚£ä¹ˆè®¡æ•°å™¨åœ¨å¤šä¸ªè®¾å¤‡é—´çš„åŒæ­¥å¯èƒ½å°±éœ€è¦å¦å¤–è€ƒè™‘çš„æ–¹æ¡ˆäº†ã€‚&lt;/p>
&lt;h4 id="å°ç»“">å°ç»“&lt;/h4>
&lt;p>å…¶å® HOTP çš„ç®—æ³•æ¯”æˆ‘åœ¨é˜…è¯»ç®—æ³•å‰æ‰€æƒ³è±¡çš„è¦ç®€æ´å¾—å¤šï¼Œè€Œä¸”ä»ç„¶è¶³å¤Ÿå¼ºå¥ã€‚ç®—æ³•æœ¬èº«å·§å¦™åˆ©ç”¨äº†åŠ å¯†ç®—æ³•å¯¹å…±äº«å¯†é’¥å’Œè®¡æ•°å™¨è¿›è¡ŒåŠ å¯†ï¼Œç¡®ä¿è¿™ä¸¤ä¸ªåŠ¨æ€å¯†ç ç”Ÿæˆå› å­ä¸è¢«ç¯¡æ”¹ï¼Œæ¥ç€é€šè¿‡ä¸€ä¸ª truncate å‡½æ•°éšæœºå¾—åˆ°ä¸€ä¸ªæœ€é•¿ 10 ä½çš„ 10 è¿›åˆ¶æ•´æ•°ï¼Œæœ€ç»ˆå®ç°å¯¹ 1 - 10 ä½é•¿åº¦åŠ¨æ€å¯†ç çš„æ”¯æŒã€‚ç®—æ³•æœ¬èº«çš„ç®€æ´ä¹Ÿç¡®ä¿äº†ç®—æ³•æœ¬èº«å¯ä»¥åœ¨å„ç§è®¾å¤‡ä¸Šå®ç°ã€‚&lt;/p>
&lt;h3 id="totp">TOTP&lt;/h3>
&lt;p>TOTP ç®—æ³•ï¼Œå…¨ç§°æ˜¯ TOTP: Time-Based One-Time Password Algorithmï¼Œå…¶åŸºäº HOTP ç®—æ³•å®ç°ï¼Œæ ¸å¿ƒæ˜¯å°†ç§»åŠ¨å› å­ä» HOTP ä¸­çš„äº‹ä»¶è®¡æ•°æ”¹ä¸ºæ—¶é—´å·®ã€‚å®Œæ•´çš„ TOTP ç®—æ³•çš„è¯´æ˜å¯ä»¥æŸ¥çœ‹ &lt;a href="https://tools.ietf.org/html/rfc6238">RFC 6238&lt;/a>ï¼Œå…¶å…¬å¼æè¿°ä¹Ÿéå¸¸ç®€å•ï¼š&lt;/p>
&lt;blockquote>
&lt;p>TOTP = HOTP(K, T) // T is an integer
and represents the number of time steps between the initial counter
time T0 and the current Unix time
More specifically, T = (Current Unix time - T0) / X, where the
default floor function is used in the computation.&lt;/p>
&lt;/blockquote>
&lt;p>é€šå¸¸æ¥è¯´ï¼ŒTOTP ä¸­æ‰€ä½¿ç”¨çš„æ—¶é—´å·®éƒ½æ˜¯å½“å‰æ—¶é—´æˆ³ï¼ŒTOTP å°†æ—¶é—´å·®é™¤ä»¥æ—¶é—´çª—å£ï¼ˆå¯†ç æœ‰æ•ˆæœŸï¼Œé»˜è®¤ 30 ç§’ï¼‰å¾—åˆ°æ—¶é—´çª—å£è®¡æ•°ï¼Œä»¥æ­¤ä½œä¸ºåŠ¨æ€å¯†ç ç®—æ³•çš„ç§»åŠ¨å› å­ï¼Œè¿™æ ·åŸºäº HOTP ç®—æ³•å°±èƒ½æ–¹ä¾¿å¾—åˆ°åŸºäºæ—¶é—´çš„åŠ¨æ€å¯†ç äº†ã€‚&lt;br>
&lt;strong>æ³¨æ„:&lt;/strong> RFC 6238 æåˆ°ï¼Œåœ¨ TOTP ç®—æ³•ä¸­ï¼Œå¯ä»¥æŒ‡å®šä¸åŒçš„é”®æ§å“ˆå¸Œç®—æ³•ï¼Œæ¯”å¦‚åœ¨ HOTP ä¸­ä½¿ç”¨çš„æ˜¯ HMAC-SHA1 ç®—æ³•ï¼Œè€Œåœ¨ TOTPï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ HMAC-SHA256 æˆ–è€… HMAC-SHA512ã€‚&lt;/p>
&lt;blockquote>
&lt;p>TOTP implementations MAY use HMAC-SHA-256 or HMAC-SHA-512 functions,
based on SHA-256 or SHA-512 [SHA2] hash functions, instead of the
HMAC-SHA-1 function that has been specified for the HOTP computation
in [RFC4226].&lt;/p>
&lt;/blockquote>
&lt;h4 id="ä»£ç ç¤ºä¾‹-1">ä»£ç ç¤ºä¾‹&lt;/h4>
&lt;p>ä»¥ä¸‹ä»£ç ç¤ºä¾‹ä¹Ÿå¯è®¿é—® &lt;a href="https://gist.github.com/Martin91/15a3a29acd9d138b0d6e125d8fbd5ab0">Gist&lt;/a> è·å–ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>require &lt;span style="font-style:italic">&amp;#39;hotp&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> totp(secret, digits = 6, step = 30, initial_time = 0)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> steps = (Time.now.to_i - initial_time) / step
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hotp(secret, steps, digits)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹åˆ°äº†å§ï¼Œæå…¶ç®€çŸ­çš„å®ç°ä»£ç ï¼ä¸€ä¸ªæ—¶é—´è®¡æ•°çš„åŠ¨æ€å¯†ç ç®—æ³•å°±æ­¤è¯ç”Ÿï¼Œå¦‚æ­¤ç®€å•çš„ç®—æ³•ï¼Œå´æ˜¯æ”¯æ’‘å¤šå°‘ä¸šåŠ¡ç³»ç»Ÿå®‰å…¨è¿ä½œçš„åŸºçŸ³ï¼Œé¢‡æœ‰å››ä¸¤æ‹¨åƒæ–¤çš„å¿«æ„Ÿï¼&lt;/p>
&lt;h4 id="é—®é¢˜æ¢è®¨">é—®é¢˜æ¢è®¨&lt;/h4>
&lt;ol>
&lt;li>ROTP ç®—æ³•ä¸­çš„ä¸»è¦é—®é¢˜æ˜¯è®¡æ•°å™¨çš„åŒæ­¥ï¼Œè€Œ TOTP ä¹Ÿä¸ä¾‹å¤–ï¼Œåªæ˜¯é—®é¢˜åœ¨äºæœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯ä¹‹é—´æ—¶é—´çš„åŒæ­¥ï¼Œç”±äºç°åœ¨äº’è”ç½‘çš„å‘è¾¾ï¼ŒåŠ ä¸Šç§»åŠ¨è®¾å¤‡ä¸€èˆ¬éƒ½ä¼šæŒ‰ç…§ç½‘ç»œæ—¶é—´è®¾ç½®è®¾å¤‡æ—¶é—´ï¼ŒåŸºæœ¬ä¸Šæ—¶é—´çš„ç›¸å¯¹åŒæ­¥éƒ½ä¸æ˜¯é—®é¢˜ï¼›&lt;/li>
&lt;li>æ—¶é—´åŒæ­¥çš„å¦ä¸€ä¸ªé—®é¢˜å…¶å®æ˜¯è¾¹ç•Œé—®é¢˜ï¼Œå‡å¦‚å®¢æˆ·ç«¯ç”Ÿæˆå¯†ç çš„æ—¶é—´åˆšå¥½æ˜¯ç¬¬ 29 ç§’ï¼Œè€Œç”±äºç½‘ç»œå»¶è¿Ÿç­‰åŸå› ï¼ŒæœåŠ¡å™¨å—ç†éªŒè¯æ—¶åˆšå¥½æ˜¯ä¸‹ä¸€ä¸ªæ—¶é—´çª—å£çš„ç¬¬ 1 ç§’ï¼Œè¿™ä¸ªæ—¶å€™ä¼šå¯¼è‡´å¯†ç éªŒè¯å¤±æ•ˆã€‚äºæ˜¯ï¼ŒTOTP ç®—æ³•åœ¨å…¶ç®—æ³•è®¨è®ºä¸­ï¼Œä¹Ÿå»ºè®®æœåŠ¡å™¨åœ¨éªŒè¯å¯†ç å¤±è´¥ä¹‹åï¼Œå¯ä»¥å°è¯•å°†è‡ªèº«çš„æ—¶é—´çª—å£å€¼å‡ 1 ä¹‹åé‡æ–°ç”Ÿæˆå¯†ç æ¯”å¯¹ï¼Œå¦‚æœéªŒè¯é€šè¿‡ï¼Œè¯´æ˜éªŒè¯ä¸é€šè¿‡æ˜¯æ—¶é—´çª—å£çš„è¾¹ç•Œé—®é¢˜å¯¼è‡´ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è®¤ä¸ºå¯†ç éªŒè¯é€šè¿‡ã€‚&lt;/li>
&lt;li>åŸºäºæ—¶é—´çš„åŠ¨æ€å¯†ç çš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯é¿å…äº†åŸºäºè®¡æ•°å™¨çš„å¤šè®¾å¤‡é—´çš„è®¡æ•°å™¨åŒæ­¥é—®é¢˜ï¼Œå› ä¸ºæ¯å°è®¾å¤‡ä»¥åŠæœåŠ¡ç«¯éƒ½å¯ä»¥è‡ªè¡Œä¸ç½‘ç»œæ—¶é—´ï¼ˆå…±åŒæ—¶é—´æ ‡å‡†ï¼‰æ ¡å‡†ï¼Œè€Œæ— éœ€ä¾èµ–æœåŠ¡ç«¯çš„æ—¶é—´ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="google-authenticator">Google Authenticator&lt;/h2>
&lt;p>åœ¨ Google Authenticator çš„&lt;a href="https://github.com/google/google-authenticator">å¼€æºé¡¹ç›®&lt;/a>çš„ README é‡Œæœ‰æ˜ç¡®æåˆ°ï¼š&lt;/p>
&lt;blockquote>
&lt;p>These implementations support the HMAC-Based One-time Password (HOTP) algorithm specified in RFC 4226 and the Time-based One-time Password (TOTP) algorithm specified in RFC 6238.&lt;/p>
&lt;/blockquote>
&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè‡³æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿæ˜ç™½äº†ï¼Œå…¶å® Google Authenticator ç®—æ³•æ ¸å¿ƒä¹Ÿæ˜¯ HOTP ä»¥åŠ TOTP ï¼Œåœ¨æ˜ç™½äº†æ•´ä¸ªåŠ¨æ€å¯†ç ç®—æ³•çš„æ ¸å¿ƒä¹‹åï¼Œæœ‰æ²¡æœ‰ä¸€ç§è±ç„¶å¼€æœ—çš„æ„Ÿè§‰å‘¢ï¼Ÿæ—¢çŸ¥å…¶ç„¶ï¼ŒåˆçŸ¥å…¶æ‰€ä»¥ç„¶äº†ï¼Œå¯¹å§ï¼Ÿæ¯æ¬¡çœ‹ç€åº”ç”¨å®šæ—¶ç”Ÿæˆå¯†ç ï¼Œ&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>è¿™ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†ä¸¤ç±»å¸¸è§çš„åŠ¨æ€å¯†ç çš„ç”Ÿæˆç®—æ³•ï¼Œç®—æ³•æœ¬èº«ç®€æ´ä¸å¤æ‚ï¼Œæ•ˆç‡å¹¶ä¸”è¶³å¤Ÿå¼ºå¥ã€‚è¿™ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯æ–¹ä¾¿è·Ÿæˆ‘ä¸€æ ·å¸Œæœ›äº†è§£ç®—æ³•æ ¸å¿ƒçš„å°ä¼™ä¼´ï¼Œè€Œåœ¨ RFC æ–‡æ¡£ä¸­ï¼Œä»æœ‰å¤§é‡å…³äºç®—æ³•æœ¬èº«çš„å®‰å…¨æ€§æ–¹é¢çš„æ¢è®¨ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»çœ‹ä¸€ä¸‹ã€‚&lt;/p>
&lt;h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://zh.wikipedia.org/zh/%E4%B8%80%E6%AC%A1%E6%80%A7%E5%AF%86%E7%A2%BC">Wikipedia: ä¸€æ¬¡æ€§å¯†ç &lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/mdp/rotp">github: rotp&lt;/a>ï¼ŒHOTP ä»¥åŠ TOTP çš„ç®—æ³•å®ç°ä»¥åŠå…¶ä»–å°è£…&lt;/li>
&lt;li>&lt;a href="http://blog.csdn.net/goldboar/article/details/7065948">åŠ¨æ€å£ä»¤ï¼ˆOTPï¼‰è®¤è¯æŠ€æœ¯æ¦‚è§ˆ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tools.ietf.org/html/rfc4226">RFC 4226 - HOTP: An HMAC-Based One-Time Password Algorithm&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://tools.ietf.org/html/rfc6238">RFC 6238 - TOTP: Time-Based One-Time Password Algorithm&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.csdn.net/article/2014-09-23/2821808-Google-Authenticator">è¯¦è§£Google Authenticatorå·¥ä½œåŸç†&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2 id="ç¤ºä¾‹æºç ">ç¤ºä¾‹æºç &lt;/h2>
&lt;p>&lt;a href="https://gist.github.com/Martin91/15a3a29acd9d138b0d6e125d8fbd5ab0">Gist: OTP algorithms in Ruby&lt;/a>&lt;/p></description></item><item><title>å‘¨æœ«åˆ°äº†ï¼Œæ¥æ®µä»£ç å‹å‹æƒŠ</title><link>https://blog.hackerpie.com/posts/archive/zhou-mo-dao-le-lai-duan-dai-ma-ya-ya-jing/</link><pubDate>Sat, 26 Nov 2016 21:43:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/zhou-mo-dao-le-lai-duan-dai-ma-ya-ya-jing/</guid><description>&lt;p>æœ€è¿‘ä¸€æ®µæ—¶é—´ï¼Œå†™äº†ä¸¤ç¯‡å…³äº sidekiq çš„æºç åˆ†æï¼Œä½†æ˜¯ä¸€ç›´æƒ³è¦è¡¥å……çš„ä¸€æ®µ sidekiq é‡Œè¾¹çš„ä»£ç å…¶å®æ˜¯æŒºæœ‰è¶£ä¹ŸæŒºé€—çš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ˜ŸæœŸå°±ä¸è¦é•¿ç¯‡å¤§è®ºçš„æºç åˆ†æï¼Œæ¥ç‚¹è½»æ¾ç‚¹çš„å§ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>è¿™ä¸ªä»£ç æ˜¯è¿™æ ·çš„ o(â•¯â–¡â•°)oï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq.rb#L51-L53&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">Sidekiq&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> self.&lt;span style="">â¨â•¯Â°â–¡Â°â©â•¯ï¸µâ”»â”â”»&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> puts &lt;span style="font-style:italic">&amp;#34;Calm down, yo.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Haha, are you kidding me? è§è¿‡ç”¨ç‰¹æ®Šå­—ç¬¦æˆ–è€…ç‰¹æ®Šè¯­è¨€æ–‡å­—åšæ–¹æ³•åçš„ï¼Œä½†æ˜¯ç”¨é¢œæ–‡å­—ï¼Œæˆ‘è¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ã€‚ä½†æ˜¯åˆ«ç¬‘ï¼Œæœ¬ç€å·¥ç§‘ç”·ä¸¥è°¨ä¸æ±‚çŸ¥çš„ç²¾ç¥ï¼Œæˆ‘å…¨å±€æœç´¢äº†ä¸‹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œç»“æœæ›´æç¬‘çš„ç»“æœæ¥äº†ï¼Œè¿™ä¸ªæ–¹æ³•æ ¹æœ¬å°±æ²¡æœ‰çœŸå®è°ƒç”¨ï¼Œä½†æ˜¯ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹åŒæ ·éå¸¸é€— 2333333333ï¼ï¼ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>describe &lt;span style="font-style:italic">&amp;#34;â¨â•¯Â°â–¡Â°â©â•¯ï¸µâ”»â”â”»&amp;#34;&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> before { $stdout = StringIO.new }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> after { $stdout = STDOUT }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> it &lt;span style="font-style:italic">&amp;#34;allows angry developers to express their emotional constitution and remedies it&amp;#34;&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.&lt;span style="">â¨â•¯Â°â–¡Â°â©â•¯ï¸µâ”»â”â”»&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> assert_equal &lt;span style="font-style:italic">&amp;#34;Calm down, yo.&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\n&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>, $stdout.string
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å“ˆå“ˆï¼Œè¿™åªæ˜¯éš¾é“ä¸ºäº†æ–¹ä¾¿ç¨‹åºå‘˜æ€’ç«ä¸­çƒ§çš„æ—¶å€™è¡¨è¾¾æƒ³æ€æ¡Œçš„å†…å¿ƒå—ï¼Ÿ&lt;/p>
&lt;p>å½“ç„¶ï¼Œè¿™ä¸ªé—®é¢˜å…¶å®æ—©å°±æœ‰å¾ˆå¤šäººå‘ç°äº†ï¼ŒRuby China ä¸Šä¹Ÿæœ‰å¥½å¤šçš„è®¨è®ºäº†ã€‚ä»Šå¤©æ˜¯ä¸ªå¿«ä¹å‘¨å…­ï¼Œè®©æˆ‘å†ä»ç½‘ç»œä¸Šæœç½—å¤šä¸€äº›æç¬‘çš„ä»£ç å§ï¼Œå“ˆå“ˆ~~~&lt;/p>
&lt;h2 id="ç²¾å½©æ®µå­æ—¶é—´">ç²¾å½©æ®µå­æ—¶é—´&lt;/h2>
&lt;p>æ¯ä¸€ä¸ªåœ¨æ³¨é‡Šæˆ–è€…ä»£ç é‡Œè—æ®µå­çš„ç¨‹åºå‘˜ä¸Šè¾ˆå­éƒ½æ˜¯æŠ˜ç¿¼çš„é€—é€¼ï¼Œä¸ä¿¡ï¼Œä½ çœ‹ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>Exception up = &lt;span style="font-weight:bold">new&lt;/span> Exception(&lt;span style="font-style:italic">&amp;#34;Something is really wrong.&amp;#34;&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">throw&lt;/span> up; &lt;span style="font-style:italic">//ha ha&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªç¨‹åºçŒ¿å†™ä»£ç æ—¶åˆ°åº•ä»€ä¹ˆå¿ƒæ€å•Šï¼Œæ•…æ„æŠ›ä¸ªå¼‚å¸¸ï¼Œè¿˜åœ¨æ³¨é‡Šé‡Œå¦‚æ­¤ç‹‚å¦„ï¼Ÿå¢™å¤´è‰å¯é™¤äº†ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//When I wrote this, only God and I understood what I was doing
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//Now, God only knows
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å“ˆå“ˆï¼Œè¿™ä¸ªæ˜¯æˆ‘çœ‹çš„æ—¶å€™æ„Ÿè§‰æ¯”è¾ƒæç¬‘çš„äº†ï¼Œæœ‰ç§ä»£ç å«åšå¤©çŸ¥åœ°çŸ¥æˆ‘çŸ¥ï¼Œåæ¥å˜æˆåªæœ‰å¤©çŸ¥é“äº†ã€‚ã€‚ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// drunk, fix later
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¥½è‡ªè§‰çš„ç¨‹åºçŒ¿å•Šï¼Œé…’åä¸å®œæ”¹ä»£ç ï¼Œå¤šæå€¡ï¼Œå»ºè®®ç«‹æ³•æœºå…³è€ƒè™‘åŠ æ¡è§„å®šï¼Œå‡¡æ˜¯é…’åå†™ä»£ç çš„ï¼Œä¸€å¾‹ç«‹æ¡ˆä¾¦åŠï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="">#define TRUE FALSE
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥æƒ³è±¡å½“è¿™ä¸ª commit è¢« merge è¿›ç”Ÿäº§ç¯å¢ƒä¹‹åã€‚ã€‚ã€‚å“ˆå“ˆï¼Œæ•´ä¸ªä¸–ç•Œé»‘ç™½é¢ å€’ï¼å¯¹çš„å°±æ˜¯é”™çš„ï¼Œé”™çš„å°±æ˜¯å¯¹çš„ï¼ï¼ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">return&lt;/span> 1; &lt;span style="font-style:italic"># returns 1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ã€‚ã€‚ã€‚ä¸ã€‚ã€‚ã€‚æ˜¯ã€‚ã€‚ã€‚åºŸã€‚ã€‚ã€‚è¯ã€‚ã€‚ã€‚å—ã€‚ã€‚ã€‚ï¼Ÿï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>Catch (Exception e) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">//who cares?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å“ˆå“ˆï¼Œæˆ‘çŸ¥é“ç³»ç»Ÿæœ‰å¼‚å¸¸å•Šï¼Œä½†æ˜¯æˆ‘æ‰ä¸ç®¡å‘¢ï¼Œå“¼~~~ â•­(â•¯^â•°)â•®&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// I am not responsible of this code.
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>o(â•¯â–¡â•°)o è¿™ä¸ªã€‚ã€‚ã€‚ä¸æ˜¯æˆ‘å¹²çš„~~~çœŸçš„ï¼ï¼ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// it was hard to write
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// so it should be hard to read
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€ä»¥ä¸èƒ½æ€ªæˆ‘å’¯ï¼Œä»£ç æœ¬æ¥å°±ä¸å¥½å†™ï¼Œä½ è¿˜æƒ³æˆ‘è®©ä½ å¥½è¯»ï¼Ÿï¼Ÿï¼Ÿ &lt;strong>â•­(â•¯^â•°)â•®&lt;/strong> æ¥å•Šï¼Œäº’ç›¸ä¼¤å®³å•Šï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// I have to find a better job
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä½å“¥æ„è¯†åˆ°è‡ªå·±èŒä¸šç”Ÿæ¶¯çš„ç»ˆç»“äº†å—ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// If this code works, it was written by Paul DiLascia. If not, I don&amp;#39;t know
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// who wrote it
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åæ­£æˆ‘ä¸ç®¡ï¼Œå¥½çš„ä»£ç è·Ÿæˆ‘æœ‰å…³ï¼Œä¸å¥½çš„ä»£ç è‚¯å®šä¸æ˜¯æˆ‘å†™çš„ï¼ï¼ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Linux Sex&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ date ; unzip ; strip ; touch ; grep ; finger ; mount ; fsck ; more ; yes ; umount ; sleep
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¥½æ±¡çš„ä¸€æ®µä»£ç ï¼ï¼ï¼å¤©å“ªï¼Œæˆ‘çš„çœ¼ç›! &lt;code>(*/Ï‰â•²*)&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="">long&lt;/span> &lt;span style="">long&lt;/span> ago; &lt;span style="font-style:italic">/* in a galaxy far far away */&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘æœ‰æ•…äº‹ä½ æœ‰é…’ï¼Œæˆ‘æ¥ç»™ä½ è®²ä¸€å®¿ï¼ O(âˆ©_âˆ©)O&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c++" data-lang="c++">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"> * Always returns true.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">public&lt;/span> boolean isAvailable() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> false;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘è¯»ä¹¦å°‘ï¼Œä½ åˆ«éª—æˆ‘ï¼ï¼ˆè¿™æ®µä»£ç æ®è¯´æ˜¯çœŸçš„è·Ÿæ³¨é‡Šè¯´çš„ä¸€æ ·çš„~~~ï¼‰&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c++" data-lang="c++">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// Dear maintainer:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// Once you are done trying to &amp;#39;optimize&amp;#39; this routine,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// and have realized what a terrible mistake that was,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// please increment the following counter as a warning
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// to the next guy:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// total_hours_wasted_here = 42
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">//
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å“ˆå“ˆï¼Œè¿™æ˜¯å—å®³è€…è”ç›Ÿå—ï¼Ÿæ¥æ¥æ¥ï¼Œä½ æ‰å‘é‡Œäº†å—ï¼Ÿç­¾ä¸ªå­—ç™»è®°ä¸€ä¸‹å§ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c++" data-lang="c++">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">return&lt;/span> true; &lt;span style="font-style:italic">//true my ass! this doesn&amp;#39;t work
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å“ˆå“ˆï¼Œç«¥è¯é‡Œéƒ½æ˜¯éª—äººçš„ o(â•¯â–¡â•°)o&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">// Peter wrote this, nobody knows what it does, don&amp;#39;t change it!
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼–ç¨‹ç•Œç½‘çº¢&lt;strong>Peter&lt;/strong>åˆä¸­æ‹›â€¦â€¦&lt;/p>
&lt;p>**æ³¨æ„ï¼š**ä¸Šé¢æ‰€æœ‰æœ‰è¶£çš„ä»£ç ç‰‡æ®µè·Ÿæ³¨é‡Šéƒ½æ˜¯ä»ä»¥ä¸‹å¸–å­æˆ–è€…è®¨è®ºä¸­æ‘˜å½•ï¼Œæ¬¢è¿ç‚¹å‡»é“¾æ¥é˜…è¯»åŸæ–‡ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;a href="http://fuzzzyblog.blogspot.hk/2014/09/40-most-funny-code-comments.html">Fuzzzy blog: 40 most funny code comments ever&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.quora.com/What-are-some-of-the-funniest-comments-in-source-code">What are some of the funniest comments in source code?&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å&lt;/h2>
&lt;p>å¤§å¤šæ•°ç¨‹åºçŒ¿çš„æ—¥å¸¸å·¥ä½œç¹é‡è¾›è‹¦ï¼ŒåŠ ç­è·Ÿé«˜åº¦çš„ç²¾ç¥å‹åŠ›éƒ½æ˜¯å®¶å¸¸ä¾¿é¥­ï¼Œå¦‚æœä½ çš„èº«è¾¹æœ‰è¿™æ ·çš„ç¨‹åºçŒ¿ï¼Œè¯·ä¸€å®šè¦å¤šå¤šçæƒœä»–ä»¬ï¼ä¹Ÿç¥æ„¿çœ‹åˆ°è¿™ç¯‡å¸–å­çš„ç¨‹åºçŒ¿ä»¬å¼€æ€€ä¸€ç¬‘ï¼Œç”Ÿæ´»å·²ç»å¦‚æ­¤å¤šè‰°ï¼Œå¿«å¿«ä¼‘æ¯æ”¾æ¾ä¸€ä¸‹å§ï¼&lt;/p></description></item><item><title>Sidekiq ä¿¡å·å¤„ç†æºç åˆ†æ</title><link>https://blog.hackerpie.com/posts/archive/sidekiq-xin-hao-chu-li-yuan-ma-fen-xi/</link><pubDate>Sun, 20 Nov 2016 10:08:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/sidekiq-xin-hao-chu-li-yuan-ma-fen-xi/</guid><description>&lt;h3 id="å¼•è¨€">å¼•è¨€&lt;/h3>
&lt;p>åœ¨ä¹‹å‰çš„æ–‡ç« &lt;a href="https://blog.hackerpie.com/blog/articles/2016/10/29/sidekiqren-wu-diao-du-liu-cheng-fen-xi/">ã€ŠSidekiqä»»åŠ¡è°ƒåº¦æµç¨‹åˆ†æã€‹&lt;/a>ä¸­ï¼Œæˆ‘ä»¬ä¸€èµ·ä»”ç»†åˆ†æäº† Sidekiq æ˜¯å¦‚ä½•åŸºäºå¤šçº¿ç¨‹å®Œæˆé˜Ÿåˆ—ä»»åŠ¡å¤„ç†ä»¥åŠè°ƒåº¦çš„ã€‚æˆ‘ä»¬åœ¨ä¹‹å‰çš„åˆ†æé‡Œï¼Œçœ‹åˆ°äº†ä¸ç®¡æ˜¯ &lt;code>Sidekiq::Scheduled::Poller&lt;/code> è¿˜æ˜¯ &lt;code>Sidekiq::Processor&lt;/code> çš„æ ¸å¿ƒä»£ç é‡Œï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªç”± &lt;code>@done&lt;/code> å®ä¾‹å˜é‡æ§åˆ¶çš„å¾ªç¯ä½“ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L63-L73&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread ||= safe_thread(&lt;span style="font-style:italic">&amp;#34;scheduler&amp;#34;&lt;/span>) &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> initial_wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> !@done &lt;span style="font-style:italic"># è¿™æ˜¯ poller çš„å¾ªç¯æ§åˆ¶&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> enqueue
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.info(&lt;span style="font-style:italic">&amp;#34;Scheduler exiting...&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L66-L77&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> !@done &lt;span style="font-style:italic"># è¿™æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ worker å¾ªç¯æ§åˆ¶&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> process_one
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_stopped(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Sidekiq::Shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_stopped(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Exception =&amp;gt; ex
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_died(self, ex)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº› &lt;code>@done&lt;/code> å®ä¾‹å˜é‡å†³å®šäº† &lt;code>poller&lt;/code> çº¿ç¨‹è·Ÿ &lt;code>worker&lt;/code> çº¿ç¨‹æ˜¯å¦å¾ªç¯æ‰§è¡Œï¼Ÿä¸€æ—¦ &lt;code>@done&lt;/code> è¢«æ”¹ä¸º &lt;code>true&lt;/code>ï¼Œé‚£å¾ªç¯ä½“å°±ä¸å†æ‰§è¡Œï¼Œçº¿ç¨‹è‡ªç„¶ä¹Ÿå°±æ˜¯é€€å‡ºäº†ã€‚äºæ˜¯ï¼Œå•ä»è¿™äº›ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥æ–­å®šï¼Œ Sidekiq å°±æ˜¯é€šè¿‡è®¾ç½® &lt;code>@done&lt;/code> çš„å€¼æ¥é€šçŸ¥ä¸€ä¸ªçº¿ç¨‹å®‰å…¨é€€å‡ºï¼ˆgraceful exitï¼‰çš„ã€‚æˆ‘ä»¬ä¹ŸçŸ¥é“ï¼Œç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡å‘é€ä¿¡å·çš„æ–¹å¼æ¥å‘Šè¯‰ sidekiq é€€å‡ºæˆ–è€…è¿›å…¥é™é»˜(quiet)çŠ¶æ€çš„ï¼Œé‚£ä¹ˆï¼Œè¿™é‡Œçš„ &lt;code>@done&lt;/code> æ˜¯æ€ä¹ˆè·Ÿä¿¡å·å¤„ç†è”ç³»èµ·æ¥çš„å‘¢ï¼Ÿè¿™äº›å°±æ˜¯ä»Šå¤©è¿™ç¯‡æ–‡ç« çš„é‡ç‚¹äº†ï¼&lt;/p>
&lt;h3 id="æ³¨æ„">æ³¨æ„&lt;/h3>
&lt;ol>
&lt;li>ä»Šå¤©çš„åˆ†ææ‰€å‚è€ƒçš„ sidekiq çš„æºç å¯¹åº”ç‰ˆæœ¬æ˜¯ 4.2.3ï¼›&lt;/li>
&lt;li>ä»Šå¤©æ‰€è®¨è®ºçš„å†…å®¹ï¼Œå°†ä¸»è¦å›´ç»•ç³»ç»Ÿä¿¡å·å¤„ç†è¿›è¡Œåˆ†æï¼Œæ— å…³ç»†èŠ‚å°†ä¸èµ˜è¿°ï¼Œå¦‚æœ‰éœ€è¦ï¼Œè¯·è‡ªè¡Œç¿»é˜… sidekiq æºç ï¼›&lt;/li>
&lt;li>ä»Šå¤©çš„æ–‡ç« è·Ÿä¸Šç¯‡çš„ã€ŠSidekiqä»»åŠ¡è°ƒåº¦æµç¨‹åˆ†æã€‹ç´§å¯†ç›¸å…³ï¼Œä¸Šç¯‡æ–‡ç« ä»‹ç»çš„å¯åŠ¨è¿‡ç¨‹è·Ÿä»»åŠ¡è°ƒåº¦ä¼šå¸®åŠ©è¿™ç¯‡æ–‡ç« çš„ç†è§£ï¼Œå¦‚æœè¿˜æ²¡æœ‰é˜…è¯»ä¸Šç¯‡æ–‡ç« çš„ï¼Œå»ºè®®å…ˆé˜…è¯»åå†æ¥é˜…è¯»è¿™ä¸€ç¯‡ä¿¡å·å¤„ç†çš„æ–‡ç« ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="ä½ å°†äº†è§£åˆ°ä»€ä¹ˆ">ä½ å°†äº†è§£åˆ°ä»€ä¹ˆï¼Ÿ&lt;/h3>
&lt;ol>
&lt;li>Sidekiq ä¿¡å·å¤„ç†æœºåˆ¶ï¼›&lt;/li>
&lt;li>ä¸ºä»€ä¹ˆé‡å¯ Sidekiq æ—¶ï¼Œ&lt;code>USR1&lt;/code> ä¿¡å·ï¼ˆå³è¿›å…¥ &lt;code>quiet&lt;/code> æ¨¡å¼ï¼‰éœ€è¦å°½å¯èƒ½æ—©ï¼Œè€Œè¿›ç¨‹çš„é€€å‡ºé‡å¯éœ€è¦å°½å¯èƒ½æ™šã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="ä»å¤´å†æ¥">ä»å¤´å†æ¥&lt;/h3>
&lt;p>å› ä¸ºå‰ä¸€ç¯‡æ–‡ç« ç€çœ¼äºä»»åŠ¡è°ƒåº¦ï¼Œæ‰€ä»¥ç•¥è¿‡äº†å…¶ä»–æ— å…³ç»†èŠ‚ï¼ŒåŒ…æ‹¬ä¿¡å·å¤„ç†ï¼Œè¿™ç¯‡æ–‡ç« åˆ™å°†é•œå¤´å¯¹å‡†ä¿¡å·å¤„ç†ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»å¤´å†æ¥ä¸€éï¼Œåªæ˜¯è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬åªå…³å¿ƒä¸ä¿¡å·å¤„ç†æœ‰å…³çš„ä»£ç ã€‚&lt;/p>
&lt;p>ä¾æ—§æ˜¯ä» &lt;code>cli.rb&lt;/code> æ–‡ä»¶å¼€å§‹ï¼Œå®ƒæ˜¯ Sidekiq æ ¸å¿ƒä»£ç çš„ç”Ÿå‘½èµ·ç‚¹ï¼Œå› ä¸º Sidekiq å‘½ä»¤è¡Œå¯åŠ¨åï¼Œå®ƒæ˜¯ç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„ä»£ç ï¼ŒSidekiq å¯åŠ¨è¿‡ç¨‹ä¸­è°ƒç”¨äº† &lt;code>Sidekiq::CLI#run&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/cli.rb#L49-L106&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> boot_system
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> print_banner
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self_read, self_write = IO.pipe
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">%w(INT TERM USR1 USR2 TTIN)&lt;/span>.each &lt;span style="font-weight:bold">do&lt;/span> |sig|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> trap sig &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self_write.puts(sig)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> ArgumentError
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> puts &lt;span style="font-style:italic">&amp;#34;Signal &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>sig&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> not supported&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ... other codes&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> launcher.run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> readable_io = IO.select([self_read])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> signal = readable_io.first[0].gets.strip
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handle_signal(signal)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Interrupt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.info &lt;span style="font-style:italic">&amp;#39;Shutting down&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> launcher.stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Explicitly exit so busy Processor threads can&amp;#39;t block&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># process shutdown.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.info &lt;span style="font-style:italic">&amp;#34;Bye!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit(0)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»¥ä¸Šçš„ä»£ç å°±æ˜¯æ•´ä¸ª Sidekiq æœ€é¡¶å±‚çš„ä¿¡å·å¤„ç†çš„æ ¸å¿ƒä»£ç äº†ï¼Œè®©æˆ‘ä»¬æ…¢æ…¢åˆ†æï¼
é¦–å…ˆï¼Œ&lt;code>self_read, self_write = IO.pipe&lt;/code> åˆ›å»ºäº†ä¸€ä¸ªæ¨¡æ‹Ÿç®¡é“çš„ IO å¯¹è±¡ï¼Œå¹¶ä¸”åŒæ—¶è¿”å›è¿™ä¸ª ç®¡é“çš„ä¸€ä¸ªå†™ç«¯ä»¥åŠä¸€ä¸ªè¯»ç«¯ï¼Œé€šè¿‡è¿™ä¸¤ç«¯ï¼Œå°±å¯ä»¥å®ç°å¯¹ç®¡é“çš„è¯»å†™äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ&lt;code>IO.pipe&lt;/code> åˆ›å»ºçš„è¯»ç«¯åœ¨è¯»çš„æ—¶å€™ä¸ä¼šè‡ªåŠ¨ç”Ÿæˆ &lt;code>EOF&lt;/code> ç¬¦ï¼Œæ‰€ä»¥è¿™å°±è¦æ±‚è¯»æ—¶ï¼Œå†™ç«¯æ˜¯å…³é—­çš„ï¼Œè€Œå†™æ—¶ï¼Œè¯»ç«¯æ˜¯å…³é—­çš„ï¼Œä¸€å¥è¯è¯´ï¼Œå°±æ˜¯è¿™æ ·çš„ç®¡é“ä¸å…è®¸è¯»å†™ç«¯åŒæ—¶æ‰“å¼€ã€‚å…³äº &lt;code>IO.pipe&lt;/code> è¿˜æœ‰æŒºå¤šç»†èŠ‚è·Ÿéœ€è¦æ³¨æ„çš„ç‚¹ï¼Œå¦‚æœè¿˜éœ€è¦äº†è§£ï¼Œè¯·é˜…è¯»&lt;a href="https://ruby-doc.org/core-2.3.1/IO.html#method-c-pipe">å®˜æ–¹æ–‡æ¡£&lt;/a>ã€‚&lt;/p>
&lt;p>ä¸Šé¢è¯´çš„ç®¡é“æœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ª IO å¯¹è±¡è€Œå·²ï¼Œæš‚æ—¶ä¸ç”¨çº ç»“å¤ªå¤šï¼Œè®©æˆ‘ä»¬æ¥ç€å¾€ä¸‹è¯»ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">%w(INT TERM USR1 USR2 TTIN)&lt;/span>.each &lt;span style="font-weight:bold">do&lt;/span> |sig|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> trap sig &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self_write.puts(sig)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> ArgumentError
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> puts &lt;span style="font-style:italic">&amp;#34;Signal &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>sig&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> not supported&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ®µä»£ç å°±æ¯”è¾ƒæœ‰æ„æ€äº†ï¼Œæœ€å¤–å±‚éå†äº†ä¸€ä¸ªç³»ç»Ÿä¿¡å·çš„æ•°ç»„ï¼Œç„¶åé€ä¸ªä¿¡å·è¿›è¡Œç›‘å¬ï¼ˆtrapï¼Œæˆ–è€…å«æ•æ‰ï¼Ÿï¼‰ã€‚è®©æˆ‘ä»¬èšç„¦åœ¨ &lt;code>trap&lt;/code> æ–¹æ³•çš„è°ƒç”¨è·Ÿå…¶ block ä¸Šï¼ŒæŸ¥é˜… &lt;a href="https://ruby-doc.org/core-2.2.0/Signal.html#method-c-trap">Ruby æ–‡æ¡£&lt;/a>ï¼Œå‘ç° &lt;code>trap&lt;/code> æ˜¯ &lt;code>Signal&lt;/code> æ¨¡å—ä¸‹çš„ä¸€ä¸ªæ–¹æ³•ï¼Œ&lt;code>Signal&lt;/code> ä¸»è¦æ˜¯å¤„ç†ä¸ç³»ç»Ÿä¿¡å·æœ‰å…³çš„ä»»åŠ¡ï¼Œç„¶å &lt;code>trap&lt;/code> çš„ä½œç”¨æ˜¯ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Specifies the handling of signals. The first parameter is a signal name (a string such as â€œSIGALRMâ€, â€œSIGUSR1â€, and so on) or a signal number&amp;hellip;&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ï¼Œå‰é¢çš„é‚£æ®µä»£ç çš„æ„æ€å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼ŒSidekiq æ³¨å†Œäº†å¯¹ &lt;code>INT&lt;/code>ã€&lt;code>TERM&lt;/code>ã€&lt;code>USR1&lt;/code>ã€&lt;code>USR2&lt;/code>ä»¥åŠ&lt;code>TTIN&lt;/code>ç­‰ç³»ç»Ÿä¿¡å·çš„å¤„ç†ï¼Œè€Œåœ¨è¿›ç¨‹æ”¶åˆ°è¿™äº›ä¿¡å·æ—¶ï¼Œå°±ä¼šæ‰§è¡Œ &lt;code>self_write.puts(sig)&lt;/code>ï¼Œä¹Ÿå°±æ˜¯å°†æ”¶åˆ°çš„ä¿¡å·é€šè¿‡ä¹‹å‰ä»‹ç»çš„ç®¡é“å†™ç«¯ &lt;code>self_write&lt;/code> è®°å½•ä¸‹æ¥ã€‚ä»€ä¹ˆï¼Ÿåªè®°å½•ä¸‹æ¥ï¼Œé‚£è¿˜å¾—å¤„ç†å•Šï¼Ÿï¼&lt;/p>
&lt;p>ç¨å®‰å‹¿èºï¼Œè®©æˆ‘ä»¬æ¥ç€å¾€ä¸‹åˆ†æ &lt;code>Sidekiq::CLI#run&lt;/code> æ–¹æ³•æœ«å°¾çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> launcher.run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> readable_io = IO.select([self_read])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> signal = readable_io.first[0].gets.strip
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handle_signal(signal)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">rescue&lt;/span> Interrupt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.info &lt;span style="font-style:italic">&amp;#39;Shutting down&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> launcher.stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Explicitly exit so busy Processor threads can&amp;#39;t block&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># process shutdown.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.info &lt;span style="font-style:italic">&amp;#34;Bye!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit(0)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹åˆ°æ²¡æœ‰ï¼Œè¿™é‡Œæœ‰ä¸ªå¾ªç¯ï¼Œå¾ªç¯æ§åˆ¶æ¡ä»¶é‡Œï¼Œ&lt;code>readable_io = IO.select([self_read])&lt;/code> æ˜¯ä»å‰é¢çš„ç®¡é“çš„è¯»ç«¯ &lt;code>self_read&lt;/code> é˜»å¡åœ°ç­‰å¾…ä¿¡å·çš„åˆ°è¾¾ã€‚å¯¹äº &lt;code>IO.select&lt;/code>ï¼Œ&lt;a href="https://ruby-doc.org/core-2.3.1/IO.html#method-c-select">Ruby å®˜æ–¹æ–‡æ¡£&lt;/a>ä»‹ç»å¦‚ä¸‹ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Calls select(2) system call. It monitors given arrays of IO objects, waits until one or more of IO objects are ready for reading, are ready for writing, and have pending exceptions respectively, and returns an array that contains arrays of those IO objects.&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥è¿™é‡Œå°±æ˜¯è¯´ Sidekiq ä¸»çº¿ç¨‹é¦–å…ˆè´Ÿè´£æ‰§è¡Œå®Œå…¶ä»–åˆå§‹åŒ–å·¥ä½œï¼Œæœ€åé˜»å¡åœ¨ä¿¡å·ç­‰å¾…ä»¥åŠå¤„ç†ã€‚åœ¨å…¶ç­‰åˆ°æ–°çš„ä¿¡å·ä¹‹åï¼Œè¿›å…¥ä¸Šé¢ä»£ç å±•ç¤ºçš„å¾ªç¯ä½“ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>signal = readable_io.first[0].gets.strip
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>handle_signal(signal)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œè¯­æ³•ç»†èŠ‚å…ˆä¸æ·±ç©¶ï¼Œæˆ‘ä»¬çœ‹ä¸‹è¿™ä¸¤è¡Œä»£ç ç¬¬ä¸€è¡Œæ˜¯ä»å‰é¢è¯´çš„ç®¡é“ä¸­è¯»å–ä¿¡å·ï¼Œå¹¶ä¸”å°†ä¿¡å·ä¼ é€’ç»™ &lt;code>handle_signal&lt;/code> æ–¹æ³•ï¼Œè®©æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ &lt;code>handle_signal&lt;/code> æ–¹æ³•çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/cli.rb#L125-L153&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> handle_signal(sig)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.debug &lt;span style="font-style:italic">&amp;#34;Got &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>sig&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> signal&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">case&lt;/span> sig
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">when&lt;/span> &lt;span style="font-style:italic">&amp;#39;INT&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Handle Ctrl-C in JRuby like MRI&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># http://jira.codehaus.org/browse/JRUBY-4637&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span> Interrupt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">when&lt;/span> &lt;span style="font-style:italic">&amp;#39;TERM&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Heroku sends TERM and then waits 10 seconds for process to exit.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span> Interrupt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">when&lt;/span> &lt;span style="font-style:italic">&amp;#39;USR1&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.info &lt;span style="font-style:italic">&amp;#34;Received USR1, no longer accepting new work&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> launcher.quiet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">when&lt;/span> &lt;span style="font-style:italic">&amp;#39;USR2&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> Sidekiq.options[&lt;span style="font-style:italic">:logfile&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.info &lt;span style="font-style:italic">&amp;#34;Received USR2, reopening log file&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq::Logging.reopen_logs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">when&lt;/span> &lt;span style="font-style:italic">&amp;#39;TTIN&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Thread.list.each &lt;span style="font-weight:bold">do&lt;/span> |thread|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.warn &lt;span style="font-style:italic">&amp;#34;Thread TID-&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>thread.object_id.to_s(36)&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>thread[&lt;span style="font-style:italic">&amp;#39;label&amp;#39;&lt;/span>]&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> thread.backtrace
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.warn thread.backtrace.join(&lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\n&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.warn &lt;span style="font-style:italic">&amp;#34;&amp;lt;no backtrace available&amp;gt;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„ä»£ç æŒºé•¿ï¼Œä½†æ˜¯ä¸€ç‚¹éƒ½ä¸éš¾ç†è§£ï¼Œæˆ‘ç®€å•è§£é‡Šä¸‹å°±å¤Ÿäº†ã€‚å½“è¿›ç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>æ”¶åˆ° &lt;code>TERM&lt;/code> æˆ–è€… &lt;code>INT&lt;/code>ä¿¡å·æ—¶ï¼Œç›´æ¥æŠ›å‡º &lt;code>Interrupt&lt;/code> ä¸­æ–­ï¼›&lt;/li>
&lt;li>æ”¶åˆ° &lt;code>USR1&lt;/code> ä¿¡å·æ—¶ï¼Œåˆ™é€šçŸ¥ &lt;code>launcher&lt;/code> æ‰§è¡Œ &lt;code>.quiet&lt;/code> æ–¹æ³•ï¼ŒSidekiq åœ¨è¿™é‡Œè¿›å…¥ Quiet æ¨¡å¼ï¼ˆæ€ä¹ˆè¿›å…¥ï¼Ÿï¼‰ï¼›&lt;/li>
&lt;li>æ”¶åˆ° &lt;code>USR2&lt;/code> ä¿¡å·æ—¶ï¼Œé‡æ–°æ‰“å¼€æ—¥å¿—ï¼›&lt;/li>
&lt;li>æ”¶åˆ° &lt;code>TTIN&lt;/code> ä¿¡å·æ—¶ï¼Œæ‰“å°æ‰€æœ‰çº¿ç¨‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç åˆ—è¡¨ã€‚&lt;/li>
&lt;/ol>
&lt;p>åˆ°æ­¤ï¼Œä¸€ä¸ªä¿¡å·ä»æ”¶åˆ°è¢«å­˜ä¸‹ï¼Œåˆ°è¢«å–å‡ºå¤„ç†çš„å¤§è‡´è¿‡ç¨‹å°±æ˜¯è¿™æ ·çš„ï¼Œè‡³äºå…·ä½“çš„å¤„ç†æ–¹å¼ï¼Œæˆ‘ä»¬ä¸‹ä¸ªç« èŠ‚è¯¦ç»†å±•å¼€ã€‚ç°åœ¨æœ‰ä¸€ç‚¹éœ€è¦è¡¥å……çš„æ˜¯ï¼Œä¸Šé¢è®²å½“ Sidekiq æ”¶åˆ° &lt;code>TERM&lt;/code> æˆ–è€… &lt;code>INT&lt;/code> ä¿¡å·æ—¶ï¼Œéƒ½ä¼šæŠ›å‡º &lt;code>Interrupt&lt;/code> ä¸­æ–­å¼‚å¸¸ï¼Œé‚£è¿™ä¸ªå¼‚å¸¸åˆæ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿæˆ‘ä»¬å›è¿‡å¤´å»çœ‹åˆšæ‰æœ€å¼€å§‹çš„ &lt;code>Sidekiq::CLI#run&lt;/code> æ–¹æ³•æœ«å°¾çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> launcher.run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> readable_io = IO.select([self_read])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> signal = readable_io.first[0].gets.strip
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handle_signal(signal)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">rescue&lt;/span> Interrupt
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.info &lt;span style="font-style:italic">&amp;#39;Shutting down&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> launcher.stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Explicitly exit so busy Processor threads can&amp;#39;t block&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># process shutdown.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.info &lt;span style="font-style:italic">&amp;#34;Bye!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exit(0)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŸæ¥æ˜¯ &lt;code>run&lt;/code> æ–¹æ³•åœ¨å¤„ç†ä¿¡å·æ—¶ï¼Œå£°æ˜äº† &lt;code>rescue Interrupt&lt;/code>ï¼Œæ•æ‰äº† &lt;code>Interrupt&lt;/code> ä¸­æ–­å¼‚å¸¸ï¼Œå¹¶ä¸”åœ¨å¼‚å¸¸å¤„ç†æ—¶æ‰“å°å¿…è¦æ—¥å¿—ï¼ŒåŒæ—¶æ‰§è¡Œ &lt;code>launcher.stop&lt;/code> é€šçŸ¥å„ä¸ªçº¿ç¨‹åœæ­¢å·¥ä½œï¼Œæœ€åè°ƒç”¨ &lt;code>exit&lt;/code> æ–¹æ³•å¼ºåˆ¶é€€å‡ºè¿›ç¨‹ï¼Œåˆ°æ­¤ï¼Œä¸€ä¸ª Sidekiq è¿›ç¨‹å°±å½»åº•é€€å‡ºäº†ã€‚
ä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œä¿¡å·å¤„ç†çš„å¤§è‡´è¿‡ç¨‹æˆ‘æ˜¯çŸ¥é“äº†ï¼Œä½†æ˜¯å…·ä½“çš„ &lt;code>launcher.quiet&lt;/code> è·Ÿ &lt;code>launcher.stop&lt;/code> éƒ½å¹²äº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="sidekiqlauncherquiet-æºç æ¢ç´¢">Sidekiq::Launcher#quiet æºç æ¢ç´¢&lt;/h3>
&lt;p>è€è§„çŸ©ï¼Œå…ˆä¸Šä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/launcher.rb#L32-L36&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> quiet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @done = &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @manager.quiet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @poller.terminate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç åªæœ‰çŸ­çŸ­ä¸‰è¡Œã€‚ Launcher å¯¹è±¡é¦–å…ˆè®¾ç½®è‡ªå·±çš„å®ä¾‹å˜é‡ &lt;code>@done&lt;/code> çš„å€¼ä¸º &lt;code>true&lt;/code>ï¼Œæ¥ç€æ‰§è¡Œ &lt;code>@manager.quiet&lt;/code> ä»¥åŠ &lt;code>@poller.terminate&lt;/code>ã€‚çœ‹æ–¹æ³•å‘½åä¸Šç†è§£ï¼Œåº”è¯¥æ˜¯ Luancher å¯¹è±¡åˆå°† quiet çš„æ¶ˆæ¯ä¼ é€’ç»™äº† &lt;code>@manager&lt;/code> å³ &lt;code>Sidekiq::Manager&lt;/code> å¯¹è±¡ï¼ŒåŒæ—¶é€šçŸ¥ &lt;code>@poller&lt;/code> å³ &lt;code>Sidekiq::Scheduled::Poller&lt;/code> å¯¹è±¡ç»“æŸå·¥ä½œã€‚é‚£åˆ°åº•æ˜¯ä¸æ˜¯çœŸçš„è¿™æ ·å‘¢ï¼Ÿè®©æˆ‘ä»¬ç»§ç»­æ·±æŒ–ï¼&lt;/p>
&lt;h4 id="sidekiqmanagerquiet">Sidekiq::Manager#quiet&lt;/h4>
&lt;p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ &lt;code>Sidekiq::Manager#quiet&lt;/code> æ–¹æ³•çš„ä»£ç &lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/manager.rb#L51-L58&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> quiet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> @done
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @done = &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.info { &lt;span style="font-style:italic">&amp;#34;Terminating quiet workers&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @workers.each { |x| x.terminate }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fire_event(&lt;span style="font-style:italic">:quiet&lt;/span>, &lt;span style="">true&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä»£ç ä¹Ÿå¾ˆçŸ­ï¼Œé¦–å…ˆå°† &lt;code>Sidekiq::Manager&lt;/code> å¯¹è±¡è‡ªèº«çš„ &lt;code>@done&lt;/code> å®ä¾‹å˜é‡çš„å€¼è®¾ç½®ä¸º &lt;code>true&lt;/code>ï¼Œæ¥ç€å¯¹å…¶æ‰€ç®¡ç†çš„æ¯ä¸€ä¸ª workerï¼Œéƒ½å‘å‡ºä¸€ä¸ª &lt;code>terminate&lt;/code> æ¶ˆæ¯ã€‚è®©æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ worker å¯¹è±¡ï¼ˆ&lt;code>Sidekiq::Processor&lt;/code> å¯¹è±¡ï¼‰çš„ &lt;code>#terminate&lt;/code> æ–¹æ³•å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L42-L46&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> terminate(wait=&lt;span style="">false&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @done = &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> !@thread
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread.value &lt;span style="font-weight:bold">if&lt;/span> wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„ä»£ç ä¾ç„¶ä¿æŒäº†ç²¾çŸ­çš„ç‰¹ç‚¹ï¼è·Ÿä¸Šä¸€å±‚é€»è¾‘ä¸€æ ·ï¼Œworker åœ¨å¤„ç† &lt;code>terminate&lt;/code> æ—¶ï¼ŒåŒæ ·è®¾ç½®è‡ªå·±çš„ &lt;code>@done&lt;/code> å®ä¾‹å˜é‡ä¸º &lt;code>true&lt;/code> åè¿”å›ï¼Œä½†æ˜¯ï¼Œå¦‚æœå…¶å‚æ•° &lt;code>wait&lt;/code> ä¸º &lt;code>true&lt;/code>ï¼Œåˆ™ä¼šä¿æŒä¸»çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ° &lt;code>@thread&lt;/code> çº¿ç¨‹é€€å‡ºï¼ˆ&lt;code>@thread.value&lt;/code> ç›¸å½“äºæ‰§è¡Œ &lt;code>@thread.join&lt;/code>å¹¶ä¸”è¿”å›çº¿ç¨‹çš„è¿”å›å€¼ï¼Œå¯å‚è€ƒ &lt;a href="https://ruby-doc.org/core-2.2.0/Thread.html#method-i-value">Ruby æ–‡æ¡£&lt;/a>ï¼‰ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆï¼Œè¿™é‡Œå°±è¦é—®äº†ï¼Œworker è®¾ç½® &lt;code>@done&lt;/code> ä¸º true æ˜¯è¦å¹²å˜›ï¼Ÿè¿™é‡Œå¥½åƒä¹Ÿæ²¡æœ‰åšä»€ä¹ˆç‰¹åˆ«çš„äº‹å•Šï¼Ÿï¼å‹¿æ€¥ï¼Œè¿˜è®°å¾—ä¸Šç¯‡æ–‡ç« ä»‹ç» worker è¿è¡Œæ—¶çš„æ ¸å¿ƒä»£ç å—ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L66-L77&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> !@done
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> process_one
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_stopped(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Sidekiq::Shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_stopped(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Exception =&amp;gt; ex
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_died(self, ex)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹åˆ°äº†å§ï¼Œ&lt;code>@done&lt;/code> å˜é‡å¯æ˜¯ä¸€ä¸ªé‡è¦çš„å¼€å…³ï¼Œå½“ &lt;code>@done&lt;/code> ä¸º &lt;code>false&lt;/code> æ—¶ï¼Œworker ä¸€ç›´å‘¨è€Œå¤å§‹åœ°ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡å¹¶ä¸”è€è€å®å®å¹²æ´»ï¼›è€Œå½“ &lt;code>@done&lt;/code> ä¸º &lt;code>true&lt;/code> æ—¶ï¼Œworker åœ¨å¤„ç†å®Œå½“å‰çš„ä»»åŠ¡ä¹‹åï¼Œä¾¿ä¸å†æ‰§è¡Œæ–°çš„ä»»åŠ¡ï¼Œæ‰§è¡Œ &lt;code>@msg.processor_stopped(self)&lt;/code> é€šçŸ¥ worker ç®¡ç†å™¨è‡ªå·±å·²ç»é€€å‡ºå·¥ä½œï¼Œæœ€ç»ˆ &lt;code>#run&lt;/code> æ–¹æ³•è¿”å›ã€‚ç”±äº &lt;code>#run&lt;/code> æ–¹æ³•æ˜¯åœ¨ç‹¬ç«‹çº¿ç¨‹é‡Œæ‰§è¡Œçš„ï¼Œæ‰€ä»¥å½“ &lt;code>#run&lt;/code> æ–¹æ³•è¿”å›æ—¶ï¼Œå…¶æ‰€åœ¨çš„çº¿ç¨‹è‡ªç„¶ä¹Ÿå°±é€€å‡ºäº†ã€‚&lt;/p>
&lt;p>é‚£å…³äº worker çš„ quiet æ¨¡å¼è¿›å…¥è¿‡ç¨‹å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œé€šè¿‡ä¸€ä¸ªå…±äº«å˜é‡ &lt;code>@done&lt;/code> ä¾¿å®ç°äº†å¯¹å·¥ä½œçº¿ç¨‹çš„æ§åˆ¶ã€‚&lt;/p>
&lt;h4 id="sidekiqscheduledpollerterminate">Sidekiq::Scheduled::Poller#terminate&lt;/h4>
&lt;p>å‰é¢è¯´åˆ° &lt;code>Sidekiq::Launcher#quiet&lt;/code> æ‰§è¡Œæ—¶ï¼Œå…ˆå°†æ¶ˆæ¯ä¼ é€’ç»™äº† worker ç®¡ç†å™¨ï¼Œéšåæ‰§è¡Œäº† &lt;code>@poller.terminate&lt;/code>ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹çœ‹ &lt;code>#terminate&lt;/code> æ–¹æ³•çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L53-L61&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> terminate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @done = &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> @thread
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t = @thread
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread = &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @sleeper &amp;lt;&amp;lt; 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> t.value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆæ˜¯å¦‚æ­¤ç®€çŸ­çš„ä»£ç ã€‚poller é€€å‡ºçš„é€»è¾‘è·Ÿ worker é€€å‡ºçš„é€»è¾‘éå¸¸ä¸€è‡´ï¼Œéƒ½æ˜¯åŒæ ·å…ˆè®¾ç½®è‡ªå·±çš„ &lt;code>@done&lt;/code> å®ä¾‹å˜é‡çš„å€¼ä¸º &lt;code>true&lt;/code>ï¼Œæ¥ç€ç­‰å¾…çº¿ç¨‹ &lt;code>@thread&lt;/code> é€€å‡ºï¼Œæœ€å poller è¿”å›ã€‚&lt;/p>
&lt;p>é‚£ä¹ˆï¼Œpoller çš„ &lt;code>@done&lt;/code> æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯ç”¨æ¥æ§åˆ¶çº¿ç¨‹é€€å‡ºå‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L63-L73&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread ||= safe_thread(&lt;span style="font-style:italic">&amp;#34;scheduler&amp;#34;&lt;/span>) &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> initial_wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> !@done
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> enqueue
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.info(&lt;span style="font-style:italic">&amp;#34;Scheduler exiting...&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿˜è®°å¾—ä¸Šé¢è¿™æ®µä»£ç å—ï¼Ÿ poller åœ¨æ¯æ¬¡å°†å®šæ—¶ä»»åŠ¡å‹å›ä»»åŠ¡é˜Ÿåˆ—ä¹‹åï¼Œç­‰å¾…ä¸€å®šæ—¶é—´ï¼Œç„¶åé‡æ–°æ£€æŸ¥ &lt;code>@done&lt;/code> çš„å€¼ï¼Œå¦‚æœä¸º &lt;code>true&lt;/code>ï¼Œåˆ™ poller ç›´æ¥è¿”å›é€€å‡ºï¼Œå› ä¸º &lt;code>#start&lt;/code> æ–¹æ³•é‡Œçš„å¾ªç¯ä½“åœ¨æ–°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå½“å¾ªç¯ç»“æŸæ—¶ï¼Œçº¿ç¨‹è‡ªç„¶ä¹Ÿé€€å‡ºäº†ã€‚&lt;/p>
&lt;h4 id="å°ç»“">å°ç»“&lt;/h4>
&lt;ol>
&lt;li>å½“ Sidekiq æ”¶åˆ° &lt;code>USR1&lt;/code> ç³»ç»Ÿä¿¡å·æ—¶ï¼ŒSidekiq ä¸»çº¿ç¨‹å‘ &lt;code>@launcher&lt;/code> å‘é€ &lt;code>quiet&lt;/code> æ¶ˆæ¯ï¼Œ&lt;code>@launcher&lt;/code> åˆå°†æ¶ˆæ¯ä¼ é€’ç»™ &lt;code>@manager&lt;/code> ï¼ŒåŒæ—¶å‘ &lt;code>@poller&lt;/code> å‘å‡º &lt;code>terminate&lt;/code> æ¶ˆæ¯ï¼›&lt;/li>
&lt;li>&lt;code>@manager&lt;/code> åœ¨æ”¶åˆ° &lt;code>quiet&lt;/code> æ¶ˆæ¯æ—¶ï¼Œé€ä¸€å¯¹è¿è¡Œä¸­çš„ worker å‘é€ &lt;code>terminate&lt;/code> æ¶ˆæ¯ï¼Œworker æ”¶åˆ°æ¶ˆæ¯åï¼Œè®¾ç½®è‡ªå·±çš„ &lt;code>@done&lt;/code> ä¸º &lt;code>true&lt;/code>ï¼Œæ ‡è¯†ä¸å†å¤„ç†æ–°ä»»åŠ¡ï¼Œå½“å‰ä»»åŠ¡å¤„ç†å®Œæˆåé€€å‡ºçº¿ç¨‹ï¼›&lt;/li>
&lt;li>&lt;code>@poller&lt;/code> åœ¨æ”¶åˆ° &lt;code>terminate&lt;/code> æ¶ˆæ¯åï¼Œä¹Ÿæ˜¯è®¾ç½®è‡ªå·±çš„ &lt;code>@done&lt;/code> ä¸º &lt;code>true&lt;/code>ï¼Œåœ¨æœ¬æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œçº¿ç¨‹ä¹Ÿé€€å‡ºï¼›&lt;/li>
&lt;li>Sidekiq è¿›å…¥ quiet æ¨¡å¼ä¹‹åï¼Œæ‰€æœ‰æœªå¤„ç†ä»»åŠ¡ä»¥åŠæ–°ä»»åŠ¡éƒ½ä¸å†å¤„ç†ï¼Œç›´åˆ° sidekiq çš„ä¸‹ä¸€æ¬¡é‡å¯ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="sidekiqlauncherstop-æºç æ¢ç´¢">Sidekiq::Launcher#stop æºç æ¢ç´¢&lt;/h3>
&lt;p>å‰é¢ä»‹ç»çš„æ˜¯ Sidekiq è¿›å…¥ quiet æ¨¡å¼çš„è¿‡ç¨‹ï¼Œé‚£ Sidekiq çš„åœæ­¢è¿‡ç¨‹åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿ&lt;/p>
&lt;p>è®©æˆ‘ä»¬ä» &lt;code>Sidekiq::Launcher#stop&lt;/code> æ–¹æ³•å¼€å§‹å¯»æ‰¾ç­”æ¡ˆï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/launcher.rb#L41-L56&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> stop
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> deadline = Time.now + @options[&lt;span style="font-style:italic">:timeout&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @done = &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @manager.quiet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @poller.terminate
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @manager.stop(deadline)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Requeue everything in case there was a worker who grabbed work while stopped&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># This call is a no-op in Sidekiq but necessary for Sidekiq Pro.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> strategy = (@options[&lt;span style="font-style:italic">:fetch&lt;/span>] || Sidekiq::BasicFetch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> strategy.bulk_requeue([], @options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> clear_heartbeat
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆï¼Œ&lt;code>Sidekiq::Launcher&lt;/code> å¯¹è±¡è®¾å®šäº†ä¸€ä¸ªå¼ºåˆ¶é€€å‡ºçš„ &lt;code>deadline&lt;/code>ï¼Œæ—¶é—´æ˜¯ä»¥å½“å‰æ—¶é—´åŠ ä¸Šé…ç½®çš„ &lt;code>timeout&lt;/code>ï¼Œè¿™ä¸ªæ—¶é—´&lt;a href="https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq.rb#L23">é»˜è®¤æ˜¯ 8 ç§’&lt;/a>ã€‚&lt;/p>
&lt;p>æ¥ç€ï¼Œè®¾å®šå¯¹è±¡æœ¬èº«çš„ &lt;code>@done&lt;/code> å˜é‡çš„å€¼ä¸º &lt;code>true&lt;/code>ï¼Œç„¶ååˆ†åˆ«å¯¹ &lt;code>@manager&lt;/code> å’Œ &lt;code>@poller&lt;/code> å‘é€ &lt;code>quiet&lt;/code> å’Œ &lt;code>terminate&lt;/code> æ¶ˆæ¯ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„ &lt;code>Sidekiq::Launcher#quiet&lt;/code> çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ï¼Œè¿™é‡Œçš„ä»£ç ä¸»è¦æ˜¯ Sidekiq è¦ç¡®ä¿é€€å‡ºå‰å·²ç»é€šçŸ¥å„ä¸ªçº¿ç¨‹å‡†å¤‡é€€å‡ºã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥çš„ä»£ç å°±æ¯”è¾ƒé‡è¦äº†ï¼Œæˆ‘ä»¬å…ˆçœ‹è¿™ä¸€è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>@manager.stop(deadline)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨é€šçŸ¥å®Œ &lt;code>@manager&lt;/code> è¿›å…¥ quiet æ¨¡å¼ä¹‹åï¼Œlauncher å‘ &lt;code>@manager&lt;/code> å‘é€äº† &lt;code>stop&lt;/code> æ¶ˆæ¯ï¼Œå¹¶ä¸”åŒæ—¶ä¼ é€’äº† &lt;code>deadline&lt;/code> å‚æ•°ã€‚è®©æˆ‘ä»¬æ¥ç€ç»§ç»­å¾€ä¸‹çœ‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/manager.rb#L61-L83&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>PAUSE_TIME = STDOUT.tty? ? 0.1 : 0.5
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> stop(deadline)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> quiet
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> fire_event(&lt;span style="font-style:italic">:shutdown&lt;/span>, &lt;span style="">true&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># some of the shutdown events can be async,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># we don&amp;#39;t have any way to know when they&amp;#39;re done but&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># give them a little time to take effect&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sleep PAUSE_TIME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> @workers.empty?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.info { &lt;span style="font-style:italic">&amp;#34;Pausing to allow workers to finish...&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remaining = deadline - Time.now
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> remaining &amp;gt; PAUSE_TIME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> @workers.empty?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sleep PAUSE_TIME
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remaining = deadline - Time.now
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> @workers.empty?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hard_shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä»£ç ï¼Œmanager é¦–å…ˆè°ƒç”¨äº†è‡ªèº«çš„ &lt;code>quiet&lt;/code> æ–¹æ³•ï¼ˆè¿™é‡Œå°±çœŸçš„å¤šæ­¤ä¸€ä¸¾äº†ï¼Œå› ä¸ºå¤–å±‚çš„ launcher å·²ç»è°ƒç”¨è¿‡ä¸€æ¬¡äº†ï¼‰ï¼Œç„¶å manager æ‰§è¡Œ &lt;code>sleep&lt;/code> ç³»ç»Ÿè°ƒç”¨è¿›å…¥ä¼‘çœ ï¼ŒæŒç»­æ—¶é—´ä¸º 0.5 ç§’ï¼Œä¼‘çœ ç»“æŸåæ£€æŸ¥æ‰€æœ‰ worker æ˜¯å¦å·²ç»éƒ½é€€å‡ºï¼Œå¦‚æœé€€å‡ºï¼Œåˆ™ç›´æ¥è¿”å›ï¼Œä»»åŠ¡æå‰ç»“æŸï¼›å¦‚æœä»æœ‰ worker æœªé€€å‡ºï¼Œåˆ™æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦æ¥è¿‘å¼ºåˆ¶é€€å‡ºçš„ deadlineï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™é‡å¤â€œæ£€æŸ¥æ‰€æœ‰ worker é€€å‡º - ä¼‘çœ â€ çš„è¿‡ç¨‹ï¼Œç›´åˆ° deadline æ¥ä¸´ï¼Œæˆ–è€… worker çº¿ç¨‹éƒ½å·²ç»å…¨éƒ¨é€€å‡ºã€‚å¦‚æœæœ€ååˆ°è¾¾ deadlineï¼Œä»æœ‰ worker çº¿ç¨‹æœªé€€å‡ºï¼Œåˆ™æœ€åæ‰§è¡Œ &lt;code>hard_shutdown&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/manager.rb#L108-L135&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> hard_shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cleanup = &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @plock.synchronize &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cleanup = @workers.dup
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> cleanup.size &amp;gt; 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jobs = cleanup.map {|p| p.job }.compact
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ... other codes&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> strategy = (@options[&lt;span style="font-style:italic">:fetch&lt;/span>] || Sidekiq::BasicFetch)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> strategy.bulk_requeue(jobs, @options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cleanup.each &lt;span style="font-weight:bold">do&lt;/span> |processor|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> processor.kill
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œ &lt;code>hard_shutdown&lt;/code> æ–¹æ³•åœ¨æ‰§è¡Œæ—¶ï¼Œé¦–å…ˆå…‹éš†äº†å½“å‰ä»æœªé€€å‡ºçš„ &lt;code>@workers&lt;/code> åˆ—è¡¨ï¼Œæ¥ç€è·å–æ¯ä¸ª worker å½“å‰æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œå°†è¿™äº›æ­£åœ¨æ‰§è¡Œä¸­çš„ä»»åŠ¡æ•°æ®é€šè¿‡ &lt;code>strategy.bulk_requeue(jobs, @options)&lt;/code> é‡æ–°å†™å›é˜Ÿåˆ—ï¼Œè€Œæœ€åå¯¹æ¯ä¸€ä¸ª worker å‘é€ &lt;code>kill&lt;/code> æ¶ˆæ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L48-L58&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> kill(wait=&lt;span style="">false&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @done = &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> !@thread
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread.raise ::Sidekiq::Shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread.value &lt;span style="font-weight:bold">if&lt;/span> wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>worker åœ¨æ”¶åˆ° &lt;code>kill&lt;/code> æ¶ˆæ¯æ—¶ï¼Œé¦–å…ˆè®¾ç½®è‡ªå·±çš„ &lt;code>@done&lt;/code> ä¸º &lt;code>true&lt;/code>ï¼Œæœ€åå‘ worker æ‰€å…³è”çš„çº¿ç¨‹æŠ›å‡º &lt;code>::Sidekiq::Shutdown&lt;/code> å¼‚å¸¸ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ worker çš„çº¿ç¨‹åˆæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L66-L77&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> !@done
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> process_one
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_stopped(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Sidekiq::Shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_stopped(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Exception =&amp;gt; ex
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_died(self, ex)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆå›åˆ° worker çš„ &lt;code>run&lt;/code> æ–¹æ³•è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°ï¼Œ&lt;code>run&lt;/code> æ–¹æ³•æ•æ‰äº† &lt;code>Sidekiq::Shutdown&lt;/code> å¼‚å¸¸ï¼Œå¹¶ä¸”åœ¨å¤„ç†å¼‚å¸¸æ—¶ï¼Œåªæ˜¯æ‰§è¡Œ &lt;code>@mgr.processor_stopped(self)&lt;/code>ï¼Œé€šçŸ¥ manager è‡ªå·±å·²ç»é€€å‡ºï¼Œç”±äºå·²ç»è·³å‡ºæ­£å¸¸æµç¨‹ï¼Œworker çš„ &lt;code>run&lt;/code> æ–¹æ³•è¿”å›ï¼Œçº¿ç¨‹ä¹Ÿå› æ­¤å¾—ä»¥é€€å‡ºã€‚è‡³æ­¤ï¼Œworker ä¹Ÿéƒ½æ­£å¸¸é€€å‡ºäº†ã€‚&lt;/p>
&lt;h4 id="å°ç»“-1">å°ç»“&lt;/h4>
&lt;ol>
&lt;li>launcher åœ¨æ‰§è¡Œé€€å‡ºæ—¶ï¼Œé¦–å…ˆæŒ‰ç…§ quiet çš„æµç¨‹å…ˆé€šçŸ¥å„ä¸ªçº¿ç¨‹å‡†å¤‡é€€å‡ºï¼›&lt;/li>
&lt;li>æ¥ç€ launcher å‘ manager ä¸‹è¾¾ &lt;code>stop&lt;/code> æŒ‡ä»¤ï¼Œå¹¶ä¸”ç»™å‡ºæœ€åæœŸé™ï¼ˆ&lt;code>deadline&lt;/code>ï¼‰ï¼›&lt;/li>
&lt;li>manager åœ¨ç»™å®šçš„é™æ—¶å†…ï¼Œå°½å¯èƒ½ç­‰å¾…æ‰€æœ‰ worker æ‰§è¡Œå®Œè‡ªå·±é€€å‡ºï¼Œå¯¹äºåˆ°è¾¾é™æ—¶ä»æœªé€€å‡ºçš„ workerï¼Œmanager å¤‡ä»½äº†æ¯ä¸ª worker çš„å½“å‰ä»»åŠ¡ï¼Œé‡æ–°åŠ å…¥é˜Ÿåˆ—ï¼Œç¡®ä¿ä»»åŠ¡è‡³å°‘å®Œæ•´æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åé€šè¿‡å‘çº¿ç¨‹æŠ›å‡ºå¼‚å¸¸çš„æ–¹å¼ï¼Œè¿«ä½¿ worker çš„çº¿ç¨‹è¢«åŠ¨é€€å‡ºã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;ol>
&lt;li>Sidekiq ç®€å•é«˜æ•ˆåˆ©ç”¨äº†ç³»ç»Ÿä¿¡å·ï¼Œå¹¶ä¸”æœ‰æ¯”è¾ƒæ¸…æ™°æ˜äº†çš„ä¿¡å·å¤„ç†è¿‡ç¨‹ï¼›&lt;/li>
&lt;li>Sidekiq åœ¨ä¿¡å·å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œå„ä¸ªç»„ä»¶åè°ƒå¾ˆæœ‰æ¡ç†ï¼Œæ¶ˆæ¯é€çº§ä¼ é€’ï¼Œè€Œä¸”å¯¹è¢«å¼ºåˆ¶åœæ­¢çš„ä»»åŠ¡ä¹Ÿæœ‰å¤‡ä»½æ–¹æ¡ˆï¼›&lt;/li>
&lt;li>æˆ‘ä»¬å¯ä»¥ä» Sidekiq çš„ç³»ç»Ÿä¿¡å·å¤„ç†æœºåˆ¶ä¸Šå€Ÿé‰´ä¸å°‘ä¸œè¥¿ï¼Œæ¯”å¦‚å¸¸ç”¨ç³»ç»Ÿä¿¡å·çš„åˆ†ç±»å¤„ç†ç­‰ï¼›&lt;/li>
&lt;li>å¯¹äºå¤šçº¿ç¨‹çš„æ§åˆ¶ï¼Œé€šè¿‡å…±äº«å˜é‡ä»¥åŠå¼‚å¸¸çš„æ–¹å¼åšåˆ° &lt;code>graceful&lt;/code> ä»¥åŠ &lt;code>hard&lt;/code> ä¸¤ç§æ–¹å¼çš„é€€å‡ºå¤„ç†ã€‚&lt;/li>
&lt;li>è¿˜æœ‰å¾ˆå¤šï¼Œä¸€ç™¾ä¸ªäººå¿ƒä¸­æœ‰ä¸€ç™¾ä¸ªå“ˆå§†è±ç‰¹ï¼ŒåŒæ ·ä¸€ä»½ä»£ç ï¼Œä¸åŒçš„äººå­¦ä¹ é˜…è¯»ï¼Œè‚¯å®šæ”¶è·ä¸åŒï¼Œä½ å¯ä»¥åœ¨è¯„è®ºåŒºç•™ä¸‹ä½ çš„æ„Ÿæ‚Ÿï¼Œè·Ÿçœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„äººä¸€èµ·åˆ†äº«ï¼&lt;/li>
&lt;/ol>
&lt;h3 id="é—®é¢˜æ€è€ƒ">é—®é¢˜æ€è€ƒ&lt;/h3>
&lt;ol>
&lt;li>ä¸ºäº†å°½å¯èƒ½ç¡®ä¿æ‰€æœ‰ Sidekiq çš„ä»»åŠ¡èƒ½å¤Ÿæ­£å¸¸ä¸»åŠ¨é€€å‡ºï¼Œæ‰€ä»¥åœ¨éƒ¨ç½²è„šæœ¬ä¸­ï¼Œéƒ½ä¼šå°½å¯èƒ½æ—©åœ°è®© Sidekiq è¿›å…¥ quiet æ¨¡å¼ï¼Œä½†æ˜¯ Sidekiq çš„ quiet æ˜¯ä¸å¯é€†çš„ï¼Œæ‰€ä»¥ä¸€æ—¦éƒ¨ç½²è„šæœ¬ä¸­é€”å¤±è´¥ï¼ŒSidekiq å¾—ä¸åˆ°é‡å¯ï¼Œå°†ä¼šä¸€ç›´ä¿æŒ quiet çŠ¶æ€ï¼Œå¦‚æœé•¿æ—¶é—´æœªé‡å¯ï¼Œä»»åŠ¡å°±ä¼šç§¯å‹ã€‚æ‰€ä»¥ï¼Œä¸€èˆ¬æˆ‘éƒ½ä¼šåœ¨éƒ¨ç½²è„šæœ¬ä¸­ï¼Œé¢å¤–æ•æ‰éƒ¨ç½²è„šæœ¬å¤±è´¥å¼‚å¸¸ï¼Œç„¶åä¸»åŠ¨æ‰§è¡Œ sidekiq çš„é‡å¯ã€‚&lt;strong>å¦‚æœä½ çš„éƒ¨ç½²è„šæœ¬ä¸­æœ‰æ¶‰åŠ Sidekiq çš„ï¼Œä¸€å®šè¦æ³¨æ„æ£€æŸ¥éƒ¨ç½²å¤±è´¥æ˜¯å¦ä¼šå½±å“ Sidekiq çš„çŠ¶æ€&lt;/strong>&lt;/li>
&lt;li>è™½ç„¶ Sidekiq åœ¨å¼ºåˆ¶é€€å‡ºå½“å‰é•¿æ—¶é—´æœªé€€å‡ºçš„ä»»åŠ¡æ—¶ï¼Œä¼šå°† job çš„æ•°æ®å†™å›é˜Ÿåˆ—ï¼Œç­‰å¾…é‡å¯åé‡æ–°æ‰§è¡Œï¼Œé‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„äº†ï¼Œå°±æ˜¯ä½ çš„ job å¿…é¡»æ˜¯å¹‚ç­‰çš„ï¼Œå¦åˆ™å°±ä¸èƒ½å…è®¸é‡æ–°æ‰§è¡Œäº†ã€‚æ‰€ä»¥ï¼Œè¯·æ³¨æ„ï¼Œ&lt;strong>å¦‚æœä½ æœ‰éœ€è¦é•¿æ—¶é—´è¿è¡Œçš„ jobï¼Œè¯·æ³¨æ„æ£€æŸ¥å…¶å¹‚ç­‰æ€§&lt;/strong>ã€‚&lt;/li>
&lt;/ol>
&lt;p>å¥½äº†ï¼Œä»Šå¤©å°±å†™åˆ°è¿™å§ï¼ä»ç„¶æŒºé•¿ä¸€ç¯‡ï¼Œå•°å—¦äº†ã€‚æ„Ÿè°¢çœ‹åˆ°è¿™é‡Œï¼&lt;/p></description></item><item><title>sidekiqä»»åŠ¡è°ƒåº¦æµç¨‹åˆ†æ</title><link>https://blog.hackerpie.com/posts/archive/sidekiqren-wu-diao-du-liu-cheng-fen-xi/</link><pubDate>Sat, 29 Oct 2016 16:32:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/sidekiqren-wu-diao-du-liu-cheng-fen-xi/</guid><description>&lt;p>&lt;a href="http://sidekiq.org/">sidekiq&lt;/a>æ˜¯ Ruby ä¸­ä¸€ä¸ªéå¸¸ä¼˜ç§€è€Œä¸”å¯é çš„åå°ä»»åŠ¡å¤„ç†è½¯ä»¶ï¼Œå…¶ä¾èµ– Redis å®ç°é˜Ÿåˆ—ä»»åŠ¡çš„å¢åŠ ã€é‡è¯•ä»¥åŠè°ƒåº¦ç­‰ã€‚è€Œ sidekiq ä»å¯åŠ¨åˆ°å¼€å§‹ä¸æ–­å¤„ç†ä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡ä»¥åŠå¤±è´¥ä»»åŠ¡çš„é‡è¯•ï¼Œéƒ½æ˜¯å¦‚ä½•è°ƒåº¦çš„å‘¢ï¼Ÿé‡åˆ°é—®é¢˜çš„æ—¶å€™ï¼Œåˆè¯¥å¦‚ä½•è°ƒä¼˜å‘¢ï¼Ÿ&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h3 id="æ³¨æ„">æ³¨æ„&lt;/h3>
&lt;ol>
&lt;li>ä»Šå¤©çš„åˆ†ææ‰€å‚è€ƒçš„ sidekiq çš„æºç å¯¹åº”ç‰ˆæœ¬æ˜¯ 4.2.3ï¼›&lt;/li>
&lt;li>ä»Šå¤©æ‰€è®¨è®ºçš„å†…å®¹ï¼Œå°†ä¸»è¦å›´ç»•ä»»åŠ¡è°ƒåº¦è¿‡ç¨‹è¿›è¡Œåˆ†æï¼Œæ— å…³ç»†èŠ‚å°†ä¸èµ˜è¿°ï¼Œå¦‚æœ‰éœ€è¦ï¼Œè¯·è‡ªè¡Œç¿»é˜… sidekiq æºç ï¼›&lt;/li>
&lt;li>æ–‡ç« å†…å®¹çœŸçš„å¾ˆé•¿ï¼Œè¯·åšå¥½å¿ƒç†å‡†å¤‡ã€‚&lt;br>
&lt;img src="https://ruby-china-files.b0.upaiyun.com/photo/2016/0fc8f347a4c7cba67066b2527bdb8f94.png!large" alt="">
&lt;/li>
&lt;/ol>
&lt;h3 id="ä½ å°†äº†è§£åˆ°ä»€ä¹ˆ">ä½ å°†äº†è§£åˆ°ä»€ä¹ˆï¼Ÿ&lt;/h3>
&lt;ol>
&lt;li>sidekiq çš„ä»»åŠ¡è°ƒåº¦æœºåˆ¶ï¼šå®šæ—¶ä»»åŠ¡ã€é‡è¯•ä»»åŠ¡çš„æ£€æŸ¥æœºåˆ¶ï¼Œé˜Ÿåˆ—ä»»åŠ¡çš„æ’é˜Ÿä»¥åŠé˜Ÿåˆ—æƒé‡å¯¹å¤„ç†ä¼˜å…ˆçº§çš„å½±å“ï¼›&lt;/li>
&lt;li>sidekiq çš„ä¸­é—´ä»¶æœºåˆ¶ä»¥åŠåœ¨æ­¤åŸºç¡€ä¸Šå®ç°çš„ä»»åŠ¡é‡è¯•æœºåˆ¶ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å…ˆæŠ›ç»“è®º">å…ˆæŠ›ç»“è®º&lt;/h2>
&lt;h3 id="æ—¶åºå›¾">æ—¶åºå›¾&lt;/h3>
&lt;p>å¯¹äºå¤æ‚çš„è°ƒç”¨å…³ç³»ï¼Œæˆ‘ä¹ æƒ¯ç”¨æ—¶åºå›¾å¸®åŠ©æˆ‘ç†è§£å…¶ä¸­å„éƒ¨åˆ†ä»£ç ä¹‹é—´ç›¸äº’åä½œçš„å…³ç³»ï¼ˆæ³¨æ„ï¼šä¸ºäº†é¿å…å¤ªå¤šç»†èŠ‚é€ æˆé˜…è¯»è´Ÿæ‹…ï¼Œæˆ‘å°†å‚æ•°ä¼ é€’ä»¥åŠè¿”å›å€¼ç­‰å†—æ‚è¿‡ç¨‹å»é™¤äº†ï¼Œåªä¿ç•™ä¸ä»»åŠ¡è°ƒåº¦ç›¸å…³çš„å…³é”®è°ƒç”¨ï¼‰ï¼š
![sidekiq ä»»åŠ¡è°ƒåº¦æ—¶åºå›¾](/images/medias/sidekiq job dispatcher.png)&lt;/p>
&lt;h3 id="äººè¯">äººè¯&lt;/h3>
&lt;p>Sidekiq æ•´ä¸ªä»»åŠ¡è°ƒåº¦è¿‡ç¨‹ä¸­ä¾èµ–å‡ ä¸ªä¸åŒè§’è‰²çš„ä»£ç å…±åŒåä½œï¼Œå…¶åˆ†å·¥å¦‚ä¸‹ï¼š
&lt;img src="https://ruby-china-files.b0.upaiyun.com/photo/2016/fe43bace416ba3bb7f7d77b397683bf4.png!large" alt="">
&lt;/p>
&lt;h2 id="æºç ä¹‹æ—…--å¯åŠ¨">æºç ä¹‹æ—… â€”â€” å¯åŠ¨&lt;/h2>
&lt;p>å½“æˆ‘ä»¬åœ¨æ‰§è¡Œ &lt;code>sidekiq&lt;/code> æ—¶ï¼Œæºç ä¸­çš„ &lt;code>bin/sidekiq.rb&lt;/code> æ–‡ä»¶ä¾¿æ˜¯ç¬¬ä¸€ä¸ªå¼€å§‹æ‰§è¡Œçš„æ–‡ä»¶ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹&lt;a href="https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/bin/sidekiq#L9-L12">é‡Œè¾¹çš„ä¸»è¦ä»£ç &lt;/a>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/bin/sidekiq#L9-L12&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cli = Sidekiq::CLI.instance
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cli.parse
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cli.run &lt;span style="font-style:italic"># &amp;lt;===== è¿™è¾¹èµ°&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç´§é  &lt;code>begin&lt;/code> åè¾¹çš„ä¸¤è¡Œä»£ç é¦–å…ˆåˆ›å»º &lt;code>Sidekiq::CLI&lt;/code> ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œæ¥ç€è°ƒç”¨å®ä¾‹æ–¹æ³• &lt;code>#parse&lt;/code> è§£æ sidekiq çš„é…ç½®å‚æ•°ï¼Œå…¶ä¸­åŒ…æ‹¬é˜Ÿåˆ—çš„é…ç½®ã€worker æ•°é‡çš„é…ç½®ç­‰ï¼Œåœ¨æ­¤ä¸å±•å¼€äº†ã€‚æ¥ç€å®ä¾‹æ–¹æ³• &lt;code>#run&lt;/code> å°†å¸¦ç€æˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ï¼Œè®©æˆ‘ä»¬ç»§ç»­çœ‹ &lt;code>lib/sidekiq/cli.rb&lt;/code> é‡Œè¾¹çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/cli.rb#L46-L106&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># è¿™é‡Œæ‰“å°æ§åˆ¶å°æ¬¢è¿ä¿¡æ¯ã€æ‰“å°æ—¥å¿—ä»¥åŠè¿è¡Œç¯å¢ƒï¼ˆä¸åŒ Rails ç‰ˆæœ¬ï¼‰åŠ è½½ç­‰&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> require &lt;span style="font-style:italic">&amp;#39;sidekiq/launcher&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @launcher = Sidekiq::Launcher.new(options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> launcher.run &lt;span style="font-style:italic"># &amp;lt;===== è¿™è¾¹èµ°&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># è¿›ç¨‹æ¥æ”¶åˆ°çš„ä¿¡å·å¤„ç†ä»¥åŠé€€å‡ºå¤„ç†&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä»£ç ä¸»è¦æ˜¯å®ä¾‹åŒ–äº†ä¸€ä¸ª &lt;code>Sidekiq::Launcher&lt;/code> çš„å¯¹è±¡ï¼Œç´§éšå…¶ååˆè°ƒç”¨äº†å®ä¾‹æ–¹æ³• &lt;code>#run&lt;/code>ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç»§ç»­é¡ºè—¤æ‘¸ç“œï¼Œçœ‹çœ‹ &lt;code>Sidekiq::Launcher#run&lt;/code> æ–¹æ³•åˆ°åº•åšäº†å“ªäº›äº‹æƒ…ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/launcher.rb#L24-L28&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread = safe_thread(&lt;span style="font-style:italic">&amp;#34;heartbeat&amp;#34;&lt;/span>, &amp;amp;method(&lt;span style="font-style:italic">:start_heartbeat&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @poller.start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @manager.start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>#run&lt;/code> æ–¹æ³•é¦–å…ˆé€šè¿‡ &lt;code>safe_thread&lt;/code> åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œçº¿ç¨‹ä¸»è¦è´Ÿè´£æ‰§è¡Œ &lt;code>start_heartbeat&lt;/code> æ–¹æ³•çš„ä»£ç ï¼Œä»æ–¹æ³•åç§°ä¸Šï¼Œæˆ‘ä»¬çŒœæµ‹å…¶ä¸»è¦æ˜¯å¿ƒè·³ä»£ç ï¼Œè´Ÿè´£å®šæ—¶æ£€æŸ¥ sidekiq å¥åº·çŠ¶æ€ï¼Œè·Ÿä¹‹å‰ä¸€æ ·ï¼Œè¿™é‡Œä¸å¾€ä¸‹æŒ–ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹åè¾¹çš„ä¸¤è¡Œä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>@poller.start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@manager.start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„ &lt;code>@poller&lt;/code> è·Ÿ &lt;code>@manager&lt;/code> éƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬å›å¤´çœ‹ä¸€ä¸‹ï¼Œå‰é¢è®²åˆ° &lt;code>lib/cli.rb&lt;/code> çš„ &lt;code>#run&lt;/code> æ–¹æ³•ä¼šè´Ÿè´£åˆ›å»º &lt;code>Sidekiq::Launcher&lt;/code> çš„å®ä¾‹ï¼Œé‚£è®©æˆ‘ä»¬çœ‹ä¸‹åè€…çš„ &lt;code>initialize&lt;/code> æ–¹æ³•å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/launcher.rb#L17-L22&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> initialize(options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @manager = Sidekiq::Manager.new(options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @poller = Sidekiq::Scheduled::Poller.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @done = &lt;span style="">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @options = options
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä¸Šï¼Œ&lt;code>@manager&lt;/code>æ˜¯åœ¨åˆ›å»º &lt;code>Sidekiq::Launcher&lt;/code> å®ä¾‹çš„è¿‡ç¨‹ä¸­åŒæ­¥åˆ›å»ºçš„ &lt;code>Sidekiq::Manager&lt;/code> çš„å®ä¾‹ï¼ŒåŒç†ï¼Œ&lt;code>@poller&lt;/code> æ˜¯åŒæ­¥åˆ›å»ºçš„ &lt;code>Sidekiq::Scheduled::Poller&lt;/code>çš„å®ä¾‹ã€‚é‚£æˆ‘ä»¬æŒ‰ç…§ä»£ç æ‰§è¡Œé¡ºåºï¼Œå…ˆçœ‹ä¸‹ &lt;code>@poller.start&lt;/code> ä¹Ÿå°±æ˜¯ &lt;code>Sidekiq::Scheduled::Poller#start&lt;/code> æ–¹æ³•çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L63-L73&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread ||= safe_thread(&lt;span style="font-style:italic">&amp;#34;scheduler&amp;#34;&lt;/span>) &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> initial_wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> !@done
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> enqueue
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.info(&lt;span style="font-style:italic">&amp;#34;Scheduler exiting...&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçœ‹åˆ°ï¼Œ&lt;code>#start&lt;/code>æ–¹æ³•ä¹Ÿåˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹é‡Œæ‰§è¡Œäº†ä¸¤ä¸ªéƒ¨åˆ†ä»£ç ï¼š1. åˆå§‹åŒ–ç­‰å¾…ï¼›2. å¾ªç¯é‡Œçš„ &lt;code>enqueue&lt;/code> ä¸ &lt;code>wait&lt;/code>ã€‚è¿™éƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ&lt;/p>
&lt;p>&lt;strong>æ³¨æ„&lt;/strong>: &lt;code>#start&lt;/code> æ–¹æ³•åœ¨çº¿ç¨‹åˆ›å»ºå®Œæˆåå°±ç«‹åˆ»è¿”å›äº†ï¼Œè‡³äº &lt;code>#start&lt;/code> æ–¹æ³•é‡Œçš„é€»è¾‘ï¼Œè¯·ç§»æ­¥åé¢ç« èŠ‚â€œç»§ç»­æ·±æŒ– Sidekiq::Scheduled::Poller#startâ€ä½œæ›´æ·±ä¸€æ­¥åˆ†æã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆç»§ç»­æ¥ç€çœ‹çœ‹ &lt;code>#start&lt;/code> æ–¹æ³•è¿”å›åæ¥ä¸‹æ¥æ‰§è¡Œçš„ &lt;code>@manager.start&lt;/code> æ–¹æ³•åˆåšäº†ä»€ä¹ˆï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/manager.rb#L45-L49&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @workers.each &lt;span style="font-weight:bold">do&lt;/span> |x|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x.start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„ &lt;code>@workers&lt;/code> åˆæ˜¯ä»€ä¹ˆï¼Ÿä¸€ä¸ªæ•°ç»„ï¼Ÿæ€æ ·çš„æ•°ç»„ï¼Ÿæˆ‘ä»¬å›é¡¾ä¸‹ï¼Œå‰é¢è¯´åœ¨åˆ›å»º &lt;code>Sidekiq::Launcher&lt;/code> å®ä¾‹çš„è¿‡ç¨‹ä¸­åŒæ­¥åˆ›å»ºäº† &lt;code>Sidekiq::Manager&lt;/code> çš„å®ä¾‹ï¼Œè®©æˆ‘ä»¬å°±çœ‹çœ‹ &lt;code>Sidekiq::Manager&lt;/code> çš„ &lt;code>#initialize&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/manager.rb#L31-L43&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> initialize(options={})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.debug { options.inspect }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @options = options
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @count = options[&lt;span style="font-style:italic">:concurrency&lt;/span>] || 25
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span> ArgumentError, &lt;span style="font-style:italic">&amp;#34;Concurrency of &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>@count&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> is not supported&amp;#34;&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> @count &amp;lt; 1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @done = &lt;span style="">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @workers = Set.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @count.times &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @workers &amp;lt;&amp;lt; Processor.new(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @plock = Mutex.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åˆ›å»ºäº† &lt;code>Sidekiq::Manager&lt;/code> çš„å®ä¾‹ä¹‹åï¼ŒåˆåŒæ­¥åˆ›å»ºäº†å¤šä¸ª &lt;code>Sidekiq::Processor&lt;/code> çš„å®ä¾‹ï¼Œå®ä¾‹çš„ä¸ªæ•°å–å†³äº &lt;code>options[:concurrency] || 25&lt;/code>ï¼Œä¹Ÿå°±æ˜¯é…ç½®çš„ &lt;code>:concurrency&lt;/code> çš„å€¼ï¼Œç¼ºçœå€¼ä¸º &lt;code>25&lt;/code>ã€‚è‡³æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œsidekiq ä¸­çš„ worker çš„æ•°é‡å°±æ˜¯åœ¨æ­¤å…¶ä½œç”¨çš„ï¼Œ&lt;code>Sidekiq::Manager&lt;/code> æŒ‰ç…§é…ç½®çš„æ•°é‡åˆ›å»ºæŒ‡å®šæ•°é‡çš„ workerã€‚
å¾€å›çœ‹åˆšæ‰çš„ &lt;code>#start&lt;/code> æ–¹æ³•ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/manager.rb#L46-L48&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@workers.each &lt;span style="font-weight:bold">do&lt;/span> |x|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> x.start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç®€è¨€ä¹‹ï¼Œå°±æ˜¯ &lt;code>Sidekiq::Manager&lt;/code> åœ¨ &lt;code>start&lt;/code> çš„æ—¶å€™åªåšä¸€ä»¶äº‹ï¼šåˆ†åˆ«è°ƒç”¨å…¶ç®¡ç†çš„æ‰€æœ‰ worker çš„ &lt;code>#start&lt;/code> æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ &lt;code>Sidekiq::Processor#start&lt;/code>ã€‚ç»§ç»­å¾€ä¸‹èµ°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L60-L62&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread ||= safe_thread(&lt;span style="font-style:italic">&amp;#34;processor&amp;#34;&lt;/span>, &amp;amp;method(&lt;span style="font-style:italic">:run&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆæ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ &lt;code>safe_thread&lt;/code> æ–¹æ³•ï¼ŒåŒæ ·æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæ„å‘³ç€æ¯ä¸€ä¸ª worker éƒ½æ˜¯åŸºäºè‡ªå·±çš„ä¸€ä¸ªæ–°çº¿ç¨‹çš„ï¼Œè€Œè¿™ä¸ªçº¿ç¨‹é‡Œæ‰§è¡Œçš„ä»£ç æ˜¯ç§æœ‰æ–¹æ³• &lt;code>#run&lt;/code> é‡Œçš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L66-L77&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> run
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> !@done
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> process_one
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_stopped(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Sidekiq::Shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_stopped(self)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Exception =&amp;gt; ex
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @mgr.processor_died(self, ex)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥å‘ç°ï¼Œåˆæ˜¯ä¸€ä¸ª while å¾ªç¯ï¼è€Œè¿™ä¸ªå¾ªç¯ä½“é‡Œåªè°ƒç”¨äº†ä¸€ä¸ª &lt;code>#process_one&lt;/code> å®ä¾‹æ–¹æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™é‡Œæ˜¯è¯´æ¯ä¸ª worker åœ¨æ²¡è¢«ç»“æŸä¹‹å‰ï¼Œéƒ½é‡å¤æ¯æ¬¡å¤„ç†ä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼Œé‚£è¿™ä¸ª &lt;code>#process_one&lt;/code> é‡Œåˆåšäº†ä»€ä¹ˆå‘¢ï¼Ÿæ€ä¹ˆå†³å®šè¯¥å…ˆåšå“ªä¸ªä»»åŠ¡å‘¢ï¼Ÿåˆ«æ€¥ï¼Œè¯·çœ‹åé¢ç« èŠ‚â€œç»§ç»­æ·±æŒ– Sidekiq::Processor#process_oneâ€ã€‚&lt;/p>
&lt;h3 id="å°ç»“">å°ç»“&lt;/h3>
&lt;p>sidekiq åœ¨å¯åŠ¨åï¼ˆæ­¤å¤„å¯å€Ÿæ–‡ç« å¼€å¤´çš„æ—¶åºå›¾è¾…åŠ©ç†è§£ï¼‰ï¼š&lt;/p>
&lt;ol>
&lt;li>é¦–å…ˆåˆ›å»ºäº† &lt;code>Sidekiq::CLI&lt;/code> çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶ &lt;code>run&lt;/code> æ–¹æ³•ï¼›&lt;/li>
&lt;li>&lt;code>Sidekiq::CLI&lt;/code> çš„å®ä¾‹åœ¨ &lt;code>#run&lt;/code> çš„è¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºäº† &lt;code>Sidekiq::Launcher&lt;/code> çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶ &lt;code>run&lt;/code> æ–¹æ³•ï¼›&lt;/li>
&lt;li>&lt;code>Sidekiq::Launcher&lt;/code> çš„å®ä¾‹åœ¨åˆ›å»ºåï¼ŒåŒæ­¥åˆ›å»ºäº†ä¸€ä¸ª &lt;code>Sidekiq::Scheduled::Poller&lt;/code> çš„å®ä¾‹ä»¥åŠ &lt;code>Sidekiq::Manager&lt;/code> çš„å®ä¾‹ï¼Œè€Œåœ¨å…¶æ‰§è¡Œ &lt;code>#run&lt;/code> çš„è¿‡ç¨‹ä¸­ï¼Œåˆ™åˆ†åˆ«è°ƒç”¨äº†è¿™ä¸¤ä¸ªå®ä¾‹çš„ &lt;code>start&lt;/code> æ–¹æ³•ï¼›&lt;/li>
&lt;li>&lt;code>Sidekiq::Scheduled::Poller&lt;/code> çš„å®ä¾‹åœ¨æ‰§è¡Œ &lt;code>start&lt;/code> è¿‡ç¨‹ä¸­ï¼Œåˆ›å»ºäº†ä¸€ä¸ªå†…éƒ¨å¾ªç¯æ‰§è¡Œçš„çº¿ç¨‹ï¼Œå‘¨è€Œå¤å§‹åœ°æ‰§è¡Œ &lt;code>enqueue&lt;/code> -&amp;gt; &lt;code>wait&lt;/code>ï¼›&lt;/li>
&lt;li>&lt;code>Sidekiq::Manager&lt;/code> çš„å®ä¾‹åœ¨åˆ›å»ºåï¼ŒåŒæ­¥åˆ›å»ºè‹¥å¹²ä¸ªæŒ‡å®šçš„ workerï¼Œä¹Ÿå°±æ˜¯ &lt;code>Sidekiq::Processor&lt;/code> çš„å®ä¾‹ï¼Œå¹¶åœ¨æ‰§è¡Œ &lt;code>start&lt;/code> æ–¹æ³•çš„è¿‡ç¨‹ä¸­å¯¹æ¯ä¸€ä¸ª worker å‘èµ· &lt;code>start&lt;/code> è°ƒç”¨ï¼›&lt;/li>
&lt;li>&lt;code>Sidekiq::Processor&lt;/code> å®ä¾‹åœ¨æ‰§è¡Œ &lt;code>start&lt;/code> æ–¹æ³•çš„è¿‡ç¨‹ä¸­åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œæ–°çš„çº¿ç¨‹é‡ŒåŒæ ·æœ‰ä¸€ä¸ª &lt;code>while&lt;/code> å¾ªç¯ï¼Œåå¤æ‰§è¡Œ &lt;code>process_one&lt;/code>ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šå°±æ˜¯ Sidekiq çš„ä¸»è¦å¯åŠ¨è¿‡ç¨‹ï¼Œä»¥ä¸‹åˆ†åˆ«é’ˆå¯¹ &lt;code>Sidekiq::Scheduled::Poller&lt;/code> ä»¥åŠ &lt;code>Sidekiq::Manager&lt;/code> å±•å¼€æºç åˆ†æã€‚&lt;/p>
&lt;h2 id="å®šæ—¶ä»»åŠ¡æ‹‰å–å™¨çš„å·¥ä½œ-sidekiqscheduledpollerstart">å®šæ—¶ä»»åŠ¡æ‹‰å–å™¨çš„å·¥ä½œ Sidekiq::Scheduled::Poller#start&lt;/h2>
&lt;p>ç»è¿‡å‰é¢è¾ƒè¡¨å±‚çš„ä»£ç åˆ†æï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ç»§ç»­å±•å¼€ &lt;code>Sidekiq::Scheduled::Poller#start&lt;/code> æ–¹æ³•çš„æ¢ç´¢ä¹‹æ—…ï¼Œé¦–å…ˆé‡æ¸©ä¸‹å…¶ä»£ç å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L63-L73&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> start
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @thread ||= safe_thread(&lt;span style="font-style:italic">&amp;#34;scheduler&amp;#34;&lt;/span>) &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> initial_wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> !@done
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> enqueue
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.logger.info(&lt;span style="font-style:italic">&amp;#34;Scheduler exiting...&amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œ&lt;code>#start&lt;/code> æ–¹æ³•çš„æ ¸å¿ƒå°±æ˜¯ä¸­é—´çš„ &lt;code>while&lt;/code> å¾ªç¯ï¼Œåœ¨å¾ªç¯å‰é¢ï¼Œæ‰§è¡Œäº† &lt;code>#initial_wait&lt;/code> æ–¹æ³•ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹è¿™ä¸ªæ–¹æ³•åˆ°åº•æ˜¯å¹²äº›ä»€ä¹ˆçš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L133-L143&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> initial_wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Have all processes sleep between 5-15 seconds. 10 seconds&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># to give time for the heartbeat to register (if the poll interval is going to be calculated by the number&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># of workers), and 5 random seconds to ensure they don&amp;#39;t all hit Redis at the same time.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> total = 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> total += INITIAL_WAIT &lt;span style="font-weight:bold">unless&lt;/span> Sidekiq.options[&lt;span style="font-style:italic">:poll_interval_average&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> total += (5 * rand)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @sleeper.pop(total)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">rescue&lt;/span> Timeout::Error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“åˆæ³¨é‡Šç†è§£ï¼ŒåŸæ¥ç§æœ‰æ–¹æ³• &lt;code>#initial_wait&lt;/code> åªæ˜¯ä¸ºäº†é¿å…æ‰€æœ‰è¿›ç¨‹åœ¨åç»­é€»è¾‘ä¸­åŒæ—¶è§¦å‘ Redis IO è€Œåšçš„è®¾è®¡ï¼Œå¦‚æœå¯¹å¤§å‹ç³»ç»Ÿæœ‰è¿‡æ¶æ„ç»éªŒçš„ç«¥é‹å°±ä¼šæ˜ç™½ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯ä¸ºäº†é˜²æ­¢ç±»ä¼¼é›ªå´©ä¹‹ç±»çš„ç³»ç»Ÿæ•…éšœå‡ºç°ã€‚è®©å½“å‰è¿›ç¨‹éšæœºç­‰å¾…ä¸€å®šèŒƒå›´çš„æ—¶é—´ï¼Œä»è€Œå°±å¯ä»¥è·Ÿå…¶ä»–è¿›ç¨‹é”™å¼€äº†ã€‚&lt;/p>
&lt;p>åœ¨ç†è§£å®Œ &lt;code>initial_wait&lt;/code> ä¹‹åï¼Œæˆ‘ä»¬æ¥ç€çœ‹åˆ°å¾ªç¯ä½“é‡Œçš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L68-L69&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>enqueue
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>wait
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>enqueue&lt;/code>ï¼Ÿå¹²å˜›å‘¢ï¼Ÿä¸ºä»€ä¹ˆæ˜¯å…¥é˜Ÿåˆ—å‘¢ï¼Ÿå¸¦ç€ç–‘é—®å¾€ä¸‹çœ‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L75-L86&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> enqueue
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @enq.enqueue_jobs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> =&amp;gt; ex
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçœ‹åˆ° &lt;code>#enqueue&lt;/code> ä»£ç éå¸¸ç®€å•ï¼Œåªæ˜¯è°ƒç”¨äº†å®ä¾‹å˜é‡ &lt;code>@enq&lt;/code> çš„ &lt;code>#enqueue_jobs&lt;/code> æ–¹æ³•è€Œå·²ï¼Œé‚£ä¹ˆï¼Œ&lt;code>@enq&lt;/code> æ˜¯ä»€ä¹ˆç±»å‹çš„å®ä¾‹å‘¢ï¼Ÿå®ƒçš„ &lt;code>#enqueue_jobs&lt;/code> æ–¹æ³•åˆåšäº†ä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹ä¸€é &lt;code>Sidekiq::Scheduled::Poller&lt;/code> çš„ &lt;code>#initialize&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L45-L50&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> initialize
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @enq = (Sidekiq.options[&lt;span style="font-style:italic">:scheduled_enq&lt;/span>] || Sidekiq::Scheduled::Enq).new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @sleeper = ConnectionPool::TimedStack.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŸæ¥ç¼ºçœæƒ…å†µä¸‹ï¼Œ&lt;code>@enq&lt;/code> å°±æ˜¯ &lt;code>Sidekiq::Scheduled::Enq&lt;/code> çš„å®ä¾‹ã€‚è€Œä»£ç ä¸Šçœ‹çš„è¯ï¼Œsidekiq æ”¯æŒç”¨æˆ·é€šè¿‡ &lt;code>:scheduled_enq&lt;/code> é…ç½®é¡¹è‡ªå®šä¹‰ &lt;code>@enq&lt;/code> çš„ç±»å‹ï¼Œä½†æ˜¯å®˜æ–¹æ–‡æ¡£æœªå¯¹æ­¤å‚æ•°æåŠä»¥åŠè¯´æ˜ï¼Œè¿™é‡Œå…¶å®æ˜¯ä¸€ç§ç­–ç•¥æ¨¡å¼çš„å®ç°ï¼Œç”¨æˆ·è‡ªå®šä¹‰çš„ç±»å‹å¿…é¡»å®ç° &lt;code>enqueue_jobs&lt;/code> æ–¹æ³•ã€‚æˆ‘ä¼°è®¡ï¼Œæ˜¯ sidekiq pro é‡Œè¾¹æ‰ä¼šç”¨åˆ°çš„é…ç½®é¡¹å§ã€‚&lt;/p>
&lt;p>çŸ¥é“äº† &lt;code>@enq&lt;/code> çš„ç±»å‹åï¼Œè®©æˆ‘ä»¬ç»§ç»­çœ‹ä¸‹ &lt;code>Sidekiq::Scheduled::Enq#enqueue_jobs&lt;/code> æ–¹æ³•çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L11-L33&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> enqueue_jobs(now=Time.now.to_f.to_s, sorted_sets=SETS)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># A job&amp;#39;s &amp;#34;score&amp;#34; in Redis is the time at which it should be processed.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Just check Redis for the set of jobs with a timestamp before now.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.redis &lt;span style="font-weight:bold">do&lt;/span> |conn|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sorted_sets.each &lt;span style="font-weight:bold">do&lt;/span> |sorted_set|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Get the next item in the queue if it&amp;#39;s score (time to execute) is &amp;lt;= now.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># We need to go through the list one at a time to reduce the risk of something&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># going wrong between the time jobs are popped from the scheduled queue and when&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># they are pushed onto a work queue and losing the jobs.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> job = conn.zrangebyscore(sorted_set, &lt;span style="font-style:italic">&amp;#39;-inf&amp;#39;&lt;/span>.freeze, now, &lt;span style="font-style:italic">:limit&lt;/span> =&amp;gt; [0, 1]).first &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Pop item off the queue and add it to the work queue. If the job can&amp;#39;t be popped from&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># the queue, it&amp;#39;s because another process already popped it so we can move on to the&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># next one.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> conn.zrem(sorted_set, job)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq::Client.push(Sidekiq.load_json(job))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq::Logging.logger.debug { &lt;span style="font-style:italic">&amp;#34;enqueued &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>sorted_set&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">: &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>job&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶å®è¿™é‡Œè¿™ä¸ªæ–¹æ³•çš„å¯“æ„ï¼Œé€šè¿‡ä»£ç é‡Œçš„æ³¨é‡Šéƒ½å·²ç»å¾ˆæ˜æ™°äº†ï¼Œä¸è¿‡æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰å‡ ä¸ªç‚¹éœ€è¦å¼ºè°ƒä¸‹ã€‚
é¦–å…ˆï¼Œåœ¨æ— å‚æ•°è°ƒç”¨ &lt;code>#enqueue_jobs&lt;/code> æ–¹æ³•æ—¶ï¼Œå®šä¹‰ä¸­çš„å‚æ•° &lt;code>now&lt;/code> ç¼ºçœä¸ºå½“å‰æ—¶é—´ï¼Œè€Œ &lt;code>sorted_sets&lt;/code> ç¼ºçœä¸º &lt;code>Sidekiq::Scheduled::SETS&lt;/code> çš„å€¼ï¼Œå…¶å€¼å®šä¹‰ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L8&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SETS = &lt;span style="font-style:italic">%w(retry schedule)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯æ•°ç»„ &lt;code>[&amp;quot;retry&amp;quot;, &amp;quot;schedule&amp;quot;]&lt;/code>ï¼Œè€Œè¿™ä¸¤ä¸ªé˜Ÿåˆ—åç§°æ‰€å¯¹åº”çš„é˜Ÿåˆ—å°±æ˜¯ sidekiq çš„é‡è¯•ä»¥åŠå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ï¼Œåœ¨ sidekiq é‡Œè¾¹ï¼Œé‡è¯•ä»»åŠ¡ä»¥åŠå®šæ—¶ä»»åŠ¡æœ¬è´¨ä¸Šéƒ½æ˜¯ scheduled jobsï¼Œè¿™ä¸¤ä¸ªé˜Ÿåˆ—ä½¿ç”¨äº†ç‰¹æ®Šçš„ Redis çš„æ•°æ®ç»“æ„ï¼Œè¿›å…¥é˜Ÿåˆ—çš„ä»»åŠ¡ä»¥å…¶æ‰§è¡Œæ—¶é—´ä½œä¸ºæ•°æ®çš„ scoreï¼Œå†™å…¥ Redis ä¹‹åæŒ‰ç…§ score æ’åºï¼Œä¹Ÿå°±æ˜¯æŒ‰ä»»åŠ¡çš„è®¡åˆ’æ—¶é—´æ’åºã€‚&lt;/p>
&lt;p>æ¥ç€å¾€ä¸‹çœ‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L14-L30&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Sidekiq.redis &lt;span style="font-weight:bold">do&lt;/span> |conn|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sorted_sets.each &lt;span style="font-weight:bold">do&lt;/span> |sorted_set|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">while&lt;/span> job = conn.zrangebyscore(sorted_set, &lt;span style="font-style:italic">&amp;#39;-inf&amp;#39;&lt;/span>.freeze, now, &lt;span style="font-style:italic">:limit&lt;/span> =&amp;gt; [0, 1]).first &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> conn.zrem(sorted_set, job)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq::Client.push(Sidekiq.load_json(job))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq::Logging.logger.debug { &lt;span style="font-style:italic">&amp;#34;enqueued &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>sorted_set&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">: &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>job&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œsidekiq åˆ†åˆ«é’ˆå¯¹ &lt;code>&amp;quot;retry&amp;quot;&lt;/code> å’Œ &lt;code>&amp;quot;schedule&amp;quot;&lt;/code> é˜Ÿåˆ—åšäº†ä¸€ä¸ªå¾ªç¯ï¼Œå¾ªç¯ä½“é‡Œæ¯æ¬¡é€šè¿‡ Redis çš„ &lt;a href="http://redis.io/commands/ZRANGEBYSCORE">&lt;code>ZRANGEBYSCORE&lt;/code>&lt;/a>å‘½ä»¤å–å‡ºä¸€ä¸ªè®¡åˆ’æ—¶é—´å°äºç­‰äºå½“å‰æ—¶é—´çš„ä»»åŠ¡ï¼Œå¹¶ä¸”è°ƒç”¨ &lt;code>Sidekiq::Client&lt;/code> çš„ &lt;code>.push&lt;/code> æ–¹æ³•å°†æ­¤ä»»åŠ¡åŠ åˆ°æŒ‡å®šé˜Ÿåˆ—ä¸­ï¼ˆjob ä¸­åŒ…å«é˜Ÿåˆ—åç§°ç­‰ä¿¡æ¯ï¼Œåœ¨æ­¤ä¸å±•å¼€ï¼Œæœ‰å…´è¶£çš„åŒå­¦è¯·è‡ªè¡Œé˜…è¯» &lt;code>Sidekiq::Client&lt;/code> çš„ä»£ç ï¼‰ã€‚&lt;/p>
&lt;p>è‡³æ­¤ï¼Œå¯ä»¥æ˜ç™½ï¼Œ&lt;code>enqueue_jobs&lt;/code> å°±æ˜¯åˆ†åˆ«ä» &lt;code>&amp;quot;retry&amp;quot;&lt;/code> å’Œ &lt;code>&amp;quot;schedule&amp;quot;&lt;/code> é˜Ÿåˆ—ä¸­å–å‡ºå·²ç»åˆ°è¾¾è®¡åˆ’æ—¶é—´çš„ä»»åŠ¡ï¼Œå°†å…¶ä¸€ä¸€åŠ å…¥åŸæ¥é˜Ÿåˆ—ã€‚æ³¨æ„ï¼Œå®šæ—¶ä»»åŠ¡ä»¥åŠé‡è¯•ä»»åŠ¡çš„è®¡åˆ’æ—¶é—´åªæ˜¯è®¡åˆ’åŠ è¿›æ‰§è¡Œä¸­é˜Ÿåˆ—çš„æ—¶é—´ï¼Œå¹¶éæ‰§è¡Œæ—¶é—´ï¼Œæ‰§è¡Œçš„æ—¶é—´å°±åªèƒ½å–å†³äºé˜Ÿåˆ—çš„é•¿åº¦ä»¥åŠé˜Ÿåˆ—æ‰§è¡Œé€Ÿåº¦äº†ã€‚&lt;/p>
&lt;p>æ¥ç€å¾€å›ç‚¹ï¼Œç»§ç»­çœ‹ &lt;code>enqueue_jobs&lt;/code> ä¹‹åçš„ &lt;code>wait&lt;/code> æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L90-L100&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> wait
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @sleeper.pop(random_poll_interval)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">rescue&lt;/span> Timeout::Error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># expected&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">rescue&lt;/span> =&amp;gt; ex
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„ &lt;code>wait&lt;/code> æ–¹æ³•åªæ˜¯åšä¸€ä¸ªä¼‘çœ ï¼Œä¼‘çœ çš„å®ç°ä¾èµ–äº &lt;code>@sleeper&lt;/code> çš„ &lt;code>#pop&lt;/code> æ–¹æ³•è°ƒç”¨ï¼Œå›é¡¾ &lt;code>Sidekiq::Scheduled::Poller&lt;/code> çš„ &lt;code>#initialize&lt;/code> æ–¹æ³•çš„å®ç°å¯ä»¥ç¡®è®¤ &lt;code>@sleeper&lt;/code> æ˜¯ &lt;code>ConnectionPool::TimedStack&lt;/code> çš„å®ä¾‹ï¼Œè€Œåè€…æ˜¯ Ruby gem &lt;a href="https://github.com/mperham/connection_pool/blob/master/lib/connection_pool/timed_stack.rb">connection_pool&lt;/a> é‡Œçš„å®ç°ï¼Œå…¶ &lt;code>pop&lt;/code> æ–¹æ³•ä¼šé˜»å¡å½“å‰ä»£ç çš„æ‰§è¡Œï¼Œç›´åˆ°æœ‰å€¼è¿”å›æˆ–è€…åˆ°è¾¾æŒ‡å®šçš„è¶…æ—¶æ—¶é—´ï¼Œè¿™é‡Œ sidekiq åˆ©ç”¨äº†å…¶é˜»å¡çš„ç‰¹æ€§ï¼Œä½œä¸º &lt;code>wait&lt;/code> æ–¹æ³•ä¼‘çœ å™¨çš„å®ç°ã€‚&lt;/p>
&lt;p>è€Œä»£ç é‡Œçš„ä¼‘çœ æ—¶é—´åˆ™ä¸æ˜¯å›ºå®šçš„ï¼Œä¾èµ– &lt;code>#random_poll_interval&lt;/code> æ–¹æ³•çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L103-L105&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Calculates a random interval that is Â±50% the desired average.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> random_poll_interval
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> poll_interval_average * rand + poll_interval_average.to_f / 2
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶å®ç°ä¾èµ–ä¸€ä¸ª &lt;code>#poll_interval_average&lt;/code> æ–¹æ³•çš„è¿”å›å€¼ï¼Œé¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ–¹æ³•å°†å†³å®šå®šæ—¶ä»»åŠ¡å®šæœŸæ£€æŸ¥çš„å¹³å‡æ—¶é—´å‘¨æœŸã€‚è®©æˆ‘ä»¬ç»§ç»­æ·±æŒ–ä¸‹å»ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L107-L122&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># We do our best to tune the poll interval to the size of the active Sidekiq&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># cluster. If you have 30 processes and poll every 15 seconds, that means one&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Sidekiq is checking Redis every 0.5 seconds - way too often for most people&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># and really bad if the retry or scheduled sets are large.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Instead try to avoid polling more than once every 15 seconds. If you have&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># 30 Sidekiq processes, we&amp;#39;ll poll every 30 * 15 or 450 seconds.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># To keep things statistically random, we&amp;#39;ll sleep a random amount between&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># 225 and 675 seconds for each poll or 450 seconds on average. Otherwise restarting&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># all your Sidekiq processes at the same time will lead to them all polling at&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># the same time: the thundering herd problem.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># We only do this if poll_interval_average is unset (the default).&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> poll_interval_average
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.options[&lt;span style="font-style:italic">:poll_interval_average&lt;/span>] ||= scaled_poll_interval
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªæ–¹æ³•çš„é‡è¦æ€§é€šè¿‡å…¶å‡ å€äºä»£ç çš„æ³¨é‡Šå°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œå¤§æ¦‚æ„æ€æ˜¯ï¼Œsidekiq ä¸ºäº†é¿å…åœ¨è¿›ç¨‹é‡å¯åï¼Œæœ‰å¤§é‡çš„è¿›ç¨‹åŒæ—¶å¯†é›†åœ°è®¿é—® redisï¼Œæ‰€ä»¥è®¾è®¡äº†è¿™ä¸ªæœºåˆ¶ï¼Œå°±æ˜¯æ¯ä¸ªè¿›ç¨‹å¯¹å®šæ—¶ä»»åŠ¡çš„æ£€æŸ¥éƒ½æ˜¯æŒ‰ç…§ä¸€ä¸ªå…¬å¼æ¥è®¡ç®—çš„ï¼Œä¿è¯æ¯ä¸ªè¿›ç¨‹ä¸¤æ¬¡æ£€æŸ¥ä¹‹é—´çš„å¹³å‡ä¼‘çœ æ—¶é—´èƒ½å¤Ÿåœ¨ä¸€ä¸ªèŒƒå›´å†…åŠ¨æ€å˜åŒ–ï¼Œä»è€Œå°†æ‰€æœ‰è¿›ç¨‹çš„ Redis IO å‡åŒ€é”™å¼€ã€‚
ä»ä»£ç ä¸Šçœ‹ï¼Œsidekiq çš„è¿™ä¸ªå¹³å‡æ‹‰å–æ—¶é—´æ”¯æŒé…ç½®é¡¹é…ç½®ï¼Œä½†æ˜¯ç›®å‰ä¹Ÿå¹¶æ²¡æœ‰åœ¨ wiki ä¸Šæœ‰æ‰€æåŠã€‚è€Œç¼ºçœæƒ…å†µä¸‹ï¼Œå…¶å€¼ç”±æ–¹æ³• &lt;code>#scaled_poll_interval&lt;/code> å†³å®šï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/scheduled.rb#L124-L131&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> scaled_poll_interval
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pcount = Sidekiq::ProcessSet.new.size
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pcount = 1 &lt;span style="font-weight:bold">if&lt;/span> pcount == 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pcount * Sidekiq.options[&lt;span style="font-style:italic">:average_scheduled_poll_interval&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ­£å¦‚å‰é¢ä¸€æ®µä»£ç çš„æ³¨é‡Šæ‰€è¯´ï¼Œç¼ºçœæƒ…å†µä¸‹ï¼Œsidekiq è®¤ä¸ºå®šæ—¶ä»»åŠ¡æ‹‰å–å™¨çš„å¹³å‡ä¼‘çœ æ—¶é—´æ­£æ˜¯ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>sidekiq è¿›ç¨‹æ•°é‡ x å¹³å‡æ‹‰å–æ—¶é—´ average_scheduled_poll_interval
&lt;/code>&lt;/pre>&lt;p>è€Œ &lt;code>:average_scheduled_poll_interval&lt;/code> çš„ç¼ºçœé…ç½®æ˜¯ 15 ç§’ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/master/lib/sidekiq.rb#L25&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>DEFAULTS = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">average_scheduled_poll_interval&lt;/span>: 15,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€ä»¥å›è¿‡å¤´æ¥ï¼Œåœ¨æ²¡æœ‰ç›¸å…³è‡ªå®šä¹‰é…ç½®çš„æƒ…å†µä¸‹ï¼Œå‡è®¾ä½ åªå¼€å¯äº†ä¸€ä¸ª sidekiq è¿›ç¨‹ï¼Œé‚£ä¹ˆ sidekiq çš„å®šæ—¶ä»»åŠ¡æ‹‰å–å™¨çš„æ‹‰å–æ—¶é—´å¹³å‡é—´éš”ä¸º 1 x 15 = 15 ç§’ï¼Œé‚£æŒ‰ç…§ä¸Šé¢çš„ &lt;code>#random_poll_interval&lt;/code> æ–¹æ³•çš„å®šä¹‰ï¼Œåˆ™å®é™…æ¯æ¬¡æ‹‰å–çš„æ—¶é—´é—´éš”åˆ™æ˜¯åœ¨ 7.5 ç§’åˆ° 22.5 ç§’ä¹‹é—´ï¼&lt;/p>
&lt;h3 id="å°ç»“-1">å°ç»“&lt;/h3>
&lt;p>ä»è¿™ä¸ªç« èŠ‚çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç™½ Sidekiq å¯¹å®šæ—¶ä»»åŠ¡å’Œé‡è¯•ä»»åŠ¡æ˜¯ä¸€è§†åŒä»çš„ï¼Œå…¶å¤„ç†æµç¨‹éƒ½æ˜¯ï¼š&lt;/p>
&lt;ol>
&lt;li>æ‰€æœ‰å®šæ—¶ä»»åŠ¡ï¼ˆåŒ…æ‹¬é‡è¯•ä»»åŠ¡ï¼Œæœ¬è´¨ä¸Šé‡è¯•ä»»åŠ¡ä¹Ÿæ˜¯å®šæ—¶çš„ï¼Œåè¾¹ä¼šå•ç‹¬è®²è§£ï¼‰ä»¥å…¶è®¡åˆ’æ—¶é—´ä¸º scoreï¼ŒåŠ å…¥ç‰¹æ®Šçš„ &lt;code>&amp;quot;retry&amp;quot;&lt;/code> æˆ– &lt;code>&amp;quot;schedule&amp;quot;&lt;/code> æœ‰åºé˜Ÿåˆ—ä¸­ï¼›&lt;/li>
&lt;li>sidekiq çš„å®šæ—¶ä»»åŠ¡æ‹‰å–å™¨ä» &lt;code>&amp;quot;retry&amp;quot;&lt;/code> å’Œ &lt;code>&amp;quot;schedule&amp;quot;&lt;/code> é˜Ÿåˆ—ä¸­ä¸€ä¸€å–å‡ºå·²åˆ°è¾¾è®¡åˆ’æ—¶é—´çš„ä»»åŠ¡ï¼Œå°†å…¶åŠ å…¥è¯¥ä»»åŠ¡è®¡åˆ’çš„é˜Ÿåˆ—ä¸­ï¼Œåç»­çš„æ‰§è¡Œåˆ™è·Ÿå…¶ä»–æ™®é€šé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸€è‡´ï¼›&lt;/li>
&lt;li>æ‹‰å–å™¨ä¼‘çœ ä¸€å®šæ—¶é—´ï¼ˆ&lt;code>random_poll_interval&lt;/code>ï¼‰åï¼Œä»æ­¥éª¤ 2 é‡æ–°å¼€å§‹ï¼Œå‘¨è€Œå¤å§‹ã€‚&lt;/li>
&lt;/ol>
&lt;p>æ‰€ä»¥ï¼Œå®šæ—¶ä»»åŠ¡çš„è®¡åˆ’æ—¶é—´ä¸æ˜¯ç¡®åˆ‡çš„ä»»åŠ¡æ—¶é—´ï¼åªæ˜¯å…è®¸åŠ å›é˜Ÿåˆ—çš„æ—¶é—´ï¼Œå…·ä½“æ‰§è¡Œæ—¶é—´è¿˜å¾—å¦å¤–çœ‹é˜Ÿåˆ—é•¿åº¦ä»¥åŠé˜Ÿåˆ—å¤„ç†é€Ÿåº¦ï¼&lt;/p>
&lt;h2 id="sidekie-worker-çš„ç§˜å¯†-sidekiqprocessorprocess_one">Sidekie worker çš„ç§˜å¯†ï¼š Sidekiq::Processor#process_one&lt;/h2>
&lt;p>å‰é¢æˆ‘ä»¬åˆ†æè¿‡ sidekiq çš„ worker çš„æ ¸å¿ƒä»£ç å°±æ˜¯åœ¨çº¿ç¨‹é‡Œå¾ªç¯æ‰§è¡Œ &lt;code>#process_one&lt;/code> æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åˆ°åº•åšäº†äº›ä»€ä¹ˆå•Šï¼Ÿåˆ«æ€¥ï¼Œç°åœ¨å°±æ¥ä¸€æ¢ç©¶ç«Ÿï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L79-L83&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> process_one
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @job = fetch
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> process(@job) &lt;span style="font-weight:bold">if&lt;/span> @job
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @job = &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç ä¸­ï¼Œ&lt;code>#process_one&lt;/code> å…ˆé€šè¿‡ &lt;code>#fetch&lt;/code> æ–¹æ³•è·å–ä¸€ä¸ªä»»åŠ¡ï¼Œå½“ä»»åŠ¡è·å–æˆåŠŸåï¼Œå°±å°†å…¶ä½œä¸ºå‚æ•°è°ƒç”¨ &lt;code>#process&lt;/code> æ–¹æ³•ï¼Œå®Œæˆå¯¹ä»»åŠ¡çš„å¤„ç†ï¼›å¦‚æœæ²¡æœ‰è·å–åˆ°ä»»åŠ¡ï¼Œåˆ™ç›´æ¥é‡æ–°å°è¯•è·å–æ–°çš„ä»»åŠ¡ã€‚&lt;/p>
&lt;p>é¦–å…ˆè®©æˆ‘ä»¬çœ‹çœ‹ &lt;code>#fetch&lt;/code> æ–¹æ³•çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L96-L104&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> fetch
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> j = get_one &lt;span style="font-style:italic"># åæ§½ä¸€ä¸‹è¿™ä¸ª `j` å˜é‡ï¼Œå‘½åçœŸçš„ä¸æ•¢æ­ç»´ï¼Œè¿™ä¸ªåº“å°±è¿™é‡Œå†™å¾—ä¸é›…&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> j &amp;amp;&amp;amp; @done
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> j.requeue
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> j
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>#fetch&lt;/code> æ–¹æ³•é€šè¿‡ &lt;code>#get_one&lt;/code> æ–¹æ³•ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼Œå½“è·å–åˆ°ä»»åŠ¡åï¼Œåˆ¤æ–­å½“å‰ worker æ˜¯å¦å·²ç»åœæ­¢(&lt;code>@done&lt;/code> ä¸º &lt;code>true&lt;/code>)ï¼Œæ˜¯åˆ™å°†ä»»åŠ¡é‡æ–°å‹å›é˜Ÿåˆ—ã€‚&lt;/p>
&lt;p>è®©æˆ‘ä»¬æ¥ç€çœ‹ &lt;code>#get_one&lt;/code> æ–¹æ³•çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L85-L94&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> get_one
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> work = @strategy.retrieve_work
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (logger.info { &lt;span style="font-style:italic">&amp;#34;Redis is online, &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>Time.now - @down&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> sec downtime&amp;#34;&lt;/span> }; @down = &lt;span style="">nil&lt;/span>) &lt;span style="font-weight:bold">if&lt;/span> @down
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> work
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Sidekiq::Shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> =&amp;gt; ex
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handle_fetch_exception(ex)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¸å¿ƒä»£ç åˆ™æ˜¯ &lt;code>work = @strategy.retrieve_work&lt;/code>ï¼Œä¸ºäº†äº†è§£ &lt;code>@strategy&lt;/code>ï¼Œæˆ‘ä»¬ä»æ—§å¾€å›çœ‹&lt;code>#initialize&lt;/code> æ–¹æ³•çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L32-L40&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> initialize(mgr)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @strategy = (mgr.options[&lt;span style="font-style:italic">:fetch&lt;/span>] || Sidekiq::BasicFetch).new(mgr.options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆæ˜¯ä¸€ä¸ªç­–ç•¥æ¨¡å¼ï¼Œç¼ºçœä¸‹ï¼Œä½¿ç”¨äº† &lt;code>Sidekiq::BasicFetch&lt;/code> ç”Ÿæˆå®ä¾‹ï¼Œå¹¶ä¸”é€šè¿‡å®ä¾‹å˜é‡ &lt;code>@strategy&lt;/code> å¼•ç”¨ã€‚&lt;/p>
&lt;p>å›åˆ°å‰é¢çš„ &lt;code>@strategy.retrieve_work&lt;/code>ï¼Œè®©æˆ‘ä»¬ç»§ç»­çœ‹çœ‹ &lt;code>Sidekiq::BasicFetch#retrieve_work&lt;/code> çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/fetch.rb#L35-L38&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> retrieve_work
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> work = Sidekiq.redis { |conn| conn.brpop(*queues_cmd) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> UnitOfWork.new(*work) &lt;span style="font-weight:bold">if&lt;/span> work
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼Œå¯ä»¥çŸ¥é“ &lt;code>Sidekiq::BasicFetch&lt;/code> çš„å–ä»»åŠ¡é€»è¾‘æ¯”è¾ƒç›´æ¥ï¼Œæ˜¯é€šè¿‡ Redis çš„ &lt;a href="http://redis.io/commands/brpop">&lt;code>BRPOP&lt;/code> å‘½ä»¤&lt;/a>ä»â€œæ‰€æœ‰é˜Ÿåˆ—â€ä¸­é˜»å¡åœ°å–å‡ºç¬¬ä¸€ä¸ªä»»åŠ¡ï¼š&lt;/p>
&lt;blockquote>
&lt;p>BRPOP is a blocking list pop primitive. It is the blocking version of RPOP because it blocks the connection when there are no elements to pop from any of the given lists. An element is popped from the tail of the first list that is non-empty, with the given keys being checked in the order that they are given.&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ï¼Œç†è§£äº† &lt;code>BRPOP&lt;/code> å‘½ä»¤çš„å·¥ä½œç»†èŠ‚ä¹‹åï¼Œæˆ‘ä»¬æŠŠæ³¨æ„åŠ›ç¼©æ”¾åˆ° &lt;code>#queues_cmd&lt;/code> æ–¹æ³•ä¸Šï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/fetch.rb#L40-L53&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> queues_cmd
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> @strictly_ordered_queues
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @queues
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> queues = @queues.shuffle.uniq
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> queues &amp;lt;&amp;lt; TIMEOUT
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> queues
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆï¼Œä»£ç ä¸­æ£€æŸ¥äº† &lt;code>@strictly_ordered_queues&lt;/code> è¿™ä¸ªå®ä¾‹å˜é‡çš„å€¼ï¼Œè®©æˆ‘ä»¬å›å¤´çœ‹ä¸‹è¿™ä¸ªå˜é‡çš„å€¼çš„æ¥æºï¼Œä¹Ÿå°±æ˜¯ &lt;code>#initialize&lt;/code> æ–¹æ³•çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/d8f11c26518dbe967880f76fd23bb99e9d2411d5/lib/sidekiq/fetch.rb#L26-L33&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> initialize(options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @strictly_ordered_queues = !!options[&lt;span style="font-style:italic">:strict&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @queues = options[&lt;span style="font-style:italic">:queues&lt;/span>].map { |q| &lt;span style="font-style:italic">&amp;#34;queue:&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>q&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> @strictly_ordered_queues
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @queues = @queues.uniq
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @queues &amp;lt;&amp;lt; TIMEOUT
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼ºçœæƒ…å†µä¸‹ï¼Œæ­¤å€¼ä¸º &lt;code>false&lt;/code>ã€‚æ‰€ä»¥è®©æˆ‘ä»¬çœ‹ &lt;code>#queues_cmd&lt;/code> æ–¹æ³•çš„ &lt;code>else&lt;/code> åˆ†æ”¯é‡Œçš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>queues = @queues.shuffle.uniq
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è€Œè¿™é‡Œçš„ &lt;code>@queues&lt;/code> å°±æ˜¯æ¥è‡ª &lt;code>options[:queues]&lt;/code> ä¸­çš„é…ç½®ï¼š &lt;code>options[:queues].map { |q| &amp;quot;queue:#{q}&amp;quot; }&lt;/code>ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ª &lt;code>options[:queues]&lt;/code> çš„å€¼åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ
è®©æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ²¿ç€è°ƒç”¨é“¾ä¸Šå‚æ•°å¾€å›èµ°ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;code>Sidekiq::BasicFetch.new&lt;/code> çš„å‚æ•° &lt;code>options&lt;/code> æ¥è‡ª worker åœ¨ &lt;code>Sidekiq::Processor#initialize&lt;/code> æ–¹æ³•ä¸­çš„å‚æ•° &lt;code>mgr&lt;/code> çš„ &lt;code>options&lt;/code> å±æ€§ï¼›&lt;/li>
&lt;li>worker çš„ mgr å‚æ•°æ­£æ˜¯ &lt;code>Sidekiq::Manager&lt;/code> çš„å®ä¾‹ï¼Œå…¶ &lt;code>options&lt;/code> å±æ€§åˆ™æ˜¯ &lt;code>Sidekiq::Launcher&lt;/code> åˆ›å»º &lt;code>Sidekiq::Manager&lt;/code> å®ä¾‹æ—¶ä¼ å…¥çš„ &lt;code>options&lt;/code> å˜é‡ï¼›&lt;/li>
&lt;li>è€Œ &lt;code>Sidekiq::Launcher#initialize&lt;/code> æ¥æ”¶åˆ°çš„ &lt;code>options&lt;/code> å˜é‡åˆ™æ˜¯æ›´å¤–å±‚çš„ &lt;code>Sidekiq::CLI&lt;/code> çš„å®ä¾‹æ–¹æ³• &lt;code>options&lt;/code> çš„å€¼ï¼›&lt;/li>
&lt;li>è€Œ &lt;code>Sidekiq::CLI&lt;/code> çš„å®ä¾‹çš„ &lt;code>options&lt;/code> åˆ™æ˜¯åœ¨å…¶æ¥æ”¶åˆ° &lt;code>#parse&lt;/code> è°ƒç”¨æ—¶è®¾ç½®çš„ã€‚
ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œçœç•¥è¿™é‡Œå…¶ä¸­çš„å¤ªå¤šè°ƒç”¨æ ˆï¼Œæˆ‘ä»¬ç›´æ¥çœ‹æœ€æ ¹æºä»£ç ï¼š&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/cli.rb#L389-L399&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> parse_queues(opts, queues_and_weights)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> queues_and_weights.each { |queue_and_weight| parse_queue(opts, *queue_and_weight) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> parse_queue(opts, q, weight=&lt;span style="">nil&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [weight.to_i, 1].max.times &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (opts[&lt;span style="font-style:italic">:queues&lt;/span>] ||= []) &amp;lt;&amp;lt; q
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> opts[&lt;span style="font-style:italic">:strict&lt;/span>] = &lt;span style="">false&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> weight.to_i &amp;gt; 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œsidekiq åœ¨è§£æ &lt;code>:queues&lt;/code> çš„ç›¸å…³é…ç½®æ—¶ï¼ŒæŒ‰ç…§æ¯ä¸ªé˜Ÿåˆ—ä»¥åŠå…¶æƒé‡ï¼Œç”Ÿæˆäº†ä¸€ä¸ªé‡å¤æ¬¡æ•°ç­‰äºé˜Ÿåˆ—æƒé‡çš„é˜Ÿåˆ—çš„æ–°æ•°ç»„ï¼Œå‡è®¾ç”¨æˆ·æä¾›å¦‚ä¸‹é…ç½®ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">:queues&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - default
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> - [myqueue, 2]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ™æ­¤å¤„ç”Ÿæˆçš„ &lt;code>options[:queues]&lt;/code> åˆ™ä¸º &lt;code>[&amp;quot;default&amp;quot;, &amp;quot;myqueue&amp;quot;, &amp;quot;myqueue&amp;quot;]&lt;/code>ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œæƒé‡ä¸»è¦ç”¨äºåè¾¹ç¡®å®šå„ä¸ªä¸åŒé˜Ÿåˆ—è¢«å¤„ç†åˆ°çš„ä¼˜å…ˆæƒçš„æ¯”é‡ã€‚&lt;/p>
&lt;p>äº†è§£äº† &lt;code>@queues&lt;/code> çš„æ¥æºä¹‹åï¼Œæˆ‘ä»¬å›åˆ°æœ€å¼€å§‹è®¨è®ºçš„åœ°æ–¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>queues = @queues.shuffle.uniq
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡ worker åœ¨è¯·æ±‚æ–°çš„ä»»åŠ¡æ—¶ï¼Œsidekiq éƒ½æŒ‰ç…§åŸæ¥çš„ &lt;code>@queues&lt;/code> æ‰§è¡Œ &lt;code>shuffle&lt;/code> æ–¹æ³•ï¼Œè€Œ &lt;code>shuffle&lt;/code> åˆ™è¡¨ç¤ºå°†æ•°ç»„å…ƒç´ é‡æ–°éšæœºæ’åºï¼Œäº¦å³â€œæ´—ç‰Œâ€ã€‚ç»“åˆå‰é¢çš„æƒé‡ï¼Œé‚£ä¹ˆæ¯ä¸ªé˜Ÿåˆ—æ´—ç‰Œåæ’åœ¨ç¬¬ä¸€ä½çš„æ¦‚ç‡ä¸å…¶æƒé‡æŒ‚é’©ã€‚æœ€åçš„ &lt;code>#uniq&lt;/code> æ–¹æ³•ç¡®ä¿é˜Ÿåˆ—åç§°æ²¡æœ‰é‡å¤ï¼Œé¿å… Redis åœ¨æ‰§è¡Œ &lt;code>BRPOP&lt;/code> å‘½ä»¤æ—¶é‡å¤æ£€æŸ¥åŒä¸€é˜Ÿåˆ—ã€‚è¿™é‡Œä½¿ç”¨ &lt;code>BRPOP&lt;/code> è¿˜æœ‰ä¸ªå¥½å¤„å°±æ˜¯ï¼ŒåŠ å…¥å½“å‰é¢ä¼˜å…ˆçš„é˜Ÿåˆ—é‡Œè¾¹æ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œå¯ä»¥ä¾æ¬¡å°†æœºä¼šè®©ç»™åé¢çš„é˜Ÿåˆ—ã€‚&lt;/p>
&lt;p>è€Œåè¾¹çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>queues &amp;lt;&amp;lt; TIMEOUT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ™æ˜¯åœ¨å‘½ä»¤æœ«å°¾è¿½åŠ è¶…æ—¶è®¾å®šï¼Œå³ Redis çš„ &lt;code>BRPOP&lt;/code> å‘½ä»¤æœ€å¤šé˜»å¡ 2 ç§’ï¼Œè¶…æ—¶åˆ™ç›´æ¥æ”¾å¼ƒã€‚&lt;/p>
&lt;p>äº†è§£äº†ä»»åŠ¡çš„è·å–ä¹‹åï¼Œæˆ‘ä»¬æ¥ç€çœ‹ sidekiq å¦‚ä½•å¤„ç†è·å–åˆ°çš„ä»»åŠ¡ï¼Œå›åˆ° &lt;code>retrieve_work&lt;/code> çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/fetch.rb#L36-L37&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>work = Sidekiq.redis { |conn| conn.brpop(*queues_cmd) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>UnitOfWork.new(*work) &lt;span style="font-weight:bold">if&lt;/span> work
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹åˆ°åœ¨è·å–åˆ°ä»»åŠ¡ä¹‹åï¼Œä»»åŠ¡é€šè¿‡ &lt;code>Sidekiq::BasicFetch::UnitOfWork&lt;/code> ç»“æ„ä½“å®ä¾‹åŒ–åè¿”å›ç»™è°ƒç”¨æ–¹ã€‚&lt;/p>
&lt;p>ç›´æ¥å›åˆ° &lt;code>Sidekiq::Processor#process_one&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L79-L83&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> process_one
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @job = fetch
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> process(@job) &lt;span style="font-weight:bold">if&lt;/span> @job
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @job = &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥æ˜ç™½ï¼Œ@job å°±æ˜¯è¿”å›çš„ &lt;code>UnitOfWork&lt;/code> å®ä¾‹ï¼Œé‚£ä¹ˆ &lt;code>process(@job)&lt;/code> ä¼šåšäº›ä»€ä¹ˆå‘¢ï¼Ÿ&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L118-L152&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> process(work)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> jobstr = work.job
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> queue = work.queue_name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @reloader.call &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ack = &lt;span style="">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">begin&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> job = Sidekiq.load_json(jobstr)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> klass = job[&lt;span style="font-style:italic">&amp;#39;class&amp;#39;&lt;/span>.freeze].constantize
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> worker = klass.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> worker.jid = job[&lt;span style="font-style:italic">&amp;#39;jid&amp;#39;&lt;/span>.freeze]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stats(worker, job, queue) &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.server_middleware.invoke(worker, job, queue) &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Only ack if we either attempted to start this job or&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># successfully completed it. This prevents us from&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># losing jobs if a middleware raises an exception before yielding&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ack = &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> execute_job(worker, cloned(job[&lt;span style="font-style:italic">&amp;#39;args&amp;#39;&lt;/span>.freeze]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢ä»£ç ä¸­ï¼Œsidekiq ä» &lt;code>work&lt;/code> ä¸­è·å–ä»»åŠ¡çš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬é˜Ÿåˆ—åç§°ï¼Œä»»åŠ¡å¯¹åº”çš„ç±»å‹ï¼ˆ&lt;code>job['class'.freeze]&lt;/code>ï¼‰ã€ä»»åŠ¡è°ƒç”¨æ‰€éœ€çš„å‚æ•°ç­‰ï¼Œæ ¹æ®è¿™äº›ä¿¡æ¯é‡æ–°å®ä¾‹åŒ–ä»»åŠ¡å¯¹è±¡ï¼Œå¹¶ä¸”å°†å®ä¾‹åŒ–çš„ä»»åŠ¡å¯¹è±¡ &lt;code>worker&lt;/code> ä»¥åŠä»»åŠ¡å‚æ•°éƒ½ä¼ é€’ç»™å¯¹ &lt;code>execute_job&lt;/code> çš„è°ƒç”¨ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ &lt;code>#execute_job&lt;/code> çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L154-L156&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> execute_job(worker, cloned_args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> worker.perform(*cloned_args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹åˆ°äº†å§ï¼Ÿæˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„ &lt;code>#perform&lt;/code> æ–¹æ³•ï¼è¿™ä¸‹çŸ¥é“æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦åœ¨æ¯ä¸ª sidekiq Worker æˆ–è€… ActiveJob çš„ Job ç±»ä¸­å®šä¹‰è¿™ä¸ªæ–¹æ³•äº†å§ï¼Ÿå› ä¸ºè¿™ä¸ªæ–¹æ³•å°±æ˜¯æœ€ç»ˆä»»åŠ¡æ‰§è¡Œæ—¶æ‰€éœ€è°ƒç”¨çš„æ–¹æ³•ï¼Œè¿™å°±æ˜¯çº¦å®šï¼&lt;/p>
&lt;p>è‡³æ­¤ï¼Œä»»åŠ¡çš„è°ƒåº¦è¿‡ç¨‹å°±åˆ°æ­¤ä¸ºæ­¢äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯å‘¨è€Œå¤å§‹çš„é‡å¤äº†ã€‚&lt;/p>
&lt;h3 id="å°ç»“-2">å°ç»“&lt;/h3>
&lt;p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç™½ sidekiq ä¸­ worker çš„å·¥ä½œæµç¨‹ï¼š&lt;/p>
&lt;ol>
&lt;li>æŒ‰ç…§æ‰€æœ‰é˜Ÿåˆ—ä»¥åŠå…¶æƒé‡ï¼Œæ¯æ¬¡é‡æ–°æ’åˆ—å¾…å¤„ç†é˜Ÿåˆ—é¡ºåºï¼Œé«˜æƒé‡çš„é˜Ÿåˆ—æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ï¼›&lt;/li>
&lt;li>å°†é‡æ–°æ’å¥½çš„é˜Ÿåˆ—é¡ºåºä¼ é€’ç»™ Redis çš„ BRPOP å‘½ä»¤ï¼ŒåŒæ—¶è®¾ç½® 2 ç§’è¶…æ—¶ï¼›&lt;/li>
&lt;li>sidekiq å°†ä»é˜Ÿåˆ—ä¸­è·å–åˆ°çš„ä»»åŠ¡å®ä¾‹åŒ–ï¼Œå¹¶ä¸”æ ¹æ®æºå¸¦çš„å‚æ•°è°ƒç”¨äº†ä»»åŠ¡çš„ &lt;code>#perform&lt;/code> æ–¹æ³•ã€‚&lt;/li>
&lt;/ol>
&lt;p>ç­‰ç­‰ï¼Œä¸Šé¢éƒ½åªæ˜¯æ­£å¸¸æµç¨‹ï¼Œé‚£å¦‚æœä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™äº†æ€ä¹ˆåŠï¼Ÿï¼Ÿï¼Ÿé‡è¯•çš„æœºåˆ¶æ˜¯å¦‚ä½•è¿è½¬çš„å‘¢ï¼Ÿ&lt;/p>
&lt;h2 id="é‡è¯•æœºåˆ¶åŸºäºä¸­é—´ä»¶çš„å®ç°">é‡è¯•æœºåˆ¶ï¼šåŸºäºä¸­é—´ä»¶çš„å®ç°&lt;/h2>
&lt;p>**æ³¨æ„ï¼š**é˜…è¯»æœ¬ç« èŠ‚å‰ï¼Œå»ºè®®å…ˆé˜…è¯»å®˜æ–¹ Wiki çš„ &lt;a href="https://github.com/mperham/sidekiq/wiki/Error-Handling">Error Handling&lt;/a>ã€‚&lt;/p>
&lt;p>ç»†å¿ƒçš„ç«¥é‹è‚¯å®šå‘ç°äº†ä¸Šé¢çš„ &lt;code>Sidekiq::Processor#process&lt;/code> æ–¹æ³•ä¸­æœ‰ä¸ªå…³é”®çš„ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/processor.rb#L131-L137&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Sidekiq.server_middleware.invoke(worker, job, queue) &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> execute_job(worker, cloned(job[&lt;span style="font-style:italic">&amp;#39;args&amp;#39;&lt;/span>.freeze]))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ª &lt;code>server_middleware&lt;/code> æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè®©æˆ‘ä»¬æ¥ç®€å•è¿‡ä¸€ä¸‹å§ï¼š&lt;/p>
&lt;p>å…¨å±€æœç´¢äº†ä»£ç ï¼Œå‘ç° &lt;code>Sidekiq.server_middleware&lt;/code> çš„æ¥æºæ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq.rb#L140-L144&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> &lt;span style="font-weight:bold">self&lt;/span>.server_middleware
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @server_chain ||= default_server_middleware
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">yield&lt;/span> @server_chain &lt;span style="font-weight:bold">if&lt;/span> block_given?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @server_chain
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¼ºçœæƒ…å†µä¸‹ï¼Œ&lt;code>.server_middleware&lt;/code> ä¾èµ– &lt;code>.default_server_middleware&lt;/code> çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq.rb#L146-L154&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> &lt;span style="font-weight:bold">self&lt;/span>.default_server_middleware
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Middleware::Chain.new &lt;span style="font-weight:bold">do&lt;/span> |m|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> m.add Middleware::Server::Logging
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> m.add Middleware::Server::RetryJobs
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥æ˜ç™½ &lt;code>Sidekiq.default_server_middleware&lt;/code> è¿”å›ä¸€ä¸ª &lt;code>Middleware::Chain&lt;/code> å®ä¾‹ï¼Œå¹¶ä¸”è°ƒç”¨äº†å…¶ &lt;code>#add&lt;/code> æ–¹æ³•å°† &lt;code>Middleware::Server::Logging&lt;/code> ä»¥åŠ &lt;code>Middleware::Server::RetryJobs&lt;/code> ä¸¤ä¸ªä¸­é—´ä»¶åŠ åˆ°ä¸­é—´ä»¶çš„ Chain ä¸Šã€‚æ­¤ä¸­é—´ä»¶çš„å®ç°ä»¥åŠå®ç°ç±»ä¼¼ rackupï¼Œæœ‰å…´è¶£çš„ç«¥é‹è‡ªè¡Œ&lt;a href="https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/middleware/chain.rb">é˜…è¯»æºç &lt;/a>ï¼Œåœ¨æ­¤ä¸å±•å¼€ï¼Œè®©æˆ‘ä»¬ç›´æ¥è·³åˆ° &lt;code>Middleware::Server::RetryJobs&lt;/code> çš„ &lt;code>call&lt;/code> æ–¹æ³•ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/middleware/server/retry_jobs.rb#L73-L84&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> call(worker, msg, queue)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">yield&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">rescue&lt;/span> Sidekiq::Shutdown
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ignore, will be pushed back onto queue during hard_shutdown&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">rescue&lt;/span> Exception =&amp;gt; e
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ignore, will be pushed back onto queue during hard_shutdown&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span> Sidekiq::Shutdown &lt;span style="font-weight:bold">if&lt;/span> exception_caused_by_shutdown?(e)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span> e &lt;span style="font-weight:bold">unless&lt;/span> msg[&lt;span style="font-style:italic">&amp;#39;retry&amp;#39;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attempt_retry(worker, msg, queue, e)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®©æˆ‘ä»¬èšç„¦æ–¹æ³•çš„æœ€åä¸€è¡Œä»£ç  &lt;code>attempt_retry(worker, msg, queue, e)&lt;/code>ï¼Œæ­¤å¤„è¡¨ç¤ºå½“æ‰§è¡Œä¸­çš„ä»»åŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œé™¤å»åœæœºçš„å› ç´ ä»¥åŠç¦ç”¨äº†é‡è¯•æœºåˆ¶åï¼Œå°è¯•è¿›è¡Œä¸‹æ¬¡é‡è¯•è¿è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/middleware/server/retry_jobs.rb#L88-L137&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> attempt_retry(worker, msg, queue, exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> max_retry_attempts = retry_attempts_from(msg[&lt;span style="font-style:italic">&amp;#39;retry&amp;#39;&lt;/span>], @max_retries)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> count = &lt;span style="font-weight:bold">if&lt;/span> msg[&lt;span style="font-style:italic">&amp;#39;retry_count&amp;#39;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg[&lt;span style="font-style:italic">&amp;#39;retried_at&amp;#39;&lt;/span>] = Time.now.to_f
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg[&lt;span style="font-style:italic">&amp;#39;retry_count&amp;#39;&lt;/span>] += 1
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg[&lt;span style="font-style:italic">&amp;#39;failed_at&amp;#39;&lt;/span>] = Time.now.to_f
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> msg[&lt;span style="font-style:italic">&amp;#39;retry_count&amp;#39;&lt;/span>] = 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> count &amp;lt; max_retry_attempts
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> delay = delay_for(worker, count, exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> logger.debug { &lt;span style="font-style:italic">&amp;#34;Failure! Retry &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>count&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> in &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>delay&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> seconds&amp;#34;&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> retry_at = Time.now.to_f + delay
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> payload = Sidekiq.dump_json(msg)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Sidekiq.redis &lt;span style="font-weight:bold">do&lt;/span> |conn|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> conn.zadd(&lt;span style="font-style:italic">&amp;#39;retry&amp;#39;&lt;/span>, retry_at.to_s, payload)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Goodbye dear message, you (re)tried your best I&amp;#39;m sure.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> retries_exhausted(worker, msg, exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span> exception
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ä¸Šé¢çš„ä»£ç ä¸­çœ‹å‡ºï¼Œsidekiq åœ¨æ•æ‰åˆ°å¼‚å¸¸åï¼Œé¦–å…ˆæ£€æŸ¥æ­¤ä»»åŠ¡æ­¤å‰æ˜¯å¦å·²ç»é‡è¯•è¿‡ï¼Œæ˜¯çš„è¯ï¼Œåˆ™åœ¨é‡è¯•ç´¯è®¡æ¬¡æ•°ä¸ŠåŠ  1ï¼Œæ›´æ–°æœ€åé‡è¯•æ—¶é—´ï¼›å¦åˆ™åˆå§‹åŒ–é‡è¯•ç´¯è®¡æ¬¡æ•°ä¸º 0ï¼Œè®¾å®šåˆæ¬¡å¤±è´¥æ—¶é—´ã€‚æ¥ç€ï¼Œsidekiq æ£€æŸ¥é‡è¯•ç´¯è®¡æ¬¡æ•°æ˜¯å¦è¶…è¿‡é™å®šæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ˜¯çš„è¯åˆ™æ”¾å¼ƒé‡è¯•ï¼Œä»»åŠ¡ä»æ­¤ä¸å†é‡è¯•ï¼Œè¿›å…¥ Dead çŠ¶æ€ï¼Œsidekiq æŠ›å‡ºå¼‚å¸¸ï¼›å¦åˆ™è®¡ç®—ä»»åŠ¡ä¸‹æ¬¡é‡è¯•æ—¶é—´ï¼Œå°†ä»»åŠ¡æŒ‰ç…§è®¡åˆ’çš„ä¸‹æ¬¡é‡è¯•æ—¶é—´åŠ åˆ° &lt;code>retry&lt;/code> æœ‰åºé˜Ÿåˆ—ä¸­ï¼Œæœ€åæŠ›å‡ºå¼‚å¸¸ã€‚å…³äºé‡è¯•ä»»åŠ¡çš„æ£€æŸ¥è·Ÿæ‰§è¡Œï¼Œè¯·é˜…è¯»å‰é¢çš„ç›¸å…³ç« èŠ‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸»è¦åˆ†æ sidekiq å¦‚ä½•è®¡ç®—ä»»åŠ¡çš„ä¸‹æ¬¡é‡è¯•æ—¶é—´ &lt;code>delay&lt;/code>ã€‚&lt;/p>
&lt;p>è®©æˆ‘ä»¬å±•å¼€å¯¹ &lt;code>#delay_for&lt;/code> æ–¹æ³•çš„æ¢ç´¢ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/middleware/server/retry_jobs.rb#L172-L174&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> delay_for(worker, count, exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> worker.sidekiq_retry_in_block? &amp;amp;&amp;amp; retry_in(worker, count, exception) || seconds_to_delay(count)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆäº†è§£ä¸‹ &lt;code>worker.sidekiq_retry_in_block?&lt;/code> çš„å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/worker.rb#L32&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>base.class_attribute &lt;span style="font-style:italic">:sidekiq_retry_in_block&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶å®šä¹‰äº†æ¯ä¸ª Worker ç±»çš„ &lt;code>sidekiq_retry_in_block&lt;/code> å±æ€§ï¼Œè€Œå…¶åˆå¯ä»¥é€šè¿‡ Worker ç±»çš„ &lt;code>#sidekiq_retry_in&lt;/code> æ–¹æ³•å®Œæˆèµ‹å€¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/worker.rb#L96-L98&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> sidekiq_retry_in(&amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self.sidekiq_retry_in_block = block
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å›è¿‡å¤´æ¥ï¼Œå‰é¢çš„&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>worker.sidekiq_retry_in_block? &amp;amp;&amp;amp; retry_in(worker, count, exception) || seconds_to_delay(count)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¡¨ç¤ºå½“å…·ä½“çš„ Worker é…ç½®äº† &lt;code>:sidekiq_retry_in_block&lt;/code> æ—¶ï¼Œåˆ™ç›´æ¥ä½¿ç”¨è¿™ä¸ªé…ç½®çš„ block æ‰§è¡Œçš„å€¼ä½œä¸ºå¤±è´¥ä»»åŠ¡ä¸‹æ¬¡é‡è¯•çš„æ—¶é—´é—´éš”ï¼›å¦åˆ™ä½¿ç”¨ç¼ºçœçš„è®¡ç®—å…¬å¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/mperham/sidekiq/blob/5ebd857e3020d55f5c701037c2d7bedf9a18e897/lib/sidekiq/middleware/server/retry_jobs.rb#L177-L179&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> seconds_to_delay(count)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (count ** 4) + 15 + (rand(30)*(count+1))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ &lt;code>count&lt;/code> ä¸ºä»»åŠ¡ç´¯è®¡é‡è¯•æ¬¡æ•°ï¼Œä»å…¬å¼ä¸Šçœ‹ï¼Œéšç€å¤±è´¥é‡è¯•æ¬¡æ•°çš„ç´¯è®¡å¢åŠ ï¼Œä»»åŠ¡çš„ä¸‹æ¬¡é‡è¯•æ—¶é—´é—´éš”ä¹Ÿä¼šæŒ‡æ•°å¼å¢é•¿ï¼ŒæŒ‰ç…§å®˜æ–¹æ–‡æ¡£è¯´æ³•ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Sidekiq will retry failures with an exponential backoff using the formula (retry_count ** 4) + 15 + (rand(30) * (retry_count + 1)) (i.e. 15, 16, 31, 96, 271, &amp;hellip; seconds + a random amount of time). It will perform 25 retries over approximately 21 days.&lt;/p>
&lt;/blockquote>
&lt;p>æ›´å¤šå¤±è´¥ä»»åŠ¡é‡è¯•çš„ç›¸å…³é…ç½®è¯·çœ‹æ–‡æ¡£ï¼š&lt;a href="https://github.com/mperham/sidekiq/wiki/Error-Handling#configuration">Error Handling: Configuration&lt;/a>ã€‚&lt;/p>
&lt;h3 id="å°ç»“-3">å°ç»“&lt;/h3>
&lt;ol>
&lt;li>sidekiq åœ¨æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œé€šè¿‡è‡ªè¡Œå®ç°çš„ä¸­é—´ä»¶æ¶æ„ä»¥åŠå¯¹åº”çš„ç®€å•çš„ä¸­é—´ä»¶ï¼ŒåŠæ—¶æ•æ‰å¤±è´¥çš„ä»»åŠ¡ï¼Œé’ˆå¯¹å…è®¸å†æ¬¡é‡è¯•çš„ä»»åŠ¡ï¼ŒæŒ‰å¤±è´¥æ¬¡æ•°è®¡ç®—æ–°çš„é‡è¯•æ—¶é—´ï¼Œç¼ºçœä¸ºæŒ‡æ•°å¢é•¿çš„æ—¶é—´é—´éš”ï¼›&lt;/li>
&lt;li>ç”¨æˆ·å¯ä»¥é€šè¿‡é…ç½®ä¿®æ”¹ç¼ºçœçš„å…¬å¼ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šæœ€å¤§é‡è¯•æ¬¡æ•°ç­‰ã€‚&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>æ³¨æ„&lt;/strong>ï¼šç»“åˆå¤±è´¥ä»»åŠ¡æ•æ‰å¤„ç†ä»¥åŠé‡è¯•ä»»åŠ¡çš„æ£€æŸ¥ï¼Œç¼ºçœæƒ…å†µä¸‹ï¼Œä¸€ä¸ªé¦–æ¬¡å¤±è´¥ä»»åŠ¡ä¸‹æ¬¡é‡å›é˜Ÿåˆ—ï¼ˆä¸æ˜¯æ‰§è¡Œï¼‰çš„ç†è®ºæœ€å¤§æ—¶é—´é—´éš”å¤§æ¦‚æ˜¯ 67.5 ç§’ï¼ï¼ˆå›ºå®šçš„ 15 ç§’ + æœ€å¤§éšæœºæ—¶é—´ 30 ç§’ + æœ€å¤§ç†è®ºæ£€æŸ¥æ—¶é—´ 22.5 ç§’ï¼‰ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ çš„ä»»åŠ¡å¾ˆé‡è¦ï¼Œåˆéœ€è¦å°½å¿«é‡è¯•ï¼Œå°±éœ€è¦å¯¹å‡ éƒ¨åˆ†æ—¶é—´çš„ç›¸å…³é…ç½®å‚æ•°è¿›è¡Œè°ƒä¼˜äº†å“¦ï¼åœ¨æˆ‘è‡ªå·±çš„å·¥ä½œä¸­ï¼Œæˆ‘é’ˆå¯¹æŸä¸ªé˜Ÿåˆ—ä»»åŠ¡è®¾ç½®çš„ &lt;code>sidekiq_retry_in&lt;/code> å…¬å¼ä¸ºçº¿æ€§æ—¶é—´ï¼Œå³1sã€2sã€&amp;hellip;50sï¼Œç„¶ååœ¨é‡è¯•æ£€æŸ¥é‚£é‡Œè®¾ç½®äº† &lt;code>:poll_interval_average&lt;/code> ä¸º 5 ç§’ï¼Œæ–°çš„ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ç†è®ºæœ€å¤§æ—¶é—´é—´éš”å°±æ˜¯ 8.5 ç§’ï¼ä¸è¿‡è¿™äº›é…ç½®éœ€è¦æ…é‡è°ƒæ•´ï¼Œç»¼åˆè€ƒè™‘ä¸šåŠ¡ä»¥åŠä¸šåŠ¡é‡ï¼Œæ—¢è¦å°½å¯èƒ½ä¿è¯ä»»åŠ¡å°½æ—©å¤„ç†å®Œï¼Œåˆå¾—ä¿è¯ Redis æ²¡è¢« IO å‹å®ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;h3 id="å…³äº-sidekiq-é¡¹ç›®ä»£ç ">å…³äº sidekiq é¡¹ç›®ä»£ç &lt;/h3>
&lt;ol>
&lt;li>sidekiq çš„æºç æ¯”è¾ƒç®€æ´ï¼Œå¾ˆå°‘çœ‹åˆ°é•¿æ–¹æ³•å®šä¹‰ï¼Œå¤§éƒ¨åˆ†æ–¹æ³•éƒ½åœ¨å‡ è¡Œä¹‹å†…ï¼Œè¯»çš„è¿‡ç¨‹ä¸­éå¸¸èˆ’æœï¼›&lt;/li>
&lt;li>sidekiq çš„æ³¨é‡Šä¹Ÿå¾ˆå……è¶³ï¼Œæ¯”è¾ƒé‡è¦åˆæ¯”è¾ƒæ ¸å¿ƒçš„ä»£ç éƒ½æœ‰å¤§é‡è¯¦ç»†çš„æ³¨é‡Šè·Ÿä¾‹å­ï¼Œé™¤æ­¤ä¹‹å¤–å¤§éƒ¨åˆ†é‡ç‚¹åœ¨ Wiki ä¸­éƒ½æœ‰æåŠï¼Œéå¸¸å¥½çš„ä¸€ä»½ä»£ç åº“ï¼›&lt;/li>
&lt;li>sidekiq å°† Redis çš„å„ç§æ•°æ®ç»“æ„ç”¨å¾—éƒ½æ°åˆ°å¥½å¤„ï¼Œå¯ä»¥é€šè¿‡ sidekiq åŠ æ·±å¯¹ Redis çš„å°è±¡ä»¥åŠå­¦ä¹ åˆ°å¦‚ä½•æ°å½“é«˜æ•ˆåœ°ç»“åˆ Redis å®ç°ä¸šåŠ¡é€»è¾‘ï¼›&lt;/li>
&lt;li>æ­£æ˜¯å› ä¸º sidekiq å°† Redis å……åˆ†åˆ©ç”¨ä»¥åŠé«˜åº¦ç»“åˆï¼Œæˆ‘ç»ˆäºç†è§£ sidekiq çš„ä½œè€…ä¸ºä»€ä¹ˆè¡¨ç¤º sidekiq ä¸è€ƒè™‘å…¶ä»–æ•°æ®åº“äº†ï¼›&lt;/li>
&lt;li>sidekiq çš„ä»£ç æ²¡æœ‰å¤ªå¤šèŠ±ä¿çš„ä»£ç ï¼Œéå¸¸æ¨èå„ä½ç«¥é‹ä»”ç»†ç ”è¯»ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="å…³äºæºç é˜…è¯»">å…³äºæºç é˜…è¯»&lt;/h3>
&lt;ol>
&lt;li>å¸¦ç€é—®é¢˜å»é˜…è¯»ï¼Œæ•ˆç‡é€šå¸¸å¾ˆé«˜ï¼›&lt;/li>
&lt;li>è¯»çš„è¿‡ç¨‹ä¸­é€‚å½“æ”¾å¼ƒæ— å…³ç»†èŠ‚ï¼Œåªè¿½å‡»ä¸é—®é¢˜ç›¸å…³çš„çº¿ç´¢ï¼›&lt;/li>
&lt;li>æœ‰äº›æ–‡æ¡£ä¸­æ²¡æœ‰æåŠçš„é…ç½®é¡¹ï¼Œå¾€å¾€éƒ½è—åŒ¿åœ¨ä»£ç ä¹‹ä¸­ï¼›&lt;/li>
&lt;li>åªæœ‰å……åˆ†äº†è§£äº†å·¥å…·çš„è¿è¡Œæœºåˆ¶ï¼Œåœ¨é‡åˆ°é—®é¢˜è°ƒä¼˜çš„æ—¶å€™æ‰èƒ½å¾—å¿ƒåº”æ‰‹ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="æœ€å">æœ€å&lt;/h3>
&lt;p>å¦‚æœä½ èƒ½ä»å¤´çœ‹åˆ°è¿™é‡Œï¼Œé‚£ä¹ˆéå¸¸æ„Ÿè°¢ä½ çš„æ—¶é—´ï¼Œæ¯•ç«Ÿè¿™ç¯‡æ–‡ç« ç¡®å®ä¸çŸ­ï¼Œå°½ç®¡æˆ‘å·²ç»å°½é‡å»é™¤æ— ç”¨çš„éƒ¨åˆ†ï¼Œä¸€äº›ä»£ç ä¹Ÿç›´æ¥è·³è¿‡äº†ï¼Œä½†æ˜¯ç³»ç»Ÿå¾—äº†è§£ä¸€ä¸ªæ¡†æ¶æˆ–è€…ä¸€ä¸ªè½¯ä»¶ï¼Œç¡®å®ä¹Ÿæ˜¯å¾ˆå¤šç»†èŠ‚ã€‚&lt;/p>
&lt;p>è¿™æ˜¯ä»Šå¹´ç¬¬äºŒç¯‡åšå®¢ï¼Œä»Šå¹´çš„äº§å‡ºè¿œä¸æ¯”å»å¹´ï¼Œç„¶è€Œå»å¹´çš„äº§å‡ºè¿œä¸æ¯”åƒå¹´ï¼Œæ‰€ä»¥ï¼Œå¯èƒ½è¿™ç¯‡ä¹Ÿæ˜¯ä»Šå¹´æœ€åä¸€ç¯‡äº†ã€‚æ´‹æ´‹æ´’æ´’å‡ ä¸‡å­—ï¼Œä»ä¸‹åˆä¸¤ä¸‰ç‚¹å†™åˆ°ç°åœ¨ï¼Œä¸ƒä¸ªå¤šå°æ—¶ï¼Œéš¾å¾—å¯ä»¥é™ä¸‹å¿ƒæ¥å†™è¿™ä¹ˆå¤šï¼Œå“ï¼Œè¿™ä¸¤å¹´å¿ƒæ€å¤ªæµ®èºï¼ŒæŠ€æœ¯è·¯ä¸Šï¼Œè¿˜æ˜¯ç»§ç»­ä¿æŒâ€œstay foolish, stay hungryâ€çš„å¥½ã€‚&lt;/p></description></item><item><title>å˜¿ï¼Œå°å¿ƒä½ çš„åŒç­‰å·==</title><link>https://blog.hackerpie.com/posts/archive/pay-attention-to-your-double-equals/</link><pubDate>Sun, 17 Jan 2016 01:40:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/pay-attention-to-your-double-equals/</guid><description>&lt;p>å‰ä¸¤å¤©åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œçªç„¶æ”¶åˆ°è­¦å‘Šè¯´é¡¹ç›®ä»£ç ä¸­å­˜åœ¨ XSS æ¼æ´ï¼Œé‚ç«‹å³æ ¹æ®æŠ¥å‘Šçš„ URL æ’æŸ¥é¡µé¢ä»£ç ï¼Œè™½ç„¶å¾ˆå¿«å°±ä¿®å¤äº†ï¼Œè€Œä¸”åŒæ ·é—®é¢˜çš„è®¨è®ºä¸¤å¹´å‰å°±æœ‰äº†ï¼Œçœ‹&lt;a href="https://ruby-china.org/topics/16633">RubyChina: åˆ«ç”¨ raw å’Œ html_safe&lt;/a>ï¼Œä¸€èˆ¬æ¥è¯´ç›¸å¯¹æœ‰ç»éªŒçš„è€é¸Ÿä¹Ÿåº”è¯¥éƒ½çŸ¥é“è¿™ä¸ªç‚¹ï¼Œä½†æ˜¯è¿˜æ˜¯è§‰å¾—æœ‰å¿…è¦å†™å‡ºæ¥ï¼Œå†æ¬¡æé†’ä¸€ä¸‹å…¶ä»–å°ä¼™ä¼´ï¼Œé¿å…è¸©å‘ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2 id="é—®é¢˜æ ¹æº">é—®é¢˜æ ¹æº&lt;/h2>
&lt;p>å…¶ä¸­ï¼Œåœ¨æ‰¾åˆ°çš„æ¼æ´å‡ºç°çš„åœ°æ–¹ï¼Œéƒ½å­˜åœ¨ç±»ä¼¼ä»¥ä¸‹è¿™æ ·çš„ slim ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>input class=&lt;span style="font-style:italic">&amp;#39;xxx&amp;#39;&lt;/span> value==params[&lt;span style="font-style:italic">:account&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é—®é¢˜å°±å‡ºåœ¨åŒç­‰å· &lt;code>==&lt;/code> ä¸Šï¼Œå› ä¸ºåœ¨ &lt;strong>slim&lt;/strong> è·Ÿ &lt;strong>ERB&lt;/strong> æ¨¡æ¿ï¼ˆå…¶ä»–æ¨¡æ¿æ¯”å¦‚ HAML ä¹‹ç±»çš„å°±ä¸æ¸…æ¥šäº†ï¼‰ä¸­ï¼ŒåŒç­‰å·å…¶å®æ˜¯ Rails çš„ &lt;code>raw&lt;/code> è¿™ä¸ª helper æ–¹æ³•çš„ç¼©å†™ï¼Œ&lt;a href="http://edgeguides.rubyonrails.org/active_support_core_extensions.html#output-safety">å‚è€ƒé“¾æ¥&lt;/a>ï¼š&lt;/p>
&lt;blockquote>
&lt;p>To insert something verbatim use the raw helper rather than calling html_safe:&lt;/p>
&lt;/blockquote>
&lt;pre>&lt;code>&amp;lt;%= raw @cms.current_template %&amp;gt; &amp;lt;%# inserts @cms.current_template as is %&amp;gt;
&lt;/code>&lt;/pre>
&lt;blockquote>
&lt;p>or, equivalently, use &lt;code>&amp;lt;%==&lt;/code>:&lt;/p>
&lt;/blockquote>
&lt;pre>&lt;code>&amp;lt;%== @cms.current_template %&amp;gt; &amp;lt;%# inserts @cms.current_template as is %&amp;gt;
&lt;/code>&lt;/pre>
&lt;p>ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„ä»£ç ç­‰åŒäºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>input class=&lt;span style="font-style:italic">&amp;#39;xxx&amp;#39;&lt;/span> value=raw(params[&lt;span style="font-style:italic">:account&lt;/span>])
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­ &lt;code>raw&lt;/code> æ–¹æ³•åœ¨ &lt;a href="http://api.rubyonrails.org/classes/ActionView/Helpers/OutputSafetyHelper.html#method-i-raw">Rails æ–‡æ¡£&lt;/a>ä¸­çš„è§£é‡Šæ˜¯è¿™æ ·å­çš„ï¼š&lt;/p>
&lt;blockquote>
&lt;p>This method outputs without escaping a string. Since escaping tags is now default, this can be used when you don&amp;rsquo;t want Rails to automatically escape tags. This is not recommended if the data is coming from the user&amp;rsquo;s input.&lt;/p>
&lt;/blockquote>
&lt;p>å¤§æ¦‚æ„æ€å°±æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šè·³è¿‡å¯¹ä¼ å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œæ ‡ç­¾è¿‡æ»¤ä»¥åŠå…¶ä»–å¤„ç†ï¼Œç›´æ¥å°†å­—ç¬¦ä¸²è¾“å‡ºåˆ° HTML ä¸­ã€‚&lt;br>
æ‰€ä»¥åˆ°ç°åœ¨åŸå› å°±å¾ˆæ¸…æ™°äº†ï¼Œå› ä¸ºä¸å°å¿ƒåœ¨ä»£ç é‡Œå¤šåŠ äº†ä¸€ä¸ªç­‰å·ï¼Œå˜æˆäº†åŒç­‰å·ï¼Œå¯¼è‡´å°†ä¼šç›´æ¥æŠŠç”¨æˆ·çš„è¾“å…¥è¾“å‡ºåˆ°å¾…æ¸²æŸ“çš„ HTML ä¸­ï¼Œåœ¨ä¸è‡ªçŸ¥çš„æƒ…å†µä¸‹ç•™ä¸‹äº† XSS æ¼æ´ã€‚äºæ˜¯ä¹ï¼Œä¿®å¤æ–¹æ¡ˆä»…éœ€å»æ‰ä¸€ä¸ªç­‰å·å³å¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>input class=&lt;span style="font-style:italic">&amp;#39;xxx&amp;#39;&lt;/span> value=params[&lt;span style="font-style:italic">:account&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·ï¼ŒRails å°±èƒ½ç»§ç»­è‡ªåŠ¨è¿‡æ»¤è¾“å…¥çš„ &lt;code>:account&lt;/code> çš„å‚æ•°å¹¶ä¸”è‡ªåŠ¨è¿‡æ»¤æ¶æ„å†…å®¹äº†ã€‚&lt;/p>
&lt;h2 id="rawstringhtml_safe-ä»¥åŠ--">rawã€String#html_safe ä»¥åŠ &amp;lt;%== %&amp;gt;&lt;/h2>
&lt;p>åœ¨æŸ¥çœ‹ &lt;code>raw&lt;/code> æ–¹æ³•çš„æ–‡æ¡£æ—¶ï¼Œé¡ºä¾¿çœ‹äº†å…¶æºç ï¼Œæå…¶ç®€å•ï¼Œåªæœ‰ä¸€è¡Œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># File actionview/lib/action_view/helpers/output_safety_helper.rb, line 16&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> raw(stringish)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stringish.to_s.html_safe
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>raw&lt;/code> åªæ˜¯å…ˆç¡®ä¿å°† &lt;code>stringish&lt;/code> å‚æ•°è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åè°ƒç”¨äº† &lt;a href="http://api.rubyonrails.org/classes/String.html#method-i-html_safe">&lt;code>String#html_safe&lt;/code>&lt;/a> æ–¹æ³•è€Œå·²ã€‚è€Œä¸”åœ¨ &lt;code>String#html_safe&lt;/code> çš„æ–‡æ¡£ä¸­ï¼ŒåŒæ ·åå¤å¼ºè°ƒæ…é‡ä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ï¼š&lt;/p>
&lt;blockquote>
&lt;p>It will be inserted into HTML with no additional escaping performed. It is your responsibilty to ensure that the string contains no malicious content. This method is equivalent to the &lt;code>raw&lt;/code> helper in views.&lt;/p>
&lt;/blockquote>
&lt;p>æ‰€ä»¥ï¼Œå¯ä»¥æ€»ç»“ä¸€ä¸‹ï¼Œä»¥ä¸‹ä¸‰ç§å†™æ³•çš„ä»£ç éƒ½æ˜¯ç­‰ä»·çš„ï¼Œéƒ½æ˜¯ä¸å®‰å…¨çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>input class=&lt;span style="font-style:italic">&amp;#39;xxx&amp;#39;&lt;/span> value==params[&lt;span style="font-style:italic">:account&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>input class=&lt;span style="font-style:italic">&amp;#39;xxx&amp;#39;&lt;/span> value=raw(params[&lt;span style="font-style:italic">:account&lt;/span>])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>input class=&lt;span style="font-style:italic">&amp;#39;xxx&amp;#39;&lt;/span> value=params[&lt;span style="font-style:italic">:account&lt;/span>].html_safe
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é‚£åœ¨åˆ‡å®éœ€è¦è¾“å‡ºåŒ…å« HTML å†…å®¹æ¯”å¦‚å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ç¼–è¾‘çš„å†…å®¹æ—¶ï¼Œå¦‚ä½•ä¿è¯å®‰å…¨ï¼Ÿ&lt;br>
æ–¹æ¡ˆå¾ˆç®€å•ï¼Œåªéœ€è¦ä½¿ç”¨æ–‡æ¡£ä¸­æ¨èçš„ &lt;a href="http://api.rubyonrails.org/classes/ActionView/Helpers/SanitizeHelper.html#method-i-sanitize">&lt;code>sanitize&lt;/code>&lt;/a> helper æ–¹æ³•ï¼š&lt;/p>
&lt;blockquote>
&lt;ol>
&lt;li>It is recommended that you use &lt;code>sanitize&lt;/code> instead of this method(html_safe).&lt;/li>
&lt;li>(#sanitize)Sanitizes HTML input, stripping all tags and attributes that aren&amp;rsquo;t whitelisted.&lt;/li>
&lt;/ol>
&lt;/blockquote>
&lt;p>æˆ–è€…ä½¿ç”¨ä¸€äº›å…¶ä»–ç¬¬ä¸‰æ–¹çš„ gem ç”¨æ¥åšè¿‡æ»¤å¤„ç†ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;ol>
&lt;li>ä¸è¦ä½¿ç”¨åŒç­‰å·ç¼©å†™çš„æ–¹å¼ï¼Œä»¥é¿å…å…¶ä»–äººï¼ˆæ¯”å¦‚é¡¹ç›®é‡Œçš„ Rails æ–°æ‰‹ï¼‰åœ¨ä¸äº†è§£çš„æƒ…å†µä¸‹ç…§ç€æ»¥ç”¨ï¼›&lt;/li>
&lt;li>å°½å¯èƒ½ä¸ç”¨ &lt;code>raw&lt;/code> helper æˆ–è€… &lt;code>String#html_safe&lt;/code> æ–¹æ³•ï¼Œå°½å¯èƒ½ä½¿ç”¨ &lt;code>#sanitize&lt;/code>ï¼›&lt;/li>
&lt;li>å¤šå€ŸåŠ©å·¥å…·è¿›è¡Œè‡ªåŠ¨æ‰«æï¼Œæ¯”å¦‚ &lt;a href="http://brakemanscanner.org/">&lt;code>brakeman&lt;/code>&lt;/a>ï¼Œèƒ½å¤Ÿå¿«é€Ÿé«˜æ•ˆæ£€æµ‹å‡ºåŒ…æ‹¬ XSS æ¼æ´åœ¨å†…çš„å¤šç§å®‰å…¨éšæ‚£ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://ruby-china.org/topics/16633">åˆ«ç”¨ raw å’Œ html_safe&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://brakemanscanner.org/">BrakemanScanner&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://guides.rubyonrails.org/active_support_core_extensions.html#safe-strings">Rails Guides: Safe Strings&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://wiki.open.qq.com/wiki/Web%E6%BC%8F%E6%B4%9E%E6%A3%80%E6%B5%8B%E5%8F%8A%E4%BF%AE%E5%A4%8D#1.2_XSS.E6.BC.8F.E6.B4.9E">è…¾è®¯å¼€æ”¾å¹³å°ï¼šXSSæ¼æ´&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Cross-site_scripting">Wikipedia: Cross-site scripting&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://api.rubyonrails.org/classes/ActionView/Helpers/OutputSafetyHelper.html#method-i-raw">Rails API: #raw&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://api.rubyonrails.org/classes/String.html#method-i-html_safe">Rails API: String#html_safe&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>è°¨é˜² ActiveSupport::Cache::Store ç¼“å­˜ nil å€¼</title><link>https://blog.hackerpie.com/posts/archive/jin-fang-activesupport-cache-store-huan-cun-nil-zhi/</link><pubDate>Fri, 30 Oct 2015 20:48:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/jin-fang-activesupport-cache-store-huan-cun-nil-zhi/</guid><description>&lt;p>Rails ä¸­çš„ &lt;strong>&lt;a href="https://github.com/rails/rails/tree/master/activesupport">active_support&lt;/a>&lt;/strong> ç»„ä»¶ä¸»è¦åŸºäº Rails éœ€è¦æä¾›äº†å¾ˆå¤šéå¸¸æœ‰ç”¨çš„åŸºç¡€å·¥å…·ä»¥åŠå¯¹ Ruby å†…ç½®ç±»è¿›è¡Œæ‰©å±•ã€‚å…¶ä¸­çš„ cache æ¨¡å—ä¸»è¦æä¾›äº† Rails ä¸­åº•å±‚ç¼“å­˜çš„å®šä¹‰ä»¥åŠç®€å•å®ç°ã€‚ä»Šå¤©è¦è·Ÿå¤§å®¶æ¢è®¨çš„æ˜¯ä¹‹å‰åœ¨ä½¿ç”¨æ­¤æ¨¡å—æ‰€é‡åˆ°çš„ä¸€ä¸ªå‘ï¼Œæœ‰å…´è¶£å­¦ä¹ å…¶åŸºæœ¬ç”¨æ³•çš„å¯ä»¥ç‚¹å‡»ä»¥ä¸‹ä¸¤ä¸ªé“¾æ¥ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a href="http://guides.rubyonrails.org/caching_with_rails.html#activesupport-cache-store">Rails Guides: ActiveSupport::Cache::Store&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://api.rubyonrails.org/classes/ActiveSupport/Cache/Store.html">Rails API: ActiveSupport::Cache::Store&lt;/a>&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;h3 id="ä»-activesupportcachestorefetch-èŠèµ·">ä» ActiveSupport::Cache::Store#fetch èŠèµ·&lt;/h3>
&lt;p>ä¹‹å‰åœ¨å®ç°ä¸€ä¸ªéœ€è¦ä»å¤–éƒ¨æœåŠ¡è¯·æ±‚æ•°æ®çš„åŠŸèƒ½æ—¶ï¼Œå¤„äºæ€§èƒ½è€ƒè™‘ï¼Œæˆ‘åœ¨ä»£ç ä¸­ä½¿ç”¨äº†ç¼“å­˜ï¼Œå¹¶ä¸”è®¾ç½®ç¼“å­˜å¤±æ•ˆæ—¶é—´ä¸º 7 å¤©ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> read_external_service(params)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># è¿™æ®µä»£ç ç¨å¾®è§£é‡Šä¸‹ï¼š&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># å½“ç¼“å­˜å‘½ä¸­æ—¶ï¼Œåˆ™ç›´æ¥è¯»å–ç¼“å­˜ï¼Œå¦‚æœæ— æœŸå¾…ç¼“å­˜ï¼Œåˆ™é€šè¿‡ HTTP å‘å¤–è¯·æ±‚ç»“æœï¼Œå¹¶ä¸”å°†ç»“æœ&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ç¼“å­˜ä¸‹æ¥ï¼Œè¿™æ ·å­ï¼Œå½“ä¸‹æ¬¡ç»§ç»­è°ƒç”¨æ—¶ï¼Œåˆ™å¯ç›´æ¥è¿”å›ç¼“å­˜å†…å®¹ï¼Œè€Œæ— éœ€é‡å¤å‘å¤–è¯·æ±‚&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rails.cache.fetch &lt;span style="font-style:italic">&amp;#39;example_cache_key_here&amp;#39;&lt;/span>, &lt;span style="font-style:italic">expires_in&lt;/span>: 7.days &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> response = HTTParty.get &lt;span style="font-style:italic">&amp;#39;https://example.com/example/request/path&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> JSON.parse(response.body)[&lt;span style="font-style:italic">&amp;#34;data&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä»£ç å…¶å®ä¸å¤æ‚ï¼Œæ ¸å¿ƒä»£ç å°±æ˜¯ä½¿ç”¨äº† &lt;a href="http://api.rubyonrails.org/classes/ActiveSupport/Cache/Store.html#method-i-fetch">&lt;code>ActiveSupport::Cache::Store#fetch&lt;/code>&lt;/a> æ–¹æ³•ã€‚&lt;/p>
&lt;p>ä¸€åˆ‡éƒ½å¾ˆæ­£å¸¸åœ°è¿è¡Œç€ï¼Œç›´åˆ°æœ‰ä¸€å¤©ï¼Œçº¿ä¸Šç³»ç»Ÿä¸æ–­æŠ¥è­¦ï¼Œå‡ºé”™åŸå› å°±æ˜¯è¿™æ®µä»£ç æ€»æ˜¯è¿”å› &lt;code>nil&lt;/code> ï¼Œè€Œè°ƒç”¨è€…åˆå› ä¸ºæ²¡æœ‰åˆ¤æ–­ &lt;code>nil&lt;/code> å€¼ï¼Œå°±ä¼šå‡ºç° &lt;code>undefined method 'xxx' for nil:NilClass&lt;/code> é”™è¯¯ã€‚åœ¨ debug æ—¶ï¼Œæˆ‘å°è¯•äº†ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡æ¥å£ï¼Œå‘ç°è¯·æ±‚éƒ½æœ‰æ­£ç¡®è¿”å›æ•°æ®ï¼Œä¸å¯èƒ½è¿”å› &lt;code>nil&lt;/code> å•Šï¼Œéš¾é“æ˜¯ç¼“å­˜äº† &lt;code>nil&lt;/code> å€¼ï¼Ÿä¸‹é¢å°±ç›´æ¥é€šè¿‡ä»£ç éªŒè¯ä¸€ä¸‹ï¼&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>[1] pry(main)&amp;gt; require &lt;span style="font-style:italic">&amp;#39;active_support&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[2] pry(main)&amp;gt; cache = ActiveSupport::Cache::MemoryStore.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &amp;lt;&lt;span style="font-style:italic">#ActiveSupport::Cache::MemoryStore entries=0, size=0, options={}&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[3] pry(main)&amp;gt; cache.read &lt;span style="font-style:italic">:nil_value&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[4] pry(main)&amp;gt; cache.exist? &lt;span style="font-style:italic">:nil_value&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[5] pry(main)&amp;gt; cache.fetch &lt;span style="font-style:italic">:nil_value&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[5] pry(main)* &lt;span style="">nil&lt;/span> &lt;span style="font-style:italic"># this `nil` value will be cached&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[5] pry(main)* &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[6] pry(main)&amp;gt; cache.read &lt;span style="font-style:italic">:nil_value&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[7] pry(main)&amp;gt; cache.exist? &lt;span style="font-style:italic">:nil_value&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>çœ‹å§ï¼Œ &lt;code>fetch&lt;/code> æ–¹æ³•ç¡®å®ä¼šç¼“å­˜ &lt;code>nil&lt;/code> å€¼ï¼ˆé€šè¿‡ &lt;code>exist?&lt;/code> æ–¹æ³•å¯ä»¥åˆ¤æ–­æ˜¯å¦ç¼“å­˜äº†æŒ‡å®šçš„ key ï¼‰ï¼Œæ‰€ä»¥ç³»ç»Ÿå‡ºé”™åŸå› å°±æ¸…æ™°äº†ï¼šåœ¨æŸæ¬¡ä»£ç æ‰§è¡Œä¸­ï¼Œæˆ‘çš„ç¼“å­˜åˆšå¥½å¤±æ•ˆäº†ï¼Œæ‰€ä»¥ç³»ç»Ÿå‘å¤–éƒ¨å‘é€äº†è¯·æ±‚ï¼Œæ°å·§è¿™æ—¶å€™å¤–éƒ¨ç³»ç»Ÿå› ä¸ºæ•…éšœæˆ–è€…å…¶ä»–å¯èƒ½åŸå› ï¼Œæ²¡æœ‰è¿”å›æœŸå¾…æ•°æ®ï¼Œå¯¼è‡´ä»£ç ä¸­æœ€ç»ˆç¼“å­˜äº† &lt;code>nil&lt;/code> å€¼ï¼Œåœ¨æ¥ä¸‹æ¥çš„æ—¶é—´é‡Œï¼Œè™½ç„¶å¤–éƒ¨ç³»ç»Ÿå¯èƒ½æ¢å¤äº†æ­£ç¡®æœåŠ¡ï¼Œå¯æ˜¯è¿™æ—¶å€™å› ä¸ºæˆ‘ä»¬çš„ç³»ç»Ÿå·²ç»ç¼“å­˜äº† &lt;code>nil&lt;/code>å€¼ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¿”å›ç¼“å­˜çš„ &lt;code>nil&lt;/code>ï¼Œè€Œä¸æ˜¯é‡æ–°è¯·æ±‚æ­£ç¡®ç»“æœï¼Œå¯¼è‡´æœ€åä¸åœçš„æŠ¥é”™å‘Šè­¦ã€‚&lt;/p>
&lt;p>è¿™é‡Œæ’æ’­ä¸€å¥ï¼Œé€šè¿‡åæ¥ä»”ç»†æŸ¥é˜…æ–‡æ¡£ï¼Œæ‰å‘ç°æ–‡æ¡£é‡Œå·²ç»æ³¨æ˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Nil values can be cached.&lt;/p>
&lt;/blockquote>
&lt;p>&lt;strong>â•®(â•¯â–½â•°)â•­ æ€ªæˆ‘å’¯~&lt;/strong>&lt;/p>
&lt;h3 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h3>
&lt;p>æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜ä¹‹åï¼Œè§£å†³æ€è·¯ç®€å•ç²—æš´ï¼Œå°±æ˜¯åœ¨å¯èƒ½è¿”å› &lt;code>nil&lt;/code> å€¼çš„åœ°æ–¹æ”¾å¼ƒå†™å…¥ç¼“å­˜ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> read_external_service(params)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cache_key = &lt;span style="font-style:italic">&amp;#39;example_cache_key_here&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = Rails.cache.read(cache_key)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ç¼“å­˜å‘½ä¸­ï¼Œä¸”å†…å®¹ä¸ä¸º nil ï¼Œç›´æ¥è¿”å›ç¼“å­˜å†…å®¹&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> result &lt;span style="font-weight:bold">if&lt;/span> result.present?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ç¼“å­˜å¤±æ•ˆï¼Œåªèƒ½é‡æ–°è¯·æ±‚äº†~&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> response = HTTParty.get &lt;span style="font-style:italic">&amp;#39;https://example.com/example/request/path&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = JSON.parse(response.body)[&lt;span style="font-style:italic">&amp;#34;data&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># è¯·æ±‚ç»“æœæ­£ç¡®ï¼Œå†™å…¥ç¼“å­˜ï¼›å¦åˆ™ï¼Œæ”¾å¼ƒä¹‹~~~&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rails.cache.write(cache_key, result, &lt;span style="font-style:italic">expires_in&lt;/span>: 7.days) &lt;span style="font-weight:bold">if&lt;/span> result.present?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‘ƒ~~~è™½ç„¶è§£å†³é—®é¢˜äº†ï¼Œå¯æ˜¯ï¼Œå°±ä¸ºäº†å‘Šè¯‰ç³»ç»Ÿä¸è¦ç›¸ä¿¡ &lt;code>nil&lt;/code>ï¼Œå°±å†™å¾—è¿™ä¹ˆç¹çï¼Œå¥½ä¹ˆï¼Ÿå¥½ä¹ˆï¼Ÿå¥½ä¹ˆï¼Ÿ&lt;/p>
&lt;h3 id="è¸ä¸Šé˜…è¯»æºç ä¹‹è·¯">è¸ä¸Šé˜…è¯»æºç ä¹‹è·¯&lt;/h3>
&lt;p>æˆ‘å°è¯•æœç´¢äº† &lt;code>#fetch&lt;/code> æ–¹æ³•æ˜¯å¦æœ‰æ”¯æŒæ¯”å¦‚ &lt;code>reject_nil&lt;/code> è¿™æ ·çš„ optionï¼Œå¯æƒœçš„æ˜¯ï¼Œæ²¡æœ‰ï¼å¯æ˜¯çœŸçš„æ²¡æœ‰å—ï¼Ÿæˆ‘ä¸ä¿¡ï¼çœ‹æºç å»ï¼&lt;/p>
&lt;p>é¦–å…ˆè¿˜æ˜¯æ‹œè®¿ä¸‹ &lt;a href="https://github.com/rails/rails/blob/edd33c08d98723ae9bb89cf7f019277117ed6414/activesupport/lib/active_support/cache.rb#L154">&lt;code>ActiveSupport::Cache::Store&lt;/code>&lt;/a> è¿™ä¸ªç±»å•¦ï¼Œå®ƒå¯æ˜¯æ‰€æœ‰ç¼“å­˜å®ç°ç±»çš„æŠ½è±¡ç±»ï¼Œåˆ«é—®æˆ‘æŠ½è±¡ç±»æ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯å®ƒæ˜æ˜åªè¯´è¯ä¸å¹²æ´»ï¼Œä½†æ˜¯å…¶ä»–å¹²æ´»çš„éƒ½å¾—å‘å®ƒçœ‹é½ï¼å¥½å•¦ï¼Œè¯´äººè¯ï¼Œå…¶å®å°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨ &lt;code>Rails.cache.read&lt;/code>ã€&lt;code>Rails.cache.fetch&lt;/code> ç­‰è¯»å†™æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•éƒ½æ˜¯åœ¨ &lt;code>ActiveSupport::Cache::Store&lt;/code> ä¸­å®šä¹‰çš„ï¼Œä½†æ˜¯å®ƒåªå®šä¹‰é€»è¾‘ï¼Œè€Œå®é™…åº•å±‚çš„è¯»å†™å®ç°ï¼Œåˆ™éƒ½æ˜¯äº¤ç”±å…¶å„ç§å­ç±»å®ç°çš„ï¼Œæ¯”å¦‚å‰é¢çš„ &lt;code>ActiveSupport::Cache::MemoryStore&lt;/code>ã€‚&lt;/p>
&lt;p>é¦–å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹ &lt;a href="https://github.com/rails/rails/blob/edd33c08d98723ae9bb89cf7f019277117ed6414/activesupport/lib/active_support/cache.rb#L275">&lt;code>fetch&lt;/code>&lt;/a>æ–¹æ³•çš„å…¨éƒ¨å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> fetch(name, options = &lt;span style="">nil&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> block_given?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> options = merged_options(options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> key = namespaced_key(name, options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> instrument(&lt;span style="font-style:italic">:read&lt;/span>, name, options) &lt;span style="font-weight:bold">do&lt;/span> |payload|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> cached_entry = read_entry(key, options) &lt;span style="font-weight:bold">unless&lt;/span> options[&lt;span style="font-style:italic">:force&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> payload[&lt;span style="font-style:italic">:super_operation&lt;/span>] = &lt;span style="font-style:italic">:fetch&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> payload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> entry = handle_expired_entry(cached_entry, key, options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> entry
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> payload[&lt;span style="font-style:italic">:hit&lt;/span>] = &lt;span style="">true&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> payload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> get_entry_value(entry, name, options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> payload[&lt;span style="font-style:italic">:hit&lt;/span>] = &lt;span style="">false&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> payload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> save_block_result_to_cache(name, options) { |_name| &lt;span style="font-weight:bold">yield&lt;/span> _name }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> read(name, options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“ &lt;code>#fetch&lt;/code> æ–¹æ³•è°ƒç”¨æ—¶æ²¡æœ‰ä¼ é€’ block çš„è¯ï¼Œå®ƒæœ¬è´¨ä¸Šå°±æ˜¯ &lt;code>read&lt;/code> æ–¹æ³•çš„åˆ«åè€Œå·²ã€‚è€Œå½“è°ƒç”¨æ—¶ä¼ é€’äº† block çš„è¯ï¼Œå³å¦‚æˆ‘å‰é¢çš„ç¤ºä¾‹ä»£ç ï¼Œè®©æˆ‘ä»¬æŠŠä»£ç åˆ†å¼€çœ‹ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>cached_entry = read_entry(key, options) &lt;span style="font-weight:bold">unless&lt;/span> options[&lt;span style="font-style:italic">:force&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>payload[&lt;span style="font-style:italic">:super_operation&lt;/span>] = &lt;span style="font-style:italic">:fetch&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> payload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>entry = handle_expired_entry(cached_entry, key, options)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®ƒé¦–å…ˆåˆ¤æ–­æ˜¯å¦è®¾ç½®äº† &lt;code>force&lt;/code> é€‰é¡¹ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä¸è¯»å–ç¼“å­˜ï¼Œç”±æ­¤æ¨¡æ‹Ÿç¼“å­˜å¼ºåˆ¶å¤±æ•ˆï¼›å¦‚æœæœªè®¾ç½® &lt;code>force&lt;/code> é€‰é¡¹æˆ–è€…è¯¥é€‰é¡¹ä¸ç­‰äº true valueï¼Œåˆ™å°è¯•è¯»å–ç¼“å­˜ï¼Œå¹¶ä¸”è°ƒç”¨ &lt;a href="https://github.com/rails/rails/blob/edd33c08d98723ae9bb89cf7f019277117ed6414/activesupport/lib/active_support/cache.rb#L564-L578">&lt;code>handle_expired_entry&lt;/code>&lt;/a>åˆ¤æ–­ç¼“å­˜æ˜¯å¦ä»æ—§æœ‰æ•ˆã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">if&lt;/span> entry
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> payload[&lt;span style="font-style:italic">:hit&lt;/span>] = &lt;span style="">true&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> payload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> get_entry_value(entry, name, options)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸‰è¡Œä»£ç ï¼Œåˆ™æ˜¯åœ¨ç¼“å­˜å‘½ä¸­æ—¶ï¼Œç›´æ¥è¯»å–ç¼“å­˜å†…å®¹å¹¶ä¸”è¿”å›ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> payload[&lt;span style="font-style:italic">:hit&lt;/span>] = &lt;span style="">false&lt;/span> &lt;span style="font-weight:bold">if&lt;/span> payload
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> save_block_result_to_cache(name, options) { |_name| &lt;span style="font-weight:bold">yield&lt;/span> _name }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>else&lt;/code> çš„ä»£ç åˆ™è¡¨ç¤ºï¼Œåœ¨ç¼“å­˜æ— å‘½ä¸­æ—¶ï¼Œ &lt;code>#fetch&lt;/code> ä»£ç ç›´æ¥è°ƒç”¨ &lt;a href="https://github.com/rails/rails/blob/edd33c08d98723ae9bb89cf7f019277117ed6414/activesupport/lib/active_support/cache.rb#L585-L592">&lt;code>#save_block_result_to_cache&lt;/code>&lt;/a> æ–¹æ³•ï¼Œå¹¶ä¸”å‘å…¶ä¼ é€’äº†ä¸€ä¸ª blockï¼Œè¿™ä¸ª block æ²¡æœ‰å¹²åˆ«çš„äº‹æƒ…ï¼Œå®ƒåªä¼šæ‰§è¡Œæˆ‘ä»¬ä¼ é€’ç»™ &lt;code>#fetch&lt;/code> æ–¹æ³•çš„ blockï¼Œè®©æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹çœ‹ç›¸å…³çš„å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> save_block_result_to_cache(name, options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = instrument(&lt;span style="font-style:italic">:generate&lt;/span>, name, options) &lt;span style="font-weight:bold">do&lt;/span> |payload|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">yield&lt;/span>(name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> write(name, result, options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œ&lt;code>#save_block_result_to_cache&lt;/code> æ–¹æ³•é¦–å…ˆæ‰§è¡Œä¼ é€’è¿›æ¥çš„ä»£ç å—ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯æˆ‘ä»¬æœŸå¾…åœ¨ç¼“å­˜å¤±æ•ˆæ—¶æ‰§è¡Œçš„ä»£ç ï¼Œè€Œåœ¨è·å¾—æ‰§è¡Œç»“æœ &lt;code>result&lt;/code> åï¼Œæ–¹æ³•é€šè¿‡è°ƒç”¨ &lt;a href="https://github.com/rails/rails/blob/edd33c08d98723ae9bb89cf7f019277117ed6414/activesupport/lib/active_support/cache.rb#L384-L391">&lt;code>#write&lt;/code>&lt;/a> æ–¹æ³•å°†ç»“æœå†™å…¥ç¼“å­˜ï¼Œæœ€åå°† &lt;code>result&lt;/code> è¿”å›ã€‚&lt;/p>
&lt;p>é€šè¿‡ä¸Šé¢çš„æºç åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œ&lt;code>#fetch&lt;/code> æ–¹æ³•ä¼šç›´æ¥å°†å…¶ä»£ç å—ä¸­çš„ä»£ç çš„è¿”å›å€¼&lt;strong>ä¸åŠ åˆ¤æ–­&lt;/strong>åœ°å†™å…¥ç¼“å­˜ï¼Œå¹¶ä¸”è¿”å›è¯¥è¿”å›å€¼ã€‚è¿™é‡Œï¼Œæˆ–è®¸æˆ‘ä»¬å¯ä»¥åšç‚¹ä»€ä¹ˆï¼Œæ¥å®ç°æˆ‘ä»¬æƒ³è¦æ”¯æŒ &lt;code>:reject_nil&lt;/code> çš„éœ€æ±‚ï¼Ÿ&lt;/p>
&lt;h3 id="æ”¯æŒ-reject_nil-option">æ”¯æŒ &lt;code>:reject_nil&lt;/code> option&lt;/h3>
&lt;p>ä¸ºäº†æ”¯æŒ &lt;code>:reject_nil&lt;/code>ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨å†™å…¥ç¼“å­˜å‰åˆ¤æ–­æ˜¯å¦çœŸçš„éœ€è¦ &lt;code>nil&lt;/code> å€¼å³å¯ï¼Œäºæ˜¯æˆ‘ä»¬åªéœ€è¦åœ¨ &lt;code>#save_block_result_to_cache&lt;/code> ä¸­åŠ å…¥ &lt;code>#write&lt;/code> çš„å‰ç½®æ¡ä»¶ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> save_block_result_to_cache(name, options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = instrument(&lt;span style="font-style:italic">:generate&lt;/span>, name, options) &lt;span style="font-weight:bold">do&lt;/span> |payload|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">yield&lt;/span>(name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># options[:reject_nil] &amp;amp;&amp;amp; result.nil? ä½œä¸ºå‰ç½®æ¡ä»¶&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> write(name, result, options) &lt;span style="font-weight:bold">unless&lt;/span> result.nil? &amp;amp;&amp;amp; options[&lt;span style="font-style:italic">:reject_nil&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬æ¥é‡æ–°è¯•éªŒä¸€ç•ªï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>[1] pry(main)&amp;gt; require &lt;span style="font-style:italic">&amp;#39;active_support&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[2] pry(main)&amp;gt; cache = ActiveSupport::Cache::MemoryStore.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &amp;lt;&lt;span style="font-style:italic">#ActiveSupport::Cache::MemoryStore entries=0, size=0, options={}&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[3] pry(main)&amp;gt; cache.fetch &lt;span style="font-style:italic">:nil_key1&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[3] pry(main)* &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[3] pry(main)* &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[4] pry(main)&amp;gt; cache.exist? &lt;span style="font-style:italic">:nil_key1&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[5] pry(main)&amp;gt; cache.fetch &lt;span style="font-style:italic">:nil_key2&lt;/span>, &lt;span style="font-style:italic">reject_nil&lt;/span>: &lt;span style="">true&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[5] pry(main)* &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[5] pry(main)* &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>[6] pry(main)&amp;gt; cache.exist? &lt;span style="font-style:italic">:nil_key2&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="">false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è°ƒç”¨ &lt;code>#fetch&lt;/code> æ–¹æ³•æ—¶ï¼Œå¦‚æœæ²¡æœ‰ä¼ é€’ &lt;code>reject_nil: true&lt;/code>ï¼Œåˆ™ &lt;code>#fetch&lt;/code> æ–¹æ³•ä¼šé»˜è®¤ç¼“å­˜ &lt;code>nil&lt;/code> å€¼ï¼›è€Œå¦‚æœæˆ‘ä»¬è®¾ç½® &lt;code>reject_nil: true&lt;/code> çš„è¯ï¼Œåˆ™ &lt;code>#fetch&lt;/code> å°±ä¼šæ”¾å¼ƒå†™å…¥ &lt;code>nil&lt;/code> å€¼åˆ°ç¼“å­˜ä¸­ã€‚è¯•éªŒæˆåŠŸï¼ï¼ï¼&lt;/p>
&lt;p>åŸºäºè¿™æ ·çš„å®ç°ï¼Œæˆ‘çš„ä»£ç å°±åˆå¯ä»¥æ”¹ä¸ºå¦‚ä¸‹äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> read_external_service(params)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># æ‰€æœ‰æ”¹åŠ¨åªæ˜¯åŠ äº†ä¸€ä¸ª `reject_nil: true`ï¼Œå¤šæ–¹ä¾¿ï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘æ‰åˆ°å‘é‡Œå»äº†&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rails.cache.fetch &lt;span style="font-style:italic">&amp;#39;example_cache_key_here&amp;#39;&lt;/span>, &lt;span style="font-style:italic">expires_in&lt;/span>: 7.days, &lt;span style="font-style:italic">reject_nil&lt;/span>: &lt;span style="">true&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> response = HTTParty.get &lt;span style="font-style:italic">&amp;#39;https://example.com/example/request/path&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> JSON.parse(response.body)[&lt;span style="font-style:italic">&amp;#34;data&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¾…ä¼šå»ç»™ Rails æäº¤ Pull Request å» &lt;strong>O(âˆ©_âˆ©)O~~&lt;/strong>&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;ul>
&lt;li>ç¼“å­˜æ˜¯å¥½ä¸ªä¸œè¥¿ï¼Œç”¨å¾—å¥½èƒ½å¤Ÿè®©åº”ç”¨æ€§èƒ½è¡¨ç°çªé£çŒ›è¿›&lt;/li>
&lt;li>è¦æ³¨æ„ç¼“å­˜å†™å…¥çš„è¾¹ç•Œæ¡ä»¶ï¼Œè¦æ³¨æ„é¿å…ç¼“å­˜äº†ç©ºå€¼ï¼Œä½†ä¹Ÿå¹¶éæ‰€æœ‰ç©ºå€¼éƒ½ä¸èƒ½ç¼“å­˜ï¼ˆæ¯”å¦‚æœ‰äº›æ¥å£ç¡®å®å°±æ˜¯æœ‰å¯èƒ½è¿”å›ç©ºå€¼å˜›ï¼‰ï¼Œå…·ä½“çœ‹ä¸šåŠ¡ï¼Œæ²¡æœ‰ç»å¯¹çš„è¦ä¸ä¸è¦ï¼Œåæ­£ &lt;code>:reject_nil&lt;/code> ç»™ä½ äº†ï¼Œçœ‹ä½ è¦ä¸è¦&lt;/li>
&lt;/ul></description></item><item><title>Apdexâ€”â€”è¡¡é‡æœåŠ¡å™¨æ€§èƒ½çš„æ ‡å‡†</title><link>https://blog.hackerpie.com/posts/archive/the-correct-way-to-metric-server-response-time/</link><pubDate>Thu, 30 Jul 2015 12:12:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/the-correct-way-to-metric-server-response-time/</guid><description>&lt;p>æ—¥å¸¸å·¥ä½œä¸­ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¹ æƒ¯äºé€šè¿‡é‡åŒ–çš„æ ‡å‡†å»è¡¡é‡æˆ‘ä»¬å¯¹äº‹ç‰©çš„è¯„ä»·ï¼Œæ¯”å¦‚ç¾é£Ÿç‚¹è¯„çš„æ˜Ÿçº§ã€é…’åº—çš„æ˜Ÿçº§ã€æ¯ä¸ªä¸ªäººçš„ä¿¡ç”¨è¯„åˆ†ç­‰ç­‰ã€‚è€Œä½œä¸ºä¸€ä¸ª Web å·¥ç¨‹å¸ˆï¼Œæˆ‘ä»¬ä¹Ÿæ€»æ˜¯åœ¨æ„äºæˆ‘ä»¬ç½‘ç«™çš„æ€§èƒ½ï¼Œå› ä¸ºç½‘ç«™çš„æ€§èƒ½ä¼šæœ€ç›´æ¥åœ°å½±å“ç”¨æˆ·çš„ä½“éªŒã€‚ä»Šå¤©è¦ä»‹ç»çš„å°±æ˜¯ä¸€ç§åŒæ ·èƒ½å¤Ÿå¸®åŠ©å·¥ç¨‹å¸ˆå¯¹åº”ç”¨æ€§èƒ½è¿›è¡Œé‡åŒ–è¯„ä¼°çš„æ ‡å‡† â€”â€” Apdex ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>Apdex å…¨ç§°æ˜¯ Application Performance Indexï¼Œæ˜¯ç”± Apdex è”ç›Ÿå¼€æ”¾çš„ç”¨äºè¯„ä¼°åº”ç”¨æ€§èƒ½çš„å·¥ä¸šæ ‡å‡†ã€‚Apdex è”ç›Ÿèµ·æºäº 2004 å¹´ï¼Œç”± &lt;a href="http://apdex.org/bios.html">Peter Sevcik&lt;/a>å‘èµ·ã€‚Apdex æ ‡å‡†ä»ç”¨æˆ·çš„è§’åº¦å‡ºå‘ï¼Œå°†å¯¹åº”ç”¨å“åº”æ—¶é—´çš„è¡¨ç°ï¼Œè½¬ä¸ºç”¨æˆ·å¯¹äºåº”ç”¨æ€§èƒ½çš„å¯é‡åŒ–ä¸ºèŒƒå›´ä¸º 0-1 çš„æ»¡æ„åº¦è¯„ä»·ã€‚&lt;/p>
&lt;h3 id="æœ¯è¯­">æœ¯è¯­&lt;/h3>
&lt;p>Apdex å®šä¹‰äº†åº”ç”¨å“åº”æ—¶é—´çš„æœ€ä¼˜é—¨æ§›ä¸ºTï¼Œå¦å¤–æ ¹æ®åº”ç”¨å“åº”æ—¶é—´ç»“åˆ T å®šä¹‰äº†ä¸‰ç§ä¸åŒçš„æ€§èƒ½è¡¨ç°ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>Satisfiedï¼ˆæ»¡æ„ï¼‰&lt;/strong>ï¼šåº”ç”¨å“åº”æ—¶é—´ä½äºæˆ–ç­‰äº Tï¼ˆT ç”±æ€§èƒ½è¯„ä¼°äººå‘˜æ ¹æ®é¢„æœŸæ€§èƒ½è¦æ±‚ç¡®å®šï¼‰ï¼Œæ¯”å¦‚ T ä¸º 1.5sï¼Œåˆ™ä¸€ä¸ªè€—æ—¶ 1s çš„å“åº”ç»“æœåˆ™å¯ä»¥è®¤ä¸ºæ˜¯ satisfied çš„ã€‚&lt;/li>
&lt;li>&lt;strong>Toleratingï¼ˆå¯å®¹å¿ï¼‰&lt;/strong>ï¼šåº”ç”¨å“åº”æ—¶é—´å¤§äº Tï¼Œä½†åŒæ—¶å°äºæˆ–ç­‰äº 4Tã€‚å‡è®¾åº”ç”¨è®¾å®šçš„ T å€¼ä¸º 1sï¼Œåˆ™ 4 * 1 = 4 ç§’æä¸ºåº”ç”¨å“åº”æ—¶é—´çš„å®¹å¿ä¸Šé™ã€‚&lt;/li>
&lt;li>&lt;strong>Frustratedï¼ˆçƒ¦èºæœŸï¼‰&lt;/strong>ï¼šåº”ç”¨å“åº”æ—¶é—´å¤§äº 4Tã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="å…¬å¼">å…¬å¼&lt;/h3>
&lt;p>&lt;!-- raw HTML omitted -->Apdex&lt;!-- raw HTML omitted -->t&lt;!-- raw HTML omitted --> = (Satisfied Count + Tolerating Count / 2) / Total Samples&lt;!-- raw HTML omitted -->&lt;/p>
&lt;p>å…¶ä¸­ &lt;code>Satisfied Count&lt;/code> å°±æ˜¯æŒ‡å®šé‡‡æ ·æ—¶é—´å†…å“åº”æ—¶é—´æ»¡è¶³ &lt;code>Satisfied&lt;/code> è¦æ±‚çš„åº”ç”¨å“åº”æ¬¡æ•°ï¼›è€Œ &lt;code>Tolerating Count&lt;/code> å°±æ˜¯æŒ‡å®šé‡‡æ ·æ—¶é—´å†…å“åº”æ—¶é—´æ»¡è¶³ &lt;code>Tolerating&lt;/code> è¦æ±‚çš„åº”ç”¨å“åº”æ¬¡æ•°ï¼›æœ€åçš„ &lt;code>Total Samples&lt;/code> å°±æ˜¯æ€»çš„é‡‡æ ·æ¬¡æ•°æ€»æ•°ã€‚ä»å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨çš„ Apdex å¾—åˆ†ä¸é‡‡æ ·æŒç»­æ—¶é—´æ— å…³ï¼Œä¸ç›®æ ‡å“åº”æ—¶é—´ T ç›¸å…³ï¼ˆåœ¨é‡‡ç”¨æ€»æ•°å›ºå®šçš„æƒ…å†µä¸‹ï¼ŒT é€šè¿‡å½±å“ &lt;code>Satisfied Count&lt;/code>ä»¥åŠ &lt;code>Tolerating Count&lt;/code>çš„å€¼é—´æ¥å½±å“æœ€ç»ˆçš„å¾—åˆ†ï¼‰ã€‚&lt;/p>
&lt;p>ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾ä½ çš„åº”ç”¨æœŸå¾…çš„å“åº”æ—¶é—´èƒ½å¤Ÿåœ¨ 1000 ms å†…ï¼Œåœ¨ 100 æ¬¡é‡‡æ ·ä¸­ï¼Œæœ‰ 50 æ¬¡åº”ç”¨å“åº”æ—¶é—´ä½äº 1000 msï¼Œ30 æ¬¡åº”ç”¨å“åº”æ—¶é—´å¤„äº 1000 ms åˆ° 4000 msï¼ˆ 4 * 1000msï¼‰ ä¹‹é—´ï¼Œå‰©ä¸‹ 20 æ¬¡å“åº”æ—¶é—´é•¿äº 4000 msï¼Œé‚£ä¹ˆï¼Œè¯¥åº”ç”¨åœ¨ T = 1000ms çš„æƒ…å†µä¸‹çš„ Apdex å€¼ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>(50 + 30 / 2) / 100 = 0.65
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="apdex-ä¸-new-relic">Apdex ä¸ New Relic&lt;/h3>
&lt;p>åœ¨ New Relic çš„ APMï¼ˆApplication Performance Managementï¼‰åŠŸèƒ½ä¸­ï¼Œå°±æä¾›äº†å„ä¸ªç»´åº¦çš„ Apdex ç»Ÿè®¡ç»“æœï¼Œæ¯”å¦‚ Server Apdex(æœåŠ¡å™¨æ€§èƒ½è¯„åˆ†)ä»¥åŠ Browser Apdex(ç»ˆç«¯ç”¨æˆ·æ€§èƒ½ä½“éªŒè¯„åˆ†)ï¼Œå¦‚å›¾ï¼š
&lt;img src="http://7xj84e.com1.z0.glb.clouddn.com/blog/apdex%20overview.png" alt="Apdex ç»Ÿè®¡æŠ¥è¡¨(T=0.5s)">
&lt;/p>
&lt;p>å…¶ä¸­å¯ä»¥çœ‹åˆ°åº”ç”¨æœåŠ¡å™¨åœ¨ &lt;code>T=0.5s&lt;/code> çš„æƒ…å†µä¸‹å¾—åˆ°çš„ Apdex åˆ†æ•°ä¸º 0.76ï¼Œè€Œ Browserï¼ˆBrowser æ›´å¤šçš„æ˜¯é™æ€æ–‡ä»¶åŠ è½½ï¼‰ åœ¨ &lt;code>T=7s&lt;/code>çš„æƒ…å†µä¸‹å¾—åˆ°çš„ Apdex åˆ†æ•°ä¸º 0.94ã€‚ç»“åˆä¸¤è€…å¯ä»¥åˆ¤æ–­ï¼Œç›®å‰åº”ç”¨åˆ°è¾¾ç»ˆç«¯ç”¨æˆ·æ€§èƒ½è¡¨ç°æ¯”è¾ƒä¼˜ç§€ï¼ˆ0.94ï¼Œæ¯”è¾ƒæ¥è¿‘æœ€å¤§å€¼ 1ï¼‰ï¼Œä½†æ˜¯å…¶ä¸­å½±å“æ€»ä½“æ€§èƒ½çš„ç“¶é¢ˆåˆ™åœ¨äºæœåŠ¡å™¨æ€§èƒ½ï¼ˆä»…ä»…åªæœ‰ 0.76 åˆ†ï¼‰ï¼Œé€šè¿‡è¿™æ ·çš„æ•°æ®ï¼Œæˆ‘ä»¬å°±èƒ½çŸ¥é“ä¸‹ä¸€æ­¥æ€§èƒ½ä¼˜åŒ–çš„æ–¹å‘äº†â€”â€”æœåŠ¡å™¨ç«¯æ€§èƒ½ä¼˜åŒ–ã€‚&lt;/p>
&lt;p>å®é™…ä¸Šï¼Œä¸Šé¢å±•ç¤ºçš„åªæ˜¯ New Relic çš„ä¸€ç§ç²’åº¦æ¯”è¾ƒç²—çš„é’ˆå¯¹æ•´ä¸ªåº”ç”¨çš„ Apdex æŠ¥è¡¨ï¼ŒNew Relic åŒæ ·æä¾›äº†å¾ˆå¤šç»†ç²’åº¦çš„ Apdex æ•°æ®ï¼Œæ¯”å¦‚ä¸‹é¢å±•ç¤ºçš„é’ˆå¯¹å…·ä½“çš„è¯·æ±‚å…¥å£çš„ Apdex æŠ¥è¡¨ï¼š
&lt;img src="http://7xj84e.com1.z0.glb.clouddn.com/blog/detailed_apdex.png" alt="å…·ä½“è¯·æ±‚å…¥å£çš„ Apdex">
è¿™æ ·ï¼Œé€šè¿‡é€æ­¥çš„ç»†åŒ–ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›ä¸€æ­¥å®šä½æ€§èƒ½ç“¶é¢ˆï¼Œé€šè¿‡ä¸æ–­ä¼˜åŒ– Apdex è¯„åˆ†ä½çš„å…¥å£é€æ­¥æå‡åº”ç”¨æ•´ä½“æ€§èƒ½ä½“éªŒã€‚&lt;/p>
&lt;h3 id="apdex-ä¸-t-å€¼">Apdex ä¸ T å€¼&lt;/h3>
&lt;p>ä»å…¬å¼ä¸­å…¶å®å¯ä»¥éå¸¸æ˜æ˜¾åœ°çœ‹å‡ºæ¥ï¼ŒT å€¼çš„é€‰æ‹©å¯¹äºæœ€ç»ˆçš„ Apdex å€¼ä¹Ÿä¼šæœ‰ç›´æ¥å½±å“ï¼Œè¶Šå¤§çš„ T å€¼ç†è®ºä¸Šæ¥è¯´ä¼šæœ‰æ›´å¤§çš„ Apdex å¾—åˆ†ã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨ New Relic ä¸­å°†åº”ç”¨çš„ Apdex T å€¼æ”¹ä¸º 1sï¼Œä»¥ä¸‹æ˜¯è®¾å®šè¿‡ç¨‹ä¸­çœ‹åˆ°çš„åŸæ¥çš„å€¼æ˜¯ 0.5sï¼š
&lt;img src="http://7xj84e.com1.z0.glb.clouddn.com/blog/apdex%20setting.png" alt="T å€¼è®¾å®š">
è€Œæ”¹ä¸º 1s åï¼Œè·Ÿä¸Šé¢åŒæ ·çš„é‡‡æ ·æ•°æ®å¾—åˆ°çš„æ–°çš„å¹³å‡ Apdex å€¼åˆ™é«˜äºåŸæ¥çš„ 0.76ã€‚
æ‰€ä»¥ï¼Œåœ¨å¯¹åº”ç”¨æ€§èƒ½è¿›è¡Œè¯„ä¼°çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦ç¡®ä¿ç»“åˆåº”ç”¨å…·ä½“æƒ…å†µè®¾å®šä¸€ä¸ªç›¸å¯¹åˆç†çš„ T å€¼ï¼Œå¤ªå¤§çš„ T å€¼ä¼šå¯¼è‡´è¿‡äºä¹è§‚çš„ Apdex å€¼ï¼Œä½†æ˜¯å¤ªå°çš„ T å€¼åˆä¼šé€ æˆè¿‡äºä¸¥è‹›çš„æ€§èƒ½è¦æ±‚ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´è¿‡åº¦çš„æ€§èƒ½ä¼˜åŒ–ã€‚
æ‰€ä»¥ï¼Œæ€»è€Œè¨€ä¹‹ï¼ŒæŠ›å¼ƒ T å€¼è°ˆ Apdex å¾—åˆ†ï¼Œéƒ½æ˜¯è€æµæ°“ï¼&lt;/p>
&lt;h3 id="apdex-å€¼ä¸€å®šè¦åšåˆ°-1-å—">Apdex å€¼ä¸€å®šè¦åšåˆ° 1 å—ï¼Ÿ&lt;/h3>
&lt;p>Apdex å…¬å¼è®¡ç®—èƒ½å¤Ÿå¾—åˆ°çš„æœ€å¤§å€¼å°±æ˜¯ 1ï¼Œè¡¨ç¤ºåº”ç”¨â€œå¯èƒ½â€èƒ½å¤Ÿä»¤æ‰€æœ‰ç”¨æˆ·å¯¹åº”ç”¨æ€§èƒ½æ„Ÿåˆ°æ»¡æ„ã€‚ä½†æ˜¯ï¼Œ Apdex = 1 å¯ä»¥åªæ˜¯ä¸€ä¸ªä¸æ–­ä¼˜åŒ–çš„æ–¹å‘ï¼Œå´ä¸ä¸€å®šæ˜¯è¦æˆä¸ºä¼˜åŒ–çš„ç›®æ ‡ï¼Œå…·ä½“æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µç¡®å®šï¼Œæ¯•ç«Ÿï¼Œä¼˜åŒ–æœ¬èº«ä¹Ÿéœ€è¦æˆæœ¬æŠ•å…¥ï¼Œä¸éœ€è¦ä¸ºäº†æè‡´çš„æ€§èƒ½è€ŒæŠ•å…¥è¿‡å¤šçš„æˆæœ¬ã€‚&lt;/p>
&lt;h3 id="å‚è€ƒèµ„æ–™ä»¥åŠæ¨èé“¾æ¥">å‚è€ƒèµ„æ–™ä»¥åŠæ¨èé“¾æ¥&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="https://en.wikipedia.org/wiki/Apdex">Wikipedia: Apdex&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://www.apdex.org/">Apdex å®˜ç½‘&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.newrelic.com/docs/apm/new-relic-apm/apdex/apdex-measuring-user-satisfaction#what-is">Apdex: Measuring user satisfaction&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.newrelic.com/docs/apm/new-relic-apm/apdex/change-your-apdex-settings">New Relic: Change your Apdex settings&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.newrelic.com/docs/apm/new-relic-apm/apdex/view-your-apdex-score">New Relic: View your Apdex score&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>ç”³è¯·ä»¥åŠé›†æˆ Stripe çš„ Alipay æ”¯ä»˜æ–¹æ¡ˆ</title><link>https://blog.hackerpie.com/posts/archive/shen-qing-yi-ji-ji-cheng-stripe-de-alipay-zhi-fu-fang-an/</link><pubDate>Sat, 28 Mar 2015 12:12:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/shen-qing-yi-ji-ji-cheng-stripe-de-alipay-zhi-fu-fang-an/</guid><description>&lt;p>Â Â Â Â Â Â Â Â æœ€è¿‘åœ¨ä¸€ä¸ªé¡¹ç›®éœ€è¦æ”¯æŒäººæ°‘å¸æ”¯ä»˜ï¼Œå¹¶ä¸”å®¢æˆ·è¦æ±‚å¸Œæœ›èƒ½å¤Ÿæ”¶å®Œæ¬¾åçš„ç»“ç®—æ˜¯ç”¨ç¾å…ƒï¼Œæ‰€ä»¥å°±æƒ³åˆ°äº†å»å¹´ Stripe å®£å¸ƒå·²ç»è·Ÿæ”¯ä»˜å®è¾¾æˆåˆä½œæ„å‘ï¼Œæ‰€ä»¥ç»è¿‡ä¸€ç•ªå’¨è¯¢è·Ÿé›†æˆï¼Œç»ˆäºæŠŠ Stripe é›†æˆè¿›æ¥ï¼Œå¹¶ä¸”å¯ç”¨äº†æ”¯ä»˜å®æ”¶æ¬¾ã€‚è¿™ç¯‡æ–‡ç« ä»‹ç»åŠŸèƒ½ç”³è¯·ä»¥åŠé›†æˆçš„å®Œæ•´è¿‡ç¨‹ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2 id="åŠŸèƒ½ç”³è¯·">åŠŸèƒ½ç”³è¯·&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://dashboard.stripe.com/register">æ³¨å†Œ Stripe è´¦å·&lt;/a>ï¼›&lt;/li>
&lt;li>åŠ å…¥ &lt;a href="https://stripe.com/alipay">beta ç”¨æˆ·ç»„&lt;/a>ï¼Œç”µå­é‚®ç®±è·Ÿæ³¨å†Œçš„ Stripe è´¦å·ä¿æŒä¸€è‡´ï¼›&lt;/li>
&lt;li>è”ç³» Stripe å‘˜å·¥&lt;br>
å‘é€é‚®ä»¶åˆ° &lt;a href="mailto:support@stripe.com">support@stripe.com&lt;/a>ï¼Œå£°æ˜ä½ éœ€è¦åœ¨ä½ çš„ Stripe è´¦å·ä¸­å¯ç”¨ Alipay çš„æ”¯ä»˜åŠŸèƒ½ï¼Œå¹¶ä¸”æä¾›ä½ çš„ Stripe è´¦å·ã€‚ç„¶åï¼Œç­‰å¾…å›å¤å°±æ˜¯ï¼Œä¸€èˆ¬å½“å¤©éƒ½èƒ½æ”¶åˆ°å›å¤çš„ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="é›†æˆ">é›†æˆ&lt;/h2>
&lt;h3 id="0-æ—¶åºå›¾å¯ç»“åˆåè¾¹ä»£ç ä¸€èµ·ç†è§£">0. æ—¶åºå›¾(å¯ç»“åˆåè¾¹ä»£ç ä¸€èµ·ç†è§£)&lt;/h3>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/medias/stripe_checkout_flow.png" alt="Stripe æ”¯ä»˜æµç¨‹">
&lt;/p>
&lt;h3 id="1-å¼•å…¥-stripejs-ä»¥åŠåˆå§‹åŒ–è„šæœ¬">1. å¼•å…¥ stripe.js ä»¥åŠåˆå§‹åŒ–è„šæœ¬&lt;/h3>
&lt;p>å‡è®¾æ”¯ä»˜é¡µé¢ä¸Šæœ‰ä¸ªå¼€å§‹æ”¯ä»˜æŒ‰é’®ï¼Œå…¶ html ä»£ç ä¸º:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="font-weight:bold">button&lt;/span> id=&lt;span style="font-style:italic">&amp;#39;pay&amp;#39;&lt;/span>&amp;gt;æ”¯ä»˜&amp;lt;/&lt;span style="font-weight:bold">button&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯·åœ¨ html ä»£ç é‡Œåˆé€‚çš„åœ°æ–¹ï¼ˆæ¯”å¦‚&lt;code>&amp;lt;body&amp;gt;&lt;/code>æ ‡ç­¾çš„åº•éƒ¨ï¼‰åŠ è½½ stripe.jsï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="font-weight:bold">script&lt;/span> src=&lt;span style="font-style:italic">&amp;#34;https://checkout.stripe.com/checkout.js&amp;#34;&lt;/span>&amp;gt;&amp;lt;/&lt;span style="font-weight:bold">script&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è„šæœ¬ä¸­åˆå§‹åŒ– stripe.jsï¼Œå¹¶ä¸”æ³¨å†Œæ”¯ä»˜æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å‡½æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-js" data-lang="js">&lt;span style="display:flex;">&lt;span>$(&lt;span style="font-weight:bold">function&lt;/span>(){
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">var&lt;/span> stripeHandler = StripeCheckout.configure({
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> key: &lt;span style="font-style:italic">&amp;#39;pk_test_xxxxxxxxxxxxxxxxxxxxxxxx&amp;#39;&lt;/span>, &lt;span style="font-style:italic">// å¯ä»¥æŸ¥çœ‹ https://dashboard.stripe.com/account/apikeys
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> image: &lt;span style="font-style:italic">&amp;#39;https://placehold.it/200x200&amp;#39;&lt;/span>, &lt;span style="font-style:italic">// æ˜¾ç¤ºåœ¨æ”¯ä»˜å¯¹è¯æ¡†çš„å›¾ç‰‡ï¼Œå¯è‡ªå·±æŒ‡å®š
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> alipay: &lt;span style="font-weight:bold">true&lt;/span>, &lt;span style="font-style:italic">// å¯ç”¨æ”¯ä»˜å®æ”¯ä»˜
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> token: &lt;span style="font-weight:bold">function&lt;/span>(token){ &lt;span style="font-style:italic">// ç”¨æˆ·å¡«å†™å®Œèµ„æ–™å¹¶ä¸” Stripe æ ¡éªŒæˆåŠŸåçš„å›è°ƒå‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">// æ­¤æ—¶åº”è¯¥æäº¤ token.id åˆ°åå°ï¼Œæ¯”å¦‚ http://example.com/orders/1?stripeToken={token.id}
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> })
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> $(&lt;span style="font-style:italic">&amp;#39;#pay&amp;#39;&lt;/span>).click(&lt;span style="font-weight:bold">function&lt;/span>(){
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> stripeHandler.open({
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: &lt;span style="font-style:italic">&amp;#39;Business Name&amp;#39;&lt;/span>, &lt;span style="font-style:italic">// æ”¶æ¬¾æ–¹æˆ–å•†å®¶åç§°ï¼Œæ¯”å¦‚ Beansmile
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> description: &lt;span style="font-style:italic">&amp;#34;å•†å“æè¿°å†…å®¹&amp;#34;&lt;/span>, &lt;span style="font-style:italic">// å¾…æ”¯ä»˜å•†å“çš„æè¿°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> amount: 50 * 100, &lt;span style="font-style:italic">// æ”¯ä»˜é‡‘é¢ï¼Œå•ä½æ˜¯â€œåˆ†â€
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> opened: &lt;span style="font-weight:bold">function&lt;/span>(){ &lt;span style="font-style:italic">// æ”¯ä»˜å¯¹è¯æ¡†æ‰“å¼€åçš„å›è°ƒå‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">// Do something
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>});
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="2-é€šè¿‡-token-è¯·æ±‚æ”¶æ¬¾">2. é€šè¿‡ token è¯·æ±‚æ”¶æ¬¾&lt;/h3>
&lt;p>æœåŠ¡å™¨ç«¯æ˜¯ Ruby on Rails å®ç°ï¼Œæ‰€ä»¥åœ¨ Gemfile ä¸­å¼•å…¥ Stripe å®˜æ–¹çš„ Ruby SDK(å…·ä½“é…ç½®æ–¹æ³•è¯·è‡ªè¡ŒæŸ¥é˜…å…¶ README)ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Gemfile&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Stripe Ruby bindings&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># https://github.com/stripe/stripe-ruby&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#34;stripe&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;~&amp;gt; 1.20.1&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååœ¨ Controller action ä¸­æ·»åŠ å¤„ç†é€»è¾‘:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># app/controllers/orders_controller.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">OrdersController&lt;/span> &amp;lt; ApplicationController
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># PUT /orders/:id&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># params:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># id: è®¢å•çš„ id&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># stripeToken: å®¢æˆ·ç«¯å®Œæˆæ”¯ä»˜æµç¨‹ï¼Œåœ¨è„šæœ¬çš„å›è°ƒå‡½æ•°ä¸­ä¼šå¾—åˆ° `token.id`ï¼Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># å°†å…¶ä¸Šä¼ åˆ° `stripeToken` å‚æ•°ï¼ŒæœåŠ¡å™¨ç«¯ç”¨æ­¤ token è¯·æ±‚æ”¶æ¬¾&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> pay
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> response = Stripe::Charge.create &lt;span style="font-style:italic">amount&lt;/span>: order.amount_in_cents,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">currency&lt;/span>: &lt;span style="font-style:italic">&amp;#39;USD&amp;#39;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">source&lt;/span>: params[&lt;span style="font-style:italic">:stripeToken&lt;/span>],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">description&lt;/span>: &lt;span style="font-style:italic">&amp;#34;è®¢å•æè¿°&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> order.update_attribute &lt;span style="font-style:italic">:state&lt;/span>, &lt;span style="font-style:italic">:paid&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> redirect_to order
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Stripe::InvalidRequestError =&amp;gt; error
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flash[&lt;span style="font-style:italic">:error&lt;/span>] = &lt;span style="font-style:italic">&amp;#34;ç”±äº&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>error.message&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">ï¼Œæ”¯ä»˜å¤±è´¥ï¼&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> redirect_to order
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="3-æ•ˆæœé¢„è§ˆ">3. æ•ˆæœé¢„è§ˆ&lt;/h3>
&lt;p>
&lt;img src="https://blog.hackerpie.com/images/medias/stripe.gif" alt="stripe æ”¯ä»˜æµç¨‹æ¼”ç¤º">
&lt;/p>
&lt;h2 id="å…¶ä»–">å…¶ä»–&lt;/h2>
&lt;ol>
&lt;li>å…³äº Stripe çš„æ²™ç›’æœºåˆ¶&lt;br>
Stripe ä¸ºæ¯ä¸ªè´¦å·éƒ½æä¾›äº†&lt;a href="https://dashboard.stripe.com/account/apikeys">ä¸¤ç»„ keys&lt;/a>ï¼Œä¸€ç»„ key ç”¨äºç”¨äº live ç¯å¢ƒï¼Œå¦ä¸€ç»„æ˜¯ test ç¯å¢ƒï¼Œåè€…å³æ˜¯æ²™ç›’ç¯å¢ƒï¼Œè€Œé’ˆå¯¹æ”¯ä»˜å®çš„æ²™ç›’ï¼Œå¯ç”¨ä»»æ„åˆæ³•çš„é‚®ç®±è´¦å·è¿›è¡Œæµ‹è¯•ï¼Œä½†éªŒè¯ç æ˜¯å›ºå®šçš„ 123456ï¼Œè€Œèº«ä»½è¯å 6 ä½æ˜¯å›ºå®šçš„ 12345ï¼›&lt;/li>
&lt;li>åœ¨åŠŸèƒ½ç”³è¯·è¿‡ç¨‹ä¸­ï¼Œä¸€å®šè¦è®°å¾—å®Œæˆæ­¥éª¤3â€”â€”è”ç³» Stripe å¼€é€š Alipay æ”¯ä»˜åŠŸèƒ½ã€‚å¦åˆ™ï¼Œä¼šåœ¨æ”¯ä»˜çš„æ—¶å€™å‡ºç°é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯ç¤ºä¾‹ä¸ºï¼š&lt;code>There is no token with ID atok_xxxxxxxxxxxxxxxxxxxxxxxx&lt;/code>&lt;/li>
&lt;li>å®é™…å¼€å‘ä¸­ï¼Œè¯·ç»“åˆè€ƒè™‘ç”¨ stripe æä¾›çš„ &lt;a href="https://dashboard.stripe.com/account/webhooks">webhook&lt;/a> å¤„ç†æ”¯ä»˜çŠ¶æ€å˜è¿ï¼›&lt;/li>
&lt;li>æ­¤æ”¯ä»˜æœºåˆ¶ä¸­ï¼Œä»˜æ¬¾äººå¯ç”¨äººæ°‘å¸æ”¯ä»˜ï¼Œä½†æ˜¯ Stripe ä¼šç”¨ç¾å…ƒè·Ÿå•†å®¶ï¼ˆæ”¶æ¬¾æ–¹ï¼‰è¿›è¡Œç»“ç®—ï¼›&lt;/li>
&lt;li>æˆ‘æ€»ç»“äº†å·¥ä½œä¸­é›†æˆè¿‡çš„å…¶ä»–å‡ æ¬¾æ”¯ä»˜ç½‘å…³ï¼Œæ¨ªå‘å¯¹æ¯”äº†å„å®¶çš„å¼‚åŒç‚¹ï¼Œæœ‰å…´è¶£çš„è¯·æˆ³ï¼š&lt;a href="http://jianggaowang.com/slides/67">è®²ç¨¿ç½‘ï¼šPayment Gateways&lt;/a>&lt;/li>
&lt;/ol>
&lt;h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="https://stripe.com/alipay">Stripe: Alipay é¦–é¡µ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stripe.com/press/alipay">Stripe: Alipay FAQ&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stripe.com/docs/guides/alipay-beta">Stripe: Alipay é›†æˆæ–‡æ¡£&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://stripe.com/docs/checkout">Stripe: Checkout&lt;/a>ï¼Œè¿™éƒ¨åˆ†çš„æ–‡æ¡£è™½ç„¶æ²¡æœ‰æäº¤ Alipay, ä½†æ˜¯é’ˆå¯¹ Alipay çš„é›†æˆï¼Œä¾æ—§é€‚ç”¨ã€‚&lt;/li>
&lt;/ol></description></item><item><title>How do I fix Passenger application startup problem</title><link>https://blog.hackerpie.com/posts/archive/how-do-i-fix-passenger-application-startup-problem/</link><pubDate>Sat, 10 Jan 2015 01:54:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/how-do-i-fix-passenger-application-startup-problem/</guid><description>&lt;p>Recent days I was working on deploying one of my Rails project on a complete new VPS. I had operated according to my experience for deploying sites before, but at the last step, after I have deployed the site, it always raised error message &amp;ldquo;An error occurred while starting up the preloader: it did not write a startup response in time.&amp;rdquo; when I try to visit the site. But, thanks to much hard work and retry, I found the source of the problem and finally fix it.&lt;/p>
&lt;p>I will spend short time to show the main steps to resolve the problem. Let&amp;rsquo;s GO!&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2 id="what-does-the-error-message-mean">What Does The Error Message Mean?&lt;/h2>
&lt;p>According the official wiki of &lt;a href="https://github.com/phusion/passenger/wiki/Debugging-application-startup-problems">Passenger&lt;/a> on Github:&lt;/p>
&lt;blockquote>
&lt;p>Phusion Passenger reports this error if the application did not finish initializing within a time limit, or if it exited without sending Phusion Passenger a message that says &amp;ldquo;I&amp;rsquo;ve initialized successfully!&amp;rdquo;&lt;/p>
&lt;/blockquote>
&lt;p>That is, &lt;strong>TWO&lt;/strong> things are expected that our application should:&lt;/p>
&lt;ul>
&lt;li>response a message to notify Passenger that itself is ready&lt;/li>
&lt;li>response within a time limit&lt;/li>
&lt;/ul>
&lt;p>otherwise Passenger will regard the application has been failed to startup and hence report error.&lt;/p>
&lt;h2 id="possible-causes-of-problem">Possible Causes Of Problem&lt;/h2>
&lt;p>According &lt;a href="https://github.com/phusion/passenger/wiki/Debugging-application-startup-problems#possible-causes-of-problems">&amp;ldquo;Possible causes of problems&amp;rdquo;&lt;/a> section in the above wiki, we can conclude that there will be the below four causes:&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://github.com/phusion/passenger/wiki/Debugging-application-startup-problems#stdout-redirection">Stdout redirection&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/phusion/passenger/wiki/Debugging-application-startup-problems#early-termination-in-bash">Early termination in bash&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/phusion/passenger/wiki/Debugging-application-startup-problems#application-startup-freeze">Application startup freeze&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/phusion/passenger/wiki/Debugging-application-startup-problems#server-too-busy">Server too busy&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="how-i-refused-impossible-causes">How I Refused Impossible Causes&lt;/h2>
&lt;p>For the first possible cause, I can not find any STDOUT redirection in all my bash init scripts, so I trust there is no redirection in my server.&lt;/p>
&lt;p>For the second one, I had tried to config to disable the loading of bashrc, but it still didn&amp;rsquo;t work, so the second cause is not the cause.&lt;/p>
&lt;p>The third one is impossible because I had built the application on other servers successfully, it seems that the cause was not from the application itself.&lt;/p>
&lt;h2 id="the-true-evil-found">The True Evil Found&lt;/h2>
&lt;p>For the last one possible cause, I tried to run &lt;code>top&lt;/code> command in shell of the server to determine if CPU or disk is busy, and I found a interesting thing: everytime I visit the site, the CPU usage was up to &amp;gt; 80%, even 90% - 100%, and after about one and half minutes, the browser rendered a rails &amp;ldquo;Something went wrong&amp;rdquo; page and meantime the CPU usage was back to &amp;lt;10%.&lt;/p>
&lt;p>I then check the explanation from Passenger again:&lt;/p>
&lt;blockquote>
&lt;p>It could also be that your server is so busy doing something (either CPU-wise or disk-wise) that it fails to start an application process within a reasonable amount of time. The default startup limit is 90 seconds.&lt;/p>
&lt;/blockquote>
&lt;p>Aha, looks like the time limit is the evil. So I decided to try to change the timeout to a longer time, such as 300 seconds.&lt;/p>
&lt;p>In my passenger module config file &lt;code>/etc/apache2/mods-available/passenger.conf&lt;/code>(more details about why this file, see &lt;a href="https://www.phusionpassenger.com/documentation/Users%20guide%20Apache.html#working_with_apache_conf">Passenger Guide: Working with the Apache configuration file&lt;/a>), I explicitly append:&lt;/p>
&lt;pre tabindex="0">&lt;code>PassengerStartTimeout 300
&lt;/code>&lt;/pre>&lt;p>After that, I tried to restart my Apache2 server and deploy again, and Passenger waited for startup within a longer time this time, and hence my application was lastly deployed successfully.&lt;/p></description></item><item><title>åœ¨ coding.net ä¸Šéƒ¨ç½² Jekyll åšå®¢</title><link>https://blog.hackerpie.com/posts/archive/zai-coding-dot-netshang-bu-shu-jekyllbo-ke/</link><pubDate>Sat, 20 Dec 2014 12:59:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/zai-coding-dot-netshang-bu-shu-jekyllbo-ke/</guid><description>&lt;p>è‡ªä» &lt;a href="https://ruby-china.org/topics/22858">coding æ¨å‡º PaaS æ¼”ç¤ºå¹³å°ä»¥åŠå¼€æ”¾è‡ªå®šä¹‰åŸŸå&lt;/a>ä¹‹åï¼Œå¾ˆå¤šäººå¼€å§‹å°è¯•åœ¨ coding ä¸Šéƒ¨ç½²è‡ªå·±çš„åšå®¢ï¼Œå…¶ä¸­å°±æœ‰ &lt;a href="http://jekyllrb.com/">jekyll&lt;/a>ï¼Œcoding ä¸Šå°±æœ‰å®˜æ–¹æ¨èçš„ &lt;a href="https://coding.net/u/chenwj233/p/jekyll-demo/git">jekyll-demo&lt;/a>ã€‚ä½†æ˜¯å› ä¸ºè¿™ä¸ª Demo çš„ README æ–‡æ¡£ä¸­åªæ˜¯ç®€å•ä»‹ç»é…ç½®æ­¥éª¤è€Œå·²ï¼Œæ²¡æœ‰è¯¦ç»†ä»‹ç»åŸç†ä»¥åŠçµæ´»é…ç½®çš„åœ°æ–¹ï¼Œæˆ‘åœ¨å‚ç…§ç€è¿ç§» jekyll åšå®¢çš„è¿‡ç¨‹ä¸­ä¹Ÿé‡åˆ°ä¸€äº›é—®é¢˜ã€‚ç°åœ¨å†™ä¸‹æ–‡ç« ï¼Œå¸Œæœ›èƒ½å¤ŸæŠŠåŸç†ç†æ¸…æ¥šã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>**å£°æ˜ï¼š**è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯å¯¹åŸæ¥çš„ Demo çš„å‡ ä¸ªä¸»è¦æ€è·¯åšä¸€ä¸ªè¡¥å……è¯´æ˜ï¼Œè€Œå¹¶é coding æ¼”ç¤ºå¹³å°ä½¿ç”¨æ“ä½œçš„è¯¦ç»†æ•™ç¨‹ï¼Œæ‰€ä»¥åœ¨æœ‰äº›ç»†èŠ‚ä¸Šä¸ä¸€å®šè¦†ç›–åˆ°ï¼Œå»ºè®®æœ€ç»ˆçš„éƒ¨ç½²ä»£ç éœ€è¦ä»¥å®˜æ–¹æ¨èçš„ repo é‡Œçš„ä»£ç ä¸ºä¸»ã€‚&lt;/p>
&lt;h2 id="åŸºæœ¬åŸç†">åŸºæœ¬åŸç†&lt;/h2>
&lt;p>å› ä¸º Coding æä¾›çš„æ¼”ç¤ºå¹³å°æ˜¯é€šç”¨çš„ PaaS å¹³å°ï¼Œå¹¶éç±»ä¼¼ Github æˆ–è€… Gitcafe çš„ Pages æœåŠ¡ï¼Œæ‰€ä»¥ jekyll éƒ¨ç½²åˆ°æ¼”ç¤ºå¹³å°éœ€è¦è§£å†³ä¸‰ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;p>&lt;strong>1. è¿è¡Œé—®é¢˜&lt;/strong>ï¼Œblog éœ€è¦ä»¥å¸¸è§„ Web ç¨‹åºçš„æ–¹å¼è¿è¡Œï¼›&lt;br>
&lt;strong>2. å¯åŠ¨è„šæœ¬&lt;/strong>ï¼Œéƒ¨ç½²å®Œæˆåè‡ªåŠ¨å¯åŠ¨æœåŠ¡å™¨ï¼›&lt;br>
&lt;strong>3. è‡ªåŠ¨æ›´æ–°&lt;/strong>ï¼Œblog å†…å®¹æ›´æ–° push åèƒ½å¤Ÿè‡ªåŠ¨ç”Ÿæˆæ–°çš„é¡µé¢ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡ &lt;a href="https://github.com/adaoraul/rack-jekyll">rack-jekyll&lt;/a> è§£å†³ï¼›ç¬¬äºŒä¸ªé—®é¢˜é€šè¿‡ Coding çº¦å®šçš„ &lt;code>Procfile&lt;/code> æ–‡ä»¶è§£å†³ï¼›ç¬¬ä¸‰ä¸ªé—®é¢˜æˆ‘ä»¬é€šè¿‡ Coding çš„ &lt;a href="https://coding.net/help/about_git/what_is_web_hook">Webhook&lt;/a> ç»“åˆè„šæœ¬è§£å†³ã€‚&lt;/p>
&lt;h3 id="1-å°†-jekyll-åšå®¢å˜ä¸ºä¸€ä¸ªåœ¨çº¿è¿è¡Œçš„-rack-ç¨‹åº">1. å°† Jekyll åšå®¢å˜ä¸ºä¸€ä¸ªåœ¨çº¿è¿è¡Œçš„ Rack ç¨‹åº&lt;/h3>
&lt;p>Jekyll åŸæœ¬æ˜¯ä¸€ä¸ªç”¨äºç”Ÿæˆé™æ€åšå®¢ç«™ç‚¹çš„æ¡†æ¶ï¼Œä½†æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨ coding æ¼”ç¤ºå¹³å°ä¸Šç›´æ¥è¿è¡Œ Jekyll åšå®¢ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿåœ¨ &lt;a href="http://unicorn.bogomips.org/">Unicorn&lt;/a> æœåŠ¡å™¨ä¸Šè¿è¡Œ Jekyll çš„æ–¹æ³•ã€‚é€šè¿‡åŸæ¥ coding æä¾›çš„ Demoï¼Œæ‰¾åˆ°äº†ä¸€ä¸ªå« &lt;a href="https://github.com/adaoraul/rack-jekyll">rack-jekyll&lt;/a> çš„å·¥å…·ã€‚&lt;/p>
&lt;p>rack-jekyll ä¸»è¦çš„åŠŸèƒ½å¦‚å…¶ä»‹ç»ï¼š&lt;/p>
&lt;blockquote>
&lt;p>Transform your Jekyll app into Rack application!&lt;/p>
&lt;/blockquote>
&lt;p>å°±æ˜¯å°† Jekyll ä½œä¸º &lt;a href="http://rack.github.io/">Rack&lt;/a> ç¨‹åºè¿è¡Œã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œä¸ºäº†èƒ½å¤Ÿä½¿ç”¨ rack-jekyll ä»¥åŠ unicornï¼Œæˆ‘ä»¬åœ¨ &lt;code>Gemfile&lt;/code> æ–‡ä»¶(å¦‚æœæ²¡æœ‰åˆ™ç›´æ¥æ–°å»ºå³å¯)ä¸­åŠ å…¥:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#34;rack-jekyll&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#34;unicorn&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸¤è¡Œï¼Œç„¶åæ‰§è¡Œ &lt;code>bundle install&lt;/code> è¿™æ ·ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä¸­å°±æˆåŠŸå¼•å…¥ &lt;code>rack-jekyll&lt;/code> ä»¥åŠ &lt;code>unicorn&lt;/code> äº†ã€‚&lt;/p>
&lt;p>å…¶æ¬¡ï¼Œå› ä¸º unicorn é»˜è®¤ä¼šä»é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ &lt;code>config.ru&lt;/code> æ–‡ä»¶å¯åŠ¨ï¼Œå†ç»“åˆ &lt;a href="https://github.com/adaoraul/rack-jekyll#how-to-use-it">rack-jekyll çš„ä½¿ç”¨è¯´æ˜&lt;/a> ï¼Œæˆ‘ä»¬åœ¨ jekyll é¡¹ç›®æ ¹ç›®å½•ä¸‹è¦åˆ›å»ºä¸€ä¸ªåŒ…å«ä»¥ä¸‹å†…å®¹çš„æ–‡ä»¶ï¼Œå¹¶ä¸”åå­—å°±æ˜¯ &lt;code>config.ru&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># config.ru&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>require &lt;span style="font-style:italic">&amp;#34;rack/jekyll&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>run Rack::Jekyll.new
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ°æ­¤ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­ cd åˆ°å½“å‰é¡¹ç›®æ ¹ç›®å½•ï¼Œæ‰§è¡Œ &lt;code>jekyll build&lt;/code> ç”Ÿæˆç«™ç‚¹ï¼Œç„¶åå†æ‰§è¡Œ &lt;code>unicorn&lt;/code> ä»é»˜è®¤é…ç½®å¯åŠ¨æœåŠ¡å™¨ï¼ŒæˆåŠŸå¯åŠ¨åï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®â€œ http://127.0.0.1:8080 â€å°±å¯ä»¥çœ‹åˆ°åšå®¢äº†ã€‚&lt;/p>
&lt;h3 id="2-æ·»åŠ ç”¨äº-coding-æ¼”ç¤ºå¹³å°çš„å¯åŠ¨è„šæœ¬">2. æ·»åŠ ç”¨äº Coding æ¼”ç¤ºå¹³å°çš„å¯åŠ¨è„šæœ¬&lt;/h3>
&lt;p>ä¸Šé¢ç¬¬ä¸€æ­¥åªæ˜¯è§£å†³äº† Jekyll èƒ½å¤Ÿä»¥ Rack æ–¹å¼è¿è¡Œçš„é—®é¢˜è€Œå·²ï¼Œä½†æ˜¯ä¸ºäº†éƒ¨ç½²åˆ° coding åï¼Œé¡¹ç›®èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åŠ å…¥å¯åŠ¨å‘½ä»¤ã€‚&lt;/p>
&lt;p>æŒ‰ç…§ &lt;a href="http://docs.coding.io/ruby.html#%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4">coding åœ¨å…³äº Ruby éƒ¨åˆ†çš„æ¼”ç¤ºå¹³å°æ–‡æ¡£&lt;/a> ä¸­çš„ä»‹ç»å¾—çŸ¥ï¼Œcoding ä¼šæŸ¥æ‰¾é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ &lt;code>Procfile&lt;/code> æ–‡ä»¶ï¼Œå¹¶å°†é‡Œè¾¹çš„å†…å®¹ä½œä¸ºå¯åŠ¨å‘½ä»¤ï¼Œå½“æ­¤æ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼Œåˆ™å°†é»˜è®¤ä½¿ç”¨ä¸€ä¸‹å¯åŠ¨å‘½ä»¤ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">web&lt;/span>: bundle exec rackup config.ru -p $PORT
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŒ‰ç…§é»˜è®¤å¯åŠ¨å‘½ä»¤çš„æ ¼å¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å†™å‡ºä»¥ä¸‹ &lt;code>Procfile&lt;/code> æ–‡ä»¶ï¼Œç”¨äºéƒ¨ç½²åä» unicorn å¯åŠ¨é¡¹ç›®ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">web&lt;/span>: bundle exec unicorn -p $PORT -c ./unicorn.rb
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæˆå‰é¢ä¸¤æ­¥ä¹‹åï¼Œå°†ä»£ç  push åˆ° coding ä¸Šï¼Œå†ä»æ¼”ç¤ºå¹³å°ä¸€é”®éƒ¨ç½²çš„è¯ï¼Œå°±åº”è¯¥å¯ä»¥æˆåŠŸå¯åŠ¨ unicorn æœåŠ¡å™¨ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®¿é—®ä½ çš„ jekyll åšå®¢äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœ‰äº†æ–°æ–‡ç« å‘¢ï¼Ÿæ€ä¹ˆè‡ªåŠ¨åœ¨ç«™ç‚¹æ”¹åŠ¨åé‡æ–°ç”Ÿæˆç«™ç‚¹ï¼Ÿ&lt;/p>
&lt;h3 id="3-ä½¿ç”¨-webhook-åœ¨-push-åè‡ªåŠ¨é‡æ–°ç”Ÿæˆç«™ç‚¹å†…å®¹">3. ä½¿ç”¨ Webhook åœ¨ push åè‡ªåŠ¨é‡æ–°ç”Ÿæˆç«™ç‚¹å†…å®¹&lt;/h3>
&lt;p>coding ä¸ºç”¨æˆ·æä¾›äº† &lt;a href="https://coding.net/help/about_git/what_is_web_hook">webhook&lt;/a> åŠŸèƒ½ï¼Œæ–¹ä¾¿ç”¨æˆ·åœ¨ push ä»£ç æ”¹åŠ¨åè‡ªåŠ¨ POST è¯·æ±‚ä½ æŒ‡å®šçš„ Web URLï¼Œä½ å¯ä»¥åˆ©ç”¨è¿™ä¸ª URL åœ¨ç¨‹åºåå°å®Œæˆç¨‹åºçš„è‡ªåŠ¨éƒ¨ç½²ç­‰æ“ä½œã€‚æ›´å¤šçš„ä»‹ç»è·Ÿä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒ &lt;a href="https://coding.net/help/about_git/about_web_hook_content">&amp;ldquo;WebHook çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ&amp;rdquo;&lt;/a> ä»¥åŠ &lt;a href="https://coding.net/help/about_git/what_is_web_hook">&amp;ldquo;WebHook æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘è¯¥å¦‚ä½•ä½¿ç”¨ï¼Ÿ&amp;rdquo;&lt;/a>ã€‚&lt;/p>
&lt;p>ä¸ºäº†å¢åŠ æ–°çš„å…¥å£ä»¥æ¥æ”¶ coding çš„ Webhook é€šçŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ &lt;code>config.ru&lt;/code> ä¸­æ·»åŠ æ–°çš„è·¯ç”±ï¼Œå¹¶ä¸”æ·»åŠ å“åº”çš„å¤„ç†è„šæœ¬ï¼Œè¿™éƒ¨åˆ†çš„å†…å®¹æˆ‘å…ˆç›´æ¥æ‹·è´å®˜æ–¹æ¨èçš„ &lt;a href="https://coding.net/u/chenwj233/p/jekyll-demo/git/raw/master/config.ru">jekyll demo çš„ä»£ç &lt;/a> åå†åšå¿…è¦çš„è§£è¯»ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code># config.ru
require &amp;#34;bundler/setup&amp;#34;
Bundler.require(:default)
WEBHOOK_TOKEN = ENV[&amp;#39;WEBHOOK_TOKEN&amp;#39;]
app = Proc.new do |env|
request = Rack::Request.new(env)
response = Rack::Response.new
path_info = request.path_info
if request.content_type =~ /application\/json/
params = JSON.parse(request.body.read)
else
params = request.params
end
if request.post? &amp;amp;&amp;amp; params[&amp;#39;token&amp;#39;] == WEBHOOK_TOKEN
repo_url = params[&amp;#39;repository&amp;#39;][&amp;#39;url&amp;#39;] rescue nil
if repo_url
archive_url = &amp;#34;#{repo_url}/archive/master&amp;#34;
puts &amp;#34;--&amp;gt; updating to #{params[&amp;#39;ref&amp;#39;]}..&amp;#34;
puts `jekyll build`
`rm -rf $HOME/_posts; curl -s -L -o $TMPDIR/archive.zip #{archive_url}; unzip -qo -d $HOME $TMPDIR/archive.zip; cd $HOME; jekyll build`
puts &amp;#34;--&amp;gt; done.&amp;#34;
else
STDERR.puts &amp;#34;--&amp;gt; error: no url field found in params: #{params}&amp;#34;
end
[&amp;#39;200&amp;#39;, { &amp;#39;Conetent-Type&amp;#39; =&amp;gt; &amp;#39;application/json;charset=utf-8&amp;#39; }, [&amp;#39;ok&amp;#39;]]
else
[&amp;#39;403&amp;#39;, { &amp;#39;Conetent-Type&amp;#39; =&amp;gt; &amp;#39;application/json;charset=utf-8&amp;#39; }, [{ error: &amp;#39;webhook token mismatch!&amp;#39; }.to_json]]
end
end
jekyll = Rack::Jekyll.new(auto: true)
run Rack::URLMap.new(&amp;#39;/&amp;#39; =&amp;gt; jekyll, &amp;#39;/_&amp;#39; =&amp;gt; app)
&lt;/code>&lt;/pre>&lt;p>é¦–å…ˆï¼Œç¨‹åºåœ¨å¯åŠ¨æ—¶ï¼ŒæŒ‡å®šäº†ä¸¤ä¸ªè·¯ç”±å…¥å£åˆ†åˆ«æŒ‡å‘ä¸åŒçš„åå°ç¨‹åºï¼Œå…¶ä¸­ &lt;code>'/'&lt;/code> è·¯å¾„æŒ‡å‘äº†æˆ‘ä»¬çš„ &lt;code>jekyll&lt;/code> ç¨‹åºï¼Œè¿™ä¸ªè·ŸåŸæ¥çš„é…ç½®ç›®çš„ä¸€è‡´ï¼›è€Œ &lt;code>'/_'&lt;/code> è·¯å¾„æŒ‡å‘äº† &lt;code>app&lt;/code> è¿™ä¸ªç¨‹åºã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œå½“æœ‰å¤–éƒ¨å‘æœåŠ¡å™¨å‘é€äº†ä¸€ä¸ªæŒ‡å‘ &amp;ldquo;/&lt;em>&amp;rdquo; è·¯å¾„ï¼ˆæ¯”å¦‚â€œ &lt;a href="http://test.codingapp.com/">http://test.codingapp.com/&lt;/a>&lt;/em> â€ï¼‰çš„è¯·æ±‚æ—¶ï¼ŒæœåŠ¡å™¨åœ¨å†…éƒ¨å¯åŠ¨äº† &lt;code>app&lt;/code> çš„è„šæœ¬ã€‚ï¼ˆæ³¨æ„ï¼Œå¦‚æœä½ å¸Œæœ›ä½¿ç”¨åˆ«çš„è·¯å¾„åæ¥é…ç½® webhook çš„å…¥å£ï¼Œåªè¦å°†ä¸‹åˆ’çº¿æ”¹æˆä½ éœ€è¦çš„è·¯å¾„å³å¯ï¼Œæ¯”å¦‚ï¼š &amp;ldquo;&lt;a href="http://test.codingapp.com/deploy%22">http://test.codingapp.com/deploy&amp;quot;&lt;/a>ï¼‰ã€‚&lt;/p>
&lt;p>&lt;code>app&lt;/code> è„šæœ¬é¦–å…ˆé€šè¿‡è¯·æ±‚çš„ &lt;code>Content-Type&lt;/code> å¤´ä¿¡æ¯åˆ¤æ–­è¯·æ±‚æ ¼å¼ï¼Œå¹¶æ®æ­¤ä»è¯·æ±‚ä¸­æå–è¯·æ±‚å‚æ•°èµ‹ç»™ &lt;code>params&lt;/code> å˜é‡ï¼›æ¥ç€è„šæœ¬éªŒè¯è¯·æ±‚çš„åˆæ³•æ€§ï¼Œè¦æ±‚è¯·æ±‚å¿…é¡»æ˜¯ POST æ–¹å¼ï¼Œå¹¶ä¸”å‚æ•°ä¸­çš„ &lt;code>token&lt;/code> å‚æ•°çš„å€¼å¿…é¡»ä¸æˆ‘ä»¬åœ¨ coding åå°ä¸­é…ç½®çš„ token ä¸€è‡´ã€‚&lt;/p>
&lt;p>æœ€åï¼Œåœ¨ç¡®è®¤è¯·æ±‚çš„åˆæ³•æ€§åï¼Œè„šæœ¬å…ˆæ¸…ç©ºäº†å½“å‰éƒ¨ç½²çš„é¡¹ç›®ï¼Œç„¶åä¸‹è½½è§£å‹æŒ‡å®šåˆ†æ”¯çš„æœ€æ–°ä»£ç ï¼Œå¹¶ä¸”è¿›å…¥é¡¹ç›®æ ¹ç›®å½•(&lt;code>$HOME&lt;/code>ç¯å¢ƒå˜é‡)é‡æ–°æ‰§è¡Œäº† &lt;code>jekyll build&lt;/code> å‘½ä»¤ä»¥é‡æ–°ç”Ÿæˆé™æ€ç«™ç‚¹ï¼Œè§ä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">`rm -rf $HOME/_posts; curl -s -L -o $TMPDIR/archive.zip &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>archive_url&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">; unzip -qo -d $HOME $TMPDIR/archive.zip; cd $HOME; jekyll build`&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å…¶ä¸­å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ&lt;code>archive_url&lt;/code>æ˜¯åœ¨å‰é¢ä»£ç ä¸­æ‹¼æ¥è€Œæ¥çš„é“¾æ¥ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>archive_url = &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>repo_url&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">/archive/master&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯·æ³¨æ„å…¶ä¸­ç¡¬ç¼–ç çš„éƒ¨åˆ† &lt;code>&amp;quot;archive/master&amp;quot;&lt;/code>ï¼Œå…¶ä¸­çš„ &lt;code>master&lt;/code> æŒ‡å®šäº†æ˜¯ &lt;code>master&lt;/code> åˆ†æ”¯ä¸Šçš„ä»£ç å‹ç¼©åŒ…çš„è·¯å¾„ï¼Œæ‰€ä»¥å‡å¦‚ä½ éœ€è¦ä» master åˆ†æ”¯å¤–çš„åˆ†æ”¯éƒ¨ç½²ä»£ç ï¼Œè¯·åŠ¡å¿…è®°å¾—å°† &lt;code>master&lt;/code> æ”¹ä¸ºå¯¹åº”çš„åˆ†æ”¯åï¼Œæ¯”å¦‚æˆ‘çš„éƒ¨ç½²åˆ†æ”¯æ˜¯ &lt;code>coding-pages&lt;/code>ï¼Œé‚£æˆ‘è¿™é‡Œçš„ä»£ç å°±åº”è¯¥æ”¹ä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>archive_url = &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>repo_url&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">/archive/coding-pages&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæˆ webhook å¤„ç†è„šæœ¬åï¼Œéœ€è¦é‡æ–° push ä»£ç å¹¶ä¸”é‡æ–°åœ¨æ¼”ç¤ºå¹³å°éƒ¨ç½²ä¸€æ¬¡ï¼Œä»¥ä½¿ &lt;code>config.ru&lt;/code> æ–‡ä»¶é‡Œçš„ä»£ç ç”Ÿæ•ˆã€‚è‡³äºå¦‚ä½•é…ç½® webhook ï¼Œç›´æ¥å‚ç…§ coding çš„å®˜æ–¹æ–‡æ¡£å³å¯ã€‚&lt;/p>
&lt;h2 id="æ€»ç»“">æ€»ç»“&lt;/h2>
&lt;p>ä»¥ä¸Šçš„ä¸‰ç‚¹ä¸»è¦æ˜¯å¯¹åœ¨ coding ä¸Šéƒ¨ç½² jekyll åšå®¢çš„å…³é”®æ€è·¯çš„è¯´æ˜ï¼Œé€šè¿‡è¿™ä¸‰ç‚¹ï¼Œç›¸ä¿¡ä½ å†å»çœ‹åŸæ¥çš„ &lt;a href="https://coding.net/u/chenwj233/p/jekyll-demo/git/raw/125f456d2dfa4d324e320a57a78adf7fda89c93e/README.md">README&lt;/a> çš„æ—¶å€™ï¼Œåº”è¯¥å°±èƒ½å¾ˆå¿«ç†è§£ä¸ºä»€ä¹ˆéœ€è¦é…ç½® &lt;code>WEBHOOK_TOKEN&lt;/code> ç¯å¢ƒå˜é‡ä»¥åŠä¸ºä»€ä¹ˆè¦é…ç½® webhook çš„ URL ä¸ºç±»ä¼¼ &amp;ldquo;http://host/_&amp;rdquo; è¿™ä¹ˆå¥‡æ€ªçš„é“¾æ¥äº†å§ï¼Ÿé™¤æ­¤ä¹‹å¤–ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®ä½ çš„éœ€è¦å°†è„šæœ¬ä¸­çš„ä»£ç åˆ†æ”¯ä» &lt;code>master&lt;/code> æ”¹ä¸ºä½ æ‰€éœ€è¦çš„ç›®æ ‡åˆ†æ”¯äº†ã€‚&lt;br>
å…¶å®ç”¨ unicorn è¿è¡Œ jekyll é¡¹ç›®çš„åŸç†è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼ŒçŸ¥é“äº†è¿™äº›ä¹‹åï¼Œå°†ä½ çš„å·²æœ‰ jekyll é¡¹ç›®ç›´æ¥è¿ç§»åˆ° coding ç”šè‡³æ˜¯å…¶ä»– PaaS å¹³å°ä¸Šå°±ä¸æ˜¯ä»¶éº»çƒ¦çš„äº‹äº†ã€‚&lt;/p>
&lt;h2 id="å…¶ä»–è”æƒ³">å…¶ä»–è”æƒ³&lt;/h2>
&lt;ol>
&lt;li>&lt;a href="http://octopress.org/">Octopress&lt;/a> åšå®¢æ˜¯åœ¨ jekyll çš„åŸºç¡€ä¸Šå°è£…è€Œæ¥çš„æ›´é«˜çº§ä¹Ÿæ›´æ–¹ä¾¿çš„é™æ€ç«™ç‚¹æ¡†æ¶ï¼Œæ‰€ä»¥æŒ‰ç…§ä¸Šé¢çš„åŸç†ï¼Œå°†å·²æœ‰çš„ octopress é¡¹ç›®éƒ¨ç½²åˆ° coding å¹³å°ä¸Šï¼Œåº”è¯¥ä¹Ÿä¸æ˜¯ä»¶éš¾äº‹ã€‚&lt;/li>
&lt;li>Octopress æœ¬èº«æ”¯æŒå¦å¤–ä¸€ç§éƒ¨ç½²æ–¹å¼ï¼Œå°±æ˜¯æœ¬åœ°ç”Ÿæˆé™æ€ç«™ç‚¹ä¹‹åï¼Œç›´æ¥æ‰§è¡Œ &lt;code>rake deploy&lt;/code> å°†ç”Ÿæˆåçš„é™æ€ç«™ç‚¹ push åˆ°æŒ‡å®šçš„è¿œç¨‹ repo æˆ–è€…æŒ‡å®šçš„åˆ†æ”¯ä¸Šï¼Œä»è¿™ä¸ªè§’åº¦è€ƒè™‘ï¼Œå…¶å®ä¹Ÿå¯ä»¥ä¸º jekyll å®ç°ç±»ä¼¼çš„è„šæœ¬ï¼Œç»“åˆ coding æ¼”ç¤ºå¹³å°çš„ &lt;a href="https://coding.net/help/project_demos/do_you_support_static_html_site">é™æ€ç«™ç‚¹éƒ¨ç½²&lt;/a> ï¼Œå°±å¯ä»¥ç›´æ¥éƒ¨ç½² jekyll åšå®¢äº†ï¼Œè¿™ç§æ–¹å¼å°±çœå»äº† unicorn æœåŠ¡å™¨ç­‰çš„é…ç½®äº†ï¼Œä¹Ÿä¸éœ€è¦å†ä½¿ç”¨ webhook é‡æ–°ç”Ÿæˆç«™ç‚¹äº†ï¼Œè€Œä¸”çº¯é™æ€ç«™ç‚¹çš„æ–¹æ¡ˆçš„æœ€å¤§ä¼˜ç‚¹å°±æ˜¯ï¼Œç‰¹åˆ«èŠ‚çº¦å†…å­˜ã€‚è¿™ç§æ–¹æ¡ˆåªæ˜¯æ„æƒ³ï¼Œä½†æ˜¯å€¼å¾—ä¸€è¯•ã€‚å¦‚æœå“ªä½æœ‹å‹å°è¯•æˆåŠŸäº†ï¼Œè¯·è®°å¾—åœ¨è¯„è®ºé‡Œå›å¤ä¸€ä¸‹ã€‚&lt;/li>
&lt;/ol></description></item><item><title>RAILSä¸­åˆ©ç”¨YAMLæ–‡ä»¶å®Œæˆæ•°æ®å¯¹æ¥</title><link>https://blog.hackerpie.com/posts/archive/railszhong-jie-he-yamlwen-jian-wan-cheng-shu-ju-dui-jie/</link><pubDate>Wed, 12 Nov 2014 20:15:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/railszhong-jie-he-yamlwen-jian-wan-cheng-shu-ju-dui-jie/</guid><description>&lt;p>æœ€è¿‘åœ¨åšçš„Ruby on Railsé¡¹ç›®ä¸­ï¼Œéœ€è¦å°†è¿œç¨‹æ•°æ®åº“ä¸­çš„æ•°æ®å¯¹æ¥åˆ°é¡¹ç›®æ•°æ®åº“ä¸­ï¼Œä½†æ˜¯è¿œç¨‹çš„æ•°æ®ä¸ä»…æ•°æ®è¡¨åè·Ÿå­—æ®µå‘½åå¥‡è‘©ï¼Œæ•°æ®ç»“æ„æœ¬èº«è·Ÿé¡¹ç›®æ•°æ®ç»“æ„å‡ºå…¥æ¯”è¾ƒå¤§ï¼Œåœ¨æ•°æ®å¯¼å…¥è¿‡ç¨‹ä¸­ä»£ç ç»å†äº†å‡ æ¬¡é‡æ„ï¼Œæœ€åä½¿ç”¨äº†YAMLæ–‡ä»¶è§£å†³äº†åŸºæœ¬æ•°æ®&lt;sup id="fnref:1">&lt;a href="#fn:1" class="footnote-ref" role="doc-noteref">1&lt;/a>&lt;/sup>å¯¹æ¥çš„é—®é¢˜ã€‚åœ¨æ­¤å†™ä¸€ç¯‡åšæ–‡ï¼Œæˆ‘ä¼šå°½é‡é‡ç°ä¸€è·¯è¿‡æ¥çš„ä»£ç å˜æ›´ï¼Œç®—æ˜¯åˆ†äº«ä¸€ä¸‹æˆ‘çš„æ€è€ƒè¿‡ç¨‹ï¼Œä¹Ÿç®—æ˜¯ç¥­å¥ ä¸€ä¸‹è‡ªå·±çš„è‹¦é€¼å²æœˆã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h3 id="å‡è®¾ä»¥åŠæ•°æ®ç»“æ„é¢„è§ˆ">å‡è®¾ä»¥åŠæ•°æ®ç»“æ„é¢„è§ˆ&lt;/h3>
&lt;p>å› ä¸ºè¿œç¨‹æ•°æ®åº“æœåŠ¡å™¨ä¸ºOracle Serverï¼Œæˆ‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨åˆ°äº†&lt;a href="http://sequel.jeremyevans.net/">Sequel&lt;/a>è¿™ä¸ªgemç”¨äºè¿æ¥æ•°æ®åº“ä»¥åŠæ•°æ®æŸ¥è¯¢ï¼Œå› ä¸ºæ•°æ®åº“è¿æ¥çš„å†…å®¹ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæ•…åç»­ä»£ç ç›´æ¥ç”¨&lt;code>remote_database&lt;/code>è¡¨ç¤ºæ•°æ®åº“è¿æ¥ï¼Œè€Œæ ¹æ®&lt;a href="http://sequel.jeremyevans.net/rdoc/files/doc/dataset_basics_rdoc.html">Sequelçš„ç”¨æ³•&lt;/a>ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨&lt;code>remote_database[table_name]&lt;/code>è¿æ¥åˆ°å…·ä½“çš„è¡¨ã€‚&lt;/p>
&lt;p>æœ¬æ¬¡éœ€è¦ä»è¿œç¨‹æ•°æ®åº“ä¸­å¯¼å…¥çš„åŸºæœ¬æ•°æ®ä¸»è¦æœ‰å­¦ç”Ÿä¿¡æ¯è¡¨ï¼ˆåŒ…å«ç­çº§åç§°ï¼‰ã€è€å¸ˆä¿¡æ¯è¡¨ä»¥åŠä¸“ä¸šä¿¡æ¯è¡¨ï¼Œç›¸åº”åœ°ï¼Œé¡¹ç›®ä¸­ï¼ˆä»¥ä¸‹ç§°ä¸ºâ€œæœ¬åœ°â€ï¼‰ä¹Ÿå·²ç»åˆ›å»ºå¥½äº†å¯¹åº”çš„modelã€‚å…¶ä¸­å­¦ç”Ÿä¿¡æ¯è¡¨çš„è¡¨åä»¥åŠéƒ¨åˆ†æ•°æ®å­—æ®µçš„ä»æœ¬åœ°åˆ°è¿œç¨‹çš„æ˜ å°„å…³ç³»å¦‚è¡¨æ‰€ç¤ºï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>è¡¨åæˆ–å­—æ®µå&lt;/th>
&lt;th>æœ¬åœ°&lt;/th>
&lt;th>è¿œç¨‹&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>è¡¨å&lt;/td>
&lt;td>students&lt;/td>
&lt;td>XSJBXX&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å§“å&lt;/td>
&lt;td>name&lt;/td>
&lt;td>XM&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å­¦å·&lt;/td>
&lt;td>number&lt;/td>
&lt;td>XH&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å¹´çº§&lt;/td>
&lt;td>grade&lt;/td>
&lt;td>NJ&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>ç­çº§&lt;/td>
&lt;td>belongs_to :klass Â Â Â &lt;/td>
&lt;td>BJMC(ç­çº§åç§°)&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>è€å¸ˆä¿¡æ¯è¡¨çš„è¡¨åä»¥åŠéƒ¨åˆ†æ•°æ®å­—æ®µçš„æ˜ å°„å…³ç³»ä¸ºï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>è¡¨åæˆ–å­—æ®µå&lt;/th>
&lt;th>æœ¬åœ°&lt;/th>
&lt;th>è¿œç¨‹&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>è¡¨å&lt;/td>
&lt;td>teachers&lt;/td>
&lt;td>JZGJBXX&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å§“å&lt;/td>
&lt;td>name&lt;/td>
&lt;td>XM&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>èŒç§°&lt;/td>
&lt;td>title&lt;/td>
&lt;td>ZC&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>è¯ä»¶å·ç &lt;/td>
&lt;td>id_number&lt;/td>
&lt;td>ZJHM&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;h3 id="æ•°æ®å¯¹æ¥ç¬¬ä¸€ç‰ˆå±æ€§æ–¹æ³•æ˜¾å¼èµ‹å€¼">æ•°æ®å¯¹æ¥ç¬¬ä¸€ç‰ˆï¼šå±æ€§æ–¹æ³•æ˜¾å¼èµ‹å€¼&lt;/h3>
&lt;p>ç¬¬ä¸€ä¸ªå¯¼å…¥çš„æ•°æ®è¡¨æ˜¯å­¦ç”Ÿçš„ä¿¡æ¯è¡¨ï¼Œåœ¨æœ€å¼€å§‹çš„æ—¶å€™ï¼Œå› ä¸ºåªéœ€è¦è€ƒè™‘ä¸€å¼ å•ç‹¬çš„è¡¨ï¼Œæ‰€ä»¥ä»£ç å†™å¾—ç®€å•ç²—æš´ï¼ŒåŸºæœ¬è¿‡ç¨‹å°±æ˜¯ï¼šæ ¹æ®éœ€è¦çš„ä¿¡æ¯ï¼ŒæŸ¥è¯¢å¯¹åº”çš„è¿œç¨‹æ•°æ®å­—æ®µï¼Œç„¶åä½¿ç”¨å±æ€§æ–¹æ³•èµ‹å€¼ï¼Œæœ€åä¿å­˜æ¥å…¥çš„æ•°æ®ã€‚å¯¹æ¥æ–¹æ³•çš„éƒ¨åˆ†ç›¸å…³ä»£ç ç¤ºä¾‹ï¼ˆä¸ºäº†æ–¹ä¾¿é˜…è¯»ä»¥åŠä¿æŠ¤é¡¹ç›®æ•æ„Ÿä¿¡æ¯ï¼Œæœ¬æ–‡å¯¹é¡¹ç›®ä¸­åŸæœ‰ä»£ç è¿›è¡Œäº†ç¼©å‡ä»¥åŠä¿®æ”¹ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># app/models/student.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Student&lt;/span> &amp;lt; ActiveRecord::Base
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> import_data_from_remote
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remote_students = remote_database[&lt;span style="font-style:italic">:xsjbxx&lt;/span>].page(page)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remote_students.each &lt;span style="font-weight:bold">do&lt;/span> |remote_student|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name, number, grade = *remote_student.values_at(&lt;span style="font-style:italic">:xm&lt;/span>, &lt;span style="font-style:italic">:xh&lt;/span>, &lt;span style="font-style:italic">:nj&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> class_name = remote_student[&lt;span style="font-style:italic">:bjmc&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> klass = Klass.find_or_create_by name: class_name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> student = Student.find_by_create_by name: name,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">number&lt;/span>: number,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">grade&lt;/span>: grade,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">klass&lt;/span>: klass
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸Šé¢çš„ä»£ç ï¼Œå‘ƒï¼Œä¸­è§„ä¸­çŸ©ï¼ŒåŸºæœ¬ä½“ç°äº†å„å–æ‰€éœ€çš„æŒ‡å¯¼æ€æƒ³ï¼Œä½†æ˜¯æ€»è§‰å¾—æ€ä¹ˆæœ‰ç‚¹ä¸å¥½å‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="æ•°æ®å¯¹æ¥ç¬¬äºŒç‰ˆé€šè¿‡æœ¬åœ°åˆ°è¿œç¨‹æ•°æ®åº“å­—æ®µæ˜ å°„å…³ç³»è‡ªåŠ¨åŒ¹é…èµ‹å€¼">æ•°æ®å¯¹æ¥ç¬¬äºŒç‰ˆï¼šé€šè¿‡æœ¬åœ°åˆ°è¿œç¨‹æ•°æ®åº“å­—æ®µæ˜ å°„å…³ç³»è‡ªåŠ¨åŒ¹é…èµ‹å€¼&lt;/h3>
&lt;p>åœ¨ç¬¬ä¸€ç‰ˆçš„ä»£ç ä¸­ï¼Œæœ€å¤§çš„åå‘³é“åœ¨äºï¼šä»£ç ä¸­éœ€è¦æŠŠæ‰€æœ‰éœ€è¦å¯¹æ¥çš„å­—æ®µåˆ—ä¸¾å‡ºæ¥ï¼Œä¸€æ—¦é‡åˆ°å­—æ®µå¢åˆ ä¿®æ”¹çš„æƒ…å†µï¼Œå°±éœ€è¦åŒæ—¶æ›´æ–°åŸæ¥çš„é€»è¾‘ä»£ç ï¼Œå¤ªä¸çµæ´»äº†ï¼Œè€Œä¸”åˆ—ä¸¾æ‰€æœ‰å­—æ®µæœ¬èº«å°±æ˜¯ä¸€ä»¶éå¸¸ç¹çæ¯ç‡¥çš„äº‹æƒ…ã€‚å†å‡è®¾å­—æ®µå¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œè¦ä»ä»£ç ä¸­ä¸€ä¸ªä¸ªæ£€æŸ¥å­—æ®µçš„åç§°ï¼Œè‚¯å®šæ˜¯ä»¶å¤šä¹ˆå¯æ€•çš„äº‹æƒ…å•Šã€‚&lt;/p>
&lt;p>é‚£ä¹ˆæ€ä¹ˆä¿®æ”¹å‘¢ï¼Ÿç”¨æ˜ å°„è¡¨ï¼ä»”ç»†è§‚å¯Ÿç¬¬ä¸€æ®µçš„ä»£ç ï¼Œå…¶å®ä»£ç æ‰€åšçš„å·¥ä½œå¦‚æ­¤ç®€å•ï¼šæ— éæ˜¯å…ˆä»è¿œç¨‹æ•°æ®ä¸­å–å€¼ï¼Œç„¶åèµ‹å€¼åˆ°æœ¬åœ°æ•°æ®å¯¹è±¡çš„å¯¹åº”å±æ€§ä¸­ï¼Œè¿™ç§â€œæœ¬åœ°-è¿œç¨‹â€çš„å­—æ®µæ˜ å°„å…³ç³»ï¼Œä¸å°±æ˜¯æˆ‘ä»¬æ¯å¤©é¢å¯¹çš„â€œé”®-å€¼â€å¯¹çš„ç‰¹å¾å—ï¼Ÿé‚£ç›´æ¥ç”¨ä¸€ä¸ª&lt;code>Hash&lt;/code>æ¥ä¿å­˜è¿™ç§å¯¹åº”å…³ç³»ä¸å°±å¥½äº†ã€‚&lt;/p>
&lt;p>è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬å¼€å§‹é‡æ„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># app/models/student.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Student&lt;/span> &amp;lt; ActiveRecord::Base
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_FIELDS_MAP = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">number&lt;/span>: &lt;span style="font-style:italic">:xh&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: &lt;span style="font-style:italic">:xm&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">age&lt;/span>: &lt;span style="font-style:italic">:nj&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_ASSOCIATION_MAP = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">klass&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">association_field_name&lt;/span>: &lt;span style="font-style:italic">:name&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">remote_field_name&lt;/span>: &lt;span style="font-style:italic">:bjmc&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> import_data_from_remote
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remote_students = remote_database[&lt;span style="font-style:italic">:xsjbxx&lt;/span>].page(page)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remote_students.each &lt;span style="font-weight:bold">do&lt;/span> |remote_student|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> student = Student.find_or_initialize_by &lt;span style="font-style:italic">xxx&lt;/span>: xxx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_FIELDS_MAP.keys.each &lt;span style="font-weight:bold">do&lt;/span> |attribute|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># é€ä¸€è°ƒç”¨å±æ€§èµ‹å€¼æ–¹æ³•ï¼Œå®ŒæˆStudentå±æ€§çš„èµ‹å€¼&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> student.send(&lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>attribute&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">=&amp;#34;&lt;/span>, remote_student[LOCAL_TO_REMOTE_FIELDS_MAP[attribute]])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_ASSOCIATION_MAP.each &lt;span style="font-weight:bold">do&lt;/span> |association_name, association_fields_map|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># æŠŠè¿œç¨‹æ•°æ®èµ‹ç»™å¯¹åº”çš„æœ¬åœ°æ•°æ®å­—æ®µ&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> association_field_name = association_fields_map[&lt;span style="font-style:italic">:association_field_name&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remote_value = remote_student[association_fields_map[&lt;span style="font-style:italic">:remote_field_name&lt;/span>]]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># æŸ¥æ‰¾æˆ–åˆ›å»ºå…³è”å¯¹è±¡&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> related_object =
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> reflect_on_association(association_name).klass.find_or_create_by association_field_name =&amp;gt; remote_value
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># å»ºç«‹å…³è”å…³ç³»&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local_object.send(&lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>association_name&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">=&amp;#34;&lt;/span>, related_object)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> student.save
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ç”¨å¸¸é‡&lt;code>LOCAL_TO_REMOTE_FIELDS_MAP&lt;/code>ä¿å­˜&lt;code>Student&lt;/code>è¿™ä¸ªmodelæœ¬èº«çš„å­—æ®µè·Ÿè¿œç¨‹æ•°æ®å­—æ®µçš„æ˜ å°„å…³ç³»ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç±»ä¼¼&lt;code>LOCAL_TO_REMOTE_FIELDS_MAP[:number]&lt;/code>çŸ¥é“å­¦ç”Ÿçš„å§“ååœ¨è¿œç¨‹æ•°æ®è¡¨ä¸­å¯¹åº”çš„å­—æ®µæ˜¯&lt;code>:xm&lt;/code>äº†ã€‚å¦å¤–å€¼å¾—ä¸€æçš„æ˜¯ï¼Œæˆ‘ç”¨äº†&lt;code>LOCAL_TO_REMOTE_ASSOCIATION_MAP&lt;/code>è¿™ä¸ªå¸¸é‡ä¿å­˜äº†å­¦ç”Ÿä¸ç­çº§å…³è”å…³ç³»ï¼ŒåŒæ—¶ä¿å­˜äº†å…³è”çš„&lt;code>klass&lt;/code>çš„æ•°æ®å­—æ®µæ˜ å°„å…³ç³»ã€‚&lt;/p>
&lt;p>åœ¨å£°æ˜äº†å¿…è¦çš„å­—æ®µæ˜ å°„å…³ç³»ä¹‹åï¼Œæˆ‘å°±åœ¨ä»£ç ä¸­éå†äº†æ¯ä¸€ä¸ªå­—æ®µï¼Œå¹¶ä¸”é€šè¿‡å¯¹åº”çš„è¿œç¨‹å­—æ®µåç§°æŸ¥æ‰¾å¯¹åº”çš„æ•°å€¼ï¼Œå¹¶ä¸”ä½¿ç”¨&lt;code>send&lt;/code>æ–¹æ³•è°ƒç”¨äº†å¯¹è±¡çš„å±æ€§èµ‹å€¼æ–¹æ³•ï¼Œå°†æ•°æ®è‡ªåŠ¨å¯¹æ¥åˆ°æœ¬åœ°æ•°æ®å¯¹è±¡ä¸Šã€‚&lt;/p>
&lt;p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä»£ç è¡Œæ•°è™½ç„¶åè€Œå¤šäº†ï¼Œä½†æ˜¯å´å®ç°äº†å­—æ®µæ˜ å°„å…³ç³»ä¸é€»è¾‘ä»£ç çš„åˆ†ç¦»ï¼Œæˆ‘ä»¬å¯ä»¥ç‹¬ç«‹ç®¡ç†æ˜ å°„å…³ç³»äº†ã€‚ä»¥åå°±ç®—éœ€è¦åŠ å…¥æ–°çš„å¯¹æ¥å­—æ®µï¼Œåªè¦åœ¨&lt;code>LOCAL_TO_REMOTE_FIELDS_MAP&lt;/code>ä¸­æ·»åŠ æ–°çš„é”®å€¼å¯¹å°±å¥½äº†ï¼Œç”šè‡³å¯ä»¥åœ¨&lt;code>LOCAL_TO_REMOTE_ASSOCIATION_MAP&lt;/code>æ·»åŠ ç±»ä¼¼&lt;code>klass&lt;/code>çš„ç®€å•å…³è”å…³ç³»çš„æ•°æ®æ¥å…¥ï¼Œè€Œè¿™äº›éƒ½æ— éœ€ä¿®æ”¹é€»è¾‘ä»£ç ã€‚&lt;/p>
&lt;h3 id="æ•°æ®å¯¹æ¥ç¬¬ä¸‰ç‰ˆæ•™èŒå·¥ä¿¡æ¯ä¹Ÿéœ€è¦å¯¼å…¥äº†ä»£ç æ‹·è´ä¹‹æ—…å¼€å§‹äº†">æ•°æ®å¯¹æ¥ç¬¬ä¸‰ç‰ˆï¼šæ•™èŒå·¥ä¿¡æ¯ä¹Ÿéœ€è¦å¯¼å…¥äº†ï¼Œä»£ç æ‹·è´ä¹‹æ—…å¼€å§‹äº†&lt;/h3>
&lt;p>æ¯«æ— ç–‘é—®ï¼Œå¦‚æœåªæ˜¯æ»¡è¶³äºå­¦ç”Ÿä¿¡æ¯çš„å¯¹æ¥ï¼Œç›¸ä¿¡ä¸Šé¢çš„ä»£ç ä¹Ÿéƒ½å¤Ÿç”¨äº†ï¼Œä»£ç çš„é‡æ„ä¹Ÿå¯ä»¥å‘Šä¸€æ®µè½äº†ã€‚&lt;/p>
&lt;p>ä½†æ˜¯ï¼Œå‰é¢è¯´äº†ï¼Œé™¤äº†å­¦ç”Ÿçš„ä¿¡æ¯ï¼Œè¿˜æœ‰æ•™èŒå·¥çš„ä¿¡æ¯éœ€è¦åšæ¥å…¥ï¼Œè€Œä¸”ä»æœ€å¼€å§‹çš„&lt;strong>å‡è®¾ä»¥åŠæ•°æ®ç»“æ„é¢„è§ˆ&lt;/strong>ä¸€èŠ‚çœ‹åˆ°ï¼Œè€å¸ˆçš„æ•°æ®ç»“æ„è·Ÿå­¦ç”Ÿçš„æ•°æ®ç»“æ„æå…¶ç›¸ä¼¼ï¼Œæ‰€ä»¥ï¼Œæ—¶é—´ç´§è¿«ï¼Œæˆ‘å°±ç›´æ¥æ‹·è´ä»£ç ç„¶åç®€å•åˆ æ”¹äº†ä¸€ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># app/models/teacher.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Teacher&lt;/span> &amp;lt; ActiveRecord::Base
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_FIELDS_MAP = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">number&lt;/span>: &lt;span style="font-style:italic">:xh&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">title&lt;/span>: &lt;span style="font-style:italic">:zc&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">id_number&lt;/span>: &lt;span style="font-style:italic">:zjhm&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> import_data_from_remote
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remote_teachers = remote_database[&lt;span style="font-style:italic">:jzgjbxx&lt;/span>].page(page)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> remote_teachers.each &lt;span style="font-weight:bold">do&lt;/span> |remote_teacher|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> teacher = Teacher.find_or_initialize_by &lt;span style="font-style:italic">xxx&lt;/span>: xxx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_FIELDS_MAP.keys.each &lt;span style="font-weight:bold">do&lt;/span> |attribute|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> teacher.send(&lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>attribute&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">=&amp;#34;&lt;/span>, remote_teacher[LOCAL_TO_REMOTE_FIELDS_MAP[attribute]])
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> teacher.save
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ³¨æ„åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ&lt;code>Teacher&lt;/code>ä¸­æ¯”èµ·&lt;code>Student&lt;/code>ï¼Œå°‘äº†&lt;code>LOCAL_TO_REMOTE_ASSOCIATION_MAP&lt;/code>å¸¸é‡ï¼Œå¹¶ä¸”ä¹Ÿåˆ é™¤äº†ç›¸å…³çš„ä»£ç ï¼Œè™½ç„¶ä»£ç å·²ç»æ»¡è¶³éœ€æ±‚äº†ï¼Œæ•™èŒå·¥çš„æ•°æ®å¯¼å…¥ä¹Ÿæ˜¯æ— æ¯”é¡ºåˆ©ï¼Œå¯æ˜¯é¢å¯¹ç€ä¸€å †é‡å¤çš„ä»£ç ï¼ŒçœŸå¿ƒåˆ«æ‰­ï¼&lt;/p>
&lt;h3 id="æ•°æ®å¯¹æ¥ç¬¬å››ç‰ˆæŠ½è±¡é€»è¾‘ä»£ç å…±äº«">æ•°æ®å¯¹æ¥ç¬¬å››ç‰ˆï¼šæŠ½è±¡é€»è¾‘ï¼Œä»£ç å…±äº«&lt;/h3>
&lt;p>å…¶å®æˆ‘å¤šå°‘ä¹Ÿæ˜¯æœ‰ä»£ç æ´ç™–çš„ï¼Œå¤§ç‰‡Copyçš„ä»£ç å²‚ä¸æ˜¯æå¾—è‡ªå·±é€¼æ ¼å¥½Lowï¼Ÿæ€ä¹ˆå¯ä»¥å¿å—ï¼Œç»§ç»­é‡æ„ï¼&lt;/p>
&lt;p>è¿™ä¸€æ¬¡é‡æ„å…¶å®å°±ç®€å•å¤šäº†ï¼ŒæŠŠé‡å¤çš„æ ¸å¿ƒé€»è¾‘ä»£ç æŠ½å–å‡ºæ¥ï¼Œç„¶åæ”¾åˆ°ä¸€ä¸ªä¸“é—¨è´Ÿè´£æ•°æ®å¯¹æ¥çš„Concerné‡Œè¾¹ï¼Œæœ€ååœ¨éœ€è¦æ­¤concernçš„modelé‡Œincludeä¸€ä¸‹å°±è¡Œäº†ã€‚è¯ä¸å¤šè¯´ï¼Œä¸ŠConcernä»£ç ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code># app/models/concerns/import_data_concern.rb
module ImportDataConcern
extend ActiveSupport::Concern
module ClassMethods
def import_data_from_remote
remote_objects = remote_database[self::REMOTE_TABLE_NAME].page(page)
remote_objects.each do |remote_object|
object = self.find_or_initialize_by xxx: xxx
self::LOCAL_TO_REMOTE_FIELDS_MAP.keys.each do |attribute|
# é€ä¸€è°ƒç”¨å±æ€§èµ‹å€¼æ–¹æ³•ï¼Œå®ŒæˆStudentå±æ€§çš„èµ‹å€¼
object.send(&amp;#34;#{attribute}=&amp;#34;, remote_object[self::LOCAL_TO_REMOTE_FIELDS_MAP[attribute]])
end
if self::LOCAL_TO_REMOTE_ASSOCIATION_MAP
self::LOCAL_TO_REMOTE_ASSOCIATION_MAP.each do |association_name, association_fields_map|
# æŠŠè¿œç¨‹æ•°æ®èµ‹ç»™å¯¹åº”çš„æœ¬åœ°æ•°æ®å­—æ®µ
association_field_name = association_fields_map[:association_field_name]
remote_value = remote_object[association_fields_map[:remote_field_name]]
# æŸ¥æ‰¾æˆ–åˆ›å»ºå…³è”å¯¹è±¡
related_object =
reflect_on_association(association_name).klass.find_or_create_by association_field_name =&amp;gt; remote_value
# å»ºç«‹å…³è”å…³ç³»
local_object.send(&amp;#34;#{association_name}=&amp;#34;, related_object)
end
end
object.save
end
end
end
end
&lt;/code>&lt;/pre>&lt;p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æŠŠæ ¸å¿ƒå¯¹æ¥é€»è¾‘æŠ½äº†å‡ºæ¥ï¼Œå¹¶ä¸”æŠ½è±¡äº†è¿œç¨‹æ•°æ®è¡¨åçš„é…ç½®ï¼Œå¦å¤–é€šè¿‡&lt;code>if self::LOCAL_TO_REMOTE_ASSOCIATION_MAP&lt;/code>å…¼å®¹å…³è”å…³ç³»çš„å¯¼å…¥ã€‚
ä¸ºäº†åœ¨&lt;code>Teacher&lt;/code>ä»¥åŠ&lt;code>Student&lt;/code>ä¸­æ­£å¸¸è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨è¿™ä¸¤ä¸ªmodelåˆ†åˆ«includeå½“å‰çš„concernï¼Œå¹¶ä¸”å£°æ˜å¿…è¦çš„å¸¸é‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># app/models/student.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Student&lt;/span> &amp;lt; ActiveRecord::Base
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">include&lt;/span> ImportDataConcern
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> REMOTE_TABLE_NAME = &lt;span style="font-style:italic">&amp;#39;XSJBXX&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_FIELDS_MAP = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">number&lt;/span>: &lt;span style="font-style:italic">:xh&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: &lt;span style="font-style:italic">:xm&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">age&lt;/span>: &lt;span style="font-style:italic">:nj&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_ASSOCIATION_MAP = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">klass&lt;/span>: {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">association_field_name&lt;/span>: &lt;span style="font-style:italic">:name&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">remote_field_name&lt;/span>: &lt;span style="font-style:italic">:bjmc&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># app/models/teacher.rb&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Teacher&lt;/span> &amp;lt; ActiveRecord::Base
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">include&lt;/span> ImportDataConcern
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOCAL_TO_REMOTE_FIELDS_MAP = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">number&lt;/span>: &lt;span style="font-style:italic">:xh&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">title&lt;/span>: &lt;span style="font-style:italic">:zc&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">id_number&lt;/span>: &lt;span style="font-style:italic">:zjhm&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»è¿‡ä¸Šé¢çš„é‡æ„ï¼ŒåŸæœ¬é‡å¤çš„ä»£ç å·²ç»å˜æˆäº†ä¸€ä¸ªConcernï¼Œé€šè¿‡Concernæ¥ç®¡ç†ç‹¬ç«‹çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿä½¿å¾—ä»£ç ç®¡ç†èµ·æ¥æ›´æ–¹ä¾¿äº†ã€‚ä½†æ˜¯ï¼Œç­‰ç­‰ï¼Œæˆ‘ä»¬çš„é‡æ„ä¹‹æ—…è¿˜åœ¨ç»§ç»­ï¼&lt;/p>
&lt;h3 id="æ•°æ®å¯¹æ¥ç¬¬äº”ç‰ˆç æ‰æ¶å¿ƒçš„å¸¸é‡ä½¿ç”¨yamlé…ç½®æ˜ å°„å…³ç³»">æ•°æ®å¯¹æ¥ç¬¬äº”ç‰ˆï¼šç æ‰æ¶å¿ƒçš„å¸¸é‡ï¼Œä½¿ç”¨YAMLé…ç½®æ˜ å°„å…³ç³»&lt;/h3>
&lt;p>å½“æ—¶åœ¨å†™ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å°±ä¸€ç›´æ„Ÿè§‰ä¸€å¤§å †çš„å¸¸é‡ä»¤äººæ— æ³•ç›´è§†ï¼Œä½†æ˜¯ï¼Œå¦‚æœä¸ç”¨å¸¸é‡ï¼Œæˆ‘è¿˜èƒ½æ€ä¹ˆåšï¼Ÿå°½ç®¡å‰é¢ä¸¤ä¸ªè¡¨çš„æ•°æ®å¯¼å…¥ä»»åŠ¡å®Œæˆäº†ï¼Œæˆ‘è¿˜æ˜¯çº ç»“äºä»£ç ä¸­é‚£æ¶å¿ƒæ­»äº†çš„å¸¸é‡ï¼ˆå®é™…ä¸Šï¼Œæˆ‘å½“æ—¶å†™çš„å¸¸é‡æ¯”ä½ ä»¬ç°åœ¨çœ‹åˆ°çš„æ›´å¤šï¼Œæ–‡ç« ä¸­çš„åªä¸è¿‡æ˜¯ç¤ºä¾‹ï¼‰ã€‚è€Œåº†å¹¸çš„æ˜¯ï¼Œé‚£å¤©è„‘æ´ä¸€å¼€ï¼šâ€œè¿™äº›æ˜ å°„å…³ç³»æœ¬è´¨ä¸Šä¸å°±æ˜¯ä¸€å †é…ç½®ä¿¡æ¯å—ï¼Ÿè€Œæˆ‘åœ¨ä»£ç ä¸­çš„å¸¸é‡ä¹Ÿå°±æ˜¯ç”¨Hashå­˜å‚¨çš„ï¼Œé‚£ç”¨YAMLæ–‡ä»¶ä¸å°±åˆšå¥½äº†å—?â€ã€‚æ˜¯å•Šï¼Œåƒ&lt;code>config/database.yml&lt;/code>è¿™ç±»çš„æ–‡ä»¶ï¼Œä¸€ç›´ä»¥æ¥éƒ½æ˜¯ç”¨äºä¿å­˜é…ç½®ä¿¡æ¯çš„å•Šï¼Œä¸€ä¸ªæ˜¯ç¬¦åˆRailsçš„ä½¿ç”¨ä¹ æƒ¯ï¼Œå¦ä¸€ä¸ªä¹Ÿç¡®å®ç¬¦åˆæ•°æ®ç»“æ„çš„è¦æ±‚ã€‚Awesomeï¼Œè¿™å°±å¼€å§‹åŠ¨å·¥ã€‚&lt;/p>
&lt;p>é¦–å…ˆç¬¬ä¸€ä»¶äº‹ï¼Œæˆ‘å°±æŠŠé‚£äº›å¸¸é‡æ¬åˆ°äº†yamlæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”æ”¾åœ¨äº†é¡¹ç›®çš„&lt;code>config/&lt;/code>ç›®å½•ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-yaml" data-lang="yaml">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">default&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">remote_unique_field_name&lt;/span>: number
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">models&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">student&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">remote_table_name&lt;/span>: xsjbxx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">local_to_remote_fields_map&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">number&lt;/span>: xh
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">name&lt;/span>: xm
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">grade&lt;/span>: nj
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">local_to_remote_association_map&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">klass&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">association_field_name&lt;/span>: name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">remote_field_name&lt;/span>: bjmc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">teacher&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">remote_table_name&lt;/span>: jzgjbxx
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">local_to_remote_fields_map&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">name&lt;/span>: xm
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">title&lt;/span>: zc
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">id_number&lt;/span>: zjhm
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é…ç½®å¥½äº†yamlï¼Œé‚£ä¹ˆåˆè¦å¦‚ä½•æ–¹ä¾¿åœ°è¯»å–é…ç½®ä¿¡æ¯å‘¢ï¼Ÿæˆ‘çš„æ–¹æ³•æ˜¯åœ¨&lt;code>config/iniitializers/&lt;/code>ç›®å½•ä¸‹æ–°å»ºäº†ä¸€ä¸ªinitializerï¼Œä¸»è¦ç”¨äºåœ¨é¡¹ç›®å¯åŠ¨æ—¶åŠ è½½é…ç½®ä¿¡æ¯ï¼Œå…³é”®ä»£ç æ®µï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">RemoteDatabase&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> &lt;span style="font-weight:bold">self&lt;/span>.fields_map
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">return&lt;/span> @fields_map &lt;span style="font-weight:bold">if&lt;/span> @fields_map
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @fields_map ||=
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> YAML::load_file(Rails.root.join(&lt;span style="font-style:italic">&amp;#39;config&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;local_to_remote_oracle_database_map.yml&amp;#39;&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ‰€ä»¥ï¼Œä»¥ååªè¦ä½¿ç”¨&lt;code>RemoteDatabase.fields_map&lt;/code>å°±èƒ½è¯»å–åˆ°æ‰€æœ‰æ•°æ®å­—æ®µæ˜ å°„å…³ç³»äº†ï¼&lt;/p>
&lt;p>ä¸‡äº‹ä¿±å¤‡ä¹‹åï¼Œæˆ‘æœ€åéœ€è¦åšçš„äº‹æƒ…å°±æ˜¯æŠŠConcernä¸­çš„å¸¸é‡æ›¿æ¢ä¸ºä»YAMLä¸­è¯»å–åˆ°çš„é…ç½®å°±å¥½äº†ï¼Œé‡æ„åçš„ä»£ç ä¸ºï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>module ImportDataConcern
extend ActiveSupport::Concern
module ClassMethods
def importing_fields_map
return @fields_map if @fields_map
@fields_map =
RemoteDatabase.fields_map[:default].merge(
RemoteDatabase.fields_map[:models][self.name.underscore]
)
end
def import_data_from_remote
remote_objects = remote_database[importing_fields_map[:remote_table_name]].page(page)
remote_objects.each do |remote_object|
# é€šè¿‡å€¼å”¯ä¸€çš„å±æ€§æŸ¥æ‰¾å¯¹è±¡
remote_unique_field_name = importing_fields_map[:remote_unique_field_name]
remote_unique_field = remote_object[importing_fields_map[:local_to_remote_fields_map][remote_unique_field_name]]
local_object = find_or_initialize_by(remote_unique_field_name =&amp;gt; remote_unique_field)
local_to_remote_fields_map = importing_fields_map[:local_to_remote_fields_map]
# é€ä¸€è®¾ç½®æœ¬åœ°å¯¹è±¡éœ€è¦å¯¹æ¥çš„å„ä¸ªå±æ€§
local_to_remote_fields_map.keys.each do |attribute|
local_object.send(&amp;#34;#{attribute}=&amp;#34;, remote_object[importing_fields_map[:local_to_remote_fields_map][attribute]])
end
# ... å…³è”å…³ç³»çš„ä¿å­˜
next unless local_object.changes.any?
local_object.save
end
end
end
end
&lt;/code>&lt;/pre>&lt;p>ä¸Šé¢ä»£ç ä¸­ï¼Œ&lt;code>importing_fields_map&lt;/code>è¯»å–ä¸å½“å‰ModelåŒ¹é…çš„å­—æ®µæ˜ å°„å…³ç³»ï¼Œå…¶å†…éƒ¨å…ˆé€šè¿‡&lt;code>RemoteDatabase.fields_map[:default]&lt;/code>åŠ è½½äº†é»˜è®¤çš„é…ç½®ï¼Œç„¶åé€šè¿‡merge&lt;code>RemoteDatabase.fields_map[:models][self.name.underscore]&lt;/code>å¾—åˆ°å½“å‰modelä¸“å±çš„é…ç½®ï¼Œå…¶ä¸­çš„&lt;code>self.name.underscore&lt;/code>çš„å€¼ç±»ä¼¼äº&lt;code>'student'&lt;/code>æˆ–è€…&lt;code>'teacher'&lt;/code>ã€‚&lt;/p>
&lt;p>åœ¨åç»­çš„ä»£ç ä¸­ï¼ŒåŸºæœ¬è·Ÿå‰é¢åˆ—ä¸¾çš„ä»£ç ä¸€è‡´ï¼Œåªæ˜¯å°†å„ç§å¸¸é‡å¯¹åº”æ›¿æ¢ä¸ºé€šè¿‡&lt;code>local_to_remote_fields_map&lt;/code>å­˜å‚¨çš„é…ç½®ï¼Œå¹¶ä¸”åˆ é™¤&lt;code>Student&lt;/code>ä»¥åŠ&lt;code>Teacher&lt;/code>çš„å¤šä½™å¸¸é‡ï¼Œåœ¨æ­¤å°±ä¸åˆ—ä¸¾ç¤ºä¾‹ä»£ç äº†ã€‚&lt;/p>
&lt;p>åœ¨æ•´ä¸ªé‡æ„çš„è¿‡ç¨‹ä¸­ï¼Œä»£ç æ˜¯è¶Šæ¥è¶ŠæŠ½è±¡çš„ï¼Œä½†æ˜¯ä»£ç æœ¬èº«å´ä¹Ÿå› æ­¤å˜å¾—è¶Šæ¥è¶Šçµæ´»ï¼Œè€Œè‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œå…¨å°†å­—æ®µæ˜ å°„å…³ç³»ä»Rubyä»£ç ä¸­å‰¥ç¦»ï¼Œå‡ä½¿ä»¥åè¿˜éœ€è¦å¯¼å…¥å…¶ä»–æ•°æ®ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹YAMLæ–‡ä»¶ï¼Œè€Œä¸å†éœ€è¦ç¢°ä»»ä½•Rubyä»£ç ï¼Œé™¤éæˆ‘ä»¬éœ€è¦ä¿®æ”¹é…ç½®é¡¹çš„ç»“æ„ã€‚&lt;/p>
&lt;h3 id="æ”¶è·é‡æ„åçš„æœå®ä¸“ä¸šæ•°æ®çš„å¯¼å…¥">æ”¶è·é‡æ„åçš„æœå®ï¼šä¸“ä¸šæ•°æ®çš„å¯¼å…¥&lt;/h3>
&lt;p>åœ¨ç»å†è¿‡äº†å‡ æ¬¡é‡æ„åï¼Œä»Šå¤©å¼€å§‹å¯¼å…¥å­¦ç”Ÿä¸“ä¸šçš„æ•°æ®ï¼Œè€Œæˆ‘æ‰€éœ€è¦åšçš„å…¨éƒ¨äº‹æƒ…ï¼Œä»…ä»…åªæ˜¯åœ¨yamlæ–‡ä»¶ä¸­åŠ å…¥ä¸“ä¸šç›¸å…³çš„é…ç½®ï¼Œå¹¶ä¸”åœ¨ä¸“ä¸šçš„model&lt;code>Major&lt;/code>includeä¸€ä¸‹æ•°æ®å¯¼å…¥çš„Concernå°±è¡Œäº†ã€‚æ•´ä¸ªè¿‡ç¨‹å‡ åˆ†é’Ÿå°±å®Œæˆäº†ï¼Œç®€ç›´ä¸èˆ¬é¡ºæ»‘å•Šï¼&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>æœ€åç®€å•æ€»ç»“ä¸€ä¸‹é‡æ„å®Œçš„ä»£ç çš„ç‰¹ç‚¹å§ï¼š&lt;/p>
&lt;ul>
&lt;li>é¿å…äº†åœ¨modelæˆ–è€…concernä¸­ç”Ÿå‘½ä¸€å †å¸¸é‡æˆ–è€…æ–¹æ³•ï¼Œåˆ°å¤„å®šä¹‰çš„å¸¸é‡ä¼šè®©æ˜ å°„å…³ç³»çš„ç®¡ç†éå¸¸åˆ†æ•£&lt;/li>
&lt;li>é¿å…ä¸åŒå‘½åç©ºé—´ä¸‹çš„åŒåå¸¸é‡ï¼Œæ¯”å¦‚&lt;code>Student::LOCAL_TO_REMOTE_FIELDS_MAP&lt;/code>ä»¥åŠ&lt;code>Teacher::LOCAL_TO_REMOTE_FIELDS_MAP&lt;/code>&lt;/li>
&lt;li>æ›´é›†ä¸­çš„å­—æ®µæ˜ å°„å…³ç³»é…ç½®ï¼Œé¿å…é”™æ¼&lt;/li>
&lt;li>é€»è¾‘è·Ÿæ˜ å°„å…³ç³»è§£è€¦ï¼Œæ›´ç®€æ´ç¨³å¥çš„ä»£ç &lt;/li>
&lt;li>è‡ªé€‚åº”æ–°çš„æ•°æ®è¡¨å¯¼å…¥ï¼Œä¸éœ€è¦å†ä¿®æ”¹æˆ–è€…æ·»åŠ Rubyä»£ç ï¼Œé…ç½®å³æ’å³ç”¨&lt;/li>
&lt;/ul>
&lt;h3 id="é—®é¢˜">é—®é¢˜&lt;/h3>
&lt;ul>
&lt;li>å¦‚æœæ¶‰åŠå¤æ‚å…³è”ï¼Œå¦‚ä½•æ›´å¥½åœ°æ‰©å±•ï¼Ÿ
ç°åœ¨çš„æ•°æ®å¯¹æ¥æ˜¯æœ‰é™åˆ¶çš„ï¼Œå°±æ˜¯æ•°æ®æœ¬èº«æ¯”è¾ƒè§„åˆ™ï¼Œå‡ ä¹æ˜¯ä¸€å¼ è¡¨åˆ°ä¸€å¼ è¡¨çš„å¯¹æ¥ï¼Œä½†æ˜¯å¦‚æœæ¶‰åŠä¸€å¼ è¡¨åˆ°å¤šå¼ è¡¨ä¹‹é—´çš„å¯¹æ¥ï¼Œæ˜¯å¦å¯ä»¥ç»§ç»­å†å°†ä»¥ä¸Šä»£ç æ‰©å±•ï¼Ÿ&lt;/li>
&lt;/ul>
&lt;div class="footnotes" role="doc-endnotes">
&lt;hr>
&lt;ol>
&lt;li id="fn:1">
&lt;p>è¯´æ˜¯åŸºæœ¬æ•°æ®ï¼Œæ˜¯å› ä¸ºè¿™ç¯‡æ–‡ç« ä»‹ç»çš„æ–¹æ¡ˆç›®å‰ä»…é’ˆå¯¹æ•°æ®å…³è”ä¸æ˜¯ç‰¹åˆ«å¤æ‚çš„åœºæ™¯ï¼Œè€Œä¸”ä»‹ç»çš„åœºæ™¯ï¼Œæ•°æ®çš„å¯¼å…¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼ŒåŸºæœ¬æ˜¯ä»è¿œç¨‹æ•°æ®åº“ä¸­å–å€¼ï¼Œç„¶åå†ç›´æ¥èµ‹å€¼åˆ°é¡¹ç›®æ•°æ®åº“çš„è®°å½•ä¸­ã€‚å¯¹äºéœ€è¦åœ¨æ•°æ®å¯¼å…¥è¿‡ç¨‹ä¸­åšå¤æ‚çš„æ•°æ®åˆ†æçš„æ¡ˆä¾‹ï¼Œæˆ‘æš‚æ—¶ä¹Ÿæ²¡æœ‰å°è¯•è¿‡ï¼Œä¸è¿‡æˆ‘é¢„è®¡å¯ä»¥å°è¯•ä½¿ç”¨Rubyä¸­çš„ä»£ç å—çš„æ–¹å¼è§£å†³ï¼Œä½†æ˜¯åœ¨æ­¤ä¸èµ˜è¿°ã€‚&amp;#160;&lt;a href="#fnref:1" class="footnote-backref" role="doc-backlink">&amp;#x21a9;&amp;#xfe0e;&lt;/a>&lt;/p>
&lt;/li>
&lt;/ol>
&lt;/div></description></item><item><title>sublime text 2åŸºäºè¯­æ³•çš„é…ç½®æ–‡ä»¶</title><link>https://blog.hackerpie.com/posts/archive/sublime-text-2ji-yu-yu-fa-de-pei-zhi-wen-jian/</link><pubDate>Sun, 03 Aug 2014 23:13:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/sublime-text-2ji-yu-yu-fa-de-pei-zhi-wen-jian/</guid><description>&lt;p>æœ€è¿‘åœ¨å­¦ä¹ Pythonç¼–ç¨‹è¯­è¨€ï¼Œä½†æ˜¯é‡åˆ°ä¸€ä¸ªå°å°çš„é—®é¢˜ï¼Œå°±æ˜¯åŸæ¥Rubyçš„ç¼–ç è§„èŒƒæ˜¯ç”¨2ä¸ªç©ºæ ¼ç¼©è¿›çš„ï¼Œæ‰€ä»¥ä»¥å‰åœ¨Sublimeçš„å…¨å±€ç”¨æˆ·é…ç½®ä¸­è®¾ç½®äº†&lt;code>&amp;quot;tab_size&amp;quot;: 2&lt;/code>ï¼Œæ‰€ä»¥åœ¨ç¼–è¾‘Pythonæ–‡ä»¶çš„æ—¶å€™å°±æ¯æ¬¡éƒ½è¦ä»èœå•ä¸­è®¾ç½®&lt;code>tab_size&lt;/code>çš„å¤§å°ä¸º4ã€‚åæ¥ç»è¿‡æœç´¢ï¼Œå‘ç°Sublime Text 2å®é™…ä¸Šæ˜¯æ”¯æŒè¯­æ³•ç‰¹å®šçš„é…ç½®çš„ï¼Œå…·ä½“çš„æ­¥éª¤æ˜¯ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;ol>
&lt;li>
&lt;p>å…ˆæ‰“å¼€ä¸€ä¸ªPythonä»£ç æ–‡ä»¶ï¼Œæˆ–è€…æ˜¯è®¾ç½®å½“å‰æ–‡ä»¶çš„è¯­æ³•ä¸º&amp;quot;Python&amp;quot;ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ç‚¹å‡»èœå•æ ä¸­çš„â€œSublime Text 2 -&amp;gt; Preferences -&amp;gt; Settings - More -&amp;gt; Syntax Specific - Userâ€ï¼›&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¯ä»¥çœ‹åˆ°æ‰“å¼€äº†ä¸€ä¸ªåå­—ä¸º&amp;quot;Python.sublime-setting&amp;quot;çš„æ–‡ä»¶ï¼Œå¦‚æœæ‰“å¼€çš„æ–‡ä»¶çš„åå­—ä¸æ˜¯Pythonï¼Œè¯·å›å¤´æ£€æŸ¥ç¬¬ä¸€æ­¥ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åœ¨æ‰“å¼€çš„ç‰¹å®šè¯­è¨€çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œç›´æ¥è®¾ç½®:&lt;/p>
&lt;pre tabindex="0">&lt;code>{ &amp;#34;tab_size&amp;#34;: 4, &amp;#34;translate_tabs_to_spaces&amp;#34;: true }
&lt;/code>&lt;/pre>&lt;p>ä»¥ä¸Šçš„è®¾ç½®ä¼šé»˜è®¤è¦†ç›–å…¨å±€é…ç½®ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>ä»¥ä¸Šæ­¥éª¤å‚è€ƒè‡ª&lt;a href="http://lukecafe.com/2013/03/daily-tips-sublime-text2-setting-and-ipa-generation/">ä»Šæ—¥æŠ€å·§ï¼šSublime Text 2è¯­æ³•ç¼©è¿›é…ç½®å’Œipaæ–‡ä»¶ç”Ÿæˆ&lt;/a>ã€‚&lt;/p></description></item><item><title>Spree 2.3.0å·²ç»å‘å¸ƒ</title><link>https://blog.hackerpie.com/posts/archive/spree-2-dot-3-0yi-jing-fa-bu/</link><pubDate>Mon, 28 Jul 2014 21:32:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/spree-2-dot-3-0yi-jing-fa-bu/</guid><description>&lt;p>**å£°æ˜ï¼š**åŸæ–‡æ¥è‡ªSpreeå®˜æ–¹åšå®¢&lt;a href="http://spreecommerce.com/blog/spree-2-3-released">Spree 2.3.0 Released&lt;/a>ï¼ŒåŸæ–‡å‘å¸ƒæ—¥æœŸæ˜¯2014-06-30ï¼Œæœ¬æ–‡ä»…ä½œç¿»è¯‘ã€‚&lt;/p>
&lt;p>&lt;strong>ç®€è¦ä»‹ç»ï¼š&lt;/strong>&lt;a href="http://spreecommerce.com/">Spree&lt;/a>æ˜¯ä¸€ä¸ªåŸºäº&lt;a href="http://rubyonrails.org/">Ruby on Rails&lt;/a>å¼€å‘çš„å¼€æºåœ¨çº¿å•†åŸæ¡†æ¶ï¼Œæä¾›äº†ä»å•†å“å±•ç¤ºè´­ä¹°ã€ä¸‹å•æ”¯ä»˜åˆ°åº“å­˜ç®¡ç†ä»¥åŠè®¢å•ç®¡ç†ç­‰ä¸€ç³»åˆ—åŸºæœ¬åŠŸèƒ½ï¼Œå¹¶ä¸”æ”¯æŒé€šè¿‡ç¬¬ä¸‰æ–¹æ‰©å±•çš„å½¢å¼å®šåˆ¶æˆ–è€…æ‰©å±•æ¡†æ¶çš„åŠŸèƒ½ï¼Œæœ€æ–°ç‰ˆæœ¬çš„Spreeå·²ç»æ”¯æŒæœ€æ–°çš„Railsç‰ˆæœ¬ã€‚&lt;/p>
&lt;p>Spree 2.3çš„æœ€æ–°æ›´æ”¹å·²ç»åŠ å…¥å¯¹Rails 4.1çš„æ”¯æŒï¼Œæä¾›äº†æ›´å¥½çš„é…ç½®é¡¹çš„å­˜å‚¨ï¼Œæ›´å¥½çš„é’ˆå¯¹å¤šåº—é“ºçš„æ”¯æŒï¼Œä»¥åŠæ›´å¥½çš„æ¸¸å®¢è¿½è¸ªã€‚Spree 2.3çš„å‘å¸ƒï¼Œæœ‰èµ–äºæ€»çš„97ä½è´¡çŒ®è€…ä»¥åŠä»–ä»¬æ€»çš„700å¤šä¸ªçš„commitè®°å½•ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬éå¸¸å…´å¥‹åœ°å®£å¸ƒï¼šSpree 2.3å‘å¸ƒäº†ï¼&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h3 id="rails-41-çš„æ”¯æŒ">Rails 4.1 çš„æ”¯æŒ&lt;/h3>
&lt;p>ç°åœ¨ï¼ŒRails 4.1å·²ç»å¾—åˆ°äº†Spree 2.3çš„æ”¯æŒã€‚å¦‚æœä½ å¸Œæœ›åŸºäºRails 4.1è¿›è¡Œå¼€å‘ï¼Œé‚£ä¹ˆSpree 2.3å°±æ˜¯ç‰¹ä¸ºä½ å‡†å¤‡çš„å‘å¸ƒç‰ˆã€‚&lt;/p>
&lt;h3 id="åŸºäºåºåˆ—åŒ–è®°å½•çš„é…ç½®é¡¹">åŸºäºåºåˆ—åŒ–è®°å½•çš„é…ç½®é¡¹&lt;/h3>
&lt;p>ç°åœ¨ï¼Œæ‰€æœ‰çš„é…ç½®é¡¹å­˜å‚¨åœ¨ä¸€ä¸ªè®°å½•ä¸Šï¼Œè€Œä¸æ˜¯å­˜å‚¨åœ¨&lt;code>spree_preferences&lt;/code>è¡¨ä¸­ã€‚è¿™æ„å‘³ç€ï¼Œä¸ºäº†è·å–ä¸€ä¸ªé…ç½®é¡¹ï¼Œæ¯”å¦‚ä»·æ ¼çš„è®¡ç®—å™¨é…ç½®ï¼Œå°±ä¼šè§¦å‘ä¸€ä¸ªæ•°æ®åº“æŸ¥è¯¢ï¼Œæ‰€æŸ¥è¯¢çš„é‚£ä¸€è¡Œè®°å½•æœ‰ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰é…ç½®ä¿¡æ¯çš„å‘½åä¸º&lt;code>preferences&lt;/code>çš„åˆ—ã€‚&lt;/p>
&lt;p>è€Œåœ¨æ­¤ä¹‹å‰ï¼Œå¯¹äºæ¯ä¸€ä¸ªé…ç½®è®°å½•æœ¬èº«ï¼Œå¯èƒ½éƒ½ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åº“è°ƒç”¨ï¼Œè€Œåœ¨æŸ¥è¯¢åˆ°æ‰€è¯·æ±‚çš„é…ç½®é¡¹ä¹‹åï¼Œè¿˜æ˜¯æœ‰å¯èƒ½ä¼šæœ‰ä»»æ„æ•°ç›®çš„æ•°æ®åº“è°ƒç”¨äº§ç”Ÿã€‚è€Œç°åœ¨ï¼Œæˆ‘ä»¬æ€»çš„åªéœ€è¦è°ƒç”¨ä¸€æ¬¡ï¼Œè¿™æ„å‘³ç€ç¨‹åºæœ¬èº«å°†ä¼šæœ‰ä¸€äº›é€Ÿåº¦ä¸Šçš„æå‡ã€‚&lt;/p>
&lt;h3 id="æ›´å¥½çš„å¤šåº—é“ºæ”¯æŒ">æ›´å¥½çš„å¤šåº—é“ºæ”¯æŒ&lt;/h3>
&lt;p>æˆ‘ä»¬å·²ç»æ·»åŠ äº†ä¸€ä¸ªåä¸º&lt;code>Spree::Store&lt;/code>çš„modelï¼Œç”¨äºæ”¯æŒåŸºæœ¬çš„å¤šåº—é“º/å¤šåŸŸåçš„ç«™ç‚¹ã€‚å…¶åœ¨&lt;code>spree-multi-domain&lt;/code>è¿™ä¸ªæ‰©å±•çš„åŸºç¡€ä¸Šæä¾›äº†é’ˆå¯¹å¤šåº—é“º/å¤šåŸŸåçš„åŸºæœ¬æ¡†æ¶ã€‚ä¸€äº›åŸæœ‰çš„é…ç½®é¡¹è¢«è½¬ç§»åˆ°äº†è¿™ä¸ªmodelä¸Šï¼Œä»¥æ­¤å®ç°æ ¹æ®å…·ä½“çš„åº—é“ºæä¾›ä¸åŒé…ç½®å€¼ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>Spree::Config[:site_name]&lt;/code> è¿ç§»åˆ°äº† &lt;code>name&lt;/code>&lt;/li>
&lt;li>&lt;code>Spree::Config[:site_url]&lt;/code> è¿ç§»åˆ°äº† &lt;code>url&lt;/code>&lt;/li>
&lt;li>&lt;code>Spree::Config[:default_meta_description]&lt;/code> è¿ç§»åˆ°äº† &lt;code>meta_description&lt;/code>&lt;/li>
&lt;li>&lt;code>Spree::Config[:default_meta_keywords]&lt;/code> è¿ç§»åˆ°äº† &lt;code>meta_keywords&lt;/code>&lt;/li>
&lt;li>&lt;code>Spree::Config[:default_seo_title]&lt;/code> è¿ç§»åˆ°äº† &lt;code>seo_title&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>ä¸€ä¸ªæ•°æ®åº“è¿ç§»æ–‡ä»¶å°†ä¼šè´Ÿè´£æŠŠè¿™äº›åŸæœ‰çš„é…ç½®é¡¹è½¬ç§»åˆ°ä¸€ä¸ªæ–°çš„é»˜è®¤çš„storeå®ä¾‹ä¸Šã€‚&lt;/p>
&lt;p>ä¸€ä¸ªæ–°çš„åä¸º&lt;code>ControllerHelpers::Store&lt;/code>çš„Concernæä¾›äº†ä¸€ä¸ª&lt;code>current_store&lt;/code>helperï¼Œå¯ä»¥åœ¨è¯·æ±‚çš„åŸŸåçš„åŸºç¡€ä¸Šï¼Œé€šè¿‡å®ƒè·å–å½“å‰åº—é“ºã€‚&lt;/p>
&lt;h3 id="æ›´å¥½çš„æ¸¸å®¢è¿½è¸ª">æ›´å¥½çš„æ¸¸å®¢è¿½è¸ª&lt;/h3>
&lt;p>ç°åœ¨ï¼Œæˆ‘ä»¬ç”¨äº†ä¸€ä¸ªç­¾åçš„cookieåœ¨æµè§ˆå™¨ä¸­å­˜å‚¨æ¸¸å®¢çš„å”¯ä¸€çš„tokenã€‚é€šè¿‡å®ƒå…è®¸å…³é—­äº†æµè§ˆå™¨çš„é¡¾å®¢å¯ä»¥åœ¨å†æ¬¡è®¿é—®æ—¶ç»§ç»­å®Œæˆä»–ä»¬çš„è´­ç‰©æµç¨‹ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œè¿™ä¹Ÿå¸®åŠ©ä½œä¸ºå•†åº—ä¸»äººçš„ä½ æ–¹ä¾¿åœ°è¯†åˆ«æ¸¸å®¢çš„è®¢å•ã€‚ç”±äºæˆ‘ä»¬åœ¨è®¿å®¢æ¥è®¿æ—¶éƒ½ä¼šè®¾ç½®&lt;code>cookies.signed[:guest_token]&lt;/code>ï¼Œæ‰€ä»¥é™¤äº†è®¢å•ï¼Œæˆ–è®¸ä½ å¯ä»¥æŠŠcookieç”¨äºå…¶ä»–ç”¨é€”ã€‚&lt;/p>
&lt;p>ä¸¾ä¸ªå®é™…ä¾‹å­ï¼Œå¦‚æœæ¸¸å®¢éœ€è¦æ”¶è—ä¸€ä¸ªå•†å“ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªç”¨äºè®°å½•æ”¶è—è®°å½•çš„modelï¼Œç„¶åæŠŠ&lt;code>cookies.signed[:guest_token]&lt;/code>èµ‹å€¼ç»™è¿™ä¸ªmodelä¸­çš„&lt;code>token&lt;/code>å­—æ®µã€‚è¿™å°†æœ‰åŠ©äºä½ åˆ†æå½“å‰ç”¨æˆ·åœ¨æ­¤ä¹‹å‰çš„è®¢å•ä»¥åŠæ”¶è—è®°å½•ï¼Œè¿™å¯¹äºå•†å“æ¨èå°†æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>ä½ å¯ä»¥ä»&lt;a href="https://github.com/spree/spree/releases/tag/v2.3.0">Github&lt;/a>ä¸Šæµè§ˆæ›´è¯¦ç»†çš„å˜æ›´åˆ—è¡¨ã€‚&lt;/p></description></item><item><title>Run a shell script auto-matically when entering/cd a directory</title><link>https://blog.hackerpie.com/posts/archive/run-a-shell-script-auto-matically-when-entering-a-directory/</link><pubDate>Sun, 04 May 2014 10:32:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/run-a-shell-script-auto-matically-when-entering-a-directory/</guid><description>&lt;p>I don&amp;rsquo;t know if it is common that you need to run some shell scripts which are used under only some directories, such as, one of your Rails projects.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>Today I find that I always need to run &lt;code>rspec&lt;/code> command with a &lt;code>SPEC&lt;/code> option, which specifies spec files to be run. In short, everytime I should type the following command in my terminal:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>rake spec SPEC=spec/lib/
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>It is convenient to run this command as an &lt;strong>alias&lt;/strong>, but I don&amp;rsquo;t want to write this alias into the &lt;code>~/.bash_profile&lt;/code>, because it should be available under the current directory only. But how?&lt;/p>
&lt;p>Thanks to the powerful bash shell and its function, we can rewrite the built-in &lt;code>cd&lt;/code> command through a function named &lt;strong>cd&lt;/strong>. The following are steps:&lt;/p>
&lt;ol>
&lt;li>Open your &lt;code>~/.bash_profile&lt;/code>, and insert:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">function&lt;/span> cd {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># actually change the directory with all args passed to the function&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> builtin cd &lt;span style="font-style:italic">&amp;#34;&lt;/span>$@&lt;span style="font-style:italic">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># if there&amp;#39;s a regular file named &amp;#34;.bash_local&amp;#34;...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> [ -f &lt;span style="font-style:italic">&amp;#34;.bash_local&amp;#34;&lt;/span> ] ; &lt;span style="font-weight:bold">then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># source its contents&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> source .bash_local
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>And then source it in your terminal:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ source ~/.bash_profile
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>Create new file named &lt;code>.bash_local&lt;/code> under your target directories(on my machine, it is &lt;code>~/development/rails-dev/graduation-project/&lt;/code>), and then insert:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>alias rspec_lib=&lt;span style="font-style:italic">&amp;#39;rake spec SPEC=spec/lib/&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>Now cd the directory, and the alias &lt;code>rspec_lib&lt;/code> will be available auto-matically:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ cd ~/development/rails-dev/graduation-project/
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ rspec_lib
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; .....
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Finished in 0.00617 seconds
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>5 examples, 0 failures
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Randomized with seed 23543
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="tips">Tips&lt;/h3>
&lt;p>Please consider if it is necessary to check &lt;code>.bash_local&lt;/code> into your git repo. If not, remember to add it to the &lt;code>.gitignore&lt;/code> file.&lt;/p>
&lt;h3 id="todo">TODO&lt;/h3>
&lt;p>When leave the directory, how to &lt;strong>&amp;ldquo;un-source&amp;rdquo;&lt;/strong> the sourced file, that is, make &lt;code>rspec_lib&lt;/code> unavailable?&lt;/p>
&lt;h3 id="related-links">Related Links&lt;/h3>
&lt;ol>
&lt;li>&lt;a href="http://superuser.com/questions/283352/how-do-you-run-a-shell-command-script-automatically-when-entering-cd-ing-a-direc">How do you run a shell command/script automatically when entering/cd-ing a directory on Snow Leopard?&lt;/a>&lt;/li>
&lt;li>&lt;a href="http://stackoverflow.com/questions/8760505/is-it-possible-to-unsource-in-bash">Is it possible to â€œunsourceâ€ in bash?&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>GemfileæŒ‡å®šgemæ¥æºçš„å››ç§æ–¹å¼</title><link>https://blog.hackerpie.com/posts/archive/gemfilezhi-ding-gemlai-yuan-de-si-chong-fang-shi/</link><pubDate>Thu, 03 Apr 2014 00:30:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/gemfilezhi-ding-gemlai-yuan-de-si-chong-fang-shi/</guid><description>&lt;p>Gemfileçš„ä½œç”¨æ— éå°±æ˜¯å‘Šè¯‰bundlerä½ çš„é¡¹ç›®å…·ä½“éƒ½éœ€è¦å“ªäº›gemï¼Œè¿™äº›geméƒ½éœ€è¦å“ªäº›ç‰ˆæœ¬ï¼Œä»¥åŠä»å“ªè·å–è¿™äº›gemã€‚å…¶å®ä½ çš„é—®é¢˜åº”è¯¥å°±æ˜¯è·Ÿç¬¬ä¸‰ç‚¹æœ‰å…³ï¼Œæ€»çš„æ¥è¯´ï¼Œgemçš„æ¥æºå¯ä»¥æœ‰å››ç§ï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h4 id="1-ä»é•œåƒæºå®‰è£…">1. ä»é•œåƒæºå®‰è£…&lt;/h4>
&lt;p>è¿™ä¸ªæ˜¯æœ€ç›´æ¥çš„ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æŒ‡å®šçš„gemï¼Œbundlerä¼šä»æ–‡ä»¶å¼€å¤´çš„&lt;code>source&lt;/code>ä¸­å»æŸ¥æ‰¾è¿™ä¸ªgemï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>source &lt;span style="font-style:italic">&amp;#39;https://rubygems.org&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#39;rails&amp;#39;&lt;/span> &lt;span style="font-style:italic"># this gem will be installed from https://rubygems.org&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="2-ä»gitä»£ç åº“å®‰è£…">2. ä»gitä»£ç åº“å®‰è£…&lt;/h4>
&lt;p>é€šè¿‡åœ¨&lt;code>gem&lt;/code>æ–¹æ³•ï¼ˆGemfileå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªrubyçš„ä»£ç æ–‡ä»¶ï¼‰ä¸­æŒ‡å®š&lt;code>git&lt;/code>å‚æ•°ï¼Œå¯ä»¥ä½¿bundlerä»æŒ‡å®šçš„è¿œç¨‹ä»£ç åº“ä¸Šæ‹‰å–ä»£ç ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># nokogiri will be installed from git://github.com/tenderlove/nokogiri.git&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#39;nokogiri&amp;#39;&lt;/span>, &lt;span style="font-style:italic">:git&lt;/span> =&amp;gt; &lt;span style="font-style:italic">&amp;#39;git://github.com/tenderlove/nokogiri.git&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="3-ä»githubå®‰è£…">3. ä»githubå®‰è£…&lt;/h4>
&lt;p>ä¸Šé¢ç¬¬2ç§æ–¹æ³•åªæ˜¯é’ˆå¯¹æ‰€æœ‰åˆæ³•çš„gitä»£ç åº“ï¼ˆä¸ä»…ä»…æ˜¯githubï¼Œä¹Ÿå¯ä»¥æ˜¯ä½ è‡ªå·±çš„ä¸€ä¸ªgitæœåŠ¡å™¨ä¸Šä¸€ä¸ªä»£ç åº“ï¼‰è€Œè¨€ï¼Œè€Œå¦‚æœä½ æ‰€éœ€è¦çš„åº“æ¥è‡ªäºgithubï¼Œåˆ™å¯ä»¥é€šè¿‡æ›´æ–¹ä¾¿çš„&lt;code>github&lt;/code>å‚æ•°å®ç°ç›®æ ‡:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#39;nokogiri&amp;#39;&lt;/span>, &lt;span style="font-style:italic">:github&lt;/span> =&amp;gt; &lt;span style="font-style:italic">&amp;#39;tenderlove/nokogiri&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹åˆ°ï¼Œåªè¦æŒ‡å®šäº†&lt;code>author/repo_name&lt;/code>çš„å½¢å¼ï¼Œbundlerå°±èƒ½è‡ªåŠ¨ä»githubä¸Šè·å–ä½ æ‰€éœ€è¦çš„gemäº†ã€‚
&lt;strong>æ³¨æ„&lt;/strong>: ç¬¬2è·Ÿç¬¬3ç§æ–¹å¼è¿˜éƒ½å¯ä»¥é€šè¿‡&lt;code>branch&lt;/code>å‚æ•°æŒ‡å®šä½ æ‰€éœ€è¦çš„ä»£ç åˆ†æ”¯ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#39;refinerycms&amp;#39;&lt;/span>, &lt;span style="font-style:italic">github&lt;/span>: &lt;span style="font-style:italic">&amp;#39;refinery/refinerycms&amp;#39;&lt;/span>, &lt;span style="font-style:italic">branch&lt;/span>: &lt;span style="font-style:italic">&amp;#39;master&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="4-ä»æ–‡ä»¶ç³»ç»Ÿä¸­å®‰è£…">4. ä»æ–‡ä»¶ç³»ç»Ÿä¸­å®‰è£…&lt;/h4>
&lt;p>å‡å¦‚ä½ æœ‰ä¸€ä¸ªå·²ç»æ”¾åœ¨é¡¹ç›®ç›®å½•ä¸­ï¼ˆå…¶å®å¯ä»¥æ˜¯ä»»ä½•åœ°æ–¹ï¼‰çš„gemï¼Œåˆ™å¯ä»¥é€šè¿‡&lt;code>path&lt;/code>å‚æ•°æŒ‡å®šæ‰€éœ€çš„gemåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½ç½®ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#34;rails&amp;#34;&lt;/span>, &lt;span style="font-style:italic">:path&lt;/span> =&amp;gt; &lt;span style="font-style:italic">&amp;#34;vendor/rails&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>bundlerå°†ä¼šæ ¹æ®pathæŒ‡å®šçš„è·¯å¾„å»æŸ¥æ‰¾å¹¶ä¸”å®‰è£…gemã€‚&lt;/p>
&lt;h3 id="æœ€åè¯´ä¸€ä¸‹">æœ€åè¯´ä¸€ä¸‹&lt;/h3>
&lt;p>æœ€åé¡ºä¾¿è¯´ä¸‹æˆ‘çš„ä¸€ç‚¹ä½“ä¼šï¼Œä¸€èˆ¬åƒè¿™ç§gemæ¥è‡ªäºé¡¹ç›®ç›®å½•ä¸‹çš„æƒ…å†µï¼Œå¤§å¤šæ˜¯å› ä¸ºé¡¹ç›®ä¸­ç”¨åˆ°äº†ä¸€äº›æä¾›æ‰©å±•æœºåˆ¶çš„æ¡†æ¶ï¼Œæ¯”å¦‚&lt;strong>Spree&lt;/strong>ä»¥åŠ&lt;strong>Refinery&lt;/strong>ï¼Œè¿™ä¸¤è€…ç”Ÿæˆçš„æ‰©å±•æˆ–è€…å­Engineéƒ½æ˜¯ä»¥gemçš„å½¢å¼æ”¾åœ¨vendoræˆ–è€…libç›®å½•ä¸‹ï¼Œç„¶åä»Gemfileé‡Œè¾¹è¿›è¡ŒæŒ‡å®šï¼Œæ¯”å¦‚æˆ‘çš„ä¸€ä¸ªé¡¹ç›®ä¸­çš„ä¸€ä¸ªå®ä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>gem &lt;span style="font-style:italic">&amp;#39;refinerycms-factories&amp;#39;&lt;/span>, &lt;span style="font-style:italic">:path&lt;/span> =&amp;gt; &lt;span style="font-style:italic">&amp;#39;vendor/extensions&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>refinerycms-factoriesæ˜¯æˆ‘ç”¨Refineryçš„generatorç”Ÿæˆçš„ä¸€ä¸ªå­engineï¼Œé»˜è®¤æ”¾åœ¨&lt;code>verdor/extensions&lt;/code>ç›®å½•ä¸‹ã€‚&lt;/p>
&lt;p>å¦ä¸€ç§å¯èƒ½æ¯”è¾ƒå¸¸è§çš„æƒ…å†µå°±æ˜¯ä½ ç”¨åˆ°äº†æŸä¸ªå¯èƒ½ä¸å†ç»´æŠ¤çš„gemï¼Œç”±äºå¯¹æºä»£ç çš„æ”¹åŠ¨è¾ƒå¤§ï¼Œæ‰€ä»¥ä½ å¹²è„†æŠŠè¿™ä¸ªgemçš„æºä»£ç ä¸‹è½½åˆ°æœ¬åœ°é¡¹ç›®ç›®å½•ä¸‹ï¼Œç„¶åç›´æ¥è¿›è¡Œä¿®æ”¹ï¼Œæœ€åé€šè¿‡&lt;code>path&lt;/code>å»å®‰è£…ã€‚&lt;/p>
&lt;h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™&lt;/h3>
&lt;p>å…³äºGemfiileçš„æ›´å¤šèµ„æ–™ï¼Œè¯·è‡ªè¡ŒçŒ›æˆ³ï¼š
&lt;a href="http://bundler.io/v1.5/gemfile.html">Bundler homepage&lt;/a>
&lt;a href="http://bundler.io/v1.5/man/gemfile.5.html">Gemfile manual page&lt;/a>&lt;/p></description></item><item><title>Rubyä¸­Hashçš„7ä¸ªæ—¥å¸¸ä½¿ç”¨èŒƒä¾‹</title><link>https://blog.hackerpie.com/posts/archive/rubyzhong-hashde-7ge-ri-chang-shi-yong-fan-li/</link><pubDate>Tue, 25 Mar 2014 20:05:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/rubyzhong-hashde-7ge-ri-chang-shi-yong-fan-li/</guid><description>&lt;p>æ­¤æ–‡ç¿»è¯‘è‡ª&lt;a href="http://blog.8thcolor.com/en/2014/03/7-daily-use-cases-of-ruby-hash/?utm_source=rubyweekly&amp;amp;utm_medium=email#json-to-hash">7 daily use cases of Ruby Hash&lt;/a>ï¼Œé™äºæœ¬äººæ°´å¹³ï¼Œç¿»è¯‘ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡æ•™ï¼&lt;/p>
&lt;p>æ¯ä¸€å¤©ï¼Œä½ éƒ½éœ€è¦è·ŸHashç›¸å¤„ã€‚åˆ›å»ºä¸€ä¸ªæ–°çš„Hashæˆ–è€…æ˜¯é€šè¿‡å®ƒçš„æŸä¸€ä¸ªé”®å»æ£€ç´¢å…¶ä¸­çš„å…ƒç´ è¿™æ ·çš„å·¥ä½œï¼Œéƒ½æ˜¯å¸¸è§ä¹Ÿæ˜¯éå¸¸ç®€å•çš„ã€‚ä½†æ˜¯å½“ä½ éœ€è¦åˆå¹¶ä¸¤ä¸ªåµŒå¥—çš„Hashæˆ–è€…æ˜¯ä»æŸä¸€ä¸ªHashé‡Œè¾¹è¿‡æ»¤æŸäº›é”®ï¼Œä½ å¯èƒ½éœ€è¦è€ƒè™‘å¾—å¤šä¸€ç‚¹ã€‚é€šè¿‡å®Œæ•´çš„&lt;a href="http://ruby-doc.org/">æ–‡æ¡£&lt;/a>ï¼Œä½ å¯ä»¥æ‰¾åˆ°å¯¹Hashä¸­çš„æ¯ä¸€ä¸ªæ–¹æ³•çš„å……åˆ†è§£é‡Šã€‚ä½†æ˜¯ç”±äºæ–‡æ¡£ä¸æ˜¯é¢å‘åº”ç”¨åœºæ™¯çš„ï¼Œä½ å¯èƒ½æ²¡æ³•å¾ˆå¿«æ‰¾åˆ°ä½ çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨ä¸‹é¢ï¼Œæˆ‘åˆ†äº«äº†æˆ‘æ—¥å¸¸ä¸­ç»å¸¸é‡åˆ°çš„Hashä¸­çš„7ä¸ªå¸¸ç”¨åœºæ™¯ï¼Œå¸Œæœ›å®ƒä»¬å¯¹ä½ æœ‰ç”¨ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2 id="1-å¦‚ä½•å°†ä¸€ä¸ªjsonè½¬æ¢ä¸ºä¸€ä¸ªhash">1. å¦‚ä½•å°†ä¸€ä¸ªJSONè½¬æ¢ä¸ºä¸€ä¸ªHashï¼Ÿ&lt;/h2>
&lt;p>å‡è®¾ä½ åˆšåˆšæ¥æ”¶åˆ°ä¸€ä¸ªç”¨JSONè¡¨ç¤ºçš„Twitterè´¦å·çš„èµ„æ–™ä¿¡æ¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-json" data-lang="json">&lt;span style="display:flex;">&lt;span>&lt;span style="">data&lt;/span> &lt;span style="">=&lt;/span> &lt;span style="">&amp;#39;&lt;/span>{
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">&amp;#34;name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;Aaron Patterson&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">&amp;#34;screen_name&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;tenderlove&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">&amp;#34;location&amp;#34;&lt;/span>: &lt;span style="font-style:italic">&amp;#34;Seattle, WA&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}&lt;span style="">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ å¸Œæœ›èƒ½å¤Ÿå°†å®ƒè½¬åŒ–ä¸ºä¸€ä¸ªHash,è¿™æ ·ä¼šæ›´æ–¹ä¾¿ä½ è¿›è¡Œå¯¹æ•°æ®çš„æ“ä½œï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>require &lt;span style="font-style:italic">&amp;#39;json&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>profile = JSON.parse(data)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>** åœ¨IRBä¸­çš„è¾“å‡ºç»“æœï¼š**&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>=&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#34;Aaron Patterson&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;screen_name&amp;#34;&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#34;tenderlove&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#34;location&amp;#34;&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#34;Seattle, WA&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ–‡æ¡£ï¼š&lt;a href="http://www.ruby-doc.org/stdlib-2.1.0/libdoc/json/rdoc/JSON.html#method-i-parse">JSON#parse&lt;/a>&lt;/p>
&lt;h2 id="2-å¦‚ä½•å°†ä¸€ä¸ªhashè½¬æ¢ä¸ºä¸€ä¸ªjson">2. å¦‚ä½•å°†ä¸€ä¸ªHashè½¬æ¢ä¸ºä¸€ä¸ªJSONï¼Ÿ&lt;/h2>
&lt;p>åœ¨ä½ çš„webåº”ç”¨ç¨‹åºä¸­ï¼Œä½ éœ€è¦è¿½è¸ªå½“å‰æ˜ŸæœŸæ¯ä¸€å¤©æ–°æ³¨å†Œç”¨æˆ·çš„æ•°é‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>signups_of_the_week = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">monday&lt;/span>: 2,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">tuesday&lt;/span>: 3,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">wednesday&lt;/span>: 4,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">thursday&lt;/span>: 20,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">friday&lt;/span>: 5,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">saturday&lt;/span>: 2,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">sunday&lt;/span>: 5
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ å¯ä»¥é€šè¿‡APIçš„æ–¹å¼æŠŠå®ƒä»¬ä»¥JSONæ ¼å¼æä¾›ç»™å®¢æˆ·ç«¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>require &lt;span style="font-style:italic">&amp;#39;json&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>signups_of_the_week.to_json
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>** åœ¨IRBä¸­çš„è¾“å‡ºç»“æœï¼š**&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>=&amp;gt; &lt;span style="font-style:italic">&amp;#34;{&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">monday&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">:2,&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">tuesday&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">:3,&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">wednesday&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">:4,&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">thursday&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">:20,&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">friday&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">:5,&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">saturday&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">:2,&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">sunday&lt;/span>&lt;span style="font-weight:bold;font-style:italic">\&amp;#34;&lt;/span>&lt;span style="font-style:italic">:5}&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ–‡æ¡£ï¼š&lt;a href="http://www.ruby-doc.org/stdlib-2.1.0/libdoc/json/rdoc/JSON.html#method-i-generate">JSON#generate&lt;/a>
è¾¹æ³¨ï¼š&lt;a href="http://www.ruby-doc.org/stdlib-2.1.0/libdoc/json/rdoc/JSON.html#method-i-pretty_generate">JSON#pretty_generate&lt;/a>å¯¹äºæ›´å¥½çš„æ‰“å°ä»¥åŠè°ƒè¯•éå¸¸æœ‰ç”¨ã€‚&lt;/p>
&lt;h2 id="3-å¦‚ä½•ä¸ºä¸€ä¸ªåµŒå¥—çš„hashè®¾ç½®é»˜è®¤å€¼">3. å¦‚ä½•ä¸ºä¸€ä¸ªåµŒå¥—çš„Hashè®¾ç½®é»˜è®¤å€¼ï¼Ÿ&lt;/h2>
&lt;p>ä½ æœ‰ä¸€ä¸ªä»¥nameä¸ºç´¢å¼•çš„è”ç³»äººçš„é›†åˆï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªåµŒå¥—çš„Hashï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>contacts = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;John&amp;#39;&lt;/span> =&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: &lt;span style="font-style:italic">&amp;#39;John&amp;#39;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">email&lt;/span>: &lt;span style="font-style:italic">&amp;#39;john@doe.com&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;#39;Freddy&amp;#39;&lt;/span> =&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name &lt;span style="font-style:italic">&amp;#39;Freddy&amp;#39;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">email&lt;/span>: &lt;span style="font-style:italic">&amp;#39;freddy@mercury.com&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ä½ åœ¨å¤„ç†å•ä¸ªè”ç³»äººçš„æ—¶å€™ï¼Œä½ ä¸éœ€è¦æ¯ä¸€æ¬¡éƒ½æ£€æŸ¥å®ƒæ˜¯å¦å­˜åœ¨ã€‚ä½ åªéœ€è¦å†™ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>contacts[&lt;span style="font-style:italic">&amp;#39;Jane&amp;#39;&lt;/span>][&lt;span style="font-style:italic">:email&lt;/span>] = &lt;span style="font-style:italic">&amp;#39;jane@doe.com&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>puts contacts[&lt;span style="font-style:italic">&amp;#39;Jane&amp;#39;&lt;/span>]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>** IRBè¾“å‡º **:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>=&amp;gt; {&lt;span style="font-style:italic">:name&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#34;Jane&amp;#34;&lt;/span>, &lt;span style="font-style:italic">:email&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#34;jane@doe.com&amp;#34;&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ å¯ä»¥åœ¨åˆ›å»ºHashçš„æ—¶å€™é€šè¿‡è®¾ç½®ä»£ç å—æ¥å®ç°é»˜è®¤å€¼ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>contacts = Hash.new &lt;span style="font-weight:bold">do&lt;/span> |hsh, key|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> hsh[key] = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> name: key,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">email&lt;/span>: &lt;span style="font-style:italic">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…æ˜¯ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>contacts.default_proc = Proc.new &lt;span style="font-weight:bold">do&lt;/span> |hsh, key|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â hsh[key] = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â Â Â name: key,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â Â Â &lt;span style="font-style:italic">email&lt;/span>: &lt;span style="font-style:italic">&amp;#39;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ–‡æ¡£ï¼š&lt;a href="http://www.ruby-doc.org/core-2.1.0/Hash.html#method-c-new">Hash#new&lt;/a>, &lt;a href="http://www.ruby-doc.org/core-2.1.0/Hash.html#method-i-default_proc-3D">Hash#default_proc&lt;/a>&lt;/p>
&lt;h2 id="4-å¦‚ä½•åˆå¹¶ä¸¤ä¸ªåµŒå¥—çš„hash">4. å¦‚ä½•åˆå¹¶ä¸¤ä¸ªåµŒå¥—çš„Hashï¼Ÿ&lt;/h2>
&lt;p>åœ¨ä¸€ä¸ªåœ¨çº¿å•†åº—é‡Œï¼Œä½ æƒ³è¦å°†ä¸€ä¸ªå¿ƒæ„¿å•ä¸å½“å‰çš„è´­ç‰©ç¯®è¿›è¡Œåˆå¹¶ï¼Œè¿™ä¸¤è€…éƒ½æ˜¯ä»¥å•†å“çš„idå·ä½œä¸ºç´¢å¼•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>wish_list = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â 8 =&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â Â Â &lt;span style="font-style:italic">title&lt;/span>: &lt;span style="font-style:italic">&amp;#34;The Color of Magic&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â 42 =&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â Â Â &lt;span style="font-style:italic">title&lt;/span>: &lt;span style="font-style:italic">&amp;#34;The Hitch-Hiker&amp;#39;s Guide to the Galaxy&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â Â Â &lt;span style="font-style:italic">price&lt;/span>: 5
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>basket = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â 8 =&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â Â Â &lt;span style="font-style:italic">price&lt;/span>: 10
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â 1729 =&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â Â Â &lt;span style="font-style:italic">title&lt;/span>: &lt;span style="font-style:italic">&amp;#34;Ramanujan:Â  Twelve Lectures on Subjects Suggested by His Life and Work&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">price&lt;/span>: 28
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å€ŸåŠ©äºActiveSupport,ä½ å¯ä»¥ç®€å•åœ°å®ç°ä½ çš„ç›®æ ‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>require &lt;span style="font-style:italic">&amp;#39;active_support/core_ext/hash&amp;#39;&lt;/span> &lt;span style="font-style:italic"># not necessary if in Rails&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>basket.deep_merge(wish_list)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆæˆ–è€…ï¼Œåœ¨æ²¡æœ‰ActiveSupportçš„æƒ…å†µä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> deep_merge(h1, h2)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â h1.merge(h2) { |key, h1_elem, h2_elem| deep_merge(h1_elem, h2_elem) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>deep_merge(basket, wish_list)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>** IRBè¾“å‡º: **&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>=&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 8=&amp;gt;{&lt;span style="font-style:italic">:price&lt;/span>=&amp;gt;10, &lt;span style="font-style:italic">:title&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#34;The Color of Magic&amp;#34;&lt;/span>},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 1729=&amp;gt;{&lt;span style="font-style:italic">:title&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#34;Ramanujan: Twelve Lectures on Subjects Suggested by His Life and Work&amp;#34;&lt;/span>, &lt;span style="font-style:italic">:price&lt;/span>=&amp;gt;28},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 42=&amp;gt;{&lt;span style="font-style:italic">:title&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#34;The Hitch-Hiker&amp;#39;s Guide to the Galaxy&amp;#34;&lt;/span>, &lt;span style="font-style:italic">:price&lt;/span>=&amp;gt;5}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ–‡æ¡£ï¼š&lt;a href="http://www.ruby-doc.org/core-2.1.0/Hash.html#method-i-merge">Hash#merge&lt;/a>, &lt;a href="http://api.rubyonrails.org/classes/Hash.html#method-i-deep_merge">Hash#deep_merge&lt;/a>&lt;/p>
&lt;h2 id="5-å¦‚ä½•è¿‡æ»¤æ‰ä¸€ä¸ªhashä¸­çš„æŸäº›key">5. å¦‚ä½•è¿‡æ»¤æ‰ä¸€ä¸ªHashä¸­çš„æŸäº›keyï¼Ÿ&lt;/h2>
&lt;p>ä½ å·²ç»åˆ›å»ºäº†ä¸€ä¸ªè¡¨ç¤ºæ—¥é”€å”®é¢çš„çŸ©å½¢å›¾ï¼Œå¹¶ä¸”ä½ å°†å®ƒä»¥Hashçš„æ–¹å¼å­˜å‚¨ï¼Œæ¯ä¸€å¤©å°±æ˜¯ä¸€ä¸ªkeyï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>histogram = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">monday&lt;/span>: 5,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">tuesday&lt;/span>: 7,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">wednesday&lt;/span>: 10,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">thursday&lt;/span>: 18,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">friday&lt;/span>: 7,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">saturday&lt;/span>: 2,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">sunday&lt;/span>: 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ æƒ³ä»ä¸­è¿‡æ»¤æ‰Saturdayä»¥åŠSundayã€‚é€šè¿‡ActiveSupportï¼Œä½ å¯ä»¥åƒä¸‹é¢è¿™æ ·åšï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>require &lt;span style="font-style:italic">&amp;#39;active_support/core_ext/hash&amp;#39;&lt;/span> &lt;span style="font-style:italic"># not necessary if Rails&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>histogram.except(&lt;span style="font-style:italic">:saturday&lt;/span>, &lt;span style="font-style:italic">:sunday&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ–è€…åœ¨æ²¡æœ‰ActiveSupportçš„æƒ…å†µä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> filter(hsh, *keys)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â hsh.dup.tap &lt;span style="font-weight:bold">do&lt;/span> |h|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â Â Â keys.each { |k| h.delete(k) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>filter(histogram, &lt;span style="font-style:italic">:saturday&lt;/span>, &lt;span style="font-style:italic">:sunday&lt;/span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦ä¸€ä¸ªç®€æ´ç‚¹å®ç°åˆ™æ˜¯åŸºäº&lt;code>reject&lt;/code>æ–¹æ³•çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> filter2(hsh, *keys)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â hsh.reject { |k, _| keys.include? k }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯·æ³¨æ„ï¼Œå¦‚æœä½ æ­£åœ¨å¤„ç†ä¸€ä¸ªæ¯”è¾ƒå¤§çš„é›†åˆï¼Œä½ æœ€å¥½æ˜¯å…ˆè¡¡é‡ä¸‹ä½ çš„å®ç°ï¼Œä¸€æ¬¡é€‰æ‹©æœ€å¥½çš„å…¶ä¸­ä¸€ä¸ªå®ç°ã€‚
** IRBè¾“å‡ºï¼š**&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>=&amp;gt; {&lt;span style="font-style:italic">:monday&lt;/span>=&amp;gt;5, &lt;span style="font-style:italic">:tuesday&lt;/span>=&amp;gt;7, &lt;span style="font-style:italic">:wednesday&lt;/span>=&amp;gt;10, &lt;span style="font-style:italic">:thursday&lt;/span>=&amp;gt;18, &lt;span style="font-style:italic">:friday&lt;/span>=&amp;gt;7}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ–‡æ¡£ï¼š&lt;a href="http://api.rubyonrails.org/classes/Hash.html#method-i-except">Hash#except&lt;/a>, &lt;a href="http://www.ruby-doc.org/core-2.1.0/Hash.html#method-i-delete">Hash#delete&lt;/a>, &lt;a href="http://www.ruby-doc.org/core-2.1.0/Hash.html#method-i-reject">Hash#reject&lt;/a>, &lt;a href="http://www.ruby-doc.org/core-2.1.0/Object.html#method-i-dup">Object#dup&lt;/a>, &lt;a href="http://www.ruby-doc.org/core-2.1.0/Object.html#method-i-tap">Object#tap&lt;/a>&lt;/p>
&lt;h2 id="6-å¦‚ä½•é€šè¿‡valueå¯¹ä¸€ä¸ªhashè¿›è¡Œæ’åº">6. å¦‚ä½•é€šè¿‡valueå¯¹ä¸€ä¸ªHashè¿›è¡Œâ€œæ’åºâ€ï¼Ÿ&lt;/h2>
&lt;p>åœ¨ä¸€ä¸ªéª°å­ç±»æ¸¸æˆä¸­ï¼Œä½ åœ¨Hashä¸­å‚¨å­˜äº†æ¯ä¸€ä¸ªé€‰æ‰‹çš„å¾—åˆ†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>scores = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">&amp;#39;The Lady&amp;#39;&lt;/span> =&amp;gt; 3,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">&amp;#39;Fate&amp;#39;&lt;/span> =&amp;gt; 2,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â &lt;span style="font-style:italic">&amp;#39;Death&amp;#39;&lt;/span> =&amp;gt; 10
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ æƒ³è¦é€šè¿‡ä»–ä»¬çš„å¾—åˆ†å¯¹ä»–ä»¬è¿›è¡Œæ’åºã€‚ä½ å¯ä»¥è¿™æ ·åšï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>leaderboard = scores.sort_by { |_, score| -score }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>** IRBè¾“å‡ºï¼š**&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>=&amp;gt; [[&lt;span style="font-style:italic">&amp;#34;Death&amp;#34;&lt;/span>, 10], [&lt;span style="font-style:italic">&amp;#34;The Lady&amp;#34;&lt;/span>, 3], [&lt;span style="font-style:italic">&amp;#34;Fate&amp;#34;&lt;/span>, 2]]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ–‡æ¡£ï¼š&lt;a href="http://ruby-doc.org/core-2.1.0/Enumerable.html#method-i-sort_by">Enumerable#sort_by&lt;/a>
è¾¹æ³¨ï¼šHashé€šè¿‡å…ƒç´ æ’å…¥æ—¶çš„é¡ºåºå»æšä¸¾å®ƒä»¬çš„å€¼ã€‚&lt;/p>
&lt;h2 id="7-å¦‚ä½•æ‰¾å‡ºä¸¤ä¸ªhashä¸­çš„ä¸åŒ">7. å¦‚ä½•æ‰¾å‡ºä¸¤ä¸ªHashä¸­çš„ä¸åŒï¼Ÿ&lt;/h2>
&lt;p>å‡è®¾ä½ å®šæœŸåœ°ä»RSSè®¢é˜…æºä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¸”å°†ä»–ä»¬æ”¾åœ¨äº†ä¸€ä¸ªHashé‡Œè¾¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>entries = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 1372284000 =&amp;gt; &lt;span style="font-style:italic">&amp;#34;CVE-2013-4073&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 1368482400 =&amp;gt; &lt;span style="font-style:italic">&amp;#34;CVE-2013-2065&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ä½ æ›´æ–°äº†ä¹‹åï¼Œä½ å¯èƒ½å¾—åˆ°å¦ä¸€ä¸ªHashï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>updated_entries = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â 1385074800 =&amp;gt; &lt;span style="font-style:italic">&amp;#34;CVE-2013-4164&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â 1372284000 =&amp;gt; &lt;span style="font-style:italic">&amp;#34;CVE-2013-4073&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â Â 1368482400 =&amp;gt; &lt;span style="font-style:italic">&amp;#34;CVE-2013-2065&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ æƒ³è¦æŸ¥æ‰¾å‡ºå“ªä¸€æ¡è®°å½•æ‰æ˜¯æ–°åŠ çš„ï¼Œè¿™æ ·ä½ å°±å¯ä»¥é€šè¿‡emailçš„æ–¹å¼å°†å®ƒä»¬å‘é€å‡ºå»ã€‚æœ€å¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>new_entries = updated_entries.reject { |k, _| entries.include? k }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>** IRBè¾“å‡ºï¼š**&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>=&amp;gt; {1385074800=&amp;gt;&lt;span style="font-style:italic">&amp;#34;CVE-2013-4164&amp;#34;&lt;/span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æŸ¥çœ‹æ–‡æ¡£ï¼š&lt;a href="http://www.ruby-doc.org/core-2.1.0/Hash.html#method-i-include-3F">Hash#include?&lt;/a>&lt;/p></description></item><item><title>æ³¨æ„Rake Taskä¸­invokeæ–¹æ³•è·Ÿexecuteæ–¹æ³•çš„ä¸åŒ</title><link>https://blog.hackerpie.com/posts/archive/zhu-yi-rake-taskzhong-invokegen-executefang-fa-de-bu-tong/</link><pubDate>Fri, 21 Mar 2014 01:18:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/zhu-yi-rake-taskzhong-invokegen-executefang-fa-de-bu-tong/</guid><description>&lt;p>å¹³æ—¶å¦‚æœè·ŸRake Taskæœ‰è¿‡æ¥è§¦çš„åŒå­¦éƒ½ä¼šçŸ¥é“ï¼Œå½“æˆ‘ä»¬éœ€è¦åœ¨ä¸€ä¸ªTaské‡Œè¾¹è°ƒç”¨å¦ä¸€ä¸ªTaskçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨&lt;code>Rake::Task['task_name'].invoke&lt;/code>çš„æ–¹å¼ã€‚ä½†æ˜¯åœ¨ä»Šå¤©çš„å®è·µä¸­ï¼Œæ‰çŸ¥é“&lt;code>Rake::Task#invoke&lt;/code>åœ¨é»˜è®¤æƒ…å†µä¸‹åœ¨æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­å°†åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡è€Œå·²ã€‚è¯ä¸å¤šè¯´ï¼ŒåŠ¨æ‰‹æ¼”ç¤ºï¼š&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>å‡†å¤‡ä¸€ä¸ª&lt;strong>say hello&lt;/strong>çš„taskï¼Œä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># lib/tasks/demo.rake&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>namespace &lt;span style="font-style:italic">:demo&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> desc &lt;span style="font-style:italic">&amp;#34;Print &amp;#39;Hello&amp;#39; string&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> task &lt;span style="font-style:italic">:say_hello&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> puts &lt;span style="font-style:italic">&amp;#34;Hello, World!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œrake task:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ rake demo:say_hello
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; Hello, World!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å‡è®¾æˆ‘ä»¬ä¸€ä¸ªå¾ªç¯ï¼Œéœ€è¦è°ƒç”¨ä¸Šè¾¹çš„taskå…±5æ¬¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯èƒ½ä¼šè¿™ä¹ˆå†™ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>namespace &lt;span style="font-style:italic">:demo&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ....&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> desc &lt;span style="font-style:italic">&amp;#34;Print &amp;#39;Hello, World!&amp;#39; five times&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> task &lt;span style="font-style:italic">:say_five_hello&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 5.times &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rake::Task[&lt;span style="font-style:italic">&amp;#39;demo:say_hello&amp;#39;&lt;/span>].invoke
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ok, è®©æˆ‘ä»¬å°è¯•ç€è¿è¡Œè¿™ä¸ª&lt;code>say_five_hello&lt;/code>çš„taskï¼Œæ˜¯ä¸æ˜¯çœŸçš„ä¼šæ‰“å°5æ¬¡&amp;rsquo;Hello, World!&amp;lsquo;å‘¢?&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ rake demo:say_five_hello
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; Hello, World!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç»“æœå°±æ˜¯ï¼Œ&amp;lsquo;Hello, World!&amp;lsquo;åªæ‰“å°äº†ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„&lt;code>Rake::Task['demo:say_hello']&lt;/code>åªè¢«è¿è¡Œäº†ä¸€æ¬¡ã€‚&lt;/p>
&lt;p>ç»è¿‡æœç´¢ï¼Œä»StackOverflowæ‰¾åˆ°äº†è¿™ä¸ªé—®é¢˜çš„ç›¸å…³æè¿°ï¼Œè¯¦è§ï¼š&lt;a href="http://stackoverflow.com/a/12948485">How do I execute Rake tasks with arguments multiple times?&lt;/a>&lt;/p>
&lt;p>æŒ‰ç…§ç­”æ¡ˆä¸­çš„æè¿°ï¼Œæˆ‘ä»¬æœ‰ä¸¤ç§ä¿®æ”¹æ–¹æ¡ˆã€‚ç¬¬ä¸€ç§å°±æ˜¯å°†ä¸Šè¿°ä»£ç è¿›è¡Œä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>namespace &lt;span style="font-style:italic">:demo&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> desc &lt;span style="font-style:italic">&amp;#34;Print &amp;#39;Hello, World!&amp;#39; five times&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> task &lt;span style="font-style:italic">:say_five_hello&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 5.times &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rake::Task[&lt;span style="font-style:italic">&amp;#39;demo:say_hello&amp;#39;&lt;/span>].execute
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†æ¬¡è¿è¡Œï¼Œè¿™æ¬¡æ€»ç®—å¾—åˆ°æœŸå¾…ç»“æœäº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ rake demo:say_five_hello
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; Hello, World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Hello, World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Hello, World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Hello, World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Hello, World!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è€Œç¬¬äºŒç§æ–¹æ³•åˆ™ä¼šç¨å¾®éº»çƒ¦ä¸€ç‚¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>namespace &lt;span style="font-style:italic">:demo&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> desc &lt;span style="font-style:italic">&amp;#34;Print &amp;#39;Hello, World!&amp;#39; five times&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> task &lt;span style="font-style:italic">:say_five_hello&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> 5.times &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rake::Task[&lt;span style="font-style:italic">&amp;#39;demo:say_hello&amp;#39;&lt;/span>].reenable
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Rake::Task[&lt;span style="font-style:italic">&amp;#39;demo:say_hello&amp;#39;&lt;/span>].invoke
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†æ¬¡æ‰§è¡Œrake task, åŒæ ·èƒ½å¤Ÿå¾—åˆ°é¢„æœŸç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ rake demo:say_five_hello
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>=&amp;gt; Hello, World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Hello, World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Hello, World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Hello, World!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Hello, World!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æœªå®Œå¾…ç»­">æœªå®Œå¾…ç»­&lt;/h3>
&lt;p>é’ˆå¯¹é‡å¤è°ƒç”¨çš„è¡Œä¸ºä¸Šçš„ä¸åŒåªæ˜¯&lt;code>invoke&lt;/code>ä»¥åŠ&lt;code>execute&lt;/code>æ–¹æ³•ä¹‹é—´çš„ä¸€ä¸ªåŸºæœ¬å·®å¼‚è€Œå·²ï¼Œé‚£ç¬¬ä¸€ç§æ–¹æ¡ˆè·Ÿç¬¬äºŒç§æ–¹æ¡ˆçš„å·®å¼‚åˆæœ‰ä»€ä¹ˆä¸åŒï¼Ÿåœ¨å¸¦å‚æ•°çš„æƒ…å†µä¸‹ï¼Œåˆè¯¥å¦‚ä½•è€ƒè™‘ä¸¤ä¸ªæ–¹æ³•ä¹‹é—´çš„å·®å¼‚ï¼Ÿ&lt;/p>
&lt;p>&lt;a href="http://rake.rubyforge.org/classes/Rake/Task.html">Rake::Task source code&lt;/a>&lt;/p></description></item><item><title>å±æ€§æ–¹æ³•</title><link>https://blog.hackerpie.com/posts/archive/shu-xing-fang-fa/</link><pubDate>Wed, 12 Mar 2014 20:58:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/shu-xing-fang-fa/</guid><description>&lt;p>æ­¤æ–‡ç¿»è¯‘è‡ª&lt;a href="http://monkeyandcrow.com/blog/reading_rails_attribute_methods/">Reading Rails - Attribute Methods&lt;/a>ï¼Œé™äºæœ¬äººæ°´å¹³ï¼Œç¿»è¯‘ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡æ•™ï¼&lt;/p>
&lt;p>åœ¨æˆ‘ä»¬&lt;a href="https://blog.hackerpie.com/blog/2014/03/07/zhui-zong-bian-geng/">ä¸Šä¸€ç¯‡çš„æ¢è®¨&lt;/a>ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°äº†Railsåœ¨è·Ÿè¸ªå±æ€§å˜æ›´ä¸­ä½¿ç”¨åˆ°çš„å±æ€§æ–¹æ³•ï¼ˆattribute methodsï¼‰ã€‚æœ‰ä¸‰ç§ç±»å‹çš„å±æ€§æ–¹æ³•ï¼šå‰ç¼€å¼ï¼ˆprefixï¼‰ã€åç¼€å¼ï¼ˆsuffixï¼‰ä»¥åŠå›ºå®šè¯ç¼€å¼ï¼ˆ affixï¼‰ã€‚ä¸ºäº†è¡¨è¿°ç®€æ´ï¼Œæˆ‘ä»¬å°†åªå…³æ³¨ç±»ä¼¼&lt;code>attribute_method_suffix&lt;/code>è¿™æ ·çš„åç¼€å¼å±æ€§æ–¹æ³•ï¼Œå¹¶ä¸”ç‰¹åˆ«å…³æ³¨å®ƒæ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬å®ç°ç±»ä¼¼&lt;code>name&lt;/code>è¿™æ ·çš„æ¨¡å‹å±æ€§ä»¥åŠå¯¹åº”ç”Ÿæˆçš„ç±»ä¼¼&lt;code>name_changed?&lt;/code>è¿™æ ·çš„æ–¹æ³•çš„ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>å¦‚æœéœ€è¦è·Ÿç€æˆ‘çš„æ­¥éª¤èµ°ï¼Œè¯·ä½¿ç”¨&lt;a href="https://github.com/adamsanderson/qwandry">qwandry&lt;/a>æ‰“å¼€æ¯ä¸€ä¸ªç›¸å…³çš„ä»£ç åº“ï¼Œæˆ–è€…ç›´æ¥ä»&lt;a href="https://github.com/rails/rails/tree/5505c1d700f17e2009e1189a7aa6dafafe7062a4">github&lt;/a>æŸ¥çœ‹æºç å³å¯ã€‚&lt;/p>
&lt;h3 id="å£°æ˜declarations">å£°æ˜ï¼ˆDeclarationsï¼‰&lt;/h3>
&lt;p>å±æ€§æ–¹æ³•æ˜¯Railsä¸­ä¼—å¤šä½¿ç”¨äº†å…ƒç¼–ç¨‹æŠ€æœ¯çš„æ¡ˆä¾‹ä¹‹ä¸€ã€‚åœ¨å…ƒç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™å¯ä»¥ç¼–å†™ä»£ç çš„ä»£ç ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ&lt;code>attribute_method_suffix&lt;/code>åç¼€å¼æ–¹æ³•æ˜¯ä¸€ä¸ªä¸ºæ¯ä¸ªå±æ€§éƒ½å®šä¹‰äº†ä¸€ä¸ªhelperæ–¹æ³•çš„æ–¹æ³•ã€‚åœ¨&lt;a href="https://blog.hackerpie.com/blog/2014/03/07/zhui-zong-bian-geng/">ä¹‹å‰çš„è®¨è®º&lt;/a>ä¸­ï¼ŒActiveModelä½¿ç”¨è¿™ç§æ–¹å¼ä¸ºæ‚¨çš„æ¯ä¸€ä¸ªå±æ€§éƒ½å®šä¹‰äº†ä¸€ä¸ª&lt;code>_changed?&lt;/code>æ–¹æ³•(&lt;strong>æç¤º&lt;/strong>ï¼š å‘½ä»¤è¡Œä¸­é”®å…¥&lt;code>qw activemodel&lt;/code>æŸ¥çœ‹ä»£ç )ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">Dirty&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">extend&lt;/span> ActiveSupport::Concern
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">include&lt;/span> ActiveModel::AttributeMethods
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> included &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attribute_method_suffix &lt;span style="font-style:italic">&amp;#39;_changed?&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_change&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_will_change!&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_was&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®©æˆ‘ä»¬æ‰“å¼€ActiveModelåº“ä¸­çš„&lt;code>attribute_methods.rb&lt;/code>æ–‡ä»¶ï¼Œå¹¶ä¸”çœ‹ä¸€ä¸‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> attribute_method_suffix(*suffixes)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self.attribute_method_matchers += suffixes.map! &lt;span style="font-weight:bold">do&lt;/span> |suffix|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> AttributeMethodMatcher.new &lt;span style="font-style:italic">suffix&lt;/span>: suffix
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“ä½ è°ƒç”¨&lt;code>attribute_method_suffix&lt;/code>æ–¹æ³•çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªåç¼€éƒ½é€šè¿‡&lt;code>map!&lt;/code>æ–¹æ³•è½¬æ¢ä¸ºä¸€ä¸ª&lt;code>AttributeMethodMatcher&lt;/code>å¯¹è±¡ã€‚è¿™äº›å¯¹è±¡ä¼šè¢«å­˜å‚¨åœ¨&lt;code>attribute_method_matchers&lt;/code>ä¸­ã€‚å¦‚æœä½ é‡æ–°çœ‹ä¸€ä¸‹è¿™ä¸ªmoduleçš„é¡¶éƒ¨ï¼Œä½ ä¼šå‘ç°&lt;code>attribute_method_matchers&lt;/code>æ˜¯åœ¨æ¯ä¸€ä¸ªåŒ…å«æ­¤moduleçš„ç±»ä¸­ä½¿ç”¨&lt;code>class_attribute&lt;/code>å®šä¹‰çš„æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">AttributeMethods&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">extend&lt;/span> ActiveSupport::Concern
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> included &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> class_attribute &lt;span style="font-style:italic">:attribute_aliases&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">:attribute_method_matchers&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">instance_writer&lt;/span>: &lt;span style="">false&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>class_attribute&lt;/code>æ–¹æ³•å¸®åŠ©ä½ åœ¨ç±»ä¸Šå®šä¹‰å±æ€§ã€‚ä½ å¯ä»¥è¿™æ ·åœ¨ä½ è‡ªå·±çš„ä»£ç ä¸­è¿™æ ·ä½¿ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Person&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> class_attribute &lt;span style="font-style:italic">:database&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Employee&lt;/span> &amp;lt; Person
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Person.database = Sql.new(&lt;span style="font-style:italic">:host&lt;/span>=&amp;gt;&lt;span style="font-style:italic">&amp;#39;localhost&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Employee.database &lt;span style="font-style:italic">#=&amp;gt; &amp;lt;Sql:host=&amp;#39;localhost&amp;#39;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Rubyä¸­å¹¶æ²¡æœ‰&lt;code>class_attribute&lt;/code>çš„å†…ç½®å®ç°ï¼Œå®ƒæ˜¯åœ¨ActiveSupport(&lt;strong>æç¤º&lt;/strong>:å‘½ä»¤è¡Œä¸­é”®å…¥&lt;code>qw activesupport&lt;/code>æŸ¥çœ‹ä»£ç )ä¸­å®šä¹‰çš„æ–¹æ³•ã€‚å¦‚æœä½ å¯¹æ­¤æ¯”è¾ƒå¥½å¥‡ï¼Œå¯ä»¥ç®€å•çœ‹ä¸‹&lt;code>attribute.rb&lt;/code>&lt;/p>
&lt;p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹&lt;code>AttributeMethodMatcher&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">AttributeMethodMatcher&lt;/span> &lt;span style="font-style:italic">#:nodoc:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">attr_reader&lt;/span> &lt;span style="font-style:italic">:prefix&lt;/span>, &lt;span style="font-style:italic">:suffix&lt;/span>, &lt;span style="font-style:italic">:method_missing_target&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> initialize(options = {})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @prefix, @suffix = options.fetch(&lt;span style="font-style:italic">:prefix&lt;/span>, &lt;span style="font-style:italic">&amp;#39;&amp;#39;&lt;/span>), options.fetch(&lt;span style="font-style:italic">:suffix&lt;/span>, &lt;span style="font-style:italic">&amp;#39;&amp;#39;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @regex = &lt;span style="font-style:italic">/^(?:&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>Regexp.escape(@prefix)&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">)(.*)(?:&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>Regexp.escape(@suffix)&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">)$/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @method_missing_target = &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>@prefix&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">attribute&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>@suffix&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @method_name = &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>prefix&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">%s&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>suffix&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç ä¸­çš„&lt;code>prefix&lt;/code>ä»¥åŠ&lt;code>suffix&lt;/code>æ˜¯é€šè¿‡&lt;code>Hash#fetch&lt;/code>æ–¹æ³•æå–å‡ºæ¥çš„ã€‚è¿™ä¼šè¿”å›ä¸€ä¸ªå¯¹åº”é”®çš„å€¼ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªé»˜è®¤å€¼ã€‚å¦‚æœè°ƒç”¨æ–¹æ³•çš„æ—¶å€™æ²¡æœ‰æä¾›é»˜è®¤å€¼ï¼Œ&lt;code>Hash#fetch&lt;/code>æ–¹æ³•å°†ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œæç¤ºæŒ‡å®šçš„é”®ä¸å­˜åœ¨ã€‚å¯¹äºoptionsçš„å¤„ç†æ¥è¯´æ˜¯ä¸€ç§ä¸é”™çš„æ¨¡å¼ï¼Œç‰¹åˆ«æ˜¯å¯¹äºbooleanå‹æ•°æ®æ¥è¯´ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>options = {&lt;span style="font-style:italic">:name&lt;/span> =&amp;gt; &lt;span style="font-style:italic">&amp;#34;Mortimer&amp;#34;&lt;/span>, &lt;span style="font-style:italic">:imaginary&lt;/span> =&amp;gt; &lt;span style="">false&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Don&amp;#39;t do this:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>options[&lt;span style="font-style:italic">:imaginary&lt;/span>] || &lt;span style="">true&lt;/span> &lt;span style="font-style:italic">#=&amp;gt; true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Do this:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>options.fetch(&lt;span style="font-style:italic">:imaginary&lt;/span>, &lt;span style="">true&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; false&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºæˆ‘ä»¬çš„&lt;code>attribute_method_suffix&lt;/code>å…¶ä¸­çš„&lt;code>'_changed'&lt;/code>ç¤ºä¾‹æ¥è¯´ï¼Œ&lt;code>AttributeMethodMatcher&lt;/code>å°†ä¼šæœ‰å¦‚ä¸‹çš„å®ä¾‹å˜é‡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>@prefix &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@suffix &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;_changed?&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@regex &lt;span style="font-style:italic">#=&amp;gt; /^(?:)(.*)(?:_changed\?)$/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@method_missing_target &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;attribute_changed?&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@method_name &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;%s_changed?&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½ ä¸€å®šæƒ³çŸ¥é“&lt;code>%s_changed&lt;/code>ä¸­çš„&lt;code>%s&lt;/code>æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å§ï¼Ÿè¿™æ˜¯ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼ˆformat stringï¼‰ã€‚ä½ å¯ä»¥ä½¿ç”¨&lt;code>sprintf&lt;/code>æ–¹æ³•å¯¹å®ƒæ’å…¥å€¼ï¼Œæˆ–è€…ä½¿ç”¨ç¼©å†™ï¼ˆshortcutï¼‰&lt;code>%&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>sprintf(&lt;span style="font-style:italic">&amp;#34;%s_changed?&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;named_changed?&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&amp;#34;%s_changed?&amp;#34;&lt;/span> % &lt;span style="font-style:italic">&amp;#34;age&amp;#34;&lt;/span> &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;age_changed?&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç¬¬äºŒä¸ªæ¯”è¾ƒæœ‰è¶£çš„åœ°æ–¹å°±æ˜¯æ­£åˆ™è¡¨è¾¾å¼åˆ›å»ºçš„æ–¹å¼ã€‚è¯·ç•™æ„åˆ›å»º&lt;code>@regex&lt;/code>å˜é‡æ—¶&lt;code>Regexp.escape&lt;/code>çš„ç”¨æ³•ã€‚å¦‚æœåç¼€æ²¡æœ‰è¢«escapeï¼Œåˆ™æ­£åˆ™è¡¨è¾¾å¼ä¸­å¸¦æœ‰ç‰¹æ®Šå«ä¹‰çš„ç¬¦å·å°†ä¼šè¢«é”™è¯¯è§£é‡Š(misinterpreted)ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Don&amp;#39;t do this!&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>regex = &lt;span style="font-style:italic">/^(?:&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>@prefix&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">)(.*)(?:&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>@suffix&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">)$/&lt;/span> &lt;span style="font-style:italic">#=&amp;gt; /^(?:)(.*)(?:_changed?)$/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>regex.match(&lt;span style="font-style:italic">&amp;#34;name_changed?&amp;#34;&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>regex.match(&lt;span style="font-style:italic">&amp;#34;name_change&amp;#34;&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; #&amp;lt;MatchData &amp;#34;name_change&amp;#34; 1:&amp;#34;name&amp;#34;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Do this:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>@regex = &lt;span style="font-style:italic">/^(?:&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>Regexp.escape(@prefix)&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">)(.*)(?:&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>Regexp.escape(@suffix)&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">)$/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>regex.match(&lt;span style="font-style:italic">&amp;#34;name_changed?&amp;#34;&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; #&amp;lt;MatchData &amp;#34;name_changed?&amp;#34; 1:&amp;#34;name&amp;#34;&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>regex.match(&lt;span style="font-style:italic">&amp;#34;name_change&amp;#34;&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; nil&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯·ä»”ç»†è®°ä½&lt;code>regex&lt;/code>ä»¥åŠ&lt;code>method_name&lt;/code>ï¼Œå®ƒä»¬å¯ä»¥ç”¨æ¥åŒ¹é…å’Œç”Ÿæˆå±æ€§æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨åé¢è¿˜ä¼šç»§ç»­ç”¨åˆ°å®ƒä»¬ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬ç°åœ¨å·²ç»ææ˜ç™½äº†å±æ€§æ–¹æ³•æ˜¯å¦‚ä½•å£°æ˜çš„ï¼Œä½†æ˜¯å®é™…ä¸­ï¼ŒRailsåˆæ˜¯å¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„å‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="é€šè¿‡method-missingè°ƒç”¨invocation-with-method-missing">é€šè¿‡Method Missingè°ƒç”¨ï¼ˆInvocation With Method Missingï¼‰&lt;/h3>
&lt;p>å½“æˆ‘ä»¬è°ƒç”¨äº†ä¸€ä¸ªæœªå®šä¹‰çš„æ–¹æ³•æ—¶ï¼ŒRailså°†ä¼šåœ¨æŠ›å‡ºå¼‚å¸¸ä¹‹å‰è°ƒç”¨å¯¹è±¡çš„&lt;code>method_missing&lt;/code>æ–¹æ³•ã€‚è®©æˆ‘ä»¬çœ‹çœ‹Railsæ˜¯å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæŠ€å·§è°ƒç”¨å±æ€§æ–¹æ³•çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> method_missing(method, *args, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> respond_to_without_attributes?(method, &lt;span style="">true&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">super&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> match = match_attribute_method?(method.to_s)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> match ? attribute_missing(match, *args, &amp;amp;block) : &lt;span style="font-weight:bold">super&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¼ ç»™&lt;code>method_missing&lt;/code>æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç”¨symbolç±»å‹è¡¨ç¤ºçš„æ–¹æ³•åï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬çš„&lt;code>:name_changed?&lt;/code>ã€‚&lt;code>*args&lt;/code>æ˜¯ï¼ˆæœªå®šä¹‰çš„ï¼‰æ–¹æ³•è¢«è°ƒç”¨æ—¶ä¼ å…¥çš„æ‰€æœ‰å‚æ•°ï¼Œ&lt;code>&amp;amp;block&lt;/code>æ˜¯ä¸€ä¸ªå¯é€‰çš„ä»£ç å—ã€‚Railsé¦–å…ˆé€šè¿‡è°ƒç”¨&lt;code>respond_to_without_attributes&lt;/code>æ–¹æ³•æ£€æŸ¥æ˜¯å¦æœ‰åˆ«çš„æ–¹æ³•å¯ä»¥å¯¹åº”è¿™æ¬¡è°ƒç”¨ã€‚å¦‚æœåˆ«çš„æ–¹æ³•å¯ä»¥å¤„ç†è¿™æ¬¡è°ƒç”¨ï¼Œåˆ™é€šè¿‡&lt;code>super&lt;/code>æ–¹æ³•è½¬ç§»æ§åˆ¶æƒã€‚å¦‚æœæ‰¾ä¸åˆ°åˆ«çš„æ–¹æ³•å¯ä»¥å¤„ç†å½“å‰çš„è°ƒç”¨ï¼ŒActiveModelåˆ™ä¼šé€šè¿‡&lt;code>match_attribute_method?&lt;/code>æ–¹æ³•æ£€æŸ¥å½“å‰è°ƒç”¨çš„æ–¹æ³•æ˜¯å¦æ˜¯ä¸€ä¸ªå±æ€§æ–¹æ³•ã€‚å¦‚æœæ˜¯ï¼Œå®ƒåˆ™ä¼šæ¥ç€è°ƒç”¨&lt;code>attribute_missing&lt;/code>æ–¹æ³•ã€‚&lt;/p>
&lt;p>&lt;code>match_attribute_method&lt;/code>æ–¹æ³•åˆ©ç”¨äº†ä¹‹å‰å£°æ˜è¿‡çš„&lt;code>AttributeMethodMatcher&lt;/code>å¯¹è±¡ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> match_attribute_method?(method_name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> match = self.class.send(&lt;span style="font-style:italic">:attribute_method_matcher&lt;/span>, method_name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> match &lt;span style="font-weight:bold">if&lt;/span> match &amp;amp;&amp;amp; attribute_method?(match.attr_name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œè¾¹å‘ç”Ÿäº†ä¸¤ä»¶äº‹ã€‚ç¬¬ä¸€ï¼ŒRailsæŸ¥æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…å™¨(matcher)ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™æ˜¯å¦çœŸçš„æ˜¯ä¸€ä¸ªå±æ€§ã€‚è¯´å®è¯ï¼Œæˆ‘è‡ªå·±ä¹Ÿæ˜¯æ¯”è¾ƒè¿·æƒ‘ï¼Œä¸ºä»€ä¹ˆ&lt;code>match_attribute_method?&lt;/code>æ–¹æ³•è°ƒç”¨çš„æ˜¯&lt;code>self.class.send(:attribute_method_matcher, method_name)&lt;/code>ï¼Œè€Œä¸æ˜¯&lt;code>self.attribute_method_matcher(method_name)&lt;/code>ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥å‡è®¾å®ƒä»¬çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚&lt;/p>
&lt;p>å¦‚æœæˆ‘ä»¬å†æ¥ç€çœ‹&lt;code>attribute_method_matcher&lt;/code>ï¼Œå°±ä¼šå‘ç°å®ƒçš„æœ€æ ¸å¿ƒçš„ä»£ç ä»…ä»…åªæ˜¯æ‰«æåŒ¹é…äº†&lt;code>AttributeMethodMatcher&lt;/code>å®ä¾‹ï¼Œå®ƒæ‰€åšçš„äº‹å°±æ˜¯å¯¹æ¯”å¯¹è±¡æœ¬èº«çš„æ­£åˆ™è¡¨è¾¾å¼ä¸å½“å‰çš„æ–¹æ³•åï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> attribute_method_matcher(method_name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attribute_method_matchers.detect { |method| method.match(method_name) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æœRailsæ‰¾åˆ°äº†åŒ¹é…å½“å‰è°ƒç”¨çš„æ–¹æ³•çš„å±æ€§ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æ‰€æœ‰å‚æ•°éƒ½ä¼šè¢«ä¼ é€’ç»™&lt;code>attribute_missing&lt;/code>æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> attribute_missing(match, *args, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> __send__(match.target, match.attr_name, *args, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªæ–¹æ³•å°†åŒ¹é…åˆ°çš„å±æ€§åä»¥åŠä¼ å…¥çš„ä»»æ„å‚æ•°æˆ–è€…ä»£ç å—ä»£ç†ç»™äº†&lt;code>match.target&lt;/code>ã€‚å›å¤´çœ‹ä¸‹æˆ‘ä»¬çš„å®ä¾‹å˜é‡ï¼Œ&lt;code>match.target&lt;/code>å°†ä¼šæ˜¯&lt;code>attribute_changed?&lt;/code>ï¼Œè€Œä¸”&lt;code>match.attr_name&lt;/code>åˆ™æ˜¯&amp;quot;name&amp;quot;ã€‚&lt;code>__send__&lt;/code>æ–¹æ³•å°†ä¼šè°ƒç”¨&lt;code>attribute_changed?&lt;/code>æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä½ å®šä¹‰çš„ä»»æ„ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§æ–¹æ³•ã€‚&lt;/p>
&lt;h3 id="å…ƒç¼–ç¨‹metaprogramming">å…ƒç¼–ç¨‹ï¼ˆMetaprogrammingï¼‰&lt;/h3>
&lt;p>æœ‰å¾ˆå¤šçš„æ–¹å¼å¯ä»¥å¯¹ä¸€ä¸ªæ–¹æ³•çš„è°ƒç”¨è¿›è¡Œåˆ†å‘ï¼ˆdispatchï¼‰ï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•ç»å¸¸è¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå®ç°ä¸€ä¸ª&lt;code>name_changed?&lt;/code>æ–¹æ³•å°†ä¼šæ›´ä¸ºæœ‰æ•ˆã€‚Railsé€šè¿‡&lt;code>define_attribute_methods&lt;/code>æ–¹æ³•åšåˆ°äº†å¯¹è¿™ç±»å±æ€§æ–¹æ³•çš„è‡ªåŠ¨å®šä¹‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> define_attribute_methods(*attr_names)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attr_names.flatten.each { |attr_name| define_attribute_method(attr_name) }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> define_attribute_method(attr_name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attribute_method_matchers.each &lt;span style="font-weight:bold">do&lt;/span> |matcher|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> method_name = matcher.method_name(attr_name)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> define_proxy_call &lt;span style="">true&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> generated_attribute_methods,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> method_name,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> matcher.method_missing_target,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attr_name.to_s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>matcher.method_name&lt;/code>ä½¿ç”¨äº†æˆ‘ä»¬å‰é¢è§åˆ°è¿‡çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”æ’å…¥äº†&lt;code>attr_name&lt;/code>ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œ&lt;code>&amp;quot;%s_changed?&amp;quot;&lt;/code>å˜æˆäº†&lt;code>&amp;quot;name_changed?&amp;quot;&lt;/code>ã€‚ç°åœ¨æˆ‘ä»¬æˆ‘ä»¬å‡†å¤‡å¥½äº†äº†è§£åœ¨&lt;code>define_proxy_call&lt;/code>ä¸­çš„å…ƒç¼–ç¨‹ã€‚ä¸‹é¢æ˜¯è¿™ä¸ªæ–¹æ³•è¢«åˆ æ‰äº†ä¸€äº›ç‰¹æ®Šåœºæ™¯ä¸‹çš„ä»£ç çš„ç‰ˆæœ¬ï¼Œä½ å¯ä»¥åœ¨é˜…è¯»å®Œè¿™ç¯‡æ–‡ç« åè‡ªå·±å»äº†è§£æ›´å¤šçš„ä»£ç ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> define_proxy_call(include_private, mod, name, send, *extra)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> defn = &lt;span style="font-style:italic">&amp;#34;def &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>name&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">(*args)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> extra = (extra.map!(&amp;amp;&lt;span style="font-style:italic">:inspect&lt;/span>) &amp;lt;&amp;lt; &lt;span style="font-style:italic">&amp;#34;*args&amp;#34;&lt;/span>).join(&lt;span style="font-style:italic">&amp;#34;, &amp;#34;&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> target = &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>send&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">(&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>extra&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">)&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mod.module_eval &lt;span style="font-style:italic">&amp;lt;&amp;lt;-RUBY, __FILE__, __LINE__ + 1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-style:italic">#{defn}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#{target}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> RUBY
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œä¸ºæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ–°çš„æ–¹æ³•ã€‚&lt;code>name&lt;/code>å°±æ˜¯æ­£è¦è¢«å®šä¹‰çš„æ–¹æ³•åï¼Œè€Œ&lt;code>send&lt;/code>åˆ™æ˜¯å¤„ç†å™¨(handler)ï¼Œå¦å¤–çš„&lt;code>extra&lt;/code>æ˜¯å±æ€§åã€‚&lt;code>mod&lt;/code>å‚æ•°æ˜¯ä¸€ä¸ªRailsç”¨&lt;code>generated_attribute_methods&lt;/code>æ–¹æ³•ç”Ÿæˆçš„ç‰¹æ®Šçš„æ¨¡å—ï¼ˆmoduleï¼‰ï¼Œå®ƒè¢«åµŒå…¥ï¼ˆmixinï¼‰åˆ°æˆ‘ä»¬çš„ç±»ä¸­ã€‚ç°åœ¨è®©æˆ‘ä»¬å¤šçœ‹ä¸€ä¸‹&lt;code>module_eval&lt;/code>æ–¹æ³•ã€‚è¿™é‡Œæœ‰ä¸‰ä»¶æœ‰è¶£çš„äº‹æƒ…å‘ç”Ÿäº†ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä»¶äº‹å°±æ˜¯&lt;a href="http://blog.jayfields.com/2006/12/ruby-multiline-strings-here-doc-or.html">HEREDOC&lt;/a>è¢«ç”¨ä½œä¸€ä¸ªå‚æ•°ä¼ ç»™äº†ä¸€ä¸ªæ–¹æ³•ã€‚è¿™æ˜¯æœ‰ç‚¹éš¾æ‡‚çš„ï¼Œä½†æ˜¯å¯¹æŸäº›åœºæ™¯å´æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæƒ³è±¡æˆ‘ä»¬åœ¨ä¸€ä¸ªæœåŠ¡å™¨å“åº”(response)ä¸­æœ‰ä¸€ä¸ªæ–¹æ³•è¦ç”¨æ¥åµŒå…¥Javascriptä»£ç ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>include_js(&lt;span style="font-style:italic">&amp;lt;&amp;lt;-JS, :minify =&amp;gt; true)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="">$&lt;/span>(&lt;span style="font-style:italic">&amp;#39;#logo&amp;#39;&lt;/span>).show();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> App.refresh();
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>JS
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™å°†ä¼šæŠŠå­—ç¬¦ä¸²&lt;code>&amp;quot;$('#logo').show(); App.refresh();&amp;quot;&lt;/code>ä½œä¸ºè°ƒç”¨&lt;code>include_js&lt;/code>æ—¶ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè€Œ&lt;code>:minify =&amp;gt; true&lt;/code>ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ã€‚åœ¨Rubyä¸­éœ€è¦ç”Ÿæˆä»£ç æ—¶ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æŠ€å·§ã€‚å€¼å¾—é«˜å…´çš„æ˜¯ï¼Œè¯¸å¦‚&lt;a href="https://github.com/textmate/textmate">TextMate&lt;/a>è¿™ç±»ç¼–è¾‘å™¨éƒ½èƒ½å¤Ÿè¯†åˆ«è¿™ä¸ªæ¨¡å¼ï¼Œå¹¶ä¸”æ­£ç¡®åœ°é«˜äº®æ˜¾ç¤ºå­—ç¬¦ä¸²ã€‚å³ä½¿ä½ å¹¶ä¸éœ€è¦ç”Ÿæˆä»£ç ï¼ŒHEREDOCå¯¹äºå¤šè¡Œçš„å­—ç¬¦ä¸²ä¹Ÿæ˜¯æ¯”è¾ƒæœ‰ç”¨çš„ã€‚&lt;/p>
&lt;p>ç°åœ¨æˆ‘ä»¬å°±çŸ¥é“äº†&lt;code>&amp;lt;&amp;lt;-RUBY&lt;/code>åšäº†äº›ä»€ä¹ˆäº‹ï¼Œä½†æ˜¯&lt;code>__FILE__&lt;/code>ä»¥åŠ&lt;code>__LINE__ + 1&lt;/code>å‘¢ï¼Ÿ&lt;code>__FILE__&lt;/code>è¿”å›äº†å½“å‰æ–‡ä»¶çš„ï¼ˆç›¸å¯¹ï¼‰è·¯å¾„ï¼Œè€Œ&lt;code>__LINE__&lt;/code>è¿”å›äº†å½“å‰ä»£ç çš„è¡Œå·ã€‚&lt;code>module_eval&lt;/code>æ¥æ”¶è¿™äº›å‚æ•°ï¼Œå¹¶é€šè¿‡è¿™äº›å‚æ•°å†³å®šæ–°çš„ä»£ç å®šä¹‰åœ¨æ–‡ä»¶ä¸­â€œçœ‹èµ·æ¥â€çš„ä½ç½®ã€‚åœ¨å¯¹äºæ ˆè·Ÿè¸ªï¼ˆstack tracesï¼‰æ¥è¯´æ˜¯ç‰¹åˆ«æœ‰ç”¨çš„ã€‚&lt;/p>
&lt;p>æœ€åï¼Œè®©æˆ‘ä»¬çœ‹ä¸€äº›&lt;code>module_eval&lt;/code>ä¸­å®é™…æ‰§è¡Œçš„ä»£ç ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå€¼æ›¿æ¢æˆæˆ‘ä»¬çš„&lt;code>name_changed?&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>mod.module_eval &lt;span style="font-style:italic">&amp;lt;&amp;lt;-RUBY, __FILE__, __LINE__ + 1
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">&lt;/span> &lt;span style="font-weight:bold">def&lt;/span> name_changed?(*args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attribute_changed?(&lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>, *args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>RUBY
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç°åœ¨&lt;code>name_changed?&lt;/code>å°±æ˜¯ä¸€ä¸ªçœŸå®çš„æ–¹æ³•äº†ï¼Œæ¯”èµ·ä¾èµ–äº&lt;code>method_missing&lt;/code>æ–¹æ³•çš„å®ç°ï¼Œè¿™ç§æ–¹æ³•çš„å¼€é”€è¦å°å¾—å¤šã€‚&lt;/p>
&lt;h3 id="æ€»ç»“recap">æ€»ç»“ï¼ˆRecapï¼‰&lt;/h3>
&lt;p>æˆ‘ä»¬å‘ç°äº†è°ƒç”¨&lt;code>attribute_method_suffix&lt;/code>æ–¹æ³•ä¼šä¿å­˜ä¸€ä¸ªé…ç½®å¥½çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ç”¨äºRailsä¸­ä¸¤ç§å…ƒç¼–ç¨‹æ–¹æ³•ä¸­çš„ä¸€ç§ã€‚ä¸è€ƒè™‘æ˜¯å¦ä½¿ç”¨äº†&lt;code>method_missing&lt;/code>ï¼Œæˆ–è€…é€šè¿‡&lt;code>module_eval&lt;/code>å®šä¹‰äº†æ–°çš„æ–¹æ³•ï¼Œæ–¹æ³•çš„è°ƒç”¨æœ€åæ€»ä¼šè¢«ä¼ é€’åˆ°è¯¸å¦‚&lt;code>attribute_changed?(attr)&lt;/code>è¿™æ ·çš„æ–¹æ³•ä¸Šã€‚&lt;/p>
&lt;p>èµ°è¿‡è¿™æ¬¡æ¯”è¾ƒå®½æ³›çš„æ—…é€”ï¼Œæˆ‘ä»¬ä¹Ÿæ”¶è·äº†ä¸€äº›æœ‰ç”¨çš„æŠ€å·§ï¼š&lt;/p>
&lt;ul>
&lt;li>ä½ å¿…é¡»ä½¿ç”¨&lt;code>Hash#fetch&lt;/code>ä»optionsä¸­è¯»å–å‚æ•°ï¼Œç‰¹åˆ«æ˜¯å¯¹äºbooleanç±»å‹å‚æ•°æ¥è¯´ã€‚&lt;/li>
&lt;li>è¯¸å¦‚&lt;code>&amp;quot;%s_changed&amp;quot;&lt;/code>è¿™æ ·çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¯ä»¥è¢«ç”¨äºç®€å•çš„æ¨¡æ¿ã€‚&lt;/li>
&lt;li>å¯ä»¥ä½¿ç”¨&lt;code>Regexp.escape&lt;/code>escapeæ­£åˆ™è¡¨è¾¾å¼ã€‚&lt;/li>
&lt;li>å½“ä½ è¯•å›¾è°ƒç”¨ä¸€ä¸ªæœªå®šä¹‰çš„æ–¹æ³•æ—¶ï¼ŒRubyä¼šè°ƒç”¨&lt;code>method_missing&lt;/code>æ–¹æ³•ã€‚&lt;/li>
&lt;li>HEREDOCså¯ä»¥ç”¨åœ¨æ–¹æ³•å‚æ•°ä¸­ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥å®šä¹‰å¤šè¡Œçš„å­—ç¬¦ä¸²ã€‚&lt;/li>
&lt;li>&lt;code>__FILE__&lt;/code>ä»¥åŠ&lt;code>__LINE__&lt;/code>æŒ‡å‘å½“å‰çš„æ–‡ä»¶ä»¥åŠè¡Œå·ã€‚&lt;/li>
&lt;li>ä½ å¯ä»¥ä½¿ç”¨&lt;code>module_eval&lt;/code>åŠ¨æ€ç”Ÿæˆä»£ç ã€‚&lt;/li>
&lt;/ul>
&lt;p>åšæŒæµè§ˆRailsçš„æºä»£ç å§ï¼Œä½ æ€»ä¼šå‘ç°ä½ åŸæœ¬ä¸çŸ¥é“çš„å®è—ï¼&lt;/p>
&lt;h3 id="å–œæ¬¢è¿™ç¯‡æ–‡ç« ">å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Ÿ&lt;/h3>
&lt;p>&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/02/jie-du-rails-xi-lie-fan-yi/">é˜…è¯»æ›´å¤š&lt;/a>ã€Šè§£è¯»Railsã€‹ä¸­çš„æ–‡ç« ã€‚&lt;/p></description></item><item><title>è·Ÿè¸ªmodelä¸­å±æ€§ï¼ˆå€¼ï¼‰çš„å˜æ›´</title><link>https://blog.hackerpie.com/posts/archive/zhui-zong-bian-geng/</link><pubDate>Fri, 07 Mar 2014 13:02:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/zhui-zong-bian-geng/</guid><description>&lt;p>æ­¤æ–‡ç¿»è¯‘è‡ª&lt;a href="http://monkeyandcrow.com/blog/reading_rails_change_tracking/">Reading Rails - Change Tracking&lt;/a>ï¼Œé™äºæœ¬äººæ°´å¹³ï¼Œç¿»è¯‘ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡æ•™ï¼&lt;/p>
&lt;p>æˆ‘ä»¬ä»Šå¤©æ¥çœ‹çœ‹Railsæ˜¯å¦‚ä½•è¿½è¸ªmodelé‡Œè¾¹å±æ€§çš„å˜æ›´çš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>person = Person.find(8)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.name = &lt;span style="font-style:italic">&amp;#34;Mortimer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.name_changed? &lt;span style="font-style:italic">#=&amp;gt; true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.name_was &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;Horton&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.changes &lt;span style="font-style:italic">#=&amp;gt; {&amp;#34;name&amp;#34;=&amp;gt;[&amp;#34;Horton&amp;#34;,&amp;#34;Mortimer&amp;#34;]}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.save!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.changes &lt;span style="font-style:italic">#=&amp;gt; {}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>name_changed?&lt;/code>æ–¹æ³•æ˜¯ä»å“ªæ¥çš„å‘¢ï¼Ÿå˜æ›´åˆæ˜¯å¦‚ä½•è¢«åˆ›å»ºçš„ï¼Ÿè®©æˆ‘ä»¬é¡ºç€è¿™ä¸ªåœºæ™¯ï¼Œçœ‹çœ‹è¿™ä¸€åˆ‡èƒŒåçš„ç§˜å¯†ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>å¦‚æœéœ€è¦è·Ÿç€æˆ‘çš„æ­¥éª¤èµ°ï¼Œè¯·ä½¿ç”¨&lt;a href="https://github.com/adamsanderson/qwandry">qwandry&lt;/a>æ‰“å¼€æ¯ä¸€ä¸ªç›¸å…³çš„ä»£ç åº“ï¼Œæˆ–è€…ç›´æ¥ä»&lt;a href="https://github.com/rails/rails/tree/5505c1d700f17e2009e1189a7aa6dafafe7062a4">github&lt;/a>æŸ¥çœ‹æºç å³å¯ã€‚&lt;/p>
&lt;h3 id="activemodel">ActiveModel&lt;/h3>
&lt;p>å½“ä½ æƒ³æ¢å¯»ActiveRecordé‡Œè¾¹çš„åŠŸèƒ½æ—¶ï¼Œä½ åº”è¯¥é¦–å…ˆäº†è§£ActiveModelã€‚ActiveModelï¼ˆ&lt;strong>æç¤º&lt;/strong>ï¼š å‘½ä»¤è¡Œä¸­é”®å…¥&lt;code>qw activemodel&lt;/code>æŸ¥çœ‹ä»£ç ï¼‰å®šä¹‰äº†æ²¡æœ‰ä¸æ•°æ®åº“æ†ç»‘çš„é€»è¾‘ã€‚æˆ‘ä»¬å°†ä»&lt;code>dirty.rb&lt;/code>æ–‡ä»¶å¼€å§‹ã€‚åœ¨è¿™ä¸ªæ¨¡å—æœ€å¼€å§‹çš„åœ°æ–¹ï¼Œä»£ç è°ƒç”¨äº†&lt;code>attribute_method_suffix&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">Dirty&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">extend&lt;/span> ActiveSupport::Concern
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">include&lt;/span> ActiveModel::AttributeMethods
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> included &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attribute_method_suffix &lt;span style="font-style:italic">&amp;#39;_changed?&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_change&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_will_change!&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_was&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>attribute_method_suffix&lt;/code>å®šä¹‰äº†å®šåˆ¶çš„å±æ€§è¯»å†™å™¨ã€‚è¿™ä¸»è¦ç”¨æ¥å‘Šè¯‰Railså°†ä¸€äº›å¸¦æœ‰ç±»ä¼¼&lt;code>_changed?&lt;/code>åç¼€çš„è°ƒç”¨åˆ†å‘åˆ°ç‰¹å®šçš„å¤„ç†å™¨æ–¹æ³•ä¸Šã€‚ä¸ºäº†çœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•å®ç°çš„ï¼Œè¯·å‘ä¸‹æ»šåŠ¨ä»£ç ï¼Œå¹¶ä¸”æ‰¾åˆ°&lt;code>def attribute_changed?&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> attribute_changed?(&lt;span style="">attr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> changed_attributes.include?(&lt;span style="">attr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å°†ä¼šåœ¨å¦å¤–çš„ä¸€ç¯‡æ–‡ç« ä¸­å†ç€é‡ä»‹ç»å¦‚ä½•è¿æ¥è¿™äº›æ–¹æ³•çš„ç»†èŠ‚ï¼Œå½“ä½ è°ƒç”¨ä¸€ä¸ªç±»ä¼¼&lt;code>name_changed?&lt;/code>çš„æ–¹æ³•æ—¶ï¼ŒRailså°†ä¼šæŠŠ&lt;code>&amp;quot;name&amp;quot;&lt;/code>ä½œä¸ºå‚æ•°&lt;code>attr&lt;/code>ä¼ ç»™ä¸Šè¿°æ–¹æ³•ã€‚å¾€å›çœ‹ä¸€ç‚¹ç‚¹ï¼Œä½ ä¼šå‘ç°&lt;code>changed_attributes&lt;/code>åªæ˜¯ä¸€ä¸ªåŒ…å«äº†ä»å±æ€§ååˆ°æ—§çš„å±æ€§å€¼çš„æ˜ å°„çš„&lt;code>Hash&lt;/code>è€Œå·²ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Returns a hash of the attributes with unsaved changes indicating their original&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># values like &amp;lt;tt&amp;gt;attr =&amp;gt; original value&amp;lt;/tt&amp;gt;.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># person.name # =&amp;gt; &amp;#34;bob&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># person.name = &amp;#39;robert&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># person.changed_attributes # =&amp;gt; {&amp;#34;name&amp;#34; =&amp;gt; &amp;#34;bob&amp;#34;}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> changed_attributes
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @changed_attributes ||= {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨Rubyä¸­ï¼Œå¦‚æœä½ ä¹‹å‰éƒ½æ²¡æœ‰è§è¿‡&lt;code>||=&lt;/code>æ“ä½œï¼Œé‚£ä¹ˆä½ å¯èƒ½éœ€è¦äº†è§£è¿™å…¶å®æ˜¯ä¸€ä¸ªç”¨äºåˆå§‹åŒ–å˜é‡å€¼çš„æŠ€å·§ã€‚å½“å®ƒç¬¬ä¸€æ¬¡è¢«è®¿é—®çš„æ—¶å€™ï¼Œå˜é‡çš„å€¼æ˜¯&lt;code>nil&lt;/code>ï¼Œæ‰€ä»¥å®ƒè¿”å›äº†ä¸€ä¸ªç©ºçš„&lt;code>Hash&lt;/code>å¹¶ä¸”ç”¨å…¶åˆå§‹åŒ–&lt;code>@changed_attributes&lt;/code>ã€‚å½“å®ƒå†ä¸€æ¬¡è¢«è®¿é—®çš„æ—¶å€™ï¼Œ&lt;code>@changed_attributes&lt;/code>å·²ç»è¢«èµ‹å€¼è¿‡äº†ã€‚é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥å›ç­”æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªé—®é¢˜äº†ï¼Œ&lt;code>name_changed?&lt;/code>æ–¹æ³•è¢«è½¬å‘åˆ°&lt;code>attribute_changed?&lt;/code>æ–¹æ³•ï¼Œè€Œåè€…ä¼šåœ¨&lt;code>changed_attributes&lt;/code>ä¸­æŸ¥æ‰¾ç‰¹å®šçš„å€¼ã€‚&lt;/p>
&lt;p>åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°&lt;code>changes&lt;/code>è¿”å›ä¸€ä¸ªç±»ä¼¼&lt;code>{&amp;quot;name&amp;quot;=&amp;gt;[&amp;quot;Horton&amp;quot;,&amp;quot;Mortimer&amp;quot;]}&lt;/code>è¿™æ ·æ—¢åŒ…å«æ—§çš„å±æ€§å€¼ï¼ŒåˆåŒ…å«æ–°çš„å±æ€§å€¼çš„&lt;code>Hash&lt;/code>ã€‚è®©æˆ‘ä»¬è¿™åˆæ˜¯å¦‚ä½•åšåˆ°çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> changes
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ActiveSupport::HashWithIndifferentAccess[changed.map { |&lt;span style="">attr&lt;/span>| [&lt;span style="">attr&lt;/span>, attribute_change(&lt;span style="">attr&lt;/span>)] }]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ®µä»£ç çœ‹èµ·æ¥æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä¸€æ­¥ä¸€æ­¥åˆ†æã€‚é¦–å…ˆæˆ‘ä»¬ä»&lt;code>ActiveSupport::HashWithIndifferentAccess&lt;/code>å¼€å§‹ï¼Œè¿™æ˜¯åœ¨ActiveSupportä¸­æ‰€å®šä¹‰çš„&lt;code>Hash&lt;/code>çš„å­ç±»ï¼Œé€šè¿‡å­—ç¬¦ä¸²ç±»å‹æˆ–è€…ç¬¦å·ç±»å‹çš„é”®å»è®¿é—®å®ƒå°†å¾—åˆ°ä¸€æ ·çš„ç»“æœï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>hash = ActiveSupport::HashWithIndifferentAccess.new
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>hash[&lt;span style="font-style:italic">:name&lt;/span>] = &lt;span style="font-style:italic">&amp;#34;Mortimer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>hash[&lt;span style="font-style:italic">&amp;#34;name&amp;#34;&lt;/span>] &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;Mortimer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥å°±æœ‰ç‚¹å¥‡æ€ªäº†ï¼ŒRailsè°ƒç”¨äº†&lt;code>Hash[]&lt;/code>æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªé²œä¸ºäººçŸ¥çš„ä»åŒ…å«é”®/å€¼å¯¹çš„æ•°ç»„ä¸­åˆå§‹åŒ–ä¸€ä¸ªå“ˆå¸Œè¡¨çš„æ–¹æ³•ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>Hash[
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="font-style:italic">:name&lt;/span>, &lt;span style="font-style:italic">&amp;#34;Mortimer&amp;#34;&lt;/span>],
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [&lt;span style="font-style:italic">:species&lt;/span>, &lt;span style="font-style:italic">&amp;#34;Crow&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>] &lt;span style="font-style:italic">#=&amp;gt; {[:name, &amp;#34;Mortimer&amp;#34;]=&amp;gt;[:species, &amp;#34;Crow&amp;#34;]}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥æŸ¥çœ‹&lt;code>Hash Tricks&lt;/code>æ‰¾åˆ°æ›´å¤šç±»ä¼¼çš„æ–¹æ³•ã€‚&lt;code>changes&lt;/code>ä¸­å‰©ä½™éƒ¨åˆ†çš„ä»£ç å°±æ¯”è¾ƒæ¸…æ™°äº†ã€‚å±æ€§åè¢«æ˜ å°„åˆ°ç±»ä¼¼&lt;code>[attr, attribute_change(attr)]&lt;/code>çš„æ•°ç»„ã€‚å…¶ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯&lt;code>attr&lt;/code>ç¼–ç¨‹äº†ä¸€ä¸ªé”®ï¼Œè€Œå¯¹åº”çš„å€¼åˆ™æ˜¯&lt;code>attribute_change(attr)&lt;/code>è¿”å›çš„ç»“æœã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> attribute_change(&lt;span style="">attr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> [changed_attributes[&lt;span style="">attr&lt;/span>], __send__(&lt;span style="">attr&lt;/span>)] &lt;span style="font-weight:bold">if&lt;/span> attribute_changed?(&lt;span style="">attr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ˜¯å¦ä¸€ä¸ªè¢«åˆ†å‘çš„å±æ€§æ–¹æ³•ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œå®ƒè¿”å›äº†ä¸€ä¸ªåŒ…å«äº†ä¸¤ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä»&lt;code>changed_attributes&lt;/code>å“ˆå¸Œè¡¨ä¸­è¯»åˆ°çš„&lt;code>attr&lt;/code>æ‰€å¯¹åº”çš„æ—§çš„å€¼ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯æ‰€å¯¹åº”çš„æ–°çš„å€¼ã€‚Railsé€šè¿‡ä½¿ç”¨&lt;code>__send__&lt;/code>æ–¹æ³•è°ƒç”¨äº†åä¸º&lt;code>attr&lt;/code>çš„æ–¹æ³•ï¼Œè¿›è€Œå¾—åˆ°æ–°çš„å±æ€§å€¼ã€‚ç„¶åè¿™å¯¹å€¼ä¼šè¢«è¿”å›ï¼Œå¹¶ä¸”ç”¨ä½œ&lt;code>changes&lt;/code>å“ˆå¸Œè¡¨ä¸­&lt;code>attr&lt;/code>æ‰€å¯¹åº”çš„å€¼ã€‚&lt;/p>
&lt;h3 id="activerecord">ActiveRecord&lt;/h3>
&lt;p>ç°åœ¨è®©æˆ‘ä»¬æ¥æ‰¾å‡ºRailsæ˜¯å¦‚ä½•è®°å½•æ›´æ”¹çš„ã€‚ActiveRecordå®ç°äº†è¯»å†™ActiveModelæ‰€è·Ÿè¸ªçš„å±æ€§çš„ä»£ç ã€‚è·ŸActiveModelä¸€æ ·ï¼ŒActiveRecordä¹Ÿæœ‰ä¸€ä¸ª&lt;code>dirty.rb&lt;/code>æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†è¦å¯¹è¿™ä¸ªæ–‡ä»¶è¿›è¡ŒæŒ–æ˜ã€‚é€šè¿‡åœ¨å®šä¹‰äº†&lt;code>changed_attributes&lt;/code>çš„æ–‡ä»¶ä¸­ï¼ˆ&lt;strong>æç¤º&lt;/strong>ï¼šå‘½ä»¤è¡Œä¸­é”®å…¥&lt;code>qw activerecord&lt;/code>ï¼‰æ‰¾åˆ°çš„ç›¸å…³ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶åŒ…è£…äº†ActiveRecordçš„&lt;code>write_attribute&lt;/code>ä¸é€»è¾‘ä»¥å®ç°å¯¹å˜æ›´çš„è·Ÿè¸ªã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Wrap write_attribute to remember original attribute value.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> write_attribute(&lt;span style="">attr&lt;/span>, value)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">attr&lt;/span> = &lt;span style="">attr&lt;/span>.to_s
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># The attribute already has an unsaved change.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> attribute_changed?(&lt;span style="">attr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> old = @changed_attributes[&lt;span style="">attr&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @changed_attributes.delete(&lt;span style="">attr&lt;/span>) &lt;span style="font-weight:bold">unless&lt;/span> _field_changed?(&lt;span style="">attr&lt;/span>, old, value)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> old = clone_attribute_value(&lt;span style="font-style:italic">:read_attribute&lt;/span>, &lt;span style="">attr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @changed_attributes[&lt;span style="">attr&lt;/span>] = old &lt;span style="font-weight:bold">if&lt;/span> _field_changed?(&lt;span style="">attr&lt;/span>, old, value)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Carry on.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">super&lt;/span>(&lt;span style="">attr&lt;/span>, value)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®©æˆ‘ä»¬æš‚æ—¶åç¦»ä¸€ä¸‹ä¸»é¢˜ï¼Œå¹¶ä¸”çœ‹ä¸€ä¸‹æ–¹æ³•çš„åŒ…è£…ã€‚è¿™æ˜¯åœ¨Railsçš„ä»£ç é‡Œè¾¹éå¸¸å¸¸è§çš„æ¨¡å¼ã€‚å½“ä½ è°ƒç”¨&lt;code>super&lt;/code>çš„æ—¶å€™ï¼ŒRubyæŸ¥æ‰¾å½“å‰å¯¹è±¡çš„æ‰€æœ‰ç¥–å…ˆï¼ŒåŒ…æ‹¬ç›¸å…³çš„æ¨¡å—ã€‚ç”±äºä¸€ä¸ªç±»å¯ä»¥å¼•è¿›å¤šä¸ªæ¨¡å—ï¼Œæ‰€ä»¥ä½ å¯ä»¥å¤šå±‚åœ°åŒ…è£…æ–¹æ³•ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">Shouting&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> say(message)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> message.upcase
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Speaker&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">include&lt;/span> Shouting
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> say(message)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> puts &lt;span style="font-weight:bold">super&lt;/span>(message)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Speaker.new.say(&lt;span style="font-style:italic">&amp;#34;Hi!&amp;#34;&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;HI!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯·æ³¨æ„&lt;code>Shouting&lt;/code>æ˜¯&lt;code>Speaker&lt;/code>æ‰€åŒ…å«çš„æ¨¡å—ï¼Œè€Œä¸æ˜¯åè€…æ‰€æ‰©å±•çš„ç±»ã€‚Railsä½¿ç”¨è¿™ç§æŠ€å·§å»åŒ…è£…æ–¹æ³•ï¼Œä»¥æ­¤ç¡®ä¿åœ¨ä¸åŒçš„æ–‡ä»¶é‡Œæœ‰ç‹¬ç«‹çš„å…³æ³¨ç‚¹ï¼ˆConcernï¼‰ã€‚è¿™ä¹Ÿæ„å‘³ç€ä¸ºäº†äº†è§£æ•´ä¸ªç³»ç»Ÿï¼Œä½ å¯èƒ½éœ€è¦ä»å¤šä¸ªæ–‡ä»¶é‡Œè¾¹æ‰¾åˆ°ç›¸å…³çš„ä»£ç ã€‚å‡å¦‚ä½ çœ‹åˆ°äº†ä¸€ä¸ªå¯¹&lt;code>super&lt;/code>çš„è°ƒç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯ä»¥å‘Šè¯‰ä½ åœ¨åˆ«çš„åœ°æ–¹è¿˜æœ‰æ›´å¤šä»£ç éœ€è¦äº†è§£çš„å¥½çº¿ç´¢ã€‚å‡å¦‚ä½ æƒ³å­¦ä¹ æ›´å¤šçš„è¿™æ–¹é¢çš„çŸ¥è¯†ï¼ŒJames Coglanæœ‰ä¸€ä¸ªéå¸¸è¯¦ç»†çš„æ–‡ç« è®²è§£äº†Rubyçš„&lt;a href="https://blog.jcoglan.com/2013/05/08/how-ruby-method-dispatch-works/">æ–¹æ³•åˆ†å‘&lt;/a>ã€‚&lt;/p>
&lt;p>å›åˆ°&lt;code>write_attribute&lt;/code>æ–¹æ³•ã€‚æ ¹æ®å±æ€§ï¼ˆå€¼ï¼‰æ˜¯å¦å·²ç»æ”¹å˜ï¼Œä¼šæœ‰ä¸¤ä¸ªå¯èƒ½çš„åœºæ™¯ã€‚ç¬¬ä¸€ä¸ªåˆ†æ”¯æ£€æŸ¥ä½ æ˜¯å¦æ­£åœ¨å°†ä¸€ä¸ªå±æ€§ï¼ˆå€¼ï¼‰è¿˜åŸåˆ°åŸæ¥çš„å€¼ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œå®ƒå°†ä¼šä»è®°å½•äº†å·²æ”¹å˜å±æ€§çš„å“ˆå¸Œè¡¨ä¸­åˆ é™¤å±æ€§ã€‚ç¬¬äºŒä¸ªåˆ†æ”¯ä»…ä»…åœ¨æ–°çš„å€¼ä¸æ—§çš„å€¼ä¸åŒçš„æ—¶å€™è®°å½•ä¸‹æ›´æ”¹ã€‚ä¸€æ—¦æ›´æ”¹è¢«è®°å½•ä¸‹æ¥ï¼Œå®é™…çš„ç”¨äºæ›´æ–°å±æ€§çš„é€»è¾‘é€šè¿‡è°ƒç”¨&lt;code>super&lt;/code>æ–¹æ³•å®Œæˆã€‚&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>Railsä¸ºä½ çš„modelæä¾›äº†å˜æ›´çš„è·Ÿè¸ªã€‚è¿™ä¸ªåŠŸèƒ½æ˜¯åœ¨ActiveModelä¸­å®ç°çš„ï¼Œä½†æ˜¯çœŸæ­£çš„ç›‘æµ‹æ›´æ”¹çš„é€»è¾‘åˆ™æ˜¯åœ¨ActiveRecordä¸­å®ç°çš„ã€‚&lt;/p>
&lt;p>é€šè¿‡äº†è§£è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬ä¹Ÿå‘æ˜åˆ°äº†ä¸€äº›æœ‰è¶£çš„å°è´´å£«ï¼š&lt;/p>
&lt;ul>
&lt;li>ActiveModelå®šä¹‰äº†&lt;code>attribute_method_suffix&lt;/code>æ–¹æ³•ç”¨äºåˆ†å‘ç±»ä¼¼&lt;code>name_changed?&lt;/code>çš„æ–¹æ³•ã€‚&lt;/li>
&lt;li>&lt;code>||=&lt;/code>æ“ä½œç¬¦æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥åˆå§‹åŒ–å˜é‡çš„æ–¹ä¾¿çš„æ–¹æ³•ã€‚&lt;/li>
&lt;li>åœ¨&lt;code>HashWithIndifferentAccess&lt;/code>ä¸­ï¼Œå­—ç¬¦ä¸²ç±»å‹ä»¥åŠç¬¦å·ç±»å‹çš„é”®æ˜¯ä¸€æ ·çš„ã€‚&lt;/li>
&lt;li>&lt;code>Hash&lt;/code>å¯ä»¥é€šè¿‡&lt;code>Hash[key_value_pairs]&lt;/code>æ–¹æ³•åˆå§‹åŒ–ã€‚&lt;/li>
&lt;li>ä½ å¯ä»¥ä½¿ç”¨æ¨¡å—æ‹¦æˆªæ–¹æ³•å¹¶ä¸ºæ–¹æ³•åŠ ä¸Šå¦ä¸€å±‚çš„åŠŸèƒ½ã€‚&lt;/li>
&lt;/ul>
&lt;p>å‡å¦‚ä½ æœ‰å…³äºä½ æƒ³é˜…è¯»çš„å…³äºRailsä¸­å…¶ä»–éƒ¨åˆ†çš„å»ºè®®ï¼Œè¯·è®©æˆ‘çŸ¥é“ã€‚&lt;/p>
&lt;h3 id="å–œæ¬¢è¿™ç¯‡æ–‡ç« ">å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Ÿ&lt;/h3>
&lt;p>&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/02/jie-du-rails-xi-lie-fan-yi/">é˜…è¯»æ›´å¤š&lt;/a>â€œè§£è¯»Railsâ€ä¸­çš„æ–‡ç« ã€‚â€œè§£è¯»Railsâ€ä¸­çš„æ–‡ç« ã€‚&lt;/p></description></item><item><title>è§£è¯»Rails - å¤„ç†å¼‚å¸¸</title><link>https://blog.hackerpie.com/posts/archive/jie-du-rails-chu-li-yi-chang/</link><pubDate>Wed, 05 Mar 2014 13:53:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/jie-du-rails-chu-li-yi-chang/</guid><description>&lt;p>æ­¤æ–‡ç¿»è¯‘è‡ª&lt;a href="http://monkeyandcrow.com/blog/reading_rails_handling_exceptions/">Reading Rails - Handling Exceptions&lt;/a>ï¼Œé™äºæœ¬äººæ°´å¹³ï¼Œç¿»è¯‘ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡æ•™ï¼&lt;/p>
&lt;p>æˆ‘ä»¬ä»Šå¤©å¼€å§‹ä¼šè¯»ä¸€äº›Railsçš„æºç ã€‚æˆ‘ä»¬æœ‰åŒé‡çš„ç›®çš„ï¼Œå…ˆé€šè¿‡å­¦ä¹ ï¼ˆRailsï¼‰å¦‚ä½•å¤„ç†å¼‚å¸¸ï¼Œå†æ‰©å±•åˆ°æ•´ä¸ªRubyä¸­åŸºç¡€çŸ¥è¯†çš„å­¦ä¹ ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>Railsé€šè¿‡è®©ä½ ä½¿ç”¨&lt;code>rescue_from&lt;/code>æ–¹æ³•ï¼Œè®©ä½ åœ¨ä½ çš„&lt;code>controller&lt;/code>é‡Œè¾¹ä¸ºå¸¸è§çš„å¼‚å¸¸å®šä¹‰å¤„ç†æ–¹æ³•ã€‚ä¸¾ä¾‹æ¥è¯´å§ï¼Œä½ å¯ä»¥åœ¨ç”¨æˆ·è¯•å›¾è®¿é—®ä»–ä»¬å°šæœªä»˜è´¹çš„åŠŸèƒ½æ—¶å°†ä»–ä»¬é‡å®šå‘åˆ°æŒ‡å®šçš„ä»˜è´¹é¡µé¢ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">ApplicationController&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># Redirect users if they try to use disabled features.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rescue_from FeatureDisabledError, InsufficientAccessError &lt;span style="font-weight:bold">do&lt;/span> |ex|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> flash[&lt;span style="font-style:italic">:alert&lt;/span>] = &lt;span style="font-style:italic">&amp;#34;Your account does not support &lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>ex.feature_name&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> redirect_to &lt;span style="font-style:italic">&amp;#34;/pricing&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å°†ä¼šæ¢ç´¢Railsæ˜¯å¦‚ä½•å®šä¹‰å¼‚å¸¸å¤„ç†å™¨ï¼Œå¦‚ä½•å°†å®ƒä»¬ä¸å…·ä½“çš„å¼‚å¸¸è¿›è¡ŒåŒ¹é…ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨å®ƒä»¬å»rescueå¤±è´¥çš„actionã€‚&lt;/p>
&lt;p>å¦‚æœéœ€è¦è·Ÿç€æˆ‘çš„æ­¥éª¤èµ°ï¼Œè¯·ä½¿ç”¨&lt;a href="https://github.com/adamsanderson/qwandry">qwandry&lt;/a>æ‰“å¼€æ¯ä¸€ä¸ªç›¸å…³çš„ä»£ç åº“ï¼Œæˆ–è€…ç›´æ¥ä»&lt;a href="https://github.com/rails/rails/tree/5505c1d700f17e2009e1189a7aa6dafafe7062a4">github&lt;/a>æŸ¥çœ‹æºç å³å¯ã€‚&lt;/p>
&lt;h3 id="å®šä¹‰å¤„ç†å™¨handlers">å®šä¹‰å¤„ç†å™¨(Handlers)&lt;/h3>
&lt;p>ActiveSupportåŒ…å«äº†ä¸€ä¸ªç”¨äºå®šä¹‰å¼‚å¸¸å¦‚ä½•è¢«å¤„ç†çš„æ¨¡å—&lt;code>Rescuable&lt;/code>ã€‚ç¬¬ä¸€ä¸ªéœ€è¦äº†è§£çš„æ–¹æ³•å°±æ˜¯&lt;code>rescue_from&lt;/code>ã€‚è¿™ä¸ªæ–¹æ³•é€šè¿‡æ–¹æ³•åæˆ–è€…ä»£ç å—ä¸ºä½ æƒ³rescueçš„å¼‚å¸¸æ³¨å†Œå¤„ç†å™¨ï¼ˆ&lt;strong>æç¤º&lt;/strong>ï¼šæŸ¥çœ‹ä»£ç ï¼Œè¯·åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥&lt;code>qw activesupport&lt;/code>ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> rescue_from(*klasses, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> options = klasses.extract_options!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">unless&lt;/span> options.has_key?(&lt;span style="font-style:italic">:with&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> block_given?
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> options[&lt;span style="font-style:italic">:with&lt;/span>] = block
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆï¼Œ&lt;code>*klasses&lt;/code>æ¥æ”¶æ•°é‡ä¸å®šçš„å¼‚å¸¸ç±»ï¼Œæ‰€ä»¥ä½ å¯ä»¥è¿›è¡Œç±»ä¼¼&lt;code>rescue_from(FeatureDisabledError, InsufficientAccessError)&lt;/code>è¿™æ ·çš„è°ƒç”¨ã€‚å®ƒä»¬å°†ä¼šè¢«å­˜æ”¾åœ¨ä¸€ä¸ªæ•°ç»„é‡Œã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥ï¼Œè¯·ç•™æ„&lt;code>extract_options!&lt;/code>çš„ä½¿ç”¨ã€‚è¿™æ˜¯ä¸€ä¸ªå¸¸è§çš„ç”¨äºä»ä¸€ä¸ªæ•°ç»„ç”Ÿæˆä¸€ä¸ªoptionså“ˆå¸Œè¡¨çš„æŠ€å·§ã€‚å‡å¦‚klassesé‡Œè¾¹çš„æœ€åä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå…ƒç´ ä¼šè¢«å¼¹å‡ºæ•°ç»„ã€‚ç°åœ¨Railså°†ä¼šä½¿ç”¨&lt;code>:with&lt;/code>é¡¹æ‰€æŒ‡å®šçš„æ–¹æ³•ï¼Œæˆ–è€…æ˜¯ä½¿ç”¨ä¼ é€’ç»™rescue_fromçš„ä»£ç å—ã€‚Railsä¸­çš„è¿™ç§æŠ€å·§åˆ›é€ äº†ä¸€ä¸ªçµæ´»çš„æ¥å£ã€‚&lt;/p>
&lt;p>æ¥ç€ç»§ç»­å¾€ä¸‹çœ‹è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹åˆ°æ¯ä¸€ä¸ªå¼‚å¸¸ç±»éƒ½è¢«è½¬æ¢æˆä¸€ä¸ªStringå¯¹è±¡ï¼Œæˆ‘ä»¬å¾…ä¼šä¾¿ä¼šçœ‹åˆ°ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> rescue_from(*klasses, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> key = &lt;span style="font-weight:bold">if&lt;/span> klass.is_a?(Class) &amp;amp;&amp;amp; klass &amp;lt;= Exception
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> klass.name
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">elsif&lt;/span> klass.is_a?(String)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> klass
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œä½ åº”è¯¥æ³¨æ„çš„æ˜¯ï¼ŒRailsæ˜¯å¦‚ä½•åˆ¤å®š&lt;code>klass&lt;/code>æ˜¯ä¸æ˜¯ç»§æ‰¿è‡ª&lt;code>Exception&lt;/code>çš„ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½ä¼šé€šè¿‡ä½¿ç”¨&lt;code>obj.is_a?(Exception)&lt;/code>æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯æŸä¸€ä¸ªå…·ä½“ç±»å‹çš„å®ä¾‹ï¼Œå³ä½¿å¦‚æ­¤ï¼Œ&lt;code>klass&lt;/code>å¹¶ä¸æ˜¯&lt;code>Exception&lt;/code>ï¼Œè€Œåªæ˜¯&lt;code>Class&lt;/code>ã€‚é‚£ä¹ˆæˆ‘ä»¬åˆæ€ä¹ˆæ‰¾å‡ºå®ƒä½¿å“ªä¸€ç±»å‘¢ï¼ŸRubyåœ¨&lt;code>Module&lt;/code>ä¸Šå®šä¹‰äº†ç±»ä¼¼&lt;code>&amp;lt;=&lt;/code>è¿™æ ·çš„&lt;a href="http://ruby-doc.org/core-1.9.3/Module.html#method-i-3C">ç”¨äºæ¯”è¾ƒçš„æ“ä½œç¬¦&lt;/a>ã€‚å½“æ“ä½œç¬¦å·¦è¾¹çš„å¯¹è±¡æ˜¯æ“ä½œç¬¦å³è¾¹å¯¹è±¡çš„å­ç±»çš„æ—¶å€™ï¼Œå®ƒä¼šè¿”å›trueã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ&lt;code>ActiveRecord::RecordNotFound &amp;lt; Exception&lt;/code>è¿”å›trueï¼Œè€Œ&lt;code>ActiveRecord::RecordNotFound &amp;gt; Exception&lt;/code>è¿”å›falseã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªæ–¹æ³•çš„æœ«å°¾ï¼Œæˆ‘ä»¬çœ‹åˆ°è¡¨ç¤ºå¼‚å¸¸ç±»çš„&lt;code>String&lt;/code>å¯¹è±¡ç¨åè¢«å‚¨å­˜åœ¨äºŒå…ƒæ•°ç»„ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> rescue_from(*klasses, &amp;amp;block)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> self.rescue_handlers += [[key, options[&lt;span style="font-style:italic">:with&lt;/span>]]]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†å¤„ç†å™¨æ˜¯å¦‚ä½•å‚¨å­˜çš„ï¼Œä½†æ˜¯å½“Railséœ€è¦å¤„ç†å¼‚å¸¸çš„æ—¶å€™ï¼Œå®ƒåˆæ˜¯å¦‚ä½•æŸ¥æ‰¾è¿™äº›å¤„ç†å™¨çš„å‘¢ï¼Ÿ&lt;/p>
&lt;h3 id="æŸ¥æ‰¾å¤„ç†å™¨finding-handlers">æŸ¥æ‰¾å¤„ç†å™¨ï¼ˆFinding Handlersï¼‰&lt;/h3>
&lt;p>ç»è¿‡å¯¹&lt;code>rescue_handlers&lt;/code>çš„å¿«é€Ÿæœç´¢å‘ç°ï¼Œè¿™ä¸€åˆ‡ä½¿ç”¨åˆ°äº†&lt;code>handler_for_rescue&lt;/code>ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªå¯èƒ½çš„å¤„ç†å™¨éƒ½è¢«ä¸€ä¸€æ£€æŸ¥ï¼Œç›´åˆ°æˆ‘ä»¬æ‰¾åˆ°èƒ½å¤Ÿä¸&lt;code>exception&lt;/code>åŒ¹é…çš„å¤„ç†å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> handler_for_rescue(exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># æˆ‘ä»¬éµå¾ªä»å³åˆ°å·¦çš„é¡ºåºï¼Œæ˜¯å› ä¸ºæ¯å½“å‘ç°ä¸€ä¸ªrescue_fromå£°æ˜çš„æ—¶å€™ï¼Œ&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># ç›¸åº”çš„klass_name, handlerå¯¹å°±ä¼šè¢«å‹å…¥resuce_handlersé‡Œã€‚&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> _, rescuer = self.class.rescue_handlers.reverse.detect &lt;span style="font-weight:bold">do&lt;/span> |klass_name, handler|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> klass = self.class.const_get(klass_name) &lt;span style="font-weight:bold">rescue&lt;/span> &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> klass ||= klass_name.constantize &lt;span style="font-weight:bold">rescue&lt;/span> &lt;span style="">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> exception.is_a?(klass) &lt;span style="font-weight:bold">if&lt;/span> klass
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚åŒæ³¨é‡Šæ‰€è¨€ï¼Œ&lt;code>rescue_handlers&lt;/code>è¢«ååºè¯»å–ã€‚å‡å¦‚æœ‰ä¸¤ä¸ªå¤„ç†å™¨èƒ½å¤Ÿå¤„ç†åŒä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆæœ€åå®šä¹‰çš„å¤„ç†å™¨ä¼šè¢«ä¼˜å…ˆé€‰ä¸­ã€‚å‡å¦‚ä½ å…ˆå®šä¹‰äº†ä¸€ä¸ªé’ˆå¯¹&lt;code>ActiveRecord::NotFoundError&lt;/code>å¼‚å¸¸çš„å¤„ç†å™¨ï¼Œæ¥ç€åˆå®šä¹‰äº†é’ˆå¯¹&lt;code>Exception&lt;/code>å¼‚å¸¸çš„å¤„ç†å™¨ï¼Œé‚£ä¹ˆå‰è€…å°†æ°¸è¿œéƒ½ä¸ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºé’ˆå¯¹&lt;code>Exception&lt;/code>çš„å¤„ç†å™¨æ€»æ˜¯ä¼šä¼˜å…ˆåŒ¹é…ã€‚&lt;/p>
&lt;p>ç°åœ¨ï¼Œåœ¨ä»£ç å—é‡Œè¾¹ï¼Œåˆå‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ&lt;/p>
&lt;p>é¦–å…ˆï¼Œå­—ç¬¦ä¸²å¯¹è±¡&lt;code>klass_name&lt;/code>è¢«å½“åšå½“å‰ç±»å†…éƒ¨çš„å¸¸é‡è¿›è¡ŒæŸ¥æ‰¾ï¼Œåœ¨æ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹ä¼šç»§ç»­åˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯å®šä¹‰åœ¨ç¨‹åºå†…éƒ¨å…¶ä»–åœ°æ–¹çš„å¸¸é‡ï¼Œä»¥æ­¤å°†&lt;code>klass_name&lt;/code>è½¬æ¢ä¸ºå®é™…çš„ç±»ã€‚æ¯ä¸€æ­¥éƒ½é€šè¿‡è¿”å›&lt;code>nil&lt;/code>è¿›è¡Œrescueã€‚è¿™ä¹ˆåšçš„ä¸€ä¸ªåŸå› å°±æ˜¯å½“å‰å¤„ç†å™¨å¯èƒ½æ˜¯é’ˆå¯¹æŸä¸ªå°šæœªåŠ è½½çš„å¼‚å¸¸çš„ç±»å‹ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œä¸€ä¸ªæ’ä»¶é‡Œå¯èƒ½ä¸º&lt;code>ActiveRecord::NotFoundError&lt;/code>å®šä¹‰äº†é”™è¯¯å¤„ç†ï¼Œä½†æ˜¯ä½ å¯èƒ½å¹¶æ²¡æœ‰ä½¿ç”¨&lt;code>ActiveRecord&lt;/code>ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œå¼•ç”¨è¿™ä¸ªå¼‚å¸¸å°†ä¼šå¯¼è‡´å¼‚å¸¸ã€‚æ¯ä¸€è¡Œæœ€åçš„&lt;code>rescue nil&lt;/code>èƒ½å¤Ÿåœ¨æ— æ³•æ‰¾åˆ°ç±»æ—¶æ— å£°æ— æ¯åœ°ç»„ç»‡å¼‚å¸¸çš„æŠ›å‡ºã€‚&lt;/p>
&lt;p>æœ€åæˆ‘ä»¬æ£€æŸ¥è¿™ä¸ªå¼‚å¸¸ï¼ˆç­‰å¾…åŒ¹é…çš„å¼‚å¸¸ï¼‰æ˜¯å¦æ˜¯è¿™ä¸ªå¤„ç†å™¨æ‰€å¯¹åº”å¼‚å¸¸ç±»çš„å®ä¾‹ã€‚å¦‚æœæ˜¯ï¼Œæ•°ç»„&lt;code>[klass_name, handler]&lt;/code>å°†ä¼šè¢«è¿”å›ã€‚è¿”å›åˆ°ä¸Šè¾¹çœ‹çœ‹&lt;code>_, rescuer = ...&lt;/code>è¿™ä¸€è¡Œä»£ç ï¼Œè¿™ä¸€ä¸€ä¸ªæ•°ç»„æ‹†åˆ†çš„ä¾‹å­ã€‚å› ä¸ºæˆ‘ä»¬å®é™…ä¸Šåªæƒ³è¦è¿”å›æ•°ç»„çš„ç¬¬äºŒä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯å¤„ç†å™¨ï¼Œæ‰€ä»¥&lt;code>_&lt;/code>åœ¨è¿™é‡Œåªæ˜¯ä¸€ä¸ªå ä½ç¬¦ã€‚&lt;/p>
&lt;h3 id="å¤„ç†å¼‚å¸¸rescuing-exceptions">å¤„ç†å¼‚å¸¸ï¼ˆRescuing Exceptions)&lt;/h3>
&lt;p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†ç¨‹åºæ˜¯å¦‚ä½•æŸ¥æ‰¾å¼‚å¸¸å¤„ç†å™¨çš„ï¼Œä½†æ˜¯å®ƒåˆæ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„å‘¢ï¼Ÿä¸ºäº†å›ç­”è¿™æœ€åä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥è¿”å›åˆ°æºä»£ç æ–‡ä»¶çš„é¡¶éƒ¨ç„¶åæ¢ç´¢ä¸€ä¸‹&lt;code>rescue_with_handler&lt;/code>æ–¹æ³•ã€‚å½“ç»™å®ƒä¼ é€’ä¸€ä¸ªå¼‚å¸¸çš„æ—¶å€™ï¼Œå®ƒå°†ä¼šå°è¯•é€šè¿‡è°ƒç”¨åˆé€‚çš„å¤„ç†å™¨æ¥å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> rescue_with_handler(exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> handler = handler_for_rescue(exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handler.arity != 0 ? handler.call(exception) : handler.call
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸ºäº†äº†è§£è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•åœ¨ä½ çš„controlleré‡Œè¾¹ç”Ÿæ•ˆçš„ï¼Œæˆ‘ä»¬éœ€è¦æŸ¥çœ‹ActionPackåŒ…é‡Œè¾¹çš„ä»£ç ã€‚ï¼ˆ&lt;strong>æç¤º&lt;/strong>ï¼šå¯ä»¥åœ¨å‘½ä»¤è¡Œä¸­é”®å…¥&lt;code>qw actionpack&lt;/code>æ‰“å¼€ActionPaceçš„ä»£ç ï¼‰Railså®šä¹‰äº†ä¸€ä¸ªå«åš&lt;code>ActionController::Rescue&lt;/code>çš„ä¸­é—´ä»¶ï¼Œå®ƒè¢«æ··å…¥åˆ°äº†&lt;code>Rescuable&lt;/code>æ¨¡å—é‡Œè¾¹ï¼Œå¹¶ä¸”é€šè¿‡&lt;code>precess_action&lt;/code>è°ƒç”¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> process_action(*args)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">super&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">rescue&lt;/span> Exception =&amp;gt; exception
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rescue_with_handler(exception) || &lt;span style="font-weight:bold">raise&lt;/span>(exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Railsåœ¨æ”¶åˆ°æ¯ä¸€ä¸ªè¯·æ±‚æ—¶éƒ½ä¼šè°ƒç”¨&lt;code>process_action&lt;/code>ï¼Œå‡å¦‚è¯·æ±‚å¯¼è‡´ä¸€ä¸ªå¼‚å¸¸å³å°†è¢«æŠ›å‡ºï¼Œ&lt;code>rescue_with_handler&lt;/code>éƒ½ä¼šè¯•å›¾å»å¤„ç†è¿™ä¸ªå¼‚å¸¸ã€‚&lt;/p>
&lt;h3 id="åœ¨railsä¹‹å¤–ä½¿ç”¨rescuableusing-rescuable-outside-of-rails">åœ¨Railsä¹‹å¤–ä½¿ç”¨Rescuableï¼ˆUsing Rescuable Outside of Railsï¼‰&lt;/h3>
&lt;p>&lt;code>Rescuable&lt;/code>èƒ½å¤Ÿè¢«æ··å…¥åˆ°å…¶å®ƒä»£ç ä¹‹ä¸­ã€‚å‡å¦‚ä½ æƒ³é›†ä¸­åŒ–ä½ çš„å¼‚å¸¸å¤„ç†éƒ¨åˆ†çš„é€»è¾‘ï¼Œé‚£ä¹ˆä½ å¯ä»¥è€ƒè™‘ä¸€ä¸‹ä½¿ç”¨&lt;code>Rescuable&lt;/code>ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ä½ æœ‰å¾ˆå¤šå‘å‘è¿œç¨‹æœåŠ¡çš„è¯·æ±‚ï¼Œå¹¶ä¸”ä½ ä¸æƒ³åœ¨æ¯ä¸€ä¸ªæ–¹æ³•é‡Œè¾¹é‡å¤å¼‚å¸¸å¤„ç†çš„é€»è¾‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">RemoteService&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">include&lt;/span> Rescuable
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rescue_from Net::HTTPNotFound, Net::HTTPNotAcceptable &lt;span style="font-weight:bold">do&lt;/span> |ex|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> disable_service!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> log_http_failure(@endpoint, ex)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rescue_from Net::HTTPNetworkAuthenticationRequired &lt;span style="font-weight:bold">do&lt;/span> |ex|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> authorize!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> get_status
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Exception =&amp;gt; exception
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rescue_with_handler(exception) || &lt;span style="font-weight:bold">raise&lt;/span>(exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> update_status
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">rescue&lt;/span> Exception =&amp;gt; exception
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rescue_with_handler(exception) || &lt;span style="font-weight:bold">raise&lt;/span>(exception)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨ä¸€ç‚¹å…ƒç¼–ç¨‹çš„æŠ€å·§ï¼Œä½ ç”šè‡³å¯ä»¥é€šè¿‡ç±»ä¼¼çš„æ¨¡å¼å¯¹å·²æœ‰çš„æ–¹æ³•è¿›è¡Œå°è£…ä»¥é¿å…rescueä»£ç å—ã€‚&lt;/p>
&lt;h3 id="æ€»ç»“recap">æ€»ç»“ï¼ˆRecapï¼‰&lt;/h3>
&lt;p>ActiveSupportçš„&lt;code>Rescuable&lt;/code>æ¨¡å—å…è®¸æˆ‘ä»¬å®šä¹‰å¼‚å¸¸å¤„ç†æ–¹æ³•ã€‚ActionControllerçš„&lt;code>Rescue&lt;/code>ä¸­é—´ä»¶æ•æ‰å¼‚å¸¸ï¼Œå¹¶è¯•å›¾å¤„ç†è¿™äº›å¼‚å¸¸ã€‚
æˆ‘ä»¬ä¹ŸåŒæ—¶äº†è§£åˆ°ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸€ä¸ªç­¾åç±»ä¼¼&lt;code>rescue_from(*klasses)&lt;/code>çš„æ–¹æ³•å¯ä»¥æ¥æ”¶æ•°é‡ä¸å®šçš„å‚æ•°ã€‚&lt;/li>
&lt;li>&lt;code>Array#extract_options!&lt;/code>æ–¹æ³•æ˜¯ä¸€ä¸ªç”¨äºä»argumentsæ•°ç»„å¾—åˆ°optionsçš„æŠ€å·§ã€‚&lt;/li>
&lt;li>ä½ å¯ä»¥é€šè¿‡ç±»ä¼¼&lt;code>klass &amp;lt;= Exception&lt;/code>è¿™æ ·çš„ä»£ç åˆ¤è¯»ä¸€ä¸ªç±»æ˜¯å¦æŸä¸ªç±»çš„å­ç±»ã€‚&lt;/li>
&lt;li>&lt;code>rescue nil&lt;/code>å°†ä¼šé™é»˜åœ°æ¶ˆé™¤å¼‚å¸¸ã€‚&lt;/li>
&lt;/ul>
&lt;p>å°±ç®—æ˜¯å†å°çš„ä»£ç ç‰‡æ®µéƒ½åŒ…å«äº†éå¸¸å¤šæœ‰ç”¨çš„ä¿¡æ¯ï¼Œè¯·è®©æˆ‘çŸ¥é“ä½ ä¸‹ä¸€æ­¥æƒ³è¦äº†è§£ä»€ä¹ˆä¸œè¥¿ï¼Œæˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°èƒ½å¤Ÿä»Railsé‡Œè¾¹æŒ–æ˜åˆ°çš„æ–°å¥‡ç©æ„ã€‚&lt;/p>
&lt;h3 id="å–œæ¬¢è¿™ç¯‡æ–‡ç« ">å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Ÿ&lt;/h3>
&lt;p>&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/02/jie-du-rails-xi-lie-fan-yi/">é˜…è¯»æ›´å¤š&lt;/a>â€œè§£è¯»Railsâ€ä¸­çš„æ–‡ç« ã€‚â€œè§£è¯»Railsâ€ä¸­çš„æ–‡ç« ã€‚&lt;/p></description></item><item><title>è§£è¯»Rails - é€‚é…å™¨æ¨¡å¼</title><link>https://blog.hackerpie.com/posts/archive/jie-du-rails-gua-pei-qi-mo-shi/</link><pubDate>Mon, 03 Mar 2014 13:40:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/jie-du-rails-gua-pei-qi-mo-shi/</guid><description>&lt;p>æœ¬æ–‡ç¿»è¯‘è‡ª&lt;a href="http://monkeyandcrow.com/blog/reading_rails_the_adapter_pattern/?utm_source=rubyweekly&amp;amp;utm_medium=email">Reading Rails - The Adapter Pattern&lt;/a>ï¼Œé™äºæœ¬äººæ°´å¹³æœ‰é™ï¼Œç¿»è¯‘ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡æ•™ï¼&lt;/p>
&lt;p>ä»Šå¤©æˆ‘ä»¬æš‚æ—¶å…ˆæ”¾ä¸‹å…·ä½“çš„ä»£ç ç‰‡æ®µï¼Œæˆ‘ä»¬å°†è¦å¯¹Railsä¸­æ‰€å®ç°çš„ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„è®¾è®¡æ¨¡å¼è¿›è¡Œä¸€ç•ªæ¢ç´¢ï¼Œè¿™ä¸ªæ¨¡å¼å°±æ˜¯&lt;a href="http://en.wikipedia.org/wiki/Adapter_pattern">é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰&lt;/a>ã€‚ä»ä¸€å®šçš„æ„ä¹‰ä¸Šæ¥è¯´ï¼Œè¿™æ¬¡çš„æ¢ç´¢å¹¶ä¸å…¨é¢ï¼Œä½†æ˜¯æˆ‘å¸Œæœ›èƒ½å¤Ÿçªå‡ºä¸€äº›å®é™…çš„ä¾‹å­ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>ä¸ºäº†è·Ÿéšæœ¬æ–‡çš„æ­¥éª¤ï¼Œè¯·ä½¿ç”¨&lt;a href="https://github.com/adamsanderson/qwandry">qwandry&lt;/a>æ‰“å¼€ç›¸å…³çš„ä»£ç åº“ï¼Œæˆ–è€…ç›´æ¥åœ¨&lt;a href="https://github.com/rails/rails/tree/5505c1d700f17e2009e1189a7aa6dafafe7062a4">Github&lt;/a>ä¸ŠæŸ¥çœ‹è¿™äº›ä»£ç ã€‚&lt;/p>
&lt;h3 id="é€‚é…å™¨æ¨¡å¼">é€‚é…å™¨æ¨¡å¼&lt;/h3>
&lt;p>&lt;a href="http://en.wikipedia.org/wiki/Adapter_pattern">é€‚é…å™¨æ¨¡å¼&lt;/a>å¯ä»¥ç”¨äºå¯¹ä¸åŒçš„æ¥å£è¿›è¡ŒåŒ…è£…ä»¥åŠæä¾›ç»Ÿä¸€çš„æ¥å£ï¼Œæˆ–è€…æ˜¯è®©æŸä¸€ä¸ªå¯¹è±¡çœ‹èµ·æ¥åƒæ˜¯å¦ä¸€ä¸ªç±»å‹çš„å¯¹è±¡ã€‚åœ¨é™æ€ç±»å‹çš„ç¼–ç¨‹è¯­è¨€é‡Œï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨å®ƒå»æ»¡è¶³ç±»å‹ç³»ç»Ÿçš„ç‰¹ç‚¹ï¼Œä½†æ˜¯åœ¨ç±»ä¼¼Rubyè¿™æ ·çš„å¼±ç±»å‹ç¼–ç¨‹è¯­è¨€é‡Œï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¹ˆåšã€‚å°½ç®¡å¦‚æ­¤ï¼Œå®ƒå¯¹äºæˆ‘ä»¬æ¥è¯´è¿˜æ˜¯æœ‰å¾ˆå¤šæ„ä¹‰çš„ã€‚&lt;/p>
&lt;p>å½“ä½¿ç”¨ç¬¬ä¸‰æ–¹ç±»æˆ–è€…åº“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»å¸¸ä»è¿™ä¸ªä¾‹å­å¼€å§‹ï¼ˆstart out fineï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> find_nearest_restaurant(locator)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> locator.nearest(&lt;span style="font-style:italic">:restaurant&lt;/span>, self.lat, self.lon)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æˆ‘ä»¬å‡è®¾æœ‰ä¸€ä¸ªé’ˆå¯¹&lt;code>locator&lt;/code>çš„æ¥å£ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦&lt;code>find_nearest_restaurant&lt;/code>èƒ½å¤Ÿæ”¯æŒå¦ä¸€ä¸ªåº“å‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯èƒ½å°±ä¼šå»å°è¯•æ·»åŠ æ–°çš„ç‰¹æ®Šçš„åœºæ™¯çš„å¤„ç†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> find_nearest_restaurant(locator)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> locator.is_a? GeoFish
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> locator.nearest(&lt;span style="font-style:italic">:restaurant&lt;/span>, self.lat, self.lon)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">elsif&lt;/span> locator.is_a? ActsAsFound
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> locator.find_food(&lt;span style="font-style:italic">:lat&lt;/span> =&amp;gt; self.lat, &lt;span style="font-style:italic">:lon&lt;/span> =&amp;gt; self.lon)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">raise&lt;/span> NotImplementedError, &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>locator.class.name&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic"> is not supported.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒåŠ¡å®çš„è§£å†³æ–¹æ¡ˆã€‚æˆ–è®¸æˆ‘ä»¬ä¹Ÿä¸å†éœ€è¦è€ƒè™‘å»æ”¯æŒå¦ä¸€ä¸ªåº“äº†ã€‚ä¹Ÿæˆ–è®¸&lt;code>find_nearest_restaurant&lt;/code>å°±æ˜¯æˆ‘ä»¬ä½¿ç”¨&lt;code>locator&lt;/code>çš„å”¯ä¸€åœºæ™¯ã€‚&lt;/p>
&lt;p>é‚£å‡å¦‚ä½ çœŸçš„éœ€è¦å»æ”¯æŒä¸€ä¸ªæ–°çš„&lt;code>locator&lt;/code>ï¼Œé‚£åˆä¼šæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿé‚£å°±æ˜¯ä½ æœ‰ä¸‰ä¸ªç‰¹å®šçš„åœºæ™¯ã€‚å†å‡å¦‚ä½ éœ€è¦å®ç°&lt;code>find_nearest_hospital&lt;/code>æ–¹æ³•å‘¢ï¼Ÿè¿™æ ·ä½ å°±éœ€è¦åœ¨ç»´æŠ¤è¿™ä¸‰ç§ç‰¹å®šçš„åœºæ™¯æ—¶å»å…¼é¡¾ä¸¤ä¸ªä¸åŒçš„åœ°æ–¹ã€‚å½“ä½ è§‰å¾—è¿™ç§è§£å†³æ–¹æ¡ˆä¸å†å¯è¡Œçš„æ—¶å€™ï¼Œä½ å°±éœ€è¦è€ƒè™‘é€‚é…å™¨æ¨¡å¼äº†ã€‚&lt;/p>
&lt;p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º&lt;code>GeoFish&lt;/code>ä»¥åŠ&lt;code>ActsAsFound&lt;/code>ç¼–å†™é€‚é…å™¨ï¼Œè¿™æ ·çš„è¯ï¼Œåœ¨æˆ‘ä»¬çš„å…¶ä»–ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦äº†è§£æˆ‘ä»¬å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ˜¯å“ªä¸ªåº“äº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> find_nearest_hospital(locator)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> locator.find &lt;span style="font-style:italic">:type&lt;/span> =&amp;gt; &lt;span style="font-style:italic">:hospital&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">:lat&lt;/span> =&amp;gt; self.lat,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">:lon&lt;/span> =&amp;gt; self.lon
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>locator = GeoFishAdapter.new(geo_fish_locator)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>find_nearest_hospital(locator)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç‰¹æ„å‡è®¾çš„ä¾‹å­å°±åˆ°æ­¤ä¸ºæ­¢ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹çœŸå®çš„ä»£ç ã€‚&lt;/p>
&lt;h3 id="multijson">MultiJSON&lt;/h3>
&lt;p>&lt;code>ActiveSupport&lt;/code>åœ¨åšJSONæ ¼å¼çš„è§£ç æ—¶ï¼Œç”¨åˆ°çš„æ˜¯&lt;code>MultiJSON&lt;/code>ï¼Œè¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹JSONåº“çš„é€‚é…å™¨ã€‚æ¯ä¸€ä¸ªåº“éƒ½èƒ½å¤Ÿè§£æJSONï¼Œä½†æ˜¯åšæ³•å´ä¸å°½ç›¸åŒã€‚è®©æˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹é’ˆå¯¹&lt;a href="https://github.com/ohler55/oj">oj&lt;/a>å’Œ&lt;a href="https://github.com/brianmario/yajl-ruby">yajl&lt;/a>çš„é€‚é…å™¨ã€‚
(&lt;strong>æç¤º&lt;/strong>: å¯åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥&lt;code>qw multi_json&lt;/code>æŸ¥çœ‹æºç ã€‚)&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">MultiJson&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">Adapters&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Oj&lt;/span> &amp;lt; Adapter
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> load(string, options={})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> options[&lt;span style="font-style:italic">:symbol_keys&lt;/span>] = options.delete(&lt;span style="font-style:italic">:symbolize_keys&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ::Oj.load(string, options)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Ojçš„é€‚é…å™¨ä¿®æ”¹äº†&lt;code>options&lt;/code>å“ˆå¸Œè¡¨ï¼Œä½¿ç”¨&lt;code>Hash#delete&lt;/code>å°†&lt;code>:symbolize_keys&lt;/code>é¡¹è½¬æ¢ä¸ºOjçš„&lt;code>:symbol_keys&lt;/code>é¡¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>options = {&lt;span style="font-style:italic">:symbolize_keys&lt;/span> =&amp;gt; &lt;span style="">true&lt;/span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>options[&lt;span style="font-style:italic">:symbol_keys&lt;/span>] = options.delete(&lt;span style="font-style:italic">:symbolize_keys&lt;/span>) &lt;span style="font-style:italic"># =&amp;gt; true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>options &lt;span style="font-style:italic"># =&amp;gt; {:symbol_keys=&amp;gt;true}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ä¸‹æ¥MultiJSONè°ƒç”¨äº†&lt;code>::Oj.load(string, options)&lt;/code>ã€‚MultiJSONé€‚é…åçš„APIè·ŸOjåŸæœ‰çš„APIéå¸¸ç›¸ä¼¼ï¼Œåœ¨æ­¤ä¸å¿…èµ˜è¿°ã€‚ä¸è¿‡ä½ æ˜¯å¦æ³¨æ„åˆ°ï¼ŒOjæ˜¯å¦‚ä½•å¼•ç”¨çš„å‘¢ï¼Ÿ&lt;code>::Oj&lt;/code>å¼•ç”¨äº†é¡¶å±‚çš„&lt;code>Oj&lt;/code>ç±»ï¼Œè€Œä¸æ˜¯&lt;code>MultiJson::Adapters::Oj&lt;/code>ã€‚&lt;/p>
&lt;p>ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹MultiJSONåˆæ˜¯å¦‚ä½•é€‚é…Yajlåº“çš„ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">MultiJson&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">Adapters&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">Yajl&lt;/span> &amp;lt; Adapter
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> load(string, options={})
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ::Yajl::Parser.new(&lt;span style="font-style:italic">:symbolize_keys&lt;/span> =&amp;gt; options[&lt;span style="font-style:italic">:symbolize_keys&lt;/span>]).parse(string)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸ªé€‚é…å™¨ä»ä¸åŒçš„æ–¹å¼å®ç°äº†&lt;code>load&lt;/code>æ–¹æ³•ã€‚Yajlçš„æ–¹å¼æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªè§£æå™¨çš„å®åŠ›ï¼Œç„¶åå°†ä¼ å…¥çš„å­—ç¬¦ä¸²&lt;code>string&lt;/code>ä½œä¸ºå‚æ•°è°ƒç”¨&lt;code>Yajl::Parser#parse&lt;/code>æ–¹æ³•ã€‚åœ¨&lt;code>options&lt;/code>å“ˆå¸Œè¡¨ä¸Šçš„å¤„ç†ä¹Ÿç•¥æœ‰ä¸åŒã€‚åªæœ‰&lt;code>:symbolize_keys&lt;/code>é¡¹è¢«ä¼ é€’ç»™äº†Yajlã€‚&lt;/p>
&lt;p>è¿™äº›JSONçš„é€‚é…å™¨çœ‹ä¼¼å¾®ä¸è¶³é“ï¼Œä½†æ˜¯ä»–ä»¬å´å¯ä»¥è®©ä½ éšå¿ƒæ‰€æ¬²åœ°åœ¨ä¸åŒçš„åº“ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œè€Œä¸éœ€è¦åœ¨æ¯ä¸€ä¸ªè§£æJSONçš„åœ°æ–¹æ›´æ–°ä»£ç ã€‚&lt;/p>
&lt;h3 id="activerecord">ActiveRecord&lt;/h3>
&lt;p>å¾ˆå¤šJSONåº“å¾€å¾€éƒ½éµä»ç›¸ä¼¼çš„æ¨¡å¼ï¼Œè¿™è®©é€‚é…å·¥ä½œå˜å¾—ç›¸å½“è½»æ¾ã€‚ä½†æ˜¯å¦‚æœä½ æ˜¯åœ¨å¤„ç†ä¸€äº›æ›´åŠ å¤æ‚çš„æƒ…å†µæ—¶ï¼Œç»“æœä¼šæ˜¯æ€æ ·ï¼ŸActiveRecordåŒ…å«äº†é’ˆå¯¹ä¸åŒæ•°æ®åº“çš„é€‚é…å™¨ã€‚å°½ç®¡PostgreSQLå’ŒMySQLéƒ½æ˜¯SQLæ•°æ®åº“ï¼Œä½†æ˜¯ä»–ä»¬ä¹‹é—´è¿˜æ˜¯æœ‰å¾ˆå¤šä¸åŒä¹‹å¤„ï¼Œè€ŒActiveRecordé€šè¿‡ä½¿ç”¨é€‚é…å™¨æ¨¡å¼å±è”½äº†è¿™äº›ä¸åŒã€‚(&lt;strong>æç¤º&lt;/strong>: å‘½ä»¤è¡Œä¸­è¾“å…¥&lt;code>qw activerecord&lt;/code>æŸ¥çœ‹ActiveRecordçš„ä»£ç )&lt;/p>
&lt;p>æ‰“å¼€ActiveRecordä»£ç åº“ä¸­çš„&lt;code>lib/connection_adapters&lt;/code>ç›®å½•ï¼Œé‡Œè¾¹ä¼šæœ‰é’ˆå¯¹PostgreSQL,MySQLä»¥åŠSQLiteçš„é€‚é…å™¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªåä¸º&lt;code>AbstractAdapter&lt;/code>çš„é€‚é…å™¨ï¼Œå®ƒä½œä¸ºæ¯ä¸€ä¸ªå…·ä½“çš„é€‚é…å™¨çš„åŸºç±»ã€‚&lt;code>AbstractAdapter&lt;/code>å®ç°äº†åœ¨å¤§éƒ¨åˆ†æ•°æ®åº“ä¸­å¸¸è§çš„åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½åœ¨å…¶å­ç±»æ¯”å¦‚&lt;code>PostgreSQLAdapter&lt;/code>ä»¥åŠ&lt;code>AbstractMysqlAdapter&lt;/code>ä¸­è¢«é‡æ–°å®šåˆ¶ï¼Œè€Œå…¶ä¸­&lt;code>AbstractMysqlAdapter&lt;/code>åˆ™æ˜¯å¦å¤–ä¸¤ä¸ªä¸åŒçš„MySQLé€‚é…å™¨â€”â€”MysqlAdapterä»¥åŠMysql2Adapterâ€”â€”çš„çˆ¶ç±»ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€äº›çœŸå®ä¸–ç•Œä¸­çš„ä¾‹å­æ¥çœ‹çœ‹ä»–ä»¬æ˜¯å¦‚ä½•ä¸€èµ·å·¥ä½œçš„ã€‚&lt;/p>
&lt;p>PostgreSQLå’ŒMySQLåœ¨SQLæ–¹è¨€çš„å®ç°ç¨æœ‰ä¸åŒã€‚æŸ¥è¯¢è¯­å¥&lt;code>SELECT * FROM users&lt;/code>åœ¨è¿™ä¸¤ä¸ªæ•°æ®åº“éƒ½å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œä½†æ˜¯å®ƒä»¬åœ¨ä¸€äº›ç±»å‹çš„å¤„ç†ä¸Šä¼šç¨æ˜¾ä¸åŒã€‚åœ¨MySQLå’ŒPostgreSQLä¸­ï¼Œæ—¶é—´æ ¼å¼å°±ä¸å°½ç›¸åŒã€‚å…¶ä¸­ï¼ŒPostgreSQLæ”¯æŒå¾®ç§’çº§åˆ«çš„æ—¶é—´ï¼Œè€ŒMySQLåªæ˜¯åˆ°äº†æœ€è¿‘çš„ä¸€ä¸ªç¨³å®šå‘å¸ƒçš„ç‰ˆæœ¬ä¸­æ‰æ”¯æŒã€‚é‚£è¿™ä¸¤ä¸ªé€‚é…å™¨åˆæ˜¯å¦‚ä½•å¤„ç†è¿™ç§å·®å¼‚çš„å‘¢ï¼Ÿ&lt;/p>
&lt;p>ActiveRecordé€šè¿‡è¢«æ··å…¥åˆ°&lt;code>AbstractAdapter&lt;/code>çš„&lt;code>ActiveRecord::ConnectionAdapters::Quoting&lt;/code>ä¸­çš„&lt;code>quoted_date&lt;/code>å¼•ç”¨æ—¥æœŸã€‚è€Œ&lt;code>AbstractAdapter&lt;/code>ä¸­çš„å®ç°ä»…ä»…åªæ˜¯æ ¼å¼åŒ–äº†æ—¥æœŸï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> quoted_date(value)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> value.to_s(&lt;span style="font-style:italic">:db&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Railsä¸­çš„ActiveSupportæ‰©å±•äº†&lt;code>Time#to_s&lt;/code>ï¼Œä½¿å…¶èƒ½å¤Ÿæ¥æ”¶ä¸€ä¸ªä»£è¡¨æ ¼å¼åçš„ç¬¦å·ç±»å‹å‚æ•°ã€‚&lt;code>:db&lt;/code>æ‰€ä»£è¡¨çš„æ ¼å¼å°±æ˜¯&lt;code>%Y-%m-%d %H:%M:%S&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Examples of common formats:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Time.now.to_s(&lt;span style="font-style:italic">:db&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;2014-02-19 06:08:13&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Time.now.to_s(&lt;span style="font-style:italic">:short&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;19 Feb 06:08&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Time.now.to_s(&lt;span style="font-style:italic">:rfc822&lt;/span>) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;Wed, 19 Feb 2014 06:08:13 +0000&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>MySQLçš„é€‚é…å™¨éƒ½æ²¡æœ‰é‡å†™&lt;code>quoted_date&lt;/code>æ–¹æ³•ï¼Œå®ƒä»¬è‡ªç„¶ä¼šç»§æ‰¿è¿™ç§è¡Œä¸ºã€‚å¦ä¸€è¾¹ï¼Œ&lt;code>PostgreSQLAdapter&lt;/code>åˆ™å¯¹æ—¥æœŸçš„å¤„ç†åšäº†ä¸¤ä¸ªä¿®æ”¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> quoted_date(value)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = &lt;span style="font-weight:bold">super&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> value.acts_like?(&lt;span style="font-style:italic">:time&lt;/span>) &amp;amp;&amp;amp; value.respond_to?(&lt;span style="font-style:italic">:usec&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = &lt;span style="font-style:italic">&amp;#34;&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>result&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">.&lt;/span>&lt;span style="font-weight:bold;font-style:italic">#{&lt;/span>sprintf(&lt;span style="font-style:italic">&amp;#34;%06d&amp;#34;&lt;/span>, value.usec)&lt;span style="font-weight:bold;font-style:italic">}&lt;/span>&lt;span style="font-style:italic">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">if&lt;/span> value.year &amp;lt; 0
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result = result.sub(&lt;span style="font-style:italic">/^-/&lt;/span>, &lt;span style="font-style:italic">&amp;#34;&amp;#34;&lt;/span>) + &lt;span style="font-style:italic">&amp;#34; BC&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> result
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®ƒåœ¨ä¸€å¼€å§‹ä¾¿è°ƒç”¨&lt;code>super&lt;/code>æ–¹æ³•ï¼Œæ‰€ä»¥å®ƒä¹Ÿä¼šå¾—åˆ°ä¸€ä¸ªç±»ä¼¼MySQLä¸­æ ¼å¼åŒ–åçš„æ—¥æœŸã€‚æ¥ä¸‹æ¥ï¼Œå®ƒæ£€æµ‹&lt;code>value&lt;/code>æ˜¯å¦åƒæ˜¯ä¸€ä¸ªå…·ä½“æ—¶é—´ã€‚è¿™æ˜¯ä¸€ä¸ªActiveSupportä¸­æ‰©å±•çš„æ–¹æ³•ï¼Œå½“ä¸€ä¸ªå¯¹è±¡ç±»ä¼¼&lt;code>Time&lt;/code>ç±»å‹çš„å®ä¾‹æ—¶ï¼Œå®ƒä¼šè¿”å›&lt;code>true&lt;/code>ã€‚è¿™è®©å®ƒæ›´å®¹æ˜“è¡¨æ˜å„ç§å¯¹è±¡å·²è¢«å‡è®¾ä¸ºç±»ä¼¼&lt;code>Time&lt;/code>çš„å¯¹è±¡ã€‚ï¼ˆ&lt;strong>æç¤º&lt;/strong>: å¯¹&lt;code>acts_like?&lt;/code>æ–¹æ³•æ„Ÿå…´è¶£ï¼Ÿè¯·åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ&lt;code>qw activesupport&lt;/code>ï¼Œç„¶åé˜…è¯»&lt;code>core_ext/object/acts_like.rb&lt;/code>ï¼‰&lt;/p>
&lt;p>ç¬¬äºŒéƒ¨åˆ†çš„æ¡ä»¶æ£€æŸ¥&lt;code>value&lt;/code>æ˜¯å¦æœ‰ç”¨äºè¿”å›æ¯«ç§’çš„&lt;code>usec&lt;/code>æ–¹æ³•ã€‚å¦‚æœå¯ä»¥æ±‚å¾—æ¯«ç§’æ•°ï¼Œé‚£ä¹ˆå®ƒå°†é€šè¿‡&lt;code>sprintf&lt;/code>æ–¹æ³•è¢«è¿½åŠ åˆ°&lt;code>result&lt;/code>å­—ç¬¦ä¸²çš„æœ«å°¾ã€‚è·Ÿå¾ˆå¤šæ—¶é—´æ ¼å¼ä¸€æ ·ï¼Œ&lt;code>sprintf&lt;/code>ä¹Ÿæœ‰å¾ˆå¤šä¸åŒçš„æ–¹å¼ç”¨äºæ ¼å¼åŒ–æ•°å­—ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>sprintf(&lt;span style="font-style:italic">&amp;#34;%06d&amp;#34;&lt;/span>, 32) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;000032&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sprintf(&lt;span style="font-style:italic">&amp;#34;%6d&amp;#34;&lt;/span>, 32) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34; 32&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sprintf(&lt;span style="font-style:italic">&amp;#34;%d&amp;#34;&lt;/span>, 32) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;32&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>sprintf(&lt;span style="font-style:italic">&amp;#34;%.2f&amp;#34;&lt;/span>, 32) &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;32.00&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æœ€åï¼Œå‡å¦‚æ—¥æœŸæ˜¯ä¸€ä¸ªè´Ÿæ•°ï¼Œ&lt;code>PostgreSQLAdapter&lt;/code>å°±ä¼šé€šè¿‡åŠ ä¸Š&amp;quot;BC&amp;quot;å»é‡æ–°æ ¼å¼åŒ–æ—¥æœŸï¼Œè¿™æ˜¯PostgreSQLæ•°æ®åº“çš„å®é™…è¦æ±‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>SELECT &lt;span style="font-style:italic">&amp;#39;2000-01-20&amp;#39;&lt;/span>::timestamp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-- 2000-01-20 00:00:00
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SELECT &lt;span style="font-style:italic">&amp;#39;2000-01-20 BC&amp;#39;&lt;/span>::timestamp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-- 2000-01-20 00:00:00 BC
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>SELECT &lt;span style="font-style:italic">&amp;#39;-2000-01-20&amp;#39;&lt;/span>::timestamp;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>-- &lt;span style="font-style:italic">ERROR&lt;/span>: time zone displacement out of &lt;span style="font-style:italic">range&lt;/span>: &lt;span style="font-style:italic">&amp;#34;-2000-01-20&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™åªæ˜¯ActiveRecordé€‚é…å¤šä¸ªAPIæ—¶çš„ä¸€ä¸ªæå°çš„æ–¹å¼ï¼Œä½†å®ƒå´èƒ½å¸®åŠ©ä½ å…é™¤ç”±äºä¸åŒæ•°æ®åº“çš„ç»†èŠ‚æ‰€å¸¦æ¥çš„å·®å¼‚å’Œçƒ¦æ¼ã€‚&lt;/p>
&lt;p>å¦ä¸€ä¸ªä½“ç°SQLæ•°æ®åº“çš„ä¸åŒç‚¹æ˜¯æ•°æ®åº“è¡¨è¢«åˆ›å»ºçš„æ–¹å¼ã€‚MySQLä»¥åŠPostgreSQLä¸­å¯¹ä¸»é”®çš„å¤„ç†å„ä¸ç›¸åŒï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># AbstractMysqlAdapter&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NATIVE_DATABASE_TYPES = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">:primary_key&lt;/span> =&amp;gt; &lt;span style="font-style:italic">&amp;#34;int(11) DEFAULT NULL auto_increment PRIMARY KEY&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># PostgreSQLAdapter&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>NATIVE_DATABASE_TYPES = {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">primary_key&lt;/span>: &lt;span style="font-style:italic">&amp;#34;serial primary key&amp;#34;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¸¤ç§é€‚é…å™¨éƒ½èƒ½å¤Ÿæ˜ç™½ActiveRecordä¸­çš„ä¸»é”®çš„è¡¨ç¤ºæ–¹å¼ï¼Œä½†æ˜¯å®ƒä»¬ä¼šåœ¨åˆ›å»ºæ–°è¡¨çš„æ—¶å€™å°†æ­¤ç¿»è¯‘ä¸ºä¸åŒçš„SQLè¯­å¥ã€‚å½“ä½ ä¸‹æ¬¡åœ¨ç¼–å†™ä¸€ä¸ªmigrationæˆ–è€…æ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢çš„æ—¶å€™ï¼Œæ€è€ƒä¸€ä¸‹ActiveRecordçš„é€‚é…å™¨ä»¥åŠå®ƒä»¬ä¸ºä½ åšçš„æ‰€æœ‰å¾®å°çš„äº‹æƒ…ã€‚&lt;/p>
&lt;h3 id="datetimeå’Œtime">DateTimeå’ŒTime&lt;/h3>
&lt;p>å½“MultiJsonä»¥åŠActiveRecordå®ç°äº†ä¼ ç»Ÿçš„é€‚é…å™¨çš„æ—¶å€™ï¼ŒRubyçš„çµæ´»æ€§ä½¿å¾—å¦ä¸€ç§è§£å†³æ–¹æ¡ˆæˆä¸ºå¯èƒ½ã€‚&lt;code>DateTime&lt;/code>ä»¥åŠ&lt;code>Time&lt;/code>éƒ½ç”¨äºè¡¨ç¤ºæ—¶é—´ï¼Œä½†æ˜¯å®ƒä»¬åœ¨å†…éƒ¨çš„å¤„ç†ä¸Šæ˜¯ä¸åŒçš„ã€‚è™½ç„¶æœ‰ç€è¿™äº›ç»†å¾®çš„å·®å¼‚ï¼Œä½†æ˜¯å®ƒä»¬æ‰€æš´éœ²å‡ºæ¥çš„APIå´æ˜¯æå…¶ç±»ä¼¼çš„ï¼ˆ&lt;strong>æç¤º&lt;/strong>ï¼šå‘½ä»¤è¡Œä¸­æ‰§è¡Œ&lt;code>qw activesupport&lt;/code>æŸ¥çœ‹æ­¤å¤„ç›¸å…³ä»£ç ï¼‰ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>t = Time.now
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>t.day &lt;span style="font-style:italic">#=&amp;gt; 19 (Day of month)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>t.wday &lt;span style="font-style:italic">#=&amp;gt; 3 (Day of week)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>t.usec &lt;span style="font-style:italic">#=&amp;gt; 371552 (Microseconds)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>t.to_i &lt;span style="font-style:italic">#=&amp;gt; 1392871392 (Epoch secconds)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>d = DateTime.now
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>d.day &lt;span style="font-style:italic">#=&amp;gt; 19 (Day of month)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>d.wday &lt;span style="font-style:italic">#=&amp;gt; 3 (Day of week)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>d.usec &lt;span style="font-style:italic">#=&amp;gt; NoMethodError: undefined method `usec&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>d.to_i &lt;span style="font-style:italic">#=&amp;gt; NoMethodError: undefined method `to_i&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ActiveSupporté€šè¿‡æ·»åŠ ç¼ºå¤±çš„æ–¹æ³•æ¥ç›´æ¥ä¿®æ”¹&lt;code>DateTime&lt;/code>å’Œ&lt;code>Time&lt;/code>ï¼Œè¿›è€ŒæŠ¹å¹³äº†ä¸¤è€…ä¹‹é—´çš„å·®å¼‚ã€‚ä»å®ä¾‹ä¸Šçœ‹ï¼Œè¿™é‡Œå°±æœ‰ä¸€ä¸ªä¾‹å­æ¼”ç¤ºäº†ActiveSupportå¦‚ä½•å®šä¹‰&lt;code>DateTime#to_i&lt;/code>ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">DateTime&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> to_i
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> seconds_since_unix_epoch.to_i
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> seconds_since_unix_epoch
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (jd - 2440588) * 86400 - offset_in_seconds + seconds_since_midnight
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> offset_in_seconds
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> (offset * 86400).to_i
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> seconds_since_midnight
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sec + (min * 60) + (hour * 3600)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¯ä¸€ä¸ªç”¨äºæ”¯æŒçš„æ–¹æ³•ï¼Œ&lt;code>seconds_since_unix_epoch&lt;/code>ï¼Œ&lt;code>offset_in_seconds&lt;/code>ï¼Œä»¥åŠ&lt;code>seconds_since_midnight&lt;/code>éƒ½ä½¿ç”¨æˆ–è€…æ‰©å±•äº†&lt;code>DateTime&lt;/code>ä¸­å·²ç»å­˜åœ¨çš„APIå»å®šä¹‰ä¸&lt;code>Time&lt;/code>ä¸­åŒ¹é…çš„æ–¹æ³•ã€‚&lt;/p>
&lt;p>å‡å¦‚è¯´æˆ‘ä»¬å‰é¢æ‰€çœ‹åˆ°çš„é€‚é…å™¨æ˜¯ç›¸å¯¹äºè¢«é€‚é…å¯¹è±¡çš„å¤–éƒ¨é€‚é…å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç°åœ¨æ‰€çœ‹åˆ°çš„è¿™ä¸ªå°±å¯ä»¥è¢«ç§°ä¹‹ä¸ºå†…éƒ¨é€‚é…å™¨ã€‚ä¸å¤–éƒ¨é€‚é…å™¨ä¸åŒçš„æ˜¯ï¼Œè¿™ç§æ–¹æ³•å—é™äºå·²æœ‰çš„APIï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´ä¸€äº›éº»çƒ¦çš„çŸ›ç›¾é—®é¢˜ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ&lt;code>DateTime&lt;/code>å’Œ&lt;code>Time&lt;/code>åœ¨ä¸€äº›ç‰¹æ®Šçš„åœºæ™¯ä¸‹å°±æœ‰å¯èƒ½å‡ºç°ä¸ä¸€æ ·çš„è¡Œä¸ºï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>datetime == time &lt;span style="font-style:italic">#=&amp;gt; true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>datetime + 1 &lt;span style="font-style:italic">#=&amp;gt; 2014-02-26 07:32:39&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>time + 1 &lt;span style="font-style:italic">#=&amp;gt; 2014-02-25 07:32:40&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“åŠ ä¸Š1çš„æ—¶å€™ï¼Œ&lt;code>DateTime&lt;/code>åŠ ä¸Šäº†ä¸€å¤©ï¼Œè€Œ&lt;code>Time&lt;/code>åˆ™æ˜¯åŠ ä¸Šäº†ä¸€ç§’ã€‚å½“ä½ éœ€è¦ä½¿ç”¨å®ƒä»¬çš„æ—¶å€™ï¼Œä½ è¦è®°ä½ActiveSupportåŸºäºè¿™äº›ä¸åŒï¼Œæä¾›äº†è¯¸å¦‚&lt;code>change&lt;/code>å’Œ&lt;code>Duration&lt;/code>ç­‰ä¿è¯ä¸€è‡´è¡Œä¸ºçš„æ–¹æ³•æˆ–ç±»ã€‚&lt;/p>
&lt;p>è¿™æ˜¯ä¸€ä¸ªå¥½çš„æ¨¡å¼å—ï¼Ÿå®ƒç†æ‰€å½“ç„¶æ˜¯æ–¹ä¾¿çš„ï¼Œä½†æ˜¯å¦‚ä½ åˆšæ‰æ‰€è§ï¼Œä½ ä»æ—§éœ€è¦æ³¨æ„å…¶ä¸­çš„ä¸€äº›ä¸åŒä¹‹å¤„ã€‚&lt;/p>
&lt;h3 id="æ€»ç»“">æ€»ç»“&lt;/h3>
&lt;p>è®¾è®¡æ¨¡å¼ä¸æ˜¯åªæœ‰Javaæ‰éœ€è¦çš„ã€‚Railsé€šè¿‡ä½¿ç”¨è®¾è®¡æ¨¡å¼ä»¥æä¾›ç”¨äºJSONè§£æä»¥åŠæ•°æ®åº“ç»´æŠ¤çš„ç»Ÿä¸€æ¥å£ã€‚ç”±äºRubyçš„çµæ´»æ€§ï¼Œç±»ä¼¼&lt;code>DateTime&lt;/code>ä»¥åŠ&lt;code>Time&lt;/code>è¿™æ ·çš„ç±»å¯ä»¥è¢«ç›´æ¥åœ°ä¿®æ”¹è€Œæä¾›ç›¸ä¼¼çš„æ¥å£ã€‚Railsçš„æºç å°±æ˜¯ä¸€ä¸ªå¯ä»¥è®©ä½ æŒ–æ˜çœŸå®ä¸–ç•Œä¸­ä¸åŒè®¾è®¡æ¨¡å¼å®ä¾‹çš„å¤©å ‚ã€‚&lt;/p>
&lt;p>åœ¨è¿™æ¬¡çš„å®è·µä¸­ï¼Œæˆ‘ä»¬åŒæ—¶ä¹Ÿå‘æ˜äº†ä¸€äº›æœ‰è¶£çš„ä»£ç ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;code>hash[:foo] = hash.delete(:bar)&lt;/code>æ˜¯ä¸€ä¸ªç”¨äºé‡å‘½åå“ˆå¸Œè¡¨ä¸­æŸä¸€é¡¹çš„å·§å¦™æ–¹æ³•ã€‚&lt;/li>
&lt;li>è°ƒç”¨&lt;code>::ClassName&lt;/code>ä¼šè°ƒç”¨é¡¶å±‚çš„ç±»ã€‚&lt;/li>
&lt;li>ActiveSupportä¸º&lt;code>Time&lt;/code>ã€&lt;code>Date&lt;/code>ä»¥åŠå…¶ä»–çš„ç±»æ·»åŠ äº†ä¸€ä¸ªå¯é€‰çš„ä»£è¡¨æ ¼å¼çš„å‚æ•°&lt;code>format&lt;/code>ã€‚&lt;/li>
&lt;li>&lt;code>sprintf&lt;/code>å¯ä»¥ç”¨äºæ ¼å¼åŒ–æ•°å­—ã€‚&lt;/li>
&lt;/ul>
&lt;p>æƒ³è¦æ¢ç´¢æ›´å¤šçš„çŸ¥è¯†ï¼Ÿå›å»çœ‹çœ‹MultiJsonæ˜¯å¦‚ä½•å¤„ç†ä»¥åŠè§£ææ ¼å¼çš„ã€‚ä»”ç»†é˜…è¯»ä½ åœ¨ä½ çš„æ•°æ®åº“ä¸­æ‰€ä½¿ç”¨åˆ°çš„ActiveRecordçš„é€‚é…å™¨çš„ä»£ç ã€‚æµè§ˆActiveSupportä¸­ç”¨äºxmlé€‚é…å™¨çš„&lt;code>XmlMini&lt;/code>ï¼Œå®ƒè·ŸMultiJsonä¸­çš„JSONé€‚é…å™¨æ˜¯ç±»ä¼¼çš„ã€‚åœ¨è¿™äº›é‡Œé¢è¿˜ä¼šæœ‰å¾ˆå¤šå¯ä»¥å­¦ä¹ çš„ã€‚&lt;/p>
&lt;p>å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Ÿ&lt;!-- raw HTML omitted -->
&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/02/jie-du-rails-xi-lie-fan-yi/">é˜…è¯»æ›´å¤š&lt;/a>â€œè§£è¯»Railsâ€ä¸­çš„æ–‡ç« ã€‚&lt;/p></description></item><item><title>è§£è¯»Rails(ç³»åˆ—ç¿»è¯‘)</title><link>https://blog.hackerpie.com/posts/archive/jie-du-rails-xi-lie-fan-yi/</link><pubDate>Sun, 02 Mar 2014 13:40:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/jie-du-rails-xi-lie-fan-yi/</guid><description>&lt;p>è§£è¯»Railsç³»åˆ—æ–‡ç« åŸæ–‡æ¥è‡ª&lt;a href="http://monkeyandcrow.com/series/reading_rails/">Reading Rails&lt;/a>ï¼Œæˆ‘å°†å°½æˆ‘æ‰€èƒ½å®Œæˆæ­¤ç³»åˆ—æ‰€æœ‰æ–‡ç« çš„ç¿»è¯‘ã€‚ä»¥ä¸‹éƒ¨åˆ†ä¸ºåŸæ–‡ç³»åˆ—å¯¹åº”ç¿»è¯‘ï¼š&lt;/p>
&lt;p>åœ¨æˆ‘ä»¬çš„å·¥ä½œä¸­ï¼Œæˆ‘ä»¬çš„å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯åœ¨ä½¿ç”¨å„ç§å„æ ·çš„å·¥å…·ï¼Œä½†æ˜¯ä½ çŸ¥ä¸çŸ¥é“å®ƒä»¬æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿ&lt;/p>
&lt;p>åœ¨è¿™ä¸ªç³»åˆ—é‡Œï¼Œæˆ‘ä»¬é€šè¿‡é˜…è¯»&lt;a href="http://rubyonrails.org/">Ruby on Rails&lt;/a>çš„æºç å»æ¢ç´¢å…¶å†…éƒ¨çš„å·¥ä½œæœºåˆ¶ã€‚æˆ‘ä»¬å°†ä¸ä»…ä»…åªæ˜¯å­¦åˆ°ä¸Railsæœ‰å…³çš„çŸ¥è¯†ï¼Œæˆ‘ä»¬ä¹Ÿå°†è§è¯†åˆ°Rubyé‡Œè¾¹ä¸€äº›æœ‰è¶£çš„åŠŸèƒ½ï¼Œä»¥åŠä¸€äº›æœ‰ç”¨çš„æ–°æŠ€å·§ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/03/jie-du-rails-gua-pei-qi-mo-shi/">è§£è¯»Rails - é€‚é…å™¨æ¨¡å¼&lt;/a>&lt;/li>
&lt;li>&lt;a href="">è§£è¯»Rails - é”™è¯¯å’ŒéªŒè¯å™¨&lt;/a>&lt;/li>
&lt;li>&lt;a href="">è§£è¯»Rails - éªŒè¯æœºåˆ¶æ˜¯å¦‚ä½•é…ç½®çš„&lt;/a>&lt;/li>
&lt;li>&lt;a href="">è§£è¯»Rails - Concern&lt;/a>&lt;/li>
&lt;li>&lt;a href="">è§£è¯»Rails - æ›´å¤šçš„Migrations&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.hackerpie.com/blog/articles/2017/10/14/jie-du-rails-migrations/">è§£è¯»Rails - Migrations&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/12/shu-xing-fang-fa/">è§£è¯»Rails - å±æ€§æ–¹æ³•(Attribute Methods)&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/07/zhui-zong-bian-geng/">è§£è¯»Rails - è·Ÿè¸ªmodelä¸­å±æ€§ï¼ˆå€¼ï¼‰çš„å˜æ›´&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://blog.hackerpie.com/blog/articles/2014/03/05/jie-du-rails-chu-li-yi-chang/">è§£è¯»Rails - å¤„ç†å¼‚å¸¸&lt;/a>&lt;/li>
&lt;/ul></description></item><item><title>åœ¨Rubyä¸­ä½¿ç”¨WebSocket</title><link>https://blog.hackerpie.com/posts/archive/zai-rubyzhong-shi-yong-websocket/</link><pubDate>Sat, 01 Mar 2014 21:31:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/zai-rubyzhong-shi-yong-websocket/</guid><description>&lt;p>&lt;strong>å£°æ˜&lt;/strong>: æ­¤æ–‡ç¿»è¯‘è‡ª&lt;a href="http://www.troikatech.com/blog/2014/02/26/websocket-webmachine/?utm_source=rubyweekly&amp;amp;utm_medium=email">WebSockets in Ruby&lt;/a>ï¼Œ é™äºæœ¬äººæ‰ç–å­¦æµ…ï¼Œå…¶ä¸­æœ‰ç¿»è¯‘ä¸å½“ä¹‹å¤„ï¼Œæ•¬è¯·æŒ‡å‡ºï¼Œæ„Ÿæ¿€ä¸å°½ï¼&lt;/p>
&lt;p>åœ¨æˆ‘çš„ä¸»è¦å·¥ä½œä¸­ï¼Œéœ€è¦æ„å»ºä¸€ä¸ªä¸€ç›´å ç”¨ç›¸å½“å¤§CPUæ—¶é—´ç‰‡çš„æ•°æ®ç³»ç»Ÿã€‚è¿™ä¸ªä»»åŠ¡ä¸»è¦ç”¨äºåœ¨åœ°ç†ç¼–ç ä»¥åŠlocal reference system(æœ¬åœ°åœ°ç†ç³»ç»Ÿï¼Ÿ)ä¹‹é—´è¿›è¡Œç¼–ç ä»¥åŠè§£ç ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œè¿™ä¸ªå·¥ä½œå°†å¸®åŠ©æˆ‘ä»¬åœ¨ç³»ç»Ÿä¸­æ ‡è®°ä¸€æ¡å¯¹åº”äºè¡—é“ä¸ŠæŸä¸ªåœ°ç‚¹çš„è®°å½•ï¼Œå¹¶ä¸”å¯ä»¥çŸ¥é“æœ¬åœ°åœ°ç†ä½ç½®æ‰€å¯¹åº”çš„åæ ‡ã€‚&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>åœ¨ç¬¬ä¸€æ¬¡çš„å°è¯•ä¸­ï¼Œæˆ‘å¼€å‘äº†ä¸€ä¸ªç”¨äºåœ°ç†ç¼–ç çš„Rubyåº“ä»¥åŠä¸€ä¸ªç®€å•çš„åŸºäºSinatraçš„webæœåŠ¡ã€‚å½“æ—¶æˆ‘çš„è§£å†³æ–¹æ¡ˆè¡¨ç°å¾—è¿˜ä¸é”™ï¼Œç›´åˆ°åæ¥å®¢æˆ·è¦æ±‚å¯¹æ¯ä¸€ä¸ªé¼ æ ‡æ»‘è¿‡çš„äº‹ä»¶è¿›è¡Œäº¤äº’ã€‚è¿™ä¸ªéœ€æ±‚ä¸Šçš„æ›´æ”¹è®©æˆ‘ä¸å¾—ä¸å†ä¸€æ¬¡é€šè¿‡Javascriptè¯­è¨€å»æ„å»ºä¸€ä¸ªåŒæ ·ç”¨äºåœ°ç†ç¼–ç çš„åŸºç¡€æ„ä»¶ï¼Œåœ¨ä¹‹åçš„ä¸€æ®µæ—¶é—´é‡Œï¼Œä¸€åˆ‡ä¹Ÿéƒ½è¡¨ç°å¾—éå¸¸å¥½ã€‚&lt;/p>
&lt;p>è€Œæ„æ–™ä¹‹ä¸­çš„æ˜¯ï¼Œæˆ‘ä»¬å†ä¸€æ¬¡å†³å®šåœ¨ç³»ç»Ÿä¸­å…è®¸æ¯ä¸ªç”¨æˆ·ä¸å¤šä¸ªè¡—é“å…³è”ã€‚ç°åœ¨ï¼Œæ¯æ¬¡ä¸‹è½½800KBçš„æ•°æ®ï¼ˆå­˜å‚¨åœ¨ç´¢å¼•æ•°æ®åº“ä¸­ï¼Œç”¨äºè®°å½•æœ€æ–°çš„ä¼šè¯ä¿¡æ¯ï¼‰å°šä¸”å¯ä»¥æ‰¿å—ï¼›ä½†æ˜¯æ½œåœ¨ä¸Šæ¥è¯´ï¼Œå‡ ä¸ªMBçš„æ•°æ®å°†æ˜¯è‡´å‘½çš„ï¼Œç”šè‡³è½¯ä»¶ä¹Ÿæœ‰å¯èƒ½åœ¨ä¼šè¯çš„å“åº”ä¹‹å‰è¢«ä½¿ç”¨-è€Œè¿™åªæ˜¯ç”¨æˆ·æ‰€æœŸå¾…çš„åŠŸèƒ½ä¹‹ä¸€ã€‚&lt;/p>
&lt;p>æˆ‘çŸ¥é“æˆ‘ä»¬å¿…é¡»å¯»æ‰¾ä¸€ä¸ªå®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”ä½¿ä¸€åˆ‡éƒ½æ˜¯å¯ä»¥ç®¡ç†æ§åˆ¶çš„ã€‚åœ¨ä»¥å‰ï¼Œæˆ‘æ¶‰è¶³è¿‡WebSocketé¢†åŸŸï¼ˆæ¯”å¦‚node.jsä»¥åŠSocket.IOï¼‰å¹¶ä¸”çŸ¥é“ç›¸å…³çš„åº•å±‚çŸ¥è¯†ã€‚ä»ä¹‹å‰çš„æœç´¢ä¸­ï¼Œæˆ‘æ„è¯†åˆ°Rubyåœ¨è¿™æ–¹é¢çš„æ¬ ç¼ºï¼Œæˆ‘å¾ˆå¿«åˆè€ƒè™‘é€šè¿‡åœ¨èŠ‚ç‚¹ä¸Šçš„Javascriptç«¯å£æ¥å®ç°éœ€æ±‚ã€‚è¿™æ ·çš„æƒ³æ³•ä½¿æˆ‘éå¸¸æ¿€åŠ¨ã€‚&lt;/p>
&lt;h2 id="å¯é€‰æ–¹æ¡ˆ">å¯é€‰æ–¹æ¡ˆ&lt;/h2>
&lt;p>ç¬¬ä¸€æ­¥æ˜¯æ‰¾å‡ºå¯ç”¨çš„æ–¹æ¡ˆã€‚ä»¥ä¸‹åˆ—ä¸¾æˆ‘æ‰¾åˆ°çš„ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://github.com/simulacre/sinatra-websocket">sinatra-websocket&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/faye/faye-websocket-ruby">faye-websocket&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/websocket-rails/websocket-rails">websocket-rails&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/ngauthier/tubesock">tubesock&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://github.com/seancribbs/webmachine-ruby">webmachine-ruby&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>åœ¨ä¸Šè¿°äº”ç§æ–¹æ¡ˆä¸­ï¼Œå‰ä¸‰ç§æ–¹æ¡ˆéƒ½æ˜¯åŸºäºäº‹ä»¶æœºåˆ¶çš„ï¼Œè€Œ&lt;code>tubesock&lt;/code>ä½¿ç”¨äº†rake hijackingæŠ€æœ¯ï¼Œ&lt;code>webmachine-ruby&lt;/code>é€šè¿‡åŸºäº&lt;code>Celluloid::IO&lt;/code>çš„HTTPæœåŠ¡å™¨Reelæä¾›WebSocketsã€‚&lt;/p>
&lt;p>é¦–å…ˆï¼Œè€ƒè™‘åˆ°æˆ‘å·²ç»ä½¿ç”¨äº†Sinatraï¼Œäºæ˜¯æˆ‘è¯•ç”¨äº†&lt;code>sinatra-websocket&lt;/code>ã€‚ä½†æ˜¯å› ä¸ºéƒ¨åˆ†åŸå› ï¼Œæˆ‘æ— æ³•å°†è¿æ¥æ–¹å¼è¿ç§»åˆ°WebSocketï¼Œæ‰€ä»¥æˆ‘å†³å®šå¿«é€Ÿè·³è¿‡ã€‚è€Œä¸”å¦ç™½è¯´çš„è¯ï¼Œæˆ‘è¿˜ç›´æ¥è·³è¿‡äº†&lt;code>faye-websocket&lt;/code>ã€‚&lt;/p>
&lt;p>æ¥ä¸‹æ¥çš„ä¸¤ä¸ªå¤‡é€‰æ–¹æ¡ˆé‡åˆ°äº†åŒæ ·çš„é—®é¢˜ï¼šåœ¨ä¸€ä¸ªé…ç½®è¾ƒä½çš„Herokuçš„ç«™ç‚¹ä¸Šå¯åŠ¨Railså¹¶ä¸”åŠ è½½äº†æ•´ä¸ªç³»ç»Ÿä¹‹åï¼Œå‰©ä¸‹çš„å†…å­˜åªå¤Ÿå‡ åä¸ªå®¢æˆ·ç«¯åŒæ—¶ä½¿ç”¨çš„äº†ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒRailsçš„å¯åŠ¨æ—¶é—´åŠ ä¸Šå…¶ä»–ç”¨äºæ„å»ºçš„æ—¶é—´å¶å°”ä¼šè®©Herokuè®¤ä¸ºç³»ç»Ÿä¸­å‡ºç°å¼‚å¸¸ï¼Œç»“æœå¯¼è‡´è¿›ç¨‹åœ¨æœåŠ¡æ­£å¸¸å¯åŠ¨ä¹‹å‰å°±å·²ç»è¢«å¼ºè¡Œé€€å‡ºäº†ã€‚&lt;/p>
&lt;p>å‡å¦‚ä½ æœ‰æ‰€ç•™æ„ï¼Œé‚£ä¹ˆä½ ä¹Ÿå°±çŸ¥é“äº†ï¼Œå‰©ä¸‹çš„å”¯ä¸€ä¸€ä¸ªæ–¹æ¡ˆï¼Œå°±æ˜¯&lt;code>webmachine-ruby&lt;/code>ã€‚&lt;/p>
&lt;h2 id="webmachine-ruby">webmachine-ruby&lt;/h2>
&lt;p>é…ç½®&lt;code>webmachine-ruby&lt;/code>çš„ç¯å¢ƒè¿˜æ˜¯ç›¸å¯¹å®¹æ˜“çš„ã€‚ä¸ºäº†é€æ­¥è¿›è¡Œï¼Œæˆ‘é¦–å…ˆæŠŠåŸæ¥åŸºäºHTTPçš„æœåŠ¡è¿ç§»åˆ°å®ƒçš„èµ„æºç»“æ„ã€‚æ¯”èµ·Railsä»¥åŠSinatraï¼Œå®ƒæ›´åŠ å…·æœ‰é¢å‘å¯¹è±¡çš„å‘³é“ã€‚å®ƒçš„åˆ†å‘å™¨æ˜¯æ˜“äºç†è§£çš„ï¼Œæˆ‘éå¸¸å–œæ¬¢é€šè¿‡&lt;a href="https://github.com/seancribbs/webmachine-ruby#visual-debugger">visual debugger&lt;/a>æ¥æ‘†ç©è¿™ä¸€åˆ‡ã€‚&lt;/p>
&lt;p>è¿ç§»åˆ°WebSocketä¸Šåï¼Œä¸€åˆ‡éƒ½å˜äº†ã€‚æˆ‘èƒ½å»ºè®®çš„ï¼ˆåŒ…æ‹¬æ–‡æ¡£ä¸­è¯´æ˜çš„ï¼‰å°±æ˜¯ï¼Œä½ å®Œå…¨å¯ä»¥è·³è¿‡å¸¸è§„çš„åŸºç¡€é…ç½®ï¼Œè½¬è€Œæä¾›ä¸€ä¸ªå¯è°ƒç”¨çš„é…ç½®é¡¹ï¼Œæ¯”å¦‚ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>App = Webmachine::Application &lt;span style="font-weight:bold">do&lt;/span> |app|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> app.configure &lt;span style="font-weight:bold">do&lt;/span> |config|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> config.adapter = &lt;span style="font-style:italic">:Reel&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> config.adapter_options[&lt;span style="font-style:italic">:websocket_handler&lt;/span>] = proc &lt;span style="font-weight:bold">do&lt;/span> |websocket|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> websocket &amp;lt;&amp;lt; &lt;span style="font-style:italic">&amp;#34;hello, world&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ˜¯ç›¸å½“å¤šçš„æ–‡æ¡£æ‰€æåˆ°çš„æ–¹æ³•ã€‚å› ä¸ºå®ƒåªæœŸæœ›handleræ”¯æŒ&lt;code>#call&lt;/code>æ–¹æ³•ï¼Œæ‰€ä»¥ä½ å¯ä»¥å†™ä¸€ä¸ªä½ è‡ªå·±çš„ad-hocåˆ†å‘å™¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">WebsocketHandler&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> call(websocket)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> message = websocket.read
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># do something with the message, call methods on other objects, log stuff, have your fun&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¾ˆå¤šæ–‡æ¡£å¹¶ä¸æåŠä¸€äº›å¥—æ¥å­—ç¼–ç¨‹çš„åŸºç¡€ã€‚å‡å¦‚ä½ å‘ç°ä½ çš„handlerè¢«æŒ‚èµ·å¹¶ä¸”ä¸å†å¤„ç†å“åº”ï¼Œè¿™æ„å‘³ç€ä½ éœ€è¦é‡æ–°ä¿®æ”¹ç¨‹åºï¼Œä½†æ˜¯ä¸éœ€è¦ä¸ºæ­¤æ„Ÿåˆ°çƒ¦æ¼ï¼šä½ åªéœ€è¦å®ç°ä¸€ä¸ªä¸æ–­ä»å¥—æ¥å­—ä¸­è¯»å–ä¿¡æ¯å¹¶ä¸”è®©&lt;code>Celluloid::IO&lt;/code>å®ç°å®ƒçš„éé˜»å¡é­”æœ¯æ–¹æ³•çš„å¾ªç¯å°±è¡Œäº†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">class&lt;/span> &lt;span style="font-weight:bold">WebsocketHandler&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">def&lt;/span> call(websocket)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">loop&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> message = websocket.read
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># do something with the message, call methods on other objects, log stuff, have your fun&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºéé˜»å¡çš„ç‰¹ç‚¹ï¼Œä½ ä¸å†éœ€è¦æ‹…å¿ƒä½ çš„CPUå ç”¨ä¼šä¸€ç›´åœç•™åœ¨100%ã€‚ç„¶è€Œï¼Œä½ ä¼šå—åˆ°èŠ‚ç‚¹åœ¨CPUä½¿ç”¨ç‡ä»¥åŠäº‹ä»¶å¤„ç†æ–¹é¢åŒæ ·çš„é™åˆ¶ï¼ˆæ¯”å¦‚ï¼Œå‡å¦‚ä½ çš„ç¨‹åºæ˜¯CPUå¯†é›†å‹çš„ï¼Œå®ƒä¾¿ä¼šå½±å“è‡ªèº«çš„ååé‡ï¼‰ã€‚&lt;/p>
&lt;p>å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Rubyä¸­ä½¿ç”¨çº¿ç¨‹ã€‚æˆ‘å†³å®šé€šè¿‡ä¸ºæ¯ä¸€ä¸ªå®¢æˆ·ç«¯æŒ‡å®šä¸€ä¸ª&lt;code>Celluloid Actor&lt;/code>æ¥å¥½å¥½åˆ©ç”¨çº¿ç¨‹ã€‚è¿™ä¸ªåšæ³•å…è®¸æˆ‘å»æä¾›ä¸€äº›CPUå¯†é›†å‹çš„æ“ä½œè€Œä¸éœ€è¦å¦¥åäºç³»ç»Ÿä¸­çš„å…¶ä»–ç”¨æˆ·ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™ä¸ªæ–¹æ¡ˆè¡¨ç°å¾—ä¸é”™ã€‚&lt;/p>
&lt;h2 id="ç–æ¼çš„åœ°æ–¹">ç–æ¼çš„åœ°æ–¹&lt;/h2>
&lt;p>æˆ‘çš„è§£å†³æ–¹æ¡ˆæœ¬æ¥åº”è¯¥è€ƒè™‘éWebSocketçš„å®¢æˆ·ç«¯ï¼Œä½†äº‹å®ä¸Šæˆ‘å´æ²¡æœ‰åšåˆ°ã€‚&lt;code>webmachine-ruby&lt;/code>é€šè¿‡å…è®¸ä½ å®ç°æµå¼APIè€Œå°†æ­¤å˜å¾—ç®€å•ä¸”æ²¡æœ‰åé¡¾ä¹‹å¿§ã€‚æˆ‘æƒ³è¿™å°†åªéœ€è¦ä¸€äº›JSä»£ç å»åšç›¸äº’ä¹‹é—´çš„åé¦ˆå¹¶ä¸”æä¾›ä¸€ä¸ªæŒ‡å‘æ¥æ”¶è€…çš„è¿æ¥ã€‚&lt;/p>
&lt;p>è¿™ç¯‡æ–‡æ¡£å¹¶æœªæ¶µç›–æ‰€æœ‰å¯èƒ½åœ¨å¥—æ¥å­—è¿æ¥æ—¶å‡ºç°çš„äº‹ä»¶ï¼ˆonerror, on close, onopen, onmessageï¼‰ã€‚ä½ å¯ä»¥åœ¨è¿æ¥å¥—æ¥å­—çš„æ—¶å€™çœ‹åˆ°å®ƒä»¬ï¼Œå¹¶ä¸”æ¯ä¸€ä¸ªéƒ½å¸¦ç€ä¸€ä¸ªå—ã€‚&lt;/p>
&lt;p>è¿™ä¸ªå·¥å…·ä¹Ÿå¹¶ä¸æä¾›ä¸€ä¸ªæˆç†Ÿçš„ç»“åˆé¢‘é“ä»¥åŠä¿¡æ¯ä»£ç†çš„å‘å¸ƒ/è®¢é˜…ç³»ç»Ÿã€‚å¦‚æœä½ æ›´å¤šçš„æ˜¯éœ€è¦è¿™æ–¹é¢çš„å·¥å…·ï¼Œå…¶å®å¯ä»¥è€ƒè™‘ä½¿ç”¨&lt;code>faye&lt;/code>ä»¥åŠ&lt;code>websocket-rails&lt;/code>ã€‚&lt;/p></description></item><item><title>DIY an interesting timer through terminal-notifier and crontab under Mac OS X</title><link>https://blog.hackerpie.com/posts/archive/diy-an-interesting-timer-through-terminal-notifier-and-crontab-under-mac-os-x/</link><pubDate>Sun, 12 Jan 2014 15:51:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/diy-an-interesting-timer-through-terminal-notifier-and-crontab-under-mac-os-x/</guid><description>&lt;p>Today I will show you how to DIY an intersting notifier automatically running per hour under the Mac OS X 10.8 and higher, all we need are a terminal-notifier and the system built-in command line program named &lt;code>crontab&lt;/code>.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;h2 id="1-install-the-terminal-notifier">1. Install the terminal-notifier&lt;/h2>
&lt;p>&lt;code>terminal-notifier&lt;/code> is a program written in the awesome &lt;a href="https://www.ruby-lang.org/en/">Ruby&lt;/a> program language, we can visit &lt;a href="https://github.com/alloy/terminal-notifier/releases">the releases page&lt;/a> and download the newest version of terminal-notifier. Steps to install it:&lt;!-- raw HTML omitted -->&lt;/p>
&lt;ol>
&lt;li>Please click the green button such as &amp;ldquo;&lt;strong>terminal-notifier-1.5.0.zip&lt;/strong>&amp;rdquo; and select a path wherever you love to save the zip file;&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>After downloading completed, open the folder you selected in the above step, look for the zip file, and then double-click to extract the program;&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>Copy the extracted program &lt;strong>terminal-notifier&lt;/strong>;&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>Click the &amp;ldquo;Applications&amp;rdquo; tab in the sidebar of your finder, and then paste the copied file.&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>Lastly, open a terminal and then run the following command to test if the notifier has been installed successfully.&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>/Applications/terminal-notifier.app/Contents/MacOS/terminal-notifier -title &lt;span style="font-style:italic">&amp;#34;Test Installation&amp;#34;&lt;/span> -message &lt;span style="font-style:italic">&amp;#39;your notifier has been installed successfully!&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>You will see a notification message appears. If not, re-check your installation and make sure you have finished the above steps strictly.&lt;/p>
&lt;h2 id="2-create-the-timer-to-notice-you-to-have-a-break">2. Create the timer to notice you to have a break&lt;/h2>
&lt;p>In order to run the notifier periodically, we use &lt;code>crontab&lt;/code>, which maintains crontab files for individual users.&lt;/p>
&lt;p>Now, please open your terminal again, and then type the following command, run it:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>crontab -e
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Append the following line to the openning file:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>0 * * * * /Applications/terminal-notifier.app/Contents/MacOS/terminal-notifier -title &lt;span style="font-style:italic">&amp;#34;Guy, take a break please!&amp;#34;&lt;/span> -message &lt;span style="font-style:italic">&amp;#39;You have worked for a hour again, I suggest that you should take a break.&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Save the file and exit, your cron tasks will be updated automatically.&lt;/p>
&lt;p>After every thing is finished, you will reveive the attentive message per hour. Cheers!&lt;/p>
&lt;p>This post only acts like a demo, you can do more powerful works as you imagine.&lt;/p>
&lt;p>&lt;strong>Related Resources:&lt;/strong>&lt;!-- raw HTML omitted -->&lt;/p>
&lt;ol>
&lt;li>&lt;a href="https://github.com/alloy/terminal-notifier">terminal-notifier&lt;/a>&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>&lt;a href="http://www.pantz.org/software/cron/croninfo.html">crontab&lt;/a>&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>&lt;a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?crontab">crontab man page&lt;/a>&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>&lt;a href="http://www.thegeekstuff.com/2009/06/15-practical-crontab-examples">Linux Crontab: 15 Awesome Cron Job Examples&lt;/a>&lt;/li>
&lt;/ol></description></item><item><title>Split logs automatically every day</title><link>https://blog.hackerpie.com/posts/archive/split-logs-automatically-every-day/</link><pubDate>Sat, 07 Sep 2013 01:11:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/split-logs-automatically-every-day/</guid><description>&lt;p>&lt;strong>Related resource(s):&lt;/strong>&lt;/p>
&lt;p>&amp;ldquo;linuxcommand: logrotate&amp;rdquo;:http://linuxcommand.org/man_pages/logrotate8.html&lt;!-- raw HTML omitted -->
&lt;strong>logrotate&lt;/strong> is designed to ease administration of systems that generate large numbers of log files. Normally, logrotate is run as a daily cron job.&lt;/p>
&lt;p>&lt;strong>Some important knowledges:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>Any number of config files may be given. Later config files may override the options given in earlier files, so the order in which the logrotate config files are listed in is important. Normally, &lt;strong>a single config file which includes any other config files which are needed should be used&lt;/strong>. If a directory is given, every file in that directory is used as a config file.&lt;/li>
&lt;li>&lt;strong>Default config file:&lt;/strong> /etc/logrotate.conf. You can include other config files within it using &lt;strong>include&lt;/strong> directive.&lt;/li>
&lt;/ul>
&lt;!-- raw HTML omitted -->
&lt;h2 id="assumption">Assumption&lt;/h2>
&lt;ol>
&lt;li>Your site is &lt;code>example.com&lt;/code>&lt;/li>
&lt;li>The site is located in &lt;code>/var/www/example/&lt;/code>&lt;/li>
&lt;li>Your site is deployed by Capistrano, so you can find your logs in &lt;code>/var/www/example/shared/log/&lt;/code>&lt;/li>
&lt;li>Your static contents server is &lt;strong>Nginx&lt;/strong>, and its logs are located in &lt;code>/var/www/example/shared/log/&lt;/code> and their names start with &lt;code>nginx_&lt;/code>&lt;/li>
&lt;/ol>
&lt;h2 id="how-to-do">How to do&lt;/h2>
&lt;h3 id="1-login-your-server">1. Login your server&lt;/h3>
&lt;h3 id="2-make-sure-that-include-etclogrotated-is-existed-in-default-config-file-and-not-commented">2. Make sure that &amp;ldquo;include /etc/logrotate.d&amp;rdquo; is existed in default config file and not commented:&lt;/h3>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>You should be able to find the directive shown below, if not, append it manully.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;h3 id="3create-new-logrotate-config-files-for-your-sites-logs">3.Create new logrotate config files for your site&amp;rsquo;s logs&lt;/h3>
&lt;p>&lt;strong>A. Create new rotate config file for application log:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>Type following contents, and save.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>B. Create new rotate config file for server log:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>Type following contents, and save.&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>Attention:&lt;/strong>&lt;!-- raw HTML omitted -->
&lt;strong>/var/run/nginx.pid&lt;/strong> is your nginx pid file path, but someone may use default nginx pid path(&lt;strong>/opt/nginx/logs/nginx.pid&lt;/strong>). You have two solutions to solve this conflict:&lt;/p>
&lt;blockquote>
&lt;p>A. Change &lt;code>/var/run/nginx.pid&lt;/code> to &lt;code>/opt/nginx/logs/nginx.pid&lt;/code> or other path you have defined in your nginx config file.
B. Set your &lt;strong>&amp;ldquo;pid&amp;rdquo;&lt;/strong> directive to expected path:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;/blockquote>
&lt;p>pid /var/run/nginx.pid;
&lt;!-- raw HTML omitted -->&lt;/p>
&lt;blockquote>
&lt;p>in your nginx config file(such as, /opt/nginx/conf/nginx.conf), and then restart your server.&lt;/p>
&lt;/blockquote>
&lt;p>If the above work are all finished, everything done! You should remember to check if everything runs normally at other days.&lt;/p></description></item><item><title>Backup database and other attachments in ROR</title><link>https://blog.hackerpie.com/posts/archive/backup-database-and-other-attachments-in-ror/</link><pubDate>Sat, 07 Sep 2013 00:26:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/backup-database-and-other-attachments-in-ror/</guid><description>&lt;h2 id="related-resources">Related Resources&lt;/h2>
&lt;ol>
&lt;li>&lt;strong>rsync&lt;/strong>:http://rsync.samba.org/&lt;/li>
&lt;li>&lt;strong>Crontab&lt;/strong>:http://unixhelp.ed.ac.uk/CGI/man-cgi?crontab+5&lt;/li>
&lt;li>&lt;strong>&amp;ldquo;Linux Crontab å®šæ—¶ä»»åŠ¡ å‘½ä»¤è¯¦è§£&amp;rdquo;&lt;/strong>:http://blog.csdn.net/tianlesoftware/article/details/5315039&lt;/li>
&lt;li>&lt;strong>[rubygem]&amp;ldquo;backup&amp;rdquo;&lt;/strong>:https://github.com/meskyanichi/backup&lt;/li>
&lt;li>&lt;strong>[rubygem]&amp;ldquo;whenever&amp;rdquo;&lt;/strong>:https://github.com/javan/whenever&lt;/li>
&lt;/ol>
&lt;h2 id="automatically-backup-on-the-remote-server">Automatically backup on the remote server:&lt;/h2>
&lt;p>Let&amp;rsquo;s firstly assumpt:&lt;/p>
&lt;ol>
&lt;li>You have a site named &amp;ldquo;&lt;strong>example.com&lt;/strong>&amp;rdquo;;&lt;/li>
&lt;li>You can login to it through a username &amp;ldquo;&lt;strong>deploy&lt;/strong>&amp;rdquo;, and its password is &amp;ldquo;&lt;strong>password&lt;/strong>&amp;rdquo;;&lt;/li>
&lt;li>You located the contents of your site in &lt;code>/var/www/example/&lt;/code>;&lt;/li>
&lt;li>Your database server is &lt;strong>Mysql&lt;/strong>, and the database for your site is &lt;strong>example_production&lt;/strong>.&lt;/li>
&lt;/ol>
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>1. SSH login:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>2. Install the backup:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>3. Prepare directories for backup files:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>4. Generate and edit backup script:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>Input the below content:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># encoding: utf-8&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Backup::Model.new(&lt;span style="font-style:italic">:example_db&lt;/span>, &lt;span style="font-style:italic">&amp;#39;Dumping example Production Database&amp;#39;&lt;/span>) &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> split_into_chunks_of 250
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> database MySQL &lt;span style="font-weight:bold">do&lt;/span> |db|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.name = &lt;span style="font-style:italic">&amp;#34;example_production&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.username = &lt;span style="font-style:italic">&amp;#34;&amp;#34;&lt;/span> &lt;span style="font-style:italic"># Replace the blank string with your real username&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.password = &lt;span style="font-style:italic">&amp;#34;&amp;#34;&lt;/span> &lt;span style="font-style:italic"># Replace the blank string with your real password&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.host = &lt;span style="font-style:italic">&amp;#34;localhost&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.port = 3306
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.socket = &lt;span style="font-style:italic">&amp;#34;/var/run/mysqld/mysqld.sock&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> db.additional_options = [&lt;span style="font-style:italic">&amp;#34;--quick&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;--single-transaction&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> store_with Local &lt;span style="font-weight:bold">do&lt;/span> |local|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local.path = &lt;span style="font-style:italic">&amp;#34;/var/www/example/backup/db&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> local.keep = 10
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> compress_with Gzip
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Run backup command to confirm that your config works:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>Attention&lt;/strong>: Remember to update the config file if you have changed the username and/or password of the database.&lt;/p>
&lt;p>&lt;strong>5. Install whenever:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>6. Generate a schedule.rb file with whenever:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>The last command will create a new file named &lt;strong>&amp;ldquo;schedule.rb&amp;rdquo;&lt;/strong> under &lt;code>config/&lt;/code> directory.&lt;/p>
&lt;p>&lt;strong>7. Add a daily task:&lt;/strong>&lt;/p>
&lt;p>Open the file to edit:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>Contents:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>set &lt;span style="font-style:italic">:output&lt;/span>, &lt;span style="font-style:italic">&amp;#34;~/Backup/example_whenever.log&amp;#34;&lt;/span> &lt;span style="font-style:italic"># This is important, it can help you to find the reason when failed to backup the database&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>every &lt;span style="font-style:italic">:day&lt;/span> &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> command &lt;span style="font-style:italic">&amp;#34;cd ~/Backup &amp;amp;&amp;amp; backup perform -t example_db&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>8. Update whenever task into crontab:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>9. Check whether the task is updated successfully or not:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>If successed, you should see your new task shown at the bottom of the file.&lt;/p>
&lt;h2 id="synchronize-remote-backups-every-day-automatically-by-rsync-and-crontab">Synchronize remote backups every day automatically by rsync and crontab:&lt;/h2>
&lt;p>&lt;strong>Attention&lt;/strong>: Below operations are played on a different server, which is used to sync files. We assumpt its domain is &lt;code>another.com&lt;/code> and the username is &lt;code>deploy&lt;/code>.&lt;/p>
&lt;p>&lt;strong>1. SSH login:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>2. Write a synchronize shell script:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>Input the below contents into the new file named &amp;lsquo;sync.sh&amp;rsquo;:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>and then, assign the scripe execution authority:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>Run the script to ensure everything works well:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>&lt;strong>Attention:&lt;/strong> Because it is required to be authorized to access the targer server, you should remember to copy your ssh public key to the target server(such as, &lt;strong>example.com&lt;/strong>) before you can sync files.&lt;/p>
&lt;p>&lt;strong>3. Open user&amp;rsquo;s crontab config file:&lt;/strong>&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>Append the below task at the end:&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;!-- raw HTML omitted -->
&lt;p>Ok, that&amp;rsquo;s all. The rest work is that remember to check if there is any backups generated.&lt;/p></description></item><item><title>Write css codes distinct from different pages</title><link>https://blog.hackerpie.com/posts/archive/write-css-codes-distinct-from-different-pages/</link><pubDate>Thu, 29 Aug 2013 15:32:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/write-css-codes-distinct-from-different-pages/</guid><description>&lt;p>In rails, there is normally a view corresponding to an action. So if you want to do some special styles based on different pages, you can render controller name and action name in your layout file like this:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-html" data-lang="html">&lt;span style="display:flex;">&lt;span>&amp;lt;&lt;span style="font-weight:bold">body&lt;/span> class=&lt;span style="font-style:italic">&amp;#34;#{controller_name} #{action_name}&amp;#34;&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">&amp;lt;!-- Render something --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&amp;lt;/&lt;span style="font-weight:bold">body&lt;/span>&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Let&amp;rsquo;s assumpt that your current page controller is &lt;code>ProductsController&lt;/code>, and your action is &lt;code>index&lt;/code>, then you can write your style codes like:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scss" data-lang="scss">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">.products.index&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">/* some styles */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>Failed to stop or restart Nginx server through serevice command</title><link>https://blog.hackerpie.com/posts/archive/failed-to-stop-or-restart-nginx-server-through-serevice-command/</link><pubDate>Fri, 09 Aug 2013 11:39:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/failed-to-stop-or-restart-nginx-server-through-serevice-command/</guid><description>&lt;p>Many people are accustomed to start a Nginx web server through init scripts and then they can control the state of the server through &lt;code>service&lt;/code> command, such as &lt;code>sudo service nginx restart&lt;/code>. But sometimes unobvious config error makes the scripts failed to work. Here I will show an error related to &lt;code>pid&lt;/code> directive in the config file of nginx, which defaultly located at &lt;code>/opt/nginx/conf/nginx.conf&lt;/code>. &lt;!-- raw HTML omitted -->
As ignored by many people, some init scripts assump there is a pid file of nginx located at &lt;code>/var/run/nginx.pid&lt;/code>, but in the fact, the default pid file for nginx is &lt;code>/opt/nginx/logs/nginx.pid&lt;/code>. Because the scripts can&amp;rsquo;t get the correct pid or even get nothing, they failed to stop the nginx process, some tasks dependent on it will be failed too, for example, you are not able to restart the server.&lt;!-- raw HTML omitted -->&lt;/p>
&lt;p>To resolve this problem, you need to:&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Force terminating your server through:&lt;/strong>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ sudo service nginx destroy
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>&lt;strong>Open your nginx config file to edit:&lt;/strong>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ sudo vim /opt/nginx/conf/nginx.conf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="3">
&lt;li>&lt;strong>Specify the path of your pid file:&lt;/strong>&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code># /opt/nginx/conf/nginx.conf
pid /var/run/nginx.pid
&lt;/code>&lt;/pre>&lt;ol start="4">
&lt;li>&lt;strong>After saving your change, start your server now:&lt;/strong>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ sudo service nginx start
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="5">
&lt;li>&lt;strong>To confirm that your pid config has taken effect, you can cat your pid file and/or try to restart your server through &lt;code>service&lt;/code> command:&lt;/strong>&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>$ cat /var/run/nginx.pid
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>$ sudo service nginx restart
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>As expected, you will see the screen out &lt;strong>&amp;ldquo;OK&amp;rdquo;&lt;/strong> for your operations.&lt;/p></description></item><item><title>export/import datas to/from a csv file</title><link>https://blog.hackerpie.com/posts/archive/export-slash-import-to-slash-from-a-csv-file/</link><pubDate>Thu, 25 Jul 2013 22:19:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/export-slash-import-to-slash-from-a-csv-file/</guid><description>&lt;p>ä»Šå¤©éœ€è¦ç»™å®¢æˆ·çš„ç½‘ç«™åšæ”¯æŒäº§å“æ•°æ®å¯¼å‡ºå¹¶ä¸”æ›´æ–°çš„åŠŸèƒ½ï¼Œæ‰€ä»¥å°±æ¶‰åŠåˆ°äº†æ•°æ®çš„å¯¼å…¥å¯¼å‡ºäº†ã€‚åœ¨ç»è¿‡ä¸€ç•ªå¯¹æ¯”ä¹‹ä¸‹ï¼Œæœæ–­ä½¿ç”¨&lt;code>csv&lt;/code>æ ¼å¼æ–‡ä»¶ä½œä¸ºæ•°æ®å¯¼å…¥å¯¼å‡ºçš„è½½ä½“ã€‚&lt;!-- raw HTML omitted -->&lt;/p>
&lt;h4 id="å¯¼å‡ºcsvæ–‡ä»¶">å¯¼å‡ºcsvæ–‡ä»¶&lt;/h4>
&lt;p>ä¸csvæ–‡ä»¶ä¸»è¦ç›¸å…³çš„ç±»æ˜¯&lt;code>CSV&lt;/code>,æ­¤ç±»åœ¨rubyçš„æ ‡å‡†åº“ä¸­è¢«å®šä¹‰ï¼Œæ‰€ä»¥åªè¦åœ¨ä»£ç å¼€å¤´å¼•å…¥ç›¸å…³æ–‡ä»¶å³å¯:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>require &lt;span style="font-style:italic">&amp;#39;csv&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ¥ç€éœ€è¦åˆ›å»ºcsvæ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­å†™å…¥æ•°æ®:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>CSV.open &lt;span style="font-style:italic">&amp;#34;path/to/csv/file&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;wb&amp;#34;&lt;/span>, &lt;span style="font-style:italic">:col_sep&lt;/span> =&amp;gt; &lt;span style="font-style:italic">&amp;#39;|&amp;#39;&lt;/span> &lt;span style="font-weight:bold">do&lt;/span> |csv|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> csv &amp;lt;&amp;lt; [&lt;span style="font-style:italic">&amp;#34;one&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;row&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;of&amp;#34;&lt;/span>, &lt;span style="font-style:italic">&amp;#34;contents&amp;#34;&lt;/span>]
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>** è¿™é‡Œæœ‰å‡ ä¸ªç»†èŠ‚å€¼å¾—ä¸€æï¼š**&lt;!-- raw HTML omitted -->&lt;/p>
&lt;ol>
&lt;li>&lt;code>open&lt;/code>æ–¹æ³•æ˜¯ç”¨äºå¯¹CSVæ–‡ä»¶è¿›è¡Œå†™æ“ä½œçš„ä¸»è¦æ¥å£,å¯¹CSVæ–‡ä»¶è¿›è¡Œå†™æ“ä½œéƒ½åº”è¯¥ä½¿ç”¨æ­¤æ–¹æ³•;&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>&lt;code>&amp;lt;&amp;lt;&lt;/code> æ“ä½œç¬¦æ”¯æŒå°†&lt;strong>å­—ç¬¦ä¸²æ•°ç»„&lt;/strong>å†™å…¥åˆ°csvæ–‡ä»¶,ä¸€ä¸ªæ•°ç»„ä¸ºä¸€è¡Œï¼Œæ•°ç»„ä¸­çš„ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ºä¸€ä¸ªå•å…ƒ(field);&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>&lt;code>open&lt;/code>æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå“ˆå¸Œï¼Œç”¨äºä¸ºæ‰“å¼€çš„æ–‡ä»¶æŒ‡å®šåˆå§‹åŒ–èµ‹å€¼ï¼Œå…·ä½“å¯ç”¨çš„optionä»¥åŠå…¶å€¼å¯å‚è€ƒ&lt;code>new&lt;/code>æ–¹æ³•çš„è¯´æ˜:http://www.ruby-doc.org/stdlib-1.9.3/libdoc/csv/rdoc/CSV.html#method-c-new &lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>&lt;code>:col_sep&lt;/code>ç”¨äºæŒ‡å®šæ–‡ä»¶ä¸­æ¯ä¸€è¡Œä¸­çš„æ¯ä¸ªå•å…ƒä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œå½“é€šè¿‡å­—ç¬¦ä¸²æ•°ç»„æƒ³æ–‡ä»¶ä¸­æ·»åŠ æ–°è¡Œçš„æ—¶å€™ï¼ŒCSVå°†ä¼šåœ¨æ•°ç»„å…ƒç´ ä¹Ÿå°±æ˜¯æ¯ä¸€è¡Œçš„å•å…ƒä¹‹é—´æ’å…¥æŒ‡å®šçš„åˆ†éš”ç¬¦ï¼Œåˆ†éš”ç¬¦éœ€è¦å°½é‡é¿å¼€å·²ç»åœ¨å¾…å¯¼å‡ºæ•°æ®ä¸­å­˜åœ¨çš„å­—ç¬¦ï¼Œä»¥å…åç»­å¯¼å…¥çš„æ—¶å€™å‘ç”Ÿæ­§ä¹‰ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="å¯¼å…¥csvæ–‡ä»¶">å¯¼å…¥csvæ–‡ä»¶&lt;/h4>
&lt;p>å¯¼å…¥csvé™¤äº†éœ€è¦ç”¨åˆ°ç›¸å…³çš„ç±»&lt;code>CSV&lt;/code>ï¼Œè¿˜å¯èƒ½ç”¨åˆ°çš„ç±»æ˜¯&lt;code>CSV::Row&lt;/code>ï¼Œå‰è€…æä¾›æ‰“å¼€æ–‡ä»¶ä»¥åŠå°†æ–‡ä»¶æŒ‰è¡Œåˆ†éš”çš„æ–¹æ³•&lt;code>foreach&lt;/code>ï¼Œforeachå°†åˆ†éš”åçš„è¡Œé€è¡Œåˆ†é…åˆ°CSV::Rowçš„å®ä¾‹ä¸­ï¼Œé€šè¿‡è°ƒç”¨CSV::Rowçš„å®ä¾‹æ–¹æ³•&lt;code>field&lt;/code>å¯å¯¹æ¯ä¸ªå•å…ƒè¿›è¡Œè¯»å–ã€‚&lt;!-- raw HTML omitted -->
å‡è®¾æˆ‘æœ‰è¿™æ ·ä¸€ä¸ªcsvæ–‡ä»¶ï¼š&lt;/p>
&lt;pre tabindex="0">&lt;code>id | value
1234 | hello
2345 | world
&lt;/code>&lt;/pre>&lt;p>åˆ™ç›¸å…³çš„ä»£ç å¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>CSV.foreach(&lt;span style="font-style:italic">&amp;#39;path/to/file&amp;#39;&lt;/span>), &lt;span style="font-style:italic">:col_sep&lt;/span> =&amp;gt; &lt;span style="font-style:italic">&amp;#39;|&amp;#39;&lt;/span>, &lt;span style="font-style:italic">:headers&lt;/span> =&amp;gt; &lt;span style="font-style:italic">:first_row&lt;/span> &lt;span style="font-weight:bold">do&lt;/span> |row|
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic"># use datas of each row&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> id = row.field &lt;span style="font-style:italic">&amp;#39;id&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> value = row.field &lt;span style="font-style:italic">&amp;#39;value&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>** åŒæ ·è¿™é‡Œä¹Ÿæœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„:**&lt;!-- raw HTML omitted -->&lt;/p>
&lt;ol>
&lt;li>&lt;code>foreach&lt;/code>æ˜¯CSVç±»ä¸­ç”¨äºè¯»å–æ–‡ä»¶çš„æ ‡å‡†æ–¹æ³•ï¼›&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>é€šè¿‡æŒ‡å®š&lt;code>:col_sep =&amp;gt; '|'&lt;/code>å¯ä½¿CSVæŒ‰ç…§æŒ‡å®šçš„åˆ†éš”ç¬¦åˆ†éš”å¥½æ–‡ä»¶å†…å®¹ï¼Œæ–¹ä¾¿åé¢&lt;code>field&lt;/code>æ–¹æ³•çš„è°ƒç”¨ï¼›&lt;!-- raw HTML omitted -->&lt;/li>
&lt;li>æŒ‡å®š&lt;code>:headers =&amp;gt; :first_row&lt;/code>å¯ä½¿CSVå°†ç¬¬ä¸€è¡Œè§†ä¸ºæ–‡ä»¶çš„headersï¼Œå¹¶ä¸”ç»“åˆ&lt;code>:col_sep&lt;/code>çš„è®¾å®šå¯ä»¥å°†headersè¿›è¡Œåˆ†å‰²ï¼Œè¿™ä¸¤ä¸ªæ˜¯&lt;code>field&lt;/code>æ–¹æ³•çš„åŸºç¡€ã€‚&lt;/li>
&lt;/ol>
&lt;h5 id="related-links">Related links:&lt;/h5>
&lt;p>&lt;a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/csv/rdoc/CSV.html">http://www.ruby-doc.org/stdlib-1.9.3/libdoc/csv/rdoc/CSV.html&lt;/a> &lt;!-- raw HTML omitted -->
&lt;a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/csv/rdoc/CSV/Row.html">http://www.ruby-doc.org/stdlib-1.9.3/libdoc/csv/rdoc/CSV/Row.html&lt;/a>&lt;/p></description></item><item><title>Rails HTTP Status Code to Symbol Mapping</title><link>https://blog.hackerpie.com/posts/archive/rails-http-status-code-to-symbol-mapping/</link><pubDate>Wed, 24 Jul 2013 15:00:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/rails-http-status-code-to-symbol-mapping/</guid><description>&lt;p>Sometimes you might need to set the HTTP response head with different status to specify the different handled results. You can do this in Rails by add a &lt;code>:status&lt;/code> to a rails method such as &lt;code>#respond_with&lt;/code>. Here list all the maps:&lt;/p>
&lt;p>{% gist 2405434 %}&lt;/p>
&lt;p>Addtionally, you can view all these on your local machine by installing the gem &lt;code>cheat&lt;/code>, and see all status codes using command &lt;code>cheat status_codes&lt;/code>.&lt;/p>
&lt;p>All these informations come from internet, the codes file comes from &lt;a href="https://gist.github.com/ktkaushik">ktkaushik&amp;rsquo;s&lt;/a> gist and other information comes from &lt;a href="http://www.codyfauser.com/2008/7/4/rails-http-status-code-to-symbol-mapping">Cody Fauser&amp;rsquo;s post&lt;/a>&lt;/p></description></item><item><title>Delete multiple git remote branches by prefixing all refs with a colon</title><link>https://blog.hackerpie.com/posts/archive/delete-multiple-git-remote-branches-by-prefixing-all-refs-with-a-colon/</link><pubDate>Sun, 21 Jul 2013 15:46:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/delete-multiple-git-remote-branches-by-prefixing-all-refs-with-a-colon/</guid><description>&lt;p>This article shows how to delete multiple remote branches in Git.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-sh" data-lang="sh">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>git push origin :branch-1 :branch-2 [:other-branches]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Remember the colon &lt;code>:&lt;/code>&lt;/p></description></item><item><title>Track Original Repo When Fork</title><link>https://blog.hackerpie.com/posts/archive/track-original-repo-when-fork/</link><pubDate>Sun, 21 Jul 2013 10:24:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/track-original-repo-when-fork/</guid><description>&lt;p>{% gist 5908916 %}&lt;/p></description></item></channel></rss>