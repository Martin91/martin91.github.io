
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>解读 Rails: Migrations - Martin</title>
	<meta name="author" content="Martin">

	
	<meta name="description" content="此文翻译自Reading Rails &ndash; Migrations，限于本人水平，翻译不当之处，敬请指教！ 今天我们将会探讨一下 Rails 经常被忽视的可靠的工作伙伴 —— Migrator。它是如何搜寻你的 migrations 并且执行它们的呢？我们将再一次慢慢地挖掘 Rails &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Martin" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="/javascripts/jquery-1.11.1.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Martin</a></h1>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:Martin91.github.io">
			</form>
		</div>
	</div>
</nav>
<nav id="sub-nav" class="alignright">
	<div class="social">
		
		
		
		
    
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
    
	</div>
	<form class="search" action="http://google.com/search" method="get">
		<input class="alignright" type="text" name="q" results="0">
		<input type="hidden" name="q" value="site:Martin91.github.io">
	</form>
</nav>

</header>
	
		
	
	<div id="content" class="inner"><article class="post">
	<h2 class="title">解读 Rails: Migrations</h2>
	<div class="entry-content"><p>此文翻译自<a href="http://www.monkeyandcrow.com/blog/reading_rails_migrations/">Reading Rails &ndash; Migrations</a>，限于本人水平，翻译不当之处，敬请指教！</p>

<p>今天我们将会探讨一下 Rails 经常被忽视的可靠的工作伙伴 —— Migrator。它是如何搜寻你的 migrations 并且执行它们的呢？我们将再一次慢慢地挖掘 Rails 的源代码，并在此过程中慧海拾珠。</p>

<!-- MORE -->


<p>为了跟随本文的步骤，请使用<a href="https://github.com/adamsanderson/qwandry">qwandry</a>打开相关的代码库，或者直接在<a href="https://github.com/rails/rails/tree/5505c1d700f17e2009e1189a7aa6dafafe7062a4">Github</a>上查看这些代码。</p>

<h3>动身启程</h3>

<p>在展开讨论之前，此处并无特殊准备要求。或许你已经创建好了项目所需要的但是仍是空的数据库。如果你执行 <code>rake db:migrate</code>，所有的未执行的 migrations 就会开始执行。让我们从查看 <code>databases.rake</code> 里的 Rake 任务的源码开始动起来：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s2">&quot;Migrate the database (options: VERSION=x, VERBOSE=false, SCOPE=blog).&quot;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:migrate</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:environment</span><span class="p">,</span> <span class="ss">:load_config</span><span class="o">]</span> <span class="k">do</span>
</span><span class='line'>  <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migration</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;VERBOSE&quot;</span><span class="o">]</span> <span class="p">?</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;VERBOSE&quot;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="p">:</span> <span class="kp">true</span>
</span><span class='line'>  <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migrator</span><span class="o">.</span><span class="n">migrate</span><span class="p">(</span><span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Migrator</span><span class="o">.</span><span class="n">migrations_paths</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;VERSION&quot;</span><span class="o">]</span> <span class="p">?</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;VERSION&quot;</span><span class="o">].</span><span class="n">to_i</span> <span class="p">:</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>虽然我们并不打算揭露 Rake 本身的工作机制，但是值得注意的是，执行 <code>migrate</code> 要求另外两个任务 <code>[:environment, :load_config]</code> 的首先执行。这能确保 Rails 的运行环境以及你的 <code>database.yml</code> 文件被加载进来。</p>

<p>上面的 rake 任务通过环境变量配置了 <code>ActiveRecord::Migration</code> 以及 <code>ActiveRecord::Migrator</code>。环境变量是一种非常有效的可用于向你的应用程序传递信息的方式。缺省地，诸如<code>USER</code>的很多（环境）变量都是已经设置好的，他们也可以在每个（终端）命令执行时单独设置。举个例子，如果你通过 <code>VERBOSE=false rake db:migrate</code> 调用了 Rake 任务，<code>ENV["VERBOSE"]</code>的值就会是字符串<code>"false"</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 通过环境变量启动 irb：</span>
</span><span class='line'><span class="c1"># &gt; FOOD=cake irb</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;FOOD&#39;</span><span class="o">]</span>     <span class="c1">#=&gt; &#39;cake&#39;</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;USER&#39;</span><span class="o">]</span>     <span class="c1">#=&gt; &#39;adam&#39;</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;WAFFLES&#39;</span><span class="o">]</span>  <span class="c1">#=&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>migration 的真正工作是从 <code>ActiveRecord::Migrator.migrate</code> 开始的，这个方法接受了第一个参数，用于表示 migrations 文件可能存在的路径的集合，另外还有一个可选参数，用于表示 migrate 执行的目标版本。</p>

<h3>搜寻 migrations</h3>

<p>现在就打开 ActiveRecord 里的 <code>migration.rb</code> 文件，不过在深入探究之前，先查看下在这个文件里最上面定义的异常。定义自定义的异常是非常容易的，<code>migration.rb</code> 里就有一些不错的例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">ActiveRecord</span>
</span><span class='line'>  <span class="c1"># 可以用于在回滚过程中中止 migrations 的异常类</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">IrreversibleMigration</span> <span class="o">&lt;</span> <span class="no">ActiveRecordError</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">IllegalMigrationNameError</span> <span class="o">&lt;</span> <span class="no">ActiveRecordError</span><span class="c1">#:nodoc:</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>      <span class="k">super</span><span class="p">(</span><span class="s2">&quot;Illegal name for migration file: </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="se">\n\t</span><span class="s2">(only lower case letters, numbers, and &#39;_&#39; allowed)&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">#...</span>
</span></code></pre></td></tr></table></div></figure>


<p>像我们在之前讲 <a href="/blog/articles/2014/03/05/jie-du-rails-chu-li-yi-chang/">Rails 处理异常</a> 的文章中一样，自定义异常能够被特别处理。在这个案例里，<code>IrreversibleMigration</code> 表示当前的 <code>migration</code> 不能被回滚。另外一个需要定义你自己的异常的原因是，可以像<code>IllegalMigrationNameError</code>一样，通过重定义<code>initialize</code>方法来实现生成一致的错误消息。同时，要确保你调用了 <code>super</code>。</p>

<p>现在向下滚动（文件），让我们看看 <code>Migrator.migrate</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Migrator</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">migrate</span><span class="p">(</span><span class="n">migrations_paths</span><span class="p">,</span> <span class="n">target_version</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">case</span>
</span><span class='line'>      <span class="k">when</span> <span class="n">target_version</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>        <span class="n">up</span><span class="p">(</span><span class="n">migrations_paths</span><span class="p">,</span> <span class="n">target_version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="c1">#...</span>
</span><span class='line'>      <span class="k">when</span> <span class="n">current_version</span> <span class="o">&gt;</span> <span class="n">target_version</span>
</span><span class='line'>        <span class="n">down</span><span class="p">(</span><span class="n">migrations_paths</span><span class="p">,</span> <span class="n">target_version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">up</span><span class="p">(</span><span class="n">migrations_paths</span><span class="p">,</span> <span class="n">target_version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="c1">#...</span>
</span></code></pre></td></tr></table></div></figure>


<p>取决于 <code>target_version</code>，我们将通过 <code>up</code> 或者 <code>down</code> 完成 migrate。这两个方法遵循了同样的模式，都是扫描了 <code>migration_paths</code> 里的可执行的 migrations，然后初始化一个新的 <code>Migrator</code> 的实例。让我们看看这些 migrations 是如何被搜寻到的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Migrator</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">migrations</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span class='line'>      <span class="n">paths</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">files</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[*</span><span class="n">paths</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">/**/[0-9]*_*.rb&quot;</span> <span class="p">}</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">migrations</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>        <span class="n">version</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/([0-9]+)_([_a-z0-9]*)\.?([_a-z0-9]*)?\.rb\z/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">raise</span> <span class="no">IllegalMigrationNameError</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">unless</span> <span class="n">version</span>
</span><span class='line'>        <span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>        <span class="nb">name</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">camelize</span>
</span><span class='line'>
</span><span class='line'>        <span class="no">MigrationProxy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">migrations</span><span class="o">.</span><span class="n">sort_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:version</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法里满是非常值得学习的实例，让我们停留几分钟并且仔细阅读它。最开始，代码里通过一个 <code>Array()</code> 方法这样的小技巧，确保了参数始终是数组类型。“你说这（Array）是个方法？”是的！这虽然不是很正统，但定义一个驼峰式命名的方法是合法的，甚至这样的方法名还可以和类同名：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Flummox</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">Flummox</span><span class="p">()</span>
</span><span class='line'>  <span class="s2">&quot;confusing&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Flummox</span>       <span class="c1">#=&gt; Flummox</span>
</span><span class='line'><span class="no">Flummox</span><span class="o">.</span><span class="n">new</span>   <span class="c1">#=&gt; #&lt;Flummox:0x0000000bf0b5d0&gt;</span>
</span><span class='line'><span class="no">Flummox</span><span class="p">()</span>     <span class="c1">#=&gt; &quot;confusing&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby 使用了这个特性定义了一个 <code>Array()</code> 方法，这个方法始终返回一个数组。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">Array</span><span class="p">(</span><span class="kp">nil</span><span class="p">)</span>                <span class="c1">#=&gt; []</span>
</span><span class='line'><span class="nb">Array</span><span class="p">(</span><span class="o">[]</span><span class="p">)</span>                 <span class="c1">#=&gt; []</span>
</span><span class='line'><span class="nb">Array</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                  <span class="c1">#=&gt; [1]</span>
</span><span class='line'><span class="nb">Array</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span>            <span class="c1">#=&gt; [&quot;Hello&quot;]</span>
</span><span class='line'><span class="nb">Array</span><span class="p">(</span><span class="o">[</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="s2">&quot;World&quot;</span><span class="o">]</span><span class="p">)</span> <span class="c1">#=&gt; [&quot;Hello&quot;, &quot;World&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法类似于 <code>to_a</code>，但是可以在任何（类型的）对象上调用。Rails 通过 <code>paths = Array(paths)</code>使用了这个（方法），得以确保 <code>paths</code> 将是一个数组。</p>

<p>在接下来一行的代码里，Rails 搜寻了指定的路径并且进行了过滤：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">files</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[*</span><span class="n">paths</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">/**/[0-9]*_*.rb&quot;</span> <span class="p">}</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>让我们将这个代码分解一下。<code>paths.map { |p| "#{p}/**/[0-9]*_*.rb" }</code>将每一个路径转换成一个 <a href="http://en.wikipedia.org/wiki/Glob_(programming)"><code>shell glob</code></a>。一个类似 <code>"db/migrate"</code> 的路径就变成了 <code>"db/migrate/**/[0-9]*_*.rb"</code>，这将会在 <code>"db/migrate"</code> 或者它的所有子目录里匹配所有用数字开头的文件。这些（shell glob 表示的）路径通过 <code>*</code> 操作符分成（单个元素）并且传递给了 <code>Dir[]</code>。</p>

<p><code>Dir[]</code> 是非常有用的。它接收类似 <code>"db/migrate/**/[0-9]*_*.rb"</code> 这样的模式（作为参数），然后返回匹配的文件列表。当你需要在指定路径里查找文件的时候，<code>Dir[]</code> 就是称手利器。其中，<code>**</code> 表示递归地在所有子目录中执行匹配，而 <code>*</code> 则表示一个或多个字符的通配符，也就是说，前面的这个模式就是为了匹配类似 <code>20131127051346_create_people.rb</code> 的 migrations （文件）。</p>

<p>Rails 遍历每一个匹配的文件，并且通过 <code>String#scan</code> 结合正则表达式提取信息。如果你对正则表达式不是很熟悉，那现在就应该抛开一切，先学习好正则表达式再说。<code>String#scan</code> 以字符串形式返回所有匹配的结果。如果表达式里还包含了 capturing groups（匹配分组），它们将会以内嵌数组（subarrays）的方式返回。比如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;123 abc 456&quot;</span>
</span><span class='line'><span class="c1"># 没有 capturing groups:</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\d+/</span><span class="p">)</span>           <span class="c1">#=&gt; [&quot;123&quot;, &quot;456&quot;]</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\d+\s\w+/</span><span class="p">)</span>      <span class="c1">#=&gt; [&quot;123 abc&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 先匹配数字，再匹配单词：</span>
</span><span class='line'><span class="n">s</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/(\d+)\s+(\w+)/</span><span class="p">)</span> <span class="c1">#=&gt; [[&quot;123&quot;, &quot;abc&quot;]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以 <code>file.scan</code> 将会匹配版本号<code>([0-9]+)</code>，名字<code>([_a-z0-9]*)</code>，以及一个可选的 scope <code>([_a-z0-9]*)?</code>。由于 <code>String#scan</code> 始终返回数组，并且我们知道这个模式只会出现一次，所以 Rails 直接提取第一个匹配结果。Rails 一次性执行了多个变量赋值 <code>version, name, scope = ...</code>。这是得益于数组的解构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">version</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">scope</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;20131127051346&quot;</span><span class="p">,</span> <span class="s2">&quot;create_people&quot;</span><span class="o">]</span>
</span><span class='line'><span class="n">version</span> <span class="c1">#=&gt; &quot;20131127051346&quot;</span>
</span><span class='line'><span class="nb">name</span>    <span class="c1">#=&gt; &quot;create_people&quot;</span>
</span><span class='line'><span class="n">scope</span>   <span class="c1">#=&gt; nil</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意一下，如果（等号左边）变量的数量大于（等号右边）数组的元素的数量，多余变量的值将会被赋值为<code>nil</code>。这是一种从正则表达式（匹配后的值）进行多个赋值的快捷技巧。</p>

<p>匹配的版本号 version 通过 <code>to_i</code> 方法转换为一个整数（Fixnum），而同时，名字 name 通过 <code>name.camelize</code> 完成了格式转换。<code>String#camelize</code>是 <code>ActiveSupport</code> 里的方法，用于下划线命名 <code>snake_case</code> 和 驼峰式命名 <code>CamelCase</code> 之间的相互转换。这个方法可以将 <code>"create_people"</code> 转换为 <code>CreatePeople</code>。</p>

<p>让我们过会再看下 <code>MigrationProxy</code>，现在先看下 <code>Migrator#migrations</code> 这个方法的最后一个部分，<code>migrations.sort_by(&amp;:version)</code>。这个表达式将所有 migrations 基于版本号进行了排序。如何排序的方式会是更有趣的内容。</p>

<p>从 Ruby 1.9 开始，<code>&amp;</code>操作将会在被它作用的对象上调用 <code>to_proc</code> 方法。当在一个 symbol 上调用时，返回的结果是一个代码块里调用与 symbol 同命名的方法的 <code>Proc</code> 对象。所以 <code>&amp;:version</code> 等同于某行代码的 <code>{|obj| obj.version }</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Library</span> <span class="o">=</span> <span class="no">Struct</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:version</span><span class="p">)</span>
</span><span class='line'><span class="n">libraries</span> <span class="o">=</span> <span class="o">[</span>
</span><span class='line'>  <span class="no">Library</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Rails&quot;</span><span class="p">,</span> <span class="s2">&quot;4.0.1&quot;</span><span class="p">),</span>
</span><span class='line'>  <span class="no">Library</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Rake&quot;</span><span class="p">,</span> <span class="s2">&quot;10.1.0&quot;</span><span class="p">)</span>
</span><span class='line'><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">libraries</span><span class="o">.</span><span class="n">map</span><span class="p">{</span><span class="o">|</span><span class="n">lib</span><span class="o">|</span> <span class="n">lib</span><span class="o">.</span><span class="n">version</span> <span class="p">}</span> <span class="c1">#=&gt; [&quot;4.0.1&quot;, &quot;10.1.0&quot;]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># &amp;:version =&gt; Proc.new{|lib| lib.version } (Roughly)</span>
</span><span class='line'><span class="n">libraries</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:version</span><span class="p">)</span>          <span class="c1">#=&gt; [&quot;4.0.1&quot;, &quot;10.1.0&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 Rails 里，这种技巧在排序或者映射的时候非常常见。和众多的技巧一样，请确认你的团队能够适应这种语法。如有疑虑，更好的方案就是不再使用（这种技巧），这会让代码更清晰。</p>

<h3>The Migration</h3>

<p>现在，回到 <code>MigrationProxy</code>。顾名思义，只是一个 <code>Migration</code> 的实例的代理。代理对象（Proxy objects）是一个常见的用于透明地将一个对象替换为另一个对象的设计模式。在这个例子中，<code>MigrationProxy</code>代替了一个真正的 <code>Migration</code> 对象，而且除非必需，它会延缓对 migration 的源码的实际的加载。<code>MigrationProxy</code> 通过委托方法（delegating methods）达到目的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MigrationProxy</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'>  <span class="n">delegate</span> <span class="ss">:migrate</span><span class="p">,</span> <span class="ss">:announce</span><span class="p">,</span> <span class="ss">:write</span><span class="p">,</span> <span class="ss">:disable_ddl_transaction</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:migration</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">migration</span>
</span><span class='line'>      <span class="vi">@migration</span> <span class="o">||=</span> <span class="n">load_migration</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">load_migration</span>
</span><span class='line'>      <span class="nb">require</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</span><span class='line'>      <span class="nb">name</span><span class="o">.</span><span class="n">constantize</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>delegate</code> 方法将它的每一个参数都发送给了 <code>to:</code> 选项返回的对象，在这里，这个对象就是我们的 <code>migration</code>。如果 <code>@migration</code> 实例变量尚未定义或赋值，<code>migration</code> 方法将会执行懒加载migration <code>load_migration</code>。<code>load_migration</code> 方法按序加载(require) ruby 源码，然后使用 <code>name.constantize.new</code> 创建一个新的实例。<code>String#constantize</code> 是 ActiveSupport 中定义的方法，用于返回名字与字符串相同的常量：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s2">&quot;Person&quot;</span><span class="o">.</span><span class="n">constantize</span>       <span class="c1">#=&gt; Person</span>
</span><span class='line'><span class="s2">&quot;Person&quot;</span><span class="o">.</span><span class="n">constantize</span><span class="o">.</span><span class="n">class</span> <span class="c1">#=&gt; Class</span>
</span><span class='line'><span class="s2">&quot;person&quot;</span><span class="o">.</span><span class="n">constantize</span>       <span class="c1">#=&gt; NameError: wrong constant name person</span>
</span></code></pre></td></tr></table></div></figure>


<p>当你想要动态地引用一个类时，这个技巧非常有效。</p>

<p>通过 <code>MigrationProxy</code>，Rails 只加载并且实例化必要的 migrations，这能为 migration 的处理提速，同时节约更多内存。</p>

<p>真正的 <code>Migration</code> 类在代理委托了 <code>migrate</code> 方法的时候才被 <code>Migrator</code> 调用。这个按序调用 <code>Migration#up</code> 或者 <code>Migration#down</code> 取决于 migration 是在先前执行，还是在执行回滚。</p>

<h3>总结（Recap）</h3>

<p>我们仅仅只是一瞥了 Rails 的 migration 机制的源码的表面，但是我们却已经学到了一些有趣的知识。Migrations 由一个调用了 <code>Migrator</code> 的 Rake 任务启动，<code>Migrator</code> 又按序查找到了我们的 migrations，并且使用了 <code>MigrationProxy</code> 对象对这些 migrations 进行了包装，直到真正的 <code>Migration</code> 需要被执行的时候。</p>

<p>一如既往，我们已经了解了一些有趣的方法、习惯以及技巧：</p>

<ul>
<li>环境变量可以通过 <code>ENV</code> 常量访问；</li>
<li>定义自定义的异常类，是一种常见的对异常进行处理的手段；</li>
<li><code>Array()</code> 方法将任意对象转换为数组；</li>
<li><code>Dir[]</code> 使用 <code>shell glob</code> 语法搜索文件；</li>
<li><code>String#scan</code> 返回字符串里所有匹配的结果，并且支持匹配分组（capturing groups）；</li>
<li><code>String#camelize</code> 将下划线形式（snake_case）字符串转换为驼峰式（CamelCase）;</li>
<li><code>&amp;</code> 操作符在符号类型的对象上调用时，会创建一个 <code>Proc</code> 对象</li>
<li><code>delegate</code> 可以用于实现代理的设计模式</li>
<li>可以通过 <code>String#contantize</code> 方法动态加载常量</li>
</ul>


<p>下一次，或许我们就能弄明白 <code>Migrator</code> 是如何确切知道哪些 migrations 已经在你的数据库里执行过。</p>

<h3>喜欢这篇文章？</h3>

<p><a href="/blog/articles/2014/03/02/jie-du-rails-xi-lie-fan-yi/">阅读更多</a>“解读Rails”中的文章。“解读Rails”中的文章。</p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2017-10-14T22:29:20+08:00" pubdate data-updated="true">Oct 14<span>th</span>, 2017</time></div>
	<div class="tags">


	<a class='category' href='/blog/categories/rails-migrations/'>Rails Migrations</a>, <a class='category' href='/blog/categories/fan-yi/'>翻译</a>, <a class='category' href='/blog/categories/jie-du-rails/'>解读Rails</a>


</div>
	
	<div class="comments"><a href="#disqus_thread">Comments</a></div>
	
</div>
</article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
		
		
		<a class="addthis_button_tweet"></a>
		
		
		<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
		
		
	</div>
	
</div>



<section id="comment">
    <h2 class="title">Comments</h2>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2018

    Martin

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'martin-blog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://Martin91.github.io/blog/articles/2017/10/14/jie-du-rails-migrations/';
        var disqus_url = 'http://Martin91.github.io/blog/articles/2017/10/14/jie-du-rails-migrations/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//go.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-50624776-1']);
		_gaq.push(['_setDomainName','github.io']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F6d4498d8e2d7328fffdb1539f0589a61' type='text/javascript'%3E%3C/script%3E"));
</script>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '781315158664022',
      xfbml      : true,
      version    : 'v2.4'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

</body>
</html>