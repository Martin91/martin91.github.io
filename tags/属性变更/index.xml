<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>属性变更 on Hackerpie</title><link>https://blog.hackerpie.com/tags/%E5%B1%9E%E6%80%A7%E5%8F%98%E6%9B%B4/</link><description>Recent content in 属性变更 on Hackerpie</description><generator>Hugo</generator><language>zh-CN</language><lastBuildDate>Fri, 07 Mar 2014 13:02:00 +0800</lastBuildDate><atom:link href="https://blog.hackerpie.com/tags/%E5%B1%9E%E6%80%A7%E5%8F%98%E6%9B%B4/index.xml" rel="self" type="application/rss+xml"/><item><title>跟踪model中属性（值）的变更</title><link>https://blog.hackerpie.com/posts/archive/zhui-zong-bian-geng/</link><pubDate>Fri, 07 Mar 2014 13:02:00 +0800</pubDate><guid>https://blog.hackerpie.com/posts/archive/zhui-zong-bian-geng/</guid><description>&lt;p>此文翻译自&lt;a href="http://monkeyandcrow.com/blog/reading_rails_change_tracking/">Reading Rails - Change Tracking&lt;/a>，限于本人水平，翻译不当之处，敬请指教！&lt;/p>
&lt;p>我们今天来看看Rails是如何追踪model里边属性的变更的。&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>person = Person.find(8)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.name = &lt;span style="font-style:italic">&amp;#34;Mortimer&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.name_changed? &lt;span style="font-style:italic">#=&amp;gt; true&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.name_was &lt;span style="font-style:italic">#=&amp;gt; &amp;#34;Horton&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.changes &lt;span style="font-style:italic">#=&amp;gt; {&amp;#34;name&amp;#34;=&amp;gt;[&amp;#34;Horton&amp;#34;,&amp;#34;Mortimer&amp;#34;]}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.save!
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>person.changes &lt;span style="font-style:italic">#=&amp;gt; {}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>name_changed?&lt;/code>方法是从哪来的呢？变更又是如何被创建的？让我们顺着这个场景，看看这一切背后的秘密。&lt;/p>
&lt;!-- raw HTML omitted -->
&lt;p>如果需要跟着我的步骤走，请使用&lt;a href="https://github.com/adamsanderson/qwandry">qwandry&lt;/a>打开每一个相关的代码库，或者直接从&lt;a href="https://github.com/rails/rails/tree/5505c1d700f17e2009e1189a7aa6dafafe7062a4">github&lt;/a>查看源码即可。&lt;/p>
&lt;h3 id="activemodel">ActiveModel&lt;/h3>
&lt;p>当你想探寻ActiveRecord里边的功能时，你应该首先了解ActiveModel。ActiveModel（&lt;strong>提示&lt;/strong>： 命令行中键入&lt;code>qw activemodel&lt;/code>查看代码）定义了没有与数据库捆绑的逻辑。我们将从&lt;code>dirty.rb&lt;/code>文件开始。在这个模块最开始的地方，代码调用了&lt;code>attribute_method_suffix&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">module&lt;/span> &lt;span style="font-weight:bold">Dirty&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">extend&lt;/span> ActiveSupport::Concern
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="">include&lt;/span> ActiveModel::AttributeMethods
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> included &lt;span style="font-weight:bold">do&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> attribute_method_suffix &lt;span style="font-style:italic">&amp;#39;_changed?&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_change&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_will_change!&amp;#39;&lt;/span>, &lt;span style="font-style:italic">&amp;#39;_was&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="font-style:italic">#...&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;code>attribute_method_suffix&lt;/code>定义了定制的属性读写器。这主要用来告诉Rails将一些带有类似&lt;code>_changed?&lt;/code>后缀的调用分发到特定的处理器方法上。为了看看它们是如何实现的，请向下滚动代码，并且找到&lt;code>def attribute_changed?&lt;/code>：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> attribute_changed?(&lt;span style="">attr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> changed_attributes.include?(&lt;span style="">attr&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>我们将会在另外的一篇文章中再着重介绍如何连接这些方法的细节，当你调用一个类似&lt;code>name_changed?&lt;/code>的方法时，Rails将会把&lt;code>&amp;quot;name&amp;quot;&lt;/code>作为参数&lt;code>attr&lt;/code>传给上述方法。往回看一点点，你会发现&lt;code>changed_attributes&lt;/code>只是一个包含了从属性名到旧的属性值的映射的&lt;code>Hash&lt;/code>而已：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-ruby" data-lang="ruby">&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># Returns a hash of the attributes with unsaved changes indicating their original&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># values like &amp;lt;tt&amp;gt;attr =&amp;gt; original value&amp;lt;/tt&amp;gt;.&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic">#&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># person.name # =&amp;gt; &amp;#34;bob&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># person.name = &amp;#39;robert&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-style:italic"># person.changed_attributes # =&amp;gt; {&amp;#34;name&amp;#34; =&amp;gt; &amp;#34;bob&amp;#34;}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">def&lt;/span> changed_attributes
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> @changed_attributes ||= {}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="font-weight:bold">end&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>在Ruby中，如果你之前都没有见过&lt;code>||=&lt;/code>操作，那么你可能需要了解这其实是一个用于初始化变量值的技巧。当它第一次被访问的时候，变量的值是&lt;code>nil&lt;/code>，所以它返回了一个空的&lt;code>Hash&lt;/code>并且用其初始化&lt;code>@changed_attributes&lt;/code>。当它再一次被访问的时候，&lt;code>@changed_attributes&lt;/code>已经被赋值过了。那么现在我们可以回答我们的第一个问题了，&lt;code>name_changed?&lt;/code>方法被转发到&lt;code>attribute_changed?&lt;/code>方法，而后者会在&lt;code>changed_attributes&lt;/code>中查找特定的值。&lt;/p></description></item></channel></rss>