<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="">

    
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:400|Old+Standard+TT:400&display=swap" rel="stylesheet" media="print" type="text/css" onload="this.media='all'">
    

    <title>
      
      
         申请以及集成 Stripe 的 Alipay 支付方案 
      
    </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/styles/tomorrow.min.css">
    <link rel="canonical" href="https://martin91.github.io/posts/shen-qing-yi-ji-ji-cheng-stripe-de-alipay-zhi-fu-fang-an/">

    <style>
  @font-face {
    font-family: "OPPO Sans";
    src: url("/fonts/OPPOSans-R.ttf");
  }

  * {
    border:0;
    font:inherit;
    font-size:100%;
    vertical-align:baseline;
    margin:0;
    padding:0;
    color: black;
    text-decoration-skip: ink;
  }

  body {
    font-family: 'OPPO Sans', 'Open Sans', 'Myriad Pro', Myriad, sans-serif;
    font-size:17px;
    line-height:160%;
    color:#1d1313;
    max-width:1000px;
    margin:auto;
  }

  p {
    margin: 20px 0;
    letter-spacing: 1pt;
  }

  a img {
    border:none;
  }

  img {
    margin: 10px auto 10px auto;
    max-width: 100%;
    display: block;
  }

  .left-justify { float: left; }
  .right-justify { float:right; }

  pre, code {
    font: 12px Consolas, "Liberation Mono", Menlo, Courier, monospace;
    background-color: #f7f7f7;
  }

  code {
    font-size: 12px;
    padding: 4px;
  }

  pre {
    margin-top: 0;
    margin-bottom: 16px;
    word-wrap: normal;
    padding: 16px;
    overflow: auto;
    font-size: 85%;
    line-height: 1.45;
  }

  pre>code {
    padding: 0;
    margin: 0;
    font-size: 100%;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0;
  }

  pre code {
    display: inline;
    padding: 0;
    margin: 0;
    overflow: visible;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0;
  }

  pre code::before,
  pre code::after {
    content: normal;
  }

  em,q,em,dfn {
    font-style:italic;
  }

  .sans,html .gist .gist-file .gist-meta {
    font-family:'OPPO Sans', "Open Sans","Myriad Pro",Myriad,sans-serif;
  }

  .mono,pre,code,tt,p code,li code {
    font-family: Menlo,Monaco,"Andale Mono","lucida console","Courier New",monospace;
  }

  .section-title {
    font-family: "fangsong", "Old Standard TT",serif;
  }

  .heading,.serif,h1,h2,h3 {
    font-family:"Old Standard TT",serif;
  }

  strong {
    font-weight:600;
  }

  q:before {
    content:"\201C";
  }

  q:after {
    content:"\201D";
  }

  del,s {
    text-decoration:line-through;
  }

  blockquote {
    font-family:'OPPO Sans', "Old Standard TT",serif;
    text-align:center;
    padding:50px;
  }

  blockquote p {
    display:inline-block;
    font-style:italic;
  }

  blockquote:before,blockquote:after {
    font-family:'OPPO Sans', "Old Standard TT",serif;
    content:'\201C';
    font-size:35px;
    color:#403c3b;
  }

  blockquote:after {
    content:'\201D';
  }

  hr {
    width:40%;
    height: 1px;
    background:#403c3b;
    margin: 25px auto;
  }

  h1 {
    font-size:35px;
  }

  h2 {
    font-size:28px;
  }

  h3 {
    font-size:22px;
    margin-top:18px;
  }

  h1 a,h2 a,h3 a {
    text-decoration:none;
  }

  h1,h2 {
    margin-top:28px;
  }

  #sub-header, .date {
    color:#403c3b;
    font-size:13px;
  }

  #sub-header {
    margin: 0 4px;
  }

  #nav h1 a {
    font-size:35px;
    color:#1d1313;
    line-height:120%;
  }

  .posts_listing a,#nav a {
    text-decoration: none;
  }

  li {
    margin-left: 20px;
  }

  ul li {
    margin-left: 5px;
  }

  ul li {
    list-style-type: none;
  }
  ul li:before {
    content:"\00BB \0020";
  }

  #nav ul li:before, .posts_listing li:before {
    content:'';
    margin-right:0;
  }

  #content {
    text-align:left;
    width:100%;
    font-size:15px;
    padding:60px 0 80px;
  }

  #content h1,#content h2 {
    margin-bottom:5px;
  }

  #content h2 {
    font-size:25px;
  }

  #content .entry-content {
    margin-top:15px;
  }

  #content .date {
    margin-left:3px;
  }

  #content h1 {
    font-size:30px;
  }

  .highlight {
    margin: 10px 0;
  }

  .posts_listing {
    margin:0 0 50px;
  }

  .posts_listing li {
    margin:0 0 25px 15px;
  }

  .posts_listing li a:hover,#nav a:hover {
    text-decoration: underline;
  }

  #nav {
    text-align:center;
    position:static;
    margin-top:60px;
  }

  #nav ul {
    display: table;
    margin: 8px auto 0 auto;
  }

  #nav li {
    list-style-type:none;
    display:table-cell;
    font-size:15px;
    padding: 0 20px;
  }

  #links {
    display: flex;
    justify-content: space-between;
    margin: 50px 0 0 0;
  }

  #links :nth-child(1) {
    margin-right:0.5em;;
  }

  #links :nth-child(2) {
    margin-left:0.5em;;
  }

  #not-found {
    text-align: center;
  }

  #not-found a {
    font-family:'OPPO Sans', "Old Standard TT",serif;
    font-size: 200px;
    text-decoration: none;
    display: inline-block;
    padding-top: 225px;
  }

  @media (max-width: 750px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:28px;
    }

    #nav li {
      font-size:13px;
      padding: 0 15px;
    }

    #content {
      margin-top:0;
      padding-top:50px;
      font-size:14px;
    }

    #content h1 {
      font-size:25px;
    }

    #content h2 {
      font-size:22px;
    }

    .posts_listing li div {
      font-size:12px;
    }
  }

  @media (max-width: 400px) {
    body {
      padding-left:20px;
      padding-right:20px;
    }

    #nav h1 a {
      font-size:22px;
    }

    #nav li {
      font-size:12px;
      padding: 0 10px;
    }

    #content {
      margin-top:0;
      padding-top:20px;
      font-size:12px;
    }

    #content h1 {
      font-size:20px;
    }

    #content h2 {
      font-size:18px;
    }

    .posts_listing li div{
      font-size:12px;
    }
  }

  @media (prefers-color-scheme: dark) {
    *, #nav h1 a {
      color: #FDFDFD;
    }

    body {
      background: #121212;
    }

    pre, code {
      background-color: #262626;
    }

    #sub-header, .date {
      color: #BABABA;
    }

    hr {
      background: #EBEBEB;
    }
  }
</style>


    </head>

  <body>
    <section id=nav>
      <h1 id="site-title"><a href="https://martin91.github.io/">骇客π</a></h1>
      <ul>
        
      </ul>
    </section>


<section id=content>
  <h1 class="section-title"> 申请以及集成 Stripe 的 Alipay 支付方案 </h1>

  
    <div id=sub-header>
      March 2015 · 2 minute read
    </div>
  

  <div class="entry-content">
    

<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最近在一个项目需要支持人民币支付，并且客户要求希望能够收完款后的结算是用美元，所以就想到了去年 Stripe 宣布已经跟支付宝达成合作意向，所以经过一番咨询跟集成，终于把 Stripe 集成进来，并且启用了支付宝收款。这篇文章介绍功能申请以及集成的完整过程。
<!-- More --></p>

<h2 id="功能申请">功能申请</h2>

<ol>
<li><a href="https://dashboard.stripe.com/register">注册 Stripe 账号</a>；</li>
<li>加入 <a href="https://stripe.com/alipay">beta 用户组</a>，电子邮箱跟注册的 Stripe 账号保持一致；</li>
<li>联系 Stripe 员工<br />
发送邮件到 <a href="mailto:support@stripe.com">support@stripe.com</a>，声明你需要在你的 Stripe 账号中启用 Alipay 的支付功能，并且提供你的 Stripe 账号。然后，等待回复就是，一般当天都能收到回复的。</li>
</ol>

<h2 id="集成">集成</h2>

<h3 id="0-时序图-可结合后边代码一起理解">0. 时序图(可结合后边代码一起理解)</h3>

<p><img src="https://martin91.github.io/images/medias/stripe_checkout_flow.png" alt="Stripe 支付流程" /></p>

<h3 id="1-引入-stripe-js-以及初始化脚本">1. 引入 stripe.js 以及初始化脚本</h3>

<p>假设支付页面上有个开始支付按钮，其 html 代码为:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="font-weight:bold">button</span> id=<span style="font-style:italic">&#39;pay&#39;</span>&gt;支付&lt;/<span style="font-weight:bold">button</span>&gt;</code></pre></div>
<p>请在 html 代码里合适的地方（比如<code>&lt;body&gt;</code>标签的底部）加载 stripe.js：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="font-weight:bold">script</span> src=<span style="font-style:italic">&#34;https://checkout.stripe.com/checkout.js&#34;</span>&gt;&lt;/<span style="font-weight:bold">script</span>&gt;</code></pre></div>
<p>在脚本中初始化 stripe.js，并且注册支付按钮的事件监听函数：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">$(<span style="font-weight:bold">function</span>(){
  <span style="font-weight:bold">var</span> stripeHandler = StripeCheckout.configure({
    key: <span style="font-style:italic">&#39;pk_test_xxxxxxxxxxxxxxxxxxxxxxxx&#39;</span>,  <span style="font-style:italic">// 可以查看 https://dashboard.stripe.com/account/apikeys
</span><span style="font-style:italic"></span>    image: <span style="font-style:italic">&#39;https://placehold.it/200x200&#39;</span>,    <span style="font-style:italic">// 显示在支付对话框的图片，可自己指定
</span><span style="font-style:italic"></span>    alipay: <span style="font-weight:bold">true</span>,                             <span style="font-style:italic">// 启用支付宝支付
</span><span style="font-style:italic"></span>    token: <span style="font-weight:bold">function</span>(token){                   <span style="font-style:italic">// 用户填写完资料并且 Stripe 校验成功后的回调函数
</span><span style="font-style:italic"></span>      <span style="font-style:italic">// 此时应该提交 token.id 到后台，比如 http://example.com/orders/1?stripeToken={token.id}
</span><span style="font-style:italic"></span>    }
  })

  $(<span style="font-style:italic">&#39;#pay&#39;</span>).click(<span style="font-weight:bold">function</span>(){
    stripeHandler.open({
      name: <span style="font-style:italic">&#39;Business Name&#39;</span>,                  <span style="font-style:italic">// 收款方或商家名称，比如 Beansmile
</span><span style="font-style:italic"></span>      description: <span style="font-style:italic">&#34;商品描述内容&#34;</span>,              <span style="font-style:italic">// 待支付商品的描述
</span><span style="font-style:italic"></span>      amount: 50 * 100,                       <span style="font-style:italic">// 支付金额，单位是“分”
</span><span style="font-style:italic"></span>      opened: <span style="font-weight:bold">function</span>(){                     <span style="font-style:italic">// 支付对话框打开后的回调函数
</span><span style="font-style:italic"></span>        <span style="font-style:italic">// Do something
</span><span style="font-style:italic"></span>      }
    });
  });
});
</code></pre></div>
<h3 id="2-通过-token-请求收款">2. 通过 token 请求收款</h3>

<p>服务器端是 Ruby on Rails 实现，所以在 Gemfile 中引入 Stripe 官方的 Ruby SDK(具体配置方法请自行查阅其 README)：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-style:italic"># Gemfile</span>
<span style="font-style:italic"># Stripe Ruby bindings</span>
<span style="font-style:italic"># https://github.com/stripe/stripe-ruby</span>
gem <span style="font-style:italic">&#34;stripe&#34;</span>, <span style="font-style:italic">&#34;~&gt; 1.20.1&#34;</span></code></pre></div>
<p>然后在 Controller action 中添加处理逻辑:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="font-style:italic"># app/controllers/orders_controller.rb</span>
<span style="font-weight:bold">class</span> <span style="font-weight:bold">OrdersController</span> &lt; ApplicationController
  <span style="font-style:italic"># PUT /orders/:id</span>
  <span style="font-style:italic">#</span>
  <span style="font-style:italic"># params:</span>
  <span style="font-style:italic">#   id: 订单的 id</span>
  <span style="font-style:italic">#   stripeToken: 客户端完成支付流程，在脚本的回调函数中会得到 `token.id`，</span>
  <span style="font-style:italic">#                将其上传到 `stripeToken` 参数，服务器端用此 token 请求收款</span>
  <span style="font-style:italic">#</span>
  <span style="font-weight:bold">def</span> pay
    response = Stripe::Charge.create  <span style="font-style:italic">amount</span>: order.amount_in_cents,
                                      <span style="font-style:italic">currency</span>: <span style="font-style:italic">&#39;USD&#39;</span>,
                                      <span style="font-style:italic">source</span>: params[<span style="font-style:italic">:stripeToken</span>],
                                      <span style="font-style:italic">description</span>: <span style="font-style:italic">&#34;订单描述&#34;</span>
    order.update_attribute <span style="font-style:italic">:state</span>, <span style="font-style:italic">:paid</span>
    redirect_to order
  <span style="font-weight:bold">rescue</span> Stripe::InvalidRequestError =&gt; error
    flash[<span style="font-style:italic">:error</span>] = <span style="font-style:italic">&#34;由于</span><span style="font-weight:bold;font-style:italic">#{</span>error.message<span style="font-weight:bold;font-style:italic">}</span><span style="font-style:italic">，支付失败！&#34;</span>
    redirect_to order
  <span style="font-weight:bold">end</span>
<span style="font-weight:bold">end</span></code></pre></div>
<h3 id="3-效果预览">3. 效果预览</h3>

<p><img src="https://martin91.github.io/images/medias/stripe.gif" alt="stripe 支付流程演示" /></p>

<h2 id="其他">其他</h2>

<ol>
<li>关于 Stripe 的沙盒机制<br />
Stripe 为每个账号都提供了<a href="https://dashboard.stripe.com/account/apikeys">两组 keys</a>，一组 key 用于用于 live 环境，另一组是 test 环境，后者即是沙盒环境，而针对支付宝的沙盒，可用任意合法的邮箱账号进行测试，但验证码是固定的 123456，而身份证后 6 位是固定的 12345；</li>
<li>在功能申请过程中，一定要记得完成步骤3——联系 Stripe 开通 Alipay 支付功能。否则，会在支付的时候出现错误，错误信息示例为：<code>There is no token with ID atok_xxxxxxxxxxxxxxxxxxxxxxxx</code></li>
<li>实际开发中，请结合考虑用 stripe 提供的 <a href="https://dashboard.stripe.com/account/webhooks">webhook</a> 处理支付状态变迁；</li>
<li>此支付机制中，付款人可用人民币支付，但是 Stripe 会用美元跟商家（收款方）进行结算；</li>
<li>我总结了工作中集成过的其他几款支付网关，横向对比了各家的异同点，有兴趣的请戳：<a href="http://jianggaowang.com/slides/67">讲稿网：Payment Gateways</a></li>
</ol>

<h2 id="参考链接">参考链接</h2>

<ol>
<li><a href="https://stripe.com/alipay">Stripe: Alipay 首页</a></li>
<li><a href="https://stripe.com/press/alipay">Stripe: Alipay FAQ</a></li>
<li><a href="https://stripe.com/docs/guides/alipay-beta">Stripe: Alipay 集成文档</a></li>
<li><a href="https://stripe.com/docs/checkout">Stripe: Checkout</a>，这部分的文档虽然没有提交 Alipay, 但是针对 Alipay 的集成，依旧适用。</li>
</ol>

  </div>

  <div id=links>
    
      <a href="https://martin91.github.io/posts/how-do-i-fix-passenger-application-startup-problem/">&laquo;&nbsp;How do I fix Passenger application startup problem</a>
    
    
      <a href="https://martin91.github.io/posts/the-correct-way-to-metric-server-response-time/">Apdex——衡量服务器性能的标准&nbsp;&raquo;</a>
    
  </div>
</section>

  
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js"></script>
<script>
  hljs.highlightAll();
</script>
</html>



