<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="简单介绍下 stimulus.js 框架特点以及遇到的一些小问题"><meta name=baidu-site-verification content="code-O73IxgKIB2"><title>stimulus.js 初体验</title><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"stimulus.js 初体验","datePublished":"2022-07-31T09:46:20\u002b08:00"}</script><style>.hljs-comment,.hljs-quote{color:#8e908c}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c82829}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5871f}.hljs-attribute{color:#eab700}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#718c00}.hljs-section,.hljs-title{color:#4271ae}.hljs-keyword,.hljs-selector-tag{color:#8959a8}.hljs{display:block;overflow-x:auto;background:#fff;color:#4d4d4c;padding:.5em}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><link rel=canonical href=https://blog.hackerpie.com/posts/frontend/stimulus-js-early-experience/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:open sans,myriad pro,Myriad,sans-serif;font-size:17px;line-height:160%;color:#1d1313;max-width:1000px;margin:auto}p{margin:20px 0;letter-spacing:1pt}table{border-collapse:collapse;border-spacing:0}table th,td{border-bottom:1px solid #d3d3d3;padding:5px}table th{font-weight:700}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre,code{font:12px Consolas,liberation mono,Menlo,Courier,monospace;background-color:#f7f7f7}code{font-size:12px;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:85%;line-height:1.45}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:open sans,myriad pro,Myriad,sans-serif}.mono,pre,code,tt,p code,li code{font-family:Menlo,Monaco,andale mono,lucida console,courier new,monospace}.section-title{font-family:fangsong,old standard tt,serif}.heading,.serif,h1,h2,h3{font-family:old standard tt,serif}figcaption{text-align:center;color:gray;font-size:90%;font-style:italic}strong{font-weight:600}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:old standard tt,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:old standard tt,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-size:35px}h2{font-size:28px}h3{font-size:22px;margin-top:18px}h1 a,h2 a,h3 a{text-decoration:none}h1,h2{margin-top:28px}#sub-header,.date{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content .date{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:table-cell;font-size:15px;padding:0 20px}#links{display:flex;justify-content:space-between;margin:50px 0 0}#links :nth-child(1){margin-right:.5em}#links :nth-child(2){margin-left:.5em}#not-found{text-align:center}#not-found a{font-family:old standard tt,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:16px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:16px}#content h1{font-size:22px}#content h2{font-size:20px}#content h3{font-size:18px}.posts_listing li div{font-size:12px}}@media(prefers-color-scheme:dark){*,#nav h1 a{color:#fdfdfd}body{background:#121212}pre,code{background-color:#262626}#sub-header,.date{color:#bababa}hr{background:#ebebeb}}</style><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?288e2eb770bdfc3ef2b333b7d845fb2a",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></head><body><section id=nav><h1 id=site-title><a href=https://blog.hackerpie.com/>HackerPie</a></h1><h3>成长，折腾，保持单纯</h3><ul></ul></section><section id=content><h1 class=section-title>stimulus.js 初体验</h1><div id=sub-header>31/Jul/2022 · 3 minute read</div><div id=toc class="well col-md-4 col-sm-6"><nav id=TableOfContents><ul><li><a href=#stimulusjs-的轻量><code>Stimulus.js</code> 的轻量</a><ul><li><a href=#controllers><code>Controllers</code></a></li><li><a href=#targets><code>Targets</code></a></li><li><a href=#controllers-和-targets-的生命周期回调><code>Controllers 和 Targets 的生命周期回调</code></a></li><li><a href=#actions><code>Actions</code></a></li></ul></li></ul></nav></div><div class=entry-content><p><code>stimulus.js</code> 框架是一个轻量的 JavaScript 框架，由大名鼎鼎的 Basecamp 公司开发，也就是 Ruby on Rails 框架核心开发团队所在的公司。老早就听说了 stimulus.js 框架，但是没有实际使用过。最近刚好在自己的一个小项目中有了实践的机会，有了一些心得体会，总结分享一下。</p><h1 id=一个克制的前端-javascript-框架>一个克制的前端 JavaScript 框架</h1><p>谈起对 <code>stimulus.js</code> 框架总的印象，我觉得这是一个非常克制的前端 JavaScript 框架。它聚焦于<strong>在 HTML 元素与 JavaScript 对象的绑定</strong>这件事情上，并且这种绑定是单向的，不是前端开发中早已非常普遍的双向绑定。除此之外，它没有提供其他额外的功能。</p><p>由于它的克制，<strong>轻量</strong>是它必然而然的第一个优点。其次，配合其所设计的 <code>controller</code> 的概念，可以实现交互逻辑里状态的隔离与解耦。最后，它在 <code>controller</code> 代码的组织上，也让熟悉 Rails 开发的人感到亲切：<strong>约定大于配置</strong>。每个 <code>controller</code> 的定义，都需要按照约定，一个 <code>controller</code> 对应一个文件，放在 <code>controllers</code> 目录下，且文件名与 <code>controller</code> 的名字一致。</p><h2 id=stimulusjs-的轻量><code>Stimulus.js</code> 的轻量</h2><p><code>Stimulus.js</code> 的核心概念非常少，想要上手 <code>stimulus.js</code> 框架的使用，只有 4 个核心概念是需要了解的。</p><h3 id=controllers><code>Controllers</code></h3><p><code>Controllers</code> 是声明了诸如 <code>data-controller="todos"</code> 这样的 data 属性的 HTML 元素所绑定的 JavaScript 对象：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=font-weight:700>div</span> data-controller=<span style=font-style:italic>&#34;todos&#34;</span>&gt;&lt;/<span style=font-weight:700>div</span>&gt;
</span></span></code></pre></div><p><code>stimulus.js</code> 会自动为所有此类元素实例化对应的 controller，每个此类元素各自绑定一个实例。以上述例子来说，<code>stimulus.js</code> 会自动查找位于 <code>app/javascript/controllers/todos_controller.js</code> 的文件，并且导入其中导出的默认类，这是一个经典的<strong>约定大于配置</strong>的做法：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=font-style:italic>// app/javascript/controllers/todos_controller.js
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> { Controller } from <span style=font-style:italic>&#39;stimulus&#39;</span>;
</span></span><span style=display:flex><span><span style=font-weight:700>export</span> <span style=font-weight:700>default</span> <span style=font-weight:700>class</span> <span style=font-weight:700>extends</span> Controller {
</span></span><span style=display:flex><span>  connect() {
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>当然，如果不想使用或者无法使用约定的形式，也可以通过 <code>stimulus.js</code> 提供的函数进行 controller 的显式注册：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span>application.register(<span style=font-style:italic>&#34;todos&#34;</span>, TodosController)
</span></span></code></pre></div><p>这类元素以及其子孙元素，都是元素绑定的 controller 的可见范围。也就是说，在 <code>stimulus.js</code> 框架中，controller 的各种操作，只能作用于 controller 绑定的元素以及此元素的子孙元素。这个原则同样适用于嵌套 Controllers 的情况下。</p><p>Controllers 之间可以通过事件的方式相互协作，这个会在后面讲 Actions 的时候再补充讲一下。</p><h3 id=targets><code>Targets</code></h3><p><code>Targets</code> 是另一种在 HTML 元素与 JavaScript 对象之间实现绑定的方法，但是它作用于具体的 Controller 之下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=font-weight:700>div</span> data-controller=<span style=font-style:italic>&#34;todos&#34;</span>&gt;
</span></span><span style=display:flex><span>    <span style=font-style:italic>&lt;!-- ... --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>button</span> data-todos-target=<span style=font-style:italic>&#34;addBtn&#34;</span>&gt;Add&lt;/<span style=font-weight:700>button</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=font-weight:700>div</span>&gt;
</span></span></code></pre></div><p>声明 target 的规则是 <code>data-&lt;controller>-target=&lt;target-name></code>，相应的，需要在 controller 声明绑定的对象：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=font-style:italic>// app/javascript/controllers/todos_controller.js
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>
</span></span><span style=display:flex><span><span style=font-weight:700>import</span> { Controller } from <span style=font-style:italic>&#39;stimulus&#39;</span>;
</span></span><span style=display:flex><span><span style=font-weight:700>export</span> <span style=font-weight:700>default</span> <span style=font-weight:700>class</span> <span style=font-weight:700>extends</span> Controller {
</span></span><span style=display:flex><span>  stitic target = [<span style=font-style:italic>&#34;addBtn&#34;</span>]
</span></span></code></pre></div><p>完成了 target 的绑定之后，就可以按照 stimulus.js 对 targets 的约定，在 controllers 方法中使用类似 <code>this.addBtnTarget</code> 或者 <code>this.addBtnTargets</code> （针对有多个 HTML 元素绑定了同一个 Target 的情况）来访问这些绑定的 HTML 元素了。</p><h3 id=controllers-和-targets-的生命周期回调><code>Controllers 和 Targets 的生命周期回调</code></h3><p>上面说的 Controllers 和 Targets，都是 HTML 元素和 JavaScript 对象之间的绑定功能，因为 HTML 元素随着浏览器的加载以及后续的 DOM 操作，就带来了一个问题，这些对象的生命周期是怎样的？</p><pre tabindex=0><code class=language-plantuml data-lang=plantuml>@startuml
(*) --&gt; &#34;initialize()&#34;
--&gt; &#34;[name]TargetConnected(target: Element)&#34;
--&gt; &#34;connect()&#34;
--&gt; &#34;[name]TargetDisconnected(target: Element)&#34;
--&gt; &#34;disconnect()&#34;
@enduml
</code></pre><p>这几个生命周期的回调函数都与 DOM 的变化紧密相关，一般来说看这几个条件：</p><ul><li>元素是否存在？</li><li>绑定的标识是否存在元素的属性列表中，比如 <code>data-controller</code> 或者 <code>data-&lt;controller>-target</code>？</li></ul><p>当条件从部分或者全部不满足变为满足时，则 connect 类型的回调函数被调用；相反，如果由于 DOM 的一些操作导致不再满足全部条件时，disconnect 类事件的回调函数被调用。</p><p>controllers 可以在 <code>connect()</code> 回调中定义初始化的工作，比如 controller 的一些状态的初始化，相应的，<code>[name]TargetConnected</code> 也可以用于某个 target 的初始化。</p><h3 id=actions><code>Actions</code></h3><p>Actions 是 <code>stimulus.js</code> 中的事件回调机制，类似 HTML 中 <code>onclick</code>、<code>onchange</code> 一类的语法。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=font-weight:700>div</span> data-controller=<span style=font-style:italic>&#34;todos&#34;</span>&gt;
</span></span><span style=display:flex><span>    <span style=font-style:italic>&lt;!-- ... --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>button</span> data-todos-target=<span style=font-style:italic>&#34;addBtn&#34;</span> data-action=<span style=font-style:italic>&#34;click-&gt;todos#add&#34;</span>&gt;Add&lt;/<span style=font-weight:700>button</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=font-weight:700>div</span>&gt;
</span></span></code></pre></div><p>Actions 支持多个事件回调声明，这样同时也方便了实现 Controllers 之间的协作：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-html data-lang=html><span style=display:flex><span>&lt;<span style=font-weight:700>div</span> data-controller=<span style=font-style:italic>&#34;todos submitter&#34;</span>&gt;  <span style=font-style:italic>&lt;!-- 注意，这里使用了多个 controller 绑定 --&gt;</span>
</span></span><span style=display:flex><span>    <span style=font-style:italic>&lt;!-- ... --&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &lt;<span style=font-weight:700>button</span> data-todos-target=<span style=font-style:italic>&#34;addBtn&#34;</span> data-action=<span style=font-style:italic>&#34;click-&gt;todos#add todos:added-&gt;submitter#submit&#34;</span>&gt;Add&lt;/<span style=font-weight:700>button</span>&gt;
</span></span><span style=display:flex><span>&lt;/<span style=font-weight:700>div</span>&gt;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=font-style:italic>// app/javascript/controllers/todos_controller.js
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span style=font-weight:700>import</span> { Controller } from <span style=font-style:italic>&#39;stimulus&#39;</span>;
</span></span><span style=display:flex><span><span style=font-weight:700>export</span> <span style=font-weight:700>default</span> <span style=font-weight:700>class</span> <span style=font-weight:700>extends</span> Controller {
</span></span><span style=display:flex><span>  add() {
</span></span><span style=display:flex><span>    <span style=font-style:italic>// do something to maintain the status of todos controller
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>    <span style=font-weight:700>this</span>.dispatch(<span style=font-style:italic>&#34;added&#34;</span>, {detail: {todos: [xxxx]}}}})
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic>// app/javascript/controllers/submitter_controller.js
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span style=font-weight:700>import</span> { Controller } from <span style=font-style:italic>&#39;stimulus&#39;</span>;
</span></span><span style=display:flex><span><span style=font-weight:700>export</span> <span style=font-weight:700>default</span> <span style=font-weight:700>class</span> <span style=font-weight:700>extends</span> Controller {
</span></span><span style=display:flex><span>  submit(event) {
</span></span><span style=display:flex><span>    <span style=font-weight:700>const</span> todos = event.detail.todos;   <span style=font-style:italic>// extract event data
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>    <span style=font-style:italic>// do something else
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以这个例子来说，程序执行的流程是这样的：</p><ol><li>用户点击 Add 按钮后，按钮触发的 <code>click</code> 事件触发了对 <code>todos</code> controller 的 <code>added</code> 的方法的回调；</li><li><code>added</code> 方法执行完自身的核心逻辑后，通过调用 <code>this.dispatch</code> 方法触发 <code>todos:added</code> 事件，注意这里的 <code>todos:</code> 前缀是框架自动加上的；</li><li><code>todos:added</code> 事件的产生，触发了对 <code>submitter</code> controller 的 <code>submit</code> 方法的回调。</li></ol><p>就这样，通过抽象出不同的 controllers，实现逻辑的分离和解耦，再通过事件机制，将逻辑实现拼装和编排。</p><p>理解了上面这 4 个核心概念，就足以使用 <code>stimulus.js</code> 开发出一个交互相对简单的前端逻辑了。当然，<code>stimulus.js</code> 还有其他几个概念，但是在我看来只是一些锦上添花的功能，这里就没必要赘述了。</p><h1 id=也谈谈-stimulusjs-不适合的场景>也谈谈 <code>stimulus.js</code> 不适合的场景</h1><p>尽管是一个小项目，但是在使用 <code>stimulus.js</code> 的过程中，也遇到了一些觉得比较繁琐的问题，这些问题体现在：</p><ol><li><strong>缺乏 DOM 操作的封装</strong>：因为 <code>stimulus.js</code> 只提供 HTML 元素与 JavaScript 对象之间的绑定，并没有提供对 DOM 操作的封装，所以在需要操作 DOM 的时候，就会经常需要直接使用原生 DOM 对象的操作，比如 <code>Element.classList.add()</code> 一类，如果是在早期的浏览器中，还需要担心兼容性问题等，但是好在现在的浏览器兼容性问题已经少了很多，这倒不是太大的问题；</li><li><strong>缺乏前端渲染的支持</strong>：因为 <code>stimulus.js</code> 中的绑定并非双向绑定，在一些需要根据 JavaScript 对象渲染不同页面内容或者视觉效果的情况下，如果不借助其他框架的支持，就只能编写各种字符串插值，以及 <code>Element.innerHTML = xxxx</code> 的代码，同样效率比较低。</li></ol><p>所以，总结来说，如果你的前端页面是一个重交互的页面，可能只使用 <code>stimulus.js</code> 并不是一个明智之选。以我自己来选择的话，如果是一些内容类的轻交互场景，比如博客或者论坛，一般需要交互的就是评论区，简单的文本输入以及追加展示等，我觉得用 <code>stimulus.js</code> 会比较舒服，轻量，又是原汁原味的 DOM；但是其他情况下，我可能会直接上 <code>vue.js</code> 之类功能更全面的框架，最大程度减少在页面与逻辑之间状态同步的代码。</p><h1 id=使用-stimulusjs-踩过的坑>使用 <code>stimulus.js</code> 踩过的坑</h1><ol><li><strong>在 Controllers scope 之外的 action 无法回调到 Controller 的方法</strong><br>这个问题最开始排查了一些时间，一直没想明白为什么，后来才顿悟，原来是因为踩了 Controller scope 的坑。因为我的 action 声明需要回调的 controller 在当前 DOM 中不在可见范围，于是触发回调失败。</li><li><strong>先于 controller 初始化前触发的 action 无法回调到 Controller 的方法</strong>
这个问题是因为我在代码中声明了一个 action，并且在 controller 中也执行了 <code>dispatch</code>，但是此时因为目标的 controller 还没有初始化，导致看似代码没有任何语法或者使用错误，但是 action 无可能触发回调成功。</li></ol></div><div id=links><a href=https://blog.hackerpie.com/posts/programming-paradigm/golang-error-logs/>&#171;&nbsp;Golang 错误处理和日志打印的 5 点建议</a></div></section></body><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.2/highlight.min.js></script>
<script>hljs.highlightAll()</script><script src=https://cdn.jsdelivr.net/gh/jmnote/plantuml-encoder@1.2.4/dist/plantuml-encoder.min.js integrity="sha256-Qsk2KRBCN5qVZX7B+8+2IvQl1Aqc723qV1tBCQaVoqo=" crossorigin=anonymous></script>
<script>(function(){let e="language-plantuml";Array.prototype.forEach.call(document.querySelectorAll("[class^="+e+"]"),function(e){let t=document.createElement("IMG");t.loading="lazy",t.src="http://www.plantuml.com/plantuml/svg/~1"+plantumlEncoder.encode(e.innerText),e.parentNode.insertBefore(t,e),e.style.display="none"})})()</script></html>